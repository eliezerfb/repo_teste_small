unit Unit7;

interface

uses
  SysUtils, WinTypes, WinProcs, Messages, Classes, Graphics, Controls,
  Forms, Dialogs, Grids, DBGrids, DB, DBTables, ExtCtrls, Menus, Unit9, IniFiles,
  StdCtrls, Unit10, Unit11, Unit14, Unit16, SmallFunc, Mask, DBCtrls,
  SMALL_DBEdit, shellapi, Printers, ToolWin, ComCtrls, clipbrd, HtmlHelp, jpeg, MAPI, Variants,
  IBDatabase, IBCustomDataSet, IBTable, IBQuery, IBDatabaseInfo, IBServices,
  DBClient, LbAsym, LbRSA, LbCipher, LbClass, MD5, xmldom, XMLIntf,
  msxmldom, XMLDoc, oxmldom,
  xercesxmldom, Windows, OleCtrls,
  SHDocVw, FileCtrl,
  SpdNFeDataSets, spdXMLUtils,
  spdNFeType,
  spdNFe, spdType, CAPICOM_TLB, MSXML5_TLB,
  DdeMan,
  Gauges,
  LzExpand,
  Registry,
  TLHelp32,
  PsAPI, ComObj, ActiveX, TnPdf, Math, pngimage, strUtils, Buttons,
  spdNFeDPEC, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
  IdHTTP;

const SIMPLES_NACIONAL = '1';
const SIMPLES_NACIONAL_EXCESSO_SUBLIMITE_DE_RECEITA_BRUTA = '2';
const REGIME_NORMAL    = '3';

function EnviarEMail(sDe, sPara, sCC, sAssunto, sTexto, sAnexo: string; bConfirma: Boolean): Integer;
function Commitatudo(P1:Boolean): Boolean;
function AbreArquivos(P1:Boolean): Boolean;
function AgendaCommit(P1:Boolean): Boolean;
function DefineJanela(bP1 : Boolean) : Boolean;
function Audita(pP1, pP2, pP3, pP4 : String; pP5, pP6: Double) : Boolean;
function AssinaturaDigital(sP1:String): String;
function ConsisteInscricaoEstadual(sIE, sUF: String): Boolean; StdCall; External 'DllInscE32.Dll';
function DistribuicaoNFe(sP1:String) : Boolean;
function DistribuicaoNFEInutilizada(sP1:String) : Boolean;
function DistribuicaoNFe2(sP1: String) : Boolean;
function AbreArquivoNoFormatoCerto(sP1:String): boolean;
function HtmlParaPdf(sP1:String): boolean;
procedure ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos(
  XmlEnviado: String; sRetorno: String);

type

//    TValidaIE  = function (const IE, UF: String): Integer; stdcall;
    TProdutoOld = Record
      sDescricao: String;
      sQuantidade: String;
      sUnitario: String;
    end;

    TForm7 = class(TForm)
    DBGrid1: TDBGrid;
    MainMenu1: TMainMenu;
    Arquivos1: TMenuItem;
    FluxodeCaixa1: TMenuItem;
    N1: TMenuItem;
    Sair1: TMenuItem;
    Edita1: TMenuItem;
    Procura1: TMenuItem;
    Caractere1: TMenuItem;
    N3: TMenuItem;
    DataSource1: TDataSource;
    ibDataSet1: TibDataSet;
    FontDialog1: TFontDialog;
    DataSource2: TDataSource;
    ibDataSet4: TibDataSet;
    DataSource4: TDataSource;
    ibDataSet4CODIGO: TStringField;
    ibDataSet4REFERENCIA: TStringField;
    ibDataSet4DESCRICAO: TStringField;
    ibDataSet4NOME: TStringField;
    ibDataSet4FORNECEDOR: TStringField;
    ibDataSet4MEDIDA: TStringField;
//    ibDataSet4PRECO: TFloatField;
    ibDataSet4CUSTOCOMPR: TFloatField;
    ibDataSet4CUSTOMEDIO: TFloatField;
    ibDataSet4QTD_ATUAL: TFloatField;
    ibDataSet4QTD_MINIM: TFloatField;
    ibDataSet4QTD_INICIO: TFloatField;
    ibDataSet4DAT_INICIO: TDateField;
    ibDataSet4ULT_COMPRA: TDateField;
    ibDataSet4ULT_VENDA: TDateField;
    ibDataSet4PESO: TFloatField;
    ibDataSet4IPI: TFloatField;
    ibDataSet5: TibDataSet;
    DataSource5: TDataSource;
    ibDataSet5DOCUMENTO: TStringField;
    ibDataSet5SAIDA_: TFloatField;
    ibDataSet5ENTRADA_: TFloatField;
    ibDataSet5EMISSAO: TDateField;
    ibDataSet5PREDATA: TDateField;
    ibDataSet5COMPENS: TDateField;
    ibDataSet7: TibDataSet;
    DataSource7: TDataSource;
    ibDataSet7HISTORICO: TStringField;
    ibDataSet7DOCUMENTO: TStringField;
    ibDataSet7NOME: TStringField;
    ibDataSet7EMISSAO: TDateField;
    ibDataSet7VENCIMENTO: TDateField;
    ibDataSet7VALOR_DUPL: TFloatField;
    ibDataSet7MOVIMENTO: TDateField;
    ibDataSet7RECEBIMENT: TDateField;
    ibDataSet7VALOR_RECE: TFloatField;
    ibDataSet7VALOR_JURO: TFloatField;
    ibDataSet9: TibDataSet;
    DataSource9: TDataSource;
    ibDataSet9COMISSA1: TFloatField;
    ibDataSet9COMISSA2: TFloatField;

    Novo1: TMenuItem;
    Alterar1: TMenuItem;
    Apagar1: TMenuItem;
    MainMenu2: TMainMenu;
    MenuItem1: TMenuItem;
    MenuItem2: TMenuItem;
    MenuItem3: TMenuItem;
    MenuItem4: TMenuItem;
    MenuItem5: TMenuItem;
    MenuItem6: TMenuItem;
    MenuItem7: TMenuItem;
    MenuItem8: TMenuItem;
    MenuItem9: TMenuItem;
    MenuItem10: TMenuItem;
    MenuItem11: TMenuItem;
    MainMenu4: TMainMenu;
    MenuItem23: TMenuItem;
    MenuItem24: TMenuItem;
    MenuItem25: TMenuItem;
    MenuItem26: TMenuItem;
    MenuItem27: TMenuItem;
    MenuItem28: TMenuItem;
    MenuItem29: TMenuItem;
    MenuItem30: TMenuItem;
    MenuItem31: TMenuItem;
    MenuItem32: TMenuItem;
    MenuItem33: TMenuItem;
    MainMenu5: TMainMenu;
    MenuItem34: TMenuItem;
    MenuItem35: TMenuItem;
    MenuItem36: TMenuItem;
    MenuItem37: TMenuItem;
    MenuItem38: TMenuItem;
    MenuItem39: TMenuItem;
    MenuItem40: TMenuItem;
    MenuItem41: TMenuItem;
    MenuItem42: TMenuItem;
    MenuItem43: TMenuItem;
    MenuItem44: TMenuItem;
    MainMenu7: TMainMenu;
    MenuItem56: TMenuItem;
    MenuItem57: TMenuItem;
    MenuItem59: TMenuItem;
    MenuItem60: TMenuItem;
    MenuItem61: TMenuItem;
    MenuItem62: TMenuItem;
    MenuItem63: TMenuItem;
    MenuItem64: TMenuItem;
    MenuItem65: TMenuItem;
    MenuItem66: TMenuItem;
    MainMenu9: TMainMenu;
    MenuItem78: TMenuItem;
    MenuItem79: TMenuItem;
    MenuItem80: TMenuItem;
    MenuItem81: TMenuItem;
    MenuItem82: TMenuItem;
    MenuItem83: TMenuItem;
    MenuItem84: TMenuItem;
    MenuItem85: TMenuItem;
    MenuItem86: TMenuItem;
    MenuItem87: TMenuItem;
    MenuItem88: TMenuItem;
    Fluxodecaixa2: TMenuItem;
    Cartaparamaladireta1: TMenuItem;
    N4: TMenuItem;
    Etiquetaparamaladireta1: TMenuItem;
    Imprimircarta1: TMenuItem;
    Oramento1: TMenuItem;
    N6: TMenuItem;
    Grupos1: TMenuItem;
    N7: TMenuItem;
    Inventrio1: TMenuItem;
    Relatriodeconpras1: TMenuItem;
    Relatriodevendas1: TMenuItem;
    N8: TMenuItem;
    Previsodecompra1: TMenuItem;
    Movimentaodoitem1: TMenuItem;
    Imprimirpedidosdevenda1: TMenuItem;
    Listadepreos1: TMenuItem;
    Etiquetas1: TMenuItem;
    N9: TMenuItem;
    Bloquetos1: TMenuItem;
    N11: TMenuItem;
    N14: TMenuItem;
    Imprimircheque1: TMenuItem;
    N15: TMenuItem;
    Mostrartodososlanamentos1: TMenuItem;
    Label1: TLabel;
    Label2: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    ibDataSet11: TibDataSet;
    DataSource11: TDataSource;
    Label11: TLabel;
    N16: TMenuItem;
    Contasbancrias1: TMenuItem;
    ibDataSet11NOME: TStringField;
    ibDataSet11AGENCIA: TStringField;
    ibDataSet11CONTA: TStringField;
    ibDataSet11PLANO: TStringField;
    ibDataSet11ARQUIVO: TStringField;
    ibDataSet12: TibDataSet;
    DataSource12: TDataSource;
    ibDataSet12CONTA: TStringField;
    ibDataSet12NOME: TStringField;
    ibDataSet12DIA: TFloatField;
    ibDataSet12MES: TFloatField;
    ibDataSet12ANO: TFloatField;
    ibDataSet12SALDO: TFloatField;
    ibDataSet12DESCRICAOCONTABIL: TStringField;
    ibDataSet12CONTACONTABILIDADE: TStringField;
    ibDataSet12IDENTIFICADOR: TStringField;
    Label12: TLabel;
    MainMenu12: TMainMenu;
    MenuItem45: TMenuItem;
    MenuItem46: TMenuItem;
    MenuItem47: TMenuItem;
    MenuItem48: TMenuItem;
    MenuItem49: TMenuItem;
    MenuItem50: TMenuItem;
    MenuItem51: TMenuItem;
    MenuItem52: TMenuItem;
    MenuItem53: TMenuItem;
    MenuItem54: TMenuItem;
    MenuItem55: TMenuItem;
    ibDataSet13: TibDataSet;
    DataSource13: TDataSource;
    ibDataSet13NOME: TStringField;
    ibDataSet13CONTATO: TStringField;
    ibDataSet13ENDERECO: TStringField;
    ibDataSet13MUNICIPIO: TStringField;
    ibDataSet13CEP: TStringField;
    ibDataSet13ESTADO: TStringField;
    ibDataSet13CGC: TStringField;
    ibDataSet13TELEFO: TStringField;
    Label13: TLabel;
    Ajuda1: TMenuItem;
    N18: TMenuItem;
    Sobreoprograma1: TMenuItem;
    ajuda2: TMenuItem;
    N20: TMenuItem;
    Sobreoprograma2: TMenuItem;
    Ajuda4: TMenuItem;
    ApplicationHelpContext11: TMenuItem;
    Ajuda5: TMenuItem;
    Ajuda7: TMenuItem;
    Ajuda9: TMenuItem;
    N31: TMenuItem;
    Sobreoprograma4: TMenuItem;
    N32: TMenuItem;
    Sobreoprograma5: TMenuItem;
    N33: TMenuItem;
    Sobreoprograma6: TMenuItem;
    N34: TMenuItem;
    Sobreoprograma8: TMenuItem;
    N36: TMenuItem;
    Sobreoprograma10: TMenuItem;
    ibDataSet14: TibDataSet;
    DataSource14: TDataSource;
    Label14: TLabel;
    ibDataSet14BASE: TFloatField;
    MainMenu14: TMainMenu;
    MenuItem106: TMenuItem;
    MenuItem107: TMenuItem;
    MenuItem108: TMenuItem;
    MenuItem109: TMenuItem;
    MenuItem110: TMenuItem;
    MenuItem111: TMenuItem;
    MenuItem112: TMenuItem;
    MenuItem113: TMenuItem;
    MenuItem114: TMenuItem;
    MenuItem115: TMenuItem;
    MenuItem116: TMenuItem;
    MenuItem117: TMenuItem;
    MenuItem120: TMenuItem;
    MenuItem121: TMenuItem;
    ibDataSet15: TibDataSet;
    DataSource15: TDataSource;
    Label15: TLabel;
    ibDataSet15NUMERONF: TStringField;
    ibDataSet15VENDEDOR: TStringField;
    ibDataSet15CLIENTE: TStringField;
    ibDataSet15EMISSAO: TDateField;
    ibDataSet15FRETE: TFloatField;
    ibDataSet15SEGURO: TFloatField;
    ibDataSet15DESPESAS: TFloatField;
    ibDataSet15VOLUMES: TFloatField;
    ibDataSet15ESPECIE: TStringField;
    ibDataSet15MARCA: TStringField;
    ibDataSet15SAIDAH: TStringField;
    ibDataSet15SAIDAD: TDateField;
    ibDataSet15DUPLICATAS: TFloatField;
    ibDataSet15BASEICM: TFloatField;
    ibDataSet15ICMS: TFloatField;
    ibDataSet15ISS: TFloatField;
    ibDataSet15IPI: TFloatField;
    ibDataSet15TOTAL: TFloatField;
    ibDataSet15MERCADORIA: TFloatField;
    ibDataSet15EMITIDA: TStringField;
    ibDataSet15SERVICOS: TFloatField;
    ibDataSet16: TibDataSet;
    DataSource16: TDataSource;
    Label16: TLabel;
    ibDataSet18: TibDataSet;
    DataSource18: TDataSource;
    Label18: TLabel;
    ibDataSet18NOME: TStringField;
    ibDataSet18PLACA: TStringField;
    ibDataSet18ENDERECO: TStringField;
    ibDataSet18MUNICIPIO: TStringField;
    ibDataSet18ESTADO: TStringField;
    ibDataSet18CGC: TStringField;
    ibDataSet16NUMERONF: TStringField;
    ibDataSet16CODIGO: TStringField;
    ibDataSet16DESCRICAO: TStringField;
    ibDataSet16IPI: TFloatField;
    ibDataSet16ICM: TFloatField;
    ibDataSet16MEDIDA: TStringField;
    ibDataSet16QUANTIDADE: TFloatField;
    ibDataSet16UNITARIO: TFloatField;
    ibDataSet16LISTA: TFloatField;
    ibDataSet16CUSTO: TFloatField;
    ibDataSet15PESOBRUTO: TFloatField;
    ibDataSet15PESOLIQUI: TFloatField;
    ibDataSet16TOTAL: TFloatField;
    ibDataSet16PESO: TFloatField;
    ibDataSet15TRANSPORTA: TStringField;
    DataSource19: TDataSource;
    ibDataSet19: TibDataSet;
    Label19: TLabel;
    ibDataSet19DESCRICAO: TStringField;
    ibDataSet19TIPO: TStringField;
    ibDataSet19LINHA: TFloatField;
    ibDataSet19COLUNA: TFloatField;
    ibDataSet19ELEMENTO: TFloatField;
    MainMenu99: TMainMenu;
    ibDataSet14INTEGRACAO: TStringField;
    ibDataSet11SALDO3: TFloatField;
    ibDataSet14OBS: TStringField;
    ibDataSet21: TibDataSet;
    DataSource21: TDataSource;
    Label21: TLabel;
    ibDataSet21NOME: TStringField;
    ibDataSet5CONTA: TStringField;
    ibDataSet23: TibDataSet;
    DataSource23: TDataSource;
    Label31: TLabel;
    ibDataSet24: TibDataSet;
    DataSource24: TDataSource;
    Label32: TLabel;
    ibDataSet24VENDEDOR: TStringField;
    ibDataSet24FRETE: TFloatField;
    ibDataSet24SEGURO: TFloatField;
    ibDataSet24DESPESAS: TFloatField;
    ibDataSet24VOLUMES: TFloatField;
    ibDataSet24ESPECIE: TStringField;
    ibDataSet24MARCA: TStringField;
    ibDataSet24TRANSPORTA: TStringField;
    ibDataSet24SAIDAH: TStringField;
    ibDataSet24SAIDAD: TDateField;
    ibDataSet24DUPLICATAS: TFloatField;
    ibDataSet24BASEICM: TFloatField;
    ibDataSet24ICMS: TFloatField;
    ibDataSet24ISS: TFloatField;
    ibDataSet24IPI: TFloatField;
    ibDataSet24TOTAL: TFloatField;
    ibDataSet24MERCADORIA: TFloatField;
    ibDataSet24EMITIDA: TStringField;
    ibDataSet24SERVICOS: TFloatField;
    ibDataSet24DESCRICAO1: TStringField;
    ibDataSet24DESCRICAO2: TStringField;
    ibDataSet24DESCRICAO3: TStringField;
    ibDataSet24PESOBRUTO: TFloatField;
    ibDataSet24PESOLIQUI: TFloatField;
    ibDataSet23CODIGO: TStringField;
    ibDataSet23DESCRICAO: TStringField;
    ibDataSet23IPI: TFloatField;
    ibDataSet23ICM: TFloatField;
    ibDataSet23MEDIDA: TStringField;
    ibDataSet23QUANTIDADE: TFloatField;
    ibDataSet23UNITARIO: TFloatField;
    ibDataSet23TOTAL: TFloatField;
    ibDataSet23LISTA: TFloatField;
    ibDataSet23CUSTO: TFloatField;
    ibDataSet23PESO: TFloatField;
    ibDataSet24FORNECEDOR: TStringField;
    ibDataSet24OPERACAO: TStringField;
    ibDataSet15OPERACAO: TStringField;
    ibDataSet14NOME: TStringField;
    ibDataSet25: TibDataSet;
    DataSource25: TDataSource;
    Label33: TLabel;
    ibDataSet25DATA: TDateField;
    ibDataSet25PAGAR: TFloatField;
    ibDataSet25ACUMULADO1: TFloatField;
    ibDataSet25RECEBER: TFloatField;
    ibDataSet25ACUMULADO2: TFloatField;
    ibDataSet25ACUMULADO3: TFloatField;
    ibDataSet14ISS: TFloatField;
    ibDataSet16ISS: TFloatField;
    ibDataSet24FRETE12: TStringField;
    ibDataSet15FRETE12: TStringField;
    ibDataSet26: TibDataSet;
    DataSource26: TDataSource;
    Label34: TLabel;
    ibDataSet27: TibDataSet;
    DataSource27: TDataSource;
    Label35: TLabel;
    ibDataSet27CODIGO: TStringField;
    ibDataSet27DESCRICAO: TStringField;
    ibDataSet27QUANTIDADE: TFloatField;
    ibDataSet27UNITARIO: TFloatField;
    ibDataSet27DATA: TDateField;
    ibDataSet27TIPO: TStringField;
    ibDataSet27PEDIDO: TStringField;
    ibDataSet27CLIFOR: TStringField;
    ibDataSet27VENDEDOR: TStringField;
    ibDataSet16BASE: TFloatField;
    ibDataSet16BASEISS: TFloatField;
    ibDataSet14BASEISS: TFloatField;
    ibDataSet15BASEISS: TFloatField;
    PrinterSetupDialog1: TPrinterSetupDialog;
    PrintDialog1: TPrintDialog;
    RegistroFiscal1: TMenuItem;
    N37: TMenuItem;
    ibDataSet13COMPLE: TStringField;
    ibDataSet7PORTADOR: TStringField;
    ibDataSet16ALIQUOTA: TFloatField;
    ibDataSet15ALIQUOTA: TFloatField;
    N38: TMenuItem;
    Aumentodepreo1: TMenuItem;
    N39: TMenuItem;
    ibDataSet4QTD_COMPRA: TFloatField;
    ibDataSet4COMISSAO: TFloatField;
    ibDataSet4OBS: TStringField;
    Relatriodecomisses1: TMenuItem;
    ibDataSet15ICMSSUBSTI: TFloatField;
    ibDataSet15BASESUBSTI: TFloatField;
    Resumodasvendas1: TMenuItem;
    ibDataSet4QTD_VEND: TFloatField;
    ibDataSet4CUS_VEND: TFloatField;
    ibDataSet4VAL_VEND: TFloatField;
    ibDataSet4LUC_VEND: TFloatField;
    Histrico1: TMenuItem;
    ibDataSet27TOTAL: TFloatField;
    ibDataSet27CAIXA: TStringField;
    ibDataSet13IE: TStringField;
    ibDataSet18IE: TStringField;
    Caixa1: TMenuItem;
    ibDataSet4SERIE: TSmallintField;
    ibDataSet4ALTERADO: TSmallintField;
    PopupMenu1: TPopupMenu;
    Ativo1: TMenuItem;
    Apagar2: TMenuItem;
    Editar1: TMenuItem;
    N2: TMenuItem;
    ibDataSet4ATIVO: TSmallintField;
    ibDataSet23FORNECEDOR: TStringField;
    Emailpara1: TMenuItem;
    N40: TMenuItem;
    Ativo2: TMenuItem;
    N42: TMenuItem;
    Ativo4: TMenuItem;
    Relatriodeservios1: TMenuItem;
    Relatriodeoramentospendentes1: TMenuItem;
    ibDataSet4MARGEMLB: TFloatField;
    ibDataSet18FONE: TStringField;
    ibDataSet18UF: TStringField;
    ibDataSet5HISTORICO: TStringField;
    ibDataSet5NOMINAL: TStringField;
    Balancetegerencial1: TMenuItem;
    Balancetegerencialanual1: TMenuItem;
    Ranquingdeclientes1: TMenuItem;
    N44: TMenuItem;
    ibDataSet19LAYOUT: TStringField;
    ibDataSet24ICMSSUBSTI: TFloatField;
    ibDataSet24BASESUBSTI: TFloatField;
    ibDataSet24ALIQUOTA: TFloatField;
    ibDataSet14CFOP: TStringField;
    ibDataSet14ST: TStringField;
    ibDataSet4ST: TStringField;
    ibDataSet16ST: TStringField;
    ibDataSet23ST: TStringField;
    ibDataSet10: TibDataSet;
    DataSource10: TDataSource;
    Label10: TLabel;
    ibDataSet10CODIGO: TStringField;
    ibDataSet10COR: TStringField;
    ibDataSet10TAMANHO: TStringField;
    ibDataSet10QTD: TStringField;
    N46: TMenuItem;
    Ativo5: TMenuItem;
    ibDataSet10ENTRADAS: TStringField;
    Balancetegerancialmensal1: TMenuItem;
    Balancetegerencialanual2: TMenuItem;
    N47: TMenuItem;
    ibDataSet25DIFERENCA_: TFloatField;
    N48: TMenuItem;
    Inadimlencia1: TMenuItem;
    ibDataSet4CST: TStringField;
    CurvaABC1: TMenuItem;
    CurvaABCdoestoque1: TMenuItem;
    ibDataSet4INDEXADOR: TFloatField;
    Carn1: TMenuItem;
    Duplicata1: TMenuItem;
    ibDataSet19SERIE: TStringField;
    ibDataSet9NOME: TStringField;
    ibDataSet7CONTA: TStringField;
    N60: TMenuItem;
    Analisegrafica1: TMenuItem;
    N61: TMenuItem;
    Analisegrficadascontas1: TMenuItem;
    ibDataSet28: TibDataSet;
    DataSource28: TDataSource;
    Label36: TLabel;
    ibDataSet28CODIGO: TStringField;
    ibDataSet28DESCRICAO: TStringField;
    ibDataSet28QUANTIDADE: TFloatField;
    MainMenu6: TMainMenu;
    MenuItem15: TMenuItem;
    MenuItem58: TMenuItem;
    MenuItem69: TMenuItem;
    MenuItem89: TMenuItem;
    MenuItem90: TMenuItem;
    MenuItem91: TMenuItem;
    MenuItem92: TMenuItem;
    MenuItem93: TMenuItem;
    MenuItem94: TMenuItem;
    MenuItem97: TMenuItem;
    MenuItem98: TMenuItem;
    MenuItem99: TMenuItem;
    MenuItem122: TMenuItem;
    MenuItem125: TMenuItem;
    MenuItem126: TMenuItem;
    Image24: TImage;
    ibDataSet18EMAIL: TStringField;
    ibDataSet13EMAIL: TStringField;
    ibDataSet7NOSSONUM: TStringField;
    Pagarestaconta1: TMenuItem;
    Receberestaconta1: TMenuItem;
    ibDataSet27VALORICM: TFloatField;
    ibDataSet23CFOP: TStringField;
    DataSource29: TDataSource;
    Label37: TLabel;
    ibDataSet29: TibDataSet;
    ibDataSet29DESCONTO: TFloatField;
    MainMenu29: TMainMenu;
    MenuItem118: TMenuItem;
    MenuItem119: TMenuItem;
    MenuItem123: TMenuItem;
    MenuItem128: TMenuItem;
    MenuItem135: TMenuItem;
    MenuItem136: TMenuItem;
    MenuItem137: TMenuItem;
    MenuItem138: TMenuItem;
    MenuItem139: TMenuItem;
    MenuItem140: TMenuItem;
    Relatriodetodososconvnios1: TMenuItem;
    ibDataSet13COPE: TFloatField;
    ibDataSet13RESE: TFloatField;
    ibDataSet13CVEN: TFloatField;
    ibDataSet13IMPO: TFloatField;
    ibDataSet13LUCR: TFloatField;
    ibDataSet13ICME: TFloatField;
    ibDataSet13ICMS: TFloatField;
    ibDataSet29NOME: TStringField;
    ibDataSet30: TibDataSet;
    DataSource30: TDataSource;
    ibDataSet30CODIGO: TStringField;
    ibDataSet30SERIAL: TStringField;
    ibDataSet30NFCOMPRA: TStringField;
    ibDataSet30NFVENDA: TStringField;
    ibDataSet16CFOP: TStringField;
    N17: TMenuItem;
    ibDataSet29RAZAO: TStringField;
    ibDataSet29FONE: TStringField;
    ibDataSet29EMAIL: TStringField;
    Receberconvnio1: TMenuItem;
    Acertodecontasde1: TMenuItem;
    RECIBO: TButton;
    ibDataSet15MODELO: TStringField;
    Colunas1: TMenuItem;
    MainMenu8: TMainMenu;
    MenuItem67: TMenuItem;
    MenuItem68: TMenuItem;
    N13: TMenuItem;
    MenuItem70: TMenuItem;
    MenuItem71: TMenuItem;
    MenuItem72: TMenuItem;
    MenuItem73: TMenuItem;
    MenuItem74: TMenuItem;
    N45: TMenuItem;
    Acertodecontasde2: TMenuItem;
    MenuItem75: TMenuItem;
    MenuItem76: TMenuItem;
    MenuItem77: TMenuItem;
    Ajuda6: TMenuItem;
    N26: TMenuItem;
    Sobreoprograma7: TMenuItem;
    ibDataSet8: TibDataSet;
    ibDataSet8HISTORICO: TStringField;
    ibDataSet8DOCUMENTO: TStringField;
    ibDataSet8NOME: TStringField;
    ibDataSet8EMISSAO: TDateField;
    ibDataSet8VENCIMENTO: TDateField;
    ibDataSet8VALOR_DUPL: TFloatField;
    ibDataSet8PAGAMENTO: TDateField;
    ibDataSet8VALOR_PAGO: TFloatField;
    ibDataSet8PORTADOR: TStringField;
    ibDataSet8CONTA: TStringField;
    DataSource8: TDataSource;
    N21: TMenuItem;
    ibDataSet4LOCAL: TStringField;
    N22: TMenuItem;
    N24: TMenuItem;
    Exibir1: TMenuItem;
    Mostrartodososclientesefornecedores1: TMenuItem;
    N25: TMenuItem;
    Exibir2: TMenuItem;
    odas1: TMenuItem;
    Receber2: TMenuItem;
    Jrecebidas2: TMenuItem;
    Atrasadas3: TMenuItem;
    Avencer3: TMenuItem;
    Vencendohoje2: TMenuItem;
    Exibir3: TMenuItem;
    odas2: TMenuItem;
    Pagar2: TMenuItem;
    Jpagas2: TMenuItem;
    Atrasadas1: TMenuItem;
    Avencer1: TMenuItem;
    Vencendohoje3: TMenuItem;
    Exibir4: TMenuItem;
    odas3: TMenuItem;
    Lanamentoscompensados1: TMenuItem;
    Lanamentosnocompensados1: TMenuItem;
    ibDataSet30VALCOMPRA: TFloatField;
    ibDataSet30VALVENDA: TFloatField;
    ibDataSet30DATCOMPRA: TDateField;
    ibDataSet30DATVENDA: TDateField;
    Balanas1: TMenuItem;
    ibDataSet7CODEBAR: TStringField;
    ibDataSet3: TibDataSet;
    DataSource3: TDataSource;
    Label22: TLabel;
    MainMenu3: TMainMenu;
    MenuItem12: TMenuItem;
    MenuItem20: TMenuItem;
    MenuItem21: TMenuItem;
    MenuItem22: TMenuItem;
    MenuItem100: TMenuItem;
    MenuItem101: TMenuItem;
    MenuItem102: TMenuItem;
    MenuItem146: TMenuItem;
    MenuItem147: TMenuItem;
    MenuItem153: TMenuItem;
    MenuItem154: TMenuItem;
    MenuItem155: TMenuItem;
    MenuItem156: TMenuItem;
    MenuItem157: TMenuItem;
    MenuItem158: TMenuItem;
    Abertas1: TMenuItem;
    Fechadas1: TMenuItem;
    ibDataSet3NUMERO: TStringField;
    ibDataSet3DATA: TDateField;
    ibDataSet3HORA: TStringField;
    ibDataSet3CLIENTE: TStringField;
    ibDataSet3DATA_PRO: TDateField;
    ibDataSet3HORA_PRO: TStringField;
    ibDataSet3TEMPO: TStringField;
    ibDataSet3SITUACAO: TStringField;
    ibDataSet3DATA_ENT: TDateField;
    ibDataSet3HORA_ENT: TStringField;
    ibDataSet3OBSERVACAO: TStringField;
    ibDataSet3TOTAL_SERV: TFloatField;
    ibDataSet3TOTAL_PECA: TFloatField;
    ibDataSet3TOTAL_FRET: TFloatField;
    ibDataSet3TOTAL_OS: TFloatField;
    ibDataSet4LIVRE1: TStringField;
    ibDataSet4LIVRE2: TStringField;
    ibDataSet4LIVRE3: TStringField;
    ibDataSet4LIVRE4: TStringField;
    ibDataSet3TECNICO: TStringField;
    ibDataSet9HORASTRAB: TStringField;
    ibDataSet9FUNCAO: TStringField;
    ibDataSet9ATIVO: TSmallintField;
    Agendada1: TMenuItem;
    N12: TMenuItem;
    Cadastrodetcnicos1: TMenuItem;
    RelatriodepeasemOSabertas1: TMenuItem;
    Imprimirrecibo1: TMenuItem;
    N27: TMenuItem;
    ImprimirOrdemdeServio1: TMenuItem;
    ibDataSet3DESCRICAO: TStringField;
    ibDataSet3PROBLEMA: TStringField;
    ibDataSet3IDENTIFI1: TStringField;
    ibDataSet3IDENTIFI2: TStringField;
    ibDataSet3IDENTIFI3: TStringField;
    ibDataSet3IDENTIFI4: TStringField;
    ibDataSet3NF: TStringField;
    ibDataSet3GARANTIA: TDateField;
    Grade1: TMenuItem;
    N29: TMenuItem;
    Cartadecobrana1: TMenuItem;
    Imprimiretiquetaparacobrana1: TMenuItem;
    Imprimircartadecobrana1: TMenuItem;
    ibDataSet23BASE: TFloatField;
    Resumodevendas1: TMenuItem;
    DBGrid2: TDBGrid;
    DBGrid3: TDBGrid;
    Label44: TLabel;
    MainMenu10: TMainMenu;
    MenuItem13: TMenuItem;
    MenuItem141: TMenuItem;
    MenuItem142: TMenuItem;
    MenuItem143: TMenuItem;
    MenuItem151: TMenuItem;
    MenuItem164: TMenuItem;
    MenuItem165: TMenuItem;
    MenuItem166: TMenuItem;
    MenuItem167: TMenuItem;
    MenuItem168: TMenuItem;
    MenuItem169: TMenuItem;
    MenuItem170: TMenuItem;
    MenuItem177: TMenuItem;
    MenuItem178: TMenuItem;
    MenuItem179: TMenuItem;
    MenuItem180: TMenuItem;
    MenuItem181: TMenuItem;
    MenuItem182: TMenuItem;
    MainMenu11: TMainMenu;
    MenuItem183: TMenuItem;
    MenuItem196: TMenuItem;
    MenuItem197: TMenuItem;
    MenuItem205: TMenuItem;
    MenuItem206: TMenuItem;
    MenuItem207: TMenuItem;
    MenuItem208: TMenuItem;
    MenuItem209: TMenuItem;
    MenuItem210: TMenuItem;
    MenuItem211: TMenuItem;
    MenuItem212: TMenuItem;
    MenuItem219: TMenuItem;
    MenuItem220: TMenuItem;
    MenuItem221: TMenuItem;
    MenuItem222: TMenuItem;
    MenuItem223: TMenuItem;
    MenuItem224: TMenuItem;
    Exibir5: TMenuItem;
    Vendas_1: TMenuItem;
    Compras_1: TMenuItem;
    Exibir6: TMenuItem;
    Vendas2: TMenuItem;
    Compras2: TMenuItem;
    Panel9: TPanel;
    Panel10: TPanel;
    ibDataSet14CONTA: TStringField;
    imageclaro: TImage;
    imagetim: TImage;
    imageoi: TImage;
    imagevivo: TImage;
    imagebr: TImage;
    ImageConvencional: TImage;
    ImageAma: TImage;
    Enviartorpedo1: TMenuItem;
    ibDataSet16NUMEROOS: TStringField;
    DBGrid4: TDBGrid;
    ibDataSet7NUMERONF: TStringField;
    ibDataSet35: TibDataSet;
    DataSource35: TDataSource;
    Label17: TLabel;
    ibDataSet35NUMERONF: TStringField;
    ibDataSet35CODIGO: TStringField;
    ibDataSet35DESCRICAO: TStringField;
    ibDataSet35MEDIDA: TStringField;
    ibDataSet35QUANTIDADE: TFloatField;
    ibDataSet35UNITARIO: TFloatField;
    ibDataSet35TOTAL: TFloatField;
    ibDataSet35CFOP: TStringField;
    ibDataSet35TECNICO: TStringField;
    ibDataSet35ISS: TFloatField;
    ibDataSet35BASEISS: TFloatField;
    ibDataSet35NUMEROOS: TStringField;
    ibDataSet16SINCRONIA: TFloatField;
    ibDataSet23SINCRONIA: TFloatField;
    ibDataSet15DESCONTO: TFloatField;
    ibDataSet24DESCONTO: TFloatField;
    N5: TMenuItem;
    N30: TMenuItem;
    N35: TMenuItem;
    ImprimirtodasasOSfiltradas1: TMenuItem;
    N41: TMenuItem;
    ImprimirNF3: TMenuItem;
    N43: TMenuItem;
    Enviaremailparatodos1: TMenuItem;
    N51: TMenuItem;
    Emaildecobrana1: TMenuItem;
    este1: TMenuItem;
    NotasfiscaisdesadavendasSrie11: TMenuItem;
    Notasfiscaisdesadavendassrie21: TMenuItem;
    ibDataSet13HP: TStringField;
    Rankingdedevedores1: TMenuItem;
    Rankingdedevedores2: TMenuItem;
    IBDatabase1: TIBDatabase;
    ibDataSet7ATIVO: TSmallintField;
    ibDataSet1DATA: TDateField;
    ibDataSet1NOME: TStringField;
    ibDataSet1HISTORICO: TStringField;
    ibDataSet1ENTRADA: TFloatField;
    ibDataSet1SAIDA: TFloatField;
    ibDataSet1CONTA: TStringField;
    ibDataSet1REGISTRO: TIBStringField;
    IBDataSet2: TIBDataSet;
    IBDataSet2NOME: TIBStringField;
    IBDataSet2CONTATO: TIBStringField;
    IBDataSet2IE: TIBStringField;
    IBDataSet2CGC: TIBStringField;
    IBDataSet2ENDERE: TIBStringField;
    IBDataSet2COMPLE: TIBStringField;
    IBDataSet2CIDADE: TIBStringField;
    IBDataSet2ESTADO: TIBStringField;
    IBDataSet2CEP: TIBStringField;
    IBDataSet2FONE: TIBStringField;
    IBDataSet2FAX: TIBStringField;
    IBDataSet2EMAIL: TIBStringField;
    IBDataSet2OBS: TIBStringField;
    IBDataSet2CELULAR: TIBStringField;
    IBDataSet2CREDITO: TFloatField;
    IBDataSet2CONVENIO: TIBStringField;
    IBDataSet2DATANAS: TDateField;
    IBDataSet2CADASTRO: TDateField;
    IBDataSet2ULTIMACO: TDateField;
    IBDataSet2PROXDATA: TDateField;
    IBDataSet2CUSTO: TFloatField;
    IBDataSet2COMPRA: TFloatField;
    IBDataSet2ATIVO: TSmallintField;
    IBDataSet2CLIFOR: TIBStringField;
    IBDataSet2REGISTRO: TIBStringField;
    IBDataSet2IDENTIFICADOR1: TIBStringField;
    IBDataSet2IDENTIFICADOR2: TIBStringField;
    IBDataSet2IDENTIFICADOR3: TIBStringField;
    IBDataSet2IDENTIFICADOR4: TIBStringField;
    IBDataSet2IDENTIFICADOR5: TIBStringField;
    ibDataSet7REGISTRO: TIBStringField;
    IBDataSet99: TIBDataSet;
    ibDataSet4REGISTRO: TIBStringField;
    ibDataSet27MEDIDA: TIBStringField;
    ibDataSet27ALIQUICM: TIBStringField;
    ibDataSet27REGISTRO: TIBStringField;
    ibDataSet15REGISTRO: TIBStringField;
    Label30: TLabel;
    ibDataSet16REGISTRO: TIBStringField;
    ibDataSet35REGISTRO: TIBStringField;
    ibDataSet18REGISTRO: TIBStringField;
    ibDataSet14REGISTRO: TIBStringField;
    Panel7: TPanel;
    ibDataSet12REGISTRO: TIBStringField;
    ibDataSet19REGISTRO: TIBStringField;
    ibDataSet3REGISTRO: TIBStringField;
    ibDataSet24MODELO: TIBStringField;
    ibDataSet24REGISTRO: TIBStringField;
    ibDataSet23REGISTRO: TIBStringField;
    ibDataSet13REGISTRO: TIBStringField;
    ibDataSet28REGISTRO: TIBStringField;
    ibDataSet30REGISTRO: TIBStringField;
    ibDataSet8REGISTRO: TIBStringField;
    ibDataSet9REGISTRO: TIBStringField;
    ibDataSet29REGISTRO: TIBStringField;
    ibDataSet25VALOR01: TFloatField;
    ibDataSet25VALOR02: TFloatField;
    ibDataSet25VALOR03: TFloatField;
    ibDataSet25VALOR04: TFloatField;
    ibDataSet25VALOR05: TFloatField;
    ibDataSet25VALOR06: TFloatField;
    ibDataSet25VALOR07: TFloatField;
    ibDataSet25VALOR08: TFloatField;
    ibDataSet25VALOR09: TFloatField;
    ibDataSet25VALOR10: TFloatField;
    ibDataSet25VALOR_1: TFloatField;
    ibDataSet25VALOR_2: TFloatField;
    ibDataSet25VALOR_3: TFloatField;
    ibDataSet25VALOR_4: TFloatField;
    ibDataSet25REGISTRO: TIBStringField;
    ibDataSet10REGISTRO: TIBStringField;
    IBDataSet100: TIBDataSet;
    ibDataSet3DESCONTO: TFloatField;
    ibDataSet21REGISTRO: TIBStringField;
    ibDataSet5REGISTRO: TIBStringField;
    ibDataSet5NOME: TIBStringField;
    ibDataSet11REGISTRO: TIBStringField;
    ibDataset40: TIBDataSet;
    ibDataset40CODIGO: TStringField;
    ibDataset40DESCRICAO: TStringField;
    ibDataset40QTD: TFloatField;
    DataSource40: TDataSource;
    Label3: TLabel;
    ibDataset40REGISTRO: TIBStringField;
    ibDataSet14AM_: TFloatField;
    ibDataSet14AC_: TFloatField;
    ibDataSet14AL_: TFloatField;
    ibDataSet14AP_: TFloatField;
    ibDataSet14BA_: TFloatField;
    ibDataSet14CE_: TFloatField;
    ibDataSet14DF_: TFloatField;
    ibDataSet14ES_: TFloatField;
    ibDataSet14GO_: TFloatField;
    ibDataSet14MA_: TFloatField;
    ibDataSet14MG_: TFloatField;
    ibDataSet14MT_: TFloatField;
    ibDataSet14MS_: TFloatField;
    ibDataSet14PA_: TFloatField;
    ibDataSet14PB_: TFloatField;
    ibDataSet14PE_: TFloatField;
    ibDataSet14PI_: TFloatField;
    ibDataSet14PR_: TFloatField;
    ibDataSet14RJ_: TFloatField;
    ibDataSet14RN_: TFloatField;
    ibDataSet14RO_: TFloatField;
    ibDataSet14RR_: TFloatField;
    ibDataSet14RS_: TFloatField;
    ibDataSet14SC_: TFloatField;
    ibDataSet14SE_: TFloatField;
    ibDataSet14SP_: TFloatField;
    ibDataSet14TO_: TFloatField;
    ibDataSet14EX_: TFloatField;
    IBDataSet2CONTATOS: TMemoField;
    ibDataSet1SALDO: TFloatField;
    ibDataSet5SALDO_BANC: TFloatField;
    ibDataSet11SALDO1: TFloatField;
    ibDataSet11SALDO2: TFloatField;
    ibDataSet15NSU: TIBStringField;
    ibDataSet15NSUH: TIBStringField;
    ibDataSet15NSUD: TDateField;
    ibDataSet4FOTO: TMemoField;
    ibDataSet21FOTO: TMemoField;
    IBDatabaseInfo1: TIBDatabaseInfo;
    ibDataSet37: TIBDataSet;
    ibDataSet37CODIGO: TStringField;
    ibDataSet37DESCRICAO: TStringField;
    ibDataSet37QUANTIDADE: TFloatField;
    ibDataSet37UNITARIO: TFloatField;
    ibDataSet37TOTAL: TFloatField;
    ibDataSet37DATA: TDateField;
    ibDataSet37TIPO: TStringField;
    ibDataSet37PEDIDO: TStringField;
    ibDataSet37CLIFOR: TStringField;
    ibDataSet37VENDEDOR: TStringField;
    ibDataSet37CAIXA: TStringField;
    ibDataSet37MEDIDA: TIBStringField;
    ibDataSet37ITEM: TIBStringField;
    ibDataSet37VALORICM: TFloatField;
    ibDataSet37ALIQUICM: TIBStringField;
    ibDataSet37REGISTRO: TIBStringField;
    DataSource37: TDataSource;
    Label9: TLabel;
    Gerarnotafiscalsrie11: TMenuItem;
    Gerarnotafiscalsrie21: TMenuItem;
    ibDataSet15IDENTIFICADOR1: TIBStringField;
    IBBackupService1: TIBBackupService;
    IBRestoreService1: TIBRestoreService;
    IBTransaction1: TIBTransaction;
    Relatriodecorrelao1: TMenuItem;
    Sosclientescomcontasatrasadas1: TMenuItem;
    Sosclientescomsuascontasemdia1: TMenuItem;
    Sosclientescomcontasareceber1: TMenuItem;
    IBDataSet119: TIBDataSet;
    DataSource119: TDataSource;
    Label20: TLabel;
    IBDataSet119DESCRICAO: TIBStringField;
    IBDataSet119TIPO: TIBStringField;
    IBDataSet119LINHA: TFloatField;
    IBDataSet119COLUNA: TFloatField;
    IBDataSet119ELEMENTO: TFloatField;
    IBDataSet119LAYOUT: TIBStringField;
    IBDataSet119SERIE: TIBStringField;
    IBDataSet119REGISTRO: TIBStringField;
    ArquivotextoNotaFiscalPaulista1: TMenuItem;
    N19: TMenuItem;
    Notasfiscaiscanceladas1: TMenuItem;
    Notasfiscaisabertas1: TMenuItem;
    odas4: TMenuItem;
    IBQuery1: TIBQuery;
    SaveDialog1: TSaveDialog;
    Exportar1: TMenuItem;
    N23: TMenuItem;
    N49: TMenuItem;
    ImportarOS1: TMenuItem;
    ImportarCupomFiscal1: TMenuItem;
    ImportarOramento1: TMenuItem;
    N50: TMenuItem;
    ImportarNotaFiscal1: TMenuItem;
    OpenDialog1: TOpenDialog;
    IBDataSet39: TIBDataSet;
    DataSource39: TDataSource;
    IBDataSet39CODIGO: TIBStringField;
    IBDataSet39NOME: TIBStringField;
    IBDataSet39UF: TIBStringField;
    IBDataSet39REGISTRO: TIBStringField;
    Movimentaodositemskardex1: TMenuItem;
    Vendasporvendedor1: TMenuItem;
    ibDataSet37NUMERONF: TIBStringField;
    Relatriodetotaldeserviosporvendedor1: TMenuItem;
    IBDataSet101: TIBDataSet;
    ibDataSet13IM: TIBStringField;
    N52: TMenuItem;
    IBDataSet2MOSTRAR: TIBStringField;
    Relatriodetotaldeserviosportcnico1: TMenuItem;
    Resumodascompras1: TMenuItem;
    Resumodascomrpas1: TMenuItem;
    ibDataSet4IAT: TIBStringField;
    ibDataSet4IPPT: TIBStringField;
    LbBlowfish1: TLbBlowfish;
    LbRSASSA1: TLbRSASSA;
    XMLDocument: TXMLDocument;
    N53: TMenuItem;
    N1EnviarNFe1: TMenuItem;
    N2ConsultarrecibodaNFe1: TMenuItem;
    N3ConsultarNFe1: TMenuItem;
    N4ImprimirDANFE1: TMenuItem;
    CancelarNFe1: TMenuItem;
    ibDataSet15STATUS: TIBStringField;
    ibDataSet15NFEID: TIBStringField;
    ibDataSet15NFERECIBO: TIBStringField;
    ibDataSet15NFEXML: TMemoField;
    ibDataSet15NFEPROTOCOLO: TIBStringField;
    N6EnviarNFeConsultareImprimirDANFE1: TMenuItem;
    N0TestarservidorNFe1: TMenuItem;
    ransmitirNFe1: TMenuItem;
    N5EnviarDANFEporemail1: TMenuItem;
    N6VisualizarDANFE1: TMenuItem;
    GerarNFedeentrada1: TMenuItem;
    N9ImprimirDANFEemformulriodecontingncia1: TMenuItem;
    Image8: TImage;
    Agrupar1: TMenuItem;
    Image9: TImage;
    Importarretornodevendaambulante1: TMenuItem;
    ibDataSet15RECIBOXML: TMemoField;
    ExportarNFesemarquivoXML1: TMenuItem;
    ibDataSet14SOBREIPI: TIBStringField;
    ibDataSet14SOBREFRETE: TIBStringField;
    ibDataSet14SOBRESEGURO: TIBStringField;
    ibDataSet14SOBREOUTRAS: TIBStringField;
    Image10: TImage;
    Image11: TImage;
    ibDataSet15LOKED: TIBStringField;
    IBQuery2: TIBQuery;
    XMLDocument1: TXMLDocument;
    ibDataSet26DATA: TDateField;
    ibDataSet26DOCUMENTO: TIBStringField;
    ibDataSet26HISTORICO: TIBStringField;
    ibDataSet26QUANTIDADE: TFloatField;
    ibDataSet26REGISTRO: TIBStringField;
    ibDataSet26VALOR: TIBBCDField;
    ibDataSet14CST: TIBStringField;
    ibDataSet14BCPIS: TIBBCDField;
    ibDataSet14BCCOFINS: TIBBCDField;
    ibDataSet14PPIS: TIBBCDField;
    ibDataSet14PCOFINS: TIBBCDField;
    XConsultarcadastro1: TMenuItem;
    Image12: TImage;
    vendaspara: TMenuItem;
    Ca1: TMenuItem;
    SaveDialog2: TSaveDialog;
    IBDataSet2FOTO: TBlobField;
    ibDataSet24NFEXML: TMemoField;
    lbumdefotografias1: TMenuItem;
    SPEDFiscal1: TMenuItem;
    Image13: TImage;
    Image14: TImage;
    OpenDialog2: TOpenDialog;
    OpenDialog3: TOpenDialog;
    Panel2: TPanel;
    Label23: TLabel;
    Label24: TLabel;
    Label25: TLabel;
    Label26: TLabel;
    SMALL_DBEdit6: TSMALL_DBEdit;
    ComboBox1: TComboBox;
    Edit1: TEdit;
    ComboBox2: TComboBox;
    Label47: TLabel;
    SMALL_DBEdit1: TSMALL_DBEdit;
    Label48: TLabel;
    Edit2: TEdit;
    Label49: TLabel;
    SMALL_DBEdit2: TSMALL_DBEdit;
    Image18: TImage;
    Edit3: TEdit;
    ibDataSet8ATIVO: TIntegerField;
    Romaneiodecarga1: TMenuItem;
    ConsultarvalidadedaNFe1: TMenuItem;
    IBQuery3: TIBQuery;
    ibDataSet13CRT: TIBStringField;
    ibDataSet13CNAE: TIBStringField;
    ibDataSet14CSOSN: TIBStringField;
    IBDataSet97: TIBDataSet;
    DataSource97: TDataSource;
    MainMenu13: TMainMenu;
    MenuItem14: TMenuItem;
    MenuItem16: TMenuItem;
    MenuItem17: TMenuItem;
    MenuItem18: TMenuItem;
    MenuItem104: TMenuItem;
    MenuItem105: TMenuItem;
    MenuItem124: TMenuItem;
    MenuItem127: TMenuItem;
    MenuItem133: TMenuItem;
    MenuItem134: TMenuItem;
    GerarNotaFiscalSrie12: TMenuItem;
    N54: TMenuItem;
    GerarNotaFiscalSrie22: TMenuItem;
    N55: TMenuItem;
    Relatriodeoramentospendentes2: TMenuItem;
    LbBlowfish2: TLbBlowfish;
    LbRSASSA2: TLbRSASSA;
    ibDataSet4ENCRYPTHASH: TIBStringField;
    ibDataSet27ITEM: TIBStringField;
    ibDataSet27HORA: TIBStringField;
    ibDataSet27DAV: TIBStringField;
    ibDataSet27TIPODAV: TIBStringField;
    ibDataSet27CNPJ: TIBStringField;
    ibDataSet27REFERENCIA: TIBStringField;
    ibDataSet27ENCRYPTHASH: TIBStringField;
    ibDataSet27COO: TIBStringField;
    ibDataSet27CCF: TIBStringField;
    ibDataSet37COO: TIBStringField;
    ibDataSet37ENCRYPTHASH: TIBStringField;
    VVerificaresquemashema1: TMenuItem;
    ibDataSet4CSOSN: TIBStringField;
    DataSource49: TDataSource;
    IBDataSet49: TIBDataSet;
    IBDataSet49REGISTRO: TIBStringField;
    IBDataSet49SIGLA: TIBStringField;
    IBDataSet49DESCRICAO: TIBStringField;
    IBDataSet49OBS: TIBStringField;
    RRecuperaroXMLdestaNFe1: TMenuItem;
    ExportarNFesfiltradasemarquivoXML1: TMenuItem;
    IBQuery99: TIBQuery;
    ibDataSet23VICMS: TIBBCDField;
    ibDataSet23VBC: TIBBCDField;
    ibDataSet23VBCST: TIBBCDField;
    ibDataSet23VICMSST: TIBBCDField;
    ibDataSet23VIPI: TIBBCDField;
    ibDataSet23VPRECO: TIBBCDField;
    ibDataSet15COMPLEMENTO: TMemoField;
    ibDataSet24COMPLEMENTO: TMemoField;
    Imprimirrecibo2: TMenuItem;
    Imprimirrecibo3: TMenuItem;
    LLeosimpostosdoXML1: TMenuItem;
    ibDataSet4PRECO: TFloatField;
    ibDataSet4PIVA: TFloatField;
    ibDataSet24NFEID: TIBStringField;
    ibDataSet4CST_IPI: TIBStringField;
    ibDataSet4TIPO_ITEM: TIBStringField;
    IBQuery4: TIBQuery;
    IBQuery5: TIBQuery;
    Button6: TButton;
    Button7: TButton;
    Button8: TButton;
    IBQuery14: TIBQuery;
    ibDataSet16VICMS: TIBBCDField;
    ibDataSet16VBC: TIBBCDField;
    ibDataSet16VBCST: TIBBCDField;
    ibDataSet16VICMSST: TIBBCDField;
    ibDataSet16VIPI: TIBBCDField;
    ibDataSet16CST_IPI: TIBStringField;
    ibDataSet16CST_ICMS: TIBStringField;
    ibDataSet16ALIQ_PIS: TIBBCDField;
    ibDataSet16ALIQ_COFINS: TIBBCDField;
    ibDataSet4CST_PIS_COFINS_ENTRADA: TIBStringField;
    ibDataSet4ALIQ_PIS_ENTRADA: TIBBCDField;
    ibDataSet4ALIQ_COFINS_ENTRADA: TIBBCDField;
    ibDataSet4CST_PIS_COFINS_SAIDA: TIBStringField;
    ibDataSet4ALIQ_PIS_SAIDA: TIBBCDField;
    ibDataSet4ALIQ_COFINS_SAIDA: TIBBCDField;
    ibDataSet16CST_PIS_COFINS: TIBStringField;
    ibDataSet23CST_IPI: TIBStringField;
    Livrodereceitas1: TMenuItem;
    Cardpio1: TMenuItem;
    N56: TMenuItem;
    RelatriodeIPI1: TMenuItem;
    RelatriodePISCOFINS1: TMenuItem;
    Button9: TButton;
    ibDataSet14CSTPISCOFINS: TIBStringField;
    ibDataSet23CST_PIS_COFINS: TIBStringField;
    ibDataSet23ALIQ_PIS: TIBBCDField;
    ibDataSet23ALIQ_COFINS: TIBBCDField;
    SPEDPISCOFINS1: TMenuItem;
    DawnloaddoXMLdiretamentedositedaSEFAZ1: TMenuItem;
    WebBrowser1: TWebBrowser;
    CCartadeCorreoEletronicaCCe1: TMenuItem;
    ibDataSet15ICCE: TIntegerField;
    ibDataSet15CCEXML: TMemoField;
    ibDataSet16XPED: TIBStringField;
    ibDataSet16NITEMPED: TIBStringField;
    ibDataSet15NVOL: TIBStringField;
    ibDataSet24NVOL: TIBStringField;
    ibDataSet27CST_PIS_COFINS: TIBStringField;
    ibDataSet27DESCONTO: TIBBCDField;
    ibDataSet27ANVISA: TIntegerField;
    ibDataSet27CST_ICMS: TIBStringField;
    ibDataSet27ALIQ_PIS: TIBBCDField;
    ibDataSet27ALIQ_COFINS: TIBBCDField;
    ibDataSet27OBS: TIBStringField;
    ibDataSet27STATUS: TIBStringField;
    ibDataSet27SERIE: TIBStringField;
    ibDataSet27SUBSERIE: TIBStringField;
    ibDataSet27CFOP: TIBStringField;
    ibDataSet4ONPROMO: TIBBCDField;
    ibDataSet4OFFPROMO: TIBBCDField;
    ibDataSet4PROMOINI: TDateField;
    ibDataSet4PROMOFIM: TDateField;
    IBDataSet128: TIBDataSet;
    ibDataSet15PLACA: TIBStringField;
    N10: TMenuItem;
    Resumodainadimplncia1: TMenuItem;
    Image1: TImage;
    Manifestaododestinatrio1: TMenuItem;
    ibDataSet24MDESTINXML: TMemoField;
    positivo: TImage;
    Positivovermelho: TImage;
    ibDataSet4IIA: TFloatField;
    IImprimirCartadeCorreoEletronicaCCe1: TMenuItem;
    ibDataSet15ANVISA: TIntegerField;
    ibDataSet15DATA_CANCEL: TDateField;
    ibDataSet15HORA_CANCEL: TIBStringField;
    ibDataSet15COD_SIT: TIBStringField;
    ibDataSet24EMISSAO: TDateField;
    ibDataSet23NUMERONF: TIBStringField;
    ibDataSet8NUMERONF: TIBStringField;
    ibDataSet24NUMERONF: TIBStringField;
    ibDataSet24ANVISA: TIntegerField;
    EtiquetasZebraArgoxElgin1: TMenuItem;
    Panel1: TPanel;
    spdNFeDataSets: TspdNFeDataSets;
    N57: TMenuItem;
    ImprimiraNFemformulrionumerado1: TMenuItem;
    ImprimirtodasasNFfiltradas1: TMenuItem;
    Panel3: TPanel;
    Button2: TButton;
    Button3: TButton;
    Button4: TButton;
    Button5: TButton;
    FCIFichadeContedodeImportao1: TMenuItem;
    ibDataSet4VALOR_PARCELA_IMPORTADA_EXTERIO: TIBBCDField;
    ibDataSet4CODIGO_FCI: TIBStringField;
    ibDataSet23CST_ICMS: TIBStringField;
    spdNFe: TspdNFe;
    ibDataSet18ANTT: TIBStringField;
    N58: TMenuItem;
    Produtividadedecontatos1: TMenuItem;
    Clientescontactadospordia1: TMenuItem;
    Clientescontactadospordiaeporvendedor1: TMenuItem;
    Relatriodevendasporvendedor1: TMenuItem;
    ibDataSet4CFOP: TIBStringField;
    PopupMenu2: TPopupMenu;
    MainMenu00: TMainMenu;
    Panel4: TPanel;
    Panel_0: TPanel;
    Image201: TImage;
    Image202: TImage;
    Image203: TImage;
    Image205: TImage;
    Image204: TImage;
    Image206: TImage;
    Image308: TImage;
    Image209: TImage;
    Label201: TLabel;
    Label202: TLabel;
    Label203: TLabel;
    Label205: TLabel;
    Label204: TLabel;
    Label206: TLabel;
    Label208: TLabel;
    Label209: TLabel;
    Image208: TImage;
    Panel5: TPanel;
    Image201_X: TImage;
    Image202_X: TImage;
    Image203_X: TImage;
    Image205_X: TImage;
    Image204_X: TImage;
    Image206_X: TImage;
    Image208_X: TImage;
    Image209_X: TImage;
    Panel6: TPanel;
    Image201_R: TImage;
    Image202_R: TImage;
    Image203_R: TImage;
    Image205_R: TImage;
    Image204_R: TImage;
    Image206_R: TImage;
    Image208_R: TImage;
    Image209_R: TImage;
    Image308_X: TImage;
    Image308_R: TImage;
    ibDataSet4MEDIDAE: TIBStringField;
    ibDataSet4FATORC: TIBBCDField;
    ibDataSet23QTD_ORIGINAL:  TFloatField;
    ibDataSet23UNITARIO_O:  TFloatField;
    Emaildecobrana2: TMenuItem;
    Image3: TImage;
    ibDataSet4IIA_UF: TFloatField;
    ibDataSet4IIA_MUNI: TFloatField;
    ibDataSet4CF: TIBStringField;
    ibDataSet16ANVISA: TIntegerField;
    ibDataSet23ANVISA: TIntegerField;
    ibDataSet15FINNFE: TIBStringField;
    ibDataSet15INDFINAL: TIBStringField;
    ibDataSet15INDPRES: TIBStringField;
    ibDataSet24FINNFE: TIBStringField;
    ibDataSet24INDFINAL: TIBStringField;
    ibDataSet24INDPRES: TIBStringField;
    IBDataSet6: TIBDataSet;
    DataSource6: TDataSource;
    IBDataSet6REGISTRO: TIBStringField;
    IBDataSet6FORNECEDOR: TIBStringField;
    ibDataSet23EAN_ORIGINAL: TIBStringField;
    IBDataSet6CODIGO: TIBStringField;
    IBDataSet6EAN: TIBStringField;
    ibDataSet4CSOSN_NFCE: TIBStringField;
    ibDataSet4CST_NFCE: TIBStringField;
    ibDataSet4ALIQUOTA_NFCE: TIBBCDField;
    ibDataSet4CEST: TIBStringField;
    ibDataSet4ENQ_IPI: TIBStringField;
    AnliseAnualdascontas1: TMenuItem;
    IBDataSet99999: TIBDataSet;
    DataSource17: TDataSource;
    IBDataSet99999NOME: TIBStringField;
    IBDataSet99999FOTO: TBlobField;
    IBDataSet99999REGISTRO: TIBStringField;
    Clientescontactadospormsporvendedor1: TMenuItem;
    ibDataSet16PFCPUFDEST: TFloatField;
    ibDataSet16PICMSUFDEST: TFloatField;
    IBDataSet88888: TIBDataSet;
    btnRetornoCNAB400: TButton;
    OpenDialog4: TOpenDialog;
    GerCNAB400: TMenuItem;
    ibDataSet7NN: TIBStringField;
    Baixaestacontanobanco1: TMenuItem;
    ibDataSet4QTD_PRO1: TFloatField;
    ibDataSet4QTD_PRO2: TFloatField;
    ibDataSet4DESCONT1: TFloatField;
    ibDataSet4DESCONT2: TFloatField;
    Vendas_XXX: TMenuItem;
    NotasfiscaisdesadavendassrieXXX1: TMenuItem;
    Relatriodeprodutosmonofsico1: TMenuItem;
    Relatriodeprodutosmonofsicos1: TMenuItem;
    Anlisedofaturamento1: TMenuItem;
    AnliseMensal1: TMenuItem;
    Analiseanual1: TMenuItem;
    Button10: TButton;
    ibDataSet15ENCRYPTHASH: TIBStringField;
    ibDataSet16ENCRYPTHASH: TIBStringField;
    ibDataSet13ENCRYPTHASH: TIBStringField;
    Anlisediaria1: TMenuItem;
    gerCNAB240: TMenuItem;
    btnRetornoCNAB240: TButton;
    spdNFeDPEC1: TspdNFeDPEC;
    ConsultarNFesemitidasparameuCNPJ1: TMenuItem;
    PositivoDownloadXML: TImage;
    VisualizarXMLdamanifestaododestinatrio1: TMenuItem;
    ibDataSet4TAGS_: TMemoField;
    N59: TMenuItem;
    ImageWhatsApp: TImage;
    IBDataSet2WHATSAPP: TIBStringField;
    N28: TMenuItem;
    EnviarmensagemWhatsAppparatodos1: TMenuItem;
    Notasfiscaisdesadavendassrie9201: TMenuItem;
    NotasfiscaisdesadavendascomCPFsrie9201: TMenuItem;
    Re1: TMenuItem;
    ClculodoCustodaltimaNota1: TMenuItem;
    Manifesto1: TMenuItem;
    PositivoVerde: TImage;
    IdHTTP1: TIdHTTP;
    ibDataSet13LICENCA: TIBStringField;
    EnvioaoFISCOREDUOZ1: TMenuItem;
    N62: TMenuItem;
    ExportarNfesdeentrdaparacontabilidade1: TMenuItem;
    IBQueryCoringa: TIBQuery;
    ManifestaododestinatrioDesc1: TMenuItem;
    Manifestaaododestinatrio1: TMenuItem;
    ransmitirNotaFiscaldeServioNFSe1: TMenuItem;
    Visu1: TMenuItem;
    EnviarNFSeporemail1: TMenuItem;
    CancelarNFSe1: TMenuItem;
    WebBrowser2: TWebBrowser;
    SMALL_DBEdit3: TSMALL_DBEdit;
    GerarNotaFiscaldeServio1: TMenuItem;
    GerarNotaFiscaldeServio2: TMenuItem;
    ibDataSet4MARKETPLACE: TIBStringField;
    ConsultarNFSe1: TMenuItem;
    MainMenu15: TMainMenu;
    MenuItem19: TMenuItem;
    MenuItem95: TMenuItem;
    MenuItem96: TMenuItem;
    MenuItem103: TMenuItem;
    MenuItem148: TMenuItem;
    MenuItem149: TMenuItem;
    MenuItem150: TMenuItem;
    MenuItem152: TMenuItem;
    Label27: TLabel;
    ImportarOrdemdeServio1: TMenuItem;
    ImportarOramento2: TMenuItem;
    N63: TMenuItem;
    N64: TMenuItem;
    ConfiguraesdaNFSe1: TMenuItem;
    N65: TMenuItem;
    NFeTransmitirasprximas1: TMenuItem;
    DevolverNF1: TMenuItem;
    ibDataSet15MARKETPLACE: TIBStringField;
    RelatriodeprodutosmonofsicosNFe1: TMenuItem;
    IBQuery6: TIBQuery;
    N66: TMenuItem;
    DuplicatestaNFe1: TMenuItem;
    PrvisualizarDANFE1: TMenuItem;
    Label28: TLabel;
    IBQALIQUOTAISS: TIBQuery;
    ibDataSet27CSOSN: TStringField;
    RelatriodePISCOFINSCupomFiscal1: TMenuItem;
    ibDataSet16CSOSN: TStringField;
    ibDataSet24IDENTIFICADORPLANOCONTAS: TStringField;
    ibDataSet4IDENTIFICADORPLANOCONTAS: TStringField;
    ibDataSet16IDENTIFICADORPLANOCONTAS: TStringField;
    ibDataSet35IDENTIFICADORPLANOCONTAS: TStringField;
    Gerarboletoeenviodeemaildecobranatotalizadoporcliente1: TMenuItem;
    procedure IntegraBanco(Sender: TField);
    procedure Sair1Click(Sender: TObject);
    procedure CalculaSaldo(Sender: BooLean);
    procedure SaldoBanco(Sender: BooLean);
    procedure Image102Click(Sender: TObject);
    procedure Image103Click(Sender: TObject);
    procedure Image106Click(Sender: TObject);
    procedure ibDataSet5NewRecord(DataSet: TDataset);
    procedure ibDataSet1NewRecord(DataSet: TDataset);
    procedure Image6Click(Sender: TObject);
    procedure Image101Click(Sender: TObject);
    procedure Image109Click(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
    procedure DBGrid1KeyPress(Sender: TObject; var Key: Char);
    procedure Cartaparamaladireta1Click(Sender: TObject);
    procedure Imprimircarta1Click(Sender: TObject);
    procedure Oramento1Click(Sender: TObject);
    procedure Grupos1Click(Sender: TObject);
    procedure Inventrio1Click(Sender: TObject);
    procedure Relatriodeconpras1Click(Sender: TObject);
    procedure Relatriodevendas1Click(Sender: TObject);
    procedure Previsodecompra1Click(Sender: TObject);
    procedure Movimentaodoitem1Click(Sender: TObject);
    procedure Imprimirpedidosdevenda1Click(Sender: TObject);
    procedure Listadepreos1Click(Sender: TObject);
    procedure Etiquetas1Click(Sender: TObject);
    procedure Contasbancrias1Click(Sender: TObject);
    procedure Sobreoprograma1Click(Sender: TObject);
    procedure Ajuda1Click(Sender: TObject);
    procedure Sobreoprograma3Click(Sender: TObject);
    procedure Sobreoprograma4Click(Sender: TObject);
    procedure Sobreoprograma5Click(Sender: TObject);
    procedure Sobreoprograma6Click(Sender: TObject);
    procedure Sobreoprograma7Click(Sender: TObject);
    procedure Sobreoprograma8Click(Sender: TObject);
    procedure Sobreoprograma9Click(Sender: TObject);
    procedure Sobreoprograma10Click(Sender: TObject);
    procedure Sobreoprograma2Click(Sender: TObject);
    procedure ibDataSet15MERCADORIAChange(Sender: TField);
    procedure FormCreate(Sender: TObject);
    procedure ibDataSet14INTEGRACAOChange(Sender: TField);
    procedure DBGrid1TitleClick(Column: TColumn);
    procedure ibDataSet7VALOR_RECEValidate(Sender: TField);
    procedure ibDataSet5COMPENSSetText(Sender: TField; const Text: String);
    procedure FormShow(Sender: TObject);
    procedure DBGrid1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Imprimircheque1Click(Sender: TObject);
    procedure ibDataSet24MERCADORIAChange(Sender: TField);
    procedure ibDataSet2BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet5ENTRADA_Change(Sender: TField);
    procedure ibDataSet5SAIDA_Change(Sender: TField);
    procedure ibDataSet1ENTRADAChange(Sender: TField);
    procedure ibDataSet1SAIDAChange(Sender: TField);
    procedure ibDataSet2NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet4BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet4DESCRICAOSetText(Sender: TField; const Text: String);
    procedure ibDataSet4NewRecord(DataSet: TDataSet);
    procedure Fluxodecaixa2Click(Sender: TObject);
    procedure ibDataSet7NewRecord(DataSet: TDataSet);
    procedure ibDataSet4QTD_ATUALChange(Sender: TField);
    procedure ibDataSet1BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet5BeforeDelete(DataSet: TDataSet);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure RegistroFiscal1Click(Sender: TObject);
    procedure Aumentodepreo1Click(Sender: TObject);
    procedure ibDataSet2ESTADOSetText(Sender: TField; const Text: String);
    procedure ibDataSet13ESTADOSetText(Sender: TField; const Text: String);
    procedure ibDataSet15VOLUMESChange(Sender: TField);
    procedure ibDataSet12BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet12AfterPost(DataSet: TDataSet);
    procedure Relatriodecomisses1Click(Sender: TObject);
    procedure Resumodasvendas1Click(Sender: TObject);
    procedure Histrico1Click(Sender: TObject);
    procedure ibDataSet7AfterPost(DataSet: TDataSet);
    procedure ibDataSet7VALOR_RECEChange(Sender: TField);
    procedure ibDataSet4REFERENCIASetText(Sender: TField; const Text: String);
    procedure ibDataSet12NewRecord(DataSet: TDataSet);
    procedure ibDataSet3NewRecord(DataSet: TDataSet);
    procedure Arquivos1Click(Sender: TObject);
    procedure Caixa1Click(Sender: TObject);
    procedure FormKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure ibDataSet1NOMEChange(Sender: TField);
    procedure MenuItem34Click(Sender: TObject);
    procedure ibDataSet7VALOR_DUPLChange(Sender: TField);
    procedure PopupMenu1Popup(Sender: TObject);
    procedure Ativo1Click(Sender: TObject);
    procedure Emailpara1Click(Sender: TObject);
    procedure MenuItem1Click(Sender: TObject);
    procedure MenuItem27Click(Sender: TObject);
    procedure Ativo4Click(Sender: TObject);
    procedure Relatriodeservios1Click(Sender: TObject);
    procedure Relatriodeoramentospendentes1Click(Sender: TObject);
    procedure ibDataSet4MARGEMLBChange(Sender: TField);
    procedure ibDataSet4BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet18ESTADOSetText(Sender: TField; const Text: String);
    procedure ibDataSet15TOTALChange(Sender: TField);
    procedure ibDataSet18UFSetText(Sender: TField; const Text: String);
    procedure DBGrid1DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure Balancetegerencial1Click(Sender: TObject);
    procedure Balancetegerencialanual1Click(Sender: TObject);
    procedure ibDataSet1BeforeEdit(DataSet: TDataSet);
    procedure Ranquingdeclientes1Click(Sender: TObject);
    procedure MenuItem60Click(Sender: TObject);
    procedure ibDataSet19AfterPost(DataSet: TDataSet);
    procedure ibDataSet2CGCSetText(Sender: TField; const Text: String);
    procedure ibDataSet7DOCUMENTOSetText(Sender: TField; const Text: String);
    procedure ibDataSet5DOCUMENTOSetText(Sender: TField; const Text: String);
    procedure ibDataSet13CGCSetText(Sender: TField; const Text: String);
    procedure ibDataSet18CGCSetText(Sender: TField; const Text: String);
    procedure ibDataSet21NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet9NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet4PRECOChange(Sender: TField);
    procedure Balancetegerancialmensal1Click(Sender: TObject);
    procedure Balancetegerencialanual2Click(Sender: TObject);
    procedure ibDataSet9BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet9AfterPost(DataSet: TDataSet);
    procedure MenuItem23Click(Sender: TObject);
    procedure ibDataSet21AfterPost(DataSet: TDataSet);
    procedure ibDataSet21BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet3NOMEChange(Sender: TField);
    procedure ibDataSet4AfterPost(DataSet: TDataSet);
    procedure ibDataSet2AfterPost(DataSet: TDataSet);
    procedure Inadimlencia1Click(Sender: TObject);
    procedure CurvaABC1Click(Sender: TObject);
    procedure CurvaABCdoestoque1Click(Sender: TObject);
    procedure Duplicata1Click(Sender: TObject);
    procedure Carn1Click(Sender: TObject);
    procedure Ajuda9Click(Sender: TObject);
    procedure Ajuda7Click(Sender: TObject);
    procedure ibDataSet2OBSSetText(Sender: TField; const Text: String);
    procedure Analisegrafica1Click(Sender: TObject);
    procedure ibDataSet4BeforePost(DataSet: TDataSet);
    procedure ibDataSet28NewRecord(DataSet: TDataSet);
    procedure MenuItem58Click(Sender: TObject);
    procedure Label38Click(Sender: TObject);
    procedure ibDataSet14BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet14AfterPost(DataSet: TDataSet);
    procedure ibDataSet14BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet28AfterDelete(DataSet: TDataSet);
    procedure ibDataSet11PLANOSetText(Sender: TField; const Text: String);
    procedure ibDataSet2DATANASSetText(Sender: TField; const Text: String);
    procedure MenuItem119Click(Sender: TObject);
    procedure MenuItem118Click(Sender: TObject);
    procedure Relatriodetodososconvnios1Click(Sender: TObject);
    procedure ibDataSet29NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet2CONVENIOSetText(Sender: TField; const Text: String);
    procedure ibDataSet29BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet29AfterPost(DataSet: TDataSet);
    procedure ibDataSet29BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet29DESCONTOSetText(Sender: TField; const Text: String);
    procedure ibDataSet30NewRecord(DataSet: TDataSet);
    procedure ibDataSet30FilterRecord(DataSet: TDataSet; var Accept: Boolean);
    procedure Receberconvnio1Click(Sender: TObject);
    procedure Acertodecontasde1Click(Sender: TObject);
    procedure RECIBOClick(Sender: TObject);
    procedure ibDataSet12BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet14NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet1AfterDelete(DataSet: TDataSet);
    procedure Colunas1Click(Sender: TObject);
    procedure Image208Click(Sender: TObject);
    procedure ibDataSet8VALOR_DUPLChange(Sender: TField);
    procedure ibDataSet8VALOR_PAGOChange(Sender: TField);
    procedure ibDataSet8VALOR_PAGOValidate(Sender: TField);
    procedure ibDataSet8NewRecord(DataSet: TDataSet);
    procedure Mostrartodososclientesefornecedores1Click(Sender: TObject);
    procedure Sosclientes1Click(Sender: TObject);
    procedure Sosfornecedores1Click(Sender: TObject);
    procedure Acertodecontasde2Click(Sender: TObject);
    procedure MenuItem71Click(Sender: TObject);
    procedure odas1Click(Sender: TObject);
    procedure Receber2Click(Sender: TObject);
    procedure Jrecebidas2Click(Sender: TObject);
    procedure Atrasadas3Click(Sender: TObject);
    procedure Avencer3Click(Sender: TObject);
    procedure Vencendohoje2Click(Sender: TObject);
    procedure odas2Click(Sender: TObject);
    procedure Pagar2Click(Sender: TObject);
    procedure Jpagas2Click(Sender: TObject);
    procedure Avencer1Click(Sender: TObject);
    procedure Atrasadas1Click(Sender: TObject);
    procedure Vencendohoje3Click(Sender: TObject);
    procedure odas3Click(Sender: TObject);
    procedure Lanamentoscompensados1Click(Sender: TObject);
    procedure Lanamentosnocompensados1Click(Sender: TObject);
    procedure Label3MouseLeave(Sender: TObject);
    procedure Label3MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet2BeforeDelete(DataSet: TDataSet);
    procedure Image_FechaClick(Sender: TObject);
    procedure Balanas1Click(Sender: TObject);
    procedure Fechadas1Click(Sender: TObject);
    procedure Abertas1Click(Sender: TObject);
    procedure MenuItem147Click(Sender: TObject);
    procedure Image210Click(Sender: TObject);
    procedure ibDataSet3TOTAL_FRETChange(Sender: TField);
    procedure Image204Click(Sender: TObject);
    procedure ibDataSet9NewRecord(DataSet: TDataSet);
    procedure ibDataSet34AfterPost(DataSet: TDataSet);
    procedure ibDataSet3BeforeDelete(DataSet: TDataSet);
    procedure Agendada1Click(Sender: TObject);
    procedure Cadastrodetcnicos1Click(Sender: TObject);
    procedure RelatriodepeasemOSabertas1Click(Sender: TObject);
    procedure ibDataSet3SITUACAOChange(Sender: TField);
    procedure Imprimirrecibo1Click(Sender: TObject);
    procedure ImprimirOrdemdeServio1Click(Sender: TObject);
    procedure MenuItem12Click(Sender: TObject);
    procedure Agenda1Click(Sender: TObject);
    procedure ibDataSet19ELEMENTOSetText(Sender: TField; const Text: String);
    procedure Grade1Click(Sender: TObject);
    procedure Cartadecobrana1Click(Sender: TObject);
    procedure Imprimiretiquetaparacobrana1Click(Sender: TObject);
    procedure Imprimircartadecobrana1Click(Sender: TObject);
    procedure ibDataSet2CEPSetText(Sender: TField; const Text: String);
    procedure ibDataSet4QTD_ATUALSetText(Sender: TField; const Text: String);
    procedure Resumodevendas1Click(Sender: TObject);
    procedure DBGrid2DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure DBGrid3DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure Vendas_1Click(Sender: TObject);
    procedure Compras_1Click(Sender: TObject);
    procedure ibDataSet16AfterPost(DataSet: TDataSet);
    procedure ibDataSet16BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet16NewRecord(DataSet: TDataSet);
    procedure ibDataSet16CFOPSetText(Sender: TField; const Text: String);
    procedure ibDataSet16DESCRICAOChange(Sender: TField);
    procedure ibDataSet16DESCRICAOSetText(Sender: TField; const Text: String);
    procedure ibDataSet16QUANTIDADEChange(Sender: TField);
    procedure ibDataSet16QUANTIDADESetText(Sender: TField; const Text: String);
    procedure ibDataSet16UNITARIOChange(Sender: TField);
    procedure ibDataSet16UNITARIOSetText(Sender: TField; const Text: String);
    procedure ibDataSet16TOTALChange(Sender: TField);
    procedure ibDataSet16TOTALSetText(Sender: TField; const Text: String);
    procedure ibDataSet15NewRecord(DataSet: TDataSet);
    procedure ibDataSet2MAESetText(Sender: TField; const Text: String);
    procedure Imprimirdocumento1Click(Sender: TObject);
    procedure Enviartorpedo1Click(Sender: TObject);
    procedure ibDataSet16AfterDelete(DataSet: TDataSet);
    procedure DBGrid4DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure DBGrid4ColEnter(Sender: TObject);
    procedure ibDataSet35AfterPost(DataSet: TDataSet);
    procedure ibDataSet35AfterDelete(DataSet: TDataSet);
    procedure ibDataSet35TOTALChange(Sender: TField);
    procedure ibDataSet23AfterPost(DataSet: TDataSet);
    procedure ibDataSet23BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet23BeforePost(DataSet: TDataSet);
    procedure ibDataSet23DESCRICAOChange(Sender: TField);
    procedure ibDataSet23DESCRICAOSetText(Sender: TField; const Text: String);
    procedure ibDataSet23QUANTIDADEChange(Sender: TField);
    procedure ibDataSet23QUANTIDADESetText(Sender: TField; const Text: String);
    procedure ibDataSet23TOTALChange(Sender: TField);
    procedure ibDataSet23IPIChange(Sender: TField);
    procedure ibDataSet23CFOPSetText(Sender: TField; const Text: String);
    procedure ibDataSet23NewRecord(DataSet: TDataSet);
    procedure ibDataSet24NewRecord(DataSet: TDataSet);
    procedure Label201MouseLeave(Sender: TObject);
    procedure Label201MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet3AfterDelete(DataSet: TDataSet);
    procedure ibDataSet35UNITARIOChange(Sender: TField);
    procedure ibDataSet15BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet24BeforeDelete(DataSet: TDataSet);
    procedure MenuItem183Click(Sender: TObject);
    procedure ImprimirNF3Click(Sender: TObject);
    procedure Enviaremailparatodos1Click(Sender: TObject);
    procedure Emaildecobrana1Click(Sender: TObject);
    procedure NotasfiscaisdesadavendasSrie11Click(Sender: TObject);
    procedure Rankingdedevedores1Click(Sender: TObject);
    procedure ibDataSet1BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet2NewRecord(DataSet: TDataSet);
    procedure DBGrid1ColEnter(Sender: TObject);
    procedure ibDataSet15BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet16BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet19BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet24BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet3BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet2BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet7BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet9BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet12BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet14BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet8BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet18BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet29BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet5BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet23BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet35BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet30BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet27BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet25BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet26BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet13BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet21BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet10BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet28BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet26NewRecord(DataSet: TDataSet);
    procedure ibDataSet27NewRecord(DataSet: TDataSet);
    procedure ibDataSet14NewRecord(DataSet: TDataSet);
    procedure ibDataSet18NewRecord(DataSet: TDataSet);
    procedure ibDataSet29NewRecord(DataSet: TDataSet);
    procedure ibDataSet35NewRecord(DataSet: TDataSet);
    procedure ibDataSet19NewRecord(DataSet: TDataSet);
    procedure ibDataSet25NewRecord(DataSet: TDataSet);
    procedure ibDataSet13NewRecord(DataSet: TDataSet);
    procedure ibDataSet10NewRecord(DataSet: TDataSet);
    procedure Panel7MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet23UNITARIOChange(Sender: TField);
    procedure ibDataSet3DESCONTOChange(Sender: TField);
    procedure ibDataSet21NewRecord(DataSet: TDataSet);
    procedure ibDataSet5BeforeEdit(DataSet: TDataSet);
    procedure Etiquetaparamaladireta1Click(Sender: TObject);
    procedure ibDataset40AfterPost(DataSet: TDataSet);
    procedure MenuItem56Click(Sender: TObject);
    procedure ibDataSet1CalcFields(DataSet: TDataSet);
    procedure ibDataSet5CalcFields(DataSet: TDataSet);
    procedure Rankingdedevedores2Click(Sender: TObject);
    procedure ibDataSet11BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet11NewRecord(DataSet: TDataSet);
    procedure ibDataSet1DATAChange(Sender: TField);
    procedure ibDataSet5COMPENSChange(Sender: TField);
    procedure IBDataSet2EditError(DataSet: TDataSet; E: EDatabaseError;
      var Action: TDataAction);
    procedure IBDataSet2UpdateError(DataSet: TDataSet; E: EDatabaseError;
      UpdateKind: TUpdateKind; var UpdateAction: TIBUpdateAction);
    procedure IBDataSet2DeleteError(DataSet: TDataSet; E: EDatabaseError;
      var Action: TDataAction);
    procedure IBDataSet2PostError(DataSet: TDataSet; E: EDatabaseError;
      var Action: TDataAction);
    procedure MenuItem75Click(Sender: TObject);
    procedure este1Click(Sender: TObject);
    procedure ibDataSet11BeforePost(DataSet: TDataSet);
    procedure Gerarnotafiscalsrie11Click(Sender: TObject);
    procedure Gerarnotafiscalsrie21Click(Sender: TObject);
    procedure Relatriodecorrelao1Click(Sender: TObject);
    procedure Sosclientescomcontasatrasadas1Click(Sender: TObject);
    procedure Sosclientescomsuascontasemdia1Click(Sender: TObject);
    procedure Sosclientescomcontasareceber1Click(Sender: TObject);
    procedure ibDataSet4INDEXADORChange(Sender: TField);
    procedure ibDataSet4CUSTOMEDIOChange(Sender: TField);
    procedure ibDataSet24DESCONTOChange(Sender: TField);
    procedure IBDataSet119BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet119NewRecord(DataSet: TDataSet);
    procedure FloatField3SetText(Sender: TField; const Text: String);
    procedure ArquivotextoNotaFiscalPaulista1Click(Sender: TObject);
    procedure ibDataSet4BeforeInsert(DataSet: TDataSet);
    procedure ImprimirtodasasOSfiltradas1Click(Sender: TObject);
    procedure ibDataSet3SITUACAOSetText(Sender: TField;
      const Text: String);
    procedure ibDataSet11AfterPost(DataSet: TDataSet);
    procedure ibDataSet11BeforeEdit(DataSet: TDataSet);
    procedure Notasfiscaiscanceladas1Click(Sender: TObject);
    procedure Notasfiscaisabertas1Click(Sender: TObject);
    procedure odas4Click(Sender: TObject);
    procedure Exportar1Click(Sender: TObject);
    procedure ImportarOS1Click(Sender: TObject);
    procedure ImportarCupomFiscal1Click(Sender: TObject);
    procedure ImportarOramento1Click(Sender: TObject);
    procedure ImportarNotaFiscal1Click(Sender: TObject);
    procedure IBDataSet2CIDADESetText(Sender: TField; const Text: String);
    procedure Movimentaodositemskardex1Click(Sender: TObject);
    procedure ibDataSet30SERIALSetText(Sender: TField; const Text: String);
    procedure Vendasporvendedor1Click(Sender: TObject);
    procedure ibDataSet15AfterPost(DataSet: TDataSet);
    procedure ibDataSet24AfterPost(DataSet: TDataSet);
    procedure ibDataSet3AfterPost(DataSet: TDataSet);
    procedure ibDataSet1AfterPost(DataSet: TDataSet);
    procedure ibDataSet8AfterPost(DataSet: TDataSet);
    procedure ibDataSet18AfterPost(DataSet: TDataSet);
    procedure ibDataSet5AfterPost(DataSet: TDataSet);
    procedure ibDataSet30AfterPost(DataSet: TDataSet);
    procedure ibDataSet27AfterPost(DataSet: TDataSet);
    procedure ibDataSet25AfterPost(DataSet: TDataSet);
    procedure ibDataSet26AfterPost(DataSet: TDataSet);
    procedure ibDataSet13AfterPost(DataSet: TDataSet);
    procedure ibDataSet10AfterPost(DataSet: TDataSet);
    procedure ibDataSet28AfterPost(DataSet: TDataSet);
    procedure ibDataSet37AfterPost(DataSet: TDataSet);
    procedure ibDataSet15AfterDelete(DataSet: TDataSet);
    procedure ibDataSet24AfterDelete(DataSet: TDataSet);
    procedure IBDataSet2AfterDelete(DataSet: TDataSet);
    procedure ibDataSet7AfterDelete(DataSet: TDataSet);
    procedure ibDataSet9AfterDelete(DataSet: TDataSet);
    procedure ibDataSet12AfterDelete(DataSet: TDataSet);
    procedure ibDataSet14AfterDelete(DataSet: TDataSet);
    procedure ibDataSet8AfterDelete(DataSet: TDataSet);
    procedure ibDataSet18AfterDelete(DataSet: TDataSet);
    procedure ibDataSet29AfterDelete(DataSet: TDataSet);
    procedure ibDataSet5AfterDelete(DataSet: TDataSet);
    procedure IBDataSet99AfterDelete(DataSet: TDataSet);
    procedure ibDataSet23AfterDelete(DataSet: TDataSet);
    procedure ibDataSet19AfterDelete(DataSet: TDataSet);
    procedure ibDataSet30AfterDelete(DataSet: TDataSet);
    procedure ibDataSet27AfterDelete(DataSet: TDataSet);
    procedure ibDataSet25AfterDelete(DataSet: TDataSet);
    procedure ibDataSet26AfterDelete(DataSet: TDataSet);
    procedure ibDataSet13AfterDelete(DataSet: TDataSet);
    procedure ibDataSet21AfterDelete(DataSet: TDataSet);
    procedure ibDataSet10AfterDelete(DataSet: TDataSet);
    procedure ibDataset40AfterDelete(DataSet: TDataSet);
    procedure ibDataSet11AfterDelete(DataSet: TDataSet);
    procedure ibDataSet37AfterDelete(DataSet: TDataSet);
    procedure IBDataSet119AfterDelete(DataSet: TDataSet);
    procedure Relatriodetotaldeserviosporvendedor1Click(Sender: TObject);
    procedure Resumodascompras1Click(Sender: TObject);
    procedure Resumodascomrpas1Click(Sender: TObject);
    procedure MenuItem117Click(Sender: TObject);
    procedure ibDataSet1BeforePost(DataSet: TDataSet);
    procedure ibDataSet5BeforePost(DataSet: TDataSet);
    procedure ibDataSet7BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet8BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet7BeforePost(DataSet: TDataSet);
    procedure ibDataSet7BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet8BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet8BeforePost(DataSet: TDataSet);
    procedure N4ImprimirDANFE1Click(Sender: TObject);
    procedure N1EnviarNFe1Click(Sender: TObject);
    procedure N2ConsultarrecibodaNFe1Click(Sender: TObject);
    procedure N3ConsultarNFe1Click(Sender: TObject);
    procedure CancelarNFe1Click(Sender: TObject);
    procedure N6EnviarNFeConsultareImprimirDANFE1Click(Sender: TObject);
    procedure N0TestarservidorNFe1Click(Sender: TObject);
    procedure ransmitirNFe1Click(Sender: TObject);
    procedure N5EnviarDANFEporemail1Click(Sender: TObject);
    procedure N6VisualizarDANFE1Click(Sender: TObject);
    procedure ibDataset40NewRecord(DataSet: TDataSet);
    procedure ibDataset40BeforeInsert(DataSet: TDataSet);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure GerarNFedeentrada1Click(Sender: TObject);
    procedure N9ImprimirDANFEemformulriodecontingncia1Click(
      Sender: TObject);
    procedure Agrupar1Click(Sender: TObject);
    procedure ExportarNFesemarquivoXML1Click(Sender: TObject);
    procedure ibDataSet4ULT_VENDASetText(Sender: TField;
      const Text: String);
    procedure XConsultarcadastro1Click(Sender: TObject);
    procedure vendasparaClick(Sender: TObject);
    procedure Ca1Click(Sender: TObject);
    procedure lbumdefotografias1Click(Sender: TObject);
    procedure SPEDFiscal1Click(Sender: TObject);
    procedure ibDataSet8DOCUMENTOSetText(Sender: TField;
      const Text: String);
    procedure SMALL_DBEdit2Change(Sender: TObject);
    procedure Edit2KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SMALL_DBEdit1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure DBGrid3KeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SMALL_DBEdit6Exit(Sender: TObject);
    procedure SMALL_DBEdit1Exit(Sender: TObject);
    procedure SMALL_DBEdit6KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Romaneiodecarga1Click(Sender: TObject);
    procedure ConsultarvalidadedaNFe1Click(Sender: TObject);
    procedure ibDataSet16BeforePost(DataSet: TDataSet);
    procedure GerarNotaFiscalSrie12Click(Sender: TObject);
    procedure GerarNotaFiscalSrie22Click(Sender: TObject);
    procedure Relatriodeoramentospendentes2Click(Sender: TObject);
    procedure ibDataSet27BeforePost(DataSet: TDataSet);
    procedure ibDataSet37BeforePost(DataSet: TDataSet);
    procedure VVerificaresquemashema1Click(Sender: TObject);
    procedure Importarretornodevendaambulante1Click(Sender: TObject);
    procedure ibDataSet24BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet4MEDIDASetText(Sender: TField; const Text: String);
    procedure RRecuperaroXMLdestaNFe1Click(Sender: TObject);
    procedure ExportarNFesfiltradasemarquivoXML1Click(Sender: TObject);
    procedure ibDataSet23ICMChange(Sender: TField);
    procedure Imprimirrecibo2Click(Sender: TObject);
    procedure Imprimirrecibo3Click(Sender: TObject);
    procedure ibDataSet4LIVRE4Validate(Sender: TField);
    procedure Image205Click(Sender: TObject);
    procedure ibDataSet27BeforeDelete(DataSet: TDataSet);
    procedure Button6Click(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure Button8Click(Sender: TObject);
    procedure RelatriodeIPI1Click(Sender: TObject);
    procedure RelatriodePISCOFINS1Click(Sender: TObject);
    procedure Cardpio1Click(Sender: TObject);
    procedure Livrodereceitas1Click(Sender: TObject);
    procedure ibDataSet4ALIQ_PIS_ENTRADAChange(Sender: TField);
    procedure SPEDPISCOFINS1Click(Sender: TObject);
    procedure WebBrowser1NavigateComplete2(Sender: TObject;
      const pDisp: IDispatch; var URL: OleVariant);
    procedure WebBrowser1DownloadComplete(Sender: TObject);
    procedure WebBrowser1DocumentComplete(Sender: TObject;
      const pDisp: IDispatch; var URL: OleVariant);
    procedure CCartadeCorreoEletronicaCCe1Click(Sender: TObject);
    procedure IBDataSet128BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet128BeforePost(DataSet: TDataSet);
    procedure IBDataSet128NewRecord(DataSet: TDataSet);
    procedure Exibir1Click(Sender: TObject);
    procedure ibDataSet4PROMOINISetText(Sender: TField;
      const Text: String);
    procedure Resumodainadimplncia1Click(Sender: TObject);
    procedure Manifestaododestinatrio1Click(Sender: TObject);
    procedure ibDataSet4CFChange(Sender: TField);
    procedure IImprimirCartadeCorreoEletronicaCCe1Click(Sender: TObject);
    procedure EtiquetasZebraArgoxElgin1Click(Sender: TObject);
    procedure Panel1Click(Sender: TObject);
    procedure ImprimiraNFemformulrionumerado1Click(Sender: TObject);
    procedure ImprimirtodasasNFfiltradas1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure FCIFichadeContedodeImportao1Click(Sender: TObject);
    procedure Produtividadedecontatos1Click(Sender: TObject);
    procedure Clientescontactadospordia1Click(Sender: TObject);
    procedure Clientescontactadospordiaeporvendedor1Click(Sender: TObject);
    procedure IBDataSet2BeforePost(DataSet: TDataSet);
    procedure Button10Click(Sender: TObject);
    procedure Label202MouseLeave(Sender: TObject);
    procedure Label203MouseLeave(Sender: TObject);
    procedure Label205MouseLeave(Sender: TObject);
    procedure Label204MouseLeave(Sender: TObject);
    procedure Label206MouseLeave(Sender: TObject);
    procedure Label208MouseLeave(Sender: TObject);
    procedure Label209MouseLeave(Sender: TObject);
    procedure Label202MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label203MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label205MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label204MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label206MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label208MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label209MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet23QTD_ORIGINALChange(Sender: TField);
    procedure ibDataSet23UNITARIO_OChange(Sender: TField);
    procedure ibDataSet23AfterScroll(DataSet: TDataSet);
    procedure Emaildecobrana2Click(Sender: TObject);
    procedure EmailAtualizaBoletoscobranaClick(Sender: TObject);
    procedure FormMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Panel4MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Panel_0MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure DBGrid1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure IBDataSet6AfterDelete(DataSet: TDataSet);
    procedure IBDataSet6AfterPost(DataSet: TDataSet);
    procedure IBDataSet6BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet6NewRecord(DataSet: TDataSet);
    procedure AnliseAnualdascontas1Click(Sender: TObject);
    procedure Clientescontactadospormsporvendedor1Click(Sender: TObject);
    procedure ibDataSet4CESTSetText(Sender: TField; const Text: String);
    procedure btnRetornoCNAB400Click(Sender: TObject);
    procedure Baixaestacontanobanco1Click(Sender: TObject);
    procedure IBDataSet2CREDITOSetText(Sender: TField; const Text: String);
    procedure Vendas_XXXClick(Sender: TObject);
    procedure NotasfiscaisdesadavendassrieXXX1Click(Sender: TObject);
    procedure Relatriodeprodutosmonofsico1Click(Sender: TObject);
    procedure ibDataSet4CFSetText(Sender: TField; const Text: String);
    procedure AnliseMensal1Click(Sender: TObject);
    procedure ibDataSet15BeforePost(DataSet: TDataSet);
    procedure ibDataSet13BeforePost(DataSet: TDataSet);
    procedure ibDataSet7PORTADORSetText(Sender: TField;
      const Text: String);
    procedure Anlisediaria1Click(Sender: TObject);
    procedure btnRetornoCNAB240Click(Sender: TObject);
    procedure ConsultarNFesemitidasparameuCNPJ1Click(Sender: TObject);
    procedure VisualizarXMLdamanifestaododestinatrio1Click(
      Sender: TObject);
    procedure DBGrid1CellClick(Column: TColumn);
    procedure EnviarmensagemWhatsAppparatodos1Click(Sender: TObject);
    procedure ibDataSet4OBSValidate(Sender: TField);
    procedure Notasfiscaisdesadavendassrie9201Click(Sender: TObject);
    procedure Re1Click(Sender: TObject);
    procedure ClculodoCustodaltimaNota1Click(Sender: TObject);
    procedure Manifesto1Click(Sender: TObject);
    procedure EnvioaoFISCOREDUOZ1Click(Sender: TObject);
    procedure ExportarNfesdeentrdaparacontabilidade1Click(Sender: TObject);
    procedure ManifestaododestinatrioDesc1Click(Sender: TObject);
    procedure Manifestaaododestinatrio1Click(Sender: TObject);
    procedure ransmitirNotaFiscaldeServioNFSe1Click(Sender: TObject);
    procedure Visu1Click(Sender: TObject);
    procedure EnviarNFSeporemail1Click(Sender: TObject);
    procedure CancelarNFSe1Click(Sender: TObject);
    procedure SMALL_DBEdit3Change(Sender: TObject);
    procedure ibDataSet35DESCRICAOSetText(Sender: TField;
      const Text: String);
    procedure GerarNotaFiscaldeServio1Click(Sender: TObject);
    procedure GerarNotaFiscaldeServio2Click(Sender: TObject);
    procedure ConsultarNFSe1Click(Sender: TObject);
    procedure ConfiguraesdaNFSe1Click(Sender: TObject);
    procedure NFeTransmitirasprximas1Click(Sender: TObject);
    procedure DevolverNF1Click(Sender: TObject);
    procedure RelatriodeprodutosmonofsicosNFe1Click(Sender: TObject);
    procedure DuplicatestaNFe1Click(Sender: TObject);
    procedure PrvisualizarDANFE1Click(Sender: TObject);
    procedure ibDataSet35DESCRICAOChange(Sender: TField);
    procedure RelatriodePISCOFINSCupomFiscal1Click(Sender: TObject);
    procedure ibDataSet13MUNICIPIOSetText(Sender: TField;
      const Text: String);

    {    procedure EscondeBarra(Visivel: Boolean);}


  private
    { Private declarations }
    function ImportaNF(pP1: boolean; sP1: String):Boolean;
    function PermiteValidarSchema(DataSet: TDataSet): Boolean;
    procedure ValidarSchemaSefaz(NFeXml: String);
    procedure VerificarShemaXsd(NFeXml: String; bValidarNaSefaz: Boolean);
    procedure EscolheOBancoParaGerarBoletoEEnviarEmail(Sender: TObject);
  public

    // Public declarations

    fSaldoVetorCaixa : array[0..9999999] of real;
    fSaldoVetorBanco : array[0..9999999] of real;

    //
    // NFe
    //
    fNFe : WideString;
    bProximas : Boolean;
    bContingencia : Boolean;
    bFirst : Boolean;
    sTextoDoAcordo, sFormatoDoDanfe, sZiparXML, sEnviarDAnfePorEmail, sCNPJContabilidade: String;
    //
    sFuso     : String;
    sSistema  : String;
    sAjuda    : String;
    sMostra   : String;
    sModulo   : String;
    sTitulo   : String;
    sRPS      : String;
    sProcura  : String;
    sPAgas    : String;
    TecAte    : String;
    sProximo  : String;
    sNSU      : String;
    sRegistro : String;
    sMaxReg   : String;
    sColuna   : String;
    sLinha    : String;
    sOrderBy  : String;
    sWhere    : String;
    sSelect   : String;
    //
    // Variaveis usadas para saber se deve converter unidades de medida na nota de compra
    //
    ProdutoOld : TProdutoOld;
    bMudei : Boolean;
    //
    //  necessrio saber o Nome anterior no caso de
    // alterar o nome. Se o nome for alterado deve ser
    // atualizado o arquivo VENDAS e o arquivo RECEBER
    //
    sAproveitamento, sNumeroAnteriorGrupo, sNomeAnteriorDoGrupo, sNomeAnterior, sNomeAnterior14, sNumeroAnterior, sNumeroAnterior14, sFornecedorAntigo : String;
    //
    fFCPRetido, fMutado, fMutado2, fMutado3 : Real;
    //
    fQuantidadeAnterior : Real;
    fPrecoAnterior      : Real;
    fTotalDoRecibo      : Real;
    //
    sReciboProvenienteDe : String;
    sReciboRecebemosDe   : String;
    sModuloAnterior      : String;
    //
    ArquivoAberto: TDataSet;
    TabelaAberta: TibDataSet;
    DataSourceAtual : TDataSource;
    ItensdaNota : Integer;
    iCampos: Integer;
    iFoco  : Integer;
    iRegistros : Integer;
    bChave : Boolean;
    bChaveGrade : boolean;
    bFlag  : Boolean;
    bCalcula : Boolean;
    bSoLeitura : Boolean;
    bChaveRecalculaBase : Boolean;
    bFabrica : Boolean;
    iChave : Integer;
    bNaoCalculaSaldo : Boolean;
    bEstaSendoUsado : Boolean;
    //
    dBancoEmissaoAnterior : TDateTime;
    dBancoPredataAnterior : TDateTime;
    dBancoCompensAnterior : TDateTime;
    {  necessrio gravar esta varivel antes calcular o saldo  }
    { do caixa no caso de alterar a data para uma data anterior }
    fValorAnterior : Real;
    //
    iKey : Integer;
    //
    function _ecf65_ValidaGtinNFCe(sEan: String): Boolean;
    function FormatFloatXML(dValor: Double; iPrecisao: Integer = 2): String;
    function AliqICMdoCliente16: double;
    function Formata2CasasDecimais(Valor: Double): Currency;
    procedure SelecionaAliquotaIss(var IBQuery: TIBQuery; Operacao: String = '');
    function CriaIBQuery(IBTRANSACTION: TIBTransaction): TIBQuery; // Sandro Silva 2022-11-10
    function CaracteresParaSequencialDocumentos: String;
    function ObtemNumeroDocumentoReceber(sNumeroNF: String; TipoRPS: String;
      iSequencialParcela: Integer): String;
    function UltimaParcelaReceberDaNF(sNumeroNF: String): String; // Sandro Silva 2023-01-06
  end;
  //
  function VerificaSeEstaSendoUsado(bP1:Boolean): boolean;
  function ValidaEmail(sP1: String):Boolean;
//  Function Valida_Campo(ibDataSet_P:TibDataSet; Text:String; Indice,Mensagem:String):Boolean;
  function Valida_Campo(Arquivo: String; Text: String;
    Indice, Mensagem: String):Boolean;
  function ObservacaoProduto(pP1:Boolean):Boolean;
  function ObservacaoOperacao(pP1:Boolean):Boolean;
  function Observacao2(pP1:Boolean):Boolean;
  function JaTem(p1:tibDataSet; p2:tField; p3: boolean):Boolean;
  function CriaJpg(sP1: String) :Boolean;
  function MostraLabels(tSp1: tImage; tSp2: TLabel): Boolean;
  function TraduzSql(P1: String;P2 :Boolean): String;
  function ConfiguraNFE(sP1:Boolean) : Boolean;
  function ConsultaProcesso(sP1:String): boolean;
  function BaixaEstoqueDaNFeAutorizada(sPp1: String): boolean;
  function LoadXmlDestinatarioSaida(aChaveNFe: String): WideString;
  function LoadXmlDestinatarioEntrada(aChaveNFe: String): WideString;
  function RetornaValorDaTagNoCampo(sTag: String; sObs: String): String;
  function RetornaValorDaTagNoCampoCRLF(sTag: String; sObs: String): String;
  function Manifesto(iP1: integer) : Boolean;
  function ProdutoValidoParaMarketplace(bP1 : Boolean): String;
  //
var
  Form7: TForm7;
implementation

uses Unit17, Unit12, Unit20, Unit21, Unit22, Unit23, Unit25, Mais,
  Unit27, Mais3, Unit19, Unit4, Unit30, Unit13, Unit32, Unit33, Unit34,
  Unit37, Unit38, Unit39, Unit40, Unit41, Unit43, Unit2,
  unit24, Unit28, Unit15, SelecionaCertificado, Unit6, Unit36, Unit26,
  Unit29, Unit48, ugeraxmlnfe;

{$R *.DFM}

function ExtraiNodeXml( sXML : String ; sNode : String ) : String ;
var
  inicio : Integer;
  fim : Integer;
begin
  inicio := pos( '<' + snode, sXML );
  fim := pos( '</' + snode, sXML ) + Length( '</' + snode + '>' ) - inicio;
  Result := Copy( sXML, inicio, fim );
end;

function BuscaNumeroNFSe(bP1: Boolean) : Boolean;
  function NumeroNFSeNaoImportadoDoRetorno: Boolean;
  begin
    Result := False;
    if pChar(Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)) = '000000000' then
      Result := True;
  end;
begin
  //
  try
    // Sandro Silva 2022-10-06 if pChar(Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)) = '000000000' then
    if NumeroNFSeNaoImportadoDoRetorno then
    begin
      //
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
        Form7.ibDataset15.Edit;
      if RetornaValorDaTagNoCampo('numero_nfse', Form7.ibDAtaSet15RECIBOXML.AsString)  <> '' then
        Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('numero_nfse',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('serie_nfse',Form7.ibDAtaSet15RECIBOXML.AsString));

      {Sandro Silva 2022-10-06 inicio}
      if NumeroNFSeNaoImportadoDoRetorno then
      begin
        if RetornaValorDaTagNoCampo('tc:Numero', Form7.ibDAtaSet15RECIBOXML.AsString)  <> '' then
          Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('tc:Numero',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('tc:Serie',Form7.ibDAtaSet15RECIBOXML.AsString));
      end;
      {Sandro Silva 2022-10-06 fim}

      //
      // Sandro Silva 2022-10-06 if pChar(Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)) = '000000000' then
      if NumeroNFSeNaoImportadoDoRetorno then
      begin
        if AllTrim(RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString)) <> '' then
        begin
          Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('SerieDoRPS',Form7.ibDAtaSet15RECIBOXML.AsString));
        end else
        begin
          Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := Limpanumero(Copy(Form7.ibDAtaSet15RECIBOXML.AsString,Pos('"numeroNFSe" :',Form7.ibDAtaSet15RECIBOXML.AsString)+16,10)) + '/1';
        end;
      end;
      //
      Form7.ibDAtaSet15.Post;
      Form7.ibDAtaSet15.Edit;
      //
    end;
  except end;
  //
  Result := True;
  //
end;

function CancelarNFSe(sP1: String) : Boolean;
begin
  //
  try
    //
    Form7.ibDAtaSet15.Edit;
    Form7.ibDAtaSet15RECIBOXML.AsString := sP1; // Calcelamento da NFSE
    Form7.ibDataSet15STATUS.AsString    := 'NFS-e cancelada';
    Form7.ibDataSet15EMITIDA.AsString   := 'X';
    //
    Form7.ibDAtaSet15.Post;
    //
    // Receber
    //
    if Form7.sModulo = 'VENDA' then
    begin
      //
      Form7.ibDataSet7.First;
      //
      if Copy(Form7.ibDataSet15STATUS.AsString,1,15) = 'NFS-e cancelada' then
      begin
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
          begin
            if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
            begin
              Form7.ibDataSet7.Edit;
              Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
            end else
            begin
              Form7.ibDataSet7.Edit;
              Form7.ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
            end;
            //
            Form7.ibDataSet7ATIVO.AsString := '1';
            Form7.ibDataSet7.Post;
            Form7.ibDataSet7.Next;
            //
          end else
          begin
            Form7.ibDataSet7.Next;
          end;
          //
        end;
        //
      end;
    end;
    //
    // CAIXA
    //
    ApagaIntegracaoComOCaixa(True);
    //
    // Relaciona os clientes com o arquivo de vendas
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    //
    // Data da ltima venda para o cliente
    //
    try
      Form7.ibDataSet2.Edit;
      Form7.ibDataSet2ULTIMACO.AsString := '';
      Form7.ibDataSet2.Post;
    except end;
    //
    AgendaCommit(True);
    Commitatudo(True); // Cancelamento NFS-e
    AbreArquivos(False);
    //
    Form7.Close;
    Form7.Show;
    //
  except end;
  //
  Result := True;
  //
end;


function ProdutoValidoParaMarketplace(bP1 : Boolean): String;
begin
  Result := '';
  try
    {Sandro Silva 2022-10-31 inicio
    //Alterado smallhub.com.br para tratar quando o marketplace exigir EAN
    if (ValidaEAN13(LimpaNumero(Form7.IBDataSet4.FieldByName('REFERENCIA').AsString)) = False) then // No tem mais EAN
      Result := Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': EAN invlido';
    }

    if (Length(LimpaNumero(Form7.IBDataSet4.FieldByName('CF').AsString)) <> 8) then // No tem NCM com 8 caracteres numricos
    begin
      if Trim(Result) <> '' then
        Result := Result + #13;
      Result := Result + Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': NCM invlido';
    end;

    if (Trim(Form7.IBDataSet4.FieldByName('NOME').AsString) = '') then
    begin
      if Trim(Result) <> '' then
        Result := Result + #13;
      Result := Result + Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': Grupo de estoque no informado';
    end;
  except
    Result := Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': No pode ser validado';
  end;

end;

(* // Sandro Silva 2022-09-12
function MostraNFSe(bP1 : Boolean): Boolean;
var
  F : TextFile;
  wNFSe : WideString;
begin
  //
  try
    //
    if Form7.WebBrowser2.Visible then
    begin
      //
      wNFSe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
      //
      if RetornaValorDaTagNoCampo('codigo_html',wNFSe) <> '' then
      begin
        //
        wNFSe := RetornaValorDaTagNoCampo('codigo_html',wNFSe);
        wNFSe := StrTran(StrTran(StrTran(StrTran( wNFSe,'&lt;','<'),'&gt;','>'),'&amp;nbsp;',' '),'&quot;','"');
//          wNFSe := StrTran(wNFSe,'Software FiscalWeb- IPM Sistemas - Protegido por Lei.','<a href="https://www.smallsoft.com.br">www.smallsoft.com.br</a>');
//          wNFSe := ConverteAcentos(wNFSe);
        //
        wNFSe := '<html>'+wNFSe+'<html>';
        AssignFile(F,pchar(Form1.sAtual+'\tempo.html'));  // Direciona o arquivo F para EXPORTA.TXT
        Rewrite(F);                  // Abre para gravao
        Write(F,wNFSe);
        CloseFile(F); // Fecha o arquivo
        Form7.WebBrowser2.Navigate(pChar(Form1.sAtual+'\tempo.html'));
        //
      end else
      begin
        //
        AssignFile(F,pchar(Form1.sAtual+'\tempo.htm'));  // Direciona o arquivo F para EXPORTA.TXT
        Rewrite(F);                  // Abre para gravao
        Writeln(F,'<html><head><title>Arquivo no encontrado</title></head>');
        WriteLn(F,'<table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        //
        WriteLn(F,'<center><br><font face="Microsoft Sans Serif" size=4>Arquivo da NFS-e no encontrado</font><br></center>');
        WriteLn(F,'<center><br><font face="Microsoft Sans Serif" size=1></b>Atualizado em'+Copy(DateTimeToStr(Date),1,2)+' de '
        + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
        + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br></center>');
        //
        // WWW
        //
        CloseFile(F);
        //
        Form7.WebBrowser2.Navigate(pChar(Form1.sAtual+'\tempo.htm'));
        //
      end;
      //
    end;
  except end;
  //
  Result := True;
  //
end;
*)

{Sandro Silva 2022-09-12 inicio 
function _ecf65_ValidaGtinNFCe(sEan: String): Boolean;
// Sandro Silva 2019-06-11
// Valida se o Gtin informado  vlido, usando ValidaEAN() e comparando o prefixo
// Prefixo 781 e 792 indicam EAN de uso interno no registrado no GS1
begin
  Result := ValidaEAN13(LimpaNumero(sEan));
  if Result then
  begin
    if (Copy(LimpaNumero(sEan), 1, 3) = '781') or (Copy(LimpaNumero(sEan), 1, 3) = '792') then
      Result := False;
  end;
end;
}

function Manifesto(iP1: integer) : Boolean;
var
  sJustificativa, sRetorno : String;
begin

  //
  // informar o tipo do Evento:
  //
  // Tipo do evento que deseja enviar:
  // 1: Confirmao da operao.
  // 2: Cincia da operao.
  // 3: Desconhecimento da operao.
  // 4: Operao no Realizada.
  //
  if Form7.spdNFe.Ambiente = spdNFeType.akProducao then
  begin
    //
    try
      //
      ConfiguraNfe(True);
      Form7.spdNFe.TimeOut                      := 60000*9; // A nota j esta no servidor mas no retorna aumentei o tempo para resolver isso
      //
      if iP1 = 4 then
      begin
        sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',chr(10)+'Informe uma justificativa (min. 15 caracteres)'+chr(10)+chr(10), ''));
      end else
      begin
        sJustificativa := '';
      end;
      //
      sRetorno       := Form7.spdNFe.EnviarManifestacaoDestinatario(iP1,pchar(Form7.ibDataSet24NFEID.AsString),pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)),sJustificativa,FormatDateTime('yyyy-mm-dd"T"hh:nn:"00"',Now),1,Form7.sFuso,'91');
      //
      if (Pos('<tpEvento>2102',sRetorno)<>0) then
      begin
        //
        // Cdigo do evento:
        //
        // 210200  Confirmao da Operao
        // 210210  Cincia da Operao
        // 210220  Desconhecimento da Operao
        // 210240  Operao no Realizada
        //
        if (Pos('<xMotivo>Rejeicao:',sRetorno)<>0) and (Pos('<cStat>573',sRetorno)=0)then // Retornou rejeio e no  rejeio por duplicidade
        begin
          //
          // ShowMessage(xmlNodeValue(sRetorno,'//retEvento/infEvento/xMotivo'));
          //
        end else
        begin
          Form7.ibDataSet24.Edit;
          Form7.ibDataSet24MDESTINXML.AsString := sRetorno;
          Form7.ibDataSet24.Post;
        end;
        //
      end else
      begin
        // ShowMessage(sRetorno);
      end;
    except end;
  end;
  //
  Result := True;
  //

end;

function xmlNodeXml(sXML: String; sNode: String): String;
//Sandro Silva 2012-02-08 inicio
// Extrai os elementos do xml
var
  XMLDOM: IXMLDOMDocument;
  iNode: Integer;
  xNodes: IXMLDOMNodeList;
begin
  XMLDOM := CoDOMDocument.Create;
  XMLDOM.loadXML(sXML);
  Result := '';
  xNodes := XMLDOM.selectNodes(sNode);
  for iNode := 0 to xNodes.length -1 do
  begin
    Result := xNodes.item[iNode].xml;
  end;
  XMLDOM := nil;
end;


function RecuperaXML(sP1: Boolean) : Boolean;
var
  sRetorno, wsNFeAssinada : String;
begin
  //
  if not FileExists( Form7.spdNFe.DiretorioXmlDestinatario + pChar(Form7.ibDataSet15NFEID.AsString) + '-nfe.xml') then
  begin
    //
    sRetorno       := Form7.spdNFe.ConsultarNF(Alltrim(Form7.ibDataSet15NFEID.AsString));
    wsNFeAssinada := Form7.ibDataSet15NFEXML.AsString;
    //
    if (Pos('<cStat>100</cStat>',sRetorno) <> 0) or (Pos('<cStat>150</cStat>',sRetorno) <> 0) then // 100|Autorizado o uso da NF-e ou 150|Autorizado o uso da NF-e, autorizao fora de prazo // Sandro Silva 2018-08-10
    begin
      //
      // Se foi autorizada faz a montagem do xml assinado com os dados da autorizao
      //
      if xmlNodeXML(sRetorno, '//protNFe') <> '' then
      begin
        //
        // conferir o digestvalue do retorno com a nota
        //
        if xmlNodeValue(sRetorno, '//infProt/digVal') = xmlNodeValue(wsNFeAssinada, '//DigestValue') then
        begin
          //
          sRetorno := '<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" versao="' + xmlNodeValue(wsNFeAssinada, '//infNFe/@versao') + '">' + wsNFeAssinada + xmlNodeXML(sRetorno, '//protNFe') + '</nfeProc>';
          //
          with TStringList.Create do
          begin
            Text := sRetorno;
            SaveToFile(Form7.spdNFe.DiretorioXmlDestinatario + '\' + Alltrim(Form7.ibDataSet15NFEID.AsString) + '-nfe.xml');
            Free;
          end;
        end;
      end;
    end;
  end;
  //
  if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
  Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
  //
  if (Pos('xMotivo',Form7.ibDataSet15NFEXML.AsString) <> 0) or (Pos('nProt',Form7.ibDataSet15NFEXML.AsString) <> 0) then
  begin
    Form7.ibDataSet15STATUS.AsString       := RetornaValorDaTagNoCampo('xMotivo',Form7.ibDataSet15NFEXML.AsString);
    Form7.ibDataSet15NFEPROTOCOLO.AsString := RetornaValorDaTagNoCampo('nProt',Form7.ibDataSet15NFEXML.AsString);
  end;
  //
  Form7.ibDataSet15.Post;
  //
  Result := True;
  //
end;

{Sandro Silva 2022-09-12 inicio
function FormatFloatXML(dValor: Double; iPrecisao: Integer = 2): String;
// Sandro Silva 2015-12-10 Formata valor float com as casas decimais para usar nos elementos do xml da nfce
// Parmetros:
// dValor: Valor a ser formatado
// iPrecisao: Quantidade de casas decimais resultante no valor formatado. Por default formata com 2 casas. Ex.: 2 casas = 0,00; 3 casas = 0,000
var
  sMascara: String;
begin
  sMascara := '##0.' + DupeString('0', iPrecisao);
  Result := StrTran(Alltrim(FormatFloat(sMascara, dValor)), ',', '.');
end;
}

function RetornaValorDaTagNoCampo(sTag: String; sObs: String): String;
// Extrai o valor do parmetro configurado
// Parmetros:
// sTag: Nome da tag parmetro
// sObs: Texto onde est a tag com a configurao
// Exemplo: Obs= <descANP>GLP</descANP> retorna: GLP
//          Obs= <descANP>GLP<descANP> retorna: GLP
var
  sTextoTag: String;
begin
  Result := '';
  sObs := Trim(sObs);
  sObs := StringReplace(sObs, #$D#$A, '', [rfReplaceAll]); // Eliminar quebras de linha geradas no cadastro de produto pelo campo blob
  if AnsiContainsText(sObs, '<' + sTag + '>') then
  begin
    sTextoTag := Copy(sObs, Pos('<' + sTag + '>', sObs) + Length('<' + sTag + '>'), Length(sObs));
    sTextoTag := StringReplace(STextoTag, '</' + sTag, '<' + sTag, []);
    Result := AllTrim(Copy(sTextoTag, 1, Pos('<' + sTag + '>', STextoTag) -1));
  end;
end;

function RetornaValorDaTagNoCampoCRLF(sTag: String; sObs: String): String;
// Extrai o valor do parmetro configurado
// Parmetros:
// sTag: Nome da tag parmetro
// sObs: Texto onde est a tag com a configurao
// Exemplo: Obs= <descANP>GLP</descANP> retorna: GLP
//          Obs= <descANP>GLP<descANP> retorna: GLP
var
  sTextoTag: String;
begin
  Result := '';
  sObs := Trim(sObs);
//  sObs := StringReplace(sObs, #$D#$A, '', [rfReplaceAll]); // Eliminar quebras de linha geradas no cadastro de produto pelo campo blob
  if AnsiContainsText(sObs, '<' + sTag + '>') then
  begin
    sTextoTag := Copy(sObs, Pos('<' + sTag + '>', sObs) + Length('<' + sTag + '>'), Length(sObs));
    sTextoTag := StringReplace(STextoTag, '</' + sTag, '<' + sTag, []);
    Result := AllTrim(Copy(sTextoTag, 1, Pos('<' + sTag + '>', STextoTag) -1));
  end;
end;


function ItemRejeicao(sRejeicao: String; sXml: String): String;
//Trata mensagens de erro do tipo: [nItem:1] Rejeicao: CFOP nao permitido para o CSOSN informado
// Parmetros:
// sRejeicao: Texto da rejeio retornado pelo servidor
// sXML: contedo xml da nf-e/nfc-e
var
  i: Integer;
begin
  if Pos('nItem', sRejeicao) > 0 then
  begin
    for i := Pos('nItem', sRejeicao) + Length('nItem:') to Length(sRejeicao) do
    begin
      if Copy(sRejeicao, i , 1) = ']' then
        Break;
      Result := Result + Copy(sRejeicao, i , 1);
    end;
  end;
  Result := Trim(Result);
  if Result <> '' then
  begin
    Result := xmlNodeValue(sXML, '//det[@nItem="' + Result + '"]/prod/cProd') + '-' + xmlNodeValue(sXML, '//det[@nItem="' + Result + '"]/prod/xProd');
  end;
end;

function CriaIBTransaction(IBDATABASE: TIBDatabase): TIBTransaction;
//Sandro Silva 2011-04-12 inicio
//Cria um objeto TIBTransaction
begin
  try
    Result := TIBTransaction.Create(Application);
    Result.Params.Add('read_committed');
    Result.Params.Add('rec_version');
    Result.Params.Add('nowait');
    Result.DefaultDatabase := IBDATABASE;
  except
    on E: Exception do
    begin
      ShowMessage(E.Message);
      Result := nil;
    end
  end;
end;

function TForm7.CriaIBQuery(IBTRANSACTION: TIBTransaction): TIBQuery;
//Sandro Silva 2011-04-12 inicio
//Cria um objeto TIBQuery
begin
  try
    Result := TIBQuery.Create(Application);
    Result.Database    := IBTRANSACTION.DefaultDataBase;
    Result.Transaction := IBTRANSACTION;
    Result.BufferChunks := 100; // 2014-02-26 Evitar Erro de out of memory
  except
    on E: Exception do
    begin
      ShowMessage(E.Message);
      Result := nil;
    end
  end;
end;

function DownloadNFeEmitida(sP1: String): Boolean;
var
  lXMLDocZip: IXMLDOMDocument;
  NodeZip: IXMLDOMNodeList;
  i: Integer;
  slXMLDescom: TStringList;
begin
  //
  try
    //
    if Pos('<cStat>653</cStat>',sP1) <> 0  then // NF-e Cancelada
    begin
      //
      if not (Form7.ibDataset24.State in ([dsEdit, dsInsert])) then Form7.ibDataset24.Edit;
      Form7.ibDataSet24EMITIDA.AsString    := 'X';
      //
    end;
    //
    // Seleciona os elementos contendo xml zipados
    //
    slXMLDescom := TStringList.Create; // Armazena o xml descompactado para extrair o id a ser baixado
    lXMLDocZip  := CoDOMDocument.Create; // No consigo fazer lXMLDocZip.Free
    //
    lXMLDocZip.loadXML(sP1);
    NodeZip     := lXMLDocZip.selectNodes('//retDistDFeInt/loteDistDFeInt/docZip');
    //
    for i := 0 to NodeZip.length - 1 do // Passa por todos os xml zipados
    begin
      //
      try
        //
        slXMLDescom.Clear;
        slXMLDescom.text := Form7.spdNFe.DescompactarXMLZip(NodeZip.item[i].text); // Descompacta xml zipado
        //
        if Pos('nfeProc',slXMLDescom.Text) <> 0 then
        begin
          //
          if (Pos('<cStat>100</cStat>',slXMLDescom.Text)<>0)  or (Pos('<cStat>150</cStat>',slXMLDescom.Text)<>0) then
          begin
            //
            try
              if Pos(Form7.ibDataset24NFEID.AsString,slXMLDescom.Text) <> 0 then
              begin
                //
                // Converter de ANSITOUTF8
                // Tira o cariage return (CR) e Line Fid (LF)
                //
                if not (Form7.ibDataset24.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset24.Edit;
                Form7.ibDataset24NFEXML.AsString := AnsiToUTF8(slXMLDescom.text);  // Grava o XML descompactado na tabela compras
                Form7.ibDataset24.Post;
                //
                // se liberar esta linha duplicava os itens Form7.ImportaNF(True,Form7.ibDataset24NFEXML.AsString); // Depois que o XML esta gravado importa os itens
                //
              end;
            except end;
          end;
        end;
      except
        on E: Exception do
        begin
          ShowMessage('Erro ao descompactar XML: '+E.Message);
        end
      end;
    end;
    //
    slXMLDescom.Free;
    lXMLDocZip := nil;
    //
  except
    //
    on E: Exception do
    begin
      ShowMessage('Erro 2503: '+E.Message);
    end
    //
  end;
  //
  Result := True;
  //
end;


function DownloadListaDeNFesEmitidas(sP1: String): Boolean;
var
  lXMLDocZip: IXMLDOMDocument;
  NodeZip: IXMLDOMNodeList;
  i: Integer;
  slXMLDescom: TStringList;
  Mais1Ini : tIniFile;
begin
  //
  try
    //
    if Pos('<cStat>137</cStat>',sP1) <> 0  then // No encontrou nenhuma nota
    begin
      //
      // Bloquear por uma hora
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
      Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao',TimeToStr(Time));
      Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
      Mais1Ini.Free;
      //
    end else
    begin
      //
      if xmlNodeValue(sP1, '//retDistDFeInt/ultNSU') <> '' then
      begin
        //
        // Liberar o bloquear por uma hora
        //
        Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
        Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao','00:00:00');
        Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
        Mais1Ini.Free;
        //
        Form1.ibQuery2.Close;
        Form1.ibQuery2.SQL.Clear;
        Form1.ibQuery2.SQL.Add('select gen_id(G_NSU_DOWNLOAD_XML,0) from rdb$database');
        Form1.ibQuery2.Open;
        //
        if StrToInt(Form1.ibQuery2.FieldByname('GEN_ID').AsString) = 0 then
        begin
          //
          // se G_NSU_DOWNLOAD_XML for igual a 0 entao grava a max nsu para no mexer no passado
          // ltimo NSU que tem disponvel para baixar <maxNSU>000000000010099</maxNSU>
          //
          try
            //
            if StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/maxNSU'))) < 50 then
            begin
              Form1.ibQuery2.Close;
              Form1.ibQuery2.SQL.Clear;
              Form1.ibQuery2.SQL.Add('set generator G_NSU_DOWNLOAD_XML to 2');
              Form1.ibQuery2.ExecSQL;
            end else
            begin
              Form1.ibQuery2.Close;
              Form1.ibQuery2.SQL.Clear;
              Form1.ibQuery2.SQL.Add('set generator G_NSU_DOWNLOAD_XML to '+IntToStr( StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/maxNSU')))-50 ));
              Form1.ibQuery2.ExecSQL;
            end;
            //
          except
            //
            // create generator G_NSU_DOWNLOAD_XML
            //
            on E: Exception do
            begin
              ShowMessage('Erro 2397: '+E.Message);
            end
            //
          end;
          //
          // ShowMessage('Gravando maxima nsu: '+IntToStr(StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/maxNSU')))));
          //
          // Descarta pra comear do zero...
          //
          {Sandro Silva 2023-01-05 inicio
          sP1 := '';
          }
          if Form1.DisponivelSomenteParaNos = False then //testando se precisa mesmo limpar a varivel para no importar a notas iniciais, quando CNPJ  novo, empresa nova constituda
            sP1 := '';
          {Sandro Silva 2023-01-05 fim}

          //
        end else
        begin
          //
          if StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/ultNSU'))) > 0 then // No pode zerar - Estava voltando zero quando consumo indevido
          begin
            //
            if Pos('<cStat>656</cStat>',sP1) = 0 then // No grava nada quando  consumo indevido
            begin
              Form1.ibQuery2.Close;
              Form1.ibQuery2.SQL.Clear;
              Form1.ibQuery2.SQL.Add('set generator G_NSU_DOWNLOAD_XML to '+IntToStr(StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/ultNSU')))));
              Form1.ibQuery2.ExecSQL;
            end;
            //
          end;
          //
          // ShowMessage('Gravando ltima nsu: '+IntToStr(StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/ultNSU')))));
          //
        end;
        //
        //
      end;
      //
      // Seleciona os elementos contendo xml zipados
      //
      slXMLDescom := TStringList.Create; // Armazena o xml descompactado para extrair o id a ser baixado
      lXMLDocZip  := CoDOMDocument.Create;
      //
      lXMLDocZip.loadXML(sP1);
      NodeZip     := lXMLDocZip.selectNodes('//retDistDFeInt/loteDistDFeInt/docZip');

      {Sandro Silva 2023-01-04 inicio
      if Form1.DisponivelSomenteParaNos then
      begin

        ShowMessage('teste 2888 ' + IntToStr(NodeZip.length));

        ShowMessage('teste 2892 ' + sP1);
        //Audita('DFE','SMALL', Senhas.UsuarioPub,'chNFE ' + xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe'),0,0); // Ato, Modulo, Usurio, Histrico, Valor
      end;
      {Sandro Silva 2023-01-04 fim}

      //
      for i := 0 to NodeZip.length - 1 do // Passa por todos os xml zipados
      begin
        //
        try
          //
          slXMLDescom.Clear;
          slXMLDescom.text := Form7.spdNFe.DescompactarXMLZip(NodeZip.item[i].text); // Descompacta xml zipado

          {Sandro Silva 2023-01-04 inicio
          if Form1.DisponivelSomenteParaNos then
          begin
            ShowMessage('teste 2913 ' + slXMLDescom.text);
          end;
          {Sandro Silva 2023-01-04 fim}

          //
          if xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe') <> '' then  // Valida se  a nota resumida
          begin
            //
            // Salvando dados para realizar o manifesto
            //
            try
              //
              Form7.IBQuery99.Close;
              Form7.IBQuery99.SQL.Clear;
              Form7.IBQuery99.SQL.Add('select NFEID, NUMERONF from COMPRAS where NFEID='+QuotedStr(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')))+' ');
              Form7.IBQuery99.Open;
              //
              if AllTrim(Form7.iBQuery99.FieldByName('NFEID').AsString) = '' then
              begin
                //
                Form7.ibDataSet24.Append;
                Form7.ibDataSet24NUMERONF.AsString   := Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')),26,9)+Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')),23,3);
                Form7.ibDataSet24FORNECEDOR.AsString := pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/xNome'));
                Form7.ibDataSet24NFEID.AsString      := pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')); // COVID19
                Form7.ibDataSet24TOTAL.AsFloat       := StrToFloat(StrTran(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/vNF')),'.',','));
                Form7.ibDataSet24EMISSAO.AsDateTime  := StrToDate(Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/dhEmi')),9,2)+'/'+Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/dhEmi')),6,2)+'/'+Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/dhEmi')),1,4));
                //
                Form7.ibDataSet24.Post;
                //
              end;
              //
            except
              on E: Exception do
              begin
                ShowMessage('Erro 2491 ao baixar lista de NF-es emitidas: '+E.Message);
              end
            end;
          end else
          begin
            //
            // Salvando o xml 
            //
            // ShowMessage('Teste NF-e ENTRADA NFEID: '+pChar(xmlNodeValue(slXMLDescom.Text, '//infProt/chNFe')));
            //
            Form7.ibDataSet24.Close;
            Form7.ibDataSet24.SelectSQL.Clear;
            Form7.ibDataSet24.SelectSQL.Add('select * from COMPRAS where NFEID = '+QuotedStr(pChar(xmlNodeValue(slXMLDescom.Text, '//infProt/chNFe')))+'');
            Form7.ibDataSet24.Open;
            //   

            if Pos(Form7.ibDataset24NFEID.AsString,slXMLDescom.Text) <> 0 then
            begin
              //
              // ShowMessage('Teste NF-e ENTRADA NF-e encontrada');
              //
              if (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) = 0) and (Pos('<procEventoNFe',Form7.ibDataSet24NFEXML.AsString) = 0) then
              begin

                {Sandro Silva 2023-01-04 inicio
                if Form1.DisponivelSomenteParaNos then
                begin
                  ShowMessage('teste 2985 ' + slXMLDescom.text);
                end;
                {Sandro Silva 2023-01-04 fim}                   

                //
                // Teste problema importao das NF-e de entrada
                //
                if not (Form7.ibDataset24.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset24.Edit;
                Form7.ibDataset24NFEXML.AsString := AnsiToUTF8(slXMLDescom.text);  // Grava o XML descompactado na tabela compras
                Form7.ibDataset24.Post;
                //
                // ShowMessage('Teste XML gravado na NF-e de COMPRA');
                // ShowMessage(Form7.ibDataSet24NFEXML.AsString);
                //
              end;

            end;

            //
          end;
        except
          on E: Exception do
          begin
            ShowMessage('Erro 2501 ao baixar lista de NF-es emitidas: '+E.Message);
          end
        end;
      end;
      //
      slXMLDescom.Free;
      lXMLDocZip := nil;
      //
    end;
    //
  except
    //
    on E: Exception do
    begin
      ShowMessage('Erro 2503 ao baixar lista de NF-es emitidas: '+E.Message);
    end
    //
  end;
  //
  Result := True;
  //
end;

function HasHs(sP1: String; bP2: Boolean): boolean;
var
  IBQHASH: TIBQuery;
  IBTHASH: TIBTransaction;
begin
  //
  if bP2 then
  begin
    Form7.ibQuery1.Close;
    Form7.ibQuery1.SQL.Clear;
    Form7.ibQuery1.SQL.Add('select gen_id(G_HASH_'+sP1+',0) as TOTALREG from rdb$database');
    Form7.ibQuery1.Open;

    try


      IBTHASH := CriaIBTransaction(Form7.ibQuery1.Transaction.DefaultDatabase);
      IBQHASH := Form7.CriaIBQuery(IBTHASH);

      Form7.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta

      IBQHASH.Close;
      IBQHASH.SQL.Clear;
      IBQHASH.SQL.Add('update HASHS set ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery1.FieldByName('TOTALREG').AsString))))+' where TABELA='+QuotedStr(sP1)+' ');
      IBQHASH.ExecSQL;

      if IBQHASH.RowsAffected = 0 then
      begin
        //2015-11-26 No existe ainda controle de hash da tabela
        IBQHASH.Close;
        IBQHASH.SQL.Clear;
        IBQHASH.SQL.Add('insert into HASHS(TABELA, ENCRYPTHASH) values(' + QuotedStr(sP1) + ',' + QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery1.FieldByName('TOTALREG').AsString)))) + ')');
        IBQHASH.ExecSQL;
      end;

      IBQHASH.Transaction.Commit;

      IBTHASH.Free;
      IBQHASH.Free;

    except

    end;
    //
    Result := True;
    //
  end else
  begin
    //
    Commitatudo(True);
    //
    Form7.ibQuery2.Close;
    Form7.ibQuery2.SQL.Clear;
    Form7.ibQuery2.SQL.Add('select count(REGISTRO) from '+sP1+' ');
    Form7.ibQuery2.Open;

    //Teste 01
    Form7.ibQuery1.Close;
    Form7.ibQuery1.SQL.Clear;
    Form7.ibQuery1.SQL.Add('select gen_id(G_HASH_'+sP1+',0) as TOTALREG from rdb$database');
    Form7.ibQuery1.Open;

    //LogFrente('Teste 01: ' + sP1 + ' Registros ' + Form7.IBQuery2.FieldByName('count').AsString + ' hash ' + Form7.IBQuery1.FieldByName('TOTALREG').AsString);


    //
    Form7.ibQuery1.Close;
    Form7.ibQuery1.SQL.Clear;
    Form7.ibQuery1.SQL.Add('select ENCRYPTHASH from HASHS where TABELA='+QuotedStr(sP1)+' ');
    Form7.ibQuery1.Open;
    //
    //  ShowMessage('Gravado no HASHs: '+ Form7.ibQuery1.FieldByName('ENCRYPTHASH').AsString
    //   +chr(10)+   'Contador de regs: '+ Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery2.FieldByName('COUNT').AsString))));
    //    );
    //
    //sHash := Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery2.FieldByName('COUNT').AsString)));
    if Form7.ibQuery1.FieldByName('ENCRYPTHASH').AsString = Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery2.FieldByName('COUNT').AsString))) then
    begin
      Result := True;
    end else
    begin
      Result := False;
    end;
    //
  end;
  //
  // Ok testado
  //
end;


/////////////////////////////////
function AssinaRegistro(pNome: String; DataSet: TDataSet; bAssina: Boolean): Boolean;
var
  s, sAntigo : String;
  sSemCest, sAntigoSemCest : String; // Sandro Silva 2017-11-13  HOMOLOGA 2017 compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior
  sAntigoENCRYPTHASH, sAntigoSemCestENCRYPTHASH: String;
begin
  //
  Result := True;
  s := '';
  //
  try
    //Sandro Silva 2017-11-09 inicio Polimig
    //
    //
    if pNome = 'EMITENTE' then
    begin
      //
      sAntigo :=
      VarToStr(DataSet.FieldByname('CGC').OldValue)+
      VarToStr(DataSet.FieldByname('IE').OldValue);;
      s :=
      DataSet.FieldByname('CGC').AsString+
      DataSet.FieldByname('IE').AsString;
      //
      //
    end;
    //
    if pNome = 'VENDA' then
    begin
      //
      sAntigo :=
      VarToStr(DataSet.FieldByname('NUMERONF').OldValue)+
      VarToStr(DataSet.FieldByname('MODELO').OldValue)+
      VarToStr(DataSet.FieldByname('VENDEDOR').OldValue)+
      VarToStr(DataSet.FieldByname('CLIENTE').OldValue)+
      VarToStr(DataSet.FieldByname('OPERACAO').OldValue)+
      VarToStr(DataSet.FieldByname('EMISSAO').OldValue)+
      VarToStr(DataSet.FieldByname('FRETE').OldValue)+
      VarToStr(DataSet.FieldByname('SEGURO').OldValue)+
      VarToStr(DataSet.FieldByname('DESPESAS').OldValue)+
      VarToStr(DataSet.FieldByname('DESCONTO').OldValue)+
      VarToStr(DataSet.FieldByname('VOLUMES').OldValue)+
      VarToStr(DataSet.FieldByname('ESPECIE').OldValue)+
      VarToStr(DataSet.FieldByname('MARCA').OldValue)+
      VarToStr(DataSet.FieldByname('TRANSPORTA').OldValue)+
      VarToStr(DataSet.FieldByname('FRETE12').OldValue)+
      VarToStr(DataSet.FieldByname('SAIDAH').OldValue)+
      VarToStr(DataSet.FieldByname('SAIDAD').OldValue)+
      VarToStr(DataSet.FieldByname('DUPLICATAS').OldValue)+
      VarToStr(DataSet.FieldByname('BASEICM').OldValue)+
      VarToStr(DataSet.FieldByname('BASEISS').OldValue)+
      VarToStr(DataSet.FieldByname('ICMS').OldValue)+
      VarToStr(DataSet.FieldByname('ICMSSUBSTI').OldValue)+
      VarToStr(DataSet.FieldByname('BASESUBSTI').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQUOTA').OldValue)+
      VarToStr(DataSet.FieldByname('ISS').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('TOTAL').OldValue)+
      VarToStr(DataSet.FieldByname('MERCADORIA').OldValue)+
      VarToStr(DataSet.FieldByname('EMITIDA').OldValue)+
      VarToStr(DataSet.FieldByname('SERVICOS').OldValue)+
      VarToStr(DataSet.FieldByname('PESOBRUTO').OldValue)+
      VarToStr(DataSet.FieldByname('PESOLIQUI').OldValue)+
      VarToStr(DataSet.FieldByname('REGISTRO').OldValue)+
      VarToStr(DataSet.FieldByname('NSUH').OldValue)+
      VarToStr(DataSet.FieldByname('NSU').OldValue)+
      VarToStr(DataSet.FieldByname('NSUD').OldValue)+
      VarToStr(DataSet.FieldByname('IDENTIFICADOR1').OldValue)+
      VarToStr(DataSet.FieldByname('COMPLEMENTO').OldValue)+
      VarToStr(DataSet.FieldByname('NVOL').OldValue)+
      VarToStr(DataSet.FieldByname('LOKED').OldValue)+
      VarToStr(DataSet.FieldByname('NFEPROTOCOLO').OldValue)+
      VarToStr(DataSet.FieldByname('STATUS').OldValue)+
      VarToStr(DataSet.FieldByname('NFEID').OldValue)+
      VarToStr(DataSet.FieldByname('NFERECIBO').OldValue)+
      VarToStr(DataSet.FieldByname('PLACA').OldValue)+
      VarToStr(DataSet.FieldByname('ANVISA').OldValue)+
      VarToStr(DataSet.FieldByname('DATA_CANCEL').OldValue)+
      VarToStr(DataSet.FieldByname('HORA_CANCEL').OldValue)+
      VarToStr(DataSet.FieldByname('COD_SIT').OldValue)+
      VarToStr(DataSet.FieldByname('FINNF').OldValue)+
      VarToStr(DataSet.FieldByname('INDFINAL').OldValue)+
      VarToStr(DataSet.FieldByname('INDPRES').OldValue);
      s :=
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('MODELO').AsString+
      DataSet.FieldByname('VENDEDOR').AsString+
      DataSet.FieldByname('CLIENTE').AsString+
      DataSet.FieldByname('OPERACAO').AsString+
      DataSet.FieldByname('EMISSAO').AsString+
      DataSet.FieldByname('FRETE').AsString+
      DataSet.FieldByname('SEGURO').AsString+
      DataSet.FieldByname('DESPESAS').AsString+
      DataSet.FieldByname('DESCONTO').AsString+
      DataSet.FieldByname('VOLUMES').AsString+
      DataSet.FieldByname('ESPECIE').AsString+
      DataSet.FieldByname('MARCA').AsString+
      DataSet.FieldByname('TRANSPORTA').AsString+
      DataSet.FieldByname('FRETE12').AsString+
      DataSet.FieldByname('SAIDAH').AsString+
      DataSet.FieldByname('SAIDAD').AsString+
      DataSet.FieldByname('DUPLICATAS').AsString+
      DataSet.FieldByname('BASEICM').AsString+
      DataSet.FieldByname('BASEISS').AsString+
      DataSet.FieldByname('ICMS').AsString+
      DataSet.FieldByname('ICMSSUBSTI').AsString+
      DataSet.FieldByname('BASESUBSTI').AsString+
      DataSet.FieldByname('ALIQUOTA').AsString+
      DataSet.FieldByname('ISS').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('MERCADORIA').AsString+
      DataSet.FieldByname('EMITIDA').AsString+
      DataSet.FieldByname('SERVICOS').AsString+
      DataSet.FieldByname('PESOBRUTO').AsString+
      DataSet.FieldByname('PESOLIQUI').AsString+
      DataSet.FieldByname('REGISTRO').AsString+
      DataSet.FieldByname('NSUH').AsString+
      DataSet.FieldByname('NSU').AsString+
      DataSet.FieldByname('NSUD').AsString+
      DataSet.FieldByname('IDENTIFICADOR1').AsString+
      DataSet.FieldByname('COMPLEMENTO').AsString+
      DataSet.FieldByname('NVOL').AsString+
      DataSet.FieldByname('LOKED').AsString+
      DataSet.FieldByname('NFEPROTOCOLO').AsString+
      DataSet.FieldByname('STATUS').AsString+
      DataSet.FieldByname('NFEID').AsString+
      DataSet.FieldByname('NFERECIBO').AsString+
      DataSet.FieldByname('PLACA').AsString+
      DataSet.FieldByname('ANVISA').AsString+
      DataSet.FieldByname('DATA_CANCEL').AsString+
      DataSet.FieldByname('HORA_CANCEL').AsString+
      DataSet.FieldByname('COD_SIT').AsString+
      DataSet.FieldByname('FINNF').AsString+
      DataSet.FieldByname('INDFINAL').AsString+
      DataSet.FieldByname('INDPRES').AsString;
      //
    end;
    //
    if pNome = 'ITENS001' then
    begin
      //
      sAntigo :=
      VarToStr(DataSet.FieldByname('NUMERONF').OldValue)+
      VarToStr(DataSet.FieldByname('CODIGO').OldValue)+
      VarToStr(DataSet.FieldByname('DESCRICAO').OldValue)+
      VarToStr(DataSet.FieldByname('ST').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('ICM').OldValue)+
      VarToStr(DataSet.FieldByname('ISS').OldValue)+
      VarToStr(DataSet.FieldByname('MEDIDA').OldValue)+
      VarToStr(DataSet.FieldByname('QUANTIDADE').OldValue)+
      VarToStr(DataSet.FieldByname('SINCRONIA').OldValue)+
      VarToStr(DataSet.FieldByname('UNITARIO').OldValue)+
      VarToStr(DataSet.FieldByname('TOTAL').OldValue)+
      VarToStr(DataSet.FieldByname('LISTA').OldValue)+
      VarToStr(DataSet.FieldByname('CUSTO').OldValue)+
      VarToStr(DataSet.FieldByname('PESO').OldValue)+
      VarToStr(DataSet.FieldByname('BASE').OldValue)+
      VarToStr(DataSet.FieldByname('BASEISS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQUOTA').OldValue)+
      VarToStr(DataSet.FieldByname('CFOP').OldValue)+
      VarToStr(DataSet.FieldByname('NUMEROOS').OldValue)+
      VarToStr(DataSet.FieldByname('REGISTRO').OldValue)+
      VarToStr(DataSet.FieldByname('XPED').OldValue)+
      VarToStr(DataSet.FieldByname('NITEMPED').OldValue)+
      VarToStr(DataSet.FieldByname('VICMS').OldValue)+
      VarToStr(DataSet.FieldByname('VBC').OldValue)+
      VarToStr(DataSet.FieldByname('VBCST').OldValue)+
      VarToStr(DataSet.FieldByname('VICMSST').OldValue)+
      VarToStr(DataSet.FieldByname('VIPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST_PIS_COFINS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQ_PIS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQ_COFINS').OldValue)+
      VarToStr(DataSet.FieldByname('CST_IPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST_ICMS').OldValue)+
      VarToStr(DataSet.FieldByname('ANVISA').OldValue)+
      VarToStr(DataSet.FieldByname('PFCPUFDEST').OldValue)+
      VarToStr(DataSet.FieldByname('PICMSUFDEST').OldValue);
      s :=
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('CODIGO').AsString+
      DataSet.FieldByname('DESCRICAO').AsString+
      DataSet.FieldByname('ST').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('ICM').AsString+
      DataSet.FieldByname('ISS').AsString+
      DataSet.FieldByname('MEDIDA').AsString+
      DataSet.FieldByname('QUANTIDADE').AsString+
      DataSet.FieldByname('SINCRONIA').AsString+
      DataSet.FieldByname('UNITARIO').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('LISTA').AsString+
      DataSet.FieldByname('CUSTO').AsString+
      DataSet.FieldByname('PESO').AsString+
      DataSet.FieldByname('BASE').AsString+
      DataSet.FieldByname('BASEISS').AsString+
      DataSet.FieldByname('ALIQUOTA').AsString+
      DataSet.FieldByname('CFOP').AsString+
      DataSet.FieldByname('NUMEROOS').AsString+
      DataSet.FieldByname('REGISTRO').AsString+
      DataSet.FieldByname('XPED').AsString+
      DataSet.FieldByname('NITEMPED').AsString+
      DataSet.FieldByname('VICMS').AsString+
      DataSet.FieldByname('VBC').AsString+
      DataSet.FieldByname('VBCST').AsString+
      DataSet.FieldByname('VICMSST').AsString+
      DataSet.FieldByname('VIPI').AsString+
      DataSet.FieldByname('CST_PIS_COFINS').AsString+
      DataSet.FieldByname('ALIQ_PIS').AsString+
      DataSet.FieldByname('ALIQ_COFINS').AsString+
      DataSet.FieldByname('CST_IPI').AsString+
      DataSet.FieldByname('CST_ICMS').AsString+
      DataSet.FieldByname('ANVISA').AsString+
      DataSet.FieldByname('PFCPUFDEST').AsString+
      DataSet.FieldByname('PICMSUFDEST').AsString;
      //
    end;
    //Sandro Silva 2017-11-09 final Polimig
    if pNome = 'ESTOQUE' then
    begin
      //Sandro Silva 2017-11-13 inicio HOMOLOGA 2017
      // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior
      sAntigoSemCest :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('REFERENCIA').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('NOME').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('PRECO').OldValue)+
        VarToStr(DataSet.FieldByName('QTD_ATUAL').OldValue)+
        VarToStr(DataSet.FieldByName('DAT_INICIO').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_COMPRA').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_VENDA').OldValue)+
        VarToStr(DataSet.FieldByName('CF').OldValue)+
        VarToStr(DataSet.FieldByName('IPI').OldValue)+
        VarToStr(DataSet.FieldByName('CST').OldValue)+
        VarToStr(DataSet.FieldByName('ST').OldValue)+
        VarToStr(DataSet.FieldByName('IAT').OldValue)+
        VarToStr(DataSet.FieldByName('IPPT').OldValue);
      {Sandro Silva 2017-11-13 final HOMOLOGA 2017}
      sAntigo :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('REFERENCIA').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('NOME').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('PRECO').OldValue)+
        VarToStr(DataSet.FieldByName('QTD_ATUAL').OldValue)+
        VarToStr(DataSet.FieldByName('DAT_INICIO').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_COMPRA').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_VENDA').OldValue)+
        VarToStr(DataSet.FieldByName('CF').OldValue)+
        VarToStr(DataSet.FieldByName('IPI').OldValue)+
        VarToStr(DataSet.FieldByName('CST').OldValue)+
        VarToStr(DataSet.FieldByName('ST').OldValue)+
        VarToStr(DataSet.FieldByName('IAT').OldValue)+
        VarToStr(DataSet.FieldByName('CEST').OldValue)+
        VarToStr(DataSet.FieldByName('IPPT').OldValue);

      //Sandro Silva 2017-11-13 inicio HOMOLOGA 2017
      // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior
      sSemCest :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('REFERENCIA').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('NOME').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('PRECO').AsString+
        DataSet.FieldByName('QTD_ATUAL').AsString+
        DataSet.FieldByName('DAT_INICIO').AsString+
        DataSet.FieldByName('ULT_COMPRA').AsString+
        DataSet.FieldByName('ULT_VENDA').AsString+
        DataSet.FieldByName('CF').AsString+
        DataSet.FieldByName('IPI').AsString+
        DataSet.FieldByName('CST').AsString+
        DataSet.FieldByName('ST').AsString+
        DataSet.FieldByName('IAT').AsString+
        DataSet.FieldByName('IPPT').AsString;
      //Sandro Silva 2017-11-13 final HOMOLOGA 2017

      s :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('REFERENCIA').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('NOME').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('PRECO').AsString+
        DataSet.FieldByName('QTD_ATUAL').AsString+
        DataSet.FieldByName('DAT_INICIO').AsString+
        DataSet.FieldByName('ULT_COMPRA').AsString+
        DataSet.FieldByName('ULT_VENDA').AsString+
        DataSet.FieldByName('CF').AsString+
        DataSet.FieldByName('IPI').AsString+
        DataSet.FieldByName('CST').AsString+
        DataSet.FieldByName('ST').AsString+
        DataSet.FieldByName('IAT').AsString+
        DataSet.FieldByName('CEST').AsString+
        DataSet.FieldByName('IPPT').AsString;
    end;
    //
    if pNome = 'ALTERACA' then
    begin
      //Sandro Silva 2018-05-25 inicio
      sAntigo :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('QUANTIDADE').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('UNITARIO').OldValue)+
        VarToStr(DataSet.FieldByName('TOTAL').OldValue)+
        VarToStr(DataSet.FieldByName('DATA').OldValue)+
        VarToStr(DataSet.FieldByName('TIPO').OldValue)+
        VarToStr(DataSet.FieldByName('PEDIDO').OldValue)+
        VarToStr(DataSet.FieldByName('ITEM').OldValue)+
        VarToStr(DataSet.FieldByName('VENDEDOR').OldValue)+
        VarToStr(DataSet.FieldByName('CLIFOR').OldValue)+
        VarToStr(DataSet.FieldByName('CAIXA').OldValue)+
        VarToStr(DataSet.FieldByName('VALORICM').OldValue)+
        VarToStr(DataSet.FieldByName('ALIQUICM').OldValue)+
        VarToStr(DataSet.FieldByName('HORA').OldValue)+
        VarToStr(DataSet.FieldByName('DAV').OldValue)+
        VarToStr(DataSet.FieldByName('TIPODAV').OldValue)+
        VarToStr(DataSet.FieldByName('COO').OldValue)+
        VarToStr(DataSet.FieldByName('CCF').OldValue)+
        VarToStr(DataSet.FieldByName('SERIE').OldValue)+
        VarToStr(DataSet.FieldByName('SUBSERIE').OldValue)+
        VarToStr(DataSet.FieldByName('CNPJ').OldValue)+
        VarToStr(DataSet.FieldByName('REFERENCIA').OldValue);
      //Sandro Silva 2018-05-25 fim
      s :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('QUANTIDADE').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('UNITARIO').AsString+
        DataSet.FieldByName('TOTAL').AsString+
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('TIPO').AsString+
        DataSet.FieldByName('PEDIDO').AsString+
        DataSet.FieldByName('ITEM').AsString+
        DataSet.FieldByName('VENDEDOR').AsString+
        DataSet.FieldByName('CLIFOR').AsString+
        DataSet.FieldByName('CAIXA').AsString+
        DataSet.FieldByName('VALORICM').AsString+
        DataSet.FieldByName('ALIQUICM').AsString+
        DataSet.FieldByName('HORA').AsString+
        DataSet.FieldByName('DAV').AsString+
        DataSet.FieldByName('TIPODAV').AsString+
        DataSet.FieldByName('COO').AsString+
        DataSet.FieldByName('CCF').AsString+
        DataSet.FieldByName('SERIE').AsString+
        DataSet.FieldByName('SUBSERIE').AsString+
        DataSet.FieldByName('CNPJ').AsString+
        DataSet.FieldByName('REFERENCIA').AsString;
      //
    end;
    //
    if pNome = 'REDUCOES' then
    begin
      s :=
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('HORA').AsString+
        DataSet.FieldByName('SERIE').AsString+
        DataSet.FieldByName('PDV').AsString+
        DataSet.FieldByName('TIPOECF').AsString+
        DataSet.FieldByName('MARCAECF').AsString+
        DataSet.FieldByName('MODELOECF').AsString+
        DataSet.FieldByName('VERSAOSB').AsString+
        DataSet.FieldByName('DATASB').AsString+
        DataSet.FieldByName('HORASB').AsString+
        DataSet.FieldByName('CUPOMI').AsString+
        DataSet.FieldByName('CUPOMF').AsString+
        DataSet.FieldByName('CONTADORZ').AsString+
        DataSet.FieldByName('TOTALI').AsString+
        DataSet.FieldByName('TOTALF').AsString+
        DataSet.FieldByName('ALIQUOTA01').AsString+
        DataSet.FieldByName('ALIQUOTA02').AsString+
        DataSet.FieldByName('ALIQUOTA03').AsString+
        DataSet.FieldByName('ALIQUOTA04').AsString+
        DataSet.FieldByName('ALIQUOTA05').AsString+
        DataSet.FieldByName('ALIQUOTA06').AsString+
        DataSet.FieldByName('ALIQUOTA07').AsString+
        DataSet.FieldByName('ALIQUOTA08').AsString+
        DataSet.FieldByName('ALIQUOTA09').AsString+
        DataSet.FieldByName('ALIQUOTA10').AsString+
        DataSet.FieldByName('ALIQUOTA11').AsString+
        DataSet.FieldByName('ALIQUOTA12').AsString+
        DataSet.FieldByName('ALIQUOTA13').AsString+
        DataSet.FieldByName('ALIQUOTA14').AsString+
        DataSet.FieldByName('ALIQUOTA15').AsString+
        DataSet.FieldByName('ALIQUOTA16').AsString+
        DataSet.FieldByName('ALIQUOTA17').AsString+
        DataSet.FieldByName('ALIQUOTA18').AsString+
        DataSet.FieldByName('ALIQUOTA19').AsString+
        DataSet.FieldByName('ALIQU01').AsString+
        DataSet.FieldByName('ALIQU02').AsString+
        DataSet.FieldByName('ALIQU03').AsString+
        DataSet.FieldByName('ALIQU04').AsString+
        DataSet.FieldByName('ALIQU05').AsString+
        DataSet.FieldByName('ALIQU06').AsString+
        DataSet.FieldByName('ALIQU07').AsString+
        DataSet.FieldByName('ALIQU08').AsString+
        DataSet.FieldByName('ALIQU09').AsString+
        DataSet.FieldByName('ALIQU10').AsString+
        DataSet.FieldByName('ALIQU11').AsString+
        DataSet.FieldByName('ALIQU12').AsString+
        DataSet.FieldByName('ALIQU13').AsString+
        DataSet.FieldByName('ALIQU14').AsString+
        DataSet.FieldByName('ALIQU15').AsString+
        DataSet.FieldByName('ALIQU16').AsString+
        DataSet.FieldByName('CANCELAMEN').AsString+
        DataSet.FieldByName('DESCONTOS').AsString+
        DataSet.FieldByName('ISSQN').AsString+
        DataSet.FieldByName('SMALL').AsString+
        DataSet.FieldByName('STATUS').AsString+
        DataSet.FieldByName('ESTOQUE').AsString;
      //
      //
    end;
    //
    if pNome = 'ORCAMENT' then
    begin
      s :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('QUANTIDADE').AsString+
        DataSet.FieldByName('UNITARIO').AsString+
        DataSet.FieldByName('TOTAL').AsString+
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('TIPO').AsString+
        DataSet.FieldByName('PEDIDO').AsString+
        DataSet.FieldByName('CLIFOR').AsString+
        DataSet.FieldByName('VENDEDOR').AsString+
        DataSet.FieldByName('CAIXA').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('ITEM').AsString+
        DataSet.FieldByName('VALORICM').AsString+
        DataSet.FieldByName('ALIQUICM').AsString+
        DataSet.FieldByName('NUMERONF').AsString+
        DataSet.FieldByName('COO').AsString;
      //

    end;
    //
    if pNome = 'PAGAMENT' then
    begin
      s :=
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('PEDIDO').AsString+
        DataSet.FieldByName('COO').AsString+
        DataSet.FieldByName('CCF').AsString+
        DataSet.FieldByName('CAIXA').AsString+
        DataSet.FieldByName('CLIFOR').AsString+
        DataSet.FieldByName('VENDEDOR').AsString+
        DataSet.FieldByName('FORMA').AsString+
        DataSet.FieldByName('VALOR').AsString+
        DataSet.FieldByName('GRG').AsString+
        DataSet.FieldByName('CDC').AsString+
        DataSet.FieldByName('GNF').AsString;
      //
    end;
    //
    if pNome = 'DEMAIS' then
    begin
      //
      s :=
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('HORA').AsString+
        DataSet.FieldByName('ECF').AsString+
        DataSet.FieldByName('DENOMINACAO').AsString+
        DataSet.FieldByName('COO').AsString+
        DataSet.FieldByName('GNF').AsString+
        DataSet.FieldByName('CDC').AsString+
        DataSet.FieldByName('GRG').AsString;
      //
    end;
    //

    //Sandro Silva 2015-10-01 inicio
    if pNome = 'ECFS' then
    begin
      //
      s := DataSet.FieldByName('SERIE').AsString;
      //
    end;
    //Sandro Silva 2015-10-01 final

    //
    //
    Form1.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta
    //

    if (pNome = 'ALTERACA') or (pNome = 'ESTOQUE') then 
    begin
      sAntigoENCRYPTHASH        := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)));
      sAntigoSemCestENCRYPTHASH := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigoSemCest)));
      //ShowMessage('Teste 01 9450 ' + #13 +
      //            'hash antigo ' + sAntigoENCRYPTHASH + #13 +
      //            'hash antigo sem cest ' + sAntigoSemCestENCRYPTHASH + #13 +
      //            'hash banco ' + DataSet.FieldByName('ENCRYPTHASH').AsString);
    end;


    if bAssina then
    begin
      // Assina registro
      //
      if pNome = 'ESTOQUE' then
      begin
//        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigoSemCest)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)))) or (DataSet.FieldByName('ENCRYPTHASH').isNull) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) then // Se o registro j foi violado no assina mais fica asssim pra sempre
        begin
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(s))); // Encrypta e grava o hash do registro
        end;
      end else
      begin
        // Sandro Silva
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) or (DataSet.FieldByName('ENCRYPTHASH').isNull) then // Se o registro j foi violado no assina mais fica asssim pra sempre // Sandro Silva 2018-05-25
        begin
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(s))); // Encrypta e grava o hash do registro
        end;
      end;
      //
    end else
    begin
      // Sandro Silva
      if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(s)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) then  // Encrypta e compara o hash do registro
      begin
        Result := True;
      end else
      begin
        Result := False;
      end;

      //Sandro Silva 2017-11-13 inicio HOMOLOGA 2017
      // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior. Para os registros ainda no alterados pelo paf novo que ainda esto assinados pelo PAF antigo
      if (pNome = 'ESTOQUE') and (Result = False) then
      begin
        // Se resultou False deve validar hash com a assinatura da Verso anterior. Pode ser que o registro ainda no foi alterado aps atualizar para nova verso homologada sem campo CEST
        // Sandro Silva 
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sSemCest)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) then
        begin
          Result := True;
        end else
        begin
          Result := False;
        end;
      end;
      //Sandro Silva 2017-11-13 final HOMOLOGA 2017
    end;
  except ShowMessage('Erro ao criptografar head do registro do arquivo '+pNome) end;
  //
end;
///////////////////////////////////

{
function AssinaRegistro(pNome: String; DataSet: TDataSet; bP: Boolean): Boolean;
var
  s, sAntigo : String;
begin
  //
  Result := True;
  s := '';
  //
  try
    //
    if pNome = 'EMITENTE' then
    begin
      //
      sAntigo :=
      VarToStr(DataSet.FieldByname('CGC').OldValue)+
      VarToStr(DataSet.FieldByname('IE').OldValue);
      s :=
      DataSet.FieldByname('CGC').AsString+
      DataSet.FieldByname('IE').AsString;
      //
      //
    end;
    //
    if pNome = 'VENDA' then
    begin
      //
      sAntigo :=
      VarToStr(DataSet.FieldByname('NUMERONF').OldValue)+
      VarToStr(DataSet.FieldByname('MODELO').OldValue)+
      VarToStr(DataSet.FieldByname('VENDEDOR').OldValue)+
      VarToStr(DataSet.FieldByname('CLIENTE').OldValue)+
      VarToStr(DataSet.FieldByname('OPERACAO').OldValue)+
      VarToStr(DataSet.FieldByname('EMISSAO').OldValue)+
      VarToStr(DataSet.FieldByname('FRETE').OldValue)+
      VarToStr(DataSet.FieldByname('SEGURO').OldValue)+
      VarToStr(DataSet.FieldByname('DESPESAS').OldValue)+
      VarToStr(DataSet.FieldByname('DESCONTO').OldValue)+
      VarToStr(DataSet.FieldByname('VOLUMES').OldValue)+
      VarToStr(DataSet.FieldByname('ESPECIE').OldValue)+
      VarToStr(DataSet.FieldByname('MARCA').OldValue)+
      VarToStr(DataSet.FieldByname('TRANSPORTA').OldValue)+
      VarToStr(DataSet.FieldByname('FRETE12').OldValue)+
      VarToStr(DataSet.FieldByname('SAIDAH').OldValue)+
      VarToStr(DataSet.FieldByname('SAIDAD').OldValue)+
      VarToStr(DataSet.FieldByname('DUPLICATAS').OldValue)+
      VarToStr(DataSet.FieldByname('BASEICM').OldValue)+
      VarToStr(DataSet.FieldByname('BASEISS').OldValue)+
      VarToStr(DataSet.FieldByname('ICMS').OldValue)+
      VarToStr(DataSet.FieldByname('ICMSSUBSTI').OldValue)+
      VarToStr(DataSet.FieldByname('BASESUBSTI').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQUOTA').OldValue)+
      VarToStr(DataSet.FieldByname('ISS').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('TOTAL').OldValue)+
      VarToStr(DataSet.FieldByname('MERCADORIA').OldValue)+
      VarToStr(DataSet.FieldByname('EMITIDA').OldValue)+
      VarToStr(DataSet.FieldByname('SERVICOS').OldValue)+
      VarToStr(DataSet.FieldByname('PESOBRUTO').OldValue)+
      VarToStr(DataSet.FieldByname('PESOLIQUI').OldValue)+
      VarToStr(DataSet.FieldByname('REGISTRO').OldValue)+
      VarToStr(DataSet.FieldByname('NSUH').OldValue)+
      VarToStr(DataSet.FieldByname('NSU').OldValue)+
      VarToStr(DataSet.FieldByname('NSUD').OldValue)+
      VarToStr(DataSet.FieldByname('IDENTIFICADOR1').OldValue)+
      VarToStr(DataSet.FieldByname('COMPLEMENTO').OldValue)+
      VarToStr(DataSet.FieldByname('NVOL').OldValue)+
      VarToStr(DataSet.FieldByname('LOKED').OldValue)+
      VarToStr(DataSet.FieldByname('NFEPROTOCOLO').OldValue)+
      VarToStr(DataSet.FieldByname('STATUS').OldValue)+
      VarToStr(DataSet.FieldByname('NFEID').OldValue)+
      VarToStr(DataSet.FieldByname('NFERECIBO').OldValue)+
      VarToStr(DataSet.FieldByname('PLACA').OldValue)+
      VarToStr(DataSet.FieldByname('ANVISA').OldValue)+
      VarToStr(DataSet.FieldByname('DATA_CANCEL').OldValue)+
      VarToStr(DataSet.FieldByname('HORA_CANCEL').OldValue)+
      VarToStr(DataSet.FieldByname('COD_SIT').OldValue)+
      VarToStr(DataSet.FieldByname('FINNF').OldValue)+
      VarToStr(DataSet.FieldByname('INDFINAL').OldValue)+
      VarToStr(DataSet.FieldByname('INDPRES').OldValue);
      s :=
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('MODELO').AsString+
      DataSet.FieldByname('VENDEDOR').AsString+
      DataSet.FieldByname('CLIENTE').AsString+
      DataSet.FieldByname('OPERACAO').AsString+
      DataSet.FieldByname('EMISSAO').AsString+
      DataSet.FieldByname('FRETE').AsString+
      DataSet.FieldByname('SEGURO').AsString+
      DataSet.FieldByname('DESPESAS').AsString+
      DataSet.FieldByname('DESCONTO').AsString+
      DataSet.FieldByname('VOLUMES').AsString+
      DataSet.FieldByname('ESPECIE').AsString+
      DataSet.FieldByname('MARCA').AsString+
      DataSet.FieldByname('TRANSPORTA').AsString+
      DataSet.FieldByname('FRETE12').AsString+
      DataSet.FieldByname('SAIDAH').AsString+
      DataSet.FieldByname('SAIDAD').AsString+
      DataSet.FieldByname('DUPLICATAS').AsString+
      DataSet.FieldByname('BASEICM').AsString+
      DataSet.FieldByname('BASEISS').AsString+
      DataSet.FieldByname('ICMS').AsString+
      DataSet.FieldByname('ICMSSUBSTI').AsString+
      DataSet.FieldByname('BASESUBSTI').AsString+
      DataSet.FieldByname('ALIQUOTA').AsString+
      DataSet.FieldByname('ISS').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('MERCADORIA').AsString+
      DataSet.FieldByname('EMITIDA').AsString+
      DataSet.FieldByname('SERVICOS').AsString+
      DataSet.FieldByname('PESOBRUTO').AsString+
      DataSet.FieldByname('PESOLIQUI').AsString+
      DataSet.FieldByname('REGISTRO').AsString+
      DataSet.FieldByname('NSUH').AsString+
      DataSet.FieldByname('NSU').AsString+
      DataSet.FieldByname('NSUD').AsString+
      DataSet.FieldByname('IDENTIFICADOR1').AsString+
      DataSet.FieldByname('COMPLEMENTO').AsString+
      DataSet.FieldByname('NVOL').AsString+
      DataSet.FieldByname('LOKED').AsString+
      DataSet.FieldByname('NFEPROTOCOLO').AsString+
      DataSet.FieldByname('STATUS').AsString+
      DataSet.FieldByname('NFEID').AsString+
      DataSet.FieldByname('NFERECIBO').AsString+
      DataSet.FieldByname('PLACA').AsString+
      DataSet.FieldByname('ANVISA').AsString+
      DataSet.FieldByname('DATA_CANCEL').AsString+
      DataSet.FieldByname('HORA_CANCEL').AsString+
      DataSet.FieldByname('COD_SIT').AsString+
      DataSet.FieldByname('FINNF').AsString+
      DataSet.FieldByname('INDFINAL').AsString+
      DataSet.FieldByname('INDPRES').AsString;
      //
    end;
    //
    if pNome = 'ITENS001' then
    begin
      //
      sAntigo :=
      VarToStr(DataSet.FieldByname('NUMERONF').OldValue)+
      VarToStr(DataSet.FieldByname('CODIGO').OldValue)+
      VarToStr(DataSet.FieldByname('DESCRICAO').OldValue)+
      VarToStr(DataSet.FieldByname('ST').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('ICM').OldValue)+
      VarToStr(DataSet.FieldByname('ISS').OldValue)+
      VarToStr(DataSet.FieldByname('MEDIDA').OldValue)+
      VarToStr(DataSet.FieldByname('QUANTIDADE').OldValue)+
      VarToStr(DataSet.FieldByname('SINCRONIA').OldValue)+
      VarToStr(DataSet.FieldByname('UNITARIO').OldValue)+
      VarToStr(DataSet.FieldByname('TOTAL').OldValue)+
      VarToStr(DataSet.FieldByname('LISTA').OldValue)+
      VarToStr(DataSet.FieldByname('CUSTO').OldValue)+
      VarToStr(DataSet.FieldByname('PESO').OldValue)+
      VarToStr(DataSet.FieldByname('BASE').OldValue)+
      VarToStr(DataSet.FieldByname('BASEISS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQUOTA').OldValue)+
      VarToStr(DataSet.FieldByname('CFOP').OldValue)+
      VarToStr(DataSet.FieldByname('NUMEROOS').OldValue)+
      VarToStr(DataSet.FieldByname('REGISTRO').OldValue)+
      VarToStr(DataSet.FieldByname('XPED').OldValue)+
      VarToStr(DataSet.FieldByname('NITEMPED').OldValue)+
      VarToStr(DataSet.FieldByname('VICMS').OldValue)+
      VarToStr(DataSet.FieldByname('VBC').OldValue)+
      VarToStr(DataSet.FieldByname('VBCST').OldValue)+
      VarToStr(DataSet.FieldByname('VICMSST').OldValue)+
      VarToStr(DataSet.FieldByname('VIPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST_PIS_COFINS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQ_PIS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQ_COFINS').OldValue)+
      VarToStr(DataSet.FieldByname('CST_IPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST_ICMS').OldValue)+
      VarToStr(DataSet.FieldByname('ANVISA').OldValue)+
      VarToStr(DataSet.FieldByname('PFCPUFDEST').OldValue)+
      VarToStr(DataSet.FieldByname('PICMSUFDEST').OldValue);
      s :=
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('CODIGO').AsString+
      DataSet.FieldByname('DESCRICAO').AsString+
      DataSet.FieldByname('ST').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('ICM').AsString+
      DataSet.FieldByname('ISS').AsString+
      DataSet.FieldByname('MEDIDA').AsString+
      DataSet.FieldByname('QUANTIDADE').AsString+
      DataSet.FieldByname('SINCRONIA').AsString+
      DataSet.FieldByname('UNITARIO').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('LISTA').AsString+
      DataSet.FieldByname('CUSTO').AsString+
      DataSet.FieldByname('PESO').AsString+
      DataSet.FieldByname('BASE').AsString+
      DataSet.FieldByname('BASEISS').AsString+
      DataSet.FieldByname('ALIQUOTA').AsString+
      DataSet.FieldByname('CFOP').AsString+
      DataSet.FieldByname('NUMEROOS').AsString+
      DataSet.FieldByname('REGISTRO').AsString+
      DataSet.FieldByname('XPED').AsString+
      DataSet.FieldByname('NITEMPED').AsString+
      DataSet.FieldByname('VICMS').AsString+
      DataSet.FieldByname('VBC').AsString+
      DataSet.FieldByname('VBCST').AsString+
      DataSet.FieldByname('VICMSST').AsString+
      DataSet.FieldByname('VIPI').AsString+
      DataSet.FieldByname('CST_PIS_COFINS').AsString+
      DataSet.FieldByname('ALIQ_PIS').AsString+
      DataSet.FieldByname('ALIQ_COFINS').AsString+
      DataSet.FieldByname('CST_IPI').AsString+
      DataSet.FieldByname('CST_ICMS').AsString+
      DataSet.FieldByname('ANVISA').AsString+
      DataSet.FieldByname('PFCPUFDEST').AsString+
      DataSet.FieldByname('PICMSUFDEST').AsString;
      //
    end;
    //
    if pNome = 'ESTOQUE' then
    begin
      sAntigo :=
      VarToStr(DataSet.FieldByname('CODIGO').OldValue)+
      VarToStr(DataSet.FieldByname('REFERENCIA').OldValue)+
      VarToStr(DataSet.FieldByname('DESCRICAO').OldValue)+
      VarToStr(DataSet.FieldByname('NOME').OldValue)+
      VarToStr(DataSet.FieldByname('MEDIDA').OldValue)+
      VarToStr(DataSet.FieldByname('PRECO').OldValue)+
      VarToStr(DataSet.FieldByname('QTD_ATUAL').OldValue)+
      VarToStr(DataSet.FieldByname('DAT_INICIO').OldValue)+
      VarToStr(DataSet.FieldByname('ULT_COMPRA').OldValue)+
      VarToStr(DataSet.FieldByname('ULT_VENDA').OldValue)+
      VarToStr(DataSet.FieldByname('CF').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST').OldValue)+
      VarToStr(DataSet.FieldByname('ST').OldValue)+
      VarToStr(DataSet.FieldByname('IAT').OldValue)+
      VarToStr(DataSet.FieldByname('CEST').OldValue)+
      VarToStr(DataSet.FieldByname('IPPT').OldValue);
      s :=
      DataSet.FieldByname('CODIGO').AsString+
      DataSet.FieldByname('REFERENCIA').AsString+
      DataSet.FieldByname('DESCRICAO').AsString+
      DataSet.FieldByname('NOME').AsString+
      DataSet.FieldByname('MEDIDA').AsString+
      DataSet.FieldByname('PRECO').AsString+
      DataSet.FieldByname('QTD_ATUAL').AsString+
      DataSet.FieldByname('DAT_INICIO').AsString+
      DataSet.FieldByname('ULT_COMPRA').AsString+
      DataSet.FieldByname('ULT_VENDA').AsString+
      DataSet.FieldByname('CF').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('CST').AsString+
      DataSet.FieldByname('ST').AsString+
      DataSet.FieldByname('IAT').AsString+
      DataSet.FieldByname('CEST').AsString+
      DataSet.FieldByname('IPPT').AsString;
    end;
    //
    if pNome = 'ALTERACA' then
    begin
      s :=
      DataSet.FieldByName('CODIGO').AsString+
      DataSet.FieldByName('DESCRICAO').AsString+
      DataSet.FieldByName('QUANTIDADE').AsString+
      DataSet.FieldByName('MEDIDA').AsString+
      DataSet.FieldByName('UNITARIO').AsString+
      DataSet.FieldByName('TOTAL').AsString+
      DataSet.FieldByName('DATA').AsString+
      DataSet.FieldByName('TIPO').AsString+
      DataSet.FieldByName('PEDIDO').AsString+
      DataSet.FieldByName('ITEM').AsString+
      DataSet.FieldByName('VENDEDOR').AsString+
      DataSet.FieldByName('CLIFOR').AsString+
      DataSet.FieldByName('CAIXA').AsString+
      DataSet.FieldByName('VALORICM').AsString+
      DataSet.FieldByName('ALIQUICM').AsString+
      DataSet.FieldByName('HORA').AsString+
      DataSet.FieldByName('DAV').AsString+
      DataSet.FieldByName('TIPODAV').AsString+
      DataSet.FieldByName('COO').AsString+
      DataSet.FieldByName('CCF').AsString+
      DataSet.FieldByName('SERIE').AsString+
      DataSet.FieldByName('SUBSERIE').AsString+
      DataSet.FieldByName('CNPJ').AsString+
      DataSet.FieldByName('REFERENCIA').AsString;
      //
    end;
    //
    if pNome = 'REDUCOES' then
    begin
      s :=
      DataSet.FieldByname('DATA').AsString+
      DataSet.FieldByname('HORA').AsString+
      DataSet.FieldByname('SERIE').AsString+
      DataSet.FieldByname('PDV').AsString+
      DataSet.FieldByname('TIPOECF').AsString+
      DataSet.FieldByname('MARCAECF').AsString+
      DataSet.FieldByname('MODELOECF').AsString+
      DataSet.FieldByname('VERSAOSB').AsString+
      DataSet.FieldByname('DATASB').AsString+
      DataSet.FieldByname('HORASB').AsString+
      DataSet.FieldByname('CUPOMI').AsString+
      DataSet.FieldByname('CUPOMF').AsString+
      DataSet.FieldByname('CONTADORZ').AsString+
      DataSet.FieldByname('TOTALI').AsString+
      DataSet.FieldByname('TOTALF').AsString+
      DataSet.FieldByname('ALIQUOTA01').AsString+
      DataSet.FieldByname('ALIQUOTA02').AsString+
      DataSet.FieldByname('ALIQUOTA03').AsString+
      DataSet.FieldByname('ALIQUOTA04').AsString+
      DataSet.FieldByname('ALIQUOTA05').AsString+
      DataSet.FieldByname('ALIQUOTA06').AsString+
      DataSet.FieldByname('ALIQUOTA07').AsString+
      DataSet.FieldByname('ALIQUOTA08').AsString+
      DataSet.FieldByname('ALIQUOTA09').AsString+
      DataSet.FieldByname('ALIQUOTA10').AsString+
      DataSet.FieldByname('ALIQUOTA11').AsString+
      DataSet.FieldByname('ALIQUOTA12').AsString+
      DataSet.FieldByname('ALIQUOTA13').AsString+
      DataSet.FieldByname('ALIQUOTA14').AsString+
      DataSet.FieldByname('ALIQUOTA15').AsString+
      DataSet.FieldByname('ALIQUOTA16').AsString+
      DataSet.FieldByname('ALIQUOTA17').AsString+
      DataSet.FieldByname('ALIQUOTA18').AsString+
      DataSet.FieldByname('ALIQUOTA19').AsString+
      DataSet.FieldByname('ALIQU01').AsString+
      DataSet.FieldByname('ALIQU02').AsString+
      DataSet.FieldByname('ALIQU03').AsString+
      DataSet.FieldByname('ALIQU04').AsString+
      DataSet.FieldByname('ALIQU05').AsString+
      DataSet.FieldByname('ALIQU06').AsString+
      DataSet.FieldByname('ALIQU07').AsString+
      DataSet.FieldByname('ALIQU08').AsString+
      DataSet.FieldByname('ALIQU09').AsString+
      DataSet.FieldByname('ALIQU10').AsString+
      DataSet.FieldByname('ALIQU11').AsString+
      DataSet.FieldByname('ALIQU12').AsString+
      DataSet.FieldByname('ALIQU13').AsString+
      DataSet.FieldByname('ALIQU14').AsString+
      DataSet.FieldByname('ALIQU15').AsString+
      DataSet.FieldByname('ALIQU16').AsString+
      DataSet.FieldByname('CANCELAMEN').AsString+
      DataSet.FieldByname('DESCONTOS').AsString+
      DataSet.FieldByname('ISSQN').AsString+
      DataSet.FieldByname('SMALL').AsString+
      DataSet.FieldByname('STATUS').AsString+
      DataSet.FieldByname('ESTOQUE').AsString;
      //
    end;
    //
    if pNome = 'ORCAMENT' then
    begin
      s :=
      DataSet.FieldByname('CODIGO').AsString+
      DataSet.FieldByname('DESCRICAO').AsString+
      DataSet.FieldByname('QUANTIDADE').AsString+
      DataSet.FieldByname('UNITARIO').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('DATA').AsString+
      DataSet.FieldByname('TIPO').AsString+
      DataSet.FieldByname('PEDIDO').AsString+
      DataSet.FieldByname('CLIFOR').AsString+
      DataSet.FieldByname('VENDEDOR').AsString+
      DataSet.FieldByname('CAIXA').AsString+
      DataSet.FieldByname('MEDIDA').AsString+
      DataSet.FieldByname('ITEM').AsString+
      DataSet.FieldByname('VALORICM').AsString+
      DataSet.FieldByname('ALIQUICM').AsString+
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('COO').AsString;
      //
    end;
    //
    if pNome = 'PAGAMENT' then

    begin
      //
      s :=
      DataSet.FieldByname('DATA').AsString+
      DataSet.FieldByname('PEDIDO').AsString+
      DataSet.FieldByname('COO').AsString+
      DataSet.FieldByname('CCF').AsString+
      DataSet.FieldByname('CAIXA').AsString+
      DataSet.FieldByname('CLIFOR').AsString+
      DataSet.FieldByname('VENDEDOR').AsString+
      DataSet.FieldByname('FORMA').AsString+
      DataSet.FieldByname('VALOR').AsString+
      DataSet.FieldByname('GRG').AsString+
      DataSet.FieldByname('CDC').AsString+
      DataSet.FieldByname('GNF').AsString;
      //
    end;
    //
    if pNome = 'DEMAIS' then
    begin
      //
      s :=
          DataSet.FieldByname('DATA').AsString+
          DataSet.FieldByname('HORA').AsString+
          DataSet.FieldByname('ECF').AsString+
          DataSet.FieldByname('DENOMINACAO').AsString+
          DataSet.FieldByname('COO').AsString+
          DataSet.FieldByname('GNF').AsString+
          DataSet.FieldByname('CDC').AsString+
          DataSet.FieldByname('GRG').AsString;
      //
    end;
    //

    if pNome = 'ECFS' then

    begin
      //
      s := DataSet.FieldByname('SERIE').AsString;
      //
    end;

    //

    Form7.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta
    //
    if bP then
    begin
      //
      if pNome = 'ESTOQUE' then
      begin
//        ShowMessage(DataSet.Fieldbyname('ENCRYPTHASH').AsString +chr(10)+ Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo))));
        //
        // Para assinar tudo de novo tem que tirar a linha abaixo
        //
//        if (DataSet.Fieldbyname('ENCRYPTHASH').AsString = Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)))) or (DataSet.Fieldbyname('ENCRYPTHASH').isNull) or (Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(sPasta))) = DataSet.Fieldbyname('ENCRYPTHASH').AsString) then // Se o registro j foi violado no assina mais fica asssim pra sempre
        begin
          DataSet.Fieldbyname('ENCRYPTHASH').AsString := Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(s))); // Encrypta e grava o hash do registro
        end;
      end else
      begin
        DataSet.Fieldbyname('ENCRYPTHASH').AsString := Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(s))); // Encrypta e grava o hash do registro
      end;
      //
    end else
    begin
      if (DataSet.Fieldbyname('ENCRYPTHASH').AsString = Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(s)))) or (Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))) = DataSet.Fieldbyname('ENCRYPTHASH').AsString) then  // Encrypta e compara o hash do registro
      begin
        Result := True;
      end else
      begin
        Result := False;
      end;
    end;
  except ShowMessage('Erro ao criptografar head do registro do arquivo '+pNome) end;
  //
end;
}

function NaoHouveMovimento(sP1:String): boolean;
begin
  //
  Result := True;
  //
  // Itens de venda
  //
  Form7.ibQuery1.Close;
  Form7.ibQuery1.SQL.Clear;
  Form7.ibQuery1.SQL.Add('select count(CODIGO) from ITENS001 where CODIGO='+QuotedStr(sP1)+' ');
  Form7.ibQuery1.Open;
  //
  if Form7.ibQuery1.FieldByName('COUNT').AsFloat <> 0 then Result := False;
  //
  // Itens de compra
  //
  Form7.ibQuery1.Close;
  Form7.ibQuery1.SQL.Clear;
  Form7.ibQuery1.SQL.Add('select count(CODIGO) from ITENS002 where CODIGO='+QuotedStr(sP1)+' ');
  Form7.ibQuery1.Open;
  //
  if Form7.ibQuery1.FieldByName('COUNT').AsFloat <> 0 then Result := False;
  //
  // ALTERACA
  //
  Form7.ibQuery1.Close;
  Form7.ibQuery1.SQL.Clear;
  Form7.ibQuery1.SQL.Add('select count(CODIGO) from ALTERACA where CODIGO='+QuotedStr(sP1)+' ');
  Form7.ibQuery1.Open;
  //
  if Form7.ibQuery1.FieldByName('COUNT').AsFloat <> 0 then Result := False;
  //
end;

function DenegadoOuCancelado(bP1:Boolean): boolean;
begin
  //
  Result := False;
  //
  if FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) then
  begin
    if (Pos('cancelada',LowerCase(Form7.ibDataSet15NFEXML.AsString)) = 0) then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
      Form7.ibDataSet15.Post;
      Result := True;
    end;
    //
    if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
    begin
      //
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataset15STATUS.AsString  := 'NF-e cancelada';
      Form7.ibDataSet15.Delete;
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      //
      Form7.ibDataSet15EMITIDA.AsString := 'X';
      Form7.ibDataSet15.Post;
      //
      Result := True;
      Screen.Cursor            := crDefault;
      commitatudo(True);
      Form7.Close;
      Form7.Show;
      //
    end;
    //
  end;
  //
  if (FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-den.xml'))))
  or (  Pos('denegado',LowerCase(Form7.ibDataSet15STATUS.AsString)) <> 0) then
  begin
    //
    Screen.Cursor            := crHourGlass;
    //
    if (Pos('denegado',LowerCase(Form7.ibDataSet15NFEXML.AsString)) = 0) then
    begin
      //
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
      Form7.ibDataSet15.Post;
      Result := True;
      //
    end;
    //
    if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
    begin
      //
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataset15STATUS.AsString  := 'Uso Denegado';
      Form7.ibDataSet15.Delete;
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataSet15EMITIDA.AsString := 'X';
      Form7.ibDataSet15.Post;
      //
      Result := True;
      Screen.Cursor            := crDefault;
      commitatudo(True);
      Form7.Close;
      Form7.Show;
      //
    end;
  end;
end;

function VerificaSeEstaSendoUsado(bP1:Boolean): boolean;
begin
  //
  Form7.bEstaSendoUsado := False;
  //
  if not (Form7.ArquivoAberto.State in ([dsInsert])) then
  begin
    try
//      if Form7.ArquivoAberto.Recno > 0 then
//      begin
        Form7.ArquivoAberto.Edit;
        Form7.ArquivoAberto.Post;
        Form7.bEstaSendoUsado := False;
//      end else
//      begin
//        Form7.bEstaSendoUsado := False;
//      end;
    except
      Form7.bEstaSendoUsado := True;
    end;
  end;
  //
  if not bP1 then
  begin
    if Form7.bEstaSendoUsado then
    begin
      //
      AgendaCommit(True);
      Form7.Close;
      Form7.Show;
      //
      try
        Form7.ArquivoAberto.Edit;
        Form7.ArquivoAberto.Post;
        Form7.bEstaSendoUsado := False;
      except
        Form7.bEstaSendoUsado := True;
      end;
    end;
  end;
  //
  Result := Form7.bEstaSendoUsado;
  //
end;


procedure CopiarMenu(Origem, Destino:TMenuItem; Form:tForm);
var
   MenuItem: TMenuItem;
   i: integer;
begin
  for i := 0 to Origem.Count - 1 do
  begin
    MenuItem := TMenuItem.Create(Form);
    MenuItem.Caption := Origem.Items[i].Caption;
    MenuItem.Visible := Origem.Items[i].Visible;
    MenuItem.Hint    := Origem.Items[i].Hint;
    MenuItem.OnClick := Origem.Items[i].OnClick;
    Destino.Add(MenuItem);
    if Origem.Items[i].count > 0 then  CopiarMenu(Origem.Items[i], Destino.Items[Destino.count -1], Form7)
  end;
end;

procedure PosicionarMenuPopUp(Parent: TObject; Sender: TObject; PopupMenu: TPopupMenu; Ancora: TAnchorKind = akTop);
//Sandro Silva 2011-05-13 inicio
//- Posiciona PopUpMenu na tela
//- Util para chamar o popup a partir do botao contrrio (esquerdo) do mouse
//
var
  Ponto: TPoint;
begin
  with Sender as TControl do
  begin
    if PopupMenu = nil then
       Exit
    else
    begin
      GetCursorPos(Ponto);
      Ponto.X := Left + 1;
      if Ancora = akTop then // Posiciona a partir do top do objeto
        Ponto.Y := Top - TControl(PopupMenu).Height - 53
      else
        if Ancora = akBottom then // Posiciona a partir do bottom do objeto
          Ponto.Y := Top + Height + 1;
      Ponto := TControl(Parent).ClientToScreen(Ponto);
      PopupMenu.popup(Ponto.X, Ponto.Y);
    end;
  end;
end;

function BaixaEstoqueDaNFeAutorizada(sPp1: String): boolean;
begin
  //
  // Ateno a rotina abaixo altera a quantidade no estoque
  //
  if ((Form7.ibDataSet13ESTADO.AsString <> 'SC') and (Form7.ibDataSet13ESTADO.AsString <> 'MG')) or (Form1.iReduzida = 2) or (Form7.sRPS = 'S') then
  begin
    try
      //
      Form7.ibDataSet15.Edit;
      //
      if (Form7.ibDataSet15.State in ([dsEdit, dsInsert])) then
      begin
        //
        if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
        begin
          Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
        end;
        //
        Form7.ibDataSet15.Post;
        //
      end;
      //
    except end;
  end;
  //
  if (Form7.ibDataSet15EMITIDA.AsString = 'S') then
  begin
    //
    try
      //
      Form7.ibDataSet14.DisableControls;
      Form7.ibDataSet14.Close;
      Form7.ibDataSet14.SelectSQL.Clear;
      Form7.ibDataSet14.SelectSQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
      Form7.ibDataSet14.Open;
      //
      if Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,5) = 'CAIXA' then
      begin
        //                                                            //
        // Integrao com o Livro caixa CAIXA.DBF                     //
        //                                                            //
        ApagaIntegracaoComOCaixa(True);
        //
        Form7.ibDataSet12.First;
        //
        if (AllTrim(Form7.ibDataSet14CONTA.AsString) = '') then
        begin
          if (Form7.ibDataSet15TOTAL.AsFloat>0) then
            Form43.ShowModal; // Ok
        end else
        begin
          Form7.ibDataSet12.Locate('NOME',AllTrim(Form7.ibDataSet14CONTA.AsString),[loCaseInsensitive, loPartialKey]);
        end;
        //
        if not Form7.ibDataSet1.Active then Form7.ibDataSet1.Open;
        //
        Form7.ibDataSet1.Append;
        Form7.ibDataSet1DATA.Value      := Form7.ibDataSet15EMISSAO.Value;
        Form7.ibDataSet1HISTORICO.Value := 'Nota Fiscal: '+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+' de '+Form7.ibDataSet15CLIENTE.asString;
        Form7.ibDataSet1ENTRADA.Value   := (Form7.ibDataSet15TOTAL.AsFloat - Form1.fRetencaoIR);
        Form7.ibDataSet1NOME.AsString   := Form7.ibDataSet12NOME.AsString;
        Form7.ibDataSet1.Post;
        //
      end;
      //
    except end;
    //
    try
      Form7.ibDataSet7.DisableControls;
      Form7.ibDataSet7.First;
      while not Form7.ibDataSet7.Eof do // disable
      begin
        Form7.ibDataSet7.Edit;
        Form7.ibDataSet7HISTORICO.AsString := 'Nota Fiscal: '+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9);
        Form7.ibDataSet7.Post;
        Form7.ibDataSet7.Next;
      end;
    except end;
    //
    // Emitida
    //
    Form7.ibDataSet16.DisableControls;
    Form7.ibDataSet16.First;
    while not Form7.ibDataSet16.Eof do // disable
    begin
      //
      // Procura o produto no estoque
      //
      try
        //
        Form7.ibDataSet4.Close;                                                //
        Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
        Form7.ibDataSet4.Open;
        //
        if Form7.ibDataSet16CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString then
        begin
          //
          if Form7.ibDataSet16SINCRONIA.AsFloat <> Form7.ibDataSet16QUANTIDADE.AsFloat then
          begin
            if Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) = 0 then
            begin
              if Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '929' then
              begin
                //
                Form7.ibDataSet4.Edit;
                Form7.ibDataSet4QTD_ATUAL.AsFloat    := Form7.ibDataSet4QTD_ATUAL.AsFloat - Form7.ibDataSet16QUANTIDADE.AsFloat; // Baixa a quantidade no estoque quando fecha a NF
                Form7.ibDataSet4ULT_VENDA.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
                Form7.ibDataSet4.Post;
                //
                //              ShowMessage('Teste saiu do estoque '+Form7.ibDataSet16QUANTIDADE.AsString+ ' '+Form7.ibDataSet16DESCRICAO.AsString);
                //
              end;
            end;
            //
            Form7.sModulo := 'FECHAVENDA';
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16SINCRONIA.AsFloat := Form7.ibDataSet16QUANTIDADE.AsFloat; // Resolvi este problema as 4 da madrugada no NoteBook em casa
            Form7.ibDataSet16.Post;
            //
          end;
        end;
      except end;
      //
      Form7.sModulo := 'VENDA';
      Form7.ibDataSet16.Next;
      //
    end;
  end;
  //
  // Ateno a rotina acima altera a quantidade no estoque
  //
  Result := True;
  //
end;

// A PEDIDO DO
// VANDERLEI PERETI
// FONES: 49 35664136 / 91427178
// EMAIL: comercial@vpinformatica.com.br

function AliqICMdoCliente101: double;
begin
  if Form1.fAliqICMdoCliente <> 0 then
  begin
    if Form7.ibDataSet13ESTADO.AsString =  Form7.ibDataSet2ESTADO.AsString then
    begin
      Result :=  Form1.fAliqICMdoCliente;
    end else
    begin
      Result := Form7.IbDataSet101.FieldByName('ICM').AsFloat;
    end;
  end else
  begin
    Result := Form7.IbDataSet101.FieldByName('ICM').AsFloat;
  end;
end;

{Sandro Silva 2022-09-12 inicio
// A PEDIDO DO
// VANDERLEI PERETI
// FONES: 49 35664136 / 91427178
// EMAIL: comercial@vpinformatica.com.br
function AliqICMdoCliente16: double;
begin
  if Form1.fAliqICMdoCliente <> 0 then
  begin
    if Form7.ibDataSet13ESTADO.AsString =  Form7.ibDataSet2ESTADO.AsString then
    begin
      Result :=  Form1.fAliqICMdoCliente;
    end else
    begin
      Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
    end;
  end else
  begin
    Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
  end;
end;
}

function utf8Fix(sTexto: String): String;
const
  acento : array[1..47] of string = ('', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '');
  utf8: array[1..47] of string = ('',' ','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','', '?');
var
  iLetra: Integer;
begin
  Result := sTexto;
  for iLetra := 1 to length(utf8) do
  begin
    if Pos(utf8[iLetra], Result) > 0 then
      Result := StringReplace(Result, utf8[iLetra], acento[iLetra], [rfReplaceAll]);
  end;
end;


function xmlNodeValue(sXML: String; sNode: String): String;
var
  XMLDOM: IXMLDOMDocument;
  iNode: Integer;
  xNodes: IXMLDOMNodeList;
begin


  XMLDOM := CoDOMDocument.Create;
  XMLDOM.loadXML(sXML);

  Result := '';
  xNodes := XMLDOM.selectNodes(sNode);
  for iNode := 0 to xNodes.length -1 do
  begin
    Result := xNodes.item[iNode].text;
  end;
  
//  Result := Utf8ToAnsi(Result);
  Result := Utf8Fix(Result);
  XMLDOM := nil;
  
end;

function ConsultaProcesso(sP1:String): boolean;
var
  Snapshot: THandle;
  ProcessEntry32: TProcessEntry32;
begin
  //
  Result   := False;
  Snapshot := CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
  if (Snapshot = Cardinal(-1)) then exit;
  //
  ProcessEntry32.dwSize := SizeOf(TProcessEntry32);
  //
  // pesquisa pela lista de processos
  //
  if (Process32First(Snapshot, ProcessEntry32)) then
  repeat
    //
    // enquanto houver processos
    //
    // SubItems.Add(IntToStr(ProcessEntry32.th32ParentPro cessID));
    if ProcessEntry32.szExeFile = sP1 then Result := True;
    //
  until not Process32Next(Snapshot, ProcessEntry32);
  //
  CloseHandle (Snapshot);
  //
end;

function CalculaTotalRecebido(pP1: Boolean): Boolean;
begin
  //
  if Form7.sModulo = 'RECEBER' then
  begin
    //
    Form7.ibQuery1.Close;
    Form7.iBQuery1.SQL.Clear;
    Form7.iBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
    Form7.iBQuery1.Open;
    //
    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Label49.CAption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Panel10.Repaint;
    //
  end else
  begin
    //
    Form7.ibQuery1.Close;
    Form7.iBQuery1.SQL.Clear;
    Form7.iBQuery1.SQL.Add('select sum(VALOR_PAGO) from PAGAR where ATIVO >= 5');
    Form7.iBQuery1.Open;
    //
    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Label49.CAption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Panel10.Repaint;
    //
  end;
  //
  Result := True;
  //
end;

function HtmlParaPdf(sP1:String): boolean;
begin
  //
  try
    //
    while FileExists(pChar(sP1+'.pdf')) do
    begin
      //
      try
        DeleteFile(pChar(sP1+'.pdf'));
        DeleteFile(pChar(sP1+'_.pdf'));
      except end;
      //
      Sleep(10);
      //
    end;
    //
    chdir(pChar(Form1.sAtual+'\HTMLtoPDF'));
    //
    while FileExists(pChar('tempo_ok.pdf')) do
    begin
      DeleteFile(pChar('tempo_ok.pdf'));
      Sleep(10);
    end;
    //
    while FileExists(pChar('tempo.pdf')) do
    begin
      DeleteFile(pChar('tempo.pdf'));
      Sleep(10);
    end;
    //
    ShellExecute( 0, 'runas', pChar('html2pdf'),pchar('"'+Form1.sAtual+'\'+sP1+'.htm" "tempo.pdf"'), '', SW_HIDE);
    Sleep(10);
    //
    while not FileExists(pChar(Form1.sAtual+'\HTMLtoPDF\tempo_ok.pdf')) do
    begin
      RenameFile(pChar(Form1.sAtual+'\HTMLtoPDF\tempo.pdf'),pChar(Form1.sAtual+'\HTMLtoPDF\tempo_ok.pdf'));
      Sleep(10);
    end;
    //
    chdir(pChar(Form1.sAtual));
    //
    CopyFile(pChar(Form1.sAtual+'\HTMLtoPDF\tempo_ok.pdf'), pChar(sP1+'_.pdf'),False);
    //
    while not FileExists(pChar(sP1+'.pdf')) do
    begin
      RenameFile(pChar(sP1+'_.pdf'), pChar(sP1+'.pdf'));
      Sleep(10);
    end;
    //
  except end;
  //
  Result := True;
  //
end;

function AbreArquivoNoFormatoCerto(sP1:String): boolean;
begin
  //
  if Copy(sP1,1,3) <> 'OS_' then sP1 := Senhas.UsuarioPub;
  //
  if Form1.bPDF then
  begin
    //
    Screen.Cursor            := crHourGlass;
    HtmlParaPdf(sP1);
    ShellExecute( 0, 'Open',pChar(sP1+'.pdf'),'', '', SW_SHOWMAXIMIZED);
    Screen.Cursor            := crDefault;
    //
  end else
  begin
    //
    ShellExecute( 0, 'Open',pChar(sP1+'.HTM'),'', '', SW_SHOWMAXIMIZED);
    //
  end;
  //
  Result := True;
  //
end;

procedure ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos(
  XmlEnviado: String; sRetorno: String);
//Exibe orientaes de como proceder em casos de rejeies retornadas pela Sefaz
begin
  if AnsiContainsText(sRetorno, '<cStat>873</cStat>') // Rejeio: Operao com medicamentos e no informado os campos de rastreabilidade [nItem: nnn]
  or AnsiContainsText(sRetorno, '<cStat>840</cStat>') // Rejeio: NCM de medicamento e no informado o grupo de medicamento (med) [nItem:nnn]
  then
  begin
    Application.MessageBox(pChar('Preencha os campos cProdANVISA, xMotivoIsencao e rastro, da Aba TAGs, no cadastro do produto ' + ItemRejeicao(sRetorno, XmlEnviado)), 'Ateno', mb_Ok + MB_ICONWARNING);
  end;
end;

function LoadXmlDestinatarioSaida(aChaveNFe: String): WideString;
Var
 _file : TStringList;
begin
  //
  _file := TStringList.Create;
  //
  try
    if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml')) then
    begin
      _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml'));
      Result := _file.Text;
    end else
    begin
      if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml')) then
      begin
        _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml'));
        Result := _file.Text;
      end else
      begin
        if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml')) then
        begin
          _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml'));
          Result := _file.Text;
        end else
        begin
          if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml')) then
          begin
            _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml'));
            Result := _file.Text;
          end else
          begin
//            ShowMessage('No foi possvel encontrar o arquivo '+pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '*.xml')+'. Verifique se a NF-e est Autorizada.');
            Result := Form7.ibDataSet15NFEXML.AsString;
          end;
        end;
      end;
      //
    end;
  except
    Result := Form7.ibDataSet15NFEXML.AsString;
  end;
  //
  _file.Free;
  //
end;


function LoadXmlDestinatarioEntrada(aChaveNFe: String): WideString;
Var
 _file : TStringList;
begin
  //
  _file := TStringList.Create;
  //
  try
    if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml')) then
    begin
      _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml'));
      Result := _file.Text;
    end else
    begin
      if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml')) then
      begin
        _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml'));
        Result := _file.Text;
      end else
      begin
        if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml')) then
        begin
          _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml'));
          Result := _file.Text;
        end else
        begin
          if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml')) then
          begin
            _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml'));
            Result := _file.Text;
          end else
          begin
//            ShowMessage('No foi possvel encontrar o arquivo '+pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '*.xml')+'. Verifique se a NF-e est Autorizada.');
            Result := Form7.ibDataSet24NFEXML.AsString;
          end;
        end;
      end;
      //
    end;
  except
    Result := Form7.ibDataSet24NFEXML.AsString;
  end;
  //
  _file.Free;
  //
end;

function ConfiguraNFE(sP1:Boolean) : Boolean;
var
  Mais1Ini: TIniFile;
begin
  //

  {Sandro Silva 2022-12-15 inicio
  Form7.spdNFe.ConfigurarSoftwareHouse('07426598000124','9830b685216a9c4613bc76c84098272d');
  }
  Form1.ConfiguraCredencialTecnospeed; // Sandro Silva 2022-12-15
  {Sandro Silva 2022-12-15 fim}

  //
  if LimpaNumero(Form7.ibDataSet13CGC.AsString) <> '' then
    Form7.spdNFe.CNPJ := LimpaNumero(Form7.ibDataSet13CGC.AsString);
  //
  if Form1.bModoScan then
  begin
    Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHomScan.ini';
    Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProdScan.ini';
  end else
  begin
    //
    if Form1.bModoSVC then
    begin
      Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHomSVC.ini';
      Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProdSVC.ini';
    end else
    begin
      Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHom.ini';
      Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProd.ini';
    end;
    //
  end;
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='FILE'            Then Form7.spdNFe.TipoCertificado := spdNFeType.ckFile;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='SMARTCARD'       Then Form7.spdNFe.TipoCertificado := spdNFeType.ckSmartCard;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='ACTIVEDIRECTORY' Then Form7.spdNFe.TipoCertificado := spdNFeType.ckActiveDiretory;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='MEMORY'          Then Form7.spdNFe.TipoCertificado := spdNFeType.ckMemory;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='LOCALMACHINE'    Then Form7.spdNFe.TipoCertificado := spdNFeType.ckLocalMachine;
  //
  Form7.sFuso                := Mais1ini.ReadString('NFE' , 'FUSO','');
  if Form7.sFuso = '' then
    Form7.sFuso := DefineFusoHorario(Form1.sAtual+'\nfe.ini', 'NFE', 'FUSO', Form7.ibDataSet13ESTADO.AsString, '', False);
  if Form7.sFuso = FusoHorarioPadrao(Form7.ibDataSet13ESTADO.AsString) then
    Form1.HorarioDeVerao.Checked := False
  else
    Form1.HorarioDeVerao.Checked := True;
  //
  Form7.sFormatoDoDanfe      := Mais1Ini.ReadString('DANFE','Formato do DANFE','Retrato');
  Form7.sZiparXML            := Mais1Ini.ReadString('ENVIO','Zipar XML','N');
  Form7.sEnviarDAnfePorEmail := Mais1Ini.ReadString('ENVIO','Enviar danfe por e-mail','N');
  Form7.sCNPJContabilidade   := Mais1Ini.ReadString('XML','CNPJ da contabilidade','');
  //
  Form1.sVersaoLayout        := Mais1Ini.ReadString('NFE','Layout','4.00');
  {Sandro Silva 2023-03-14 inicio}
  if Form1.sVersaoLayout <> '4.00' then
  begin
    Mais1Ini.WriteString('NFE','Layout','4.00');
    Form1.sVersaoLayout := '4.00';
  end;
  {Sandro Silva 2023-03-14 fim}
  Form1.sModoDbug            := Mais1Ini.ReadString('NFE','dbug','');
  //
  if Form1.sVersaoLayout = '4.00' then
  begin
    //
    // Altera a Verso do Manual no Componente NFe
    // essa mudana afeta o comportamento do componente quanto 
    // Gerao da Chave de Acesso, Assinatura, Comunicao com SEFAZ, Validao de Esquema
    //
    Form7.spdNFe.TimeOut                      := 60000*3;
    Form7.spdNFe.VersaoManual                 := vm60;
    Form7.spdNFeDataSets.VersaoEsquema        := pl_009;
    Form7.spdNFe.DiretorioEsquemas            := Form1.sAtual + '\nfe\Esquemas\vm60';
    Form7.spdNFe.DiretorioTemplates           := Form1.sAtual + '\nfe\Templates\vm60';
    Form7.spdNFeDataSets.XMLDicionario        := Form1.sAtual + '\nfe\Templates\vm60\Conversor\NFeDataSets.xml';
    //
  end else
  begin
    //
    // Altera a Verso do Manual no Componente NFe
    // essa mudana afeta o comportamento do componente quanto 
    // Gerao da Chave de Acesso, Assinatura, Comunicao com SEFAZ, Validao de Esquema
    //
    Form7.spdNFe.TimeOut                      := 60000;
    Form7.spdNFe.VersaoManual                 := vm50a;
    Form7.spdNFeDataSets.VersaoEsquema        := pl_008h;
    Form7.spdNFe.DiretorioEsquemas            := Form1.sAtual + '\nfe\Esquemas\vm50a';
    Form7.spdNFe.DiretorioTemplates           := Form1.sAtual + '\nfe\Templates\vm50a';
    Form7.spdNFeDataSets.XMLDicionario        := Form1.sAtual + '\nfe\Templates\vm50a\Conversor\NFeDataSets.xml';
    //
  end;
  //
  try
    Form7.spdNFe.NomeCertificado.Text     := Mais1Ini.ReadString('NFE','Certificado','');
  except
    on E: Exception do
    begin
      {Sandro Silva 2022-09-12 inicio
      if Mais1Ini.ReadString('NFE','Certificado','') <> '' then
      begin
        if AnsiContainsText(E.Message, '"Certificado no encontrado."') then
        begin
          //ShowMessage('Selecione o Certificado Digital');
          Form1.SelecionarCertificadoDigital1Click(Form1.SelecionarCertificadoDigital1);
          ConfiguraNFE(sP1);
          Exit;
        end;
      end;
      {Sandro Silva 2022-09-12 fim}
    end;
  end;
  //
  if AllTrim(UpperCase(Form7.ibDataSet13ESTADO.AsString)) <> '' then
  begin
    Form7.spdNFe.UF := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end else
  begin
    Form7.spdNFe.UF := 'SC';
  end;
  //
  if (Mais1Ini.ReadString('NFE','Ambiente','Homologacao') <> 'Homologacao') and (Mais1Ini.ReadString('NFE','Ambiente','Homologacao') <> 'Producao') then Mais1Ini.WriteString('NFE','Ambiente','Homologacao');
  if Mais1Ini.ReadString('NFE','Ambiente','Homologacao') = 'Homologacao' then Form1.bHomologacao := True else Form1.bHomologacao := False;
  if Mais1Ini.ReadString('NFE','Ambiente','Homologacao') = 'Homologacao' then Form7.spdNFe.Ambiente := spdNFeType.akHomologacao else Form7.spdNFe.Ambiente := spdNFeType.akProducao;
  //
  if Mais1Ini.ReadString('NFE','Consultar Nfes Emitidas','Sim') = 'Sim' then Form1.bConsultarNFesEmitidas := True else Form1.bConsultarNFesEmitidas := False;
  if Mais1Ini.ReadString('NFE','Consultar Nfes Emitidas','Sim') = 'Sim' then Form1.ConsultarNFesemitidas1.Checked := True else Form1.ConsultarNFesemitidas1.Checked := False;
  //
  Mais1ini.Free;
  //
  if Form7.spdNFe.NomeCertificado.Text = '' then
  begin
    //
    {Sandro Silva 2022-12-15 inicio 
    Form7.spdNFe.ConfigurarSoftwareHouse('07426598000124','9830b685216a9c4613bc76c84098272d');
    }
    Form1.ConfiguraCredencialTecnospeed;
    {Sandro Silva 2022-12-15 fim}

    Form7.spdNFe.ListarCertificados(frmSelectCertificate.lbList.Items);
    //
  end;
  //
//  Form7.spdNFe.DiretorioLog                    := Form1.sAtual + '\log';
//  Form7.spdNFe.DiretorioLogErro                := Form1.sAtual + '\LogErro';
//  Form7.spdNFe.DiretorioXmlDestinatario        := Form1.sAtual + '\xmldestinatario';

  Form7.spdNFe.DiretorioLog                    := 'log';
  Form7.spdNFe.DiretorioXmlDestinatario        := 'xmldestinatario';
  Form7.spdNFe.DiretorioLogErro                := 'LogErro';
  Form7.spdNFe.DanfeSettings.LogotipoEmitente  := 'LOGONFE.BMP';
  Form7.spdNFe.DanfeSettings.ImprimirDuplicata := False;
  Form7.spdNFe.DiretorioTemporario             := Form1.sAtual;
  //
  Form7.spdNFe.DanfeSettings.ModeloRetrato             := Form1.sAtual + '\nfe\Templates\vm60\danfe\Retrato.rtm';
  Form7.spdNFe.DanfeSettings.ModeloPaisagem            := Form1.sAtual + '\nfe\Templates\vm60\danfe\paisagem.rtm';
  Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento := Form1.sAtual + '\nfe\Templates\vm60\danfe\RetratoCanc.rtm';
  Form7.spdNFe.DanfeSettings.ModeloDanfeSimplificado   := Form1.sAtual + '\nfe\Templates\vm60\danfe\RetratoSimplificado.rtm';
  Form7.spdNFe.DanfeSettings.ModeloDanfeXmlResumo      := Form1.sAtual + '\nfe\Templates\vm60\danfe\Resumo.rtm';
  Form7.spdNFe.DanfeSettings.ModeloRTMCCe              := Form1.sAtual + '\nfe\Templates\cce\Impressao\modeloCCe.rtm';
  //
  Result := True;
  //
end;      

function ConsultaCadastro(sP1: String) : String;
var
  Mais1ini : tIniFile;
  sEstado, sM, sRetorno : String;
  Hora, Min, Seg, cent : Word;
  tInicio : tTime;
  I : Integer;
begin
  //
  ConfiguraNFE(True);
  Form7.spdNFe.Ambiente := spdNFeType.akProducao;
  //
  sM := '';
  tInicio := Time;
  //
  sRetorno    := '';
  //
  if Length(Limpanumero(xmlNodeValue(sRetorno,'//CEP'))) <> 8 then
  begin
    //
    Mais1ini := TIniFile.Create(Form7.spdNFe.ArquivoServidoresProd);
    //
    for I := 1 to 28 do
    begin
      //
      sEstado := AllTrim(Copy(AllTrim(UpperCase(Form7.ibDataSet13ESTADO.AsString))+'SCSPRSACALAMAPBACEDFESGOMAMGMSMTPAPBPEPIPRRJRNRORRSETO      ',(I*2)-1,2));
      //
      if sEstado <> '' then
      begin
        //
        if Length(Limpanumero(xmlNodeValue(sRetorno,'//CEP'))) <> 8 then
        begin
          //
          try
            if Length(LimpaNumero(sP1)) = 14 then
            begin
              sRetorno := Form7.spdNFe.ConsultarCadastro(LimpaNumero(sP1),'CNPJ',sEstado);
            end else
            begin
              sRetorno := Form7.spdNFe.ConsultarCadastro(LimpaNumero(sP1),'CPF',sEstado);
            end;
          except

          end;
          //
          // ShowMessage(sRetorno);
          //
        end;
        //
        DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
        sM := sM + Form1.sVersaoLayout + sEstado+': '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0)+chr(10);
        tInicio := Time;
        //
      end;
    end;
    //
    mais1ini.Free;
    //
  end;
  //
//  ShowMessage(sM);
//  ShowMessage(sRetorno);
  //
//  Form10.Panel2.Hint := sM;
  //
  ConfiguraNFE(True);
  Result := sRetorno;
  //
end;    

function DistribuicaoNFe2(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  //
  if AllTrim(sP1) = '' then sP1 := Form1.sAtual;
  if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
  begin
    ShowMessage('Recuperando XML da pasta \log');
    Form7.ibDataSet15.Edit;
    Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
    Form7.ibDataSet15.Post;
  end;
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(sP1+'\XML');
    //
    Form7.fNFe := Form7.ibDataSet15NFEXML.AsString;
    //
    if (Pos('>Cancelamento</descEvento>',Form7.ibDataSet15NFEXML.AsString) <> 0) then
    begin
      AssignFile(F,pChar(sP1 + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    end else
    begin
      AssignFile(F,pChar(sP1 + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    end;
    //
    Rewrite(F);                  // Abre para gravao
    WriteLn(F,Form7.fNFe);
    CloseFile(F); // Fecha o arquivo
    //
  except end;
  //
  Result := True;
  //
end;


function DistribuicaoNFe(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  //
  if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0) and (Pos('<procEventoNFe',Form7.ibDataSet15NFEXML.AsString) = 0) then
  begin
    //
    //    ShowMessage('Recuperando XML da pasta \log');
    //
    Form7.ibDataSet15.Edit;
    Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
    Form7.ibDataSet15.Post;
  end;
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(Form1.sAtual+'\'+sP1);
    //
    if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) <> 0) or (Pos('<procEventoNFe',Form7.ibDataSet15NFEXML.AsString) <> 0) then
    begin
      //
      Form7.fNFe := Form7.ibDataSet15NFEXML.AsString;
      //
      if (Pos('>Cancelamento</descEvento>',Form7.ibDataSet15NFEXML.AsString) <> 0) then
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end else
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end;
      //
      Rewrite(F);                  // Abre para gravao
      WriteLn(F,Form7.fNFe);
      CloseFile(F); // Fecha o arquivo
      //
    end;
    //
  except end;
  //
  Result := True;
  //
end;


function DistribuicaoNFEInutilizada(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(Form1.sAtual+'\'+sP1);
    //
    Form7.fNFe := Form7.IBQuery99.FieldByname('XML').AsString;
    AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.IBQuery99.FieldByname('REGISTRO').AsString+'-inutilizada.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                  // Abre para gravao
    WriteLn(F,Form7.fNFe);
    CloseFile(F); // Fecha o arquivo
    //
  except end;
  //
  Result := True;
  //
end;


function DistribuicaoNFeCompra(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  //
  Result := False;
  //
  if (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) = 0) and (Pos('<procEventoNFe',Form7.ibDataSet24NFEXML.AsString) = 0) then
  begin
    //
    //    ShowMessage('Recuperando XML da pasta \log');
    //
    Form7.ibDataSet24.Edit;
    Form7.ibDataSet24NFEXML.AsString := LoadXmlDestinatarioEntrada(Form7.ibDataSet24NFEID.AsString); // COVID19
    Form7.ibDataSet24.Post;
  end;
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(Form1.sAtual+'\'+sP1);
    //
    if (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) <> 0) or (Pos('<procEventoNFe',Form7.ibDataSet24NFEXML.AsString) <> 0) then
    begin
      //
      Form7.fNFe := Form7.ibDataSet24NFEXML.AsString;
      //
      if (Pos('>Cancelamento</descEvento>',Form7.ibDataSet24NFEXML.AsString) <> 0) then
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet24NFEID.AsString+'-caneve.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end else
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet24NFEID.AsString+'-nfe.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end;
      //
      Rewrite(F);                  // Abre para gravao
      WriteLn(F,Form7.fNFe);
      CloseFile(F); // Fecha o arquivo
      //
      Result := True;
      //
    end;
    //
  except end;
  //
  //
end;


function AssinaturaDigital(sP1:String): String;
var
  HashDoArquivo: string;
  F : TextFile;
begin
  //
  with form1 do
  begin
    //
    HashDoArquivo := MD5Print(MD5File(pChar(sP1)));
    Form7.LbRSASSA1.HashMethod := hmMD5;
    Form7.LbRSASSA1.KeySize := aks1024;
    //
    Form7.LbRSASSA1.PrivateKey.ExponentAsString :=  '75C2624A448186B59016FE623' +
                                              'EF23ED97137C8D5F273C15EE813D2AEFD322C2AFBF868ADBB5096A78CD' +
                                              'EA9D678CA9370EE0C79FAD21FEC0ECE440149D09367077B46A33F829B3' +
                                              '28CAFF49F0B884AA672F9F65D632F44A492D4E92D9B33526CB8DD84416' +
                                              '9240235E8F49F74C8CD1B4626A423009FC777935B091CB751895E5F6A';
    //
    Form7.LbRSASSA1.PrivateKey.ModulusAsString := '656B072B31EF964B1C3D31F8BC' +
                                            '9BD945E7A675307DEB790B748B1197B0DFC4E4D1064ECCD625C3248970'+
                                            'E4F29FC6D8F0D0385A53A9A3E7DB20C258C982CFC47B798E54EE655D55'+
                                            '92269559B8DDB864E57D46ECFBFE594A572C0C9E3DA8DD2BDEBE63BDD2'+
                                            '9583C66553B3969F73602CF3CAC29C78A6F3DC491507AD2C4F818077';
    //
    Form7.LbRSASSA1.SignString(HashDoArquivo);
    Result := Form7.LbRSASSA1.Signature.IntStr;
    //
    try
      //
      AssignFile(F, sP1);
      Append(F);
      Writeln(F,'EAD'+Result);
      CloseFile(F);
      //
    except end;
  end;
end;

function Audita(pP1, pP2, pP3, pP4 : String; pP5, pP6: Double) : Boolean;
var
  sRegistro : String;
begin
  //
  try
    //
    try
      Form7.ibDataSet100.Close;
      Form7.ibDataSet100.SelectSql.Clear;
      Form7.ibDataset100.SelectSql.Add('select gen_id(G_AUDIT0RIA,1) from rdb$database');
      Form7.ibDataset100.Open;
    except
      ShowMessage('Erro na tabela de auditoria. Cod. 1');
    end;
    //
    sRegistro := '1'+StrZero(StrToInt(Form7.ibDataSet100.FieldByname('GEN_ID').AsString),9,0);
    Form7.ibDataset100.Close;
    //
    Form7.ibDataSet100.Close;
    Form7.ibDataSet100.SelectSql.Clear;
    Form7.ibDataSet100.SelectSql.Add('insert into AUDIT0RIA (ATO, MODULO, USUARIO, HISTORICO, VALOR_DE, VALOR_PARA, DATA, HORA, REGISTRO) values('
            +QuotedStr(pP1)+', '
            +QuotedStr(pP2)+', '
            +QuotedStr(pP3)+', '
            +QuotedStr(pP4)+', '
            +QuotedStr(StrTran(StrZero(pP5,10,2),',','.'))+', '
            +QuotedStr(StrTran(StrZero(pP6,10,2),',','.'))+', '
            +QuotedStr(DateToStrInvertida(Date))+', '
            +QuotedStr(TimeToStr(Time))+', '
            +QuotedStr(sRegistro)+')');
    //
    // ShowMessage(Form7.ibDataSet100.SelectSql.Text);
    //
    Form7.ibDataSet100.Open;
    //
  except
    ShowMessage('Erro na tabela de auditoria. Cod. 2'+chr(10)+chr(10)+Form7.ibDataSet100.SelectSql.Text);
  end;
  //
  Result := True;
  //
end;


function DefineJanela(bP1 : Boolean) : Boolean;
begin
  //
  Form7.DbGrid1.Top    := 110-15;
  Form7.DbGrid1.Left   := 10;
  Form7.dbGrid1.Width  := Form1.Width - 30;
  Form7.dbGrid1.Height := Form7.Height - Form7.DbGrid1.Top - 60 -26;
  Form7.Panel7.Visible := True;
  //
  if (Form7.sModulo='CONFOS') or (Form7.sModulo='CONFRECIBO') or (Form7.sModulo = 'NOTA') then
  begin
    //
    Form7.DbGrid1.Top     := 0;
    Form7.DbGrid1.Left    := 10;
    Form7.DbGrid1.Width   := 400;
    Form7.DbGrid1.Height  := Form7.Height - Form7.DbGrid1.Top - 60 -26 - 105;
    Form7.Panel7.Visible  := False;
    Form7.Panel_0.Visible := False;
    Form7.Width           := 410;
    Form7.Panel4.Visible  := False;
    Form1.Panel_3.Visible := False;
    //
  end else
  begin
    //
    Form7.Panel_0.Visible := True;
    Form7.Width  := Form1.Width -6;
    Form7.Panel4.Visible  := True;
    Form1.Panel_3.Visible := True;
    //
  end;
  //
  Result := True;
  //
end;


function Altura(MM : Double) : Longint;
var
  mmPointY : Real;
  PageSize, OffSetUL : TPoint;
begin
  mmPointY := Printer.PageHeight / GetDeviceCaps(Printer.Handle,VERTSIZE);
  Escape (Printer.Handle,GETPRINTINGOFFSET,0,nil,@OffSetUL);
  Escape (Printer.Handle,GETPHYSPAGESIZE,0,nil,@PageSize);
  if MM > 0 then Result := round ((MM * mmPointY) - OffSetUL.Y) else Result := round (MM * mmPointY);
end;

function Largura(MM: Double) : Longint;
var
  mmPointX : Real;
  PageSize, OffSetUL: TPoint;
begin
  mmPointX := Printer.PageWidth / GetDeviceCaps(Printer.Handle,HORZSIZE);
  Escape (Printer.Handle,GETPRINTINGOFFSET,0,nil,@OffSetUL);
  Escape (Printer.Handle,GETPHYSPAGESIZE,0,nil,@PageSize);
  if MM > 0 then Result := round ((MM * mmPointX) - OffSetUL.X) else Result := round (MM * mmPointX);
end;

function AgendaCommit(P1: Boolean): Boolean;
begin
  try
    if P1 then
    begin
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,1) from rdb$database');
      Form7.ibDataset101.Open;
    end else
    begin
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,-1) from rdb$database');
      Form7.ibDataset101.Open;
    end;
  except end;
  //
  Result := True;
  //
end;

function Commitatudo(P1:Boolean): Boolean;
begin
  //
  // bFechaTudo s  usado para incluir novos produtos e novos fornecedores na NF, COMPRA e OF
  //
  if Form7.sModulo = 'COMPRA' then
  begin
    //
    Form7.ibDataSet1.BufferChunks  := 500;
    Form7.ibDataSet27.BufferChunks := 500;
    Form7.ibDataSet25.BufferChunks := 500;
    Form7.ibDataSet21.BufferChunks := 500;
    Form7.ibDataSet10.BufferChunks := 500;
    Form7.ibDataSet30.BufferChunks := 500;
    Form7.ibDataSet28.BufferChunks := 500;
    Form7.ibDataSet19.BufferChunks := 500;
    Form7.ibDataSet18.BufferChunks := 500;
    Form7.ibDataSet16.BufferChunks := 500;
    Form7.ibDataSet15.BufferChunks := 500;
    Form7.ibDataSet23.BufferChunks := 500;
    Form7.ibDataSet24.BufferChunks := 500;
    Form7.ibDataSet35.BufferChunks := 500;
    Form7.ibDataSet13.BufferChunks := 500;
    Form7.ibDataSet14.BufferChunks := 500;
    Form7.ibDataSet11.BufferChunks := 500;
    Form7.ibDataSet26.BufferChunks := 500;
    Form7.ibDataSet9.BufferChunks  := 500;
    Form7.ibDataSet29.BufferChunks := 500;
    Form7.ibDataSet12.BufferChunks := 500;
    Form7.ibDataSet8.BufferChunks  := 500;
    Form7.ibDataSet7.BufferChunks  := 500;
    Form7.ibDataSet2.BufferChunks  := 500;
    Form7.ibDataSet3.BufferChunks  := 500;
    Form7.ibDataSet4.BufferChunks  := 500;
    Form7.ibDataSet5.BufferChunks  := 500;
    Form7.ibDataSet6.BufferChunks  := 500;
    //
  end else
  begin
    //
    Form7.ibDataSet1.BufferChunks  := 1000;
    Form7.ibDataSet27.BufferChunks := 1000;
    Form7.ibDataSet25.BufferChunks := 1000;
    Form7.ibDataSet21.BufferChunks := 1000;
    Form7.ibDataSet10.BufferChunks := 1000;
    Form7.ibDataSet30.BufferChunks := 1000;
    Form7.ibDataSet28.BufferChunks := 1000;
    Form7.ibDataSet19.BufferChunks := 1000;
    Form7.ibDataSet18.BufferChunks := 1000;
    Form7.ibDataSet16.BufferChunks := 1000;
    Form7.ibDataSet15.BufferChunks := 1000;
    Form7.ibDataSet23.BufferChunks := 1000;
    Form7.ibDataSet24.BufferChunks := 1000;
    Form7.ibDataSet35.BufferChunks := 1000;
    Form7.ibDataSet13.BufferChunks := 1000;
    Form7.ibDataSet14.BufferChunks := 1000;
    Form7.ibDataSet11.BufferChunks := 1000;
    Form7.ibDataSet26.BufferChunks := 1000;
    Form7.ibDataSet9.BufferChunks  := 1000;
    Form7.ibDataSet29.BufferChunks := 1000;
    Form7.ibDataSet12.BufferChunks := 1000;
    Form7.ibDataSet8.BufferChunks  := 1000;
    Form7.ibDataSet7.BufferChunks  := 1000;
    Form7.ibDataSet2.BufferChunks  := 1000;
    Form7.ibDataSet3.BufferChunks  := 1000;
    Form7.ibDataSet4.BufferChunks  := 1000;
    Form7.ibDataSet5.BufferChunks  := 1000;
    Form7.ibDataSet6.BufferChunks  := 1000;
    //
  end;
  //
  if Form1.bFechaTudo then
  begin
    //
    // s commitatudo se houve realmente uma alterao no GDB - Talvs controlar com um generator
    // criar uma varivel com um numero de 0 a 9999999999 cada vez que alterar o GDB incrementa
    // este generator depois confere com a variavel se nao  a mesma commita.
    // Sonhei isso e tenho certeza que funciona
    //
    Form7.ibDataSet101.Close;
    Form7.ibDataSet101.SelectSql.Clear;
    if P1 then Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,1) from rdb$database') else Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,0) from rdb$database');
    Form7.ibDataset101.Open;
    //
    if Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat > 9999999999 then
    begin
      Form7.ibDataset100.Close;
      Form7.ibDataset100.SelectSql.Clear;
      Form7.ibDataset100.SelectSql.Add('set generator G_MUTADO to 0');
      Form7.ibDataset100.Open;
    end;
    //
    if (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat <> Form7.fMutado) then // or (Form7.ibDataSet100.FieldByname('GEN_ID').AsFloat = 0) then
    begin
      //
      Form7.fMutado := Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat;
      Form7.ibDataSet4.Disablecontrols;
      //
      try
        if Form7.IBTransaction1.Active then Form7.IBTransaction1.Commit;
      except
        ShowMessage('Falha na conexo com o Banco de Dados. Erro 1848');
      end;
      //
      try
        HasHs('ESTOQUE',True);
        HasHs('REDUCOES',True);
        HasHs('PAGAMENT',True);
        HasHs('ALTERACA',True);
        HasHs('DEMAIS',True);
        HasHs('VENDAS',True);
        HasHs('ITENS001',True);
        HasHs('ORCAMENT',True);
      except end;
      //
      if p1 then
      begin
        //
        Form7.ibDataSet1.Selectsql.Clear;
        Form7.ibDataSet27.Selectsql.Clear;
        Form7.ibDataSet25.Selectsql.Clear;
        Form7.ibDataSet21.Selectsql.Clear;
        Form7.ibDataSet10.Selectsql.Clear;
        Form7.ibDataSet30.Selectsql.Clear;
        Form7.ibDataSet28.Selectsql.Clear;
        Form7.ibDataSet19.Selectsql.Clear;
        Form7.ibDataSet18.Selectsql.Clear;
        Form7.ibDataSet16.Selectsql.Clear;
        Form7.ibDataSet15.Selectsql.Clear;
        Form7.ibDataSet23.Selectsql.Clear;
        Form7.ibDataSet24.Selectsql.Clear;
        Form7.ibDataSet35.Selectsql.Clear;
        Form7.ibDataSet13.Selectsql.Clear;
        Form7.ibDataSet14.Selectsql.Clear;
        Form7.ibDataSet11.Selectsql.Clear;
        Form7.ibDataSet26.Selectsql.Clear;
        Form7.ibDataSet9.Selectsql.Clear;
        Form7.ibDataSet29.Selectsql.Clear;
        Form7.ibDataSet12.Selectsql.Clear;
        Form7.ibDataSet8.Selectsql.Clear;
        Form7.ibDataSet7.Selectsql.Clear;
        Form7.ibDataSet2.Selectsql.Clear;
        Form7.ibDataSet3.Selectsql.Clear;
        Form7.ibDataSet4.Selectsql.Clear;
        Form7.ibDataSet5.Selectsql.Clear;
        Form7.ibDataSet6.Selectsql.Clear;
        //
        Form7.ibDataSet1.Selectsql.Add('select * from CAIXA where DATA=CURRENT_DATE order by DATA, REGISTRO');
        Form7.ibDataSet27.Selectsql.Add('select * from ALTERACA where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet25.Selectsql.Add('select * from FLUXO order by DATA');
        Form7.ibDataSet21.Selectsql.Add('select * from GRUPO');
        Form7.ibDataSet10.Selectsql.Add('select * from GRADE');
        Form7.ibDataSet30.Selectsql.Add('select * from SERIE');
        Form7.ibDataSet28.Selectsql.Add('select * from COMPOSTO');
        Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=1 order by ((LINHA * 1000) + COLUNA)');
        Form7.ibDataSet18.Selectsql.Add('select * from TRANSPOR order by upper(NOME)');
        Form7.ibDataSet16.Selectsql.Add('select * from ITENS001 where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet15.Selectsql.Add('select * from VENDAS where EMISSAO=CURRENT_DATE ');
        Form7.ibDataSet23.Selectsql.Add('select * from ITENS002 where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet24.Selectsql.Add('select * from COMPRAS where EMISSAO=CURRENT_DATE ');
        Form7.ibDataSet35.Selectsql.Add('select * from ITENS003 where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet13.Selectsql.Add('select * from EMITENTE');
        Form7.ibDataSet14.Selectsql.Add('select * from ICM order by CFOP');
        Form7.ibDataSet11.Selectsql.Add('select * from BANCOS');
        Form7.ibDataSet26.Selectsql.Add('select * from RESUMO order by DATA, REGISTRO');
        Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR');
        Form7.ibDataSet29.Selectsql.Add('select * from CONVENIO');
        Form7.ibDataSet12.Selectsql.Add('select * from CONTAS order by NOME');
        Form7.ibDataSet8.Selectsql.Add('select * from PAGAR where EMISSAO=CURRENT_DATE');
        Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where EMISSAO=CURRENT_DATE');
        Form7.ibDataSet3.Selectsql.Add('select * from OS where DATA=CURRENT_DATE ');
        Form7.ibDataSet5.Selectsql.Add('select * from MOVIMENT where NOME='+quotedStr('XXXXXXXXXX')+'');
        Form7.ibDataSet6.Selectsql.Add('select * from CODEBAR where CODIGO=''99999'' ');
        //
        //  CAIXA
        //  ICM
        //  NOTA
        //  TRANSPORT
        //  CONTAS
        //  LIMPA
        //  VENDEDOR
        //  GRUPOS
        //  CONVENIO
        //  CLIENTES
        //  ESTOQUE
        //  BANCOS
        //  BACKUP
        //  CONFIG
        //  CONFOS
        //  CONFRECIBO
        //  RECEBER
        //  PAGAR
        //  OS
        //  VENDA
        //  COMPRA
        //  TECNICO
        //
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO=''99999'' order by upper(DESCRICAO)');
        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where nome = ''X.X.X.X.X.X.'' order by upper(NOME)');
        //
      end;
      //
    end;
    //
  end;
  //
  Result := True;
  //
end;

function AbreArquivos(P1:Boolean): Boolean;
begin
  //
  try
    //
    if not Form7.ibDataSet13.active then Form7.ibDataSet13.active := True;
    if not Form7.ibDataSet25.active then Form7.ibDataSet25.active := True;
    if not Form7.ibDataSet28.active then Form7.ibDataSet28.active := True;
    if not Form7.ibDataSet19.active then Form7.ibDataSet19.active := True;
    if not Form7.ibDataSet18.active then Form7.ibDataSet18.active := True;
    if not Form7.ibDataSet14.active then Form7.ibDataSet14.active := True;
    if not Form7.ibDataSet11.active then Form7.ibDataSet11.active := True;
    if not Form7.ibDataSet26.active then Form7.ibDataSet26.active := True;
    if not Form7.ibDataSet9.active  then Form7.ibDataSet9.active  := True;
    if not Form7.ibDataSet29.active then Form7.ibDataSet29.active := True;
    if not Form7.ibDataSet39.active then Form7.ibDataSet39.active := True;
    if not Form7.ibDataSet49.active then Form7.ibDataSet49.active := True;
    if not Form7.ibDataSet12.active then Form7.ibDataSet12.active := True;
    if not Form7.ibDataSet2.active  then Form7.ibDataSet2.active  := True;
    if not Form7.ibDataSet3.active  then Form7.ibDataSet3.active  := True;
    if not Form7.ibDataSet1.active  then Form7.ibDataSet1.active  := True;
    if not Form7.ibDataSet27.active then Form7.ibDataSet27.active := True;
    if not Form7.ibDataSet21.active then Form7.ibDataSet21.active := True;
    if not Form7.ibDataSet10.active then Form7.ibDataSet10.active := True;
    if not Form7.ibDataSet30.active then Form7.ibDataSet30.active := True;
    if not Form7.ibDataSet16.active then Form7.ibDataSet16.active := True;
    if not Form7.ibDataSet15.active then Form7.ibDataSet15.active := True;
    if not Form7.ibDataSet23.active then Form7.ibDataSet23.active := True;
    if not Form7.ibDataSet24.active then Form7.ibDataSet24.active := True;
    if not Form7.ibDataSet35.active then Form7.ibDataSet35.active := True;
    if not Form7.ibDataSet8.active  then Form7.ibDataSet8.active  := True;
    if not Form7.ibDataSet7.active  then Form7.ibDataSet7.active  := True;
    if not Form7.ibDataSet4.active  then Form7.ibDataSet4.active  := True;
    if not Form7.ibDataSet5.active  then Form7.ibDataSet5.active  := True;
    if not Form7.ibDataSet6.active  then Form7.ibDataSet6.active  := True;
    //
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao abrir arquivos.'
      ),'Erro: 5179',mb_Ok + MB_ICONWARNING);
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      Abort;
    end;
  end;
  //
  if p1 then
  begin
    //
    if Form7.ibDataSet1.Active then Form7.ibDataSet1.EnableControls;
    if Form7.ibDataSet27.Active then Form7.ibDataSet27.EnableControls;
    if Form7.ibDataSet25.Active then Form7.ibDataSet25.EnableControls;
    if Form7.ibDataSet21.Active then Form7.ibDataSet21.EnableControls;
    if Form7.ibDataSet10.Active then Form7.ibDataSet10.EnableControls;
    if Form7.ibDataSet30.Active then Form7.ibDataSet30.EnableControls;
    if Form7.ibDataSet28.Active then Form7.ibDataSet28.EnableControls;
    if Form7.ibDataSet19.Active then Form7.ibDataSet19.EnableControls;
    if Form7.ibDataSet18.Active then Form7.ibDataSet18.EnableControls;
// ka    if Form7.ibDataSet16.Active then Form7.ibDataSet16.EnableControls;
    if Form7.ibDataSet15.Active then Form7.ibDataSet15.EnableControls;
    if Form7.ibDataSet23.Active then Form7.ibDataSet23.EnableControls;
    if Form7.ibDataSet24.Active then Form7.ibDataSet24.EnableControls;
    if Form7.ibDataSet35.Active then Form7.ibDataSet35.EnableControls;
    if Form7.ibDataSet13.Active then Form7.ibDataSet13.EnableControls;
    if Form7.ibDataSet14.Active then Form7.ibDataSet14.EnableControls;
    if Form7.ibDataSet11.Active then Form7.ibDataSet11.EnableControls;
    if Form7.ibDataSet26.Active then Form7.ibDataSet26.EnableControls;
    if Form7.ibDataSet9.Active then Form7.ibDataSet9.EnableControls;
    if Form7.ibDataSet29.Active then Form7.ibDataSet29.EnableControls;
    if Form7.ibDataSet39.Active then Form7.ibDataSet39.EnableControls;
    if Form7.ibDataSet49.Active then Form7.ibDataSet49.EnableControls;
    if Form7.ibDataSet12.Active then Form7.ibDataSet12.EnableControls;
    if Form7.ibDataSet8.Active then Form7.ibDataSet8.EnableControls;
    if Form7.ibDataSet7.Active then Form7.ibDataSet7.EnableControls;
    if Form7.ibDataSet2.Active then Form7.ibDataSet2.EnableControls;
    if Form7.ibDataSet3.Active then Form7.ibDataSet3.EnableControls;
    if Form7.ibDataSet4.Active then Form7.ibDataSet4.EnableControls;
    if Form7.ibDataSet5.Active then  Form7.ibDataSet5.EnableControls;
    //
  end;
  //
  Result := True;
  //
end;

function TraduzSql(P1: String;P2 :Boolean): String;
var
  I : Integer;
begin
  //
  P1 := StrTran(P1,'Coalesce', '');
  P1 := StrTran(P1, QuotedStr('~'),'');
  P1 := StrTran(P1,'PEDIDO', 'oramento');
  P1 := StrTran(P1,'REGISTRO', 'Lanamento');
  P1 := StrTran(P1,'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+'', ' s clientes ');
  P1 := StrTran(P1,'where coalesce(CLIFOR,'+QuotedStr('F')+')='+QuotedStr('F')+'', ' s fornecedores ');
  //
  P1 := StrTran(P1,'Coalesce(VALOR_RECE,0)=0', ' a receber ');
  //
  P1 := StrTran(P1,' IE', ' Inscrio');
  P1 := StrTran(P1,'(IE)', ' Inscrio');
  //
  if Copy(Form7.TabelaAberta.SelectSQL.Text,1,12)='select first' then P1 := StrTran(P1, 'Listando' ,'Mostrando os ltimos '+Form7.sMaxReg+' registros' );
  //
  P1 := StrTran(P1,' and EMITIDA='+QuotedStr('X'), ', canceladas ');
  P1 := StrTran(P1,' and EMITIDA<>'+QuotedStr('S')+' and EMITIDA<>'+QuotedStr('X'), ', no impressas ');
  P1 := StrTran(P1, '(select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0)<>0',' clientes com contas a receber ');
  P1 := StrTran(P1, '(select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)<>0',' clientes com contas atrasadas ');
  P1 := StrTran(P1, '(select Coalesce(sum(VALOR_DUPL),0) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)=0',' clientes com contas em dia ');
  //
  P1 := StrTran(P1,'substring(DATANAS from 6 for 5)', ' aniverssrio ');
  P1 := StrTran(P1, 'MOSTRAR<>'+QuotedStr('0'),' est atrasado ');
  P1 := StrTran(P1, 'MOSTRAR<>'+QuotedStr('1'),' est em dia ');
  P1 := StrTran(P1,'C='+QuotedStr('R   ')+' ',' no conciliado com o estrato do banco ' );
//  P1 := StrTran(P1, 'ContatoS' ,' Contatos ');
  P1 := StrTran(P1, 'CONTATOS' ,' Contatos ');
  P1 := StrTran(P1, 'order by' ,' e ordenando por ' );
  P1 := StrTran(P1, 'group by' ,' e agrupado por ' );
  P1 := StrTran(P1, 'CURRENT_DATE' ,' data de hoje ' );
  P1 := StrTran(P1, 'where' ,' s quando ' );
  P1 := StrTran(P1, '='     ,' igual a '  );
  P1 := StrTran(P1, '<>'    ,' diferente '  );
  P1 := StrTran(P1, '>'     ,' maior que '  );
  P1 := StrTran(P1, '<'     ,' menor que '  );
  P1 := StrTran(P1, 'like'  ,' com '    );
  P1 := StrTran(P1, 'upper' ,'');
  P1 := StrTran(P1, ' and ' ,' e '      );
  P1 := StrTran(P1, ' not ' ,' no '    );
  P1 := StrTran(P1, '(' ,'');
  P1 := StrTran(P1, ')' ,'');
  P1 := StrTran(P1, '%' ,'');
  P1 := StrTran(P1, '  ' ,' ');
  P1 := StrTran(P1, 's quando s' ,'s');
  //
  for I := 1 to Form7.TabelaAberta.FieldCount do if Form7.TabelaAberta.Fields[I-1].FieldName <> Form7.TabelaAberta.Fields[I-1].DisplayLabel then
  begin
    if (Form7.TabelaAberta.Fields[I-1].FieldName <> 'IPI')
    and (copy(Form7.TabelaAberta.Fields[I-1].FieldName,1,3) <> 'CST')
  then
    begin
      P1 := StrTran(P1,' '+Form7.TabelaAberta.Fields[I-1].FieldName,' '+Form7.TabelaAberta.Fields[I-1].DisplayLabel);
    end;
  end;
  //
  Result := P1;
  //
end;


function ImprimeOuNaoANota(pP1:Boolean):Boolean;
var
  //
  vLinha: array [0..200]  of String;  // Cria uma matriz com 100 elementos
                                      // isso eu aprendi num sonho
  vCampo: array [0..3000] of Variant; // Cria uma matriz com 1000 elementos
  ConfItens, ConfSvc, iPagina, I, J : Integer; // e contedo varivel
  F: TextFile;
  Mais1ini, Mais2Ini: TIniFile;
  bMaisItens  : Boolean;
  //
begin
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
  if (Mais1Ini.ReadString('NFE','Ambiente','Homologacao') <> 'Producao') or (Mais1Ini.ReadString('NFE','Formulario','No') <> 'No') then
  begin
    Mais1ini.Free;
    //
    ShortDateFormat := 'dd/mm/yyyy';   {Bug 2001 free}
    iPagina         := 72;
    Mais1ini        := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    ConfItens       := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Itens','16'));
    ConfSvc         := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Svc','5'));
    //
    Mais1ini.Free;
    //
    // Relaciona a natureza da operao com o arquivo de vendas
    //
    if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = ''
      then Form7.ibDataSet14.Append
         else Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
    //
    // Relaciona os clientes com o arquivo de vendas
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    //
    Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
    Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
    //
    try
      //
      // Verifica se o cliente est cadastrado se a nota tem valor
      //
      if (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') and ((Form7.ibDataSet15TOTAL.AsFloat <> 0) or (Form7.ibDataSet15ICMS.AsFloat <> 0)) then
      begin
        //
        // Abre o arquivo de clientes para edio
        //
        try
          if  Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime then
          begin
            Form7.ibDataSet2.Edit;
            Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
            Form7.ibDataSet2.Post;
          end;
        except
          try
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15LOKED.AsString := 'S';
            Form7.ibDataSet15.Post;
          except end;
        end;
        //
        if Form7.ibDataSet15EMITIDA.AsString = 'S' then
        begin
          I := Application.MessageBox(pChar(
                                    chr(10) +'Esta nota j foi impressa!                   '
                                    +chr(10)+
                                    chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                                    'posicionado.'+Chr(10)+
                                    chr(10)+
                                    'Imprimir a nota fiscal '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' agora?'),
                                    'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        end else
        begin
          I := Application.MessageBox(pChar(chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                                    'posicionado.'+Chr(10)+
                                    chr(10)+
                                    'Imprimir a nota fiscal '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' agora?'),
                                    'Ateno',mb_YesNo + MB_ICONWARNING);
        end;
        //
        if I = 6 then
        begin
          //
          // Incio da impresso da nota
          //
          bMaisItens := True;
          Form7.ibDataSet16.First;
          Form7.ibDataSet35.First;
          //
          while bMaisItens do
          begin
            {                                           }
            { Arquivo de NF indexado por LINHA + COLUNA }
            {                                           }
            Form7.ibDataSet19.Active     := False;
            Form7.ibDataSet19.SelectSQL.Clear;
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then  Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=1 order by ((LINHA * 1000) + COLUNA)');
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then  Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=2 order by ((LINHA * 1000) + COLUNA)');
            Form7.ibDataSet19.Open;
            {                                           }
            { Inicializa todos os elementos dos vetores }
            {                                           }
            for I := 1 to 1300 do vCampo[I] := '';
            for I := 1 to 200  do  vLinha[I] := '';

            //
            // Zera os servicos
            //
            for I := 1 to 50 do
            begin
              vCampo[2150 + I] := '';
              vCampo[2300 + I] := '';
              vCampo[2350 + I] := '';
              vCampo[2400 + I] := '';
              vCampo[2600 + I] := '';
            end;

            //
            // Valores nmericos
            //
            vCampo[020] := '************';   //  20 Base de Clculo do ISS
            vCampo[021] := '************';
            vCampo[022] := '************'; //  22 Valor total do ISS
            vCampo[023] := '************'; //  23 Base de Clculo do ICMS
            vCampo[025] := '************'; //  25 Valor do ICM
            vCampo[026] := '************'; //  26 Base de subst
            vCampo[027] := '************'; //  27 ICMS de Subst
            vCampo[028] := '************'; //  28 Total dos Produtos
            vCampo[029] := '************'; //  29 Valor do frete
            vCampo[030] := '************'; //  30 Seguro
            vCampo[031] := '************'; //  31 Outras despesas
            vCampo[032] := '************'; //  32 Valor total do IPI
            vCampo[033] := '************'; //  33 Valor total da nota
            vCampo[063] := Replicate('x',160);   //  Valor por Extenso
            vCampo[046] := '************'; //  29 Valor do desconto
            vCampo[069] := '************';
            vCampo[085] := '************'; //  Valor total dos produtos
            vCampo[020] := '************'; //  Imposto de renda
            //
            vCampo[034] := '*****************************';   //  34 Transportadora Nome
            vCampo[035] := '*';      //  35 Frete por conta (1 ou 2)
            //
            // Transportadora
            //
            if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
            begin
              vCampo[036] := '*******';      //  36 Placa do veculo
              vCampo[037] := '*******';      //  37 estado do veculo
              vCampo[038] := '*******';      //  38 CGC da tranportadora
              vCampo[039] := '*******';      //  39 Transportadora endereo
              vCampo[040] := '*******';      //  40 Transportadora municpio
              vCampo[041] := '*******';      //  41 Estado da transportadora
              vCampo[042] := '*******';      //  42 IE da transportadora
            end;
            //
            vCampo[043] :=  '*******'; //  43 Quantidade de volumes
            vCampo[044] :=  '*******'; //  44 Espcie de volumes
            vCampo[045] :=  '*******'; //  45 Marca dos volumes
            vCampo[047] :=  '*******'; //  47 Peso bruto
            vCampo[048] :=  '*******'; //  48 Peso liquido
            //
            {                                                      }
            { Atribui o valor a cada elemento conf fonte no dBFAST }
            {                                                      }
            vCampo[001] := Form7.ibDataSet13CGC.Value;        //   1 C.G.C. do Emitente
            vCampo[002] := Form7.ibDataSet15OPERACAO.Value;   //   2 Natureza da operaco
            vCampo[003] := Form7.ibDataSet14CFOP.Value;       //   3 C.F.O.
            vCampo[005] := Form7.ibDataSet13IE.Value;         //   5 I.E. do emitente
            vCampo[007] := Form7.ibDataSet2NOME.Value;        //   7 Razo Social do Destinatrio
            vCampo[008] := Form7.ibDataSet2CGC.Value;         //   8 C.G.C. do Destinatrio
            vCampo[009] := DateTimeToStr(Form7.ibDataSet15EMISSAO.asDateTime); //   9 Data de emisso
            vCampo[010] := Form7.ibDataSet2ENDERE.Value;      //  10 Endereo do Destinatrio
            vCampo[011] := Form7.ibDataSet2COMPLE.Value;      //  11 Bairro do cliente
            vCampo[012] := Form7.ibDataSet2CEP.Value;         //  12 CEP do Destinatrio
            vCampo[013] := Form7.ibDataSet15SAIDAD.AsString;  //  13 Data de Sada
            vCampo[014] := Form7.ibDataSet2CIDADE.Value;      //  14 Municpio do Destinatrio
            vCampo[015] := Form7.ibDataSet2FONE.Value;        //  15 Telefone do cliente
            vCampo[016] := Form7.ibDataSet2ESTADO.Value;      //  16 U.F. do Destinatrio
            vCampo[017] := Form7.ibDataSet2IE.Value;          //  17 I.E. do Destinatrio
            vCampo[018] := Form7.ibDataSet15SAIDAH.Value;     //  18 Hora de sada
            //
            vCampo[086] := AllTrim(Form7.ibDataSet2IDENTIFICADOR1.AsString);  // Identificador 1 do cliente
            vCampo[087] := AllTrim(Form7.ibDataSet2IDENTIFICADOR2.AsString);  // Identificador 2 do cliente
            vCampo[088] := AllTrim(Form7.ibDataSet2IDENTIFICADOR3.AsString);  // Identificador 3 do cliente
            vCampo[089] := AllTrim(Form7.ibDataSet2IDENTIFICADOR4.AsString);  // Identificador 4 do cliente
            //
            VCampo[076] := 'X'; // 76 X da nota de saida
            vCampo[077] := ' '; // 77 X da nota de entrada
            //
            vCampo[054] := ''; //  54 Descrio dos servios 1
            vCampo[055] := ''; //  55 Descrio dos Servios 2
            vCampo[056] := ''; //  56 Descrio dos Servios 3
            //
            vCampo[057] := Form7.ibDataSet13ENDERECO.Value;   //  57 Endereco do Emitente
            vCampo[059] := Form7.ibDataSet13MUNICIPIO.Value;  //  59 Cidade do Emitente
            vCampo[060] := Form7.ibDataSet13CEP.Value;        //  60 C.E.P. Emitente
            vCampo[061] := UpperCase(Form7.ibDataSet13ESTADO.AsString);     //  61 Estado do Emitente
            vCampo[062] := Copy(Form7.ibDataSet15NUMERONF.AsString,1,9);   //  62 Nmero da Nota Fiscal
            //
            vCampo[064] := Form7.ibDataSet15IDENTIFICADOR1.Value;     //  Identificador 1
            //
            vCampo[067] := Form7.ibDataSet13NOME.Value;       //  67 Nome do emitente
            vCampo[098] := Form7.ibDataSet15VENDEDOR.Value;     //  98 Nome do vendedor
            vCampo[090] := 'NSU: '+Form7.ibDataSet15NSU.Value;  //  90 NSU
            vCampo[091] := 'Geracao da NSU: '+Form7.ibDataSet15NSUD.AsString +' '+ Copy(Form7.ibDataSet15NSUH.AsString,1,5);  //  Gerao da NSU:
            //
            // Passa os dados do arquivo ITENS001 para os vetores
            //
            I := 0;
            //
            Form7.ibDataSet16.DisableControls;
            while (not Form7.ibDataSet16.Eof) and (I<ConfItens) do // Disable
            begin
              if (Form7.ibDataSet16DESCRICAO.AsString <> '') and (Form7.ibDataSet16QUANTIDADE.AsFloat > 0) then
              begin
                //
                Form7.ibDataSet4.Close;                                                //
                Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                Form7.ibDataSet4.Open;
                //
                // so para sair o 0,00
                //
  //              Form7.ibDataSet16.Edit;
                //
                vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                vCampo[250 + I] := Form7.ibDataSet16MEDIDA.Value;     // 250 Unidades de medida do item
                vCampo[300 + I] := Form7.ibDataSet16QUANTIDADE.Value; // 300 Quantidades do item
                vCampo[350 + I] := Form7.ibDataSet16UNITARIO.Value;   // 350 Valor unitrio do item
                vCampo[400 + I] := Form7.ibDataSet16QUANTIDADE.Value  //
                                   * Form7.ibDataSet16UNITARIO.Value; // 400 Valor total do item
                if Form7.ibDataSet16IPI.AsFloat >= 0 then  vCampo[500 + I] := Form7.ibDataSet16IPI.AsFloat else vCampo[500 + I] := 0;        // 500 % IPI do item
                vCampo[450 + I] := (Form7.ibDataSet16QUANTIDADE.Value * Form7.ibDataSet16UNITARIO.Value * ( Form7.ibDataSet16IPI.Value / 100 )); // 450 Valor IPI do item
                //
                vCampo[550 + I] := Form7.ibDataSet16ICM.Value;        // 550 % ICM do item
                vCampo[600 + I] := Form7.ibDataSet16CODIGO.Value;     // 600 Cdigos do item
                vCampo[650 + I] := Form7.ibDataSet16QUANTIDADE.Value
                                 * Form7.ibDataSet16UNITARIO.Value
                                 * Form7.ibDataSet16ICM.Value
                                  / 100;                     // 650 Valor do ICM do item
                // Procura o produto no estoque
                if Form7.ibDataSet4CODIGO.Value = Form7.ibDataSet16CODIGO.Value then
                begin
                  vCampo[700 + I] := Form7.ibDataSet4CF.Value;          // 700 CF do item
                  vCampo[200 + I] := Form7.ibDataSet4CST.Value;         // 200 ST do item
                  vCampo[750 + I] := Form7.ibDataSet4REFERENCIA.Value;  // 750 Referncia
                end;
                //
                vCampo[800 + I] := Form7.ibDataSet16CFOP.Value;  // 800 CFOP do item
                vCampo[900 + I] := Form7.ibDataSet4LOCAL.Value;  // 900 Local do item
                //
                I := I + 1;
                //
              end else
              begin
                //
                // DESCRICAO NO CORPO DA NOTA
                //
                if (Form7.ibDataSet16DESCRICAO.AsString <> '') then
                begin
                  vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                  I := I + 1;
                end;
                //
              end;
              Form7.ibDataSet16.next;
              //
            end;
            //
            // servios INICIO
            //
            J := 0;
            //
            // servicos
            //
            while (not Form7.ibDataSet35.Eof) and (J<ConfSVC) do // Disable
            begin
              //
              if (Form7.ibDataSet35DESCRICAO.AsString <> '') then
              begin
                //
                vCampo[2150 + J] := Form7.ibDataSet35DESCRICAO.Value;  // 2150 Descrio do item de servico
                vCampo[2300 + J] := Form7.ibDataSet35QUANTIDADE.Value; // 2300 Quantidades do item de servico
                if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then vCampo[2350 + J] := Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.Asfloat;   // 2350 Valor unitrio do item de servico
                vCampo[2400 + J] := Form7.ibDataSet35TOTAL.Value;      // 2400 Valor total do item de servico
                vCampo[2600 + J] := '   ';
                //
                J := J + 1;
                //
              end;
              Form7.ibDataSet35.Next;
            end;
            //
            // servios FIM
            //
            if (Form7.ibDataSet16.eof) and ((Form7.ibDataSet35.eof)) then // Disable
            begin
              //
              bMaisItens := False;
              //
              // Valores
              //
              vCampo[020] := Form7.ibDataSet15SERVICOS.Value;   //  20 Base de Clculo do ISS
              if Form7.ibDataSet15SERVICOS.AsFloat <> 0 then vCampo[021] := Form7.ibDataSet15ISS.AsFloat / Form7.ibDataSet15SERVICOS.AsFloat * 100 else vCampo[021] := 0;
              vCampo[022] := Form7.ibDataSet15ISS.Value;          //  22 Valor total do ISS
              vCampo[023] := Form7.ibDataSet15BASEICM.Value;      //  23 Base de Clculo do ICMS
              vCampo[025] := Form7.ibDataSet15ICMS.Value;         //  25 Valor do ICM
              vCampo[026] := Form7.ibDataSet15BASESUBSTI.Asfloat; //  26 Base de subst
              vCampo[027] := Form7.ibDataSet15ICMSSUBSTI.AsFloat; //  27 ICMS de Subst
              vCampo[028] := Form7.ibDataSet15MERCADORIA.Value;   //  28 Total dos Produtos
              vCampo[029] := Form7.ibDataSet15FRETE.Value;        //  29 Valor do frete
              vCampo[030] := Form7.ibDataSet15SEGURO.Value;       //  30 Seguro
              vCampo[031] := Form7.ibDataSet15DESPESAS.Value;     //  31 Outras despesas
              vCampo[032] := Form7.ibDataSet15IPI.Value;          //  32 Valor total do IPI
              vCampo[033] := Form7.ibDataSet15TOTAL.Value;        //  33 Valor total da nota
              vCampo[046] := Form7.ibDataSet15DESCONTO.Value;     //  29 Valor do desconto
              vCampo[069] := vCampo[033];
              vCampo[085] := Form7.ibDataSet15MERCADORIA.Value;   //  Valor total dos produtos
              //
              vCampo[063] := Alltrim(Extenso(vCampo[033]));
              // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
              try
                if vCampo[020] >= Form1.ConfLimite  then vCampo[068] := vCampo[020] * ((Form1.ConfIR / 100) * 1) else vCAmpo[068] := 0;
              except end;

              // Fatura - Contas a receber
              //
              I := 0;
              //
              Form7.ibDataSet7.First;                 // Procura as duplicatas
              while not Form7.ibDataSet7.Eof do // No contas a receber
              begin
                //
                if AlltRim(Form7.ibDataSet7DOCUMENTO.asString) <> '' then
                begin
                  //
                  vCampo[1000 + I] := Form7.ibDataSet7DOCUMENTO.asString;    // Documento
                  vCampo[1100 + I] := Form7.ibDataSet7VALOR_DUPL.asFloat;    // Valor da duplicata
                  vCampo[1200 + I] := DateTimeToStr(Form7.ibDataSet7VENCIMENTO.asDateTime); // Vencimento
                  //
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = Date then vCampo[1200 + I] := ' VISTA ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime < Date then vCampo[1200 + I] := 'ANTECIP ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = StrToDateTime('30/12/1899') then vCampo[1200 + I] := 'APRESENT';
                  if I < 25 then I := I + 1;
                  //
                end;
                Form7.ibDataSet7.Next;
                //
              end;
              //
              vCampo[034] := Form7.ibDataSet15TRANSPORTA.Value;   //  34 Transportadora Nome
              vCampo[035] := Form7.ibDataSet15FRETE12.Value;      //  35 Frete por conta (0 ou 1)
              //
              // Transportadora
              //
              if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
              begin
                vCampo[036] := Form7.ibDataSet15PLACA.Value;        //  36 Placa do veculo
                vCampo[037] := Form7.ibDataSet18ESTADO.Value;       //  37 estado do veculo
                vCampo[038] := Form7.ibDataSet18CGC.Value;          //  38 CGC da tranportadora
                vCampo[039] := Form7.ibDataSet18ENDERECO.Value;     //  39 Transportadora endereo
                vCampo[040] := Form7.ibDataSet18MUNICIPIO.Value;    //  40 Transportadora municpio
                vCampo[041] := Form7.ibDataSet18UF.Value;           //  41 Estado da transportadora
                vCampo[042] := Form7.ibDataSet18IE.Value;           //  42 IE da transportadora
              end;
              //
              vCampo[043] := Form7.ibDataSet15VOLUMES.Value;      //  43 Quantidade de volumes
              vCampo[044] := Form7.ibDataSet15ESPECIE.Value;      //  44 Espcie de volumes
              vCampo[045] := Form7.ibDataSet15MARCA.Value;        //  45 Marca dos volumes
              vCampo[047] := Form7.ibDataSet15PESOBRUTO.Value;    //  47 Peso bruto
              vCampo[048] := Form7.ibDataSet15PESOLIQUI.Value;    //  48 Peso liquido
              //
              vCampo[049] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1,60);        //  49 Informacoes Complementares 1
              vCampo[050] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*1),60); //  49 Informacoes Complementares 1
              vCampo[051] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*2),60); //  49 Informacoes Complementares 1
              vCampo[052] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*3),60); //  49 Informacoes Complementares 1
              vCampo[053] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*4),60); //  49 Informacoes Complementares 1
              //
            end else
            begin
              bMaisItens := True;
            end;
            //
            // Impresso da NF
            //
            Form7.ibDataSet19.First;
            //
            if Copy(Form7.ibDataSet15NUMERONF.AsString,10,3) = '001' then
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal','Porta','LPT1'));
              Mais2ini.Free;
            end else
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal 2','Porta','LPT1'));
              Mais2ini.Free;
            end;
            //
            try
              Rewrite(F);
            except ShowMessage('Verifique a impressora.') end;
            //                                                                    //
            // Arquivo de nota fiscal NOTA                                        //
            //                                                                    //
            Form7.ibDataSet19.First;                                                  //
            while not Form7.ibDataSet19.Eof do                                        //
            begin                                                                 //
              //                                                                  //
              // No imprime quando a linha e a coluna estiverem zeradas          //
              //                                                                  //
              if Form7.ibDataSet19LINHA.AsFloat > 200 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19LINHA.AsFloat := 200;
              end;
              if Form7.ibDataSet19COLUNA.AsFloat > 300 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19COLUNA.AsFloat := 300;
              end;
              //
              if (Form7.ibDataSet19LINHA.Value + Form7.ibDataSet19COLUNA.Value) > 0 then
              begin
                //
                try
                  if Trunc(Form7.ibDataSet19ELEMENTO.Value) > 0 then
                  begin
                    Form7.ibDataSet19.Edit;
                    Form7.ibDataSet19LAYOUT.AsString := vCampo[ Trunc(Form7.ibDataSet19ELEMENTO.Value) ];
                    Form7.ibDataSet19.Post;
                  end;
                except
                  // ShowMessage('Erro criando o Lay Out da nota fiscal no campo, '+ibDataSet19DESCRICAO.AsString+'.');
                end;
                //
                if (Form7.ibDataSet19ELEMENTO.Value >= 150) and (Form7.ibDataSet19ELEMENTO.Value < 999) then
                begin
  try
                  //
                  // Linha dos produtos
                  //
                  for I := 0 to ConfItens do
                  begin
                    //
                    if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                    begin
                      try
                        //
                        if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                        begin
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right( Replicate(' ',100)+FormatFloat('#,##0.00', vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )] * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString) ),10);
                        end else
                        begin
                          if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                          begin
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        end;
                        //
                      except
                        //
                        try
                          Form7.ibDataSet19.Edit;
                          Form7.ibDataSet19TIPO.AsString := '999.999,99';
                          Form7.ibDataSet19.Post;
                          //
                                                vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        except
                          ShowMessage('Erro 2');

                        end;
                        //
                      end;
                    end else
                    begin
                      try
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                               alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                      except end;
                    end;
                  end;

  except end;

                end else
                begin
                  //
                  // SERVICOS SERVIOS servios
                  //
                  if (Form7.ibDataSet19ELEMENTO.Value >= 2150) and  (Form7.ibDataSet19ELEMENTO.Value < 2999) then
                  begin

  try
                    // Linha dos Servios
                    //
                    // Resolvi esse problema num sonho
                    //
                    for I := 0 to Form1.ConfSvc do
                    begin
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          //
                          try
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                            //
                                                  vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          except end;
                          //
                        end;
                      end else
                      begin
                        try
                           vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                        except end;
                      end;
                    end;
  except end;
                  end else
                  begin
                    //
  try
                    if Form7.ibDataSet19ELEMENTO.Value > 0 then
                    begin
                      //
                      // Todas as informaes da NF menos itens de produtos ou servios
                      //
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          try
                            try
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                              //
                              vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                              Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                              ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                            except end;
                          except end;
                        end;
                      end
                      else
                        try
                          //
                          // @S 0150
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) =  '@S' then
                          begin
                            try
                              vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ] := Copy(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]+Replicate(' ',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2)),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                            except end;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                   alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]);
                        except end;
                    end;
  except end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@&' then // Comando para a impressora
                    begin

                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'E->OBSERVACAO' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + Form7.ibDataSet2OBS.AsString;
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + chr(15);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(18);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[0]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'0';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[1]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'1';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[2]' then vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'2';
                      //
                      // ShowMessage('Teste: '+Chr(10)+UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17)))+chr(10)+'CHR(27)+[C]+CHR(');
                      //
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17))) = 'CHR(27)+[C]+CHR(' then
                      begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'C'+chr(StrToInt(Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-2,2)));
                        iPagina := StrToInt('0'+Limpanumero((Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-3,3))));
                      end;
                    end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@R' then // Texto fixo
                    begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2));
                    end;
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@E' then  // Valor por extenso
                    begin
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] :=
                         Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value)) +
                             Copy(AllTrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ])
                               +' '+Replicate('.x',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2))
                                 ,StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                    end;
                  end;
                  //
                end;
              end;
              //
              Form7.ibDataSet19.Next;
             //
            end;
            {                    }
            { Elimina os acentos }
            {                    }
            for J := 1 to iPagina -1 do
              for I := 1 to 36 do
               vLinha[ J ] := strtran( vLinha[ J ],copy('*',I,1),copy('AAAAAEEEEIIIOOOUUCaaaaaeeeeiiiooouuc*',I,1)
            {+chr(8)+StrTran(copy('/`^"~/~^"/^"/^~/",/~^"~/`^"/^"/^~/",',I,1),'/',Chr(39))});
            {                         }
            { Imprime todas as Linhas }
            {                         }
            //
            // MOTOR DA NOTA FISCAL
            //
            try
              Writeln(F,chr(27)+'@');
              for I := 0 to iPagina -1 do
              begin
                try
                  Writeln(F,vLinha[I]);
                except
                  ShowMessage('Verifique a impressora.');
                  Abort;
                end;
              end;
              CloseFile(F);
            except
              ShowMessage('Verifique a impressora.');
              Abort;
            end;
            //
          end;
          //
          if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
          begin
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
            Form7.ibDataSet15.Post;
          end;
          //
          // Ok imprimiu todos os itens - bMaisItens  falso
          //
        end;
      end;
      //
    except end;
    //
  end;
  //
  Result := True;
  //
end;


function ImprimeOuNaoANotaZZ(pP1:Boolean):Boolean;
var
  //
  vLinha: array [0..200]  of String;  // Cria uma matriz com 100 elementos
                                      // isso eu aprendi num sonho
  vCampo: array [0..3000] of Variant; // Cria uma matriz com 1000 elementos
  ConfItens, ConfSvc, iPagina, I, J : Integer; // e contedo varivel
  F: TextFile;
  Mais1ini, Mais2Ini: TIniFile;
  bMaisItens  : Boolean;
  //
begin
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
  begin
    //
    Mais1ini.Free;
    //
    ShortDateFormat := 'dd/mm/yyyy';   {Bug 2001 free}
    iPagina         := 72;
    Mais1ini        := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    ConfItens       := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Itens','16'));
    ConfSvc         := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Svc','5'));
    //
    Mais1ini.Free;
    //
    // Relaciona a natureza da operao com o arquivo de vendas
    //
    if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = ''
      then Form7.ibDataSet14.Append
         else Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
    //
    // Relaciona os clientes com o arquivo de vendas
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    //
    Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
    Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
    //
    try
      //
      // Verifica se o cliente est cadastrado se a nota tem valor
      //
      if (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') and ((Form7.ibDataSet15TOTAL.AsFloat <> 0) or (Form7.ibDataSet15ICMS.AsFloat <> 0)) then
      begin
        //
        // Abre o arquivo de clientes para edio
        //
        try
          if  Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime then
          begin
            Form7.ibDataSet2.Edit;
            Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
            Form7.ibDataSet2.Post;
          end;
        except
          try
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15LOKED.AsString := 'S';
            Form7.ibDataSet15.Post;
          except end;
        end;
        //
        I := Application.MessageBox(pChar(chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                                  'posicionado.'+Chr(10)+
                                  chr(10)+
                                  'Imprimir a nota fiscal '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' agora?'),
                                  'Ateno',mb_YesNo + MB_ICONWARNING);



        if I = 6 then
        begin
          //
          // Incio da impresso da nota
          //
          bMaisItens := True;
          Form7.ibDataSet16.First;
          Form7.ibDataSet35.First;
          //
          while bMaisItens do
          begin
            {                                           }
            { Arquivo de NF indexado por LINHA + COLUNA }
            {                                           }
            Form7.ibDataSet19.Active     := False;
            Form7.ibDataSet19.SelectSQL.Clear;
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=1 order by ((LINHA * 1000) + COLUNA)') else Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=2 order by ((LINHA * 1000) + COLUNA)');
            Form7.ibDataSet19.Open;
            {                                           }
            { Inicializa todos os elementos dos vetores }
            {                                           }
            for I := 1 to 1300 do vCampo[I] := '';
            for I := 1 to 200  do  vLinha[I] := '';
            //
            // Zera os servicos
            //
            for I := 1 to 50 do
            begin
              vCampo[2150 + I] := '';
              vCampo[2300 + I] := '';
              vCampo[2350 + I] := '';
              vCampo[2400 + I] := '';
              vCampo[2600 + I] := '';
            end;

            //
            // Valores nmericos
            //
            vCampo[020] := '************';   //  20 Base de Clculo do ISS
            vCampo[021] := '************';
            vCampo[022] := '************'; //  22 Valor total do ISS
            vCampo[023] := '************'; //  23 Base de Clculo do ICMS
            vCampo[025] := '************'; //  25 Valor do ICM
            vCampo[026] := '************'; //  26 Base de subst
            vCampo[027] := '************'; //  27 ICMS de Subst
            vCampo[028] := '************'; //  28 Total dos Produtos
            vCampo[029] := '************'; //  29 Valor do frete
            vCampo[030] := '************'; //  30 Seguro
            vCampo[031] := '************'; //  31 Outras despesas
            vCampo[032] := '************'; //  32 Valor total do IPI
            vCampo[033] := '************'; //  33 Valor total da nota
            vCampo[063] := Replicate('x',160);   //  Valor por Extenso
            vCampo[046] := '************'; //  29 Valor do desconto
            vCampo[069] := '************';
            vCampo[085] := '************'; //  Valor total dos produtos
            vCampo[020] := '************'; //  Imposto de renda
            //
            vCampo[034] := '*****************************';   //  34 Transportadora Nome
            vCampo[035] := '*';      //  35 Frete por conta (1 ou 2)
            //
            // Transportadora
            //
            if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
            begin
              vCampo[036] := '*******';      //  36 Placa do veculo
              vCampo[037] := '*******';      //  37 estado do veculo
              vCampo[038] := '*******';      //  38 CGC da tranportadora
              vCampo[039] := '*******';      //  39 Transportadora endereo
              vCampo[040] := '*******';      //  40 Transportadora municpio
              vCampo[041] := '*******';      //  41 Estado da transportadora
              vCampo[042] := '*******';      //  42 IE da transportadora
            end;
            //
            vCampo[043] :=  '*******'; //  43 Quantidade de volumes
            vCampo[044] :=  '*******'; //  44 Espcie de volumes
            vCampo[045] :=  '*******'; //  45 Marca dos volumes
            vCampo[047] :=  '*******'; //  47 Peso bruto
            vCampo[048] :=  '*******'; //  48 Peso liquido
            //
            {                                                      }
            { Atribui o valor a cada elemento conf fonte no dBFAST }
            {                                                      }
            vCampo[001] := Form7.ibDataSet13CGC.Value;        //   1 C.G.C. do Emitente
            vCampo[002] := Form7.ibDataSet15OPERACAO.Value;   //   2 Natureza da operaco
            vCampo[003] := Form7.ibDataSet14CFOP.Value;       //   3 C.F.O.
            vCampo[005] := Form7.ibDataSet13IE.Value;         //   5 I.E. do emitente
            vCampo[007] := Form7.ibDataSet2NOME.Value;        //   7 Razo Social do Destinatrio
            vCampo[008] := Form7.ibDataSet2CGC.Value;         //   8 C.G.C. do Destinatrio
            vCampo[009] := DateTimeToStr(Form7.ibDataSet15EMISSAO.asDateTime); //   9 Data de emisso
            vCampo[010] := Form7.ibDataSet2ENDERE.Value;      //  10 Endereo do Destinatrio
            vCampo[011] := Form7.ibDataSet2COMPLE.Value;      //  11 Bairro do cliente
            vCampo[012] := Form7.ibDataSet2CEP.Value;         //  12 CEP do Destinatrio
            vCampo[013] := Form7.ibDataSet15SAIDAD.AsString;  //  13 Data de Sada
            vCampo[014] := Form7.ibDataSet2CIDADE.Value;      //  14 Municpio do Destinatrio
            vCampo[015] := Form7.ibDataSet2FONE.Value;        //  15 Telefone do cliente
            vCampo[016] := Form7.ibDataSet2ESTADO.Value;      //  16 U.F. do Destinatrio
            vCampo[017] := Form7.ibDataSet2IE.Value;          //  17 I.E. do Destinatrio
            vCampo[018] := Form7.ibDataSet15SAIDAH.Value;     //  18 Hora de sada
            //
            vCampo[086] := AllTrim(Form7.ibDataSet2IDENTIFICADOR1.AsString);  // Identificador 1 do cliente
            vCampo[087] := AllTrim(Form7.ibDataSet2IDENTIFICADOR2.AsString);  // Identificador 2 do cliente
            vCampo[088] := AllTrim(Form7.ibDataSet2IDENTIFICADOR3.AsString);  // Identificador 3 do cliente
            vCampo[089] := AllTrim(Form7.ibDataSet2IDENTIFICADOR4.AsString);  // Identificador 4 do cliente
            //
            VCampo[076] := 'X'; // 76 X da nota de saida
            vCampo[077] := ' '; // 77 X da nota de entrada
            //
            vCampo[054] := ''; //  54 Descrio dos servios 1
            vCampo[055] := ''; //  55 Descrio dos Servios 2
            vCampo[056] := ''; //  56 Descrio dos Servios 3
            //
            vCampo[057] := Form7.ibDataSet13ENDERECO.Value;   //  57 Endereco do Emitente
            vCampo[059] := Form7.ibDataSet13MUNICIPIO.Value;  //  59 Cidade do Emitente
            vCampo[060] := Form7.ibDataSet13CEP.Value;        //  60 C.E.P. Emitente
            vCampo[061] := UpperCase(Form7.ibDataSet13ESTADO.AsString);     //  61 Estado do Emitente
            vCampo[062] := Copy(Form7.ibDataSet15NUMERONF.Value,1,9);   //  62 Nmero da Nota Fiscal
            //
            vCampo[064] := Form7.ibDataSet15IDENTIFICADOR1.Value;     //  Identificador 1
            //
            vCampo[067] := Form7.ibDataSet13NOME.Value;       //  67 Nome do emitente
            vCampo[098] := Form7.ibDataSet15VENDEDOR.Value;     //  98 Nome do vendedor
            vCampo[090] := 'NSU: '+Form7.ibDataSet15NSU.Value;  //  90 NSU
            vCampo[091] := 'Geracao da NSU: '+Form7.ibDataSet15NSUD.AsString +' '+ Copy(Form7.ibDataSet15NSUH.AsString,1,5);  //  Gerao da NSU:
            //
            // Passa os dados do arquivo ITENS001 para os vetores
            //
            I := 0;
            //
            Form7.ibDataSet16.DisableControls;
            while (not Form7.ibDataSet16.Eof) and (I<ConfItens) do // Disable
            begin
              if (Form7.ibDataSet16DESCRICAO.AsString <> '') and (Form7.ibDataSet16QUANTIDADE.AsFloat > 0) then
              begin
                //
                Form7.ibDataSet4.Close;                                                //
                Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                Form7.ibDataSet4.Open;
                //
                // so para sair o 0,00
                //
  //              Form7.ibDataSet16.Edit;
                //
                vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                vCampo[250 + I] := Form7.ibDataSet16MEDIDA.Value;     // 250 Unidades de medida do item
                vCampo[300 + I] := Form7.ibDataSet16QUANTIDADE.Value; // 300 Quantidades do item
                vCampo[350 + I] := Form7.ibDataSet16UNITARIO.Value;   // 350 Valor unitrio do item
                vCampo[400 + I] := Form7.ibDataSet16QUANTIDADE.Value  //
                                   * Form7.ibDataSet16UNITARIO.Value; // 400 Valor total do item
                if Form7.ibDataSet16IPI.AsFloat >= 0 then  vCampo[500 + I] := Form7.ibDataSet16IPI.AsFloat else vCampo[500 + I] := 0;        // 500 % IPI do item
                vCampo[450 + I] := (Form7.ibDataSet16QUANTIDADE.Value * Form7.ibDataSet16UNITARIO.Value * ( Form7.ibDataSet16IPI.Value / 100 )); // 450 Valor IPI do item
                //
                vCampo[550 + I] := Form7.ibDataSet16ICM.Value;        // 550 % ICM do item
                vCampo[600 + I] := Form7.ibDataSet16CODIGO.Value;     // 600 Cdigos do item
                vCampo[650 + I] := Form7.ibDataSet16QUANTIDADE.Value
                                 * Form7.ibDataSet16UNITARIO.Value
                                 * Form7.ibDataSet16ICM.Value
                                  / 100;                     // 650 Valor do ICM do item
                // Procura o produto no estoque
                if Form7.ibDataSet4CODIGO.Value = Form7.ibDataSet16CODIGO.Value then
                begin
                  vCampo[700 + I] := Form7.ibDataSet4CF.Value;          // 700 CF do item
                  vCampo[200 + I] := Form7.ibDataSet4CST.Value;         // 200 ST do item
                  vCampo[750 + I] := Form7.ibDataSet4REFERENCIA.Value;  // 750 Referncia
                end;
                //
                vCampo[800 + I] := Form7.ibDataSet16CFOP.Value;  // 800 CFOP do item
                vCampo[900 + I] := Form7.ibDataSet4LOCAL.Value;  // 900 Local do item
                //
                I := I + 1;
                //
              end else
              begin
                //
                // DESCRICAO NO CORPO DA NOTA
                //
                if (Form7.ibDataSet16DESCRICAO.AsString <> '') then
                begin
                  vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                  I := I + 1;
                end;
                //
              end;
              Form7.ibDataSet16.next;
              //
            end;
            //
            // servios INICIO
            //
            J := 0;
            //
            // servicos
            //
            while (not Form7.ibDataSet35.Eof) and (J<ConfSVC) do // Disable
            begin
              //
              if (Form7.ibDataSet35DESCRICAO.AsString <> '') then
              begin
                //
                vCampo[2150 + J] := Form7.ibDataSet35DESCRICAO.Value;  // 2150 Descrio do item de servico
                vCampo[2300 + J] := Form7.ibDataSet35QUANTIDADE.Value; // 2300 Quantidades do item de servico
                if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then vCampo[2350 + J] := Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.Asfloat;   // 2350 Valor unitrio do item de servico
                vCampo[2400 + J] := Form7.ibDataSet35TOTAL.Value;      // 2400 Valor total do item de servico
                vCampo[2600 + J] := '   ';
                //
                J := J + 1;
                //
              end;
              Form7.ibDataSet35.Next;
            end;
            //
            // servios FIM
            //
            if (Form7.ibDataSet16.eof) and ((Form7.ibDataSet35.eof)) then // Disable
            begin
              //
              bMaisItens := False;
              //
              // Valores
              //
              vCampo[020] := Form7.ibDataSet15SERVICOS.Value;   //  20 Base de Clculo do ISS
              if Form7.ibDataSet15SERVICOS.AsFloat <> 0 then vCampo[021] := Form7.ibDataSet15ISS.AsFloat / Form7.ibDataSet15SERVICOS.AsFloat * 100 else vCampo[021] := 0;
              vCampo[022] := Form7.ibDataSet15ISS.Value;          //  22 Valor total do ISS
              vCampo[023] := Form7.ibDataSet15BASEICM.Value;      //  23 Base de Clculo do ICMS
              vCampo[025] := Form7.ibDataSet15ICMS.Value;         //  25 Valor do ICM
              vCampo[026] := Form7.ibDataSet15BASESUBSTI.Asfloat; //  26 Base de subst
              vCampo[027] := Form7.ibDataSet15ICMSSUBSTI.AsFloat; //  27 ICMS de Subst
              vCampo[028] := Form7.ibDataSet15MERCADORIA.Value;   //  28 Total dos Produtos
              vCampo[029] := Form7.ibDataSet15FRETE.Value;        //  29 Valor do frete
              vCampo[030] := Form7.ibDataSet15SEGURO.Value;       //  30 Seguro
              vCampo[031] := Form7.ibDataSet15DESPESAS.Value;     //  31 Outras despesas
              vCampo[032] := Form7.ibDataSet15IPI.Value;          //  32 Valor total do IPI
              vCampo[033] := Form7.ibDataSet15TOTAL.Value;        //  33 Valor total da nota
              vCampo[046] := Form7.ibDataSet15DESCONTO.Value;     //  29 Valor do desconto
              vCampo[069] := vCampo[033];
              vCampo[085] := Form7.ibDataSet15MERCADORIA.Value;   //  Valor total dos produtos
              //
              vCampo[063] := Alltrim(Extenso(vCampo[033]));
              // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
              try
                if vCampo[020] >= Form1.ConfLimite  then vCampo[068] := vCampo[020] * ((Form1.ConfIR / 100) * 1) else vCAmpo[068] := 0;
              except end;

              // Fatura - Contas a receber
              //
              I := 0;
              //
              Form7.ibDataSet7.First;                 // Procura as duplicatas
              while not Form7.ibDataSet7.Eof do // No contas a receber
              begin
                //
                if AlltRim(Form7.ibDataSet7DOCUMENTO.asString) <> '' then
                begin
                  //
                  vCampo[1000 + I] := Form7.ibDataSet7DOCUMENTO.asString;    // Documento
                  vCampo[1100 + I] := Form7.ibDataSet7VALOR_DUPL.asFloat;    // Valor da duplicata
                  vCampo[1200 + I] := DateTimeToStr(Form7.ibDataSet7VENCIMENTO.asDateTime); // Vencimento
                  //
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = Date then vCampo[1200 + I] := ' VISTA ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime < Date then vCampo[1200 + I] := 'ANTECIP ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = StrToDateTime('30/12/1899') then vCampo[1200 + I] := 'APRESENT';
                  if I < 25 then I := I + 1;
                  //
                end;
                Form7.ibDataSet7.Next;
                //
              end;
              //
              vCampo[034] := Form7.ibDataSet15TRANSPORTA.Value;   //  34 Transportadora Nome
              vCampo[035] := Form7.ibDataSet15FRETE12.Value;      //  35 Frete por conta (1 ou 2)
              //
              // Transportadora
              //
              if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
              begin
                vCampo[036] := Form7.ibDataSet15PLACA.Value;        //  36 Placa do veculo
                vCampo[037] := Form7.ibDataSet18ESTADO.Value;       //  37 estado do veculo
                vCampo[038] := Form7.ibDataSet18CGC.Value;          //  38 CGC da tranportadora
                vCampo[039] := Form7.ibDataSet18ENDERECO.Value;     //  39 Transportadora endereo
                vCampo[040] := Form7.ibDataSet18MUNICIPIO.Value;    //  40 Transportadora municpio
                vCampo[041] := Form7.ibDataSet18UF.Value;           //  41 Estado da transportadora
                vCampo[042] := Form7.ibDataSet18IE.Value;           //  42 IE da transportadora
              end;
              //
              vCampo[043] := Form7.ibDataSet15VOLUMES.Value;      //  43 Quantidade de volumes
              vCampo[044] := Form7.ibDataSet15ESPECIE.Value;      //  44 Espcie de volumes
              vCampo[045] := Form7.ibDataSet15MARCA.Value;        //  45 Marca dos volumes
              vCampo[047] := Form7.ibDataSet15PESOBRUTO.Value;    //  47 Peso bruto
              vCampo[048] := Form7.ibDataSet15PESOLIQUI.Value;    //  48 Peso liquido
              //
              vCampo[049] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1,60);        //  49 Informacoes Complementares 1
              vCampo[050] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*1),60); //  49 Informacoes Complementares 1
              vCampo[051] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*2),60); //  49 Informacoes Complementares 1
              vCampo[052] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*3),60); //  49 Informacoes Complementares 1
              vCampo[053] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*4),60); //  49 Informacoes Complementares 1
              //
            end else
            begin
              bMaisItens := True;
            end;
            //
            // Impresso da NF
            //
            Form7.ibDataSet19.First;
            //
            if Copy(Form7.ibDataSet15NUMERONF.AsString,10,3) = '001' then
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal','Porta','LPT1'));
              Mais2ini.Free;
            end else
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal 2','Porta','LPT1'));
              Mais2ini.Free;
            end;
            //
            try
              Rewrite(F);
            except ShowMessage('Verifique a impressora.') end;
            //                                                                    //
            // Arquivo de nota fiscal NOTA                                        //
            //                                                                    //
            Form7.ibDataSet19.First;                                                  //
            while not Form7.ibDataSet19.Eof do                                        //
            begin                                                                 //
              //                                                                  //
              // No imprime quando a linha e a coluna estiverem zeradas          //
              //                                                                  //
              if Form7.ibDataSet19LINHA.AsFloat > 200 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19LINHA.AsFloat := 200;
              end;
              if Form7.ibDataSet19COLUNA.AsFloat > 300 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19COLUNA.AsFloat := 300;
              end;
              //
              if (Form7.ibDataSet19LINHA.Value + Form7.ibDataSet19COLUNA.Value) > 0 then
              begin
                //
                try
                  if Trunc(Form7.ibDataSet19ELEMENTO.Value) > 0 then
                  begin
                    Form7.ibDataSet19.Edit;
                    Form7.ibDataSet19LAYOUT.AsString := vCampo[ Trunc(Form7.ibDataSet19ELEMENTO.Value) ];
                    Form7.ibDataSet19.Post;
                  end;
                except
                  // ShowMessage('Erro criando o Lay Out da nota fiscal no campo, '+ibDataSet19DESCRICAO.AsString+'.');
                end;
                //
                if (Form7.ibDataSet19ELEMENTO.Value >= 150) and (Form7.ibDataSet19ELEMENTO.Value < 999) then
                begin
  try
                  //
                  // Linha dos produtos
                  //
                  for I := 0 to ConfItens do
                  begin
                    //
                    if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                    begin
                      try
                        //
                        if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                        begin
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right( Replicate(' ',100)+FormatFloat('#,##0.00', vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )] * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString) ),10);
                        end else
                        begin
                          if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                          begin
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        end;
                        //
                      except
                        //
                        try
                          Form7.ibDataSet19.Edit;
                          Form7.ibDataSet19TIPO.AsString := '999.999,99';
                          Form7.ibDataSet19.Post;
                          //
                                                vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        except
                          ShowMessage('Erro 2');

                        end;
                        //
                      end;
                    end else
                    begin
                      try
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                               alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                      except end;
                    end;
                  end;

  except end;

                end else
                begin
                  //
                  // SERVICOS SERVIOS servios
                  //
                  if (Form7.ibDataSet19ELEMENTO.Value >= 2150) and  (Form7.ibDataSet19ELEMENTO.Value < 2999) then
                  begin

  try
                    // Linha dos Servios
                    //
                    // Resolvi esse problema num sonho
                    //
                    for I := 0 to Form1.ConfSvc do
                    begin
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          //
                          try
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                            //
                                                  vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          except end;
                          //
                        end;
                      end else
                      begin
                        try
                           vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                        except end;
                      end;
                    end;
  except end;
                  end else
                  begin
                    //
  try
                    if Form7.ibDataSet19ELEMENTO.Value > 0 then
                    begin
                      //
                      // Todas as informaes da NF menos itens de produtos ou servios
                      //
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          try
                            try
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                              //
                              vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                              Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                              ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                            except end;
                          except end;
                        end;
                      end
                      else
                        try
                          //
                          // @S 0150
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) =  '@S' then
                          begin
                            try
                              vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ] := Copy(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]+Replicate(' ',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2)),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                            except end;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                   alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]);
                        except end;
                    end;
  except end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@&' then // Comando para a impressora
                    begin

                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'E->OBSERVACAO' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + Form7.ibDataSet2OBS.AsString;
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + chr(15);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(18);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[0]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'0';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[1]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'1';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[2]' then vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'2';
                      //
                      // ShowMessage('Teste: '+Chr(10)+UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17)))+chr(10)+'CHR(27)+[C]+CHR(');
                      //
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17))) = 'CHR(27)+[C]+CHR(' then
                      begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'C'+chr(StrToInt(Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-2,2)));
                        iPagina := StrToInt('0'+Limpanumero((Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-3,3))));
                      end;
                    end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@R' then // Texto fixo
                    begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2));
                    end;
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@E' then  // Valor por extenso
                    begin
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] :=
                         Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value)) +
                             Copy(AllTrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ])
                               +' '+Replicate('.x',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2))
                                 ,StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                    end;
                  end;
                  //
                end;
              end;
              //
              Form7.ibDataSet19.Next;
             //
            end;
            {                    }
            { Elimina os acentos }
            {                    }
            for J := 1 to iPagina -1 do
              for I := 1 to 36 do
               vLinha[ J ] := strtran( vLinha[ J ],copy('*',I,1),copy('AAAAAEEEEIIIOOOUUCaaaaaeeeeiiiooouuc*',I,1)
            {+chr(8)+StrTran(copy('/`^"~/~^"/^"/^~/",/~^"~/`^"/^"/^~/",',I,1),'/',Chr(39))});
            {                         }
            { Imprime todas as Linhas }
            {                         }
            //
            // MOTOR DA NOTA FISCAL
            //
            try
              Writeln(F,chr(27)+'@');
              for I := 0 to iPagina -1 do
              begin
                try
                  Writeln(F,vLinha[I]);
                except
                  ShowMessage('Verifique a impressora.');
                  Abort;
                end;
              end;
              //
              CloseFile(F);
              //
              if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
              begin
                Form7.ibDataSet15.Edit;
                Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
                Form7.ibDataSet15.Post;
              end;
              //
            except
              //
              ShowMessage('Verifique a impressora.');
              Abort;
              //
            end;
            //
          end;
          //
          // Ok imprimiu todos os itens - bMaisItens  falso
          //
        end;
      end;
      //
    except end;
    //
    //
  end;
  //
  Result := True;
  //
end;



function ExportaNF(pP1:Boolean):Boolean;
var
  //
  vCampo: array [0..30000] of Variant; // Cria uma matriz com 1000 elementos
  I, J : Integer; // e contedo varivel
  F: TextFile;
  //
begin
  //
  Result := True;
  ShortDateFormat := 'dd/mm/yyyy';   {Bug 2001 free}
  //
  // Relaciona a natureza da operao com o arquivo de vendas
  //
  if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = ''
    then Form7.ibDataSet14.Append
       else Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
  //
  // Relaciona os clientes com o arquivo de vendas
  //
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
  Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
  //
  // Verifica se o cliente est cadastrado se a nota tem valor
  //
  if (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') and ((Form7.ibDataSet15TOTAL.AsFloat <> 0) or (Form7.ibDataSet15ICMS.AsFloat <> 0)) then
  begin
    {                                           }
    { Inicializa todos os elementos dos vetores }
    {                                           }
    for I := 1 to 13000 do vCampo[I] := '';
    {                                                      }
    { Atribui o valor a cada elemento conf fonte no dBFAST }
    {                                                      }
    vCampo[001] := Form7.ibDataSet13CGC.Value;        //   1 C.G.C. do Emitente
    vCampo[002] := Form7.ibDataSet15OPERACAO.Value;   //   2 Natureza da operaco
    vCampo[003] := Form7.ibDataSet14CFOP.Value;       //   3 C.F.O.
    vCampo[005] := Form7.ibDataSet13IE.Value;         //   5 I.E. do emitente
    vCampo[007] := Form7.ibDataSet2NOME.Value;        //   7 Razo Social do Destinatrio
    vCampo[008] := Form7.ibDataSet2CGC.Value;         //   8 C.G.C. do Destinatrio
    vCampo[009] := DateTimeToStr(Form7.ibDataSet15EMISSAO.asDateTime); //   9 Data de emisso
    vCampo[010] := Form7.ibDataSet2ENDERE.Value;      //  10 Endereo do Destinatrio
    vCampo[011] := Form7.ibDataSet2COMPLE.Value;      //  11 Bairro do cliente
    vCampo[012] := Form7.ibDataSet2CEP.Value;         //  12 CEP do Destinatrio
    vCampo[013] := Form7.ibDataSet15SAIDAD.AsString;  //  13 Data de Sada
    vCampo[014] := Form7.ibDataSet2CIDADE.Value;      //  14 Municpio do Destinatrio
    vCampo[015] := Form7.ibDataSet2FONE.Value;        //  15 Telefone do cliente
    vCampo[016] := Form7.ibDataSet2ESTADO.Value;      //  16 U.F. do Destinatrio
    vCampo[017] := Form7.ibDataSet2IE.Value;          //  17 I.E. do Destinatrio
    vCampo[018] := Form7.ibDataSet15SAIDAH.Value;     //  18 Hora de sada
    //
    vCampo[086] := AllTrim(Form7.ibDataSet2IDENTIFICADOR1.AsString);  // Identificador 1 do cliente
    vCampo[087] := AllTrim(Form7.ibDataSet2IDENTIFICADOR2.AsString);  // Identificador 2 do cliente
    vCampo[088] := AllTrim(Form7.ibDataSet2IDENTIFICADOR3.AsString);  // Identificador 3 do cliente
    vCampo[089] := AllTrim(Form7.ibDataSet2IDENTIFICADOR4.AsString);  // Identificador 4 do cliente
    //
    VCampo[076] := 'X'; // 76 X da nota de saida
    vCampo[077] := ' '; // 77 X da nota de entrada
    vCampo[034] := Form7.ibDataSet15TRANSPORTA.Value;   //  34 Transportadora Nome
    vCampo[035] := Form7.ibDataSet15FRETE12.Value;      //  35 Frete por conta (0 ou 1)
    //
    // Transportadora
    //
    if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
    begin
      vCampo[036] := Form7.ibDataSet15PLACA.Value;        //  36 Placa do veculo
      vCampo[037] := Form7.ibDataSet18ESTADO.Value;       //  37 estado do veculo
      vCampo[038] := Form7.ibDataSet18CGC.Value;          //  38 CGC da tranportadora
      vCampo[039] := Form7.ibDataSet18ENDERECO.Value;     //  39 Transportadora endereo
      vCampo[040] := Form7.ibDataSet18MUNICIPIO.Value;    //  40 Transportadora municpio
      vCampo[041] := Form7.ibDataSet18UF.Value;           //  41 Estado da transportadora
      vCampo[042] := Form7.ibDataSet18IE.Value;           //  42 IE da transportadora
    end;
    //
    vCampo[043] := Form7.ibDataSet15VOLUMES.Value;      //  43 Quantidade de volumes
    vCampo[044] := Form7.ibDataSet15ESPECIE.Value;      //  44 Espcie de volumes
    vCampo[045] := Form7.ibDataSet15MARCA.Value;        //  45 Marca dos volumes
    vCampo[047] := Form7.ibDataSet15PESOBRUTO.Value;    //  47 Peso bruto
    vCampo[048] := Form7.ibDataSet15PESOLIQUI.Value;    //  48 Peso liquido
    //
    vCampo[049] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1,60);        //  49 Informacoes Complementares 1
    vCampo[050] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*1),60); //  49 Informacoes Complementares 1
    vCampo[051] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*2),60); //  49 Informacoes Complementares 1
    vCampo[052] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*3),60); //  49 Informacoes Complementares 1
    vCampo[053] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*4),60); //  49 Informacoes Complementares 1
    //
    vCampo[054] := ''; //  54 Descrio dos servios 1
    vCampo[055] := ''; //  55 Descrio dos Servios 2
    vCampo[056] := ''; //  56 Descrio dos Servios 3
    //
    vCampo[057] := Form7.ibDataSet13ENDERECO.Value;   //  57 Endereco do Emitente
    vCampo[059] := Form7.ibDataSet13MUNICIPIO.Value;  //  59 Cidade do Emitente
    vCampo[060] := Form7.ibDataSet13CEP.Value;        //  60 C.E.P. Emitente
    vCampo[061] := UpperCase(Form7.ibDataSet13ESTADO.AsString);     //  61 Estado do Emitente
    vCampo[062] := Copy(Form7.ibDataSet15NUMERONF.AsString,1,9);   //  62 Nmero da Nota Fiscal
    //
    vCampo[064] := Form7.ibDataSet15IDENTIFICADOR1.Value;     //  Identificador 1
    //
    vCampo[067] := Form7.ibDataSet13NOME.Value;       //  67 Nome do emitente
    vCampo[098] := Form7.ibDataSet15VENDEDOR.Value;     //  98 Nome do vendedor
    vCampo[090] := 'NSU: '+Form7.ibDataSet15NSU.Value;  //  90 NSU
    vCampo[091] := 'Geracao da NSU: '+Form7.ibDataSet15NSUD.AsString +' '+ Copy(Form7.ibDataSet15NSUH.AsString,1,5);  //  Gerao da NSU:
    //
    // Passa os dados do arquivo ITENS001 para os vetores
    //
    I := 0;
    //
//    Form7.ibDataSet16.DisableControls;
    while (not Form7.ibDataSet16.Eof) do // Disable
    begin
      if (Form7.ibDataSet16DESCRICAO.AsString <> '') and (Form7.ibDataSet16QUANTIDADE.AsFloat > 0) then
      begin
        //
        Form7.ibDataSet4.Close;                                                //
        Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
        Form7.ibDataSet4.Open;
        //
        // so para sair o 0,00
        //
//              Form7.ibDataSet16.Edit;
        //
        vCampo[01000 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 01000 Descrio do item
        vCampo[02000 + I] := Form7.ibDataSet16MEDIDA.Value;     // 02000 Unidades de medida do item
        vCampo[03000 + I] := Form7.ibDataSet16QUANTIDADE.Value; // 03000 Quantidades do item
        vCampo[04000 + I] := Form7.ibDataSet16UNITARIO.Value;   // 04000 Valor unitrio do item
        vCampo[05000 + I] := Form7.ibDataSet16QUANTIDADE.Value  //
                           * Form7.ibDataSet16UNITARIO.Value;   // 05000 Valor total do item
        if Form7.ibDataSet16IPI.AsFloat >= 0 then  vCampo[6000 + I] := Form7.ibDataSet16IPI.AsFloat else vCampo[6000 + I] := 0;        // 06000 % IPI do item
        vCampo[07000 + I] := (Form7.ibDataSet16QUANTIDADE.Value * Form7.ibDataSet16UNITARIO.Value * ( Form7.ibDataSet16IPI.Value / 100 )); // 07000 Valor IPI do item
        //
        vCampo[08000 + I] := Form7.ibDataSet16ICM.Value;        // 08000 % ICM do item
        vCampo[09000 + I] := Form7.ibDataSet16CODIGO.Value;     // 09000 Cdigos do item
        //
        // Procura o produto no estoque
        //
        if Form7.ibDataSet4CODIGO.Value = Form7.ibDataSet16CODIGO.Value then
        begin
          vCampo[11000 + I] := Form7.ibDataSet4CF.Value;          // 11000 CF do item
          vCampo[12000 + I] := Form7.ibDataSet4CST.Value;         // 12000 ST do item
          vCampo[13000 + I] := Form7.ibDataSet4REFERENCIA.Value;  // 13000 Referncia
        end;
        //
        vCampo[14000 + I] := Form7.ibDataSet16CFOP.Value;  // 14000 CFOP do item
        vCampo[15000 + I] := Form7.ibDataSet4LOCAL.Value;  // 15000 Local do item
        //
        I := I + 1;
        //
      end else
      begin
        //
        // DESCRICAO NO CORPO DA NOTA
        //
        if (Form7.ibDataSet16DESCRICAO.AsString <> '') then
        begin
          vCampo[01000 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
          I := I + 1;
        end;
        //
      end;
      Form7.ibDataSet16.next;
      //
    end;
    //
    vCampo[020] := Form7.ibDataSet15SERVICOS.Value;   //  20 Base de Clculo do ISS
    if Form7.ibDataSet15SERVICOS.AsFloat <> 0 then vCampo[021] := Form7.ibDataSet15ISS.AsFloat / Form7.ibDataSet15SERVICOS.AsFloat * 100 else vCampo[021] := 0;
    vCampo[022] := Form7.ibDataSet15ISS.Value;          //  22 Valor total do ISS
    vCampo[023] := Form7.ibDataSet15BASEICM.Value;      //  23 Base de Clculo do ICMS
    vCampo[025] := Form7.ibDataSet15ICMS.Value;         //  25 Valor do ICM
    vCampo[026] := Form7.ibDataSet15BASESUBSTI.Asfloat; //  26 Base de subst
    vCampo[027] := Form7.ibDataSet15ICMSSUBSTI.AsFloat; //  27 ICMS de Subst
    vCampo[028] := Form7.ibDataSet15MERCADORIA.Value;   //  28 Total dos Produtos
    vCampo[029] := Form7.ibDataSet15FRETE.Value;        //  29 Valor do frete
    vCampo[030] := Form7.ibDataSet15SEGURO.Value;       //  30 Seguro
    vCampo[031] := Form7.ibDataSet15DESPESAS.Value;     //  31 Outras despesas
    vCampo[032] := Form7.ibDataSet15IPI.Value;          //  32 Valor total do IPI
    vCampo[033] := Form7.ibDataSet15TOTAL.Value;        //  33 Valor total da nota
    vCampo[046] := Form7.ibDataSet15DESCONTO.Value;     //  29 Valor do desconto
    vCampo[069] := vCampo[0330];
    vCampo[085] := Form7.ibDataSet15MERCADORIA.Value;   //  Valor total dos produtos
    //
    vCampo[063] := Alltrim(Extenso(vCampo[033]));
    // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
    try
      if vCampo[020] >= Form1.ConfLimite  then vCampo[068] := vCampo[020] * ((Form1.ConfIR / 100) * 1) else vCAmpo[068] := 0;
    except end;
    //
    J := 0;
    //
    // servicos
    //
    Form7.ibDataSet35.First;
    while not Form7.ibDataSet35.Eof do
    begin
      if (Form7.ibDataSet35DESCRICAO.AsString <> '') then
      begin
        //
        vCampo[2150 + J] := Form7.ibDataSet35DESCRICAO.Value;  // 2150 Descrio do item de servico
        vCampo[2300 + J] := Form7.ibDataSet35QUANTIDADE.Value; // 2300 Quantidades do item de servico
        if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then vCampo[2350 + J] := Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.Asfloat;   // 2350 Valor unitrio do item de servico
        vCampo[2400 + J] := Form7.ibDataSet35TOTAL.Value;      // 2400 Valor total do item de servico
        vCampo[2600 + J] := '   ';
        //
        J := J + 1;
        //
      end;
      Form7.ibDataSet35.Next;
    end;
    //
  end;
  //
  Form7.SaveDialog1.FileName := 'SmallNF'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'.TXT';
  Form7.SaveDialog1.Title    := 'Exportar Nota Fiscal';
  //
  if not Form7.SaveDialog1.Execute then Exit;
  DeleteFile(pChar(Form7.SaveDialog1.FileName));
  AssignFile(F, Form7.SaveDialog1.FileName);
  Rewrite(F);
  //
  for I := 1 to 30000 do
  begin
    if (VarType(vCampo[I])= varString) then
    begin
      if Alltrim(vCampo[I]) <> '' then Writeln(F,StrZero(I,5,0)+'='+vCampo[I]);
    end;
    if (VarType(vCampo[I])= varDouble) then
    begin
      Writeln(F,StrZero(I,5,0)+'='+StrZero(vCampo[I],14,4));
    end;
  end;
  //
  CloseFile(F);
  //
end;

function tForm7.ImportaNF(pP1: boolean; sP1: String):Boolean;
var
  //
  NodePrim, NodePai, NodeSec, NodeTmp: IXMLNode; // Node  um n do XML
  Hora, Min, Seg, cent : Word;
  tInicio : tTime;
  sXML,
  sICMSTag,
  sNomeDaEmpresa,
  sIPI     ,
  sICMS    ,
  spICMS   ,
  sBC      ,
  sICMSST  ,
  spREDBC  ,
  spIPI    ,
  sCSTIPI  ,
  sCSTICMS ,
  sBCST    : String;
  sCodigoDeBarrasDoFornecedor : String;
  bProdutoCadastrado : Boolean;
  sCnpjCpf: String; // Sandro Silva 2023-02-22
  //
begin
  //
  Result := True;
  //
  try
    //
//    sP1 := AnsiToUTF8(sP1);
    // Tira o cariage return (CR) e Line Fid (LF)
    //
    //
    if AllTrim(sP1) = '' then
    begin
      //
      // Importa de um arquivo XML informado pelo usurio
      //
      Form7.OpenDialog1.FileName := '';
      Form7.OpenDialog1.Title    := 'Importar Nota Fiscal';
      //
      if not Form7.OpenDialog1.Execute then
        Exit;
      if LowerCase(Right(Form7.OpenDialog1.FileName,4))='.xml' then
      begin
        try
          Form7.XMLDocument1.DOMVendor := GetDOMVendor('Open XML');
          Form7.XMLDocument1.LoadFromFile(Form7.OpenDialog1.FileName);
        except
          Form7.XMLDocument1.DOMVendor := GetDOMVendor('MSXML');
          Form7.XMLDocument1.LoadFromFile(Form7.OpenDialog1.FileName);
        end;
      end;
      //
      // Novo
      //
      Form7.Image101Click(Form7.Image201);
      //
    end else
    begin
      //
      // Importa atravez do XML gravado no COMPRAS automaticamento por download (ConsultarDistribuicaoDFeChave)
      //
      try
        Form7.XMLDocument1.DOMVendor := GetDOMVendor('Open XML');
        Form7.XMLDocument1.XML.Text  := sP1;
      except
        Form7.XMLDocument1.DOMVendor := GetDOMVendor('MSXML');
        Form7.XMLDocument1.XML.Text  := sP1;
      end;
      //
      try
        Form7.XMLDocument1.Active    := True;
      except
        on E: Exception do
        begin
          Application.MessageBox(pChar(E.Message),'Erro 1 importa NF',mb_Ok + MB_ICONWARNING);
        end;
      end;
      //
      // Alterar
      //
      try
        Form7.Image106Click(Form7.Image206);
      except
        on E: Exception do
        begin
          Application.MessageBox(pChar(E.Message),'Erro 2 importa NF',mb_Ok + MB_ICONWARNING);
        end;
      end;
      //
    end;
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message),'Erro 3 importa NF',mb_Ok + MB_ICONWARNING);
    end;
  end;
  //
  Screen.Cursor            := crHourGlass;
  tInicio := time;
  //
  try
    sXML := XMLDocument1.XML.Text;
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message),'Erro ao caregar XML da NF-e',mb_Ok + MB_ICONWARNING);
    end;
  end;
  //
  try
    //
    Form7.ibDataset2.DisableControls;
    Form7.ibDataset23.DisableControls;
    Form7.ibDataset24.DisableControls;
    Form7.ibDataset4.DisableControls;
    //
    try
      //
      if AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//nfeProc/NFe/infNFe/ide/mod')) = '55' then
      begin
        //
        NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe');
        NodePai  := NodePrim.ChildNodes.FindNode('infNFe');
        NodeSec  := NodePai.ChildNodes.FindNode('emit');
        NodeSec.ChildNodes.First;
        //
        Form7.ibDataSet2.Close;
        Form7.ibDataSet2.Selectsql.Clear;
        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR');  //
        Form7.ibDataSet2.Open;
        //
        sNomeDaEmpresa := PrimeiraMaiuscula(AllTrim(Copy(CaracteresHTML((AllTrim(XmlNodeValue(NodeSec.ChildNodes['xNome'].XML,'//xNome'))))+replicate(' ',60),1,60)));
        {Sandro Silva 2023-02-22 inicio}
        sCnpjCpf := Trim(NodeSec.ChildNodes['CNPJ'].Text);
        if sCnpjCpf = '' then
          sCnpjCpf := Trim(NodeSec.ChildNodes['CPF'].Text);
        {Sandro Silva 2023-02-22 fim}

        //
        // Sandro Silva 2023-02-22 if (not Form7.IBDataSet2.Locate('CGC',ConverteCpfCgc(AllTrim(NodeSec.ChildNodes['CNPJ'].Text)),[])) or (AllTrim(Form7.IBDataSet2NOME.AsString) = '') then
        if (not Form7.IBDataSet2.Locate('CGC',ConverteCpfCgc(Trim(sCnpjCpf)),[])) or (AllTrim(Form7.IBDataSet2NOME.AsString) = '') then
        begin
          //
          Form7.IBDataSet2.Append;
          Form7.IBDataSet2CGC.AsString  := ConverteCpfCgc(Trim(sCnpjCpf)); // Sandro Silva 2023-02-22 Form7.IBDataSet2CGC.AsString  := ConverteCpfCgc(AllTrim(NodeSec.ChildNodes['CNPJ'].Text));
          //
          Form1.ibQuery2.Close;
          Form1.ibQuery2.SQL.Clear;
          Form1.ibQuery2.SQL.Add('select * from CLIFOR where Upper(NOME)='+QuotedStr(UpperCase(sNomeDaEmpresa)));
          Form1.ibQuery2.Open;
          //
          while sNomeDaEmpresa = Form1.IBQuery2.FieldByName('NOME').AsString do
          begin
            //
            sNomeDaEmpresa := Copy(sNomeDaEmpresa,1,Length(sNomeDaEmpresa)-2);
            //
            Form1.ibQuery2.Close;
            Form1.ibQuery2.SQL.Clear;
            Form1.ibQuery2.SQL.Add('select * from CLIFOR where NOME='+QuotedStr(sNomeDaEmpresa));
            Form1.ibQuery2.Open;
          end;
          //
          Form7.IBDataSet2NOME.AsString := sNomeDaEmpresa;
          Form7.IBDataSet2IE.AsString   := AllTrim(NodeSec.ChildNodes['IE'].Text);
          //
          NodeTmp  := NodeSec.ChildNodes['enderEmit']; // tag <prod> dentro de <det>
          NodeTmp.ChildNodes.First;
          //
          Form7.IBDataSet2ENDERE.AsString := PrimeiraMaiuscula(CaracteresHTML((AllTrim(XmlNodeValue(NodeTmp.ChildNodes['xLgr'].XML,'//xLgr'))))+' '+AllTrim(NodeTmp.ChildNodes['nro'].Text));
          Form7.IBDataSet2COMPLE.AsString := PrimeiraMaiuscula(CaracteresHTML((AllTrim(XmlNodeValue(NodeTmp.ChildNodes['xBairro'].XML,'//xBairro')))));
          Form7.IBDataSet2CIDADE.AsString := CaracteresHTML((AllTrim(XmlNodeValue(NodeTmp.ChildNodes['xMun'].XML,'//xMun'))));
          Form7.IBDataSet2ESTADO.AsString := AllTrim(NodeTmp.ChildNodes['UF'].Text);
          Form7.IBDataSet2CEP.AsString    := Copy(AllTrim(NodeTmp.ChildNodes['CEP'].Text+'00000000'),1,5)+'-'+Copy(AllTrim(NodeTmp.ChildNodes['CEP'].Text+'00000000'),5,3);
          Form7.IBDataSet2FONE.AsString   := '(0xx'+Copy(AllTrim(NodeTmp.ChildNodes['fone'].Text+'         '),1,2)+')'+Copy(AllTrim(NodeTmp.ChildNodes['fone'].Text+'         '),2,9);
          Form7.IBDataSet2.Post;
          //
        end
        else
        begin
          sNomeDaEmpresa := Form7.IBDataSet2NOME.AsString;
        end;
        //
        NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe');
        NodePai  := NodePrim.ChildNodes.FindNode('infNFe');
        NodeSec  := NodePai.ChildNodes.FindNode('ide');
        //
        NodeSec.ChildNodes.First;
        //
        // ShowMessage('*'+NodeSec.ChildNodes['serie'].Text+'*');
        //
        Form7.ibDataset99.Close;
        Form7.ibDataset99.SelectSql.Clear;
        Form7.ibDataset99.SelectSql.Add('select NUMERONF from COMPRAS where NUMERONF='+QuotedStr( Right(StrZero(StrToFloat(NodeSec.ChildNodes['nNF'].Text),9,0),9)+StrZero(StrToInt(LimpaNumero('0'+NodeSec.ChildNodes['serie'].Text)),3,0) )+' and FORNECEDOR='+QuotedStr(sNomeDaEmpresa)+' ');
        Form7.IBDataSet99.Open;
        //
        if (AllTrim(Form7.ibDAtaSet99.FieldByname('NUMERONF').AsString) <> '') and (sP1='') then
        begin
          //
          ShowMessage('Nota Fiscal J Cadastrada.');
          Form24.Close;
          //
          Form7.sModulo := 'DUPLA';
          Form7.ibDataSet24.Delete;
          Form7.sModulo := 'COMPRA';
          //
          Abort;
          //
        end
        else
        begin
          //
          Form7.ibDataSet24.Edit;
          Form7.ibDataSet24FORNECEDOR.AsString := Form7.IBDataSet2NOME.AsString;
          Form7.ibDataSet24FRETE12.AsString    := '1';
          Form7.ibDataSet24MODELO.AsString     := '55';
          Form7.ibDataSet24EMISSAO.Value       := Date;
          //
          Form24.Label64.Caption := 'Mod: '+Form7.ibDataSet24MODELO.AsString;
          //
          if not Form7.ibDataSet14.Locate('CFOP','2102',[]) then
            Form7.ibDataSet14.Locate('CFOP','1102',[]);
          //
          Form7.ibDataSet24OPERACAO.AsString    := Form7.ibDataSet14NOME.AsString;
          //
          if pP1 then
          begin
            //
            Form7.ibDataSet24NUMERONF.AsString := Right(StrZero(StrToFloat(NodeSec.ChildNodes['nNF'].Text),9,0),9)+StrZero(StrToInt(LimpaNumero('0'+NodeSec.ChildNodes['serie'].Text)),3,0);// Nmero da NF
            //
            Form24.Edit2.Text := Right(StrZero(StrToFloat(NodeSec.ChildNodes['nNF'].Text),9,0),9)+'/'+StrZero(StrToInt(LimpaNumero('0'+NodeSec.ChildNodes['serie'].Text)),3,0);// Nmero da NF
            Form24.Edit2.Repaint;
          end
          else
          begin
            //
            Form7.ibDataset99.Close;
            Form7.ibDataset99.SelectSql.Clear;
            Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE1,0) from rdb$database');
            Form7.IBDataSet99.Open;
            //
            Form7.ibDataSet24NUMERONF.AsString := StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString)+1,9,0)+'001'; // Nmero da NF
            Form7.IBDataSet99.Close;
            //
          end;
          //
          try
            NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('protNFe');
            NodePai  := NodePrim.ChildNodes.FindNode('infProt');
            //
            Form7.ibDataSet24SAIDAD.AsString := Copy(NodePai.ChildNodes['dhRecbto'].Text,9,2)+'/'+Copy(NodePai.ChildNodes['dhRecbto'].Text,6,2)+'/'+Copy(NodePai.ChildNodes['dhRecbto'].Text,1,4); // Data da saida
            Form7.ibDataSet24SAIDAH.AsString := Copy(NodePai.ChildNodes['dhRecbto'].Text,12,8);// Hora da sada
            //
          except
            ShowMessage('Verigique se esta NF-e foi autorizada');
          end;
          //
          NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe');
          NodePai  := NodePrim.ChildNodes.FindNode('infNFe');
          NodeSec  := NodePai.ChildNodes.FindNode('det');
          //
          NodeSec.ChildNodes.First;
          //
          Screen.Cursor            := crHourGlass;
          //
          repeat

            //
            //
            try
              NodeTmp  := NodeSec.ChildNodes['prod']; // tag <prod> dentro de <det>
              NodeTmp.ChildNodes.First;
            except
              on E: Exception do
              begin
                Application.MessageBox(pChar(E.Message),'Erro X importa NF',mb_Ok + MB_ICONWARNING);
              end;
            end;
            //

            if NodeTmp <> nil then
            begin
              try
                if Alltrim(CaracteresHTML((XmlNodeValue(NodeTmp.ChildNodes['xProd'].XML,'//xProd')))) <> '' then
                begin
                  try
                    //
                    bProdutoCadastrado := False;
                    //
                    // Procura primeiro pelo Cdigo de Barras cEAN
                    //
                    if (NodeTmp.ChildNodes['cEAN'].Text <> '') and (NodeTmp.ChildNodes['cEAN'].Text <> 'SEM GTIN')  then
                    begin
                      //
                      Form7.ibDataSet4.Close;
                      Form7.ibDataSet4.SelectSQL.Clear;
                      Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where REFERENCIA='+QuotedStr(NodeTmp.ChildNodes['cEAN'].Text)+' ');
                      Form7.ibDataSet4.Open;
                      //
                      if (AllTrim(Form7.ibDataSet4REFERENCIA.AsString) = AllTrim(NodeTmp.ChildNodes['cEAN'].Text)) and (AllTrim(Form7.ibDataSet4REFERENCIA.AsString) <> '') then
                      begin
                        bProdutoCadastrado := True;
                      end;
                      //
                    end;
                    //
                    if not bProdutoCadastrado then
                    begin
                      //
                      // Procura pelo CODIGO de Barras do fornecedor relacionado no arquivo CODEBAR
                      //
                      if (NodeTmp.ChildNodes['cEAN'].Text = '') or (NodeTmp.ChildNodes['cEAN'].Text = 'SEM GTIN')  then
                      begin
                        sCodigoDeBarrasDoFornecedor := AllTrim(NodeTmp.ChildNodes['cProd'].Text);
                      end else
                      begin
                        sCodigoDeBarrasDoFornecedor := NodeTmp.ChildNodes['cEAN'].Text;
                      end;
                      //
                      Form7.ibQuery1.Close;
                      Form7.ibQuery1.Sql.Clear;
                      Form7.ibQuery1.Sql.Add('select * from CODEBAR where FORNECEDOR='+QuotedStr(Form7.ibDataSet24FORNECEDOR.AsString)+' and EAN='+QuotedStr(sCodigoDeBarrasDoFornecedor)+' ');
                      Form7.ibQuery1.Open;
                      //
                      if AllTrim(Form7.ibQuery1.FieldByname('EAN').AsString) <> '' then
                      begin
                        //
                        sCodigoDeBarrasDoFornecedor := Form7.ibQuery1.FieldByname('CODIGO').AsString;
                        //
                        Form7.ibDataSet4.Close;
                        Form7.ibDataSet4.SelectSQL.Clear;
                        Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(sCodigoDeBarrasDoFornecedor)+' ');
                        Form7.ibDataSet4.Open;
                        //
                        if form7.ibDataSet4CODIGO.AsString = sCodigoDeBarrasDoFornecedor then
                        begin
                          bProdutoCadastrado := True;
                        end;
                        //
                      end;
                    end;
                    //
                    if not bProdutoCadastrado then
                    begin
                      //
                      //  Procura pelo cdigo de barras / quando no tem descricao
                      //
                      Form7.ibQuery1.Close;
                      Form7.ibQuery1.Sql.Clear;
                      Form7.ibQuery1.Sql.Add('select * from CODEBAR where FORNECEDOR='+QuotedStr(Form7.ibDataSet24FORNECEDOR.AsString)+' and CODIGO='+QuotedStr(AllTrim(Form7.ibDataSet4CODIGO.AsString))+' ');
                      Form7.ibQuery1.Open;
                      //
                      if AllTrim(Form7.IBQuery1.FieldByName('EAN').AsString) = '' then
                      begin
                        //
                        Form7.ibDataSet4.Close;
                        Form7.ibDataSet4.SelectSQL.Clear;
                        Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(AllTrim(Copy(CaracteresHTML((XmlNodeValue(NodeTmp.ChildNodes['xProd'].XML,'//xProd')))+Replicate(' ',45),1,45)))+' ');
                        Form7.ibDataSet4.Open;
                        //
                        if AllTrim(Form7.ibDataSet4CODIGO.AsString) <> '' then
                        begin
                          bProdutoCadastrado := True;
                        end else
                        begin
                          bProdutoCadastrado := False;
                        end;
                        //
                      end;
                    end;
                    //
                    if not bProdutoCadastrado then  // No encontrou
                    begin
                      //
                      // Cria um novo produto
                      //
                      Form7.iKey := 0;
                      Form7.ibDataSet4.Append; // Importa NF XML
                      Form7.ibDataSet4REFERENCIA.AsString := NodeTmp.ChildNodes['cEAN'].Text;
                      //
                      //
                      //
                      if AllTrim(NodeTmp.ChildNodes['cProd'].Text) <> '' then
                      begin
                        //
                        // Inclui automaticamente no CODEBAR para saber numa futura compra do mesmo fornecedor que este cdigo  referente a este produto
                        //
                        try
                          Form7.IBDataSet6.Append;
                          Form7.IBDataSet6CODIGO.AsString       := Form7.ibDataSet4CODIGO.AsString;
                          Form7.IBDataSet6EAN.AsString          := AllTrim(NodeTmp.ChildNodes['cProd'].Text);
                          Form7.IBDataSet6FORNECEDOR.AsString   := Form7.ibDataSet24FORNECEDOR.AsString;
                          Form7.IBDataSet6.Post;
                        except
                        end;
                      end;
                      //
                      // Procura para ver se j existe um nome igual
                      //
                      Form7.ibQuery1.Close;
                      Form7.ibQuery1.Sql.Clear;
                      Form7.ibQuery1.Sql.Add('select DESCRICAO from ESTOQUE where DESCRICAO='+QuotedStr(AllTrim(Copy(CaracteresHTML((XmlNodeValue(NodeTmp.ChildNodes['xProd'].XML,'//xProd')))+Replicate(' ',45),1,45)))+' ');
                      Form7.ibQuery1.Open;
                      //
                      if Form7.IBQuery1.FieldByName('DESCRICAO').AsString = AllTrim(Copy(CaracteresHTML((XmlNodeValue(NodeTmp.ChildNodes['xProd'].XML,'//xProd')))+Replicate(' ',45),1,45)) then
                      begin
                        //
                        // Se j existe cria o nome com o cdigo no final
                        //
                        Form7.ibDataSet4DESCRICAO.AsString  := AllTrim(Copy(CaracteresHTML((XmlNodeValue(NodeTmp.ChildNodes['xProd'].XML,'//xProd')))+Replicate(' ',39),1,39))+' '+Form7.ibDataSet4CODIGO.AsString;
                        //
                      end
                      else
                      begin
                        Form7.ibDataSet4DESCRICAO.AsString  := AllTrim(Copy(CaracteresHTML((XmlNodeValue(NodeTmp.ChildNodes['xProd'].XML,'//xProd')))+Replicate(' ',39),1,39))+' '+Form7.ibDataSet4CODIGO.AsString;
                      end;
                      //
                      Form7.ibDataSet4MEDIDA.AsString     := AllTrim(NodeTmp.ChildNodes['uCom'].Text);
                      Form7.ibDataSet4PRECO.AsFloat       := 0.01;
                      Form7.ibDataSet4ALTERADO.AsString   := '3';
                      try
                        Form7.ibDataSet4CF.AsString     := AllTrim(Copy(NodeTmp.ChildNodes['NCM'].Text+Replicate(' ',45),1,45));
                      except
                      end;
                      try
                        Form7.ibDataSet4CEST.AsString   := AllTrim(Copy(NodeTmp.ChildNodes['CEST'].Text+Replicate(' ',7),1,7));
                      except
                      end;
                      Form7.ibDataSet4.Post;
                      //
                    end;
                    //
                    // FCI
                    //
                    if AllTrim(NodeTmp.ChildNodes['nFCI'].Text) <> '' then
                    begin
                      Form7.ibDataSet4.Edit;
                      Form7.ibDataSet4CODIGO_FCI.AsString := AllTrim(NodeTmp.ChildNodes['nFCI'].Text);
                      Form7.ibDataSet4.Edit;
                    end;
                    //
                    Form1.bFlag := False;
                    Form7.sModulo := 'NAO';
                    //
                    Form7.ibDAtaSet23.Append;
                    Form7.ibDataSet23CODIGO.AsString       := Form7.ibDataSet4CODIGO.AsString; // Importar NF
                    Form7.ibDataSet23DESCRICAO.AsString    := Form7.ibDataSet4DESCRICAO.AsString; // NodeTmp.ChildNodes['xProd'].Text;
                    Form7.ibDataSet23QTD_ORIGINAL.AsString := StrTran(NodeTmp.ChildNodes['qCom'].Text,'.',',');
                    Form7.ibDataSet23TOTAL.AsString        := StrTran(NodeTmp.ChildNodes['vProd'].Text,'.',',');
                    //
                    try
                      Form7.ibDataSet23UNITARIO_O.AsString   := StrTran(NodeTmp.ChildNodes['vUnCom'].Text,'.',',');
                    except
                    end;
                    //
                    if (NodeTmp.ChildNodes['cEAN'].Text = '') or (NodeTmp.ChildNodes['cEAN'].Text = 'SEM GTIN')  then
                    begin
                      Form7.ibDataSet23EAN_ORIGINAL.AsString := AllTrim(NodeTmp.ChildNodes['cProd'].Text);
                    end
                    else
                    begin
                      Form7.ibDataSet23EAN_ORIGINAL.AsString := NodeTmp.ChildNodes['cEAN'].Text;
                    end;
                    //
                    Form7.ibDataSet23.Post;
                    Form7.ibDataSet23.Edit;
                    //
                    // Impostos
                    //
                    try
                      //
                      Form7.ibDataSet23BASE.AsFloat       := 0;
                      Form7.ibDataSet23ICM.AsString          := '0';
                      //
                      //
                      // ICM
                      //
                      spICMS   := '0.00';
                      sPRedBC  := '0.00';
                      sICMS    := '0.00';
                      sBC      := '0.00';
                      sBCST    := '0.00';
                      sICMSST  := '0.00';
                      sIPI     := '0.00';
                      spIPI    := '0.00';
                      sCSTIPI  := '';
                      sCSTICMS := '';
                      //
                      // Ver como resolver ester try Quando nao existem os campos
                      //
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS00/CST')) <> '' then
                        sICMSTag := 'ICMS00';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS10/CST')) <> '' then
                      sICMSTag := 'ICMS10';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS20/CST')) <> '' then
                        sICMSTag := 'ICMS20';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS30/CST')) <> '' then
                        sICMSTag := 'ICMS30';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS40/CST')) <> '' then
                        sICMSTag := 'ICMS40';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS51/CST')) <> '' then
                        sICMSTag := 'ICMS51';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS60/CST')) <> '' then
                        sICMSTag := 'ICMS60';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS70/CST')) <> '' then
                        sICMSTag := 'ICMS70';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMS90/CST')) <> '' then
                        sICMSTag := 'ICMS90';
                      //
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMSSN101/CSOSN')) <> '' then
                        sICMSTag := 'ICMSSN101';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMSSN102/CSOSN')) <> '' then
                        sICMSTag := 'ICMSSN102';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMSSN201/CSOSN')) <> '' then
                        sICMSTag := 'ICMSSN201';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMSSN202/CSOSN')) <> '' then
                        sICMSTag := 'ICMSSN202';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMSSN500/CSOSN')) <> '' then
                        sICMSTag := 'ICMSSN500';
                      if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').XML, '//ICMSSN900/CSOSN')) <> '' then
                        sICMSTag := 'ICMSSN900';
                      //
                      if Assigned(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag)) then
                      begin
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//vICMS'))   <> '' then
                          sICMS    := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['vICMS'].Text;
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//vBC'))     <> '' then
                          sBC      := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['vBC'].Text;
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//vICMSST')) <> '' then
                          sICMSST  := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['vICMSST'].Text;
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//vBCST'))   <> '' then
                          sBCST    := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['vBCST'].Text;
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//pICMS'))   <> '' then
                          spICMS   := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['pICMS'].Text;
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//pRedBC'))  <> '' then
                          spREDBC  := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['pRedBC'].Text;
                        if AllTrim(xmlNodeValue(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).XML, '//CST'))     <> '' then
                          sCSTICMS := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['orig'].Text + NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('ICMS').ChildNodes.FindNode(sICMSTag).ChildNodes['CST'].Text;
                      end;
                      //
                      try
                        if Assigned(NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('IPI')) then
                        begin
                          try
                            sIPI    := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('IPI').ChildNodes.FindNode('IPITrib').ChildNodes['vIPI'].Text;
                          except
                          end;
                          try
                            spIPI   := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('IPI').ChildNodes.FindNode('IPITrib').ChildNodes['pIPI'].Text;
                          except
                          end;
                          try
                            sCSTIPI := NodeSec.ChildNodes.FindNode('imposto').ChildNodes.FindNode('IPI').ChildNodes.FindNode('IPITrib').ChildNodes['CST'].Text;
                          except
                          end;
                        end;
                      except
                      end;
                      //
                      //      ShowMessage('vBCST: ' + sBCST + chr(10) +
                      //                  'vICMSST: ' + sICMSST);
                      //

                      // Ver como resolver ester try Quando nao existem os campos
                      //
                      try
                         Form7.ibDataSet23ICM.AsString       := StrTran(spICMS,'.',',');
                      except
                      end;
                      try
                         Form7.ibDataSet23BASE.AsFloat       := 100 - StrToFloat(StrTran(sPRedBC,'.',','));
                      except
                      end;
                      try
                        Form7.ibDataSet23VICMS.AsString     := StrTran(sICMS,'.',',');
                      except
                      end;
                      try
                        Form7.ibDataSet23VBC.AsString       := StrTran(sBC,'.',',');
                      except
                      end;
                      try
                        Form7.ibDataSet23VBCST.AsString     := StrTran(sBCST,'.',',');
                      except
                      end;
                      try
                        Form7.ibDataSet23vICMSST.AsString   := StrTran(sICMSST,'.',',');
                      except
                      end;
                      try
                        Form7.ibDataSet23vIPI.AsString      := StrTran(sIPI,'.',',');
                      except
                      end;
                      //
                      try
                        Form7.ibDataSet23IPI.AsString       := StrTran(spIPI,'.',',');
                      except
                      end;
                      try
                        Form7.ibDataSet23CST_IPI.AsString   := sCSTIPI;
                      except
                      end;
                      try
                        Form7.ibDataSet23CST_ICMS.AsString  := sCSTICMS;
                      except
                      end;
                      try
                        Form7.ibDataSet23CFOP.AsString   := Copy(Form7.ibDataSet14CFOP.AsString,1,1)+Copy(NodeTmp.ChildNodes['CFOP'].Text,2,3);
                      except
                      end;
                      //
                      Form7.ibDataSet23.Post;
                      Form7.ibDataSet23.Edit;
                      //
                    except
                    end;
                    //
                  except end;
                end;
              except
                ShowMessage('Erro ao ler o produto cdigo: '+sCodigoDeBarrasDoFornecedor+chr(10)+chr(10)+
                            'Este item no foi importado. Deve ser digitado manualmente.'+chr(10));

              end;
              //
            end;
            //
            NodeSec := NodeSec.NextSibling; // Next
            NodeTmp.ChildNodes.Clear;
            //
          until NodeSec = nil;
          //
          try Form7.ibDataSet24.Edit; except end;
          //
          try Form7.ibDataSet24NFEID.VAlue          := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('protNFe').ChildNodes.FindNode('infProt').ChildNodes.FindNode('chNFe').Text;  except end;
          try Form7.ibDataSet24ICMSSUBSTI.AsString  := StrTran(Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe').ChildNodes.FindNode('infNFe').ChildNodes.FindNode('total').ChildNodes.FindNode('ICMSTot').ChildNodes.FindNode('vST').Text,'.',','); except end;
          try Form7.ibDataSet24BASESUBSTI.AsString  := StrTran(Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe').ChildNodes.FindNode('infNFe').ChildNodes.FindNode('total').ChildNodes.FindNode('ICMSTot').ChildNodes.FindNode('vBCST').Text,'.',','); except end;
          try Form7.ibDataSet24DESCONTO.AsString    := StrTran(Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe').ChildNodes.FindNode('infNFe').ChildNodes.FindNode('total').ChildNodes.FindNode('ICMSTot').ChildNodes.FindNode('vDesc').Text,'.',','); except end;
          try Form7.ibDataSet24FRETE.AsString       := StrTran(Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe').ChildNodes.FindNode('infNFe').ChildNodes.FindNode('total').ChildNodes.FindNode('ICMSTot').ChildNodes.FindNode('vFrete').Text,'.',','); except end;
          try Form7.ibDataSet24DESPESAS.AsString    := StrTran(Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe').ChildNodes.FindNode('infNFe').ChildNodes.FindNode('total').ChildNodes.FindNode('ICMSTot').ChildNodes.FindNode('vOutro').Text,'.',','); except end;
          try Form7.ibDataSet24SEGURO.AsString      := StrTran(Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe').ChildNodes.FindNode('infNFe').ChildNodes.FindNode('total').ChildNodes.FindNode('ICMSTot').ChildNodes.FindNode('vSeg').Text,'.',','); except end;
          //
          try
            Form7.ibDataSet24NFEXML.AsString := sXML;
          except
            ShowMessage('No foi possvel gravar o XML');
          end;
          //
          try
            Form7.ibDataSet24.Post;
            Form1.bFlag := True;
            Form7.sModulo := 'COMPRA';
            if not (Form7.ibDataset23.State in ([dsEdit, dsInsert])) then
              Form7.ibDataset23.Edit;
            Form7.ibDataSet23DESCRICAOChange(Form7.ibDataSet23DESCRICAO);
          except
            on E: Exception do
            begin
              Application.MessageBox(pChar(E.Message),'Erro 10 importa NF',mb_Ok + MB_ICONWARNING);
            end;
          end;
          //
        end;
        //
      end;
      //
      // Conhecimento de Transporte Eletrnico
      //
      if AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/mod')) = '57' then
      begin
        //
        // CT-e
        //
        //
        Form7.ibDataSet2.Close;
        Form7.ibDataSet2.Selectsql.Clear;
        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR');  //
        Form7.ibDataSet2.Open;
        //
        if not Form7.IBDataSet2.Locate('CGC',ConverteCpfCgc(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/CNPJ'))),[]) then
        begin
          Form7.IBDataSet2.Append;
          Form7.IBDataSet2CGC.AsString    := ConverteCpfCgc(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/CNPJ')));
          Form7.IBDataSet2NOME.AsString   := AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/xNome'));
          Form7.IBDataSet2IE.AsString     := AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/IE'));
          Form7.IBDataSet2ENDERE.AsString := AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/xLgr'))+' '+AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/nro'));
          Form7.IBDataSet2COMPLE.AsString := AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/xBairro'));
          Form7.IBDataSet2CIDADE.AsString := AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/xMun'));
          Form7.IBDataSet2ESTADO.AsString := AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/UF'));
          Form7.IBDataSet2CEP.AsString    := Copy(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/CEP'))+'00000',1,5)+'-'+Copy(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/CEP'))+'00000000',6,3);
          Form7.IBDataSet2FONE.AsString   := '(0xx'+Copy(AllTrim( AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/fone'))  +'         '),1,2)+')'+Copy(AllTrim(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//emit/enderEmit/fone'))+'         '),2,9);
          Form7.IBDataSet2.Post;
          //
        end;
        //
        Form7.ibDataset99.Close;
        Form7.ibDataset99.SelectSql.Clear;
        Form7.ibDataset99.SelectSql.Add('select NUMERONF from COMPRAS where NUMERONF='+QuotedStr( Right(StrZero(StrToFloat(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/nCT')),9,0),9)+StrZero(StrToInt(LimpaNumero('0'+xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/serie'))),3,0) )+' and FORNECEDOR='+QuotedStr(Form7.IBDataSet2NOME.AsString)+' ');
        Form7.IBDataSet99.Open;
        //
        if Form7.ibDAtaSet99.FieldByname('NUMERONF').AsString =Right(StrZero(StrToFloat(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/nCT')),9,0),9)+StrZero(StrToInt(LimpaNumero('0'+xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/serie'))),3,0) then
        begin
          //
          ShowMessage('Nota Fiscal J Cadastrada.');
          Form24.Close;
          Form7.ibDataSet24.Delete;
          //
        end else
        begin
          //
          Form7.ibDataSet24.Edit;
          Form7.ibDataSet24FORNECEDOR.AsString := Form7.IBDataSet2NOME.AsString;
          Form7.ibDataSet24MODELO.AsString     := '57';
          //
          Form24.Label64.Caption := 'Mod: '+Form7.ibDataSet24MODELO.AsString;
          //
          if Form7.IBDataSet2ESTADO.AsString <> Form7.IBDataSet13ESTADO.AsString then
          begin
            if not Form7.ibDataSet14.Locate('CFOP','2'+copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/CFOP'),2,3),[]) then
            begin
              Form7.ibDataSet14.Append;
              Form7.ibDataSet14CFOP.AsString := '2'+copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/CFOP'),2,3);
              Form7.ibDataSet14NOME.AsString := xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/natOp');
              Form7.ibDataSet14.Post;
            end;
          end else
          begin
            if not Form7.ibDataSet14.Locate('CFOP','1'+copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/CFOP'),2,3),[]) then
            begin
              Form7.ibDataSet14.Append;
              Form7.ibDataSet14CFOP.AsString := '1'+copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/CFOP'),2,3);
              Form7.ibDataSet14NOME.AsString := xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/natOp');
              Form7.ibDataSet14.Post;
            end;
          end;
          //
          Form7.ibDataSet24OPERACAO.AsString    := Form7.ibDataSet14NOME.AsString;
          Form7.ibDataSet24NUMERONF.AsString := Right(StrZero(StrToFloat(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/nCT')),9,0),9)+StrZero(StrToInt(LimpaNumero('0'+xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/serie'))),3,0);
          Form24.Edit2.Text := Right(StrZero(StrToFloat(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/nCT')),9,0),9)+'/'+StrZero(StrToInt(LimpaNumero('0'+xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/serie'))),3,0);
          Form24.Edit2.Repaint;
          //
          Form7.ibDataSet24SAIDAD.AsString := Copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/dhEmi'),9,2)+'/'+Copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/dhEmi'),6,2)+'/'+Copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/dhEmi'),1,4); // Data da saida
          Form7.ibDataSet24SAIDAH.AsString := Copy(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/CTe/infCte/ide/dhEmi'),12,8);// Hora da sada
          Form7.ibDataSet24NFEID.AsString  := xmlNodeValue(Form7.XMLDocument1.XML.Text,'//cteProc/protCTe/infProt/chCTe'); // COVID19
          //
          Form1.bFlag := False;
          Form7.sModulo := 'NAO';
          //
          if not Form7.ibDataSet4.Locate('DESCRICAO','Frete',[]) then
          begin
            Form7.ibDataSet4.Append;  // Inclui um produto chamado FRETE
            Form7.ibDataSet4.Edit;
            Form7.ibDataSet4DESCRICAO.AsString := 'Frete';
            Form7.ibDataSet4.Post;
          end;
          //
          try
            Form7.ibDAtaSet23.Append;
            Form7.ibDataSet23CODIGO.AsString     := Form7.ibDataSet4CODIGO.AsString; // Importar NF
            Form7.ibDataSet23DESCRICAO.AsString  := Form7.ibDataSet4DESCRICAO.AsString;
            Form7.ibDataSet23QUANTIDADE.AsString := '1';
          except
          end;
          //
          try
            Form7.ibDataSet23UNITARIO_O.AsString :=  StrTran(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//imp/ICMS/ICMS00/vBC')),'.',',');
            Form7.ibDataSet23ICM.AsString        :=  StrTran(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//imp/ICMS/ICMS00/pICMS')),'.',',');
            Form7.ibDataSet23VICMS.AsString      :=  StrTran(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//imp/ICMS/ICMS00/vICMS')),'.',',');
            Form7.ibDataSet23vBC.AsString        :=  StrTran(AllTrim(xmlNodeValue(Form7.XMLDocument1.XML.Text,'//imp/ICMS/ICMS00/vBC')),'.',',');
          except
          end;
          //
          try
            Form7.ibDataSet23.Post;
            Form7.ibDataSet23.Edit;
          except
            on E: Exception do
            begin
              Application.MessageBox(pChar(E.Message),'Erro 11 importa NF',mb_Ok + MB_ICONWARNING);
            end;
          end;
          //
        end;
        //
      end;
      //
    except
      on E: Exception do
      begin
        Application.MessageBox(pChar(E.Message),'Estrutura do arquivo XML da NF-e invlida.',mb_Ok + MB_ICONWARNING);
      end;
    end;
    //
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message),'Erro ao importar XML da NF-e',mb_Ok + MB_ICONWARNING);
    end;
  end;
  //
  try
    //
    Form1.bFlag := True;
    Form7.sModulo := 'COMPRA';
    //
    DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
    //
  except end;
  //
  try
    Form7.ibDataset2.EnableControls
  except
  end;
  try
    Form7.ibDataset23.EnableControls
  except
  end;
  try
    Form7.ibDataset24.EnableControls
  except
  end;
  try
    Form7.ibDataset4.EnableControls
  except
  end;
  //
  //
  Screen.Cursor            := crDefault;
  //
  // ShowMessage('Tempo: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0)+chr(10));
  //
  // Fim
  //
end;

function EnviarEMail(sDe, sPara, sCC, sAssunto, sTexto, sAnexo: string; bConfirma: Boolean): Integer;
var
{
  RetVal : Integer;
}
  Mais1Ini : tIniFile;
  sAtual : String;
  Msg: TMapiMessage;
  lpSender, lpRecepient, lpComCopia: TMapiRecipDesc;
  FileAttach: TMapiFileDesc;
  SM: TFNMapiSendMail;
  MAPIModule: HModule;
  Flags: Cardinal;
  //
begin
  //
  GetDir(0,sAtual);
  //
  Mais1ini := TIniFile.Create('frente.ini');
  //
  if FileExists(pChar('mail.exe')) and (Mais1Ini.ReadString('mail','Host','') <> '') then
  begin
    //
    while FileExists(pChar('email.exe')) do
    begin
      DeleteFile(pChar(Form1.sAtual+'\email.exe'));
      sleep(10);
    end;
    //
    while not FileExists(pChar('email.exe')) do
    begin
      CopyFile(pChar(Form1.sAtual+'\mail.exe'), pChar(Form1.sAtual+'\email.exe'),True);
      sleep(10);
    end;
    //
    ShellExecute( 0, 'Open', pChar(Form1.sAtual+'\email.exe') , pChar(sPara+' '+'"'+sAssunto+'"'+' '+'"'+sTexto+'"'+' '+'"'+sAnexo+'"'), '', SW_SHOW);
    //
    Result := 1;
    //
  end else
  begin
    //
    {
    RetVal := ShellExecute(0, 'open', PChar(
  'mailto:'+sPara+
  '?subject='+sAssunto+
  '&body='+sTexto+
  '&Attach='+sAnexo
    ), nil, nil, SW_SHOWNORMAL);
    //
    if RetVal <= 32 then MessageDlg('No foi possvel mandar o e-mail.', mtWarning, [mbOK], 0);
    }
    //
    //
    // cria propriedades da mensagem
    //
    FillChar(Msg, SizeOf(Msg), 0);
    //
    with Msg do
    begin
      if (sAssunto <> '') then lpszSubject := PChar(sAssunto);
      if (sTexto <> '')   then lpszNoteText := PChar(sTexto); //Corpo da Mensagem
      //
      // remetente
      //
      if (sDe <> '') then
      begin
        lpSender.ulRecipClass := MAPI_ORIG;
        lpSender.lpszName := PChar(sDe);
        lpSender.lpszAddress := PChar(sDe);
        lpSender.ulReserved := 0;
        lpSender.ulEIDSize := 0;
        lpSender.lpEntryID := nil;
        lpOriginator := @lpSender;
      end;
      //
      // destinatrio
      //
      if (sPara <> '') then
      begin
        //
        if not bConfirma then
        begin
          sPara := StrTran(StrTran(sPara,';','><'),' ','');
          sPara := StrTran(sPara,'><','>;<');
        end;
        //
        lpRecepient.ulRecipClass := MAPI_TO;
        lpRecepient.lpszName := PChar('');
        lpRecepient.lpszAddress := PChar(sPara);
        lpRecepient.ulReserved := 0;
        lpRecepient.ulEIDSize := 0;
        lpRecepient.lpEntryID := nil;
        nRecipCount := 1;
        lpRecips := @lpRecepient;
        //
      end else
      begin
        //
        if (sCC <> '') then
        begin
          lpComCopia.ulRecipClass := MAPI_CC;
          lpComCopia.lpszName     := PChar(sCC);
          lpComCopia.lpszAddress  := PChar(sCC);
          lpComCopia.ulReserved   := 0;
          lpComCopia.ulEIDSize    := 0;
          lpComCopia.lpEntryID    := nil;
          nRecipCount             := 1;
          lpRecips                := @lpComCopia;
        end else
        begin
          lpRecips := nil;
        end;
      end;
      // arquivo anexo
      if (sAnexo = '') then
      begin
        nFileCount := 0;
        lpFiles := nil;
      end else
      begin
        //
        FillChar(FileAttach, SizeOf(FileAttach), 0);
        //
        FileAttach.nPosition    := Cardinal($FFFFFFFF);
        FileAttach.lpFileType   := nil;
        FileAttach.lpszPathName := PChar(sAnexo);
        nFileCount              := 1;
        lpFiles                 := @FileAttach;
        //
      end;
      //
      // carrega dll e o mtodo sPara envio do email
      //
      MAPIModule := LoadLibrary(PChar(MAPIDLL));
  //    MAPIModule.
      if MAPIModule = 0 then
      begin
        Result := -1
      end else
      begin
        try
          //
  //        Flags := MAPI_AB_NOMODIFY;
  //        Flags := MAPI_USE_DEFAULT;
  //        Flags := MAPI_ENVELOPE_ONLY;

          if bConfirma then
          begin
            Flags := MAPI_DIALOG or MAPI_LOGON_UI;
          end else
          begin
            Flags := 0;
          end;
          //
          @SM := GetProcAddress(MAPIModule, 'MAPISendMail');
          if @SM <> nil then
          begin
            Result := SM(0, Application.Handle, Msg, Flags, 0);
          end else
          begin
            Result := 1;
          end;
        finally
          FreeLibrary(MAPIModule);
        end;
        //
      end;
    end;
    //
  end;
  //
  Mais1Ini.Free;
  //
  CHDir(sAtual);
  //
end;

function CriaJpg(sP1: String) :Boolean;
var
  jp: TJPEGImage;  //Requires the "jpeg" unit added to "uses" clause.
begin
  //
  if FileExists(Form1.sAtual+'\LOGOTIP.BMP') then
    Form14.Image1.Picture.LoadFromFile('LOGOTIP.BMP')
  else
    Form14.Image1.Picture := Form1.Image1.Picture;
  //
  try
    jp := TJPEGImage.Create;
    jp.Assign(Form14.Image1.Picture.Bitmap);
    jp.CompressionQuality := 100;
    jp.SaveToFile('logotip.jpg');
  except end;
  //
  Result := True;
  //
end;

function MostraLabels(tSp1: tImage; tSp2: TLabel): Boolean;
begin
  //
  if Form19.CheckBox8.Checked then
  begin
    with Form1 do
    begin
      tSp2.OnClick     := tSp1.OnClick;
      tSp2.Width       := tSp1.Width;
      tSp2.Top         := -5; // tSp1.Top; // + tSp1.Height -20;
      tSp2.Left        := tSp1.Left;
      //
      //
      // if Form1.sContrasteCor = 'BRANCO' then tSp2.Font.Color := clWhite;
      // if Form1.sContrasteCor = 'PRETO' then tSp2.Font.Color := clBlack;
      // if Form1.sContrasteCor = 'ROSA' then tSp2.Font.Color := clFuchsia;
      // if Form1.sContrasteCor = 'AZUL' then tSp2.Font.Color := clBlack;
      //
      // tSp2.Font.Color := $00F5CB58;
      tSp2.Font.Color := clBlack;
      //
      tSp2.visible     := True;
      tsP2.Repaint;
    end;
  end else
  begin
    with Form1 do
    begin
      tSp2.visible     := False;
    end;
  end;
  //
  Result := True;
  //
end;


function JaTem(p1:tibDataSet; p2:tField; p3: boolean):Boolean;
var
  sReg1, sReg2 : String;
  sDescricao : String;
begin
  //
  Result := False;
  //
  with Form7 do
  begin
    //
    if (AllTrim(p2.AsString) = AllTrim(ibDataSet4DESCRICAO.ASString)) and (Form7.ibDataSet4.FieldByname('SERIE').Value <> 1) then
    begin
      //
      p1.DisableControls;
      sDescricao := p2.AsString;
      //
      sReg1 := p1.FieldByname('REGISTRO').AsString;
      p1.First;
      //
      while not p1.EOF do
      begin
        //
        if (AllTrim(p2.AsString) = AllTrim(sDescricao)) and (sReg1 <> p1.FieldByname('REGISTRO').AsString) then
        begin
          //
          sREg2 := p1.FieldByname('REGISTRO').AsString;
          //
          if p3 then
          begin
            p1.Locate('REGISTRO',sREg1,[]);
            p1.Delete;
            sREg1 := sREg2;
            p1.EnableControls;
            ShowMessage('Este item j est relacionado.');
          end;
          Result := True;
        end;
        p1.Next;
      end;
      //
      p1.Locate('REGISTRO',sREg1,[]);
      p1.EnableControls;
      if Form12.dbGrid1.CanFocus then
      begin
        if Form12.Visible then
          Form12.dbGrid1.SetFocus;
      end;
      if Form24.dbGrid1.CanFocus then
      begin
        if Form24.Visible then
          Form24.dbGrid1.SetFocus;
      end;
      //
      if p1.MoveBy(+1) = 1 then
        p1.MoveBy(-1)
      else if p1.MoveBy(-1) = -1 then
        p1.MoveBy(+1);
      //
    end;
  end;
  //
end;

function Totalizaservicos(sP1: Boolean):Boolean;
begin
  //
  // Servicos
  //
  // ShowMessage('Teste: '+Form7.sModulo );
  //
  if Form7.sModulo = 'VENDA' then
  begin
    //
    if (Form7.ibDataSet15NUMERONF.AsString = Form7.ibDataSet35NUMERONF.AsString) then //  Sandro Silva 2022-09-26
    begin
      // Totalizaservicos()  executando em vrios OnChange de campos do DataSet da tabela VENDAS.
      // Precisa validar VENDAS.NUMERONF = ITENS003.NUMERONF para no calcular ISS do primeiro item da nota anterior

      if AllTrim(Form7.ibDataSet35DESCRICAO.AsString) <> '' then
      begin
        //
        Form7.sModulo := 'No';
        //
        if Form7.sRPS = 'S' then
        begin
          Form7.ibQuery1.Close;
          Form7.ibQuery1.Sql.Clear;
          Form7.ibQuery1.Sql.Add('select ISS, BASEISS from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString));
          Form7.ibQuery1.Open;
        end else
        begin
          Form7.ibQuery1.Close;
          Form7.ibQuery1.Sql.Clear;
          Form7.ibQuery1.Sql.Add('select ISS, BASEISS from ICM where Coalesce(ISS,0)<>0 and Coalesce(BASEISS,0)<>0');
          Form7.ibQuery1.Open;
        end;
        //
        Form7.ibQuery3.Close;
        Form7.ibQuery3.Sql.Clear;
        Form7.ibQuery3.Sql.Add('select sum(ISS) as TOTALISS, sum(TOTAL) as SERVICOS from ITENS003 where NUMERONF='+QuotedStr(Form7.ibDataSet15NUMERONF.AsString)+'');
        Form7.ibQuery3.Open;
        //
        Form7.ibDataSet15.Edit;
        Form7.ibDataSet15SERVICOS.AsFloat := Form7.IBQuery3.FieldByname('SERVICOS').AsFloat;
        //
        // Abate o Desconto no ISS
        //
        //Ficha 6253
        {Sandro Silva 2022-09-21 inicio
        Form7.ibDataSet15ISS.AsFloat      := Form7.IBQuery3.FieldByname('TOTALISS').AsFloat - (Form7.ibDataSet15DESCONTO.AsFloat * Form7.ibDataSet14ISS.AsFloat / 100);
        Form7.ibDataSet35.Edit;
        //
        Form7.ibDataSet35ISS.AsFloat      := Form7.ibDataSet35TOTAL.AsFloat * Form7.ibQuery1.FieldByname('ISS').AsFloat / 100 * Form7.ibQuery1.FieldByname('BASEISS').AsFloat / 100;
        }
        Form7.ibDataSet15ISS.AsFloat      := Form7.IBQuery3.FieldByname('TOTALISS').AsFloat - (Form7.ibDataSet15DESCONTO.AsFloat * Form7.ibDataSet14ISS.AsFloat / 100);
        Form7.ibDataSet35.Edit;
        //
        Form7.ibDataSet35ISS.AsFloat      := Form7.Formata2CasasDecimais(Form7.ibDataSet35TOTAL.AsFloat * Form7.ibQuery1.FieldByname('ISS').AsFloat / 100 * Form7.ibQuery1.FieldByname('BASEISS').AsFloat / 100);
        Form7.ibDataSet35BASEISS.AsFloat  := Form7.Formata2CasasDecimais(Form7.ibDataSet35TOTAL.AsFloat * Form7.ibQuery1.FieldByname('BASEISS').AsFloat / 100);
        {Sandro Silva 2022-09-21 fim}
        //
        Form7.sModulo := 'VENDA';
        //
      end;
      
    end;
    //
  end;
  //
  Result := True;
  //
end;


function TotalizaOS(sP1: Boolean):Boolean;
var
  MyBookMark, MyBookMark1 : TBookMark;
begin
  //
  Form7.ibDataSet3.Edit;
  //
  // Produtos
  //
  MyBookMark := Form7.ibDataSet16.GetBookMark();
  Form7.ibDataSet16.DisableControls;
  Form7.ibDataSet16.First;
  Form7.ibDataSet3TOTAL_PECA.AsFloat := 0;
  while not Form7.ibDataSet16.Eof do // disable
  begin
    Form7.ibDataSet3TOTAL_PECA.AsFloat := Form7.ibDataSet3TOTAL_PECA.AsFloat + Form7.ibDataSet16TOTAL.AsFloat;
    Form7.ibDataSet16.Next;
  end;
  //
  Form7.ibDataSet16.GotoBookmark(MyBookMark);
  if Form7.sModulo <> 'RETRIBUTA' then Form7.ibDataSet16.EnableControls;
  Form7.ibDataSet16.Edit;
  //
  // Servicos
  //
  MyBookMark1 := Form7.ibDataSet35.GetBookMark();
  Form7.ibDataSet35.DisableControls;
  Form7.ibDataSet35.First;
  Form7.ibDataSet3TOTAL_SERV.AsFloat := 0;
  while not Form7.ibDataSet35.Eof do
  begin
    Form7.ibDataSet3TOTAL_SERV.AsFloat := Form7.ibDataSet3TOTAL_SERV.AsFloat + Form7.ibDataSet35TOTAL.AsFloat;
    Form7.ibDataSet35.Next;
  end;
  //
  Form7.ibDataSet35.GotoBookmark(MyBookMark1);
  Form7.ibDataSet35.EnableControls;
  Form7.ibDataSet35.Edit;
  //
  Form7.ibDataSet3TOTAL_OS.AsFloat := Form7.ibDataSet3TOTAL_FRET.AsFloat + Form7.ibDataSet3TOTAL_SERV.AsFloat + Form7.ibDataSet3TOTAL_PECA.AsFloat - Form7.ibDataSet3DESCONTO.AsFloat;
  //
  Result := True;
  //
end;

function ValidaEmail(sP1: String):Boolean;
var
  I : Integer;
begin
  Result := False;
  if (Pos('@',sP1)<>0) then Result := True;
  if (Pos('@.',sP1)<>0) or
     (Pos('.@',sP1)<>0) or
     (Pos('..',sP1)<>0) then
  begin
    Result := False;
  end;
  //
  for I := 1 to 57 do
  begin
    if Pos(Copy(' "!#$%*()+=^]}{,|?*',I,1),AllTrim(sP1)) <> 0 then
    begin
      Result := False;
    end;
  end;
  //
end;

function Valida_Campo(Arquivo: String; Text: String;
  Indice, Mensagem: String): Boolean;
begin
  //
  try
    //
    Form7.ibDataSet100.Close;
    Form7.ibDataSet100.SelectSQL.Clear;
    Form7.ibDataSet100.SelectSQL.Add('select * from '+Arquivo+' where '+Indice+'= '+QuotedStr(TExt)+'');
    //
    Form7.ibDataSet100.Open;
    //
    if Form7.ibDataSet100.FieldByname(Indice).AsString = Text then
    begin
      if Indice <> 'CEP' then
      begin
        if Mensagem <> '' then ShowMessage(Mensagem);
      end else
      begin
        try
          if Alltrim(Form7.ibDataSet2CIDADE.AsString) = '' then
            Form7.ibDataSet2CIDADE.AsString := Form7.ibDataSet100.FieldByname('CIDADE').AsString;
          if Alltrim(Form7.ibDataSet2ESTADO.AsString) = '' then
            Form7.ibDataSet2ESTADO.AsString := Form7.ibDataSet100.FieldByname('ESTADO').AsString;
          if Alltrim(Form7.ibDataSet2COMPLE.AsString) = '' then
          begin
            if Copy(Form7.ibDataSet100.FieldByname('CEP').AsString,7,3) <> '000' then
              Form7.ibDataSet2COMPLE.AsString := Form7.ibDataSet100.FieldByname('COMPLE').AsString;
          end;
        except
        end;
      end;
      Result := False;
    end else
    begin

      Result := True;
    end;
  except
    Result := False;
  end;
  //
  //
end;

{                                   }
{ Joga p/obs a obs na tabela de icm }
{                                   }
function ObservacaoProduto(pP1:Boolean):Boolean;
begin
  //
  // Relacionado ao produto
  //
  if (Copy(Form7.ibDataSet14OBS.AsString,1,24) <> 'PERMITE O APROVEITAMENTO') and  (Copy(Form7.ibDataSet14OBS.AsString,1,24) <> 'DEVOLUCAO DA NF-e')  then
  begin
    try
      if Form7.IBQuery14.Active then
      begin
        if Pos(Alltrim(LimpaLetras(Form7.ibQuery14.FieldByname('OBS').AsString)),LimpaLetras(Form7.ibDataSet15COMPLEMENTO.AsString)) = 0 then
        begin
          Form7.ibDataSet15COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString) + ' ' + Form7.ibQuery14.FieldByname('OBS').AsString; // Nunca limpa s vai acrescentando OK
        end;
      end
    except
    end;
  end;
  //
  Result := True;
  //
end;

function ObservacaoOperacao(pP1:Boolean):Boolean;
var
  sRef : String;
begin
  //
  // Relacionado a operacao
  //
  try
    //
    if Form7.ibDataSet15FINNFE.AsString <> '4' then // Devolucao Devoluo No deve mudar
    begin
      //
      if pP1 then
      begin
        //
        // Quando o parametro pP1 e true se nao contem limpa tudo e poe
        //
        if (Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO') then
        begin
          if (Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,24) <> 'PERMITE O APROVEITAMENTO') then
          begin
            Form7.ibDataSet15COMPLEMENTO.AsString := '   ';
            Form12.sObservacaoAntiga := '   ';
          end;
        end else
        begin
          if Pos(Alltrim(Form7.ibDataSet14OBS.AsString),Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
          begin
            //
            sRef := '';
            if Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,30) = 'NF REFERENTE AO CUPOM FISCAL: ' then
              sRef := Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,36+11);
            if Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,19) = 'NF REFERENTE A OS: ' then
              sRef := Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,29);
            if Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,27) = 'NF REFERENTE AO ORAMENTO: ' then
              sRef := Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,33);
            //
            Form7.ibDataSet15COMPLEMENTO.AsString := sRef + AllTrim(Form7.ibDataSet14OBS.AsString);
            //
            Form12.sObservacaoAntiga := Form7.ibDataSet14OBS.AsString;
            //
          end;
        end;
      end else
      begin
        //
        if (Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO') then
        begin
          if (Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,24) <> 'PERMITE O APROVEITAMENTO') then
          begin
            Form7.ibDataSet15COMPLEMENTO.AsString := '   ';
            Form12.sObservacaoAntiga := '   ';
          end;
        end else
        begin
          //
          if Pos(AllTrim(Form7.ibDataSet14OBS.AsString),Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
          begin
            //
            if (Pos( LimpaLEtras(Form12.sObservacaoAntiga), LimpaLetras(Form7.ibDataSet15COMPLEMENTO.AsString) ) <> 0) and (Pos( AllTrim(Form12.sObservacaoAntiga), Form7.ibDataSet15COMPLEMENTO.AsString ) = 0) then
            begin
              if AllTrim(Form12.sObservacaoAntiga) <> AllTrim(Form7.ibDataSet14OBS.AsString) then
              begin
                Form7.ibDataSet15COMPLEMENTO.AsString := '';
              end;
            end;
            //
            if (Pos( LimpaLEtras(AllTrim(Form7.ibDataSet14OBS.AsString)), LimpaLetras(AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString)) ) = 0) then
            begin
              if (Pos(AllTrim(Form12.sObservacaoAntiga), Form7.ibDataSet15COMPLEMENTO.AsString) = 0) then
              begin
                Form7.ibDataSet15COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet14OBS.AsString) + ' ' + Form7.ibDataSet15COMPLEMENTO.AsString;
              end else
              begin
                if Pos(AllTrim(Form12.sObservacaoAntiga), AllTrim(Form7.ibDataSet14OBS.AsString)) = 0 then
    //            if AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString) <> alltrim(Form12.sObservacaoAntiga) then
                begin
                  Form7.ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,AllTrim(Form12.sObservacaoAntiga), AllTrim(Form7.ibDataSet14OBS.AsString));
                end else
                begin
                  Form7.ibDataSet15COMPLEMENTO.AsString := StringReplace(Form7.ibDataSet15COMPLEMENTO.AsString,AllTrim(Form12.sObservacaoAntiga),AllTrim(Form7.ibDataSet14OBS.AsString),[rfIgnoreCase]);
    //              Form7.ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,AllTrim(Form12.sObservacaoAntiga), '');
    //              Form7.ibDataSet15COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet14OBS.AsString);
                end;
              end;
            end;
            //
            Form12.sObservacaoAntiga := AllTrim(Form7.ibDataSet14OBS.AsString);
            //
          end;
        end;
      end;
    end;
  except
  end;
  //
  // Ok
  //
  if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) = 'URB' then
  begin
    //
    // Teste do PAF-ECF quando importa um cupom para NF
    //
    if Pos( StrTran(ParamStr(1),'URB','') ,Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
    begin
      Form7.ibDataSet15COMPLEMENTO.AsString := 'MD-5: '+(StrTran(ParamStr(1),'URB',''))+ ' ' + AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString);
      Form12.DBMemo1.ReadOnly := True;
    end;
  end;
  //
  Result := True;
  //
end;     

function Observacao2(pP1:Boolean):Boolean;
begin
  //
  if (pP1) then
  begin
    //
    Form7.ibDataSet24.Edit;
    Form7.ibDataSet24COMPLEMENTO.AsString := Form7.ibDataSet14OBS.AsString;
    //
  end else
  begin
    //
    if Pos(Alltrim(Form7.ibDataSet14OBS.AsString),Form7.ibDataSet24COMPLEMENTO.AsString) = 0 then
    begin
      Form7.ibDataSet24.Edit;
      Form7.ibDataSet24COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet24COMPLEMENTO.AsString) + ' ' + Form7.ibDataSet14OBS.AsString;
    end;
    //
  end;
  //
  if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) = 'URB' then
  begin
    //
    // Teste do PAF-ECF quando importa um cupom para NF
    //
    if Pos( StrTran(ParamStr(1),'URB','') ,Form7.ibDataSet24COMPLEMENTO.AsString) = 0 then
    begin
      Form7.ibDataSet24COMPLEMENTO.AsString := 'MD-5: '+(StrTran(ParamStr(1),'URB',''))+ ' ' + AllTrim(Form7.ibDataSet24COMPLEMENTO.AsString);
    end;
  end;
  //
  Result := True;
  //
end;
//  

procedure TForm7.Sair1Click(Sender: TObject);
begin
  Close;
  Form7.sModulo := '';
end;

procedure TForm7.IntegraBanco(Sender: TField);
begin
  if ibDataSet1.Modified then
    ibDataSet1.Post;
  //
  // Estorno
  //
  if (AllTrim(ibDataSet1CONTA.AsString) <> '') then
  begin
    ibDataSet12.Locate('NOME',Alltrim(ibDataSet1NOME.AsString),[loPartialKey]);
    if ibDataSet11.Locate('PLANO',AllTrim(ibDataSet12CONTA.AsString),[loPartialKey]) then
    begin
      ibDataSet5.Close;
      ibDataSet5.SelectSQL.Clear;
      ibDataSet5.SelectSQL.Add('select * FROM MOVIMENT where NOME=' + QuotedStr(Form1.sEscolhido) + 'and EMISSAO = '+QuotedStr(DateToStrInvertida(ibDataSet1DATA.AsDateTime))+' order by COMPENS');
      ibDataSet5.Open;
      while not ibDataSet5.Eof do
      begin
        if (ibDataSet5HISTORICO.AsString = ibDataSet1HISTORICO.AsString) then
        begin
          if (ibDataSet1SAIDA.AsFloat <> ibDataSet5ENTRADA_.AsFloat) or (ibDataSet1ENTRADA.AsFloat <> ibDataSet5SAIDA_.AsFloat) then
          begin
            ibDataSet5.Delete;
            ibDataSet5.Last;
            ibDataSet1.Edit;
            ibDataSet1CONTA.AsString := '';
          end;
        end;
        ibDataSet5.Next;
      end;
    end;
  end;
  //
  // Lanamento
  //
  if (AllTrim(ibDataSet1CONTA.AsString) = '') and (AllTrim(ibDataSet1NOME.AsString) <> '') then
  begin
    if ibDataSet1ENTRADA.AsFloat + ibDataSet1SAIDA.AsFloat <> 0 then
    begin
      ibDataSet12.Locate('NOME',Alltrim(ibDataSet1NOME.AsString),[loPartialKey]);
      if ibDataSet11.Locate('PLANO',AllTrim(ibDataSet12CONTA.AsString),[loPartialKey]) then
      begin
        //
        Form1.sEscolhido := ibDataSet11NOME.AsString;
        ibDataSet5.Close;
        ibDataSet5.SelectSQL.Clear;
        ibDataSet5.SelectSQL.Add('select * FROM MOVIMENT where NOME=' + QuotedStr(ibDataSet11NOME.AsString) + ' order by COMPENS');
        ibDataSet5.Open;
        ibDataSet5.Append;
        ibDataSet5HISTORICO.AsString := ibDataSet1HISTORICO.AsString;
        ibDataSet5EMISSAO.AsDateTime := ibDataSet1DATA.AsDateTime;
        ibDataSet5ENTRADA_.AsFloat   := ibDataSet1SAIDA.AsFloat;
        ibDataSet5SAIDA_.AsFloat     := ibDataSet1ENTRADA.AsFloat;
        ibDataSet5.Post;
        //
        ibDataSet1.Edit;
        ibDataSet1CONTA.AsString := ibDataSet12CONTA.AsString;
        ibDataSet1.Post;
        //
      end;
    end;
  end;
end;

procedure TForm7.CalculaSAldo(Sender: Boolean);
var
  sW : String;
  SaldoAnterior : Real;
  I : Integer;
begin
  //
  sW      := '';
  //
  if not bNaoCalculaSaldo then
  begin
    //
    for I := 1 to 9999999 do
      Form7.fSaldoVetorCaixa[I] := 0;
      
    SaldoAnterior  := 0;
    Form7.ibDataSet1.DisableControls;
    sRegistro := Form7.ibDataSet1REGISTRO.AsString;
    //
    if ibDataSet1.Modified then
      ibDataSet1.Post;
    //
    if (Pos('where',ibDataSet1.SelectSQL.Text) <> 0) or (Pos('skip',ibDataSet1.SelectSQL.Text) <> 0) then
    begin
      sW := ibDataSet1.SelectSQL.Text;
      ibDataSet1.Close;
      ibDataSet1.SelectSQL.Clear;
      ibDataSet1.SelectSQL.Add('select * from CAIXA order by DATA, REGISTRO');
      ibDataset1.Open;
      Sender := True;
    end;
    //
    // if Sender then
    //
    Form7.ibDataSet1.First;
    while not Form7.ibDataSet1.Eof do
    begin
      SaldoAnterior := SaldoAnterior + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
      try
        Form7.fSaldoVetorCaixa[Form7.ibDataSet1REGISTRO.AsInteger] := SaldoAnterior;
      except
      end;
      Form7.ibDataSet1.Next;
    end;
    //
    if sW <> '' then
    begin
      ibDataSet1.Close;
      ibDataSet1.SelectSQL.Clear;
      ibDataSet1.SelectSQL.Add(sW);
      ibDataset1.Open;
    end;
    //
    if Sender then
      Form7.ibDataSet1.Locate('REGISTRO',sRegistro,[]);
    Form7.ibDataSet1.EnableControls;
    //
  end;
  //
end;

procedure TForm7.SaldoBanco(Sender: Boolean);
var
  sW: String;
  SaldoAnterior: Real;
  sRegistroS: String;
begin
  //
  Screen.Cursor            := crHourGlass;
  //
  sW      := '';
  //
  if not Form7.ibDataSet5.Active then
    Form7.ibDataSet5.Active := True;
  if not Form7.ibDataSet11.Active then
    Form7.ibDataSet11.Active := True;
  //
  if not bNaoCalculaSaldo and (Pos(' and ',ibDataSet5.SelectSQL.Text)=0) then
  begin
    SaldoAnterior  := 0;
    Form7.ibDataSet5.DisableControls;
    sRegistroS     := Form7.ibDataSet5.FieldByName('REGISTRO').AsString;
    //
    if Pos(' and ',ibDataSet5.SelectSQL.Text) <> 0 then
    begin
      sW := ibDataSet5.SelectSQL.Text;
      ibDataSet5.Close;
      ibDataSet5.SelectSQL.Clear;
      ibDataSet5.SelectSQL.Add('select * FROM MOVIMENT where NOME=' + QuotedStr(ibDataSet11NOME.AsString) + ' order by COMPENS');
      ibDataset5.Open;
    end;
    //
    Form7.ibDataSet5.First;
    while (not Form7.ibDataSet5.Eof) do
    begin
      if (AllTrim(Form7.ibDataSet5.FieldByName('COMPENS').AsString)<>'') then
      begin
        SaldoAnterior := SaldoAnterior + Form7.ibDataSet5.FieldByName('ENTRADA_').AsFloat - Form7.ibDataSet5.FieldByName('SAIDA_').AsFloat;
        Form7.fSaldoVetorBanco[Form7.ibDataSet5.FieldByName('REGISTRO').AsInteger] := SaldoAnterior;
      end;
      Form7.ibDataSet5.Next;
    end;
    //
    Form7.ibDataSet11.Locate('NOME',ibDataSet5NOME.AsString,[]);
    Form7.ibDataSet11.Edit;
    Form7.ibDataSet11SALDO3.AsFloat := SaldoAnterior;
    Form7.ibDataSet11.Post;
    //
    if sW <> '' then
    begin
      ibDataSet5.Close;
      ibDataSet5.SelectSQL.Clear;
      ibDataSet5.SelectSQL.Add(sW);
      ibDataset5.Open;
    end;
    //
    Form7.ibDataSet5.Locate('REGISTRO',sRegistroS,[]);
    Form7.ibDataSet5.EnableControls;
    //
  end;
  //
//  if Pos(' and ',ibDataSet5.SelectSQL.Text)<>0 then ibDataSet5SALDO_BANC.Visible := False else ibDataSet5SALDO_BANC.Visible := True;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.Image102Click(Sender: TObject);
begin
  if (sModulo <> 'OS') then Form21.Show;
end;

procedure TForm7.Image103Click(Sender: TObject);
begin
  Form20.ShowModal;
end;

procedure TForm7.Image106Click(Sender: TObject);
begin
  //
  //
  //
  if sModulo = 'OS' then
  begin
    Form30.Show;
  end else
  begin
    if sModulo = 'VENDA' then
    begin
      //
      if Form7.sRPS = 'S' then
      begin
         if (Form7.ibDataSet15EMITIDA.AsString <> 'X') and (Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString)=0) then
           Form48.Show;
      end
      else
      begin
        if not DenegadoOuCancelado(True) then
        begin
          if (Form7.ibDataSet15EMITIDA.AsString <> 'X') and (alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') and (Form7.ibDataSet15EMITIDA.AsString <> 'E') then
            Form12.Show;
        end;
      end;
      //
    end
    else
    begin
      if sModulo = 'COMPRA' then
      begin
        Form24.Show;
      end
      else
      begin
        if sModulo = 'ORCAMENTO' then
        begin
          //
          ShellExecute( 0, 'Open', 'orca.exe', '', '', SW_SHOW);
          sleep(1000);
          //
          while ConsultaProcesso('orca.exe') or ConsultaProcesso('ORCA.EXE') do
          begin
            Form7.Caption := 'Aguarde o fechamento do programa de orcamentos...';
            Application.ProcessMessages;
            sleep(100);
          end;
          //
          Form7.Caption := '';
          //
          AgendaCommit(True);
          Form7.Close;
          Form7.Show;
          //
          Form7.ibDataSet97.EnableControls;
          //
          Abort;
          //
        end else
        begin
          //
          Form7.IBTransaction1.CommitRetaining;
          VerificaSeEstaSendoUsado(False);
          Form10.Show;
          //
        end;
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet5NewRecord(DataSet: TDataset);
begin
  //
  ibDataSet5.Edit;
  ibDataSet5REGISTRO.AsString  := sProximo;
  ibDataSet5NOME.AsString      := Form1.sEscolhido;
  //
  ibDataSet5EMISSAO.Value      := Date;
  ibDataSet5PREDATA.Value      := Date;
  //
  bNaoCalculaSaldo             := True;
  ibDataSet5SAIDA_.Value       := 0;
  ibDataSet5ENTRADA_.Value     := 0;
  bNaoCalculaSaldo             := False;
  //
end;

procedure TForm7.ibDataSet1NewRecord(DataSet: TDataset);
begin
  //
  ibDataSet1.Edit;
  //
  ibDataSet1REGISTRO.AsString  := sProximo;
  bNaoCalculaSaldo             := True;
  ibDataSet1DATA.Value         := Date;
  ibDataSet1SAIDA.Value        := 0;
  ibDataSet1ENTRADA.Value      := 0;
  bNaoCalculaSaldo             := False;
  //
end;

procedure TForm7.Image6Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
begin
  {Fonte atual}
  try
    FontDialog1.Font.Name  := DBGrid1.Font.Name;
    FontDialog1.Font.Size  := DBGrid1.Font.Size;
    FontDialog1.Font.Color := DBGrid1.Font.Color;
    FontDialog1.Font.Style := DBGrid1.Font.Style;
    {Dialog box}
    FontDialog1.Execute;
    {Novas configuraes}
    DBGrid1.Font.Name  := FontDialog1.Font.Name;
    DBGrid1.Font.Size  := FontDialog1.Font.Size;
    DBGrid1.Font.Color := FontDialog1.Font.Color;
    DBGrid1.Font.Style := FontDialog1.Font.Style;
    //
    DBGrid1.TitleFont.Name  := FontDialog1.Font.Name;
    DBGrid1.TitleFont.Size  := FontDialog1.Font.Size + 0;
    DBGrid1.TitleFont.Color := FontDialog1.Font.Color;
  //  DBGrid1.TitleFont.sTyle := [fsBold];
    DBGrid1.TitleFont.sTyle := [];
    {Grava a nova Configurao .INF, sModulo  'CAIXA', ou 'CLIENTES' ou ...}
    Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
    Mais1Ini.WriteString(sModulo,'FonteName_',DBGrid1.Font.Name);
    Mais1Ini.WriteString(sModulo,'FonteSize_',IntToStr(DBGrid1.Font.Size));
    Mais1Ini.WriteString(sModulo,'FonteColor_',IntToStr(DBGrid1.Font.Color));
    //
    if DBGrid1.Font.sTyle = [fsBold]   then
      Mais1Ini.WriteString(sModulo,'FonteY_','fsBold');
    if DBGrid1.Font.sTyle = [fsItalic] then
      Mais1Ini.WriteString(sModulo,'FonteY_','fsItalic');
    if DBGrid1.Font.sTyle = []         then
      Mais1Ini.WriteString(sModulo,'FonteY_','');
    //
    Mais1Ini.Free;
    //
  except end;
  //
  try
    Form7.Close;
    Form7.Show;
  except end;
  //
end;

procedure TForm7.Image101Click(Sender: TObject);
begin
  //
  Form7.bEstaSendoUsado := False;
  //
  if sModulo = 'OS' then
  begin
    //
    Form7.ibDataSet3.Append;
    Form7.ibDataSet3DATA_PRO.AsDateTime := Date;
    Form7.ibDataSet3HORA_PRO.AsString   := TimeToStr(Time);
    Form30.Show;
    //
  end
  else
  begin
    //
    if sModulo = 'VENDA' then
    begin
      //
      Form7.ibDataSet15.Append;
      //
      if Form7.sRPS = 'S' then
      begin
        Form48.Show;
      end
      else
      begin
        if ParamCount > 0 then
        begin
          if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) = 'URB' then
          begin
            Form12.ShowModal;
          end
          else
            Form12.Show;
        end
        else
          Form12.Show;
      end;
      //
    end
    else
    begin
      //
      if sModulo = 'COMPRA' then
      begin
        Form7.ibDataSet24.Append;
        Form24.Show;
      end else
      begin
        if sModulo = 'ORCAMENTO' then
        begin
          //
          ShellExecute( 0, 'Open', 'orca.exe', '', '', SW_SHOW);
          sleep(1000);
          //
          while ConsultaProcesso('orca.exe') or ConsultaProcesso('ORCA.EXE') do
          begin
            Form7.Caption := 'Aguarde o fechamento do programa de orcamentos...';
            Application.ProcessMessages;
            sleep(100);
          end;
          //
          Form7.Caption := '';
          AgendaCommit(True);
          Form7.Close;
          Form7.Show;
          Form7.ibDataSet97.EnableControls;
          Abort;
        end else
        begin
          Form10.Show;
          Form10.Image201Click(Sender);
        end;
      end;
    end;
  end;
end;

procedure TForm7.Image109Click(Sender: TObject);
begin
  //
//  if (sModulo <> 'ICM') then
  begin
    //
    if (dBgrid1.SelectedField.FieldName = 'QTD_MINIM') then
    begin
      if Form7.sWhere = 'where QTD_ATUAL <= QTD_MINIM' then
        Form7.sWhere := ''
      else
        Form7.sWhere := 'where QTD_ATUAL <= QTD_MINIM'
    end
    else
      Form16.ShowModal;
    //
    Form7.Close;
    Form7.Show;
    //
  end;
//else ShowMessage('Opo no disponvel!');
  //
end;

procedure TForm7.DBGrid1DblClick(Sender: TObject);
var
  Mais1Ini: TIniFile;
  sASP : String;
  bButton : Integer;
  F : TextFile;
  //
begin
  // --------------------------------------------------------------------------------- //
  // duplo clique no XML da NF-e                                                       //
  // --------------------------------------------------------------------------------- //
  Screen.Cursor            := crHourGlass;
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet4MARKETPLACE' then
  begin
    //
    Form7.ibDataSet4.Edit;
    if Form7.ibDataSet4MARKETPLACE.AsString = '1' then
    begin
      //
      Form7.ibDataSet4MARKETPLACE.AsString := '0';
      //
    end else
    begin
      //
      if ProdutoValidoParaMarketplace(True) = '' then
      begin
        Form7.ibDataSet4MARKETPLACE.AsString := '1';
      end else
      begin
        Form7.ibDataSet4MARKETPLACE.AsString := '0';
        ShowMessage('Para vender este produto atravs de Marketplace'+chr(10)+'preencha pelo menos os seguintes campos: '+chr(10)+chr(10)+ProdutoValidoParaMarketplace(True));
      end;
      //
    end;
    //
    Form7.ibDataSet4.Post;
    //
    Screen.Cursor            := crDefault;
    Abort;
    //
  end;
  //
  if Pos('MDESTINXML',DBGrid1.SelectedField.Name) <> 0 then
  begin
    //
    Manifestaododestinatrio1Click(Sender);
    //
    Screen.Cursor            := crDefault;
    Abort;
    //
  end;
  //
  if Pos('STATUS',DBGrid1.SelectedField.Name) <> 0 then
  begin
    if not DenegadoOuCancelado(True) then
    begin
      //
      Form7.N6EnviarNFeConsultareImprimirDANFE1Click(Sender);
      //
      if Form7.sRPS = 'S' then
      begin
        try
          Screen.Cursor := crHourGlass; // Cursor de Aguardo //
          if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) = 0 then
          begin
            //
            Sleep(15000);
            ConsultarNFSe1Click(Sender);
            //
          end;
        except
        end;
        //
        EnviarNFSeporemail1Click(Sender);
        //
        try
          try
            Form7.ibDAtaSet15.Post;
          except
          end;
          //
          Screen.Cursor            := crHourGlass;
          AgendaCommit(True);
          //
          Form7.Close;
          Form7.Show;
          //
          Screen.Cursor            := crDefault;
          Form7.ibDAtaSet15.Edit;
          //
        except
        end;
        //
        Screen.Cursor            := crDefault;
        //
      end;
      //
    end;
    //
    Abort;
    //
  end;
  //
  if Pos('NFEID',DBGrid1.SelectedField.Name) <> 0 then
  begin
    if sModulo = 'VENDA' then
    begin
      Clipboard.SetTextBuf(pchar(Form7.ibDataSet15NFEID.AsString));
    end else
    begin
      Clipboard.SetTextBuf(pchar(Form7.ibDataSet24NFEID.AsString));
    end;
    //
    //    ShellExecute( 0, 'Open',pChar('http://www.nfe.fazenda.gov.br/PORTAL/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8='),'','', SW_SHOWMAXIMIZED); // Antigo
    //
    // ShellExecute( 0, 'Open',pChar('http://www.nfe.fazenda.gov.br/PORTAL/consultaRecaptcha.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8='),'','', SW_SHOWMAXIMIZED); // Atualizado em 19/03/18
    //
    //
    ShellExecute( 0, 'Open',pChar('http://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g='),'','', SW_SHOWMAXIMIZED); // Atualizado em 10/11/2021
    //
    Screen.Cursor            := crDefault;
    Abort;
    //
  end;
  //
  if Pos('CCEXML',DBGrid1.SelectedField.Name) <> 0 then
  begin
    fNFe := Form7.ibDataSet15CCEXML.AsString;
    AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                  // Abre para gravao
    WriteLn(F,fNFe);
    CloseFile(F); // Fecha o arquivo
    ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
    Abort;
  end;
  //
  if Pos('RECIBOXML',DBGrid1.SelectedField.Name) <> 0 then
  begin
    //
    if Form7.sRPS = 'S' then
    begin
      //
      fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
      //
      if RetornaValorDaTagNoCampo('notaFiscal',fNFe) <> '' then
      begin
        //
        fNFe := '<retorno>'+
                '<notaFiscal>'+RetornaValorDaTagNoCampo('notaFiscal',fNFe)+'</notaFiscal>'+
                '<sRetornoDaPrefeitura>'+RetornaValorDaTagNoCampo('sRetornoDaPrefeitura',fNFe)+'</sRetornoDaPrefeitura>'+
                '</retorno>';
        //
      end;
      //
      if RetornaValorDaTagNoCampo('Nfse',fNFe) <> '' then
      begin
        //
        fNFe := RetornaValorDaTagNoCampo('Nfse',fNFe);
        //
      end;
      //
      fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
      //
      try
        BuscaNumeroNFSe(True);
      except end;
      //
    end;
    //
    fNFe := Form7.ibDataSet15RECIBOXML.AsString;
    //
    AssignFile(F,pchar(Form1.sAtual+'\tempo.txt'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                  // Abre para gravao
    Write(F,fNFe);
    CloseFile(F); // Fecha o arquivo
    ShellExecute( 0, 'Open','tempo.txt','','', SW_SHOWMAXIMIZED);
    //
    Abort;
    //
  end;
  //
  if Pos('NFEXML',DBGrid1.SelectedField.Name) <> 0 then
  begin
    //
    if sModulo = 'VENDA' then
    begin
      //
      if Form7.sRPS = 'S' then
      begin
        fNFe := Form7.ibDataSet15NFEXML.AsString;
        AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
        Rewrite(F);                  // Abre para gravao
        WriteLn(F,fNFe);
        CloseFile(F); // Fecha o arquivo
        ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
        Abort;
      end else
      begin
        //
        bButton := Application.MessageBox('Validar Schema?', 'Ateno',
                   mb_YesNo + mb_DefButton1 +  + MB_ICONQUESTION);

        if bButton = IDYES  then
        begin
          {Sandro Silva 2022-09-29 inicio
          Clipboard.SetTextBuf(pchar(Form7.ibDataSet15NFEXML.AsString));
          ShellExecute( 0, 'Open',pChar('http://www.sefaz.rs.gov.br/NFE/NFE-VAL.aspx'),'','', SW_SHOWMAXIMIZED);
          }
          ValidarSchemaSefaz(Form7.ibDataSet15NFEXML.AsString);
        end else
        begin
          fNFe := Form7.ibDataSet15NFEXML.AsString;
          AssignFile(F,pChar(Form7.ibDataSet15NFEID.AsString+'.xml'));  // Direciona o arquivo F para EXPORTA.TXT
          Rewrite(F);                  // Abre para gravao
          WriteLn(F,fNFe);
          CloseFile(F); // Fecha o arquivo
          ShellExecute( 0, 'Open',pChar(Form7.ibDataSet15NFEID.AsString+'.xml'),'','', SW_SHOWMAXIMIZED);
        end;
      end;
    end else
    begin
      fNFe := Form7.ibDataSet24NFEXML.AsString;
      AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      WriteLn(F,fNFe);
      CloseFile(F); // Fecha o arquivo
      ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
    end;
    //
    Screen.Cursor            := crDefault;
    Abort;
    //
  end;
{
  //
  // Procura pelo cdigo de barras no no google
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet4REFERENCIA' then
  begin
//    ShellExecute( 0, 'Open',pchar('http://www.google.com/products?hl=en&q='+ibDAtaSet4REFERENCIA.AsString+'&ie=UTF-8&sa=N&tab=df'),'', '', SW_SHOWMAXIMIZED)
    ShellExecute( 0, 'Open',pchar('http://www.google.com/products?q='+ibDAtaSet4REFERENCIA.AsString+''),'', '', SW_SHOWMAXIMIZED)
  end;
}
  //
  // Duplo CLICK no ativo REC
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet7ATIVO' then
  begin
    if (Form7.ibDataSet7VALOR_RECE.Asfloat = 0) or (Form7.ibDataSet7ATIVO.AsFloat >= 5) then
    begin
      //
      Form7.ibDataSet7.Edit;
      if Form7.ibDataSet7ATIVO.AsFloat >=5 then
      begin
        //
        Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat -5;
        Form7.ibDataSet7VALOR_RECE.AsFloat := 0;
        Form7.ibDataSet7RECEBIMENT.AsString := '';
        //
      end else
      begin
        //
        Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
        Form7.ibDataSet7VALOR_RECE.AsFloat := Form7.ibDataSet7VALOR_DUPL.AsFloat;
        //
      end;
      //
      SMALL_DBEdit2Change(Sender);
      Form7.ibDataSet7.Post;
      //
//      Form1.IBDataSet200.Close;
//      Form1.IBDataSet200.Open;
      //
      CalculaTotalRecebido(True);
      //
    end;
    //
    Screen.Cursor            := crDefault;
    Abort;
    //
  end;
  //
  // Duplo CLICK no ativo PAG
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet8ATIVO' then
  begin
    if (Form7.ibDataSet8VALOR_PAGO.Asfloat = 0) or (FORM7.ibDataSet8ATIVO.AsFloat >= 5) then
    begin
      //
      Form7.ibDataSet8.Edit;
      if Form7.ibDataSet8ATIVO.AsFloat >=5 then
      begin
        //
        Form7.ibDataSet8ATIVO.AsFloat := Form7.ibDataSet8ATIVO.AsFloat -5;
        Form7.ibDataSet8VALOR_PAGO.AsFloat := 0;
        Form7.ibDataSet8PAGAMENTO.AsString := '';
        //
      end else
      begin
        //
        Form7.ibDataSet8ATIVO.AsFloat := Form7.ibDataSet8ATIVO.AsFloat +5;
        Form7.ibDataSet8VALOR_PAGO.AsFloat := Form7.ibDataSet8VALOR_DUPL.AsFloat;
        //
      end;
      //
      SMALL_DBEdit2Change(Sender);
      Form7.ibDataSet8.Post;
      //
//      Form1.IBDataSet200.Close;
//      Form1.IBDataSet200.Open;
      //
      CalculaTotalRecebido(True);
      //
    end;
    //
    Screen.Cursor            := crDefault;
    Abort;
    //
  end;
  //
  // Duplo CLICK no ICM configurao
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet14SOBREIPI' then
  begin
    Form7.ibDataSet14.Edit;
    if (Form7.ibDataSet14SOBREIPI.AsString = 'S') or (Form7.ibDataSet14SOBREIPI.AsString = '') then
      Form7.ibDataSet14SOBREIPI.AsString := 'N' else Form7.ibDataSet14SOBREIPI.AsString := 'S';
    Screen.Cursor            := crDefault;
    Abort;
  end;
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet14SOBREFRETE' then
  begin
    Form7.ibDataSet14.Edit;
    if (Form7.ibDataSet14SOBREFRETE.AsString = 'S') or (Form7.ibDataSet14SOBREFRETE.AsString = '') then
      Form7.ibDataSet14SOBREFRETE.AsString := 'N' else Form7.ibDataSet14SOBREFRETE.AsString := 'S';
    Screen.Cursor            := crDefault;
    Abort;
  end;
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet14SOBRESEGURO' then
  begin
    Form7.ibDataSet14.Edit;
    if (Form7.ibDataSet14SOBRESEGURO.AsString = 'S') or (Form7.ibDataSet14SOBRESEGURO.AsString = '') then
      Form7.ibDataSet14SOBRESEGURO.AsString := 'N' else Form7.ibDataSet14SOBRESEGURO.AsString := 'S';
    Screen.Cursor            := crDefault;
    Abort;
  end;
  //
  if DBGrid1.SelectedField.Name = 'ibDataSet14SOBREOUTRAS' then
  begin
    Form7.ibDataSet14.Edit;
    if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') or (Form7.ibDataSet14SOBREOUTRAS.AsString = '') then
      Form7.ibDataSet14SOBREOUTRAS.AsString := 'N' else Form7.ibDataSet14SOBREOUTRAS.AsString := 'S';
    Screen.Cursor            := crDefault;
    Abort;
  end;
  //
  // --------------------------------------------------------------------------------- //
  // duplo clique no CGC                                                               //
  // --------------------------------------------------------------------------------- //
  if Pos('CGC',DBGrid1.SelectedField.Name) <> 0 then
  begin
    Clipboard.SetTextBuf(pChar(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)));
    if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
    begin
      bButton := Application.MessageBox('Federal?', 'Ateno',
                 MB_YESNOCANCEL + mb_DefButton1 + MB_ICONQUESTION);

      if bButton = IDYES  then
      begin
        if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
          ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/PessoaJuridica/CNPJ/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED)
        else
          ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/Aplicacoes/ATCTA/CPF/ConsultaPublica.asp?cnpf='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED);
      end else
      begin
        //
        if bButton = IDNO  then
        begin
          sAsp := 'http://www.sintegra.gov.br/';
          ShellExecute( 0, 'Open',pChar(sASP),'', '', SW_SHOWMAXIMIZED);
        end;  
        //
      end;
      Screen.Cursor            := crDefault;
      Abort;
    end else
    begin
      Clipboard.SetTextBuf(pChar(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)));
      if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
        ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/PessoaJuridica/CNPJ/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED)
      else
        ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/Aplicacoes/ATCTA/CPF/ConsultaPublica.asp?cpf='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED);
      Screen.Cursor            := crDefault;
      Abort;
    end;
  end;
  // --------------------------------------------------------------------------------- //
  // duplo clique no CGC  The End                                                      //
  // --------------------------------------------------------------------------------- //
  if Pos('COMPENS',DBGrid1.SelectedField.Name)<>0 then
  begin
    try
      if ibDataSet5COMPENS.AsString = '' then
      begin
        ibDataSet5.Edit;
        ibDataSet5COMPENS.AsDateTime := Date;
        if (Form7.ibDataset5.State in ([dsEdit, dsInsert])) then Form7.ibDataset5.Post;
        ibDataSet5.Edit;
      end;
    except end;
    Screen.Cursor            := crDefault;
    Abort;
  end;
  //
  if Pos('EMAIL',DBGrid1.SelectedField.Name) <> 0 then
  begin
    if (ValidaEmail(DBGrid1.SelectedField.AsString)) then
      ShellExecute( 0, 'Open',pChar('mailto:'+AllTrim(DBGrid1.SelectedField.AsString)),'New', '', SW_SHOWMAXIMIZED);
  end else
  begin
    // --------------------- //
    // Duplo click no dbgrid //
    // --------------------- //
    if sModulo = 'BANCOS' then
    begin
      iFoco := 7;
      Form10.Show;
    end;
    //
    if sModulo = '2CONTAS' then
    begin
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
      Mais1Ini.WriteString('BANCOS','BANCO',ibDataSet11NOME.AsString);
      Mais1Ini.Free;
      close;
      Form1.Image206Click(Sender);
      //
    end;
    //
    if sModulo = 'OS' then
    begin
      Form7.Image106Click(Sender);
    end else
    begin
      if sModulo = 'VENDA' then
      begin
        if (Form7.ibDataSet15EMITIDA.AsString <> 'X') and (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') then
          Form7.Image106Click(Sender);
      end else
      begin
        if sModulo = 'COMPRA' then
        begin
          Form7.Image106Click(Sender);
        end else
        begin
          if  (sModulo <> 'BANCOS')
          and (sModulo <> '2CONTAS')
          and (sModulo <> 'NOTA')
          and (sModulo <> 'CONFOS')
          and (sModulo <> 'CONFRECIBO') then
          begin
            if sModulo = 'ORCAMENTO' then
            begin
              ShellExecute( 0, 'Open', pChar(Form1.sAtual+'\orca.exe'), pChar(Form7.ibDataSet97.FieldByname('Oramento').AsString), '', SW_SHOW);
              sleep(1000);
              while ConsultaProcesso('orca.exe') or ConsultaProcesso('ORCA.EXE') do
              begin
                Form7.Caption := 'Aguarde o fechamento do programa de orcamentos...';
                Application.ProcessMessages;
                sleep(100);
              end;
              //
              Form7.Caption := '';
              AgendaCommit(True);
              Form7.Close;
              Form7.Show;
              //
              Form7.ibDataSet97.EnableControls;
              //
              Screen.Cursor            := crDefault;
              Abort;
              //
            end else
            begin
              Form7.Image106Click(Sender);
            end;
          end;
        end;
      end;
    end;
    //
  end;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.DBGrid1KeyPress(Sender: TObject; var Key: Char);
var
  I : Integer;
begin
 //
 if (DBGrid1.SelectedField.Name = 'ibDataSet14SOBREIPI') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14SOBREFRETE') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14SOBRESEGURO') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14SOBREOUTRAS')  then
 begin
   if Key <> chr(13) then
     Key := Chr(0);
 end;

 if Key = Chr(18) then
 begin
   Form20.Panel1.Visible := True;
   Form20.ShowModal;
 end;
 //
 if Key = Chr(6) then
  Form7.Image103Click(Sender);
 //
 if (dBGrid1.SelectedField.Name = 'ibDataSet1NOME') or
    (dBGrid1.SelectedField.Name = 'ibDataSet4NOME') or
    (dBGrid1.SelectedField.Name = 'ibDataSet7NOME') or
    (dBGrid1.SelectedField.Name = 'ibDataSet8NOME') then
 begin
   if Key <> chr(13) then
     Key := Chr(0);
 end;
 //
 if bFlag = True then
 begin

   I := DbGrid1.SelectedIndex;

   if Key = chr(13) then
   begin
     if (sModulo = 'CONCILIACAO') and (dBGrid1.SelectedField.Name = 'ibDataSet5COMPENS') then
       ArquivoAberto.Next
     else
       DbGrid1.SelectedIndex := DbGrid1.SelectedIndex  + 1;
   end;

   if dbGrid1.SelectedField.DataType = ftFloat then
   begin
     if Key = chr(46) then
       key := chr(44);
   end;

   if Key = chr(13) then
   begin
     if (I = DbGrid1.SelectedIndex) and (sModulo <> 'CONCILIACAO') then
     begin
       DbGrid1.SelectedIndex := 0;
       ArquivoAberto.Next;
  //     if (ArquivoAberto.EOF) and (not dbGrid1.ReadOnly) then ArquivoAberto.Append;
     end;
   end;
   //
   if Copy(UpperCase(dBGrid1.SelectedField.DisplayLabel),1,3) = 'SAL' then
   begin
     DbGrid1.SelectedIndex := 0;
     ArquivoAberto.Next;
//     if ArquivoAberto.EOF then ArquivoAberto.Append;
   end;
 end
 else
   bFlag := True;

 dBgrid1.Refresh;

end;


procedure TForm7.Cartaparamaladireta1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\carta.doc'),'','', SW_SHOWMAXIMIZED);
end;

procedure TForm7.Imprimircarta1Click(Sender: TObject);
begin
  //
  Form33.ShowModal;
  //
end;

procedure TForm7.Oramento1Click(Sender: TObject);
begin
  Form7.Close;
  Form7.sModulo := 'ORCAMENTO';
  Form7.sTitulo := 'Oramentos';
  Form7.sRPS := 'N';
  Form7.Show;
end;

procedure TForm7.Grupos1Click(Sender: TObject);
begin
  Form7.sModulo := 'GRUPOS';
  Form7.sTitulo := 'Grupos de mercadorias no estoque';
  Form7.sRPS := 'N';
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Inventrio1Click(Sender: TObject);
begin
  Form32.ShowModal;
end;

procedure TForm7.Relatriodeconpras1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.RadioButton1.Visible := True;
  Form38.RadioButton2.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de compras';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Relatriodevendas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.RadioButton1.Visible := True;
  Form38.RadioButton2.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de vendas';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Previsodecompra1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Panel3.Visible  := True;
  Form7.sModulo := 'Previso de compras';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Movimentaodoitem1Click(Sender: TObject);
begin
  Form10.Image203Click(Sender);
end;

procedure TForm7.Imprimirpedidosdevenda1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Relatrio de vendas (Cupom Fiscal)';
  Form38.Label17.Visible := True;
  Form38.Edit1.Visible   := True;
  Form38.ShowModal; // Ok
  Form38.Label17.Visible := False;
  Form38.Edit1.Visible   := False;
  //
end;

procedure TForm7.Listadepreos1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
begin
  //
  if Form7.sModulo = 'ESTOQUE' then
  begin
    Form7.Caption := 'Lista de preos';
    { L as configuraes no .INF }
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    { -- Mais1Ini.WriteString(Mais.sEscolhido,'L'+alltrim(IntToStr(I)), -- }
    Form39.CheckBox4.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo1','7'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00') +'%';
    Form39.CheckBox5.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo2','14'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00') +'%';
    Form39.CheckBox6.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo3','21'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00') +'%';
    //
    Form39.Label1.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00');
    Form39.Label2.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00');
    Form39.Label3.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00');
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    //
    Form39.Height := 80;
    //
  end;
  Form9.Show;
  Form14.Caption := 'Assistente para lista de preos';
  Form14.Show;
  Form39.Show;
  //
end;

procedure TForm7.Etiquetas1Click(Sender: TObject);
begin
  //
  Form15.ShowModal;
  //
end;

procedure TForm7.Contasbancrias1Click(Sender: TObject);
var
  I : Integer;
begin
  //
  // for I := 0 to Menuitem34.Count -1 do if I > 12 then ShowMessage(Menuitem34.Items[I].Caption);
  try
    for I := Menuitem34.Count -1 downto 13 do
    begin
      Menuitem34.Items[I].Destroy;
    end;
  except
  end;
  //
  Form7.sModulo := '2CONTAS';
  Form7.sTitulo := 'Contas bancrias';
  Form7.sRPS := 'N';
  Form7.Close;
  Form7.Show;
  //
end;

procedure TForm7.Sobreoprograma1Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Ajuda1Click(Sender: TObject);
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
end;

procedure TForm7.Sobreoprograma3Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma4Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma5Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma6Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma7Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma8Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma9Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma10Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma2Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.ibDataSet15MERCADORIAChange(Sender: TField);
var
  I, bButton : Integer;
  fDesconto, fTotal9, fAliquota, fRetencao, fST : Real;
  sReg14: String;
  sReg16: String;
begin
  //
  // No faz nada quando entra a 1 vez
  //
  if Form7.sModulo <> 'CANCELA' then // Sandro Silva 2022-11-07 if Form7.sModulo <> 'CALCELA' then
  begin
    //
    if (Alltrim(Form7.ibDataSet15OPERACAO.AsString) <> '') and (Form7.ibDataSet15FINNFE.AsString <> '2-Complementar') then
    begin
      //                            
      Form7.ibDataSet16.DisableControls;
      //
      try
        Form7.ibDataSet14.DisableControls;
        sReg14 := Form7.ibDataSet14REGISTRO.AsString;
        sReg16 := Form7.ibDataSet16REGISTRO.AsString;
        try
          Form7.ibDataSet14.First;
          while (Form7.ibDataSet14ISS.AsFloat = 0) and ( not Form7.ibDataSet14.EOF) do Form7.ibDataSet14.Next;
          if Form7.ibDataSet14ISS.AsFloat <> 0  then
          begin
            Form7.ibDataSet15.Edit;
  //          Form7.ibDataSet15ISS.AsFloat := Form7.ibDataSet15SERVICOS.Value * Form7.ibDataSet14ISS.AsFloat / 100; // ISS
          end;
        except
        end;
        try
          Form7.ibDataSet14.Locate('REGISTRO',sReg14,[]);
          Form7.ibDataSet14.EnableControls;
        except
        end;
        //
        // SIMPLES NACIONAL
        //
        if Copy(Form7.ibDataSet14OBS.AsString,1,26) = 'PERMITE O REAPROVEITAMENTO' then
        begin
          try
            Form7.ibDataSet14.Edit;
            Form7.ibDataSet14OBS.AsString := StrTran(Form7.ibDataSet14OBS.AsString,'REAPROVEITAMENTO','APROVEITAMENTO');
            Form7.ibDataSet14.Post;
          except
          end;
        end;
        //
        if Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO' then
        begin
          //
          // ObservacaoOperacao(False); // simplas nacional PERMITE O APROVEITAMENTO
          //
          try
            //
            // PERMITE O APROVEITAMENTO DO CRDITO DE ICMS NO VALOR DE R$; CORRESPONDENTE  ALQUOTA DE 2,82%, NOS TERMOS DO ART. 23 DA LC 123
            //
            try
              fAliquota := StrToFloat(Alltrim(StrTran(Copy(Form7.ibDataSet14OBS.AsString,90,4),'.',',')));
            except
              fAliquota := 2.82;
            end;
            //
            Form7.IBQuery99.Close;
            Form7.IBQuery99.SQL.Clear;
            Form7.IBQuery99.SQL.Add('select sum(Itens001.TOTAL) from ITENS001 ,ESTOQUE where ESTOQUE.DESCRICAO=ITENS001.DESCRICAO and (ESTOQUE.CSOSN=''101'' or ESTOQUE.CSOSN=''201'' or ESTOQUE.CSOSN=''900'') and ITENS001.NUMERONF='+QuotedStr(Form7.ibDataSet15NUMERONF.AsString)+' ');
            Form7.IBQuery99.Open;
            //
            fST := Form7.IBQuery99.FieldByname('SUM').AsFloat;
            //
            if FST > 0 then
            begin
              //
              if Pos(Form7.sAproveitamento,Form7.ibDataSet15COMPLEMENTO.AsString) <> 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
                Form7.ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,Form7.sAproveitamento,'');                      // Retira o anterios
              end;
              //
              Form7.sAproveitamento := StrTran(Form7.ibDataSet14OBS.AsString,'R$;','R$ '+Alltrim(Format('%12.2n',[ fST * fAliquota / 100])) +'; ');  // Gera o novo e grava em sAproveitamento
              //
              if Pos(Form7.sAproveitamento,Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
                Form7.ibDataSet15COMPLEMENTO.AsString := Form7.sAproveitamento + Form7.ibDataSet15COMPLEMENTO.AsString;                                // Coloca o novo
              end;
              //
            end;
            //
          except
          end;
        end else
        begin
          //                                   //
          // Joga p/obs a obs na tabela de icm //
          //                                   /
          //
          // 'Reteno de 4,65% correspondente a soma das aliquotas da CSLL da COFINS e PIS/PASEP. R$'
          //
          if Copy(Form7.ibDataSet14OBS.AsString,1,8) = 'Reteno' then
          begin
            Form7.ibDataSet15COMPLEMENTO.AsString  := '';
            ObservacaoOperacao(True); // Retencao
            try
              fRetencao := Form7.ibDataSet15SERVICOS.Value * StrToFloat(LimpaNumeroDeixandoAvirgula(Copy(Form7.ibDataSet14OBS.AsString,13,5))) / 100; // Reteno
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15COMPLEMENTO.AsString  := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,'R$','X$');
              Form7.ibDataSet15COMPLEMENTO.AsString  := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,'X$','R$ '+AllTrim(Format('%12.2n',[fRetencao])));
            except
            end;
          end;
        end;
      except
      end;
      //
      Form7.ibDataSet14.EnableControls;
      //
      //////////////////////////////////////////////////////////////////////////////////////////////////////
      //
      if Form7.sModulo = 'DESCONTO1' then
      begin
        //
        if ibDataSet15MERCADORIA.AsFloat <> 0 then
        begin
          //
          if (Form7.ibDataSet15MERCADORIA.AsFloat < 0) or (Pos('+',Form12.SMALL_DBEdit17.Text) <> 0) then
          begin
            if (Pos('+',Form12.SMALL_DBEdit17.Text) <> 0) then
            begin
              //
              // + 10 Acrescimo
              //
              Form12.FVELHO := Form12.fVELHO + (form12.fVELHO * StrToFloat(StrTran(Form12.SMALL_DBEdit17.Text,'+','')) / 100);
            end else
            begin
              //
              // - 10 Desconto
              //
              Form12.FVELHO := Form12.fVELHO +
              (form12.fVELHO * Form7.ibDataSet15MERCADORIA.AsFloat / 100);
            end;
          end else
          begin
            //
            ibDataSet16.First;
            fTotal9 := 0;
            //
            while not Form7.ibDataSet16.Eof do // Disable
            begin
              //
              if Form7.ibDataSet16BASEISS.AsFloat <> 100 then
              begin
                if (Pos(Alltrim(Form7.ibDataSet16.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5104 Industrializao efetuada para outra empresa no soma na base
                begin
                  fTotal9 := fTotal9 + Arredonda(Form7.ibDataSet16.FieldByname('TOTAL').AsFloat,2);
                end;
              end;
              //
              ibDataSet16.Next;
              //
            end;
            //
            // desconto
            //
            bButton := IDNO;
            if fTotal9 <> 0 then
            begin
              if (((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100) > 0.0001 then
              begin
                bButton := Application.MessageBox(Pchar('Confirma um desconto de:                    ' + chr(10) +
                Chr(10) +
                '           % ' + AllTrim(Format('%12.2n',[((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100])) +
                Chr(10) +
                Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
              end;
              //
              // Acrescimo
              //
              if (((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100) < -0.001 then
              begin
                bButton := Application.MessageBox(Pchar('Confirma um acrscimo de:                    ' + chr(10) +
                Chr(10) +
                '           % ' + AllTrim(Format('%12.2n',[-1*((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100])) +
                Chr(10) +
                Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
              end;
            end;
            //
            sModulo := 'MEMO1';
            //
            if bButton = IDYES then
            begin
              try
                for I := 1 to 10 do
                begin
                  fDesconto := ibDataSet15MERCADORIA.AsFloat/fTotal9;
                  if fTotal9 <> ibDataSet15MERCADORIA.AsFloat then
                  begin
                    ibDataSet16.First;
                    fTotal9 := 0;
                    while not Form7.ibDataSet16.Eof do // disable
                    begin
                      if ibDataSet16QUANTIDADE.AsFloat * ibDataSet16UNITARIO.Asfloat <> 0 then
                      begin
                        //
                        Form7.ibDataSet4.Close;                                                //
                        Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
                        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                        Form7.ibDataSet4.Open;
                        //
                        ibDataSet16.Edit;
                        if (((ibDataSet16TOTAL.Asfloat * fDesconto) / ibDataSet16QUANTIDADE.AsFloat) < ibDataSet4CUSTOCOMPR.AsFloat) and (Form1.ConfCusto = 'No') then
                        begin
                          ShowMessage('No  possvel dar descontos com o preo abaixo do custo');
                          ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
                        end else ibDataSet16TOTAL.AsFloat := Arredonda(ibDataSet16TOTAL.Asfloat * fDesconto,StrToInt(Form1.ConfPreco));
                        ibDataSet16.Post;
                        if Form7.ibDataSet16BASEISS.AsFloat <> 100 then
                        begin
                          if (Pos(Alltrim(Form7.ibDataSet16.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5104 Industrializao efetuada para outra empresa no soma na base
                          begin
                            fTotal9 := fTotal9 + Arredonda(Form7.ibDataSet16.FieldByname('TOTAL').AsFloat,2);
                          end;
                        end;
                        //
                      end;
                      ibDataSet16.Next;
                    end;
                  end;
                end;
              except
              end;
            end else
            begin
              ibDataSet15.Edit;
              ibDataSet15MERCADORIA.AsFloat := fTotal9;
              ibDataSet15.Post;
              ibDataSet15.Edit;
            end;
            //
          end;
          //
        end;
        //
        Form7.ibDataSet16.Locate('REGISTRO',sReg16,[]);
        //
      end;
      //
      // Reteno de 4,65% correspondente a soma das aliquotas da CSLL da COFINS e PIS/PASEP. R$
      //
      fRetencao := 0;
      //
      if Copy(Form7.ibDataSet14OBS.AsString,1,8) = 'Reteno' then
      begin
        try
          fRetencao := Form7.ibDataSet15SERVICOS.Value * StrToFloat(LimpaNumeroDeixandoAvirgula(Copy(Form7.ibDataSet14OBS.AsString,13,5))) / 100; // Reteno
          //
          // ShowMessage(Copy(Form7.ibDataSet14OBS.AsString,13,4));
          // ShowMessage(Format('%12.2n',[fRetencao]));
          //
        except
        end;
      end;
      // ------------------------ //
      // Dedus o ISS retido       //
      // ------------------------ //
      Form1.fRetencoes := 0;
      //
      Form48.SMALL_DBEdit16.Hint := '';
      //
      if Form7.sRPS = 'S' then
      begin
        //
        if Pos('(I)',Form7.ibDataset15MARCA.AsString) <> 0 then
        begin
          //
          // ISS
          //
          Form1.fRetencoes := Form7.ibDataSet15ISS.AsFloat;
          Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[( Form7.ibDataSet15ISS.AsFloat )]))  +' de ISS'+chr(10);
          //
        end;
        //
        // Pis
        // Cofins
        // Inss
        // Ir
        // Csll
        //
        if Pos('(F)',Form7.ibDataset15MARCA.AsString) <> 0 then
        begin
          //
          try
            //
            // Pis
            //
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString))    <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes + Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2,);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de PIS'+chr(10);
            end;
            //
          except
          end;
          //
          try
            //
            // Cofins
            //
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de COFINS'+chr(10);
            end;
            //
          except
          end;
          //
          try
            //
            // Inss
            //
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de INSS'+chr(10);
            end;
            //
          except
          end;
          //
          try
            //
            // Ir
            //
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString))     <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de IR'+chr(10);
            end;
            //
          except
          end;
          //
          try
            //
            // Csll
            //
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de CSLL'+chr(10);
            end;
            //
          except
          end;
          //
        end;
      end;
      // ------------------------ //
      // Dedus o imposto de renda //
      // ------------------------ //
      // Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
      //
      if Form7.ibDataSet15SERVICOS.AsFloat >= Form1.ConfLimite then
      begin
        //
        // ObservacaoOperacao(True); // Retencao
        //
        Form1.fRetencaoIR := (Form7.ibDataSet15SERVICOS.AsFloat * (( Form1.ConfIR / 100) * 1));
        Form7.ibDataSet15COMPLEMENTO.AsString := Form7.ibDataSet15COMPLEMENTO.AsString + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[  (Form7.ibDataSet15SERVICOS.AsFloat * (( Form1.ConfIR / 100) * 1))  ]))  +' de IRRF';
        //
      end else
      begin
        //
        Form1.fRetencaoIR := 0;
        //
      end;
      //
      if Format('%12.2n',[Form7.ibDataSet15TOTAL.AsFloat]) <> Format('%12.2n',[( Form7.ibDataSet15MERCADORIA.Value  +
                                                                             Form7.ibDataSet15SERVICOS.Value    +
                                                                             Form7.ibDataSet15FRETE.Value       +
                                                                             Form7.ibDataSet15SEGURO.Value      +
                                                                             Form7.ibDataSet15IPI.Value         +
                                                                             Form7.ibDataSet15ICMSSUBSTI.Value  +
                                                                             fFCPRetido      +
                                                                             Form7.ibDataSet15DESPESAS.Value    -
                                                                             Form7.ibDataSet15DESCONTO.Value    -
                                                                             Form1.fRetencoes -
                                                                             fRetencao)]) then
      begin

        Form7.ibDataSet15TOTAL.AsFloat :=  Arredonda(Form7.ibDataSet15MERCADORIA.Value + // Mercadoria +
                                                     Form7.ibDataSet15SERVICOS.Value   + // Servios +
                                                     Form7.ibDataSet15FRETE.Value      + // Frete +
                                                     Form7.ibDataSet15SEGURO.Value     + // Seguro +
                                                     Form7.ibDataSet15IPI.Value        + // Ipi +
                                                     Form7.ibDataSet15ICMSSUBSTI.Value + // Valor do ICMS substituio
                                                     fFCPRetido     + // Fundo de combate a pobresa retido por st
                                                     Form7.ibDataSet15DESPESAS.Value   - // Despesas
                                                     Form7.ibDataSet15DESCONTO.Value   - // Desconto
                                                     Form1.fRetencoes -                // ISS retido
                                                     fRetencao,2);                       //


        Form12.SMALL_DBEdit16.ShowHint := True;
        Form12.SMALL_DBEdit16.Hint     :=
        '+ Mercadoria: '+FloatToStr(Form7.ibDataSet15MERCADORIA.Value)+CHR(10)+
        '+ Servios: '+FloatToStr(Form7.ibDataSet15SERVICOS.Value)+CHR(10)+
        '+ Frete: '+FloatToStr(Form7.ibDataSet15FRETE.Value)+CHR(10)+
        '+ Seguro: '+FloatToStr(Form7.ibDataSet15SEGURO.Value)+CHR(10)+
        '+ IPI: '+FloatToStr(Form7.ibDataSet15IPI.Value)+CHR(10)+
        '+ ICMS Substituio: '+FloatToStr(Form7.ibDataSet15ICMSSUBSTI.Value)+CHR(10)+
        '+ FCPST: '+FloatToStr(fFCPRetido)+CHR(10)+
        '+ Despesas: '+FloatToStr(Form7.ibDataSet15DESPESAS.Value)+CHR(10)+
        '- Desconto: '+FloatToStr(Form7.ibDataSet15DESCONTO.Value)+CHR(10)+
        '- Retenes: '+FloatToStr(Form1.fRetencoes)+CHR(10)+
        '- Reteno de IR: '+FloatToStr(fRetencao)+CHR(10);
        //
      end;
      //
      if Form7.sModulo <> 'RETRIBUTA' then
        Form7.ibDataSet16.EnableControls;
      //
      // Soma o CFOP 5124 ou 6124 no TOTAL da nota mas no soma na MERCADORIA
      // 5104 Industrializao efetuada para outra empresa
      //
      if AllTrim(Form1.CFOP5124) <> '' then // Ok
      begin
        try
          //
          Form7.IBDataSet100.Close;
          Form7.ibDataSet100.SelectSQL.Clear;
          Form7.ibDataSet100.SelectSQL.Add('select sum(TOTAL) from ITENS001 where NUMERONF='+QuotedStr(IbDAtaSet15NUMERONF.AsString)+' and '+Form1.CFOP5124);
          Form7.ibDataSet100.Open;
          //
          // Soma o CFOP 5104 ou 6124 no TOTAL da nota mas no soma na MERCADORIA
          //
        except
        end;
      end;
      //
    end;
    
  end;
  //
  try
    //
    // Abate o Desconto no ISS
    //
    Totalizaservicos(True);
    //
  except end;
  //
end;

procedure TForm7.FormCreate(Sender: TObject);
begin
  //
  Form7.sAproveitamento := '';
  Form7.bMudei := False;
  dbGrid1.ReadOnly := True;
  Form7.Label208.Caption  := 'Liberar';
  //
  // NF-e
  //
  bProximas := False;
  bContingencia := False;
  bFirst := False;
  //
  sAjuda := 'INDEX.HTM';
  //
end;

procedure TForm7.ibDataSet14INTEGRACAOChange(Sender: TField);
begin
  if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,5) <> 'CAIXA' then
     if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,7) <> 'RECEBER' then
        if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,5) <> 'PAGAR' then
           if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,7) <> 'ESTOQUE' then
              if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,1) <> '=' then
                 if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,1) <> '0' then
                    if ibDataSet14INTEGRACAO.Value <> '' then
                       ibDataSet14INTEGRACAO.Value := '';

end;

procedure TForm7.DBGrid1TitleClick(Column: TColumn);
var
  Mais1ini : tIniFile;
begin
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  //
  if (form7.sModulo = 'RECEBER') and (Column.FieldName='NOME') then
    Mais1Ini.WriteString(sModulo,'ORDEM',Column.FieldName+', EMISSAO')
  else
    Mais1Ini.WriteString(sModulo,'ORDEM',Column.FieldName);
  //
  Mais1Ini.WriteString(sModulo,'REGISTRO',TabelaAberta.FieldByName('REGISTRO').AsString);
  Mais1Ini.Free;
  Form7.Close;
  Form7.Show;
  //
end;

procedure TForm7.ibDataSet7VALOR_RECEValidate(Sender: TField);
var
  fTotal : Real;
  bButton: Integer;
  sp : String;
  sR : String;
begin
  //
  if Form7.sModulo <> 'VENDA' then
  begin
    //
    if ibDataSet1.Locate('HISTORICO',Alltrim(copy('Receb. doc. '+ibDataSet7DOCUMENTO.AsString+'-'+ibDataSet7NOME.AsString+Replicate(' ',45),1,45)),[loPartialKey]) then
    begin
      if AllTrim(ibDataSet1HISTORICO.AsString) = Alltrim(copy('Receb. doc. '+ibDataSet7DOCUMENTO.AsString+'-'+ibDataSet7NOME.AsString+Replicate(' ',45),1,45)) then
      begin
        ibDataSet1.Delete;
      end;
    end;
    //
    if ibDataSet7VALOR_RECE.Value > 0 then
    begin
      //
      if ibDataSet7VALOR_RECE.Value < ibDataSet7VALOR_DUPL.Value then
      begin
        //
        bButton := Application.MessageBox('Criar uma nova conta a receber no restante do valor?','Ateno',
                                              MB_ICONQUESTION +
                                              mb_YesNo + mb_DefButton1);
        //
        if bButton = IDYES then
        begin
          //
          try
            //
            ibDataSet100.Close;
            ibDataSet100.SelectSql.Clear;
            ibDataset100.SelectSql.Add('select gen_id(G_RECEBER,1) from rdb$database');
            ibDataset100.Open;
            sP := StrZero(StrToInt(ibDataSet100.FieldByname('GEN_ID').AsString),10,0);
            //
            ibDataset100.Close;
            //
            if copy(ibDataSet7DOCUMENTO.AsString,1,1) = '0' then sR := 'A' else sR := Chr(Ord(ibDataSet7DOCUMENTO.AsString[1])+1);
            //

            if ibDataSet7VALOR_JURO.AsFloat > ibDataSet7VALOR_DUPL.AsFloat then
            begin
              //
              bButton := Application.MessageBox('Incluir os juros na nova conta a receber?','Ateno',
                                                    MB_ICONQUESTION +
                                                    mb_YesNo + mb_DefButton2);
              //
              if bButton = IDYES then
              begin
                fTotal := ibDataSet7VALOR_JURO.AsFloat - ibDataSet7VALOR_RECE.AsFloat;
              end else
              begin
                fTotal := ibDataSet7VALOR_DUPL.AsFloat - ibDataSet7VALOR_RECE.AsFloat;
              end;
            end else
            begin
              fTotal := ibDataSet7VALOR_DUPL.AsFloat - ibDataSet7VALOR_RECE.AsFloat;
            end;
            //
            Form7.ibDataSet100.Close;
            Form7.ibDataSet100.SelectSql.Clear;
            Form7.ibDataSet100.SelectSql.Add('insert into RECEBER (DOCUMENTO, VALOR_DUPL, VALOR_RECE, EMISSAO, VENCIMENTO, NOME, HISTORICO, CONTA, NUMERONF, REGISTRO) values('
              +QuotedStr(sR+copy(ibDataSet7DOCUMENTO.AsString,2,9))+', '
              +QuotedStr(StrTran(StrZero(fTotal,10,2),',','.'))
              +', '+QuotedStr('0')
              +', '+QuotedStr(DateToStrInvertida(Date))
              +', '+QuotedStr(DateToStrInvertida(Date))
              +', '+QuotedStr(StrTran(ibDataSet7Nome.AsString,chr(39),''))
              +', '+QuotedStr(StrTran(ibDataSet7Historico.AsString,chr(39),''))
              +', '+QuotedStr(ibDataSet7CONTA.AsString)
              +', '+QuotedStr(ibDataSet7NUMERONF.AsString)
              +', '+QuotedStr(sP)+') ');
            Form7.ibDataSet100.Open;
          except
          end;
        end;
      end;
      //
      if ibDataSet7RECEBIMENT.AsString = '' then ibDataSet7RECEBIMENT.AsDateTime := Date;
      //
      try
        if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
        begin
          if Pos(Form7.ibDataSet7PORTADOR.AsString,'RECEBIDO') = 0 then
          begin
            Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
          end;
        end;
      except
      end;
      //
    end;
    //
    if ibDataSet7VALOR_RECE.Value <> 0 then // Se valor Zero apaga o antigo mas no grava o novo
    begin
      //
      Form7.ibDataSet1.Append;
      Form7.ibDataSet1DATA.AsDateTime    := ibDataSet7RECEBIMENT.AsDateTime;
      Form7.ibDataSet1ENTRADA.AsFloat    := ibDataSet7VALOR_RECE.AsFloat;
      Form7.ibDataSet1HISTORICO.AsString := Alltrim(copy('Receb. doc. '+ibDataSet7DOCUMENTO.AsString+'-'+ibDataSet7NOME.AsString+Replicate(' ',45),1,45));
      Form7.ibDataSet1NOME.AsString      := ibDataSet7CONTA.AsString;     // contas bancrias
      Form7.ibDataSet1.Post;
    end;
    //
  end;
  //
end;

procedure TForm7.ibDataSet5COMPENSSetText(Sender: TField; const Text: String);
begin
  { ------------------------------------------------------------------ }
  { Cuidado: Esta rotina est associada a todos os campos do tipo data }
  { ------------------------------------------------------------------ }
  if Text = '  /  /    ' then
  begin
    Sender.AsString := '';
  end else
  begin
    try
      if (StrToDate(Text) <= (Date-(360*90))) or (StrToDate(Text) >= (Date+(360*90))) then
      begin
        if Application.MessageBox(Pchar('Esta data no parece ser a correta. Voc confirma '+text+ Chr(10) +
                                        'como a data vlida?' + Chr(10))
                                         ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION) <> IDYES then
        begin
          bFlag := False;
        end else
        begin
          try
            Sender.AsString := Text;
          except
            begin
              bFlag := False;
              ShowMessage('Esta data no  vlida, digite-a novamente.');
            end;
          end;
        end;
      end else
      begin
        try
          Sender.AsString := Text;
        except
          begin
            bFlag := False;
            ShowMessage('Esta data no  vlida, digite-a novamente.');
          end;
        end;
      end;
    except
      bFlag := False;
      ShowMessage('Esta data no  vlida, digite-a novamente.');
    end;
  end;
end;

procedure TForm7.FormShow(Sender: TObject);
var
  Mais1Ini : TiniFile;
  J, I, iLeft, iIconeCom : Integer;
  tInicio : tTime;
  Hora, Min, Seg, cent : Word;
  bA : Boolean;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo //
  try
    if Form10.Visible then
      Form10.Close;
  except
  end;
  //
  Form7.AlphaBlend      := True;
  Form7.AlphaBlendValue := 0;
  //
  tInicio := Time;
  //
  Form1.Panel4.Visible      := True;
  Form7.WebBrowser2.Visible := False;
  //
  try
    //
    // Pega os dados do Emitente
    //
    Form7.ibDataSet13.Active := True;
    // Sandro Silva 2022-10-31 if Pos('1'+UpperCase(UpperCase(Form7.ibDataSet13ESTADO.AsString))+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21mg2') = 0 then
    if (Pos('1'+UpperCase(UpperCase(Form7.ibDataSet13ESTADO.AsString))+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21mg2') = 0)
     or (Form1.ValidaEmitenteMunicipio = False) then
    begin
      try
        Form17.ShowModal;
        if Form1.CanFocus then
          Form1.SetFocus;
      except
      end;
    end;
    //
    DefineJanela(True);
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo //
    //
    Commitatudo(True);
    AgendaCommit(False);
    //
    // RECEBER CONTAS
    //
    Form7.Panel2.Visible  := False;
    Form7.Panel3.Visible  := False;
    //
    // Recalcula a quantidade no estoque
    //
    if (sModulo = 'ESTOQUE') and (not Form12.Visible) and (not Form30.Visible) then
    begin
      //
      ibDataSet27.DisableControls;
      ibDataSet4.DisableControls;
      ibDataSet16.DisableControls;
      ibDataSet23.DisableControls;
      ibDataSet12.DisableControls;
      //
//      Commitatudo(True);
//      AgendaCommit(False);
      //
      AtualizaPromocao(True);
      bA := False;
      //
      try
        //
        // Processa os produtos que ainda no foram baixados do estoque por motivo de Dead Look
        //
        sModulo := 'NAO';
        //
        // Teste LOKED Ronei
        //
        ibDataSet27.Close;
        ibDataSet27.SelectSQL.Clear;
        ibDataSet27.SelectSQL.Add('select * from ALTERACA where TIPO='+QuotedStr('LOKED')+' or TIPO='+QuotedStr('CANLOK')+' or TIPO='+QuotedStr('KOLNAC'));
        ibDataSet27.Open;
        //
        ibDataSet27.First;
        while not ibDataSet27.Eof do
        begin
          //
          try
            //
            if AllTrim(Form7.ibDataSet27CODIGO.AsString)<>'' then
            begin
              //
              bA := True;
              //
              Form7.ibDataSet4.Close;
              Form7.ibDataSet4.SelectSQL.Clear;
              Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet27CODIGO.AsString)+' ');
              Form7.ibDataSet4.Open;
              //
              if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet27CODIGO.AsString then
              begin
                //
                ibDataSet4.Edit;
                //
                if (Form7.ibDataSet27TIPO.AsString = 'CANLOK') or (Form7.ibDataSet27TIPO.AsString = 'KOLNAC') then
                begin
                  ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat + ibDataSet27QUANTIDADE.AsFloat; // Mantem a sincronia
                end else
                begin
                  ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat - ibDataSet27QUANTIDADE.AsFloat; // Mantem a sincronia
                end;
                //
                ibDataSet4ULT_VENDA.AsDateTime := ibDataSet27DATA.AsDateTime; // Mantem a sincronia
                ibDataSet4.Post;
                //
              end;
              //
              ibDataSet27.Edit;
              if AllTrim(ibDataSet27SERIE.AsString)='' then
              begin
                //
                if Form7.ibDataSet27TIPO.AsString = 'LOKED' then
                begin
                  ibDataSet27TIPO.AsString  := 'BALCAO'; // Resolvi este problema baseado no sincronia
                end;
                //
                if Form7.ibDataSet27TIPO.AsString = 'CANLOK' then
                begin
                  ibDataSet27TIPO.AsString  := 'CANCEL'; // Resolvi este problema baseado no sincronia
                end;
                //
                if Form7.ibDataSet27TIPO.AsString = 'KOLNAC' then
                begin
                  //
                  ibDataSet27DESCRICAO.AsString := '<CANCELADO>';
//                  ibDataSet27QUANTIDADE.AsFloat := 0;
//                  ibDataSet27UNITARIO.AsFloat   := 0;
//                  ibDataSet27TOTAL.AsFloat      := 0;
//                  ibDataSet27DESCONTO.AsFloat   := 0;
                  ibDataSet27TIPO.AsString      := 'CANCEL'; // Resolvi este problema baseado no sincronia
                  //
                end;
                //
              end else
              begin
                ibDataSet27TIPO.AsString  := 'VENDA'; // Resolvi este problema baseado no sincronia
              end;
              //
            end;
            //
          except

          end;
          //
          ibDataSet27.Next;
          //
        end;
        //
        if (Form7.ibDataset4.State in ([dsEdit, dsInsert])) then
          ibDataSet27.Post;
        //
        try
          //
          ibDataSet16.Close;
          ibDataSet16.SelectSQL.Clear;
          ibDataSet16.SelectSQL.Add('update ITENS001 set SINCRONIA=QUANTIDADE where coalesce(SINCRONIA,9999999)=9999999');
          ibDataSet16.Open;
          //
        except
        end;
        //
        ibDataSet16.Close;
        ibDataSet16.SelectSQL.Clear;
        ibDataSet16.SelectSQL.Add('select * from ITENS001, VENDAS where ITENS001.NUMERONF=VENDAS.NUMERONF and Coalesce(EMITIDA,''R'')=''S'' and coalesce(ITENS001.QUANTIDADE,0) <> coalesce(ITENS001.SINCRONIA,0)');
        ibDataSet16.Open;
        //
        ibDAtaSet16.First;
        //
        while not ibDataSet16.Eof do
        begin
          //
          bA := True;
          //
          try
            //
            Form7.ibQuery1.Close;
            Form7.IBQuery1.SQL.Clear;
            Form7.IBQuery1.SQL.Add('select EMITIDA from VENDAS where NUMERONF='+QuotedStr(Form7.ibDataSet16NUMERONF.AsString)+'');
            Form7.IBQuery1.Open;
            //
            if Form7.ibQuery1.FieldByName('EMITIDA').AsString = 'S' then
            begin
              //
              if AllTrim(Form7.ibDataSet16CODIGO.AsString)<>'' then
              begin
                //
                Form7.ibDataSet4.Close;
                Form7.ibDataSet4.SelectSQL.Clear;
                Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
                Form7.ibDataSet4.Open;
                //
                if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet16CODIGO.AsString then
                begin
                  ibDataSet4.Edit;
                  ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat - ibDataSet16QUANTIDADE.AsFloat; // Mantem a sincronia
                  ibDataSet4ULT_VENDA.AsDateTime := Date; // Mantem a sincronia
                  ibDataSet4.Post;
                  ibDataSet16.Edit;
                  ibDataSet16SINCRONIA.AsFloat   := ibDataSet16QUANTIDADE.AsFloat; // Resolvi este problema as 4 da madrugada no NoteBook em casa
                  ibDataSet16.Post;
                end;
                //
              end;
            end;
            //
          except
          end;
          //
          ibDataSet16.Next;
          //
        end;
        //
        try
          //
          ibDataSet23.Close;
          ibDataSet23.SelectSQL.Clear;
          ibDataSet23.SelectSQL.Add('update ITENS002 set SINCRONIA=QUANTIDADE where coalesce(SINCRONIA,9999999)=9999999');
          ibDataSet23.Open;
          //
        except
        end;
        //
        ibDataSet23.Close;
        ibDataSet23.SelectSQL.Clear;
        ibDataSet23.SelectSQL.Add('select * from ITENS002 where coalesce(QUANTIDADE,0) <> coalesce(SINCRONIA,0)');
        ibDataSet23.Open;
        //
        ibDAtaSet23.First;
        //
        while not ibDataSet23.Eof do
        begin
          //
          bA := True;
          //
          try
            if AllTrim(Form7.ibDataSet23CODIGO.AsString)<>'' then
            begin
              //
              Form7.ibDataSet4.Close;
              Form7.ibDataSet4.SelectSQL.Clear;
              Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');
              Form7.ibDataSet4.Open;
              //
  //            ShowMessage(ibDataSet4.SelectSQL.Text
  //            +chr(10)+Form7.ibDataSet4CODIGO.AsString+chr(10)+Form7.ibDataSet23CODIGO.AsString);
              //
              if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet23CODIGO.AsString then
              begin
                //
                ibDataSet4.Edit;
                ibDataSet4QTD_ATUAL.AsFloat := ibDataSet4QTD_ATUAL.AsFloat + ibDataSet23QUANTIDADE.AsFloat; // Mantem a sincronia
                ibDataSet4.Post;
                //
                ibDataSet23.Edit;
                ibDataSet23SINCRONIA.AsFloat   := ibDataSet23QUANTIDADE.AsFloat;       // Resolvi este problema as 4 da madrugada no NoteBook em casa
                //
                if ibDataSet23CUSTO.AsFloat = 0 then
                  ibDataSet23CUSTO.Value         := Form7.ibDataSet4CUSTOCOMPR.AsFloat;   // Custo de compra            //
                //
                ibDataSet23.Post;
                //
              end;
              //
            end;
          except
          end;
          //
          ibDataSet23.Next;
          //
        end;
        //
      except
      end;
      //
      sModulo := 'ESTOQUE';
      //
      // Se der um try no grava nada
      //
      try
        //
        Form7.ibQuery5.Close;
        Form7.IBQuery5.SQL.Clear;
        Form7.IBQuery5.SQL.Add('select CODIGO, DESCRICAO, QTD_ATUAL from ESTOQUE where QTD_ATUAL < 0');
        Form7.IBQuery5.Open;
        //
        Form7.IBQuery5.First;
        while not Form7.IBQuery5.Eof do
        begin
          //
          // Verifica se  produto composto
          //
          Form7.IBQuery3.Close;
          Form7.IBQuery3.SQL.Clear;
          Form7.IBQuery3.SQL.Add('select * from COMPOSTO where CODIGO='+QuotedStr(Form7.IBQuery5.FieldByname('CODIGO').AsString)+' ');
          Form7.IBQuery3.Open;
          //
          if AllTrim(Form7.IBQuery5.FieldByname('CODIGO').AsString) = AllTrim(Form7.IBQuery3.FieldByname('CODIGO').AsString) then
          begin
            //
            try
              //
              Form7.bFabrica := True;
              //
              Form7.IBQuery3.First;
              while not Form7.IBQuery3.Eof do
              begin
                //
                bA := True;
                //
                Form7.ibDataSet4.Close;
                Form7.ibDataSet4.Selectsql.Clear;
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.IBQuery3.FieldByname('DESCRICAO').AsString)+' ');  //
                Form7.ibDataSet4.Open;
                //
                Form7.ibDataSet4.Edit;
                Form7.ibDataSet4QTD_ATUAL.AsFloat := Arredonda(Form7.ibDataSet4QTD_ATUAL.AsFloat - (Form7.IBQuery3.FieldByname('QUANTIDADE').AsFloat * (Form7.IBQuery5.FieldByname('QTD_ATUAL').AsFloat*-1)),3);
                Form7.ibDataSet4.Post;
                //
                Form7.IBQuery3.Next;
                //
              end;
              //
            except
              ShowMEssage('Erro: 7319');
            end;
            Form7.ibDataSet4.Close;
            Form7.ibDataSet4.Selectsql.Clear;
            Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.IBQuery5.FieldByname('DESCRICAO').AsString)+' ');  //
            Form7.ibDataSet4.Open;
            //
  //          ShowMessage('Fabricando '+Form7.IBQuery5.FieldByname('QTD_ATUAL').AsString+' '+Form7.IBQuery5.FieldByname('DESCRICAO').AsString);
            //
            Form7.ibDataSet4.Edit;
            Form7.ibDataSet4QTD_ATUAL.AsFloat := Form7.ibDataSet4QTD_ATUAL.AsFloat + (Form7.IBQuery5.FieldByname('QTD_ATUAL').AsFloat*-1);
            Form7.ibDataSet4.Post;
            //
            Form7.bFabrica := False;
            //
          end;
          //
          Form7.IBQuery5.Next;
          //
        end;
      except
        Form7.IBTransaction1.Rollback;
      end;
      //
      if bA then
      begin
        Commitatudo(True);
        AgendaCommit(False);
      end;
      //
      ibDataSet27.EnableControls;
      ibDataSet4.EnableControls;
      ibDataSet16.EnableControls;
      ibDataSet23.EnableControls;
      ibDataSet12.EnableControls;
      //
      sModulo := 'ESTOQUE';
      //
    end;
    //
    // Recaulcula a quantidade no estoque
    //
    // Recalcula a data da ltima venda
    //
    if sModulo = 'CLIENTES' then
    begin
      //
      try
        //
        if Form1.bFechaTudo then
        begin
          //
          Form7.ibDataSet15.Close;
          Form7.ibDataSet15.SelectSql.Clear;
          Form7.ibDataset15.SelectSql.Add('select * from VENDAS where LOKED='+QuotedStr('S')+' ');
          Form7.ibDataset15.Open;
          //
          while not ibDataset15.Eof do
          begin
            //
            // Abre o arquivo de clientes para edio
            //
            try
              //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.SelectSql.Clear;
              Form7.ibDataset2.SelectSql.Add('select * from CLIFOR where NOME='+QuotedStr(AllTrim(Form7.ibDataSet15CLIENTE.AsString))+' ');
              Form7.ibDataset2.Open;
              //
              if (Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime) and (AllTrim(Form7.IBDataSet2NOME.AsString)=AllTrim(Form7.ibDataSet15CLIENTE.AsString)) then
              begin
                sModulo := 'LOKED';
                Form7.ibDataSet2.Edit;
                Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
                Form7.ibDataSet2.Post;
                sModulo := 'CLIENTES';
              end;
              //
              try
                Form7.ibDataSet15.Edit;
                Form7.ibDataSet15LOKED.AsString := '';
                Form7.ibDataSet15.Post;
              except
                //
                // ShowMessage('Erro ao atualizar data da ltima compra. 5893');
                //
              end;
              //
            except
              sModulo := 'CLIENTES';
            end;
            //
            Form7.ibDataSet15.Next;
            //
          end;
        end;
      except
        //
        Form7.ibDataSet15.Close;
        Form7.ibDataSet15.SelectSql.Clear;
        Form7.ibDataSet15.Selectsql.Add('select * from VENDAS where EMISSAO=CURRENT_DATE ');
        Form7.ibDataset15.Open;
        //
        Form7.ibDataSet2.Close;
        Form7.ibDataSet2.SelectSql.Clear;
        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');
        Form7.ibDataset2.Open;
        //
        sModulo := 'CLIENTES';
        //
      end;
      //
    end;
    //
    // Recaulcula a data da ltima venda
    //
    dbGrid1.DataSource := Form7.DataSource13;
    Form4.Close;                                          //
    //                                                   //
    // Desabilita os grids e paineis secundrios        //
    //                                                 //
    Panel9.Visible         := False;                  //
    Panel10.Visible        := False;                  //
    dbGrid2.Visible        := False;                  //
    dbGrid3.Visible        := False;                 //
    dbGrid4.Visible        := False;                //
    //
    Form7.Panel9.Caption :=   '0,00';
    //
    try
      //
      bSoLeitura := False;
      Mais1Ini   := TIniFile.Create(Form1.sAtual+'\EST0QUE.DAT');
      if Form7.sModulo = 'NOTA'     then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B1','0'))  <> '1' then
          bSoLeitura := True;
      end;
      if Form7.sModulo = 'ESTOQUE'  then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B2','0'))  <> '1' then
          bSoLeitura := True;
      end;
      if Form7.sModulo = 'CLIENTES' then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B3','0'))  <> '1' then
          bSoLeitura := True;
      end;
      if Form7.sModulo = 'RECEBER'  then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B4','0'))  <> '1' then
          bSoLeitura := True;
      end;
      if Form7.sModulo = 'PAGAR'    then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B10','0')) <> '1' then
          bSoLeitura := True;
      end;
      if Form7.sModulo = 'CAIXA'    then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B5','0'))  <> '1' then
          bSoLeitura := True;
      end;
      if Form7.sModulo = 'BANCOS'   then
      begin
        if AllTrim(Mais1Ini.ReadString(Usuario,'B6','0'))  <> '1' then
          bSoLeitura := True;
      end;
      Mais1Ini.Free;
    except end;
    //
  //  try
      //
      Form7.Caption := StrTran(sTitulo,'(RPS) RPS','(RPS)');
      Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
      //
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // Le a fonte no .INF}                                                                                         //
      //                                                                                                            //
      try
        if AllTrim(sModulo) <> '' then
        begin
          //
          DBGrid1.Font.Name  := Mais1Ini.ReadString(sModulo,'FonteName_','Microsoft Sans Serif');                         //
          DBGrid1.Font.Size  := StrToInt(Mais1Ini.ReadString(sModulo,'FonteSize_','10'));                                 //
          DBGrid1.Font.Color := StrToInt(Mais1Ini.ReadString(sModulo,'FonteColor_','0'));                                 //
          //                                                                                                        //
          if Mais1Ini.ReadString(sModulo,'FonteY_','') = ''         then
            DBGrid1.Font.Style := [];                  //
          if Mais1Ini.ReadString(sModulo,'FonteY_','') = 'fsItalic' then
            DBGrid1.Font.Style := [fsItalic];         //
          if Mais1Ini.ReadString(sModulo,'FonteY_','') = 'fsBold'   then
            DBGrid1.Font.Style := [fsBold];          //
          //                                                                                                    //
          DBGrid1.TitleFont.Name  := DBGrid1.Font.Name;   //
          DBGrid1.TitleFont.Size  := DBGrid1.Font.Size +2;    //
          DBGrid1.TitleFont.Color := DBGrid1.Font.Color;    //
          DBGrid1.TitleFont.sTyle := [];                     //
          //
        end;
      except end;
      //////////////////////////////////////////////////////
      // Abilita ou desabilita os campos                   //
      ////////////////////////////////////////////////////////
      if (sModulo = 'COMPRA') or (sModulo = 'VENDA') or (sModulo = 'OS') then
      begin
        //
        Form7.ibDataSet35UNITARIO.Visible := False;
        Form7.ibDataSet16UNITARIO.Visible := False;
        //
        if (sModulo = 'COMPRA') then
        begin
          dbGrid2.Left    := Form7.Width - 447 - 5; // Form7.Width - 410 -5;
          dbGrid2.Top     := dbGrid1.Top;
          dbGrid2.Height  := (dbGrid1.Height div 2) - Panel9.Height;
          dbGrid2.Width   := 432;
        end
        else
        begin
          dbGrid2.Left    := Form7.Width - 410 - 5;
          dbGrid2.Top     := dbGrid1.Top;
          dbGrid2.Height  := (dbGrid1.Height div 2) - Panel9.Height;
          dbGrid2.Width   := 395;
        end;
        //
        dbGrid2.Visible := True;
        //
        Panel9.Top     := dbGrid2.Top + dbGrid2.Height -1;
        Panel9.Left    := dbGrid2.Left;
        Panel9.width   := dbGrid2.Width;
        Panel9.Visible := True;
        //
        if (sModulo = 'COMPRA') then
        begin
          dbGrid3.Left    := Form7.Width - 447 -5;
          dbGrid3.Top     := Panel9.Top + Panel9.Height + 10;
          dbGrid3.Height  := dbGrid1.Height - dbGrid2.Height - Panel9.Height - 5 -4;
          dbGrid3.Width   := 432;
        end
        else
        begin
          dbGrid3.Left    := Form7.Width - 410 -5;
          dbGrid3.Top     := Panel9.Top + Panel9.Height + 10;
          dbGrid3.Height  := dbGrid1.Height - dbGrid2.Height - Panel9.Height - 5 -4;
          dbGrid3.Width   := 395;
        end;
        //
        dBgrid3.Visible        := True;
        //
        Panel10.Top     := dbGrid3.Top + dbGrid3.Height -1;
        Panel10.Left    := dbGrid3.Left;
        Panel10.Width   := dbGrid3.Width;
        //
        Panel10.Visible := True;
        //
        dbGrid1.Width   := dbGrid1.Width - dbGrid3.Width - 15;
        //
        Form7.ibDataSet16UNITARIO.Visible       := False;
        Form7.ibDataSet16CFOP.Visible           := False;
        Form7.ibDataSet16DESCRICAO.DisplayWidth := 41;
        //
        Form7.ibDataSet23UNITARIO.Visible       := False;
        Form7.ibDataSet23IPI.Visible            := False;
        Form7.ibDataSet23ICM.Visible            := False;
        Form7.ibDataSet23CST_ICMS.Visible       := False;
        Form7.ibDataSet23CST_IPI.Visible        := False;
        Form7.ibDataSet23CFOP.Visible           := False;
        if (sModulo = 'COMPRA') then
        begin
          Form7.ibDataSet23CFOP.Visible           := True;

        end;
        Form7.ibDataSet23VICMS.Visible          := False;
        Form7.ibDataSet23VBC.Visible            := False;
        Form7.ibDataSet23VBCST.Visible          := False;
        Form7.ibDataSet23VICMSST.Visible        := False;
        Form7.ibDataSet23VIPI.Visible           := False;
        Form7.ibDataSet23EAN_ORIGINAL.Visible   := False;
        //
        Form7.ibDataSet23DESCRICAO.DisplayWidth := 41;
        Form7.ibDataSet23TOTAL.DisplayWidth     := 10;
        Form7.ibDataSet23QUANTIDADE.DisplayWidth:= 9;
        //                                           //
        Form7.DBGrid1.Options   := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];                                 // Form 7 Show
        Form7.DbGrid1.ReadOnly  := True;
        Form7.DbGrid1.Update;
        Form7.Image308.Visible  := False;
        Form7.Image208.Visible  := True;
        Form7.Label208.Caption  := 'Liberar';
        //
        if Form7.sRPS = 'S' then
        begin
            //
            Form7.dBGrid2.Visible     := False;
            form7.Panel9.Visible      := False;
            //
            dbGrid3.Top            := dbGrid1.Top;
            dbGrid3.Height         := (dbGrid1.Height);
            //
        end else
        begin
          //

          //
        end;
      end;
      //
      if (sModulo = 'RECEBER') then
      begin
        //
        ComboBox1.Items.Clear;
        ComboBox1.Items.Add('<Dinheiro/Cheque>');
        ComboBox1.ItemIndex := 0;
        //
        Form7.ibDataSet12.Close;
        Form7.ibDataSet12.SelectSQL.Clear;
        Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
        Form7.ibDataSet12.Open;
        //
        Form7.ibDataSet12.First;
        //
        while not Form7.ibDataSet12.Eof do
        begin
          if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '5' then
          begin
            ComboBox1.Items.Add(Form7.ibDataSet12NOME.AsString);
          end;
          //
          Form7.ibDataSet12.Next;
          //
        end;
        //
        Panel9.Top      := 86;
        Panel9.Width    := Panel2.Width;
        //
        //
        Panel2.Left     := Form7.Width - 395 -15 -5;
        Panel2.Top      := Form7.DBGrid1.Top;
        Panel2.Visible  := True;
        Button6.Visible := True;
        //
        dbGrid3.Top     := Form7.DBGrid1.Top + Panel2.Height + 10;
        //
        dbGrid3.Height  := dbGrid1.Height - 10 - Panel2.Height + 17;
        dbGrid3.Width   := 395;
        dbGrid3.Left    := Form7.Width - 395 -15 -5;
        dbGrid3.Visible := True;
        //
        Panel10.Top     := dbGrid3.Top + dbGrid3.Height- 18;
        Panel10.Left    := dbGrid3.Left;
        Panel10.Width   := dbGrid3.Width;
        //
        Panel10.Visible := True;
        dbGrid1.Width   := dbGrid1.Width - dbGrid3.Width - 15;
        //
        Form7.DBGrid1.Options  := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];                                 // Form 7 Show
        Form7.dbGrid1.ReadOnly := True;
        Form7.Image308.Visible := False;
        Form7.Image208.Visible := True; Form7.Label208.Caption  := 'Liberar';
        //
//        CommitaTudo(True);
//        AgendaCommit(False);
        //
        CalculaTotalRecebido(True);
        //
        Form1.IBDataSet200.Close;
        Form1.IBDataSet200.SelectSQL.Clear;
        Form1.IBDataSet200.SelectSQL.Add('select DOCUMENTO as "Documento", VALOR_DUPL as "Valor original   ", VALOR_RECE as "Valor recebido   ", VENCIMENTO as "Vencimento", RECEBIMENT as "Data recebimento   ", REGISTRO from RECEBER where ATIVO>=5');
        Form1.IBDataSet200.Open;
        //
        dbGrid3.Datasource         := Form1.DataSource200;
        dbGrid3.Columns[5].Visible := False;
        dbGrid3.Columns[4].Visible := False;
        //
        Edit1.Text := 'Recebimentos';
        //
        Label47.Caption := 'Valor recebido';
        Label23.Caption := 'Total recebido';
        //
        Form7.SMALL_DBEdit1.DataField  := '';
        Form7.SMALL_DBEdit1.DataSource := Form7.DataSource7;
        Form7.SMALL_DBEdit2.DataSource := Form7.DataSource7;
        Form7.SMALL_DBEdit1.DataField  := 'VALOR_RECE';
        //
        Form7.ibDataSet25.Active := True;
        Form7.ibDataSet25.Append;
        //
      end;
      //
      if (sModulo = 'PAGAR') then
      begin
        //
        ComboBox1.Items.Clear;
        ComboBox1.Items.Add('<Dinheiro/Cheque>');
        ComboBox1.ItemIndex := 0;
        //
        Form7.ibDataSet12.Close;
        Form7.ibDataSet12.SelectSQL.Clear;
        Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
        Form7.ibDataSet12.Open;
        //
        Form7.ibDataSet12.First;
        //
        while not Form7.ibDataSet12.Eof do
        begin
          if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '5' then
          begin
            ComboBox1.Items.Add(Form7.ibDataSet12NOME.AsString);
          end;
          //
          Form7.ibDataSet12.Next;
          //
        end;
        //
        Panel9.Top      := 86;
        Panel9.Width    := Panel2.Width;
        //
        Panel2.Left     := Form7.Width - 395 -15 -5;
        Panel2.Top      := Form7.DBGrid1.Top;
        Panel2.Visible  := True;
        Button6.Visible := False;
        //
        dbGrid3.Top     := Form7.DBGrid1.Top + Panel2.Height + 10;
        //
        dbGrid3.Height  := dbGrid1.Height - 10 - Panel2.Height + 17;
        dbGrid3.Width   := 395;
        dbGrid3.Left    := Form7.Width - 395 -15 -5;
        dbGrid3.Visible := True;
        //
        Panel10.Top     := dbGrid3.Top + dbGrid3.Height- 18;
        Panel10.Left    := dbGrid3.Left;
        Panel10.Width   := dbGrid3.Width;
        //
        Panel10.Visible := True;
        dbGrid1.Width   := dbGrid1.Width - dbGrid3.Width - 15;
        //
        Form7.DBGrid1.Options  := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];                                 // Form 7 Show
        Form7.dbGrid1.ReadOnly := True;
        Form7.Image308.Visible := False;
        Form7.Image208.Visible := True; Form7.Label208.Caption  := 'Liberar';
        //
        //
//        CommitaTudo(True);
//        AgendaCommit(False);
        //
        CalculaTotalRecebido(True);
        //
        Form1.IBDataSet200.Close;
        Form1.IBDataSet200.SelectSQL.Clear;
        Form1.IBDataSet200.SelectSQL.Add('select DOCUMENTO as "Documento", VALOR_DUPL as "Valor original   ", VALOR_PAGO as "Valor pago   ", VENCIMENTO as "Vencimento", PAGAMENTO as "Data de pagamento     ", REGISTRO from PAGAR where ATIVO>=5');
        Form1.IBDataSet200.Open;
        //
        dbGrid3.Datasource     := Form1.DataSource200;
        //
        dbGrid3.Columns[5].Visible := False;
        dbGrid3.Columns[4].Visible := False;
        //
        Edit1.Text := 'Pagamentos';
        //
        Label47.Caption := 'Valor pago';
        Label23.Caption := 'Total pago';
        //
        Form7.SMALL_DBEdit1.DataField  := '';
        Form7.SMALL_DBEdit1.DataSource := Form7.DataSource8;
        Form7.SMALL_DBEdit2.DataSource := Form7.DataSource8;
        Form7.SMALL_DBEdit1.DataField  := 'VALOR_PAGO';
        //
        Form7.ibDataSet25.Active := True;
        Form7.ibDataSet25.Append;
        //
      end;
      //
      if sModulo = 'COMPRA' then
      begin
        //
        sAjuda := 'nf_compra.htm';
        //
//        Form7.ibDataSet2.Close;                                                //
//        Form7.ibDataSet2.Selectsql.Clear;                                      // receber Relacionado
//        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');  //
//        Form7.ibDataSet2.Open;
        //
        ibDataSet8.Close;
        ibDataSet8.DataSource := DataSource24;
        ibDataSet8.Selectsql.Clear;
        ibDataSet8.Selectsql.Add('select * from PAGAR where NUMERONF=:NUMERONF and NOME=:FORNECEDOR order by REGISTRO');
        ibDataSet8.Open;
        //
        ibDataSet23.Close;
        ibDataSet23.DataSource  := DataSource24;
        ibDataSet23.Selectsql.Clear;
        ibDataSet23.Selectsql.Add('select * from ITENS002 where NUMERONF=:NUMERONF and FORNECEDOR=:FORNECEDOR');
        ibDataSet23.Open;
        //
        Form7.ibDataSet35.Close;                                                            //
        Form7.ibDataSet35.Selectsql.Clear;                                                  // Itens de servio relacionado
        Form7.ibDataSet35.Selectsql.Add('select * from ITENS003 where NUMERONF='+QuotedStr('9999999')+' '); //
        Form7.ibDataSet35.Open;
        //
        Form7.ibDataSet14.Close;
        Form7.ibDataSet14.SelectSQL.Clear;
        Form7.ibDataSet14.SelectSQL.Add('select * FROM ICM where (CFOP like '+QuotedStr('1%')+') or (CFOP like '+QuotedStr('3%')+') or (CFOP like '+QuotedStr('2%')+') order by upper(NOME)');
        Form7.ibDataSet14.Open;
        //
        if not Form7.ibDataSet4.active  then
          Form7.ibDataSet4.Open;
        if not Form7.ibDataSet1.active  then
          Form7.ibDataSet1.Open;
        //
        DbGrid1.Height         := Form7.Height - Form7.DbGrid1.Top - 60 -26 - 105 -10;
        dbGrid4.Left           := dbGrid1.Left;
        dbGrid4.Top            := dbGrid1.Top + dbGrid1.Height + 30 + 5 -2;
        dbGrid4.Height         := 105;
        dbGrid4.Width          := dbGrid1.Width;
        dbGrid4.Visible        := True;
        //
        // Mostra s o que interassa no contas a receber
        //
        for I := 1 to Form7.ibDataSet8.FieldCount do
        begin
          Form7.ibDataSet8.Fields[I-1].Visible := False;
        end;

        Form7.ibDataSet8DOCUMENTO.Visible  := True;
        Form7.ibDataSet8VENCIMENTO.Visible := True;
        Form7.ibDataSet8VALOR_DUPL.Visible := True;
        Form7.ibDataSet8NOME.Visible       := True;
        //
        // Liga os dbGrids aos dataSurces
        //
        dbGrid2.Datasource     := DataSource23;
        dbGrid3.Datasource     := DataSource35;
        dbGrid4.Datasource     := DataSource8;
        //
        // Campos
        //
        {Sandro Silva 2023-03-27 inicio
        sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
        iCampos                := 25;
        }
        if Length(Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTFFT')) = 25 then
        begin
          sMostra := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
          sMostra := Copy(sMostra, 1, 1) + 'T' + Copy(sMostra, 2, Length(sMostra));
        end
        else
        begin
          sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTFFT');
        end;
        iCampos                := 26;
        Form7.ibDataSet15.FieldByName('MODELO').Visible := True;
        {Sandro Silva 2023-03-27 fim}

        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        //
        // Menu
        //
        Form7.Menu             := MainMenu11;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource24.Dataset;
        TabelaAberta           := ibDataSet24;
        DataSourceAtual        := DataSource24;
        //
        // Sql
        //
        sSelect   := 'select * FROM COMPRAS';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by EMISSAO';
        //
      end
      else
        Form7.ibDataSet8.DataSource := Nil;
      //
      if sModulo = 'VENDA' then
      begin
        //
        sAjuda := 'nf_venda.htm';
        //
//        Form7.ibDataSet2.Close;                                                //
//        Form7.ibDataSet2.Selectsql.Clear;                                      // receber Relacionado
//        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');  //
//        Form7.ibDataSet2.Open;
        //
        Form7.ibDataSet9.Close;
        Form7.ibDataSet9.SelectSQL.Clear;
        Form7.ibDataSet9.SelectSQL.Add('select * FROM VENDEDOR where FUNCAO like '+QuotedStr('%VENDEDOR%')+' order by upper(NOME)');
        Form7.ibDataSet9.Open;
        Form7.ibDataSet9.First;
        Form7.ibDataSet9.DataSource := Nil;
        //
        Form7.ibDataSet7.Close;                                                            //
        Form7.ibDataSet7.Selectsql.Clear;                                                  // receber Relacionado
        Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where NUMERONF=:NUMERONF order by REGISTRO');  //
        Form7.ibDataSet7.DataSource := DataSource15;
        Form7.ibDataSet7.Open;
        //
        Form7.ibDataSet16.Close;                                                            //
        Form7.ibDataSet16.Selectsql.Clear;                                                  // Itens de venda relacionado
        Form7.ibDataSet16.Selectsql.Add('select * from ITENS001 where NUMERONF=:NUMERONF order by NUMERONF, REGISTRO'); //
        Form7.ibDataSet16.DataSource := DataSource15;
        Form7.ibDataSet16.Open;
        //
        Form7.ibDataSet35.Close;                                                            //
        Form7.ibDataSet35.Selectsql.Clear;                                                  // Itens de servio relacionado
        Form7.ibDataSet35.Selectsql.Add('select * from ITENS003 where NUMERONF=:NUMERONF order by REGISTRO'); //
        Form7.ibDataSet35.DataSource := DataSource15;
        Form7.ibDataSet35.Open;
        //
        Form7.ibDataSet14.Close;
        Form7.ibDataSet14.SelectSQL.Clear;
        Form7.ibDataSet14.SelectSQL.Add('select * FROM ICM where (CFOP like '+QuotedStr('5%')+') or (CFOP like '+QuotedStr('6%')+') or (CFOP like '+QuotedStr('7%')+') order by upper(NOME)');
        Form7.ibDataSet14.Open;
        //
        if not Form7.ibDataSet4.active  then
          Form7.ibDataSet4.Open;
        if not Form7.ibDataSet1.active  then
          Form7.ibDataSet1.Open;
        //
        DbGrid1.Height         := Form7.Height - Form7.DbGrid1.Top - 60 -26 - 105 -10;
        dbGrid4.Left           := dbGrid1.Left;
        dbGrid4.Top            := dbGrid1.Top + dbGrid1.Height + 30 + 5 -2;
        dbGrid4.Height         := 105;
        dbGrid4.Width          := dbGrid1.Width;
        dbGrid4.Visible        := True;
        //
        // Mostra s o que interassa no contas a receber
        //
        try
          for I := 1 to Form7.ibDataSet7.FieldCount do
          begin
            Form7.ibDataSet7.Fields[I-1].Visible := False;
          end;
        except

        end;
        //
        Form7.ibDataSet7DOCUMENTO.Visible  := True;
        Form7.ibDataSet7VENCIMENTO.Visible := True;
        Form7.ibDataSet7VALOR_DUPL.Visible := True;
        Form7.ibDataSet7NOME.Visible       := True;

        //
        // Liga os dbGrids aos dataSurces
        //
        dbGrid2.Datasource     := DataSource16;
        dbGrid3.Datasource     := DataSource35;
        dbGrid4.Datasource     := DataSource7;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource15.Dataset;
        TabelaAberta           := ibDataSet15;
        DataSourceAtual        := DataSource15;
        //
        // Sql
        //
        sSelect   := 'select * FROM VENDAS ';
        //
        if Form7.sRPS = 'S' then
        begin
          //
          // Menu
          //
          Form7.Menu             := MainMenu15;
          //
          sWhere    := Mais1Ini.ReadString('RPS','FILTRO','');
          //
        end else
        begin
          //
          // Menu
          //
          Form7.Menu             := MainMenu10;
          //
          sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
          //
        end;
        //
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%1'),'');
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%2'),'');
        //
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%001'),'');
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%002'),'');
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%920'),'');
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%'+Form1.sSerieEspecial+''),'');
        sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%RPS'),'');
        //
        if Pos('where NUMERONF like ',sWhere) <> 0 then  sWhere := '';
        //
        if Alltrim(sWhere) = 'where' then sWhere := '';
        //
        // Notas fiscais de sada (vendas) srie 001
        // Notas fiscais de sada (vendas) srie 002
        //
        sWhere := 'where NUMERONF like '+QuotedStr('%'+Right(Form7.sTitulo,3))+ '  '+AllTrim(sWhere)+' ';
        //
        sOrderBy  := 'order by NUMERONF';
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
        //
        if Form7.sRPS = 'S' then
        begin
          //
          Form7.ibDataSet15NUMERONF.DisplayLabel     := 'RPS';
          Form7.ibDataSet15NFEPROTOCOLO.DisplayLabel := 'NFS-e/Srie';
          //
          Form7.ibDataSet15NUMERONF.Visible := False;
          Form7.ibDataSet15STATUS.Visible := False;
          Form7.ibDataSet15EMISSAO.Visible := False;
          Form7.ibDataSet15CLIENTE.Visible := False;
          Form7.ibDataSet15MERCADORIA.Visible := False;
          Form7.ibDataSet15SERVICOS.Visible := False;
          Form7.ibDataSet15DESCONTO.Visible := False;
          Form7.ibDataSet15TOTAL.Visible := False;
          Form7.ibDataSet15OPERACAO.Visible := False;
          Form7.ibDataSet15VENDEDOR.Visible := False;
          Form7.ibDataSet15ICMS.Visible := False;
          Form7.ibDataSet15ISS.Visible := False;
          Form7.ibDataSet15IPI.Visible := False;
          Form7.ibDataSet15FRETE.Visible := False;
          Form7.ibDataSet15SEGURO.Visible := False;
          Form7.ibDataSet15DESPESAS.Visible := False;
          Form7.ibDataSet15TRANSPORTA.Visible := False;
          Form7.ibDataSet15PLACA.Visible := False;
          Form7.ibDataSet15IDENTIFICADOR1.Visible := False;
          Form7.ibDataSet15BASEICM.Visible := False;
          Form7.ibDataSet15BASEISS.Visible := False;
          Form7.ibDataSet15ICMSSUBSTI.Visible := False;
          Form7.ibDataSet15BASESUBSTI.Visible := False;
          Form7.ibDataSet15NFEPROTOCOLO.Visible := False;
          Form7.ibDataSet15NFERECIBO.Visible := False;
          Form7.ibDataSet15NFEID.Visible := False;               
          Form7.ibDataSet15NFEXML.Visible := False;              
          Form7.ibDataSet15CCEXML.Visible := False;              
          Form7.ibDataSet15RECIBOXML.Visible := False;           
          Form7.ibDataSet15MODELO.Visible := False;              
          //
          Form7.ibDataSet15NUMERONF.Index         := 0;
          Form7.ibDataSet15NFEPROTOCOLO.Index     := 1;
          Form7.ibDataSet15STATUS.Index           := 2;
          Form7.ibDataSet15EMISSAO.Index          := 3;
          Form7.ibDataSet15CLIENTE.Index          := 4;
          Form7.ibDataSet15SERVICOS.Index         := 5;
          Form7.ibDataSet15DESCONTO.Index         := 6;
          Form7.ibDataSet15TOTAL.Index            := 7;
          Form7.ibDataSet15OPERACAO.Index         := 8;
          Form7.ibDataSet15VENDEDOR.Index         := 9;
          Form7.ibDataSet15ISS.Index              := 10;
          Form7.ibDataSet15NFEXML.Index           := 11;
          Form7.ibDataSet15RECIBOXML.Index        := 12;
          //
          sMostra                := Mais1Ini.ReadString('RPS','Mostrar','TTTTTTTTTTTTT');
          iCampos                := 13;
          //
        end else
        begin
          //
          // Campos
          //
          sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTTTTTTTTTTTTT');
          iCampos                := 29;
          //
          Form7.ibDataSet15NUMERONF.DisplayLabel     := 'NF/Srie';
          Form7.ibDataSet15NFEPROTOCOLO.DisplayLabel := 'Protocolo';
          //
          Form7.ibDataSet15NUMERONF.Index         := 0;
          Form7.ibDataSet15STATUS.Index           := 1;
          Form7.ibDataSet15EMISSAO.Index          := 2;
          Form7.ibDataSet15CLIENTE.Index          := 3;
          Form7.ibDataSet15MERCADORIA.Index       := 4;
          Form7.ibDataSet15SERVICOS.Index         := 5;
          Form7.ibDataSet15DESCONTO.Index         := 6;
          Form7.ibDataSet15TOTAL.Index            := 7;
          Form7.ibDataSet15OPERACAO.Index         := 8;
          Form7.ibDataSet15VENDEDOR.Index         := 9;
          Form7.ibDataSet15ICMS.Index             := 10;
          Form7.ibDataSet15ISS.Index              := 11;
          Form7.ibDataSet15IPI.Index              := 12;
          Form7.ibDataSet15FRETE.Index            := 13;
          Form7.ibDataSet15SEGURO.Index           := 14;
          Form7.ibDataSet15DESPESAS.Index         := 15;
          Form7.ibDataSet15TRANSPORTA.Index       := 16;
          Form7.ibDataSet15PLACA.Index            := 17;
          Form7.ibDataSet15IDENTIFICADOR1.Index   := 18;
          Form7.ibDataSet15BASEICM.Index          := 19;
          Form7.ibDataSet15BASEISS.Index          := 20;
          Form7.ibDataSet15ICMSSUBSTI.Index       := 21;
          Form7.ibDataSet15BASESUBSTI.Index       := 22;
          Form7.ibDataSet15NFEPROTOCOLO.Index     := 23;
          Form7.ibDataSet15NFERECIBO.Index        := 24;
          Form7.ibDataSet15NFEID.Index            := 25;
          Form7.ibDataSet15NFEXML.Index           := 26;
          Form7.ibDataSet15CCEXML.Index           := 27;
          Form7.ibDataSet15RECIBOXML.Index        := 28;
          Form7.ibDataSet15MODELO.Index           := 29;
          //
        end;
        //
      end
      else
        Form7.ibDataSet7.DataSource := Nil;
      //
      if sModulo = 'OS' then
      begin
        //
        sAjuda := 'os.htm';
        //
//        Form7.ibDataSet2.Close;                                                //
//        Form7.ibDataSet2.Selectsql.Clear;                                      // receber Relacionado
//        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');  //
//        Form7.ibDataSet2.Open;
        //
        Form7.ibDataSet9.Close;
        Form7.ibDataSet9.SelectSQL.Clear;
        Form7.ibDataSet9.SelectSQL.Add('select * FROM VENDEDOR where FUNCAO like '+QuotedStr('%TECNICO%')+' order by upper(NOME)');
        Form7.ibDataSet9.Open;
        Form7.ibDataSet9.DataSource := Nil;
        Form7.ibDataSet9.First;
        //
  //      Image210.Visible := True;
        //
        ibDataSet16.Close;
        ibDataSet16.DataSource := DataSource3;
        ibDataSet16.Selectsql.Clear;
        ibDataSet16.Selectsql.Add('select * from ITENS001 where NUMEROOS=:NUMERO');
        ibDataSet16.Open;
        //
        ibDataSet35.Close;
        ibDataSet35.DataSource := DataSource3;
        ibDataSet35.Selectsql.Clear;
        ibDataSet35.Selectsql.Add('select * from ITENS003 where NUMEROOS=:NUMERO');
        ibDataSet35.Open;
        //
        if not Form7.ibDataSet4.active  then
          Form7.ibDataSet4.Open;
        //
        dBgrid3.Visible        := True;
        //
        // Liga os dbGrids aos dataSurces
        //
        dbGrid2.Datasource     := DataSource16;
        dbGrid3.Datasource     := DataSource35;
        //
        // Campos
        //
        sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TFFTTTTTTFFFFFFFFFFFFFFFF');
        iCampos                := 25;
        //
        // Menu
        //
        Form7.Menu           := MainMenu3;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource3.Dataset;
        TabelaAberta           := ibDataSet3;
        DataSourceAtual        := DataSource3;
        //
        // Sql
        //
        sSelect   := 'select * FROM OS';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NUMERO');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        //
      end;
      //
      if sModulo = 'NOTA' then
      begin
        //
        sAjuda := 'nf_config.htm';
        //
        ArquivoAberto          := DataSource19.Dataset;
        TabelaAberta           := ibDataSet19;
        DataSourceAtual        := DataSource19;
        //
        iCampos              := 6;
        Form7.Menu       := MainMenu99;
        Panel3.Visible       := True;
        //
        DBgrid1.TitleFont.Name     := 'Microsoft Sans Serif';
        DBGrid1.TitleFont.Size     := 8;
        DBGrid1.TitleFont.Color    := clBlack;
        //
        DBGrid1.Font.Name          := 'Microsoft Sans Serif';
        DBGrid1.Font.Size          := 8;
        DBGrid1.Font.Color         := clBlack;
        //
        sSelect   := 'select * from NOTA';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','where SERIE=1');
        sOrderBy  := 'order by ((LINHA * 1000) + COLUNA)';
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := 'TTTTTT';
        //
        Form4.Top            := Form7.Top;
        Form4.Left           := Form7.Left + Form7.Width + 10;
        Form4.Width          := Screen.Width - Form4.Left -10;
        Form4.Height         := Form7.Height -10;
        //
        if sWhere = 'where SERIE=1' then
        begin
          Button2.Caption       := 'Srie 2';
          Button2.Repaint;
          Form7.sTitulo         := 'Configurao da nota fiscal srie 1';
          Form7.sRPS := 'N';
        end else
        begin
          Button2.Caption       := 'Srie 1';
          Button2.Repaint;
          Form7.sTitulo         := 'Configurao da nota fiscal srie 2';
          Form7.sRPS := 'N';
        end;
        //
        Form7.Button2.Visible := True;
        //
      end;
      //
      if Form7.sModulo = 'ORCAMENTO' then
      begin
        //
        try
          CriaJpg('logotip.jpg');
        except
        end;
        //
        if FileExists(Form1.sAtual+'\logotip.jpg') then
        begin
          if not FileExists(Form1.sAtual+'\ORCAMENTOS\logotip.jpg') then
          begin
            try
              ForceDirectories(Form1.sAtual+'\ORCAMENTOS');
            except
            end;
          end;
          //
          DeleteFile(pChar(Form1.sAtual+'\ORCAMENTOS\logotip.jpg'));
          CopyFile(pChar(Form1.sAtual+'\logotip.jpg'),pChar(Form1.sAtual+'\ORCAMENTOS\logotip.jpg'),false);
          //
        end;
        //
        Form7.ibDataSet97.Close;
        Form7.ibDataSet97.Selectsql.Clear;
        //Sandro Silva 2019-09-25 No est agrupando quando lana itens em data diferentes Form7.ibDataSet97.Selectsql.Add('select PEDIDO as "Oramento", DATA as "Data", CLIFOR as "Cliente", VENDEDOR as "Vendedor", sum ( case when DESCRICAO <> '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Total bruto", sum ( case when DESCRICAO  = '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Desconto", NUMERONF as "Doc. Fiscal", PEDIDO as "Registro" from ORCAMENT group by PEDIDO, DATA, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO'); //
        Form7.ibDataSet97.Selectsql.Add('select PEDIDO as "Oramento", min(DATA) as "Data", CLIFOR as "Cliente", VENDEDOR as "Vendedor", sum ( case when DESCRICAO <> '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Total bruto", sum ( case when DESCRICAO  = '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Desconto", NUMERONF as "Doc. Fiscal", PEDIDO as "Registro" from ORCAMENT group by PEDIDO, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO'); //
        Form7.ibDataSet97.Open;
        Form7.ibDataSet97.EnableControls;
        //
        // Form7.ibDataSet16.Selectsql.Add('select * from ITENS001 where NUMERONF=:NUMERONF order by NUMERONF, REGISTRO');
        //
        Form7.IBDataSet97.FieldByName('Registro').Visible := False;
        //
        sAjuda := 'orcamento.htm';
        //
        // Campos
        //
        sMostra                := 'TTTTTTTF';
        iCampos                := 8;
        //
        // Menu
        //
        Form7.Menu         := MainMenu13;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource97.Dataset;
        TabelaAberta           := ibDataSet97;
        DataSourceAtual        := DataSource97;
        //
        // Sql
        //
        //Sandro Silva 2019-09-25 No est agrupando quando lana itens em data diferentes  sSelect   := 'select PEDIDO as "Oramento", DATA as "Data", CLIFOR as "Cliente", VENDEDOR as "Vendedor", sum ( case when DESCRICAO <> '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Total bruto", sum ( case when DESCRICAO  = '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Desconto", NUMERONF as "Doc. Fiscal", PEDIDO as "Registro" from ORCAMENT'; //
        sSelect   := 'select PEDIDO as "Oramento", min(DATA) as "Data", CLIFOR as "Cliente", VENDEDOR as "Vendedor", sum ( case when DESCRICAO <> '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Total bruto", sum ( case when DESCRICAO  = '+QuotedStr('Desconto')+' then TOTAL else 0 end ) as "Desconto", NUMERONF as "Doc. Fiscal", PEDIDO as "Registro" from ORCAMENT'; //
        sWhere    := StrTran(StrTran(StrTran(Mais1Ini.ReadString(sModulo,'FILTRO',''),'Cliente','CLIFOR'),'Doc. Fiscal','NUMERONF'),'Oramento','PEDIDO');
        //Sandro Silva 2019-09-25 No est agrupando quando lana itens em data diferentes sOrderBy  := 'group by PEDIDO, DATA, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO';
        sOrderBy  := 'group by PEDIDO, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO';
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
        //
      end;
      //
      if sModulo = 'CAIXA' then
      begin
        //
        sAjuda := 'livro.htm';
        //
        // Campos
        //
        sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TFTTTTF');
        iCampos                := 6;
        //
        // Menu
        //
        Form7.Menu         := MainMenu1;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource1.Dataset;
        TabelaAberta           := ibDataSet1;
        DataSourceAtual        := DataSource1;
        //
        // Sql
        //
        sSelect  := 'select * from CAIXA';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy := 'order by DATA, REGISTRO';
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
        //
      end;
      //
      if sModulo = 'BANCOS' then
      begin
        //
        sAjuda := 'bancos.htm';
        //
        // Campos
        //
        Form1.sEscolhido       := Mais1Ini.ReadString(sModulo,'BANCO','Banco do Brasil');
        sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTT');
        iCampos                := 9;
        //
        // Menu
        //
        Form7.Menu                   := MainMenu5;
        Odas3.Checked                    := True;
        Lanamentoscompensados1.Checked   := False;
        Lanamentosnocompensados1.Checked := False;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource5.Dataset;
        TabelaAberta           := ibDataSet5;
        DataSourceAtual        := DataSource5;
        //
        if not Form7.ibDataSet1.active  then
          Form7.ibDataSet1.Open;
        if not Form7.ibDataSet11.active  then
          Form7.ibDataSet11.Open;
        //
        // Sql
        //
        sSelect  := 'select * FROM MOVIMENT';
        sOrderBy := 'order by COMPENS, PREDATA, REGISTRO';
        sWhere   := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        //
        if Pos(AllTrim(Form1.sEscolhido),Mais1Ini.ReadString(sModulo,'FILTRO','')) = 0 then
          sWhere := 'where NOME=' + QuotedStr(Form1.sEscolhido);
        //
        if (Pos(' CONTA=',sWhere) <> 0) then
        begin
          Form7.sTitulo  := 'Conciliao Bancria - '+Form1.sEscolhido;
          Form7.sRPS := 'N';
        end else
        begin
          Form7.sTitulo  := 'Controle bancrio - '+Form1.sEscolhido;
          Form7.sRPS := 'N';
        end;
        //
      end;
      //
      Relatriodecomisses1.Visible := False;
      //
      if (sModulo = 'CLIENTES') or (sModulo = 'VENDEDOR') then
      begin
        //
        if sModulo = 'VENDEDOR' then
        begin
          //
          sAjuda := 'config_vendedores.htm'; // Falta vendedores
          //
          // Menu
          //
          Form7.Menu              := MainMenu9;
          Relatriodecomisses1.Visible := True;
          //
          // Sql
          //
          sSelect   := 'select * from CLIFOR';
          sWhere    := 'where CLIFOR=''Vendedor''';
          //
          sModulo := 'CLIENTES';
          //
        end else
        begin
          //
          sAjuda := 'clifor.htm';
          //
          // Menu
          //
          Form7.Menu         := MainMenu2;
          Mostrartodososclientesefornecedores1.Checked := True;
          //
          // Sql
          //
          sSelect   := 'select * from CLIFOR';
          sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
          //
        end;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource2.Dataset;
        TabelaAberta           := ibDataSet2;
        DataSourceAtual        := DataSource2;
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','FTFTFTFTTTFFFFFTFFFFFFFTFT');
        iCampos   := 27;
        //
        // S FORNECEDORES
        //
        if not Form1.bClientesLiberados then
        begin
          //
          if Pos('where coalesce(CLIFOR,'+QuotedStr('F')+')=',sWhere)=0 then
          begin
            if (alltrim(sWhere)='where') or (alltrim(sWhere)='') then
            begin
              sWhere := 'where coalesce(CLIFOR,'+QuotedStr('F')+')='+QuotedStr('F')+ '';
            end else
            begin
              sWhere := 'where coalesce(CLIFOR,'+QuotedStr('F')+')='+QuotedStr('F')+' and '+ StrTran(sWhere,'where','');
            end;
          end;
          //
          sWhere := StrTran(sWhere,'and and','and'); // corrige um bug
          //
        end;
        //
        // S CLIENTES
        //
        if not Form1.bFornecedoresLiberados then
        begin
          if Pos('where coalesce(CLIFOR,'+QuotedStr('C')+')=',sWhere)=0 then
          begin
            if (alltrim(sWhere)='where') or (alltrim(sWhere)='') then
            begin
              sWhere := 'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+ '';
            end else
            begin
              if Pos('(select',sWhere)=0 then
              begin
                sWhere := 'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+ ' and '+ StrTran(sWhere,'where','');
              end else
              begin
                sWhere := 'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+ ' and '+ StrTran(sWhere,'where (','and (');
              end;
            end;
          end;
          //
          sWhere := StrTran(sWhere,'and and','and'); // corrige um bug
          //
        end;
        //
        if Form7.sWhere  = 'where CLIFOR='+QuotedStr('Vendedor') then
        begin
          Form7.ibDataSet9.Close;                                                    //
          Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
          Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME=:NOME'); //
          Form7.ibDataSet9.DataSource := DataSource2;
          Form7.ibDataSet9.Open;
        end;
        //
      end;
      //
      if sModulo = 'ESTOQUE' then
      begin
        //
        try
          //
          Form7.ibDataSet13.Close;
          Form7.ibDataSet13.Selectsql.Clear;
          Form7.ibDataSet13.Selectsql.Add('select * from EMITENTE');
          Form7.ibDataSet13.Open;
          //
        except end;
        //
        sAjuda := 'estoque.htm';
        //
        if AllTrim(Form7.ibDataSet13ESTADO.AsString) = 'SP' then
        begin
          ibDataSet4CFOP.DisplayLabel          := StrTran(ibDataSet4CFOP.DisplayLabel,'NFC-e','SAT');
          ibDataSet4CSOSN_NFCE.DisplayLabel    := StrTran(ibDataSet4CSOSN_NFCE.DisplayLabel,'NFC-e','SAT');
          ibDataSet4CST_NFCE.DisplayLabel      := StrTran(ibDataSet4CST_NFCE.DisplayLabel,'NFC-e','SAT');
          ibDataSet4ALIQUOTA_NFCE.DisplayLabel := StrTran(ibDataSet4ALIQUOTA_NFCE.DisplayLabel,'NFC-e','SAT');
        end else
        begin
          ibDataSet4CFOP.DisplayLabel          := StrTran(ibDataSet4CFOP.DisplayLabel,'SAT','NFC-e');
          ibDataSet4CSOSN_NFCE.DisplayLabel    := StrTran(ibDataSet4CSOSN_NFCE.DisplayLabel,'SAT','NFC-e');
          ibDataSet4CST_NFCE.DisplayLabel      := StrTran(ibDataSet4CST_NFCE.DisplayLabel,'SAT','NFC-e');
          ibDataSet4ALIQUOTA_NFCE.DisplayLabel := StrTran(ibDataSet4ALIQUOTA_NFCE.DisplayLabel,'SAT','NFC-e');
        end;
        //
        // Menu
        //
        Form7.Menu         := MainMenu4;
        //
        // Arquivo
        //
        Form7.ibDataSet4.EnableControls;
        //
        ArquivoAberto          := DataSource4.Dataset;
        TabelaAberta           := ibDataSet4;
        DataSourceAtual        := DataSource4;
        //
        // Sql
        //
        sSelect   := 'select * FROM ESTOQUE';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','DESCRICAO');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        //
        {Sandro Silva 2023-01-04 inicio
        if Form1.bMKP then
        begin
          sMostra   := 'TFTFTFFFFF'+Replicate('F',39)+'T';
        end else
        begin
          // Sandro Silva 2022-12-20 sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TFTFFFTFFT'+Replicate('F',40));
          sMostra   := Mais1Ini.ReadString(sModulo, 'Mostrar', 'TFTFFFTFFT'+Replicate('F', 41));
        end;
        }
        if Form1.bMKP then
        begin
          sMostra   := 'TFTFTFFFFF'+Replicate('F',40)+'T';
        end else
        begin
          // Sandro Silva 2022-12-20 sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TFTFFFTFFT'+Replicate('F',40));
          sMostra   := Mais1Ini.ReadString(sModulo, 'Mostrar', 'TFTFFFTFFT'+Replicate('F', 42));
        end;
        {Sandro Silva 2023-01-04 fim}

        //
        iCampos   := 50; // Sandro Silva 2023-01-18 iCampos   := 51; // Sandro Silva 2023-01-04 iCampos   := 50;
        {Sandro Silva 2022-12-20 inicio
        if Form1.CampoDisponivelParaUsuario(sModulo, 'IDENTIFICADORPLANOCONTAS') then
          iCampos   := 51;
        {Sandro Silva 2022-12-20 fim}
        //
        //
      end;
      //
      // Receber
      //
      if sModulo = 'RECEBER' then
      begin
        //
//        Form7.ibDataSet2.Close;                                                //
//        Form7.ibDataSet2.Selectsql.Clear;                                      // receber Relacionado
//        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');  //
//        Form7.ibDataSet2.Open;
        //
        sAjuda := 'cr.htm';
        //
        Odas1.Checked          := True;
        Receber2.Checked       := False;
        Jrecebidas2.Checked    := False;
        Atrasadas3.Checked     := False;
        Avencer3.Checked       := False;
        Vencendohoje2.Checked  := False;
        //
        // Campos
        //
        sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTFFFFT');
        iCampos                := 16; // Sandro Silva 2022-12-29 iCampos                := 15;
        //
        // Menu
        //
        Form7.Menu         := MainMenu7;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource7.Dataset;
        TabelaAberta           := ibDataSet7;
        DataSourceAtual        := DataSource7;
        //
        try
          if not Form7.ibDataSet1.active  then
            Form7.ibDataSet1.Open;
        except
          ShowMessage('Erro 11189');
        end;
        //
        // Sql
        //
        sSelect   := 'select * FROM RECEBER';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','VENCIMENTO');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        //
      end;
      //
      // Pagar
      //
      if sModulo = 'PAGAR' then
      begin
        //
        sAjuda := 'cp.htm';
        //
//        Form7.ibDataSet2.Close;
//        Form7.ibDataSet2.Selectsql.Clear;
//        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');
//        Form7.ibDataSet2.Open;
        //
        Form7.odas2.Checked    := True;
        Form7.Pagar2.Checked    := False;
        Form7.Jpagas2.Checked    := False;
        Form7.Atrasadas1.Checked  := False;
        Form7.Avencer1.Checked     := False;
        Form7.Vencendohoje3.Checked := False;
        //
        // Campos
        //
        sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTT');
        iCampos                := 12; // 2022-07-18 iCampos                := 11;
        //
        // Menu
        //
        Form7.Menu         := MainMenu8;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource8.Dataset;
        TabelaAberta           := ibDataSet8;
        DataSourceAtual        := DataSource8;
        //
        try
          if not Form7.ibDataSet1.active then
            Form7.ibDataSet1.Open;
        except
          ShowMessage('Erro 11189');
        end;
        //
        // Sql
        //
        sSelect   := 'select * FROM PAGAR';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','VENCIMENTO');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        //
      end;
      //
      // Tcnicos
      //
      if sModulo = 'TECNICO' then
      begin
        //
        sAjuda := 'config_tecnicos.htm'; // Falta tecnicos
        //
        // Menu
        //
        Form7.Menu         := MainMenu9;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource9.Dataset;
        TabelaAberta           := ibDataSet9;
        DataSourceAtual        := DataSource9;
        //
        // Sql
        //
        Form7.ibDataSet9.Open;
        Form7.ibDataSet9.First;
        sSelect   := 'select * FROM VENDEDOR';
        sWhere    := 'where FUNCAO like '+QuotedStr('%TECNICO%')+' ';
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TFF');
        iCampos   := 1;
        //
        Form7.ibDataSet9COMISSA1.Visible := False;
        Form7.ibDataSet9COMISSA2.Visible := False;
        //
      end;
      //
      // Convenio
      //
      if sModulo = 'CONVENIO' then
      begin
        //
        sAjuda := 'config_convenio.htm'; // Falta convnio
        //
        // Menu
        //
        Form7.Menu         := MainMenu29;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource29.Dataset;
        TabelaAberta           := ibDataSet29;
        DataSourceAtual        := DataSource29;
        //
        // Sql
        //
        sSelect   := 'select * FROM CONVENIO';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTT');
        iCampos   := 5;
        //
      end;
      //
      // CONTAS
      //
      if sModulo = 'CONTAS' then
      begin
        //
        sAjuda := 'config_plano_contas.htm'; // Falta contas
        //
        // Menu
        //
        Form7.Menu         := MainMenu12;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource12.Dataset;
        TabelaAberta           := ibDataSet12;
        DataSourceAtual        := DataSource12;
        //
        // Sql
        //
        sSelect   := 'select * FROM CONTAS';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','CONTA');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTT'); // Sandro Silva 2022-12-19 sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTT');
        iCampos   := 9; // Sandro Silva 2022-12-19 iCampos   := 6;
        //
      end;
      //
      // Tabela de ICM
      //
      if sModulo = 'ICM' then
      begin
        //
        sAjuda := 'config_icms_iss.htm'; // Falta icm
        //
        // Menu
        //
        Form7.Menu         := MainMenu14;
        //
        // Arquivo
        //
        ArquivoAberto          := DataSource14.Dataset;
        TabelaAberta           := ibDataSet14;
        DataSourceAtual        := DataSource14;
        //
        // Sql
        //
        sSelect   := 'select * FROM ICM';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by CFOP';
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := Replicate('T',47);
        iCampos   := 44;
        iCampos   := 5;
        //
      end;
      //
      if sModulo = 'TRANSPORT' then
      begin
        //
        sAjuda := 'config_transportadoras.htm'; // Falta tranport
        //
        // Menu
        //
        Form7.Menu := MainMenu6;
        //
        // Arquivo
        //
        ArquivoAberto   := DataSource18.Dataset;
        TabelaAberta    := ibDataSet18;
        DataSourceAtual := DataSource18;
        //
        // Sql
        //
        sSelect   := 'select * FROM TRANSPOR';
        sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
        sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
        sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
        sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
        sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
        sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTFTTTFTFTT');
        iCampos   := 11;
        //
      end;
      //
      if sModulo = 'GRUPOS' then
      begin
        //
        sAjuda := 'est_grupos.htm'; // Falta grupo
        //
        Form7.Menu         := MainMenu99;
        //
        ArquivoAberto   := DataSource21.Dataset;
        TabelaAberta    := ibDataSet21;
        DataSourceAtual := DataSource21;
        //
        sSelect   := 'select * FROM GRUPO';
        sWhere    := '';
        sOrderBy  := 'order by upper(NOME)';
        sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','T');
        iCampos   := 1;
        //
      end;
      //
      if sModulo = '2CONTAS' then
      begin
        //
        Image209.Visible := False; // Filtros
        Label209.Visible := False;
        //
        sAjuda := 'bancos.htm'; // Falta contas bancrias
        //
        Form7.Menu := MainMenu99;
        //
        ArquivoAberto   := DataSource11.Dataset;
        TabelaAberta    := ibDataSet11;
        DataSourceAtual := DataSource11;
        //
        sSelect   := 'select * FROM BANCOS';
        sWhere    := '';
        sOrderBy  := 'order by upper(NOME)';
        sREgistro := '0000000001';
        sMostra   := 'TTTTT';
        iCampos   := 5;
        //
      end else
      begin
        Image209.Visible := True; // Filtros
        Label209.Visible := True;
      end;
      //
      // dBGrid
      //
      TabelaAberta.DisableControls;
      //
      try
        Form7.DBGrid1.Options := [dgTitles, dgColLines, dgRowLines, dgTabs, dgColumnResize]; // 2CONTAS
        (*
        with ArquivoAberto do
        begin
          try
            for I := 1 to iCampos do
            begin
              if copy(sMostra+'FFFFFFFFFFFFFFFFFFFF',I,1) = 'F' then
                Fields[I-1].Visible := False
              else
                Fields[I-1].Visible := True;

              {Sandro Silva 2022-12-16 inicio // Sandro Silva 2023-01-09
              if sModulo = 'ESTOQUE' then
              begin
                if ArquivoAberto.Fields[I-1].FieldName = 'IDENTIFICADORPLANOCONTAS' then
                begin
                  ArquivoAberto.Fields[I-1].Visible := Form1.CampoDisponivelParaUsuario(sModulo, ArquivoAberto.Fields[I-1].FieldName);
                end;
              end;
              {Sandro Silva 2022-12-16 fim}


              {Sandro Silva 2022-12-16 inicio}
              if sModulo = 'RECEBER' then
              begin
                if ArquivoAberto.Fields[I-1].FieldName = 'MOVIMENTO' then
                begin
                  ArquivoAberto.Fields[I-1].Visible := Form1.DisponivelSomenteParaNos;
                end;
              end;
              {Sandro Silva 2022-12-16 fim}

            end;
          except
          end;
        end;
        *)

        try
          for I := 1 to iCampos do
          begin
            ArquivoAberto.Fields[I-1].Visible := True;
            if copy(sMostra+'FFFFFFFFFFFFFFFFFFFF',I,1) = 'F' then
              ArquivoAberto.Fields[I-1].Visible := False;

            {Sandro Silva 2022-12-16 inicio // Sandro Silva 2023-01-09
            if sModulo = 'ESTOQUE' then
            begin
              if ArquivoAberto.Fields[I-1].FieldName = 'IDENTIFICADORPLANOCONTAS' then
              begin
                ArquivoAberto.Fields[I-1].Visible := Form1.CampoDisponivelParaUsuario(sModulo, ArquivoAberto.Fields[I-1].FieldName);
              end;
            end;
            {Sandro Silva 2022-12-16 fim}


            {Sandro Silva 2022-12-16 inicio}
            if sModulo = 'RECEBER' then
            begin
              if ArquivoAberto.Fields[I-1].FieldName = 'MOVIMENTO' then
              begin
                ArquivoAberto.Fields[I-1].Visible := Form1.DisponivelSomenteParaNos;
              end;
            end;
            {Sandro Silva 2022-12-16 fim}

          end;
        except
        end;

      except
      end;
      //
      // Visual
      //
      iIconeCom := 70;
      //
      Form7.MenuItem61.Enabled := True;
      Form7.MenuItem62.Enabled := True;
      Form7.MenuItem63.Enabled := True;
      Form7.Ativo5.Enabled     := True;
      //
      if Form7.bSoLeitura then
      begin
        //
        try
          if Form7.Menu <> MainMenu99 then
          begin
            //
            if sModulo <> 'RECEBER' then Form7.Menu.Items[1].Enabled := False else
            begin
              Form7.MenuItem61.Enabled := False;
              Form7.MenuItem62.Enabled := False;
              Form7.MenuItem63.Enabled := False;
              Form7.Ativo5.Enabled     := False;
            end;
            //
            Image201.Visible := False;
            Image202.Visible := False;
            Image208.Visible := False; Form7.Label208.Caption  := 'Bloquear';
            Image308.Visible := False;
            //
            //
            Label201.Visible := False;
            Label202.Visible := False;
            Label208.Visible := False;
            //
          end;
        except
        end;
        //
      end else
      begin
        //
        try
          if (Form7.Menu <> MainMenu99) or  (sModulo = 'GRUPOS') or (sModulo = 'TRANSPORT')  then
          begin
            //
            Image201.Visible := True;
            Image202.Visible := True;
            Image208.Visible := True; Form7.Label208.Caption  := 'Liberar';
            //
            Label201.Visible := True;
            Label202.Visible := True;
            Label208.Visible := True;
            //
            if (Form7.Menu <> MainMenu99) then
              Form7.Menu.Items[1].Enabled := True;
            //
          end;
          //
        except
        end;
        //
      end;
      //
      try
        if not Form7.bSoLeitura then
        begin
          Form7.Image308.Visible  := False;
          Form7.Image208.Visible  := True; Form7.Label208.Caption  := 'Liberar';
          Form7.Label208.Visible  := True;
        end;
        if (sModulo = 'NOTA') or (sModulo = 'CONCILIACAO') or (Form7.sModulo = 'CONFOS') or (Form7.sModulo = 'CONFRECIBO') then
        begin
          Form7.DBGrid1.Options  := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs]; // NOTA CONCILIACAO CONFOS CONFRECIBO
          Form7.dbGrid1.ReadOnly := False;
        end;
      except
      end;
      //
  //  except end;
    //
    // Abre e posiciona
    //
    Image209.Visible := True;
    Image206.Visible := True;
    Image201.Visible := True;
    Label209.Visible := True;
    Label206.Visible := True;
    Label201.Visible := True;
    //
    if (sModulo = 'TECNICO') then
    begin
      Image209.Visible := False;
      Label209.Visible := False;
    end;
    //
    if sModulo = 'ICM' then
    begin
{
      Image209.Visible := False;
      Image206.Visible := False;
      Image201.Visible := False;
      Label209.Visible := False;
      Label206.Visible := False;
      Label201.Visible := False;
}
    end;
    //
    if sModulo = 'ORCAMENTO' then
    begin
      Image202.Visible := False;
      Label202.Visible := False;
      Image206.Visible := False;
      Label206.Visible := False;
    end;
    //
    if sModulo = 'VENDA' then
    begin
      Image202.Visible := False;
      Label202.Visible := False;
    end;
    //
    if (sModulo = 'COMPRA') or (sModulo = 'VENDA') or (sModulo = 'OS') then
    begin
      Image308.Visible := False;
      Image208.Visible := False; Form7.Label208.Caption  := 'Bloquear';
      Label208.Visible := False;
    end;
    //
    if (sModulo = 'OS') then
    begin
      Image202.Visible := False; // No pode apagar DAV
      Label202.Visible := False;
    end;
    //
    iLeft := 2+5;
    //
    if Image201.Visible then
    begin
      Image201.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image202.Visible then
    begin
      Image202.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image203.Visible then
    begin
      Image203.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image205.Visible then
    begin
      Image205.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image204.Visible then
    begin
      Image204.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image206.Visible then
    begin
      Image206.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image208.Visible then
    begin
      Image208.Left := iLeft ;
      Image308.Left := Image208.Left;
      iLeft := iLeft + iIconeCom;
    end;
    //
    if Image209.Visible then
    begin
      Image209.Left := iLeft ;
//      iLeft := iLeft + iIconeCom;
    end;
    //
    if (AllTrim(sWhere)     = 'where')     then swhere   := '';
    if (UpperCase(sOrderBy) = 'ORDER BY NOME')      then
    begin
      if sModulo = 'ESTOQUE' then
      begin
        sOrderBy := 'order by upper(NOME), upper(DESCRICAO)';
      end else
      begin
        sOrderBy := 'order by upper(NOME)';
      end;
    end;
    if (UpperCase(sOrderBy) = 'ORDER BY DESCRICAO') then sOrderBy := 'order by upper(DESCRICAO)';
    //
    if (AllTrim(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(AllTrim(UpperCase(TabelaAberta.SelectSQL.Text)),Chr(10),''),Chr(13),''),'COALESCE(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA''',''),'  ',' '),'WHERE ORDER','ORDER'),'AND ORDER','ORDER'))
    <> AllTrim(StrTran(StrTran(StrTran(AllTrim(UpperCase(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy))),Chr(10),''),Chr(13),''),'  ',' '))) or (not TabelaAberta.Active) then
    begin
      //
      // Este bloco tem toda a demora
      //
      begin
        //
//        ShowMessage(
//        (StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(AllTrim(UpperCase(TabelaAberta.SelectSQL.Text)),Chr(10),''),Chr(13),''),'COALESCE(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA''',''),'  ',' '),'WHERE ORDER','ORDER'),'AND ORDER','ORDER')+
//        Chr(10)+StrTran(StrTran(StrTran(AllTrim(UpperCase(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy))),Chr(10),''),Chr(13),''),'  ',' '))
//        );
        //
        try
          //
          TabelaAberta.Close;
          TabelaAberta.SelectSQL.Clear;
          //
          if (sModulo = 'VENDA') and (pos('and',sWhere)=0) then
          begin
            //
            // Filtro auxiliar
            //
            TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' and EMISSAO >'+QuotedStr( DateToStrInvertida(DATE - 30) )+' '+AllTrim(sOrderBy));
            //
          end else
          begin
            if (sModulo = 'RECEBER') then
            begin
              if sWhere <> '' then
              begin
                TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' and coalesce(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA'' '+AllTrim(sOrderBy));
              end else
              begin
                TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' where coalesce(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA'' '+AllTrim(sOrderBy));
              end;
            end else
            begin
              TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy));
            end;
          end;
          //
          TabelaAberta.Open;
          //
        except
          on E: Exception do
          begin
            sWhere   := '';
            if Form7.sModulo <> 'ORCAMENTO' then
            begin
              Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+TabelaAberta.SelectSQL.Text+chr(10)+chr(10)
              ),'Erro: 2211',mb_Ok + MB_ICONWARNING);
              sOrderBy := ''
            end else
            begin
              //Sandro Silva 2019-09-25 No est agrupando quando lana itens em data diferentes sOrderBy  := 'group by PEDIDO, DATA, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO';
              sOrderBy  := 'group by PEDIDO, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO';
            end;
            //
            TabelaAberta.Close;
            TabelaAberta.SelectSQL.Clear;
            TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy));
            TabelaAberta.Open;
          end;
        end;
      end;
      //
    end;
    //
    if (sModulo <> 'CAIXA') and (sModulo <> 'BANCOS') then
    begin
      try
        if not bFirst then
        begin
          if not TabelaAberta.Locate('REGISTRO',sRegistro,[]) then
            TabelaAberta.Last;
        end else
        begin
          bFirst := False;
        end;
      except
        TabelaAberta.First;
      end;
    end
    else
      TabelaAberta.Last;
    //
    dbGrid1.DataSource := DataSourceAtual;
    //
    try
      if StrToInt('0'+LimpaNumero(sLinha)) <> 0 then
      begin
        I := TabelaAberta.MoveBy(StrToInt('0'+LimpaNumero(sLinha))*-1);
        TabelaAberta.MoveBy(I*-1);
      end;
    except
    end;
    //
    try
      dbGrid1.SelectedIndex := StrToInt('0'+LimpaNumero(sColuna));
    except
      dbGrid1.SelectedIndex := 0;
    end;
    //
    // Este bloco tem toda a demora
    //
    Panel7.Top      := dbGrid1.Top + dbGrid1.Height -1;
    Panel7.Left     := dbGrid1.Left;
    Panel7.width    := dbGrid1.Width;
    //
    Form7.Panel7.Caption   := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    //
    //  Panel7.Visible  := True;
    //
    if Image201.Visible then
      MostraLabels(Form7.Image201,Form7.Label201);
    if Image202.Visible then
      MostraLabels(Form7.Image202,Form7.Label202);
    if Image203.Visible then
      MostraLabels(Form7.Image203,Form7.Label203);
    if Image204.Visible then
      MostraLabels(Form7.Image204,Form7.Label204);
    if Image205.Visible then
      MostraLabels(Form7.Image205,Form7.Label205);
    if Image206.Visible then
      MostraLabels(Form7.Image206,Form7.Label206);
    if Image209.Visible then
      MostraLabels(Form7.Image209,Form7.Label209);
    if Image203.Visible then
      MostraLabels(Form7.Image203,Form7.Label203);
    if Image208.Visible then
      MostraLabels(Form7.Image208,Form7.Label208);
    //
    try
      if (sModulo = 'NOTA') or (Form7.sModulo = 'CONFOS') or (Form7.sModulo = 'CONFRECIBO') then
      begin
        Form4.Show;
        Form4.FormClick(Sender);
        TabelaAberta.EnableControls;
      end;
    except end;
    //
  except
    //
    on E: Exception do
    begin
      ShowMessage('Erro: 673 "'+E.Message+'"');
      Form7.DestroyWindowHandle;
      Application.Terminate;
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
    end;
    //
  end;
  //
  try
    //
    if sModulo = 'CAIXA' then
    begin
      //
      // S Calcula o Saldo quando houve realmente alguma alterao no GDB
      // talvez um dia criar um generator somente para o caixa.
      //
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,0) from rdb$database');
      Form7.ibDataset101.Open;
      //
      if (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat <> Form7.fMutado3) then // or (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat = 0) then
      begin
        //
        Form7.fMutado3 := Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat;
        CalculaSaldo(False);
        TabelaAberta.Last;
        //
      end;
    end;
    //
    if sModulo = 'BANCOS' then
    begin
      //
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,0) from rdb$database');
      Form7.ibDataset101.Open;
      //
      if (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat <> Form7.fMutado3) then // or (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat = 0) then
      begin
        //
        Form7.fMutado3 := Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat;
        SaldoBanco(True);
        TabelaAberta.Last;
        //
      end;
    end;
    //
    try
      if TabelaAberta.Active then
      begin
        if TabelaAberta.MoveBy(+1) = 1 then
          TabelaAberta.MoveBy(-1)
        else if TabelaAberta.MoveBy(-1) = -1 then
          TabelaAberta.MoveBy(+1);
      end;
    except
      TabelaAberta.First;
    end;
    //
    try
      //
      if Form7.DBGrid1.CanFocus then Form7.DBGrid1.SetFocus;
      //
      ArquivoAberto.EnableControls;
      //
      Form7.Menu:= Form7.Menu;
      //
      Mais.LeLabels(True);
      AbreArquivos(True);
      //
    except
    //  on E: Exception do
    //  begin
    //    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao abrir arquivos'
    //    ),'Ateno',mb_Ok + MB_ICONWARNING);
    //  end;
    end;
  except end;
  //
  // Se no existe cria o layout da nova nota
  //
  //
  if sModulo = 'RECEBER' then
  begin
    btnRetornoCNAB400.Visible := True; // Sandro Silva 2022-12-21 Button1.Visible := True;
  end;
  //
  Form7.AlphaBlendValue := 255;
  TabelaAberta.EnableControls;
  //
  DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
  Form7.Panel7.Hint := 'Tempo: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0) + ' ';
  Form7.Panel7.ShowHint := True;
  //
  Screen.Cursor := crDefault;
  //
end;

procedure TForm7.DBGrid1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  //
  Form7.iKey := Key;
  //
  if Key = VK_F11  then
    Form7.Agrupar1Click(Sender);
  if Key = VK_F3   then
    Form20.Button1Click(Sender);
  if Key = VK_F5   then
  begin
    Screen.Cursor            := crHourGlass;
    AgendaCommit(True);
    //
    Form7.Close;
    Form7.Show;
    //
    Screen.Cursor            := crDefault;
  end;
  //
end;

procedure TForm7.Imprimircheque1Click(Sender: TObject);
begin
  Form23.ShowModal;
end;

procedure TForm7.ibDataSet24MERCADORIAChange(Sender: TField);
begin
  //
  if Alltrim(Form7.ibDataSet24FRETE12.AsString) <> '1' then
  begin
     Form7.ibDataSet24TOTAL.AsFloat := Form7.ibDataSet24MERCADORIA.AsFloat -
                                 Form7.ibDataSet24DESCONTO.AsFloat     +
                                 Form7.ibDataSet24SERVICOS.AsFloat     +
                                 Form7.ibDataSet24ICMSSUBSTI.AsFloat   +
                                 Form7.ibDataSet24DESPESAS.AsFloat     +
                                 Form7.ibDataSet24SEGURO.AsFloat       +
                                 Form7.ibDataSet24IPI.AsFloat;
   end else
   begin
     Form7.ibDataSet24TOTAL.AsFloat := Form7.ibDataSet24MERCADORIA.AsFloat -
                                 Form7.ibDataSet24DESCONTO.AsFloat     +
                                 Form7.ibDataSet24SERVICOS.AsFloat     +
                                 Form7.ibDataSet24ICMSSUBSTI.AsFloat   +
                                 Form7.ibDataSet24DESPESAS.AsFloat     +
                                 Form7.ibDataSet24FRETE.AsFloat        +
                                 Form7.ibDataSet24SEGURO.AsFloat       +
                                 Form7.ibDataSet24IPI.AsFloat;
   end;
   //
   if Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '3' then
     Form7.ibDataSet24TOTAL.AsFloat := Form7.ibDataSet24TOTAL.AsFloat + Form7.ibDataSet24ICMS.AsFloat;
   //
end;

procedure TForm7.ibDataSet2BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo VENDAS e o arquivo RECEBER }
  sNumeroAnterior := ibDataSet2REGISTRO.AsString;
  sNomeAnterior   := ibDataSet2NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet5ENTRADA_Change(Sender: TField);
begin
  //
  if ibDataSet5ENTRADA_.AsFloat < 0 then
    ibDataSet5ENTRADA_.AsFloat := 0;
  if ibDataSet5ENTRADA_.AsFloat <> 0 then
  begin
    if ibDataSet5SAIDA_.AsFloat <> 0 then
      ibDataSet5SAIDA_.AsFloat := 0;
  end;
  if Form7.sModulo = 'BANCOS' then
    SaldoBanco(True);
  ibDataSet5.Edit;
  //
end;

procedure TForm7.ibDataSet5SAIDA_Change(Sender: TField);
begin
  if ibDataSet5SAIDA_.AsFloat < 0 then
    ibDataSet5SAIDA_.AsFloat := 0;
  if ibDataSet5SAIDA_.AsFloat <> 0 then
  begin
    if ibDataSet5ENTRADA_.AsFloat <> 0 then
      ibDataSet5ENTRADA_.AsFloat := 0;
  end;
  if Form7.sModulo = 'BANCOS' then
    SaldoBanco(True);
  ibDataSet5.Edit;
  //
end;

procedure TForm7.ibDataSet1ENTRADAChange(Sender: TField);
begin
  //
//  try
//    if ibDataSet1ENTRADA.AsFloat < 0 then ibDataSet1ENTRADA.AsFloat := 0;
//    if ibDataSet1ENTRADA.AsFloat <> 0 then if ibDataSet1SAIDA.AsFloat <> 0 then ibDataSet1SAIDA.AsFloat := 0;
//  except end;  
  //
  if sModulo = 'CAIXA' then CalculaSaldo(True);
  IntegraBanco(Sender);
  ibDataSet1.Edit;
  //
end;

procedure TForm7.ibDataSet1SAIDAChange(Sender: TField);
begin
  //
//  try
//    if ibDataSet1SAIDA.AsFloat < 0 then ibDataSet1SAIDA.AsFloat := 0;
//    if ibDataSet1SAIDA.AsFloat <> 0 then if ibDataSet1ENTRADA.AsFloat <> 0 then ibDataSet1ENTRADA.AsFloat := 0;
//  except end;
  //
  if sModulo = 'CAIXA' then CalculaSaldo(True);
  IntegraBanco(Sender);
  ibDataSet1.Edit;
  //
end;

procedure TForm7.ibDataSet2NOMESetText(Sender: TField; const Text: String);
begin
  if (AllTrim(ibDataSet2NOME.AsString) <> '') and (AllTrim(Text) = '') then
  begin
    ShowMessage('Nome invlido (no pode ficar em branco).');
  end else
  begin
    if Valida_Campo('CLIFOR',AllTrim(Text),'NOME','Este cliente j foi cadastrado') then
      ibDataSet2NOME.AsString := AllTrim(Text);
  end;
end;

procedure TForm7.ibDataSet4BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo VENDAS e o arquivo RECEBER }
  sNumeroAnterior     := ibDataSet4REGISTRO.AsString;
  sNomeAnterior       := ibDataSet4DESCRICAO.AsString;
  fQuantidadeAnterior := ibDataSet4QTD_ATUAL.AsFloat;
  fPrecoAnterior      := Form7.ibDataSet4PRECO.AsFloat;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet4DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  if (AllTrim(ibDataSet4DESCRICAO.AsString) <> '') and (AllTrim(Text) = '') then
  begin
    ShowMessage('Descrio invlida (no pode ficar em branco).');
  end else
  begin
    if Valida_Campo('ESTOQUE',Text,'DESCRICAO','Este produto j foi cadastrado') then
    ibDataSet4DESCRICAO.AsString := Text;
  end;
end;

procedure TForm7.ibDataSet4NewRecord(DataSet: TDataSet);
var
  sCodigo : String;
begin
  //
  if Form7.iKey = VK_Down then
  begin
    iKey := 0;
    Abort;
  end else
  begin
    //
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select gen_id(G_CODIGO,1) from rdb$database');
    IBDataSet99.Open;
    sCodigo := StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),5,0);
    IBDataSet99.Close;
    //
    Form7.sModulo := 'XXXXXXXX';
    //
    sNomeAnterior := ''; //  usado quando se altera o nome do produto
    ibDataSet4CODIGO.ReadOnly       := False;
    ibDataSet4REGISTRO.AsString     := sProximo;
    ibDataSet4CODIGO.AsString       := sCodigo;
    ibDataSet4PRECO.AsFloat         := 0.01;
    ibDataSet4CUSTOCOMPR.AsFloat    := 0;
    ibDataSet4CUSTOMEDIO.AsFloat    := 0;
    ibDataSet4QTD_ATUAL.AsFloat     := 0;
    ibDataSet4QTD_MINIM.AsFloat     := 0;
    ibDataSet4QTD_INICIO.AsFloat    := 0;
    ibDataSet4PESO.AsFloat          := 0;
    ibDataSet4IPI.AsFloat           := 0;
    ibDataSet4IPPT.AsString         := 'T';
    ibDataSet4IAT.AsString          := 'T';
    ibDataSet4DAT_INICIO.AsDateTime := Date;

    ibDataSet4FATORC.AsFloat        := 1;
    ibDataSet4MEDIDA.AsString       := 'UND';
    ibDataSet4MEDIDAE.AsString      := 'UND';
    //
    ibDataSet4CODIGO.ReadOnly       := True;
    //
    ibDataSet4.Post;
    ibDataSet4.Edit;
    //
    AgendaCommit(True);
    //
    Form7.sModulo := 'ESTOQUE';
    //
  end;
  //
end;

procedure TForm7.Fluxodecaixa2Click(Sender: TObject);
begin
  Form27.ShowModal;
end;

procedure TForm7.ibDataSet7NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet7REGISTRO.AsString     := sProximo;
{
  //
  // Nosso Numero
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_NN,1) from rdb$database');
    ibDataset99.Open;
    ibDataSet7NN.AsString := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
}
  //
  if Form7.sModulo = 'VENDA' then
    ibDataSet7NUMERONF.AsString  := Form7.ibDataSet15NUMERONF.AsString;
  //
  ibDataSet7VALOR_RECE.AsFloat    := 0;
  ibDataSet7VALOR_DUPL.AsFloat    := 0;
  ibDataSet7VALOR_JURO.ReadOnly   := False;
  ibDataSet7VALOR_JURO.AsFloat    := 0;
  ibDataSet7VALOR_JURO.ReadOnly   := True;
  ibDataSet7EMISSAO.AsDateTime    := Date;
  //
  // Sugere sempre a data de vencimento de acordo com a configurao
  //
  ibDataSet7VENCIMENTO.AsDateTime := Date + StrtoInt('0'+Limpanumero(Form19.MaskEdit4.Text));
  ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
  //
end;

procedure TForm7.ibDataSet4QTD_ATUALChange(Sender: TField);
begin
  //
  try
    if Form7.sModulo = 'ESTOQUE' then
    begin
      //
      //
      // Grade
      //
      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;
      //
      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
      begin
        //
        // Grade - Alterao na ficha da mercadoria
        //
        Form1.rReserva := 0;
        Form13.Label1.Caption := 'Alterao na ficha da mercadoria';
        Form13.ShowModal; // Alterao na ficha da mercadoria
        //
        // alterado para no poder mais cancelar a alterao na quantidade clicando no cancelar
        //
      end;
      //
      if Form7.bFabrica then
      begin
        //
        if not ibDataSet27.Active then
          ibDataSet27.Open;
        //
        ibDataSet27.Append;
        ibDataSet27DATA.AsDateTime     := Date;
        ibDataSet27CODIGO.AsString     := ibDataSet4CODIGO.AsString;
        ibDataSet27DESCRICAO.AsString  := ibDataSet4DESCRICAO.AsString;
        ibDataSet27QUANTIDADE.AsFloat  := ibDataSet4QTD_ATUAL.AsFloat - fQuantidadeAnterior;
        ibDataSet27TIPO.AsString       := 'FABRIC';
        ibDataSet27MEDIDA.AsString     := ibDataset4MEDIDA.AsString;
        ibDataSet27VENDEDOR.AsString   := Senhas.Usuario.Text;
        ibDataSet27.Post;
        //
        fQuantidadeAnterior := ibDataSet4QTD_ATUAL.AsFloat;
        //
      end;
      //
    end;
  except end;
  //
end;

procedure TForm7.ibDataSet1BeforeDelete(DataSet: TDataSet);
begin
  //
  if sModulo = 'CAIXA' then
  begin
    Audita('APAGOU', sModulo, Senhas.UsuarioPub,
    ibDataSet1DATA.AsString + ' - ' + Alltrim(ibDataSet1HISTORICO.AsString),
    ((ibDataSet1SAIDA.AsFloat*-1)+ibDataSet1ENTRADA.AsFloat)
    ,0);   // Ato, Modulo, Usurio, Histrico
  end;
  //
end;

procedure TForm7.ibDataSet5BeforeDelete(DataSet: TDataSet);
begin
  //
  if sModulo = 'BANCOS' then
  begin
    Audita('APAGOU', sModulo, Senhas.UsuarioPub,
    Alltrim(ibDataSet5EMISSAO.AsString +' - ' +Alltrim(ibDataSet5DOCUMENTO.AsString + ' - ' + ibDataSet5HISTORICO.AsString)),
    ((ibDataSet5SAIDA_.AsFloat*-1)+ibDataSet5ENTRADA_.AsFloat)
    ,0);   // Ato, Modulo, Usurio, Histrico
  end;
  //
end;

procedure TForm7.FormClose(Sender: TObject; var Action: TCloseAction);
var
  Mais1ini : tIniFile;
//  tInicio : tTime;
//  Hora, Min, Seg, cent : Word;
begin
  //
  try
    //
    if Form7.sTitulo = 'Cadastro dos vendedores' then
      sModulo := 'VENDEDOR'; // No grava o Filtro registro coluna etc
    //
    if (sModulo <> 'CONFIG') and (Alltrim(sModulo)<>'') and (TabelaAberta.Active) then
    begin
//      tInicio := Time;
      Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
      //
      if Form7.sRPS = 'S' then //ver onde est setando para 'S'
      begin
        sModulo := 'RPS';
      end;
      //
      if AllTrim(Form7.sWhere) = 'where' then
        Form7.sWhere := '';
      Mais1Ini.WriteString(sModulo,'FILTRO',AllTrim(Form7.sWhere));
      Mais1Ini.WriteString(sModulo,'REGISTRO',TabelaAberta.FieldByName('REGISTRO').AsString);
      Mais1Ini.WriteString(sModulo,'COLUNA',StrZero(DbGrid1.SelectedIndex,2,0));
      Mais1Ini.WriteString(sModulo,'LINHA',StrZero(TStringGrid(DBGrid1).Row,4,0));
      Mais1Ini.Free;
      //
//aqui sempre est apontando para mdulo de vendas, por qu?
      if sModulo = 'RPS' then
      begin
        sModulo := 'VENDA';
      end;
      //
//      DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
    end;
    //
  except
  end;
  //
  try
    //
    if Form9.Visible  then
      Form9.Close;
    if Form14.Visible then
      Form14.Close;
    if Form21.Visible then
      Form21.Close;
    if Form20.Visible then
      Form20.Close;
    if Form16.Visible then
      Form16.Close;
    if Form4.Visible  then
      Form4.Close;
    //
  except
  end;
  //
  try
    //
    Form38.Caption := 'Cancelar';
    Form6.Tag := 36;
    //
    if Form7.sModulo = 'COMPRA' then
    begin
      Form1.AvisoNFECompra(True);
    end;
    //
    if Form7.sModulo = 'CAIXA' then
    begin
      Form1.AvisoCaixa(True);
    end;
    //
    if Form7.sModulo = 'BANCOS' then
    begin
      Form1.AvisoBanco(True);
    end;
    //
    if Form7.sModulo = 'ESTOQUE' then
    begin
      Form1.AvisoEstoque(True);
    end;
    //
    if Form7.sModulo = 'PAGAR' then
    begin
      Form1.AvisoPagar(True);
    end;
    //
    if Form7.sModulo = 'OS' then
    begin
      Form1.AvisoOS(True);
    end;
    //
    if Form7.sModulo = 'RECEBER' then
    begin
      Form1.AvisoReceber(True);
    end;
    //
    if Form7.sModulo = 'CLIENTES' then
    begin
      Form1.AvisoCliFor(True);
    end;
    //
    Form1.AvisoIndicadores(True);
    //
  except
  end;
  //
  try
    dbGrid1.DataSource := Form7.DataSource13;
  except
  end;
  //
end;

procedure TForm7.RegistroFiscal1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\sintegra.exe') then
    ShellExecute( 0, 'Open', 'sintegra.exe', '', '', SW_SHOW)
  else
    ShowMessage('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.');
end;

procedure TForm7.Aumentodepreo1Click(Sender: TObject);
begin
  Form34.ShowModal;
end;

procedure TForm7.ibDataSet2ESTADOSetText(Sender: TField; const Text: String);
begin
  if (Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0) and (AllTrim(Text)<>'') then
  begin
//   raise Exception.Create('Estado invlido');
    ShowMessage('Estado invlido');
    ibDataSet2ESTADO.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end
  else
    ibDataSet2ESTADO.AsString := UpperCase(Text);
end;


procedure TForm7.ibDataSet13ESTADOSetText(Sender: TField; const Text: String);
begin
  if (Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0) and (AllTrim(Text)<>'') then
  begin
    ShowMessage('Estado invlido');
    Form7.ibDataSet13ESTADO.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end
  else
    Form7.ibDataSet13ESTADO.AsString := UpperCase(Text);
end;

procedure TForm7.ibDataSet15VOLUMESChange(Sender: TField);
begin
  ibDataSet15.Edit;
  if ibDataSet15VOLUMES.AsFloat = 0 then
  begin
    ibDataSet15ESPECIE.AsString := '';
    ibDataSet15MARCA.AsString   := '';
  end;
  if ibDataSet15VOLUMES.AsFloat = 1 then
  begin
    if ibDataSet15ESPECIE.AsString = '' then
      ibDataSet15ESPECIE.AsString := 'CAIXA';
    if ibDataSet15MARCA.AsString   = '' then
      ibDataSet15MARCA.AsString   := 'VARIAS';
  end;
  if ibDataSet15VOLUMES.AsFloat > 1 then
  begin
    if ibDataSet15ESPECIE.AsString = '' then
      ibDataSet15ESPECIE.AsString := 'CAIXAS';
    if ibDataSet15MARCA.AsString   = '' then
      ibDataSet15MARCA.AsString   := 'VARIAS';
  end;
end;

procedure TForm7.ibDataSet12BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo CAIXA                      }
  sNumeroAnterior := ibDataSet12REGISTRO.AsString;
  sNomeAnterior   := ibDataSet12NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet12AfterPost(DataSet: TDataSet);
var
  sNomeNovo : String;
  sNomeVolta : String;
begin
  //
  // PLANO DE CONTAS
  //
  if (sNomeAnterior <> ibDataSet12NOME.AsString) and (sNomeAnterior <> '') and (sNumeroAnterior = ibDataSet12REGISTRO.AsString) then
  begin
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    sNomeNovo  := ibDataSet12NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // CAIXA
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update CAIXA set NOME='+QuotedStr(sNomeNovo)+' where NOME='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    // PAGAR
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update PAGAR set CONTA='+QuotedStr(sNomeNovo)+' where CONTA='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    // RECEBER
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update RECEBER set CONTA='+QuotedStr(sNomeNovo)+' where CONTA='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    // ICM
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update ICM set CONTA='+QuotedStr(sNomeNovo)+' where CONTA='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    Screen.Cursor := crDefault;
    //
  end;
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.Relatriodecomisses1Click(Sender: TObject);
begin
  //
  Form37.Caption := 'Relatrio de comisses';
  if AllTrim(Form7.ibDataSet9NOME.AsString) = '' then
  begin
    ShowMessage('Nome do vendedor invlido.');
    Abort;
  end
  else
    Form37.ShowModal;
  //
end;

procedure TForm7.Resumodasvendas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Resumo das vendas';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Histrico1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Histrico';
  Form38.ShowModal;
  sModulo := sModuloAnterior;
  if Form38.Caption <> 'Cancelar' then
    Form10.Image203Click(Sender);
  Form7.ArquivoAberto.EnableControls;
  //
end;

procedure TForm7.ibDataSet7AfterPost(DataSet: TDataSet);
begin
//  if ibDataSet7.IndexFieldNames <> '' then
  begin
    if form7.SModulo = 'RECEBER' then
      if (Alltrim(ibDataSet7DOCUMENTO.AsString) = '') and (ibDataSet7VALOR_DUPL.AsFloat <> 0) then
        ShowMessage('O nmero da duplicata deve ser preenchido.');
  end;
  //
  AgendaCommit(True);
  //
  Form1.ibQuery2.Close;
  Form1.ibQuery2.SQL.Clear;
  Form1.ibQuery2.SQL.Add('set generator G_GRAFICO_RECEBER to 0');
  Form1.ibQuery2.ExecSQL;
  //
end;


procedure TForm7.ibDataSet7VALOR_RECEChange(Sender: TField);
begin
  //
  if ibDataSet7VALOR_RECE.AsFloat < 0 then ibDataSet7VALOR_RECE.AsFloat := 0;
  //
end;

procedure TForm7.ibDataSet4REFERENCIASetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(Text) = '' then ibDataSet4REFERENCIA.AsString := '' else
  begin
    if Valida_Campo('ESTOQUE',Text,'REFERENCIA','Esta referncia j foi cadastrada') then
        ibDataSet4REFERENCIA.AsString := Text;
  end;
end;

procedure TForm7.ibDataSet12NewRecord(DataSet: TDataSet);
begin
  ibDataSet12REGISTRO.AsString := sProximo;
  sNomeAnterior := '';
end;

procedure TForm7.ibDataSet3NewRecord(DataSet: TDataSet);
var
  sNumero : String;
begin
  //
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_NUMEROOS,1) from rdb$database');
  IBDataSet99.Open;
  sNumero := StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0);
  IBDataSet99.Close;
  //
  try
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select OBSERVACAO from OS where NUMERO='+QuotedStr(StrZero( StrtoFloat(AllTrim( sNumero ))-1,10,0))+' ');
    IBDataSet99.Open;
  except end;
  //
  //
  ibDataSet3REGISTRO.AsString   := sProximo;
  ibDataSet3NUMERO.AsString     := sNumero;
  ibDataSet3DATA.AsDateTime     := Date;
  ibDataSet3HORA.AsString       := TimeToStr(Time);
  ibDataSet3TEMPO.AsString      := '00:45';
  ibDataSet3SITUACAO.AsString   := 'Agendada';
  try
    ibDataSet3OBSERVACAO.AsString := IBDataSet99.FieldByname('OBSERVACAO').AsString;
  except end;  
  //
  IBDataSet99.Close;
  //
  ibDataSet2.Append;
  //
end;

procedure TForm7.Arquivos1Click(Sender: TObject);
begin
  Caixa1.Caption := 'Caixa do dia '+DateTimeToStr(Form7.ibDataSet1DATA.AsDateTime);
end;

procedure TForm7.Caixa1Click(Sender: TObject);
var
  dData : TDateTime;
  F: TextFile;
  fTotal, fTotal1, fTotal2 : Real;
begin
  fTotal := 0;
  Screen.Cursor := crHourGlass;
  //
  dData := ibDataSet1DATA.AsDateTime;
  Form16.Button3.Click; // Limpa os filtros //
  ibDataSet1.Locate('DATA',dData,[]);
  ibDataSet1.MoveBy(-1);
  //
  if Form1.bHtml1 then
  begin
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    Writeln(F,'<html><head><title>'+AllTrim(Form7.ibDataSet13NOME.AsString) + ' - '+Form7.sModulo+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font><p></center>');
    Writeln(F,'<br><font face="Microsoft Sans Serif" size=2><b><center>CAIXA DO DIA '+DateTimeToStr(dData)+'</b><br><br>');
    WriteLn(F,'<table  border=1   style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
    WriteLn(F,' <tr>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Histrico</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Entrada</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Sada</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Saldo</td>');
    WriteLn(F,' </tr>');
    //
    WriteLn(F,' <tr>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Saldo anterior</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1></td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1></td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1SALDO.AsFloat])+'</td>');
    WriteLn(F,' </tr>');
    //
  end else
  begin
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.txt'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    Writeln(F,'');
    Writeln(F,'');
    Writeln(F,'');
    Writeln(F,UpperCase(ibDataSet13NOME.AsString));
    Writeln(F,'CNPJ.: '+ ibDataSet13CGC.AsString + ' IE.: ' + ibDataSet13IE.AsSTring);
    Writeln(F,'');
    Writeln(F,'CAIXA DO DIA '+DateTimeToStr(dData));
    Writeln(F,'');
    Writeln(F,'                                         Saldo anterior.: '+
                                           Format('%12.2n',[Form7.ibDataSet1SALDO.AsFloat]));
    Writeln(F,'');
    Writeln(F,'Histrico                                    Entrada      Sada       ');
    Writeln(F,'-------------------------------------------- ------------ ------------');
    //
  end;
  //
  fTotal1 := 0;
  fTotal2 := 0;
  //
  if not ibDataSet1.BOF then ibDataSet1.MoveBy(1);
  while not Form7.ibDataSet1.EOF and (dData = ibDataSet1DATA.AsDateTime) do
  begin
    //
    if ibDataSet1DATA.AsDateTime = dData then
    begin
      //
      if Form1.bHtml1 then
      begin
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+AllTrim(Form7.ibDataSet1HISTORICO.AsString)+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1ENTRADA.AsFloat])+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1SAIDA.AsFloat])+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1SALDO.AsFloat])+'</td>');
        WriteLn(F,' </tr>');
      end else
      begin
        //
        Writeln(F,
                  Copy(AllTrim(Form7.ibDataSet1HISTORICO.AsString)+replicate(' ',44),1,44) + ' ' +
                  Format('%12.2n',[Form7.ibDataSet1ENTRADA.AsFloat]) + ' ' +
                  Format('%12.2n',[Form7.ibDataSet1SAIDA.AsFloat]));
      end;
      //
      fTotal  := Form7.ibDataSet1SALDO.AsFloat;
      fTotal1 := fTotal1 + Form7.ibDataSet1SAIDA.AsFloat;
      fTotal2 := ftotal2 + Form7.ibDataSet1ENTRADA.AsFloat;
      //
    end;
    //
    Form7.ibDataSet1.Next;
    //
  end;
  //
  if Form1.bHtml1 then
  begin
    //
    WriteLn(F,' <tr>');
    Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal2])+'</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal1])+'</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal2-ftotal1])+'</td>');
    WriteLn(F,' </tr>');
    //
    Writeln(F,'</table>');
    //
    WriteLn(F,'<center><br><font face="Microsoft Sans Serif" size=1></b>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
    + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
    + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br></center>');
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  end else
  begin
    //
    Writeln(F,'-------------------------------------------- ------------ ------------');
    Writeln(F,'                                             '+
                                           Format('%12.2n',[fTotal2]) + ' ' +
                                           Format('%12.2n',[fTotal1]));
    Writeln(F,'');
    Writeln(F,'                                            Saldo final.: '+
                                           Format('%12.2n',[fTotal]));

    Writeln(F,'');
    Writeln(F,'                                         (Entrada-Sada): '+
                                           Format('%12.2n',[fTotal2-Ftotal1]));
    //
    CloseFile(F);
    ShellExecute( 0, 'Open',pChar(Senhas.UsuarioPub+'.TXT'),'','', SW_SHOWMAXIMIZED);
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor normal
  //
end;

procedure TForm7.FormKeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if Key = VK_F1 then
    HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
  if Form7.sModulo <> 'RETRIBUTA' then
    Form7.ibDataSet16.EnableControls;
  {Sandro Silva 2022-10-18 inicio}
  if Sender.ClassType = TDBGrid then
  begin
    Key := Form1.BloqueiaCtrlXTField(Sender, Key, Shift);
  end;
  {Sandro Silva 2022-10-19 final}  
end;

procedure TForm7.ibDataSet1NOMEChange(Sender: TField);
begin
//  if Form10.Button7.Visible then Form10.Button7.Enabled := True;
//  if (ibDataSet1ENTRADA.AsFloat + ibDataSet1SAIDA.AsFloat) <> 0 then IntegraBanco(Sender);
end;

procedure TForm7.MenuItem34Click(Sender: TObject);
var
  I : Integer;
  NewItem: TMenuItem;
  bI : Boolean;
begin
  //
  if not bSoLeitura then
  begin
    Contasbancrias1.Enabled := True;
    Mostrartodososlanamentos1.Enabled := True;
  end else
  begin
    Contasbancrias1.Enabled := False;
    Mostrartodososlanamentos1.Enabled := False;
  end;
  //
  ibDataSet11.First;
  while not ibDataSet11.eof do
  begin
    bI := True;
    for I := 0 to Menuitem34.Count -1 do
    begin
      if Menuitem34.Items[I].Caption = ibDataSet11Nome.Value then
        bI := False;
    end;
    if bI then
    begin
      if AllTrim(ibDataSet11Nome.AsString) <> '' then
      begin
        NewItem := TMenuItem.Create(MenuItem34);
        NewItem.Caption := ibDataSet11Nome.Value;
        MenuItem34.Add(NewItem);
        NewItem.OnClick := Form1.EscolheOBanco;
      end;
    end;
    ibDataSet11.Next;
  end;
  //
  for I := 0 to (MenuItem34.Count-1) do
  begin
    //    ShowMessage(MenuiTem34.Items[I].Caption)
    if I > 7 then
    begin
      if MenuiTem34.Items[I].Caption = Form1.sEscolhido then
        MenuiTem34.Items[I].Checked := True
      else
        MenuiTem34.Items[I].Checked := False;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet7VALOR_DUPLChange(Sender: TField);
var
  I: Integer;
  fJuro: Real;
begin
  //
  try
    //
    ibDataSet7VALOR_JURO.ReadOnly := False;
    //
    if ibDataSet7VALOR_RECE.AsFloat = 0 then
    begin
      if ( Date - ibDataSet7VENCIMENTO.AsDateTime ) > 0 then
      begin
        if Form19.RadioButton1.Checked then
        begin
          if ibDataSet7VALOR_JURO.AsFloat <> ibDataSet7VALOR_DUPL.AsFloat * (((( Date - ibDataSet7VENCIMENTO.AsDateTime )) * Form1.ftaxa / 100) + 1) then
          begin
            ibDataSet7VALOR_JURO.AsFloat := ibDataSet7VALOR_DUPL.AsFloat * (((( Date - ibDataSet7VENCIMENTO.AsDateTime )) * Form1.ftaxa / 100) + 1)
          end;
        end else
        begin
          fJuro := ibDataSet7VALOR_DUPL.AsFloat;
          for I := 1 to Trunc(Date - ibDataSet7VENCIMENTO.AsDateTime) do
            fJuro  := fJuro * ((Form1.fTaxa / 100) + 1);

          if fJuro <> ibDataSet7VALOR_DUPL.AsFloat then
            ibDataSet7VALOR_JURO.AsFloat := fJuro;
        end;
      end else
      begin
        if ibDataSet7VALOR_JURO.AsFloat <> ibDataSet7VALOR_DUPL.AsFloat then
          ibDataSet7VALOR_JURO.AsFloat := ibDataSet7VALOR_DUPL.AsFloat;
      end;
    end else
    begin
      if ibDataSet7VALOR_JURO.AsFloat <> ibDataSet7VALOR_DUPL.AsFloat then
        ibDataSet7VALOR_JURO.AsFloat := ibDataSet7VALOR_DUPL.AsFloat;
    end;
    //
    ibDataSet7VALOR_JURO.ReadOnly := True;
    if ibDataSet7VALOR_DUPL.AsFloat < 0 then
      ibDataSet7VALOR_DUPL.AsFloat := 0;
  except
  end;
  //
  try
    if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
    begin
      Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString + '(000)', 1, 11) + 'VENCIMENTO';
    end;
  except
  end;
  //
end;

procedure TForm7.PopupMenu1Popup(Sender: TObject);
var
  sEmail, sEmail1 : String;
begin
  //
  Ativo1.Visible := False;
  Receberestaconta1.Visible := False;
  Pagarestaconta1.Visible   := False;
  Imprimirrecibo3.Visible   := False;
  Baixaestacontanobanco1.Visible := False;
  //
  // NF-e
  //
  N6VisualizarDANFE1.Caption := '6 - Visualizar DANFE'; // Sandro Silva 2023-02-14
  PrvisualizarDANFE1.Visible                       := False;
  CancelarNFSe1.Visible                            := False;
  EnviarNFSeporemail1.Visible                      := False;
  Visu1.Visible                                    := False;
  ransmitirNotaFiscaldeServioNFSe1.Visible         := False;
  ConsultarNFSe1.Visible                           := False;
  N0TestarservidorNFe1.Visible                     := False;
  N1enviarNFe1.Visible                             := False;
  N2ConsultarrecibodaNFe1.Visible                  := False;
  N3ConsultarNFe1.Visible                          := False;
  N4ImprimirDANFE1.Visible                         := False;
  N5EnviarDANFEporemail1.Visible                   := False;
  N6VisualizarDANFE1.Visible                       := False;
  CancelarNFe1.Visible                             := False;
  CCartadeCorreoEletronicaCCe1.Visible             := False;
  IImprimirCartadeCorreoEletronicaCCe1.Visible     := False;
  N6EnviarNFeConsultareImprimirDANFE1.Visible      := False;
  N9ImprimirDANFEemformulriodecontingncia1.Visible := False;
  VVerificaresquemashema1.Visible                  := False;
  RRecuperaroXMLdestaNFe1.Visible                  := False;
  Manifestaododestinatrio1.Visible                 := False;
  ManifestaododestinatrioDesc1.Visible             := False;
  Manifestaaododestinatrio1.Visible                := False;
  VisualizarXMLdamanifestaododestinatrio1.Visible  := False;
  N66.Visible                                      := False;
  DuplicatestaNFe1.Visible                         := False;
  //
  Editar1.Visible := True;
  Apagar2.Visible := True;
  //
  Editar1.Enabled := True;
  Apagar2.Enabled := True;
  //
  if Form7.bSoLeitura then
  begin
    Editar1.Enabled           := False;
    Apagar2.Enabled           := False;
    Ativo1.Enabled            := False;
    Pagarestaconta1.Enabled   := False;
    Receberestaconta1.Enabled := False;
    Baixaestacontanobanco1.Visible := False;
  end else
  begin
    Editar1.Enabled           := True;
    Apagar2.Enabled           := True;
    Ativo1.Enabled            := True;
    Pagarestaconta1.Enabled   := True;
    Receberestaconta1.Enabled := True;
    //
    if sModulo = 'RECEBER'  then
    begin
      Imprimirrecibo3.Visible := True;
      if ibDataSet7VALOR_RECE.AsFloat = 0 then
        Receberestaconta1.Enabled := True
      else
        Receberestaconta1.Enabled := False;
      if ibDataSet7VALOR_RECE.AsFloat <> 0 then
        Imprimirrecibo3.Enabled := True
      else
        Imprimirrecibo3.Enabled := False;
      Baixaestacontanobanco1.Visible  := True;
      //
      if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
      begin
        Baixaestacontanobanco1.Enabled := True;
      end else
      begin
        Baixaestacontanobanco1.Enabled := False;
      end;
      //
    end;
    //
    if sModulo = 'PAGAR'  then
    begin
      if ibDataSet8VALOR_PAGO.AsFloat = 0 then
        Pagarestaconta1.Enabled := True
      else
        Pagarestaconta1.Enabled := False;
    end;
    //
    if sModulo = 'ICM' then
      Abort;
    //
    if sModulo = 'CLIENTES' then
    begin
      if ibDataSet2ATIVO.AsString='1' then
        Ativo1.Checked := False
      else
        Ativo1.Checked := True;
      Ativo1.Visible := True;
    end;
    if sModulo = 'RECEBER' then
    begin
      if ibDataSet7ATIVO.AsString='1' then
        Ativo1.Checked := False
      else
        Ativo1.Checked := True;
      if ibDataSet7ATIVO.AsString='1' then
        Ativo5.Checked := False
      else
        Ativo5.Checked := True;
      Ativo1.Visible := True;
    end;
    if sModulo = 'ESTOQUE'  then
    begin
      if ibDataSet4ATIVO.AsString='1' then
        Ativo1.Checked := False
      else
        Ativo1.Checked := True;
      Ativo1.Visible := True;
    end;
    //
    if sModulo = 'ORCAMENTO'  then
    begin
      Editar1.Visible := False;
      Apagar2.Visible := False;
    end;
    //
    if sModulo = 'OS'  then
    begin
      Apagar2.Enabled := False;
    end;
    //
    if sModulo = 'COMPRA'  then
    begin
      N6VisualizarDANFE1.Caption := 'Visualizar DANFE'; // Sandro Silva 2023-02-14
      N6VisualizarDANFE1.Visible                       := True; // Sandro Silva 2023-02-14
      Manifestaododestinatrio1.Visible                 := True;
      VisualizarXMLdamanifestaododestinatrio1.Visible  := True;
      ManifestaododestinatrioDesc1.Visible             := True;
      Manifestaaododestinatrio1.Visible                := True;
    end;
    //
    if sModulo = 'VENDA'  then
    begin
      //
      // NF-e
      //
      Apagar2.Visible                                  := False;
      //
      if Form7.sRPS <> 'S' then
      begin
        //
        N0TestarservidorNFe1.Visible                     := True;
        N1enviarNFe1.Visible                             := True;
        N2ConsultarrecibodaNFe1.Visible                  := True;
        N3ConsultarNFe1.Visible                          := True;
        N4ImprimirDANFE1.Visible                         := True;
        N5EnviarDANFEporemail1.Visible                   := True;
        N6VisualizarDANFE1.Visible                       := True;
        CancelarNFe1.Visible                             := True;
        CCartadeCorreoEletronicaCCe1.Visible             := True;
        IImprimirCartadeCorreoEletronicaCCe1.Visible     := True;
        N6EnviarNFeConsultareImprimirDANFE1.Visible      := True;
        N9ImprimirDANFEemformulriodecontingncia1.Visible := True;
        VVerificaresquemashema1.Visible                  := True;
        RRecuperaroXMLdestaNFe1.Visible                  := True;
        N66.Visible                                      := True;
        DuplicatestaNFe1.Visible                         := True;
        //
      end else
      begin
        //
        CancelarNFSe1.Visible                            := True;
        EnviarNFSeporemail1.Visible                      := True;
        Visu1.Visible                                    := True;
        ransmitirNotaFiscaldeServioNFSe1.Visible         := True;
        ConsultarNFSe1.Visible                           := True;
        //
      end;
      //
      {Sandro Silva 2022-09-28 inicio
      if Pos('Falha no Schema',Form7.ibDataSet15STATUS.AsString)<> 0 then
      begin
        VVerificaresquemashema1.Enabled  := True;
      end else
      begin
        VVerificaresquemashema1.Enabled  := False;
      end;
      }
      VVerificaresquemashema1.Enabled := PermiteValidarSchema(Form7.ibDataSet15); // Ficha 6275 Sempre que estiver preenchido o campo NFEXML pode verificar o schema
      {Sandro Silva 2022-09-28 fim}
      //
      if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
      begin
        N2ConsultarrecibodaNFe1.Enabled  := True;
        N3ConsultarNFe1.Enabled          := True;
        RRecuperaroXMLdestaNFe1.Enabled  := True;
      end else
      begin
        N2ConsultarrecibodaNFe1.Enabled  := False;
        N3ConsultarNFe1.Enabled          := False;
        RRecuperaroXMLdestaNFe1.Enabled  := False;
      end;
      //
      //
      if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
      begin
        //
        N4ImprimirDANFE1.Enabled    := True;
        N6VisualizarDANFE1.Enabled  := True;
        //
        N1enviarNFe1.Enabled                 := False;
//        N2ConsultarrecibodaNFe1.Enabled  := False;
//        N3ConsultarNFe1.Enabled          := False;
        if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) <> 0) or (Form7.ibDataSet15EMITIDA.AsString = 'X') then
          N4ImprimirDANFE1.Enabled := True
        else
          N4ImprimirDANFE1.Enabled := False;

        N5EnviarDANFEporemail1.Enabled       := True;
        CancelarNFe1.Enabled                 := True;
        CCartadeCorreoEletronicaCCe1.Enabled := True;
        //
        N9ImprimirDANFEemformulriodecontingncia1.Enabled            := False;
      end else
      begin
        N1enviarNFe1.Enabled             := True;
        N4ImprimirDANFE1.Enabled         := False;
        N5EnviarDANFEporemail1.Enabled   := False;
//        if Alltrim(Form7.ibDataSet15NFERECIBO.AsString) = '' then N2ConsultarrecibodaNFe1.Enabled := False else N2ConsultarrecibodaNFe1.Enabled := True;
//        if Alltrim(Form7.ibDataSet15NFERECIBO.AsString) = '' then N3ConsultarNFe1.Enabled := False else N3ConsultarNFe1.Enabled := True;
        CancelarNFe1.Enabled                 := False;
        CCartadeCorreoEletronicaCCe1.Enabled := False;
        //
        N9ImprimirDANFEemformulriodecontingncia1.Enabled            := True;
        //
      end;
      //
      if Alltrim(Form7.ibDataSet15CCEXML.AsString) <> '' then
      begin
        //
        IImprimirCartadeCorreoEletronicaCCe1.Enabled := True;
        //
      end else
      begin
        //
        IImprimirCartadeCorreoEletronicaCCe1.Enabled := False;
        //
      end;
      //
      Form7.ibDataSet2.Close;
      Form7.ibDataSet2.Selectsql.Clear;
      Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
      Form7.ibDataSet2.Open;
      //
      sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
      //
      Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
      //
      if Alltrim(Form7.ibDataSet15TRANSPORTA.AsString) = Alltrim(Form7.ibDataSet18NOME.AsString) then
      begin
        sEmail1 := Form7.ibDataSet18EMAIL.AsString; // XML POR EMAIL
      end else
      begin
        sEmail1  := '';
      end;
      //
      if ibDataSet2NOME.AsString = ibDataSet15CLIENTE.AsString then
      begin
        //
        if validaEmail(sEmail) or validaEmail(sEmail1) then
        begin
          N5EnviarDANFEporemail1.Enabled   := True;
          N5EnviarDANFEporemail1.Caption   := '5 - Enviar o XML e DANFE por e-mail <'+sEmail+'>;<'+sEmail1+'>';
        end else
        begin
          N5EnviarDANFEporemail1.Enabled   := False;
          N5EnviarDANFEporemail1.Caption   := '5 - Enviar o XML e DANFE por e-mail <'+sEmail+'>;<'+sEmail1+'>';
        end;
        //
      end;
      //
      if Form7.ibDataSet15EMITIDA.AsString = 'X' then
      begin
        N1enviarNFe1.Enabled                             := False;
        N2ConsultarrecibodaNFe1.Enabled                  := False;
        N3ConsultarNFe1.Enabled                          := False;
        N5EnviarDANFEporemail1.Enabled                   := False;
        CancelarNFe1.Enabled                             := False;
        CCartadeCorreoEletronicaCCe1.Enabled             := False;
        IImprimirCartadeCorreoEletronicaCCe1.Enabled     := False;
        N6EnviarNFeConsultareImprimirDANFE1.Enabled      := False;
        N9ImprimirDANFEemformulriodecontingncia1.Enabled := False;
      end;
      //
    end;
    //
  end;
  //
  {Sandro Silva 2022-09-12 inicio}
  // Ficha 4128/6230
  PrvisualizarDANFE1.Visible := CancelarNFe1.Visible;
  PrvisualizarDANFE1.Enabled := ((Trim(Form7.ibDataSet15.FieldByName('NFEPROTOCOLO').AsString) = '') and (Form7.ibDataSet15.FieldByName('MODELO').AsString = '55'));
  {Sandro Silva 2022-09-12 fim}
end;

procedure TForm7.Ativo1Click(Sender: TObject);
begin
  //
  try
    if sModulo = 'RECEBER' then
    begin
      ibDataSet7.Edit;
      if ibDataSet7ATIVO.AsString = '1' then
      begin
        Ativo1.Checked := False;
        Ativo2.Checked := False;
//        Ativo5.Checked := False;
        ibDataSet7ATIVO.AsString := '0';
        //
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub, 'ATIVOU DOCUMENTO '+ibDataSet7DOCUMENTO.AsString,(ibDataSet7VALOR_DUPL.AsFloat),0);   // Ato, Modulo, Usurio, Histrico
        //
      end else
      begin
        Ativo1.Checked := True;
        Ativo2.Checked := True;
//        Ativo5.Checked := True;
        ibDataSet7ATIVO.AsString := '1';
        //
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub,'INATIVOU DOCUMENTO '+ibDataSet7DOCUMENTO.AsString,(ibDataSet7VALOR_DUPL.AsFloat),0);   // Ato, Modulo, Usurio, Histrico
        //
      end;
      ibDataSet7.Post;
    end;
    //
    if sModulo = 'CLIENTES' then
    begin
      ibDataSet2.Edit;
      if ibDataSet2ATIVO.AsString='1' then
      begin
        Ativo1.Checked := False;
        Ativo2.Checked := False;
        ibDataSet2ATIVO.AsString := '0';
      end else
      begin
        Ativo1.Checked := True;
        Ativo2.Checked := True;
        ibDataSet2ATIVO.AsString := '1';
      end;
      ibDataSet2.Post;
    end;
    //
    if sModulo = 'ESTOQUE' then
    begin
      ibDataSet4.Edit;
      if ibDataSet4ATIVO.AsString='1' then
      begin
        Ativo1.Checked := False;
        Ativo4.Checked := False;
        ibDataSet4ATIVO.AsString := '0';
      end else
      begin
        Ativo1.Checked := True;
        Ativo4.Checked := True;
        ibDataSet4ATIVO.AsString := '1';
      end;
      ibDataSet4.Post;
//    ibDataSet4.Edit;
    end;
  except end;
end;

procedure TForm7.Emailpara1Click(Sender: TObject);
begin
  if (ibDataSet2ATIVO.AsString<>'1') and (ValidaEmail(ibDataSet2EMAIL.AsString)) then
     ShellExecute( 0, 'Open',pChar('mailto:'+AllTrim(ibDataSet2EMAIL.AsString)),'New', '', SW_SHOWMAXIMIZED);
end;

procedure TForm7.MenuItem1Click(Sender: TObject);
begin
  //
  Enviartorpedo1.Caption      := 'Enviar uma mensagem WhatsApp para: '+Alltrim(ibDataSet2NOME.AsString);
  if LimpaNumero(ibDataSet2WHATSAPP.AsString) = '' then Enviartorpedo1.Enabled := False else Enviartorpedo1.Enabled := True;
  //
  Emailpara1.Caption        := 'Enviar um e-mail para: '+Alltrim(ibDataSet2NOME.AsString);
  Histrico1.Caption         := 'Histrico de: '+Alltrim(ibDataSet2NOME.AsString);
  VendasPara.Caption        := 'Vendas para: '+Alltrim(ibDataSet2NOME.AsString);
  Resumodevendas1.Caption   := 'Resumo das vendas para: '+Alltrim(ibDataSet2NOME.AsString);
  Resumodascomrpas1.Caption := 'Resumo das compras de: '+Alltrim(ibDataSet2NOME.AsString);
  //
  if ( Pos('@',ibDataSet2EMAIL.AsString) = 0) then Emailpara1.Enabled := False else Emailpara1.Enabled := True;
  if AllTrim(sWhere) = '' then
    Enviaremailparatodos1.Caption := 'Enviar um e-mail texto para todos os clientes e fornecedores'
  else
    Enviaremailparatodos1.Caption := 'Enviar o e-mail texto para todos os clientes e fornecedores filtrados';
  //
end;

procedure TForm7.MenuItem27Click(Sender: TObject);
begin
  if ibDataSet4ATIVO.AsString='1' then Ativo4.Checked := False else Ativo4.Checked := True;
end;


procedure TForm7.Ativo4Click(Sender: TObject);
begin
  try
    ibDataSet4.Edit;
    if ibDataSet4ATIVO.AsString='1' then
    begin
      Ativo1.Checked := False;
      Ativo4.Checked := False;
      ibDataSet4ATIVO.AsString := '0';
    end else
    begin
      Ativo1.Checked := True;
      Ativo4.Checked := True;
      ibDataSet4ATIVO.AsString :='1';
    end;
    ibDataSet4.Post;
  except end;
end;

procedure TForm7.Relatriodeservios1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de servios';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Relatriodeoramentospendentes1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Relatrio de oramentos pendentes';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet4MARGEMLBChange(Sender: TField);
begin
  //
  if ibDataSet4CUSTOCOMPR.Asfloat < 0 then ibDataSet4CUSTOCOMPR.Asfloat := 0;
  if (ibDataSet4MARGEMLB.AsFloat <> 0) and (ibDataSet4CUSTOCOMPR.AsFloat <> 0) then ibDataSet4PRECO.AsFloat := StrToFloat(Format('%8.2f',[(ibDataSet4CUSTOCOMPR.AsFloat * ((ibDataSet4MARGEMLB.AsFloat / 100)+1))]));
  //
end;


procedure TForm7.ibDataSet4BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  //
  if AllTrim(Form7.ibDataSet4DESCRICAO.AsString) <> '' then
  begin
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    sApagar := 'O sistema encontrou lanamentos referentes ao produto: '+Chr(10)+
               Chr(10)+
               Chr(10)+Form7.ibDataSet4DESCRICAO.AsString+Chr(10)+
               Chr(10)+
               'nos seguintes arquivos:'+chr(10)+chr(10);

    //
    ibDataSet16.Close;
    ibDataSet16.SelectSQL.Clear;
    ibDataSet16.SelectSQL.Add('select * from ITENS001 where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
    ibDataSet16.Open;
    //
    ibDataSet23.Close;
    ibDataSet23.SelectSQL.Clear;
    ibDataSet23.SelectSQL.Add('select * from ITENS002 where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
    ibDataSet23.Open;
    //
    ibDataSet27.Close;
    ibDataSet27.SelectSQL.Clear;
    ibDataSet27.SelectSQL.Add('select * from ALTERACA where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
    ibDataSet27.Open;
    //
    if Form7.ibDataSet16.Locate('DESCRICAO',Form7.ibDataSet4DESCRICAO.AsString,[]) then sApagar := sApagar + '      Movimento de vendas'+Chr(10); // Vendas
    if Form7.ibDataSet23.Locate('DESCRICAO',Form7.ibDataSet4DESCRICAO.AsString,[]) then sApagar := sApagar + '      Movimento de compras'+Chr(10); // Compras
    if Form7.ibDataSet27.Locate('DESCRICAO',Form7.ibDataSet4DESCRICAO.AsString,[]) then sApagar := sApagar + '      Movimento de vendas por ECF ou alterao na quantidade '+Chr(10);
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    //
    if Length(sApagar) <> 85+Length(Form7.ibDataSet4DESCRICAO.AsString)  then
    begin
      sApagar := sApagar + Chr(10) + Chr(10) + 'Portanto no pode ser apagado.' + Chr(10)
                                             + Chr(10)
                                             + 'Para tornar este item inativo clique no menu "Edita"'
                                             + Chr(10) + 'e desabilite a opo "Ativo".' + Chr(10);
      ShowMessage(sApagar);
      Abort;
    end;
  end;
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //
  // Alteraca
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('delete from CODEBAR where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString));
  ibDataSet99.Open;
  //
  // Alteraca
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('delete from ALTERACA where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
  ibDataSet99.Open;
  //
  // Apaga a controle de serial
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.Selectsql.Add('delete from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
  ibDataSet99.Open;
  //
  // Apaga a grade
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.Selectsql.Add('delete from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' ');
  ibDataSet99.Open;
  //
  // Apaga na composio
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.Selectsql.Add('delete from COMPOSTO where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString)+' ');
  ibDataSet99.Open;
  //
  // Reaproveita o Nmero do Cdigo do produto
  //
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_CODIGO,0) from rdb$database');
  IBDataSet99.Open;
  //
  if Form7.ibDataSet4CODIGO.AsString = StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),5,0) then
  begin
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select gen_id(G_CODIGO,-1) from rdb$database');
    IBDataSet99.Open;
  end;
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_HASH_ESTOQUE,-1) from rdb$database');
    ibDataset99.Open;
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.ibDataSet18ESTADOSetText(Sender: TField; const Text: String);
begin
  if Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0 then
  begin
//     raise Exception.Create('Estado invlido');
//   raise Exception.Create('Estado invlido');
     ShowMessage('Estado invlido');
     ibDataSet18ESTADO.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end else ibDataSet18ESTADO.AsString := UpperCase(Text);
end;

procedure TForm7.ibDataSet15TOTALChange(Sender: TField);
var
  fCredito: Real;
begin
  //
  if (Form7.sModulo = 'VENDA') then
  begin
    //
    // Relaciona as tabelas
    //
    if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet15OPERACAO.AsString then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
    //
    if Form7.ibDataSet2NOME.AsString <> Form7.ibDataSet15CLIENTE.AsString then
    begin
      Form7.ibDataSet2.Close;
      Form7.ibDataSet2.Selectsql.Clear;
      Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
      Form7.ibDataSet2.Open;
    end;
    //
    if (Form7.ibDataSet2CREDITO.AsFloat <> 0) and (ibDataSet15TOTAL.Asfloat <> 0) and (ibDataSet15EMITIDA.AsString <> 'S') then
    begin
      //
      if UpperCase(Form7.ibDataSet14INTEGRACAO.AsString) = 'RECEBER' then
      begin
        //
        // Soma o valor das contas a receber
        //
        Form7.ibDataSet99.Close;
        Form7.ibDataSet99.Selectsql.Clear;
        Form7.IbDataSet99.SelectSQL.Add('select sum(VALOR_DUPL) from RECEBER where VALOR_RECE = 0 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
        Form7.ibDataSet99.Open;
        //
        fCredito := Form7.ibDataSet2CREDITO.AsFloat - ibDataSet15TOTAL.Asfloat - ibDataSet99.FieldByname('SUM').AsFloat;
        //
        if (fCredito < 0) and (Form7.ibDataSet15EMITIDA.AsString <> 'S') then
        begin
          //
          ShowMessage('Ateno:'+Chr(10)
                                                 +Chr(10)
                                       +'Cliente: '+Form7.ibDataSet2NOME.AsString + Chr(10)
                                       + Chr(10)
                                       +'Limite de crdito: R$ '+Format('%10.2n',[Form7.ibDataSet2CREDITO.AsFloat]) + '                ' + Chr(10)
                                       +'Contas a receber: R$ '+Format('%10.2n',[Form7.ibDataSet99.FieldByname('SUM').AsFloat]) + Chr(10)
                                       +'Total da nota: R$ '+Format('%10.2n',[Form7.ibDataSet15TOTAL.Asfloat]) + Chr(10)
                                       +Chr(10)
                                       +'Limite de crdito excedido em: R$ '+Format('%10.2n',[(fCredito)*-1])
                                       + Chr(10)+chr(10)+chr(10)
                                       +'           MUDE A FORMA DE PAGAMENTO.                      '
                                       + Chr(10));
          //
          Form7.ibDataSet14.Locate('INTEGRACAO','CAIXA',[loCaseInsensitive, loPartialKey]);
          Form7.ibDataSet15OPERACAO.AsString := Form7.ibDataSet14NOME.AsString;
          //
        end;
        //
        Form7.ibDataSet99.Close;
        //
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet18UFSetText(Sender: TField; const Text: String);
begin
  if Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0 then
  begin
     // raise Exception.Create('Estado invlido');
     ShowMessage('Estado invlido');
     ibDataSet18UF.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end else ibDataSet18UF.AsString := UpperCase(Text);
end;

procedure TForm7.DBGrid1DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  I, OldBkMode : Integer;
  yRect, xRect : tREct;
  sTex : String;
begin
  //
  try
    //
    dbGrid1.Canvas.Pen.Width    := 0;
    dbGrid1.Canvas.Pen.Color    := clWhite;
    //
    //  gdSelected	The cell is currently selected.
    //  gdFocused	The cell has input focus.
    //  gdFixed	The cell is in the fixed region of the grid.
    //

{
if Field.DataType = ftString then ShowMessage('String '+Field.DisplayName);
if Field.DataType = ftSmallint then ShowMessage('Smallint '+Field.DisplayName);
if Field.DataType = ftInteger then ShowMessage('Integer '+Field.DisplayName);
if Field.DataType = ftWord then ShowMessage('Word '+Field.DisplayName);
if Field.DataType = ftBoolean then ShowMessage('Boolean '+Field.DisplayName);
if Field.DataType = ftFloat then ShowMessage('Float '+Field.DisplayName);
if Field.DataType = ftCurrency then ShowMessage('Currency '+Field.DisplayName);
if Field.DataType = ftDate then ShowMessage('Date '+Field.DisplayName);
if Field.DataType = ftTime then ShowMessage('Time '+Field.DisplayName);
if Field.DataType = ftDateTime then ShowMessage('DateTime '+Field.DisplayName);
if Field.DataType = ftBytes then ShowMessage('Bytes '+Field.DisplayName);
if Field.DataType = ftVarBytes then ShowMessage('VarBytes '+Field.DisplayName);
if Field.DataType = ftAutoInc then ShowMessage('AutoInc '+Field.DisplayName);
if Field.DataType = ftBlob then ShowMessage('Blob '+Field.DisplayName);
if Field.DataType = ftMemo then ShowMessage('Memo '+Field.DisplayName);
if Field.DataType = ftCurrency then ShowMessage('1 '+Field.DisplayName);
if Field.DataType = ftBCD then ShowMessage('2 '+Field.DisplayName);
if Field.DataType = ftFMTBcd then ShowMessage('3 '+Field.DisplayName);
}


    if not (gdFocused in State) and not (gdFixed in State) and not (gdSelected in State) then
    begin
      try
        //
        if (Field.DataType <> ftFloat) and (Field.DataType <> ftBCD) then
        begin
          //
          if sModulo = 'CLIENTES' then
          begin
            //
            if ibDataSet2ATIVO.AsString='1'  then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              //
              if ibDataSet2MOSTRAR.AsString='1'  then DBGrid1.Canvas.Font.Color := clRed else DBGrid1.Canvas.Font.Color := clBlack;
              //
              if (Field.FieldName = 'EMAIL') and (ValidaEmail(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                DBGrid1.Canvas.Font.Color := clBlue;
                DBGrid1.Canvas.Font.Style := [fsUnderline];
              end;
              //
              if Field.FieldName = 'IE' then
              begin
                //
                if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 18) and (UpperCase(AllTrim(Form7.ibDataSet2IE.AsString))<>'ISENTO') then
                begin
                  if ConsisteInscricaoEstadual(LimpaNumero(Form7.ibDataSet2IE.AsString),Form7.ibDataSet2ESTADO.AsString) then
                  begin
                    DBGrid1.Canvas.Font.Color := clRed;
                    DBGrid1.Canvas.Font.Style := [fsUnderline];
                  end else DBGrid1.Canvas.Font.Color := clBlack;
                end;
                //
              end;
              //
              // O dgito 9 (nove) ser acrescentado  esquerda dos atuais nmeros, passando a ter o formato: 9XXXX-XXXX.
              // O nono dgito dever ser acrescentado no momento da discagem por todos os usurios, de aparelhos fixos ou mveis que liguem para telefones mveis da rea 11, independentemente do local de origem da chamada.
              // Assim, quem fizer um interurbano para um celular da rea 11 a partir de 29 de julho ter que teclar 14 dgitos - 0 + Cdigo da Operadora + 11 + 9XXXX-XXXX.
              //
              if Field.FieldName = 'CELULAR' then
              begin
                //
                if (Copy(Form7.IBDataSet2CELULAR.AsString,1,7) = '(0xx11)') and (Length(AllTrim(Form7.IBDataSet2CELULAR.AsString))=15) then
                begin
                  if Copy(RetornaOperadora(Form7.IBDataSet2CELULAR.AsString),1,12) <> 'Convencional' then
                  begin
                    ibDAtaSet2.Edit;
                    ibDataSet2CELULAR.AsString := StrTran(ibDataSet2CELULAR.AsString,'(0xx11)','(9xx99)');
                    ibDataSet2CELULAR.AsString := StrTran(ibDataSet2CELULAR.AsString,'(9xx99)','(0xx11)9');
                    ibDAtaSet2.Post;
                    ibDAtaSet2.Edit;
                  end;
                end;
              end;
              //
            end;
            //
          end;
          //
          if sModulo = 'CONVENIO' then
          begin
            if ibDataSet2ATIVO.AsString='1'  then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              if (Field.Name = 'ibDataSet29EMAIL') and (ValidaEmail(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                DBGrid1.Canvas.Font.Color := clBlue;
                DBGrid1.Canvas.Font.Style := [fsUnderline];
              end;
            end;
          end;
          //
          if sModulo = 'FORNECED' then
          begin
            if ibDataSet2ATIVO.AsString='1' then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              if (Field.Name = 'ibDataSet3EMAIL') and (ValidaEmail(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                DBGrid1.Canvas.Font.Color := clBlue;
                DBGrid1.Canvas.Font.Style := [fsUnderline];
              end;
            end;
          end;
          //
          if sModulo = 'TRANSPORT' then
          begin
            if (Field.Name = 'ibDataSet18EMAIL') and (ValidaEmail(Form7.ibDataSet18EMAIL.AsString)) then
            begin
              DBGrid1.Canvas.Font.Color := clBlue;
              DBGrid1.Canvas.Font.Style := [fsUnderline];
            end;
          end;
          //
          if sModulo = 'ESTOQUE' then
          begin
            //
            if ibDataSet4ATIVO.AsString='1'  then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              //
              if Form7.ibDataSet4QTD_ATUAL.AsFloat < Form7.ibDataSet4QTD_MINIM.AsFloat then
              begin
                DBGrid1.Canvas.Font.Color := clRed;
              end;
              //
              // Composio Ok
              //
              if (Field.Name = 'ibDataSet4DESCRICAO') and (not Form10.Visible) then
              begin
{
                if not (Form7.IBDataSet99.Active) or (Copy(Form7.IbDataSet99.SelectSQL.Text,1,22) <> 'select * from COMPOSTO') then
                begin
                  //
                  // ShowMessage(Form7.IbDataSet99.SelectSQL.Text);
                  //
                  Form7.ibDataSet99.Close;
                  Form7.ibDataSet99.SelectSQL.Clear;
                  Form7.IbDataSet99.SelectSQL.Add('select * from COMPOSTO');
                  Form7.IbDataSet99.Open;
                  //
                end;
                //
                if Form7.IBDataset99.Locate('CODIGO',Form7.ibDataSet4CODIGO.AsString,[]) then DBGrid1.Canvas.Font.Color := clGreen;
}

                Form7.ibDataSet99.Close;
                Form7.ibDataSet99.SelectSQL.Clear;
                Form7.IbDataSet99.SelectSQL.Add('select CODIGO from COMPOSTO where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' ');
                Form7.IbDataSet99.Open;
                //
                if Form7.ibDataSet4CODIGO.AsString = Form7.IbDataSet99.FieldByname('CODIGO').AsString then DBGrid1.Canvas.Font.Color := clGreen;
                //
//                if not AssinaRegistro('ESTOQUE',form7.ibDataSet4, False) then
//                begin
//                  DBGrid1.Canvas.Font.Color := clLime;
//                end;
                //
              end;
              //
              if Field.FieldName = 'REFERENCIA' then
              begin
                try
                  if not ValidaEAN13(Form7.ibDataSet4REFERENCIA.AsString) then
                  begin
                    DBGrid1.Canvas.Font.Color := clRed;
                    DBGrid1.Canvas.Font.Style := [fsUnderline];
                  end else DBGrid1.Canvas.Font.Color := clBlack;
                except
                  DBGrid1.Canvas.Font.Color := clRed;
                  DBGrid1.Canvas.Font.Style := [fsUnderline];
                end;
              end;
              //
              if Form7.ibDataSet4MEDIDA.AsString <> '' then
              begin
                //
                if Field.FieldName = 'MEDIDA' then
                begin
                  //
                  Form7.IBDataSet99.Close;
                  Form7.IBDataSet99.SelectSQL.Clear;
                  Form7.IBDataSet99.SelectSQL.Add('select SIGLA from MEDIDA where SIGLA='+QuotedStr(Form7.IBDataSet4MEDIDA.AsString)+'');
                  Form7.IBDataSet99.Open;
                  //
                  if Form7.ibDataSet4MEDIDA.AsString <> Form7.IBDataSet99.FieldByname('SIGLA').AsString then
                  begin
                    DBGrid1.Canvas.Font.Color := clRed;
                    DBGrid1.Canvas.Font.Style := [fsUnderline];
                  end else DBGrid1.Canvas.Font.Color := clBlack;
                  //
                end;
              end;
              //
            end;
          end;
          //
          if sModulo = 'RECEBER' then
          begin
            if ibDataSet7Vencimento.Value < date then DBGrid1.Canvas.Font.Color := clRed;
            if ibDataSet7Vencimento.Value = date then DBGrid1.Canvas.Font.Color := clBlue;
            if ibDataSet7Valor_Rece.Value <> 0   then DBGrid1.Canvas.Font.Color := clGreen;
            if ibDataSet7ATIVO.AsString=  '1'    then DBGrid1.Canvas.Font.Color := clSilver;
          end;
          //
          if sModulo = 'OS' then
          begin
            if ibDataSet3SITUACAO.AsString = 'Fechada'    then DBGrid1.Canvas.Font.Color := clGreen;
            if ibDataSet3SITUACAO.AsString = 'Aberta'     then DBGrid1.Canvas.Font.Color := clRed;
            if ibDataSet3SITUACAO.AsString = 'Agendada'   then DBGrid1.Canvas.Font.Color := clBlack;
          end;
          //
          if sModulo = 'PAGAR' then
          begin
            if ibDataSet8Vencimento.Value < date then DBGrid1.Canvas.Font.Color := clRed;
            if ibDataSet8Vencimento.Value = date then DBGrid1.Canvas.Font.Color := clBlue;
            if ibDataSet8Valor_Pago.Value <> 0 then DBGrid1.Canvas.Font.Color := clGreen;
          end;
          //
          if sModulo = 'CAIXA' then
          begin
            if ibDataSet1.FieldByName('DATA').Value <> date then DBGrid1.Canvas.Font.Color := clGray;
            if AllTrim(ibDataSet1.FieldByName('NOME').AsString) = '' then
            begin
              if ibDataSet1.FieldByName('DATA').Value <> date then DBGrid1.Canvas.Font.Color := $009F9FFF else DBGrid1.Canvas.Font.Color :=  clRed;
            end;
          end;
          //
          if sModulo = 'ICM' then
          begin
            //
            if (Copy(ibDataSet14CFOP.AsString,1,1) = '1') or (Copy(ibDataSet14CFOP.AsString,1,1) = '2')  then DBGrid1.Canvas.Font.Color := clGreen;
            if (Copy(ibDataSet14CFOP.AsString,1,1) = '5') or (Copy(ibDataSet14CFOP.AsString,1,1) = '6')  then DBGrid1.Canvas.Font.Color := clBlue;
            if (Copy(ibDataSet14CFOP.AsString,1,1) = '3') or (Copy(ibDataSet14CFOP.AsString,1,1) = '7')  then DBGrid1.Canvas.Font.Color := clSilver;
            if (Copy(ibDataSet14CFOP.AsString,1,1) = ' ') then DBGrid1.Canvas.Font.Color := clBlack;
            //
          end;
          //
          if sModulo = 'ORCAMENTO' then
          begin
            //
            try
              if AllTrim(Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString) = '' then
                DBGrid1.Canvas.Font.Color := clBlack
              else
                DBGrid1.Canvas.Font.Color  := $00EAB231;
            except
            end;
            //
          end;
          //
          if sModulo = 'VENDA' then
          begin
            //
            if (Field.Name = 'ibDataSet15NUMERONF')     then
              DBGrid1.Canvas.Font.Style := [fsBold];
{
            if Form7.ibDataSet15EMITIDA.AsString <> 'S' then DBGrid1.Canvas.Font.Color := clRed;
            if Form7.ibDataSet15EMITIDA.AsString = 'X' then DBGrid1.Canvas.Font.Color := clSilver;
            if Form7.ibDataSet15STATUS.AsString = 'Autorizado o uso da NF-e' then DBGrid1.Canvas.Font.Color := $00EAB231;
}
            //
            if Form7.ibDataSet15EMITIDA.AsString = 'S' then
              DBGrid1.Canvas.Font.Color  := clBlack
            else
              DBGrid1.Canvas.Font.Color  := clRed;
            //
            if alltrim(Form7.ibDataSet15NFERECIBO.AsString)    <> '' then
              DBGrid1.Canvas.Font.Color := clBlue;
//            if alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then DBGrid1.Canvas.Font.Color  := $00EAB231;
            if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) <> 0 then
              DBGrid1.Canvas.Font.Color  := $00EAB231;
            if Form7.sRPS = 'S' then
            begin
              if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) <> 0 then
                DBGrid1.Canvas.Font.Color  := $00EAB231;
            end;
            //
            if Form7.ibDataSet15EMITIDA.AsString = 'X' then
              DBGrid1.Canvas.Font.Color := clSilver;
            //
            //
          end;
          //
          if sModulo = 'COMPRA' then
          begin
            //
            if (Field.Name = 'ibDataSet24NUMERONF')     then
              DBGrid1.Canvas.Font.Style := [fsBold];
            //
          end;
          //
          dbGrid1.Canvas.FillRect(Rect);
          //
          if Field.Name = 'ibDataSet3CGC' then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image24.Picture.Graphic);
          if Field.Name = 'ibDataSet18CGC' then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image24.Picture.Graphic);
          if Field.Name = 'ibDataSet2CGC' then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image24.Picture.Graphic);
          //
          if (Pos('CELULAR',UpperCase(Field.DisplayLabel)) <> 0) or (Pos('TELEFONE',UpperCase(Field.DisplayLabel)) <> 0) then
          begin
            //
            //          4988163696
            //
            yRect := Rect;
            YRect.Left   := Rect.Right - 40;
            YREct.Bottom := Rect.Top   + 40;
            //
            if Copy(RetornaOperadora(Field.AsString),1,5) = 'Claro'         then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageClaro.Picture.Graphic);  // Claro
            if Copy(RetornaOperadora(Field.AsString),1,4) = 'Vivo'          then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageVivo.Picture.Graphic);   // Vivo
            if Copy(RetornaOperadora(Field.AsString),1,3) = 'Tim'           then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageTim.Picture.Graphic);   // Tim
            if Copy(RetornaOperadora(Field.AsString),1,2) = 'Oi'            then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageOi.Picture.Graphic);   // Oi
            if Copy(RetornaOperadora(Field.AsString),1,2) = 'Br'            then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageBr.Picture.Graphic);   // Br
            if Copy(RetornaOperadora(Field.AsString),1,3) = 'Ama'           then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageAma.Picture.Graphic);   // iAmazonia
            if Copy(RetornaOperadora(Field.AsString),1,12) = 'Convencional' then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageConvencional.Picture.Graphic);   // Convencional
            //
            //
          end;
          //
          if Pos('WHATSAPP',UpperCase(Field.DisplayLabel)) <> 0 then
          begin
            //
            //          4988163696
            //
            yRect := Rect;
            YRect.Left   := Rect.Right - 40;
            YREct.Bottom := Rect.Top   + 40;
            //
            if LimpaNumero(Field.AsString) <> '' then dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageWhatsApp.Picture.Graphic);  // Claro
            //
          end;
          //
          if (Field.FieldName = 'CONTATOS') then
          begin
            sTex := Right(Field.AsString,100);
          end;
          //
//          if (Field.Name = 'ibDataSet15NFEPROTOCOLO') and (Length(AllTrim(Field.AsString))>=10) then dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString+'   ',10,3))
          if ((Field.Name = 'ibDataSet15NUMERONF') and (Copy(Field.AsString,10,3)='RPS')) then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9))
          else if (Field.Name = 'ibDataSet15NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.Name = 'ibDataSet7NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.Name = 'ibDataSet24NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.Name = 'ibDataSet8NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.FieldName = 'CONTATOS') then
            DbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,sTex)
          else
            DbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,StrTran(StrTran(Copy(Field.AsString,1,Field.DisplayWidth),chr(10),' '),chr(13),' '));

        end;
      except
        try
          for I := 1 to iCampos do
            ArquivoAberto.Fields[I-1].Visible := True;
        except end;
      end;
    end;
    //
    if Field.Name = 'ibDataSet5COMPENS' then
    begin
      //
      if Form7.ibDataSet5COMPENS.AsString = '' then
      begin
        dbGrid1.Canvas.FillRect(Rect);
        DBGrid1.Canvas.Font.Color   := clRed;
        dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'<Clique Duplo>');
      end;
      //
    end;
    //
    if Field.Name = 'ibDataSet1NOME' then
    begin
      //
      if Form7.ibDataSet1NOME.AsString = '' then
      begin
        dbGrid1.Canvas.FillRect(Rect);
        DBGrid1.Canvas.Font.Color   := clRed;
        dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'<Plano de Contas>');
      end;
      //
    end;
    //
    if Field.Name = 'ibDataSet24MDESTINXML' then
    begin
      //
      // Cdigo do evento:
      // 210200  Confirmao da Operao
      // 210210  Cincia da Operao
      // 210220  Desconhecimento da Operao
      // 210240  Operao no Realizada
      //
      yRect := Rect;
      YRect.Left   := Rect.Right - 20;
      YREct.Bottom := Rect.Top   + 40;
      //
      dbGrid1.Canvas.FillRect(Rect);
      //
      if Pos('<tpEvento>210200',Form7.ibDataSet24MDESTINXML.AsString)<>0 then
      begin
        //
        // 210200  Confirmao da Operao
        //
        DBGrid1.Canvas.Font.Color   := $00EAB231;
        dbGrid1.Canvas.StretchDraw(yRect,Form7.Positivo.Picture.Graphic);  // Positivo
        dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Operao confirmada');
        //
      end else
      begin
        //
        if (Pos('<tpEvento>210210',Form7.ibDataSet24MDESTINXML.AsString)<>0)  then
        begin
          if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString)=0) and (Form7.ibDataSet24MERCADORIA.Asfloat = 0) then
          begin
            //
            // Cincia da operao
            //
            DBGrid1.Canvas.Font.Color   := clMaroon;
            dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoDownloadXML.Picture.Graphic);
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Ciencia da Operacao - Importe o XML');
          end else
          begin
            //
            // 210210  Cincia da Operao
            //
            DBGrid1.Canvas.Font.Color   := clGreen;
            dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoVerde.Picture.Graphic);  // Positivo
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Ciente da Operao');
            //
          end;
          //
        end else
        begin
          //
          if (Pos('<tpEvento>21020',Form7.ibDataSet24MDESTINXML.AsString)<>0) then
          begin
            //
            // 210220  Desconhecimento da Operao
            //
            DBGrid1.Canvas.Font.Color := clSilver;
            dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoDownloadXML.Picture.Graphic);  // Positivo
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Desconhecimento da Operao');
            //
          end else
          begin
            //
            if (Pos('<tpEvento>210240',Form7.ibDataSet24MDESTINXML.AsString)<>0) then
            begin
              //
              // 210240  Operao no Realizada
              //
              DBGrid1.Canvas.Font.Color := clSilver;
              dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoDownloadXML.Picture.Graphic);  // Positivo
              dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Operao no Realizada');
              //
            end else
            begin
              //
              // Manifestar ciencia
              //
              if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) then
              begin
                DBGrid1.Canvas.Font.Color   := clRed;
                dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoVermelho.Picture.Graphic);  // Positivo
                dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Manifeste Cincia');
              end else
              begin
                DBGrid1.Canvas.Font.Color   := clBlack;
                dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'NF Manual (Guarde o Doc)');
              end;
            end;
          end;
        end;
      end;
    end;
    //
    if Field.Name = 'ibDataSet15STATUS' then
    begin
      //
      yRect := Rect;
      YRect.Left       := Rect.Right - 20;
      YRect.Bottom     := Rect.Top + 40;
      //
      if Form7.sRPS = 'S' then
      begin
        if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) <> 0 then
        begin
          dbGrid1.Canvas.StretchDraw(yRect,Form7.Image9.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(yRect,Form7.image8.Picture.Graphic);
        end
      end else
      begin
        //
        if Form7.ibDataSet15EMITIDA.AsString = 'X' then
        begin
          dbGrid1.Canvas.StretchDraw(yRect,Form7.Image1.Picture.Graphic)
        end else
        begin
          if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
          begin
            dbGrid1.Canvas.StretchDraw(yRect,Form7.image8.Picture.Graphic);
          end else
          begin
            dbGrid1.Canvas.StretchDraw(yRect,Form7.Image9.Picture.Graphic);
          end;
        end;
        //
      end;
    end;
    //
    if sModulo = 'ESTOQUE' then
    begin
      if Field.Name = 'ibDataSet4MARKETPLACE' then
      begin
        if (Form7.ibDataSet4MARKETPLACE.AsString = '1') then
        begin
          //
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image13.Picture.Graphic);
          //dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end;
      end;
    end;
    //

    if sModulo = 'RECEBER' then
    begin
      if Field.Name = 'ibDataSet7ATIVO' then
      begin
        if (Form7.ibDataSet7VALOR_RECE.Asfloat = 0) or (FORM7.ibDataSet7ATIVO.AsFloat >= 5) then
        begin
          if ibDataSet7ATIVO.AsFloat >= 5 then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image13.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image18.Picture.Graphic);
        end;
      end;
    end;
    //
    if sModulo = 'PAGAR' then
    begin
      if Field.Name = 'ibDataSet8ATIVO' then
      begin
        if (Form7.ibDataSet8VALOR_PAGO.Asfloat = 0) or (Form7.ibDataSet8ATIVO.AsFloat >= 5) then
        begin
          if ibDataSet8ATIVO.AsFloat >= 5 then dbGrid1.Canvas.StretchDraw(Rect,Form7.Image13.Picture.Graphic) else dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image18.Picture.Graphic);
        end;
      end;
    end;
    //
    if (Field.Name = 'ibDataSet14SOBREIPI') or
       (Field.Name = 'ibDataSet14SOBREFRETE') or
       (Field.Name = 'ibDataSet14SOBRESEGURO') or
       (Field.Name = 'ibDataSet14SOBREOUTRAS')  then
    begin
      dbGrid1.Canvas.FillRect(Rect);
      dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'          ');
      //
      if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '5') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '6') then
      begin
        if Field.Name = 'ibDataSet14SOBREIPI' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBREIPI.AsString) = '') or (Alltrim(Form7.ibDataSet14SOBREIPI.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;
        if Field.Name = 'ibDataSet14SOBREFRETE' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBREFRETE.AsString) = '') or (Alltrim(Form7.ibDataSet14SOBREFRETE.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;
        if Field.Name = 'ibDataSet14SOBRESEGURO' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBRESEGURO.AsString) = '') or (Alltrim(Form7.ibDataSet14SOBRESEGURO.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;
        if Field.Name = 'ibDataSet14SOBREOUTRAS' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBREOUTRAS.AsString) = '') or (Alltrim(Form7.ibDataSet14SOBREOUTRAS.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;
      end;
      //
    end;
    //
    if (Field.Name = 'ibDataSet14'+UpperCase(Form7.ibDataSet13ESTADO.AsString)) or (Field.Name = 'ibDataSet14'+UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_') then
    begin
      DBGrid1.Canvas.Font.Color   := clRed;
      dbGrid1.Canvas.FillRect(Rect);
      dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Field.AsString);
    end;
    //
    if Field.Name = 'ibDataSet7VENCIMENTO' then
    begin
      if (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 7) then
        DBGrid1.Canvas.Font.Color   := clRed
      else
        DBGrid1.Canvas.Font.Color   := clBlack;
      dbGrid1.Canvas.TextOut(Rect.Left+dbGrid1.Canvas.TextWidth('99/99/9999_'),Rect.Top+2,Copy(DiaDaSemana(Form7.ibDataSet7VENCIMENTO.AsDateTime),1,3) );
    end;
    //
    {Sandro Silva 2022-12-19 inicio}
    if Field.Name = 'ibDataSet7MOVIMENTO' then
    begin
      if Form7.ibDataSet7MOVIMENTO.AsString <> '' then
      begin
        if (DayOfWeek(Form7.ibDataSet7MOVIMENTO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet7MOVIMENTO.AsDateTime) = 7) then
          DBGrid1.Canvas.Font.Color   := clRed
        else
          DBGrid1.Canvas.Font.Color   := clBlack;
        dbGrid1.Canvas.TextOut(Rect.Left + dbGrid1.Canvas.TextWidth('99/99/9999_'), Rect.Top + 2, Copy(DiaDaSemana(Form7.ibDataSet7MOVIMENTO.AsDateTime), 1, 3) );
      end;
    end;
    //
    {Sandro Silva 2022-12-19 fim}
    if Field.Name = 'ibDataSet1DATA' then
    begin
      if (DayOfWeek(Form7.ibDataSet1DATA.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet1DATA.AsDateTime) = 7) then
        DBGrid1.Canvas.Font.Color   := clRed
      else
        DBGrid1.Canvas.Font.Color   := clBlack;
      DBGrid1.Canvas.TextOut(Rect.Left+dbGrid1.Canvas.TextWidth('99/99/9999_'),Rect.Top+2,Copy(DiaDaSemana(Form7.ibDataSet1DATA.AsDateTime),1,3) );
    end;
    //
    if Field.Name = 'ibDataSet15EMISSAO' then
    begin
      if (DayOfWeek(Form7.ibDataSet15EMISSAO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet15EMISSAO.AsDateTime) = 7) then
        DBGrid1.Canvas.Font.Color   := clRed
      else
        DBGrid1.Canvas.Font.Color   := clBlack;
      DBGrid1.Canvas.TextOut(Rect.Left + dbGrid1.Canvas.TextWidth('99/99/9999_'), Rect.Top + 2, Copy(DiaDaSemana(Form7.ibDataSet15EMISSAO.AsDateTime), 1, 3) );
    end;
    //
    begin
      //
      DBGrid1.Canvas.Brush.Color := Form7.Panel7.Color;
      DBGrid1.Canvas.Pen.Color   := clRed;
//      dbGrid1.Canvas.Brush.Color := clRed;
//      dbGrid1.Canvas.Pen.Color   := clRed;
      //
      xRect.Left   := REct.Left;
      xRect.Top    := -2;
      xRect.Right  := Rect.Right;
      xRect.Bottom := Rect.Bottom - Rect.Top + 3;
      //
//      dbGrid1.Canvas.StretchDraw(xREct,Form1.Botao_Titulo.Picture.Graphic);  // Claro
      dbGrid1.Canvas.FillRect(xRect);
      //
      if Pos(Field.FieldName,sOrderBy) <> 0 then DBGrid1.Canvas.Font.Style := [fsBold] else DBGrid1.Canvas.Font.Style := [];
      //
      //with dbGrid1.Canvas do
      //begin
        OldBkMode := SetBkMode(Handle, TRANSPARENT);
        DBGrid1.Canvas.Font.Color := clblack;
        DBGrid1.Canvas.TextOut(Rect.Left + 3, 3, AllTrim(Field.DisplayLabel));
        DBGrid1.Canvas.Font.Color := clblack;
        SetBkMode(Handle, OldBkMode);
      //end;
      //
    end;
    //
  except end;
end;

procedure TForm7.Balancetegerencial1Click(Sender: TObject);
var
  F: TextFile;
  fTotalNaoIdentificado, fSaldo, fTotalDasCONTAS, fTotalDasDespesas, fTotalDasReceitas, fTotalRetiradas : Real;
  Mais1Ini: TIniFile;
  I : Integer;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  Form7.ibDataSet1.DisableControls;
  Form7.ibDataSet12.DisableControls;
  //
  Form7.ibDataSet12.Close;
  Form7.ibDataSet12.SelectSQL.Clear;
  Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
  Form7.ibDataSet12.Open;
  Form7.ibDataSet12.First;
  //
  // Receitas
  //
  DeleteFile(pChar(Form1.sAtual+'\1.gra'));
  DeleteFile(pChar(Form1.sAtual+'\3.gra'));
  DeleteFile(pChar(Form1.sAtual+'\5.gra'));
  //
  DeleteFile(pChar(Form1.sAtual+'\1.png'));
  DeleteFile(pChar(Form1.sAtual+'\3.png'));
  DeleteFile(pChar(Form1.sAtual+'\5.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\1.gra');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','ENTRADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '1') and (Form7.ibDataSet12MES.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12MES.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  //
  CriaJpg('logotip.jpg');
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '1.GRA SMALLSOFT','', SW_SHOWMINNOACTIVE);
  //
  // Receitas
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\3.gra');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','SADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '3') and (Form7.ibDataSet12MES.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12MES.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  Mais1Ini.Free;
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '3.GRA  SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  // BANCOS
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\5.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','BANCOS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','2000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','4000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '5') and (Form7.ibDataSet12MES.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12MES.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '5.GRA  SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>BALANCETE GERENCIAL MENSAL</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>'+MesExtenso(Month(Form38.MonthCalendar1.Date))+' de '+ IntToStr(Year(Form38.MonthCalendar1.Date)) +'</b></font>');
  WriteLn(F,'<br></center>');              // Linha em branco
  WriteLn(F,'<br>');              // Linha em branco
  //
  WriteLn(F,'<center>');
  WriteLn(F,'<table  border=0>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  //
  ibDataSet1.Close;
  ibDataSet1.SelectSQL.Clear;
  ibDataSet1.SelectSQL.Add('select * from CAIXA order by DATA, REGISTRO');
  ibDataSet1.Open;
  //
  CalculaSaldo(True);
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('select * from CAIXA where extract(month from DATA)='+QuotedStr(StrZero(Month(Form38.MonthCalendar1.Date),2,0))+' and extract(year from DATA)='+QuotedStr(StrZero(Year(Form38.MonthCalendar1.Date),4,0))+' order by DATA, REGISTRO');
  ibDataSet99.Open;
  ibDataSet99.First;
  //
  // ShowMessage(ibDataSet99.SelectSQL.Text);
  //
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  //
  fSaldo := Form7.ibDataSet1SALDO.AsFloat- Form7.ibDataSet1ENTRADA.AsFloat + Form7.ibDataSet1SAIDA.AsFloat;
  //
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap  colspan=2 align=left><font size=2>Saldo inicial do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>ENTRADAS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  //
  Form7.ibDataSet12.First;
  fTotalDasReceitas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '1' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalDasReceitas := fTotalDasReceitas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo])+'<br></font></td>');
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\1.png"><img src="1.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>SADAS<br></td>');
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasDespesas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '3' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalDasDespesas := fTotalDasDespesas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo +fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  //
  // ENTRADAS - SAIDAS
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2>ENTRADAS - SAIDAS</font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas +  fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
  WriteLn(F,'    </tr>');
  //
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\3.png"><img src="3.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  //
  // Cabealho
  //
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>BANCOS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasContas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '5' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalDasContas := fTotalDasContas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'     <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'     <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\5.png"><img src="5.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  // Cabealho
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
//  WriteLn(F,'   <table  border=0 align=left width=400>');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>RETIRADAS/INTEGRALIZAES<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalRETIRADAS := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '7' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalRetiradas := fTotalRetiradas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Saldo Final
  ibDataSet99.Last;
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap  colspan=2 align=left><font size=2>Saldo final do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2 color=#FF0000>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas - Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  Form7.ibDataSet12.First;
  fTotalNaoIdentificado := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) <> '1') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '3') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '5') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '7') then
    begin
      fTotalNaoIdentificado := fTotalNaoIdentificado + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap  colspan=3 align=left><font size=2>Lanamentos no identificados no caixa<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalNaoIdentificado])+'<br></font></td>');
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,'</table>');
  WriteLn(F,'   </td>');
  WriteLn(F,'  </tr>');
  WriteLn(F,' </table>');
  WriteLn(F,'<br><font size=1 color=#C0C0C0><b>Saldo do caixa do dia anterior + Receitas - Despesas + Bancos = Saldo do caixa atual</b></font>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);
  //
  Form7.ibDataSet1.EnableControls;
  Form7.ibDataSet12.Enablecontrols;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;

procedure TForm7.Balancetegerencialanual1Click(Sender: TObject);
var
  F: TextFile;
  fTotalNaoIdentificado, fSaldo, fTotalDasCONTAS, fTotalDasDespesas, fTotalDasReceitas, fTotalRetiradas : Real;
  Mais1Ini: TIniFile;
  I : Integer;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  Form7.ibDataSet1.DisableControls;
  Form7.ibDataSet12.DisableControls;
  //
  Form7.ibDataSet12.Close;
  Form7.ibDataSet12.SelectSQL.Clear;
  Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
  Form7.ibDataSet12.Open;
  Form7.ibDataSet12.First;
  //
  // Receitas
  //
  DeleteFile(pChar(Form1.sAtual+'\11.gra'));
  DeleteFile(pChar(Form1.sAtual+'\13.gra'));
  DeleteFile(pChar(Form1.sAtual+'\15.gra'));
  //
  DeleteFile(pChar(Form1.sAtual+'\11.png'));
  DeleteFile(pChar(Form1.sAtual+'\13.png'));
  DeleteFile(pChar(Form1.sAtual+'\15.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\11.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','ENTRADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '1') and (Form7.ibDataSet12ANO.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12ANO.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  CriaJpg('logotip.jpg');
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '11.GRA SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  // Receitas
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\13.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','SADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '3') and (Form7.ibDataSet12ANO.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12ANO.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '13.GRA SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  // BANCOS
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\15.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','BANCOS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '5') and (Form7.ibDataSet12ANO.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12ANO.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  Mais1Ini.Free;
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '15.GRA SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>BALANCETE GERENCIAL ANUAL</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>'+MesExtenso(Month(Form38.MonthCalendar1.Date))+' de '+ IntToStr(Year(Form38.MonthCalendar1.Date)) +'</b></font>');
  WriteLn(F,'<br></center>');              // Linha em branco
  WriteLn(F,'<br>');                       // Linha em branco
  //
  WriteLn(F,'<br></center>');              // Linha em branco
  WriteLn(F,'<br>');                       // Linha em branco
  //
  WriteLn(F,'<center>');
  WriteLn(F,'<table border=0>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  //
  ibDataSet1.Close;
  ibDataSet1.SelectSQL.Clear;
  ibDataSet1.SelectSQL.Add('select * from CAIXA order by DATA, REGISTRO');
  ibDataSet1.Open;
  //
  CalculaSaldo(True);
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('select * from CAIXA where extract(year from DATA)='+QuotedStr(StrZero(Year(Form38.MonthCalendar1.Date),4,0))+' order by DATA, REGISTRO');
  ibDataSet99.Open;
  ibDataSet99.First;
  //
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  fSaldo := Form7.ibDataSet1SALDO.AsFloat- Form7.ibDataSet1ENTRADA.AsFloat + Form7.ibDataSet1SAIDA.AsFloat;
  //
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td  nowrap colspan=2 align=left><font size=2>Saldo inicial do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td  nowrap align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'        <td  nowrap align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td  nowrap colspan=4><font size=2 ><b>ENTRADAS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  //
  Form7.ibDataSet12.First;
  fTotalDasReceitas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '1' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalDasReceitas := fTotalDasReceitas + Form7.ibDataSet12ANO.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo])+'<br></font></td>');

  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\11.png"><img src="11.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>SADAS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasDespesas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '3' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalDasDespesas := fTotalDasDespesas + Form7.ibDataSet12ANO.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo +fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  //
  // ENTRADAS - SAIDAS
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2>ENTRADAS - SAIDAS</font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas +  fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
  WriteLn(F,'    </tr>');
  //
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\13.png"><img src="13.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>BANCOS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasContas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '5' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalDasContas := fTotalDasContas + Form7.ibDataSet12ano.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'     <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'     <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\15.png"><img src="15.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  // Cabealho
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   nowrap  colspan=4><font size=2 ><b>RETIRADAS/INTEGRALIZAES<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  nowrap><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  nowrap><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalRETIRADAS := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '7' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   nowrap   align=right><font size=2><br></font></td>');
      fTotalRetiradas := fTotalRetiradas + Form7.ibDataSet12ANO.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  //
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Saldo Final
  ibDataSet99.Last;
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap  colspan=2 align=left><font size=2>Saldo final do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2 color=#FF0000>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas - Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  Form7.ibDataSet12.First;
  fTotalNaoIdentificado := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) <> '1') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '3') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '5') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '7') then
    begin
      fTotalNaoIdentificado := fTotalNaoIdentificado + Form7.ibDataSet12ano.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   nowrap  colspan=3 align=left><font size=2>Lanamentos no identificados no caixa<br></font></td>');
  WriteLn(F,'        <td   nowrap   align=right><font size=2>'+ Format('%15.2n',[fTotalNaoIdentificado])+'<br></font></td>');
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,'</table>');
  WriteLn(F,'   </td>');
  WriteLn(F,'  </tr>');
  WriteLn(F,' </table>');
  WriteLn(F,'<br><font size=1 color=#C0C0C0><b>Saldo do caixa do dia anterior + Receitas - Despesas + Bancos = Saldo do caixa atual</b></font>');
  //
  // ---------------------------------------------------------------------------
  WriteLn(F,'<br>');              // Linha em branco
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</center>');
  WriteLn(F,'</html>');
  CloseFile(F);
  Form7.ibDataSet1.EnableControls;
  Form7.ibDataSet12.Enablecontrols;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;


procedure TForm7.ibDataSet1BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet1ENTRADA.AsFloat + (ibDataSet1SAIDA.AsFloat*-1);
end;

procedure TForm7.Ranquingdeclientes1Click(Sender: TObject);
begin
  //
  Form7.Close;
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Ranking de clientes';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.MenuItem60Click(Sender: TObject);
begin
  //
  if sModulo = 'RECEBER'  then
  begin
    if ibDataSet7ATIVO.AsString = '1' then
      Ativo5.Checked := False
    else
      Ativo5.Checked := True;
    //
    Acertodecontasde1.Visible := False;
    //
    Acertodecontasde1.Visible := True;
    Acertodecontasde1.Caption := 'Receber contas de: '+Form7.ibDataSet7NOME.AsString;
    //
  end;
  //
end;

procedure TForm7.ibDataSet19AfterPost(DataSet: TDataSet);
begin
  Form4.FormClick(Form4);
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet2CGCSetText(Sender: TField; const Text: String);
var
  sRetorno : String;
  I : Integer;
begin
  //
  {Sandro Silva 2022-12-15 inicio 
  Form7.spdNFe.ConfigurarSoftwareHouse('07426598000124','9830b685216a9c4613bc76c84098272d');
  }
  Form1.ConfiguraCredencialTecnospeed;
  {Sandro Silva 2022-12-15 fim}

  //
  if LimpaNumero(Text) <> '' then
  begin
    if CpfCgc(LimpaNumero(Text)) then
    begin
       if UpperCase(Form1.ConfAceitaCGCDuplo) = 'SIM' then
       begin
         ibDataSet2CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)));
       end else
       begin
         if (Valida_Campo('CLIFOR',ConverteCpfCgc(AllTrim(LimpaNumero(Text))),'CGC','Este CPF/CNPJ j foi cadastrado')) then
            ibDataSet2CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)));
       end;
    end else
    begin
      ShowMessage('CPF ou CNPJ invlido!');
    end;
  end
  else
  begin
    if (ibDataSet2CGC.OldValue <> '') then
      ibDataSet2CGC.AsString := ibDataSet2CGC.OldValue
    else
      ibDataSet2CGC.AsString := '';
  end;

  //
  if (AllTrim(Form7.IBDataSet2NOME.AsString) = '') and (AllTrim(LimpaNumero(Form7.IBDataSet2CGC.AsString))<>'') then
  begin
    //
    Screen.Cursor            := crHourGlass;
    //
    try
      //
      if (Length(LimpaNumero(Form7.ibDataSet2CGC.AsString)) = 14) then
      begin
        //
        sRetorno := ConsultaCadastro(Form7.ibDataSet2CGC.AsString);
        //
        if AllTrim(xmlNodeValue(sRetorno,'//xNome')) <> '' then
        begin
          //
          Form7.IBDataSet2IE.AsString     := xmlNodeValue(sRetorno,'//IE');
          Form7.IBDataSet2ESTADO.AsString := xmlNodeValue(sRetorno,'//UF');
          Form7.IBDataSet2NOME.AsString   := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xNome')));
          Form7.IBDataSet2ENDERE.AsString := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xLgr')+', '+xmlNodeValue(sRetorno,'//nro') + ' ' + xmlNodeValue(sRetorno,'//xCpl')));
          Form7.IBDataSet2COMPLE.AsString := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xBairro')));
          Form7.IBDataSet2CEP.AsString    := copy(xmlNodeValue(sRetorno,'//CEP'),1,5)+'-'+copy(xmlNodeValue(sRetorno,'//CEP'),6,3);
          Form7.IBDataSet2OBS.AsString    := 'CNAE: ' + xmlNodeValue(sRetorno,'//CNAE') + ' ' + xmlNodeValue(sRetorno,'//xMotivo');
          //
          // CNAE
          //
          for I := 0 to Form17.ComboBox7.Items.Count -1 do
          begin
            if Copy(Form17.ComboBox7.Items[I],1,7) = xmlNodeValue(sRetorno,'//CNAE') then
            begin
              Form7.IBDataSet2OBS.AsString    := 'CNAE: ' + AllTrim(Form17.ComboBox7.Items[I]) + ' ' + xmlNodeValue(sRetorno,'//xMotivo');
            end;
          end;
          //
          Form7.ibDataset99.Close;
          Form7.ibDataset99.SelectSql.Clear;
          Form7.ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where CODIGO='+QuotedStr(xmlNodeValue(sRetorno,'//cMun'))+' ');
          Form7.ibDataset99.Open;
          //
          Form7.IBDataSet2CIDADE.AsString := Form7.IBDataSet99.FieldByname('NOME').AsString;
          //
        end;
      end;
      //
    except end;
    //
  end;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.ibDataSet7DOCUMENTOSetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(Text) <> '' then
    Valida_Campo('RECEBER', Text, 'DOCUMENTO','Esta conta j est cadastrada');
  ibDataSet7DOCUMENTO.AsString := AllTrim(Text);
end;

procedure TForm7.ibDataSet5DOCUMENTOSetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(Text) <> '' then
    Valida_Campo('MOVIMENT', Text, 'DOCUMENTO','Este documento j est cadastrado');
  ibDataSet5DOCUMENTO.AsString := Text;
end;

procedure TForm7.ibDataSet13CGCSetText(Sender: TField; const Text: String);
var
  sRetorno : String;
  I: Integer;
begin
  //
  if LimpaNumero(Text) <> '' then
  begin
    if CpfCgc(LimpaNumero(Text)) then
      ibDataSet13CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)))
    else
      ShowMessage('CPF ou CNPJ invlido!');
  end
  else
    ibDataSet13CGC.AsString := '';
  //
  if (AllTrim(Form7.IBDataSet13NOME.AsString) = '') and (AllTrim(LimpaNumero(Form7.IBDataSet13CGC.AsString))<>'') then
  begin
    //
    Screen.Cursor            := crHourGlass;
    //
    try
      //
      if (Length(LimpaNumero(Form7.ibDataSet13CGC.AsString)) = 14) or (Length(LimpaNumero(Form7.ibDataSet13CGC.AsString)) = 11) then
      begin
        //
        sRetorno := ConsultaCadastro(Form7.ibDataSet13CGC.AsString);
        //
        if AllTrim(xmlNodeValue(sRetorno,'//xNome')) <> '' then
        begin
          //
          Form7.ibDataset13IE.AsString       := xmlNodeValue(sRetorno,'//IE');
          Form7.ibDataset13ESTADO.AsString   := xmlNodeValue(sRetorno,'//UF');
          Form7.ibDataset13NOME.AsString     := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xNome')));
          Form7.ibDataset13ENDERECO.AsString := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xLgr')+', '+xmlNodeValue(sRetorno,'//nro') + ' ' + xmlNodeValue(sRetorno,'//xCpl')));
          Form7.ibDataset13COMPLE.AsString   := PrimeiraMaiuscula((xmlNodeValue(sRetorno,'//xBairro')));
          Form7.ibDataset13CEP.AsString      := copy(xmlNodeValue(sRetorno,'//CEP'),1,5)+'-'+copy(xmlNodeValue(sRetorno,'//CEP'),6,3);
          Form7.ibDataset13CNAE.AsString     := xmlNodeValue(sRetorno,'//CNAE');
          //
          for I := 0 to Form17.ComboBox7.Items.Count -1 do
          begin
            if Copy(Form17.ComboBox7.Items[I],1,7) = AllTrim(Form7.ibDataSet13CNAE.AsString) then
            begin
              Form17.ComboBox7.ItemIndex := I;
            end;
          end;
          //
          Form7.ibDataset99.Close;
          Form7.ibDataset99.SelectSql.Clear;
          Form7.ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where CODIGO='+QuotedStr(xmlNodeValue(sRetorno,'//cMun'))+' ');
          Form7.ibDataset99.Open;
          //
          Form7.ibDataset13MUNICIPIO.AsString := Form7.IBDataSet99.FieldByname('NOME').AsString;
          //
          {
          if xmlNodeValue(sRetorno,'//XregApur') = 'SIMPLES NACIONAL' then
          begin
            Form17.ComboBox1.ItemIndex    := 0;
            Form7.ibDataset13CRT.AsString := '1';
          end else
          begin
            Form17.ComboBox1.ItemIndex    := 2;
            Form7.ibDataset13CRT.AsString := '3';
          end;
          }
          Form17.ComboBox1.ItemIndex    := 0;
          Form7.ibDataset13CRT.AsString := '1';
          //
        end;
      end;
      //
    except

    end;
    //
  end;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.ibDataSet18CGCSetText(Sender: TField; const Text: String);
begin
  if LimpaNumero(Text) <> '' then
  begin
    if CpfCgc(LimpaNumero(Text)) then
        ibDataSet18CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)))
             else ShowMessage('CPF ou CNPJ invlido!')
  end else ibDataSet18CGC.AsString := '';
end;

procedure TForm7.ibDataSet21NOMESetText(Sender: TField; const Text: String);
begin
  if Valida_Campo('GRUPO',Text,'NOME','Este grupo j foi cadastrado') then
  ibDataSet21NOME.AsString := Text;
end;

procedure TForm7.ibDataSet9NOMESetText(Sender: TField; const Text: String);
begin
  if Valida_Campo('VENDEDOR',Text,'NOME','Este vendedor j foi cadastrado') then
  ibDataSet9NOME.AsString := Text;
end;

procedure TForm7.ibDataSet4PRECOChange(Sender: TField);
begin
  //
  if ibDataSet4PRECO.AsFloat <= 0 then
  begin
    ShowMessage('O valor unitrio no pode aceitar valor negativo ou nulo.');
    if Form7.fPrecoAnterior <= 0 then Form7.fPrecoAnterior := 0.01;
    Form7.ibDataSet4PRECO.AsFloat := Form7.fPrecoAnterior;
    if Form10.Visible then
      Form10.SMALL_DBEdit7.Text := Form7.ibDataSet4PRECO.AsString;
    Abort;
  end else ibDataSet4ALTERADO.AsString := '1';
  //
  Form7.ibDataSet4OFFPROMO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
  //
end;

procedure TForm7.Balancetegerancialmensal1Click(Sender: TObject);
begin
  Form1.Planodecontas1Click(Sender);
  Balancetegerencial1Click(Sender);
  Form1.Image205Click(Sender);
end;

procedure TForm7.Balancetegerencialanual2Click(Sender: TObject);
begin
  Form1.Planodecontas1Click(Sender);
  Balancetegerencialanual1Click(Sender);
  Form1.Image205Click(Sender);
end;

procedure TForm7.ibDataSet9BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de    }
  { alterar o nome. Se o nome for alterado deve ser  }
  { atualizado o arquivo VENDAS e o arquivo ALTERACA }
  sNumeroAnterior := ibDataSet9REGISTRO.AsString;
  sNomeAnterior   := ibDataSet9NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet9AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  //
  // VENDEDOR
  //
  if (sNomeAnterior <> ibDataSet9NOME.AsString) and (sNomeAnterior <> '')  and (sNumeroAnterior = ibDataSet9REGISTRO.AsString) then
  begin
    //
    sNomeNovo  := ibDataSet9NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // VENDAS
    //
    Form7.ibDataSet15.Close;
    Form7.ibDataSet15.SelectSQL.Clear;
    Form7.ibDataSet15.SelectSQL.Add('update VENDAS set VENDEDOR='+QuotedStr(sNomeNovo)+' where upper(VENDEDOR)='+QuotedStr(UpperCase(sNomeVolta))+'');
    Form7.ibDataSet15.Open;
    //
    // OS
    //
    Form7.ibDataSet3.Close;
    Form7.ibDataSet3.SelectSQL.Clear;
    Form7.ibDataSet3.SelectSQL.Add('update OS set TECNICO='+QuotedStr(sNomeNovo)+' where upper(TECNICO)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet3.Open;
    //
    // ITENS003
    //
    Form7.ibDataSet3.Close;
    Form7.ibDataSet3.SelectSQL.Clear;
    Form7.ibDataSet3.SelectSQL.Add('update ITENS003 set TECNICO='+QuotedStr(sNomeNovo)+' where upper(TECNICO)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet3.Open;
    //
    // ORCAMENT
    //
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    Form7.ibDataSet27.SelectSQL.Add('update ORCAMENT set VENDEDOR='+QuotedStr(sNomeNovo)+' where upper(VENDEDOR)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet27.Open;
    //
    // ALTERACA
    //
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    Form7.ibDataSet27.SelectSQL.Add('update ALTERACA set VENDEDOR='+QuotedStr(sNomeNovo)+' where upper(VENDEDOR)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet27.Open;
    //
    ibDataSet9.Enablecontrols;
    ibDataSet27.EnableControls;
    Screen.Cursor := crDefault; // Cursor de Aguardo
    //
  end;
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.MenuItem23Click(Sender: TObject);
begin
  //
  Form7.EnvioaoFISCOREDUOZ1.Visible := True;
  ImprimiraNFemformulrionumerado1.Visible := True;
  ImprimirtodasasNFfiltradas1.Visible     := True;
  ImprimirNF3.Visible                     := True;
  //
  if FileExists(Form1.sAtual+'\orca.exe') then
  begin
    Relatriodeoramentospendentes1.Visible := True;
    ImportarOramento1.Visible := True;
    ImportarOS1.Visible := True;
    Oramento1.Visible := True;
    N6.Visible := True;
  end else
  begin
    Relatriodeoramentospendentes1.Visible := False;
    ImportarOramento1.Visible := False;
    ImportarOS1.Visible := False;
    Oramento1.Visible := False;
    N6.Visible := False;
  end;
  //
  ArquivotextoNotaFiscalPaulista1.Visible := False;
  //
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'SP' then ArquivotextoNotaFiscalPaulista1.Visible := True;
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'AL' then
  begin
    ArquivotextoNotaFiscalPaulista1.Visible := True;
    ArquivotextoNotaFiscalPaulista1.Caption := 'Arquivo texto "Nota Fiscal Alagoana"...';
  end;
  //
//  ImprimirNF2.Caption := 'Imprimir NF nmero '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet15CLIENTE.AsString;
  Exportar1.Caption   := 'Exportar NF nmero '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet15CLIENTE.AsString;
  if bSoLeitura then Grupos1.Enabled := False else Grupos1.Enabled := True;
  //
{
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
  if (Mais1Ini.ReadString('NFE','Ambiente','Homologacao') = 'Producao') and (Mais1Ini.ReadString('NFE','Formulario','No') = 'No') then
  begin
    ImprimirNF2.Visible                 := False;
    ImprimirtodasasNFfiltradas1.Visible := False;
  end else
  begin
    ImprimirNF2.Visible                 := True;
    ImprimirtodasasNFfiltradas1.Visible := True;
  end;
  //
  Mais1ini.Free;
}
  //
end;

procedure TForm7.ibDataSet21AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //
  // GRUPO de Mercadorias
  //
  Form7.ibDataSet4.DisableControls;
  Form7.ibDataSet21.DisableControls;
  //
  if (sNomeAnteriorDoGrupo <> ibDataSet21NOME.AsString) and (sNumeroAnteriorGrupo = ibDataSet21REGISTRO.AsString) then
  begin
    sNomeNovo  := ibDataSet21NOME.AsString;
    sNomeVolta := sNomeAnteriorDoGrupo;
    //
    // ESTOQUE
    //
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.SelectSQL.Clear;
    Form7.ibDataSet4.SelectSQL.Add('update ESTOQUE set NOME='+QuotedStr(sNomeNovo)+' where NOME='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet4.Open;
    //
  end;
  Form7.ibDataSet21.EnableControls;
  Form7.ibDataSet4.EnableControls;
  Screen.Cursor := crDefault;
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet21BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo de ESTOQUE                 }
  sNumeroAnteriorGrupo := ibDataSet21REGISTRO.AsString;
  sNomeAnteriorDoGrupo := ibDataSet21NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet3NOMEChange(Sender: TField);
begin
//  if Form10.Button7.Visible then Form10.Button7.Enabled := True;
end;

procedure TForm7.ibDataSet4AfterPost(DataSet: TDataSet);
var
  sNomeNovo  : String;
  sNomeVolta : String;
begin
  //
  // Quando troca o nome do produto
  //
  if (sNomeAnterior <> ibDataSet4DESCRICAO.AsString) and (AllTrim(sNomeAnterior) <> '') and (sNumeroAnterior = ibDataSet4REGISTRO.AsString) then
  begin
    //
    Form1.LbBlowfish1.GenerateKey(Form1.sPasta);
    //
    Form7.ibDataSet4.DisableControls;
    //
    sNomeNovo  := ibDataSet4DESCRICAO.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // ALTERACA
    //
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    Form7.ibDataSet27.SelectSQL.Add('update ALTERACA set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+'  where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet27.Open;
    //
    // ORCAMENTO
    //
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    Form7.ibDataSet27.SelectSQL.Add('update ORCAMENT set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet27.Open;
    //
    // COMPOSICAO
    //
    Form7.ibDataSet28.Close;
    Form7.ibDataSet28.SelectSQL.Clear;
    Form7.ibDataSet28.SelectSQL.Add('update COMPOSTO set DESCRICAO='+QuotedStr(sNomeNovo)+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet28.Open;
    //
    // ITENS001
    //
    Form7.ibDataSet16.Close;
    Form7.ibDataSet16.SelectSQL.Clear;
    Form7.ibDataSet16.SelectSQL.Add('update ITENS001 set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet16.Open;
    //
    // ITENS002
    //
    Form7.ibDataSet23.Close;
    Form7.ibDataSet23.SelectSQL.Clear;
    Form7.ibDataSet23.SelectSQL.Add('update ITENS002 set DESCRICAO='+QuotedStr(sNomeNovo)+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet23.Open;
    //
    Form7.ibDataSet4.EnableControls;
    //
  end;
  //
  // Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet2AfterPost(DataSet: TDataSet);
var
  bButton : Integer;
  sNomeNovo, sNomevolta : String;
begin
  //
  if sModulo <> 'LOKED' then
  begin
    //
    try
      Form7.TabelaAberta.DisableControls;
    except end;
    //
    // Est variavel foi Iniciada no BeforeEdit        //
    // Se o nome for alterado deve ser                 //
    // atualizado o arquivo VENDAS e o arquivo RECEBER //
    //
    Form7.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta
    //
    try
      //
      if (sNomeAnterior <> ibDataSet2NOME.AsString) and (sNomeAnterior <> '') and (sNumeroAnterior = ibDataSet2REGISTRO.AsString) then
      begin
        //
        sNomeNovo  := ibDataSet2NOME.AsString;
        sNomeVolta := sNomeAnterior;
        //
        bButton := Application.MessageBox(Pchar('O nome do '+LowerCase(Form7.IBDataSet2CLIFOR.AsString)+' foi alterado' +
                                                Chr(10) +
                                                Chr(10) + '     de: ' + sNomeAnterior +
                                                Chr(10) + '  para: ' + sNomeNovo +
                                                Chr(10) +
                                                Chr(10) + 'Os movimentos de: Vendas, contas a receber, vendas no balco          '+
                                                Chr(10) + 'e oramento vo ser atribudos a este novo nome.' + Chr(10) +
                                                Chr(10) +
                                                'Continuar?'+
                   Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        if bButton = IDYES then
        begin
          //
          Screen.Cursor := crHourGlass;
          //
          // CODEBAR
          //
          Form7.ibDataSet6.Close;
          Form7.ibDataSet6.SelectSQL.Clear;
          Form7.ibDataSet6.SelectSQL.Add('update CODEBAR set FORNECEDOR='+QuotedStr(sNomeNovo)+' where FORNECEDOR='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet6.Open;
          //
          // RECEBER
          //
          Form7.ibDataSet7.Close;
          Form7.ibDataSet7.SelectSQL.Clear;
          Form7.ibDataSet7.SelectSQL.Add('update RECEBER set NOME='+QuotedStr(sNomeNovo)+' where NOME='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet7.Open;
          //
          // PAGAR
          //
          Form7.ibDataSet8.Close;
          Form7.ibDataSet8.SelectSQL.Clear;
          Form7.ibDataSet8.SelectSQL.Add('update PAGAR set NOME='+QuotedStr(sNomeNovo)+' where NOME='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet8.Open;
          //
          // OS
          //
          Form7.ibDataSet3.Close;
          Form7.ibDataSet3.SelectSQL.Clear;
          Form7.ibDataSet3.SelectSQL.Add('update OS set CLIENTE='+QuotedStr(sNomeNovo)+' where CLIENTE='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet3.Open;
          //
          // VENDAS
          //
          Form7.ibDataSet15.Close;
          Form7.ibDataSet15.SelectSQL.Clear;
          Form7.ibDataSet15.SelectSQL.Add('update VENDAS set CLIENTE='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where CLIENTE='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet15.Open;
          //
          // COMPRAS
          //
          Form7.ibDataSet24.Close;
          Form7.ibDataSet24.SelectSQL.Clear;
          Form7.ibDataSet24.SelectSQL.Add('update COMPRAS set FORNECEDOR='+QuotedStr(sNomeNovo)+' where FORNECEDOR='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet24.Open;
          //
          // ITENS DE COMPRA
          //
          Form7.ibDataSet23.Close;
          Form7.ibDataSet23.SelectSQL.Clear;
          Form7.ibDataSet23.SelectSQL.Add('update ITENS002 set FORNECEDOR='+QuotedStr(sNomeNovo)+' where FORNECEDOR='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet23.Open;
          //
          // ESTOQUE
          //
          Form7.ibDataSet4.Close;
          Form7.ibDataSet4.SelectSQL.Clear;
          Form7.ibDataSet4.SelectSQL.Add('update ESTOQUE set FORNECEDOR='+QuotedStr(sNomeNovo)+' where FORNECEDOR='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet4.Open;
          //
          // ORCAMENTO
          //
          Form7.ibDataSet27.Close;
          Form7.ibDataSet27.SelectSQL.Clear;
          Form7.ibDataSet27.SelectSQL.Add('update ORCAMENT set CLIFOR='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where CLIFOR='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet27.Open;
          //
          // ALTERACA
          //
          Form7.ibDataSet27.Close;
          Form7.ibDataSet27.SelectSQL.Clear;
          Form7.ibDataSet27.SelectSQL.Add('update ALTERACA set CLIFOR='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where CLIFOR='+QuotedStr(sNomeVolta)+'');
          Form7.ibDataSet27.Open;
          //
          // VENDEDORES
          //
          Form7.ibDataSet9.Close;                                                    //
          Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
          Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME='+QuotedStr(sNomeVolta)+''); //
          Form7.ibDataSet9.DataSource := Nil;
          Form7.ibDataSet9.Open;
          //
          if Form7.ibDataSet9NOME.AsString = sNomeVolta then
          begin
            Form7.ibDataSet9.Edit;
            Form7.ibDataSet9NOME.AsString := sNomeNovo;
            Form7.ibDataSet9.Post;
            //
            Form7.ibDataSet9.Delete;
            //
          end;
          //
          Screen.Cursor := crDefault; // Cursor normal
          //
        end else
        begin
          //
          ibDataSet2.Locate('NOME',sNomeNovo,[]);
          if ibDataSet2NOME.AsString = sNomeNovo then
          begin
            ibDataSet2.Edit;
            sNomeAnterior := sNomeVolta;
            ibDataSet2NOME.AsString := sNomeVolta;
            ibDataSet2.Post;
          end;
          //
          // VENDEDORES
          //
          Form7.ibDataSet9.Close;                                                    //
          Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
          Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME='+QuotedStr(sNomeNovo)+''); //
          Form7.ibDataSet9.DataSource := Nil;
          Form7.ibDataSet9.Open;
          //
          if Form7.ibDataSet9NOME.AsString = sNomeNovo then
          begin
            Form7.ibDataSet9.Delete;
          end;
          //
        end;
      end;
    except ShowMessage('Erro 7/1 ao renomear o nome do cliente.') end;
    //
    Form7.TabelaAberta.EnableControls;
    AgendaCommit(True);
    //
  end;
  //
end;

procedure TForm7.Inadimlencia1Click(Sender: TObject);
var
  Mais1Ini : TiniFile;
  ValorDevido, ValorRecebido: array [0..12] of Real;  // Cria uma matriz com 100 elementos
  F: TextFile;
  iOp1 : Real;
  iAno, I : Integer;
begin
  //
  ShortDateFormat := 'dd/mm/yyyy';
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - INADIMPLNCIA')+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  // cria o grfico de inadim.png
  //
  for iAno := 0 to 10 do
  begin
    //
    WriteLn(F,'<table  border=0 cellspacing=10 cellpadding=10 width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   vAlign=Top align=Right width=50%><a href="'+StrZero((year(Date)-iAno),4,0)+'.png"><img src="'+StrZero((year(Date)-iAno),4,0)+'.png" border="0" width=400 height=200></a></td>');
    WriteLn(F,'  <td   vAlign=Top align=Left width=50%>');
    WriteLn(F,'   <br><br>');
    WriteLn(F,'   <table  border=1  style="border-collapse:Collapse"  cellspacing=0 cellpadding=3>');
    WriteLn(F,'    <tr>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Ms</th>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Valor devido</th>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Valor recebido</th>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Inadimplncia</th>');
    WriteLn(F,'    </tr>');
    //
    for I := 1 to 12 do Valorrecebido[I] := 0;
    for I := 1 to 12 do ValorDevido[I] := 0;
    //
    Form7.IBDataSet99.Close;
    Form7.IBDataSet99.SelectSQL.Clear;
    Form7.IBDataSet99.SelectSQL.Add('select * from RECEBER where coalesce(ATIVO,9)<>1 order by VENCIMENTO');
    Form7.IBDataSet99.Open;
    //
    Form7.ibDataSet99.First;
    while not Form7.ibDataSet99.EOF do
    begin
      //
      if (ibDataSet99.FieldByname('VENCIMENTO').AsDateTime <= Date) and (Form7.ibDataSet7ATIVO.AsString<>'1') then
      begin
        if not ((Year(ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Year(Date)) and (Month(ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Month(Date))) then
        begin
          if ibDataSet99.FieldByname('VALOR_RECE').Value <> 0 then
            if Year(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Year(Date)-iAno then
              Valorrecebido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] := Valorrecebido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] + Form7.ibDataSet99.FieldByname('VALOR_RECE').AsFloat;
          if Year(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Year(Date)-iAno then
          begin
            ValorDevido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] := ValorDevido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] + Form7.ibDataSet99.FieldByname('VALOR_DUPL').AsFloat;
          end;
        end;
      end;
      Form7.ibDataSet99.Next;
    end;
    //
    DeleteFile(pChar(StrZero((year(Date)-iAno),4,0)+'.gra'));
    DeleteFile(pChar(StrZero((year(Date)-iAno),4,0)+'.png'));
    //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\'+StrZero((year(Date)-iAno),4,0)+'.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp',StrZero((year(Date)-iAno),4,0)+'.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','% DE INADIMPLNCIA EM '+StrZero((year(Date)-iAno),4,0));
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Series','1');
    Mais1Ini.WriteString('DADOS','MarcasS1','1');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
    Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); //  Verde
    //
    Mais1Ini.WriteString('DADOS','TituloSerie1',StrZero(Year(Date)-iAno,4,0));
    //
    for I := 1 to 12 do
    begin
      //
      if ValorDevido[I] = 0 then
        iOp1 := 0
      else
        iOp1 := 100-(ValorRecebido[I]/ValorDevido[I]*100);
      //
      WriteLn(F,'    <tr>');
      WriteLn(F,'     <td  ><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Copy(MesExtenso(I),1,3)+'</td>');
      WriteLn(F,'     <td   Align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[ValorDevido[I]])+'</td>');
      WriteLn(F,'     <td   Align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[ValorRecebido[I]])+'</td>');
      WriteLn(F,'     <td   Align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[iOp1])+' %</td>');
      WriteLn(F,'    </tr>');
      //
      //
      //  ValorDevido[i]    = Total do Valor a Receber
      //  Valorrecebido[i]  = Total de Valor Recebido
      //
      if ValorDevido[I] = 0 then
        iOp1 := 0
      else
        iOp1 := 100-(ValorRecebido[I]/ValorDevido[I]*100);

      if iOp1 < 0 then
        iOp1 := 0;
      //
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                           'S1<'+StrTran(Format('%15.2n', [iOp1]),'.','')+
                           '>S2<'+StrTran(Format('%15.2n',[iOp1]),'.','')+
                           '>VX<'+StrZero(I,2,0)+'>LX<'+StrZero(I,2,0)+'>');

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                            'S1<'+StrTran(Format('%15.2n', [iOp1]),'.','')+
                            '>S2<'+StrTran(Format('%15.2n',[iOp1]),'.','')+
                            '>VX<'+StrZero(I,2,0)+'>LX<'+Copy(MesExtenso(I),1,3)+'>');

    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe',pChar(StrZero((year(Date)-iAno),4,0)+'.gra SMALLSOFT'), '', SW_SHOWMINNOACTIVE);
    while not FileExists(StrZero((year(Date)-iAno),4,0)+'.png') do sleep(100);
    //
    WriteLn(F,'  </table>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    //
  end;
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  WriteLn(F,'<center><br><font face="verdana" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
  + Copy(DateTimeToStr(Date),7,4) +', '+ LowerCase(DiaDaSemana(Date)) + ' s ' + TimeToStr(Time)+'</font></center>');
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);                                    // Fecha o arquivo
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;

procedure TForm7.CurvaABC1Click(Sender: TObject);
begin
  //
  Form7.Close;
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Curva ABC de clientes';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.CurvaABCdoestoque1Click(Sender: TObject);
begin
  //
//  commitatudo(True);
  //
//  Form7.Close;
//  Form7.Show;
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Curva ABC do estoque';
  //
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Duplicata1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open', 'smalldupl.exe',pChar(Form7.ibDataSet7DOCUMENTO.AsString+' '+'1'), '', SW_SHOW);
end;

procedure TForm7.Carn1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open', 'smalldupl.exe',pChar(Form7.ibDataSet7DOCUMENTO.AsString+' '+'2'), '', SW_SHOW);
end;

procedure TForm7.Ajuda9Click(Sender: TObject);
begin
  //
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
  //
end;

procedure TForm7.Ajuda7Click(Sender: TObject);
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
end;

procedure TForm7.ibDataSet2OBSSetText(Sender: TField; const Text: String);
begin
  try
    ibDataSet2OBS.AsString := Text;
  except
    ShowMessage('Erro 10/10 comunique o suporte tcnico.');
  end;
end;

procedure TForm7.Analisegrafica1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  J, I : Integer;
  v1: array [0..4] of Real;
  F: TextFile;
  sNome : String;
  bChave : boolean;
begin
  //
  Form7.ibDataSet1.DisableControls;
  //
  try
    //
    for I := 1 to 4 do v1[I] := 0;
    //
    CriaJpg('logotip.jpg');
    //
    ShortDateFormat := 'dd/mm/yyyy';
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE GRFICA DAS CONTAS</b></font>');
    WriteLn(F,'<br><center>');   // Linha em branco
    WriteLn(F,'<br>');           // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //  Form7.ibDataSet1.DisableControls;
    //
    sNome := '';
    //
    ibDataSet1.Close;
    ibDataSet1.SelectSQL.Clear;
    ibDataSet1.SelectSQL.Add('select * from CAIXA order by upper(NOME)');
    ibDataSet1.Open;
    //
    ibDataSet1.First;
    bChave := True;
    //
    while bChave do
    begin
      //
      if (AllTrim(sNome) <> AllTrim(ibDataSet1NOME.AsString)) or (ibDataSet1.Eof) then
      begin
        //
        if ibDataSet1.Eof then bChave := False;
        //
  //      ShowMEssage(ibDataSet1NOME.AsString);
        //
        if (AllTrim(sNome) <> '') then
        begin
          if AllTrim(ibDataSet12NOME.AsString) = AllTrim(sNome) then
          begin
            //
            if allTrim(Form7.ibDataSet12CONTA.AsString) <> '' then
            begin
              //
              DeleteFile(pChar(Form1.sAtual+'\'+allTrim(Form7.ibDataSet12CONTA.AsString)+'.gra'));
              DeleteFile(pChar(Form1.sAtual+'\'+allTrim(Form7.ibDataSet12CONTA.AsString)+'.png'));
              //                               //
              // cria o grfico de receber.png //
              //                               //
              Mais1ini := TIniFile.Create(Form1.sAtual+'\'+AllTrim(Form7.ibDataSet12CONTA.AsString)+'.gra');
              Mais1Ini.WriteString('DADOS','3D','1');
    //          Mais1Ini.WriteString('DADOS','NomeBmp',AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png');
              Mais1Ini.WriteString('DADOS','TituloY','');
              Mais1Ini.WriteString('DADOS','TipoS1','0');
              Mais1Ini.WriteString('DADOS','Titulo',AllTrim(ibDataSet12NOME.AsString));
              Mais1Ini.WriteString('DADOS','Legenda','0');
              Mais1Ini.WriteString('DADOS','Series','1');
              Mais1Ini.WriteString('DADOS','MarcasS1','1');
              Mais1Ini.WriteString('DADOS','TituloX','');
              Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
              Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
              Mais1Ini.WriteString('DADOS','CorS1','13803635');
              Mais1Ini.WriteString('DADOS','CorS2','13421823');
              //
              Mais1Ini.WriteString('DADOS','TituloSerie1','Anos');
              //
              // Se for uma conta negativa multiplica por -1
              //
              J := -1;
              for I := 1 to 4 do if v1[I] > 0 then J := 1;
              //
              for I := 1 to 4 do
              begin
                try
                  Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                               'S1<'+StrTran(Format('%15.2n',[v1[I]*J]),'.','')+'>'+
                                               'S2<'+StrTran(Format('%15.2n',[v1[I]*J]),'.','')+'>'+
                                               'VX<'+StrZero(I,2,0)+'>LX<'+StrZero(Year(Date)-4+I,2,0)+'>');
                except end;
              end;
              //
              Mais1Ini.Free;
              //
              ShellExecute( 0, 'Open', 'graficos.exe', pchar(AllTrim(Form7.ibDataSet12CONTA.AsString)+'.GRA SMALLSOFT'), '', SW_SHOWMINNOACTIVE);
              while not FileExists(AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png') do sleep(10);
              WriteLn(F,'     <br><br><br><a href="'+Form1.sAtual+'\'+AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png"><img src="'+AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png" border="0" width=600 height=300></a>');
              //
              for I := 1 to 4 do v1[I] := 0;
              //
            end;
          end;
        end;
        //
        sNome := ibDataSet1NOME.AsString;
        ibDataSet12.Locate('NOME',Alltrim(ibDataSet1NOME.AsString),[loPartialKey]);
        //
        //
      end;
      //
      // Acumula os valores
      //
      if AllTrim(sNome) <> '' then
      begin
        if Year(date)-3 = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[1] := v1[1] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
        if Year(date)-2 = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[2] := v1[2] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
        if Year(date)-1 = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[3] := v1[3] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
        if Year(date)   = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[4] := v1[4] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
      end;
      //
      ibDataSet1.Next;
      //
    end;
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
    //
    //
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  //
end;

procedure TForm7.ibDataSet4BeforePost(DataSet: TDataSet);
begin
  //
  sRegistro := DataSet.FieldByname('REGISTRO').AsString;
  if ibDataSet4PRECO.AsFloat <=0 then ibDataSet4PRECO.AsFloat := 0.01;
  AssinaRegistro('ESTOQUE',DataSet, True);
  //
end;

procedure TForm7.ibDataSet28NewRecord(DataSet: TDataSet);
begin
  ibDataSet28REGISTRO.AsString := sProximo;
  ibDataSet28CODIGO.AsString := ibDataSet4CODIGO.AsString;
end;

procedure TForm7.MenuItem58Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Romaneio de entrega';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Label38Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open','http://www.smallsoft.com.br','', '', SW_SHOWMAXIMIZED);
end;

procedure TForm7.ibDataSet14BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo VENDAS e o arquivo RECEBER }
  sNumeroAnterior14 := ibDataSet14REGISTRO.AsString;
  sNomeAnterior14 := ibDataSet14NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet14AfterPost(DataSet: TDataSet);
var
  bButton : Integer;
  sNomeNovo, sNomevolta : String;
begin
  //
  // NATUREZE DA OPERAO
  //
  try
    if (sNomeAnterior14 <> ibDataSet14NOME.AsString) and (sNomeAnterior14 <> '') and (sNumeroAnterior14 = ibDataSet14REGISTRO.AsString) then
    begin
      //
      sNomeNovo  := ibDataSet14NOME.AsString;
      sNomeVolta := sNomeAnterior14;
      sRegistro  := ibDataSet14REGISTRO.AsString;
      //
      bButton := Application.MessageBox(Pchar('O nome da natureza da operao foi alterada' +
                                              Chr(10) +
                                              Chr(10) + '     de: ' + sNomeAnterior14 +
                                              Chr(10) + '  para: ' + ibDataSet14NOME.AsString +
                                              Chr(10) +
                                              Chr(10) + 'Os movimentos vo ser atribudos'+
                                              Chr(10) + 'a este novo nome.' + Chr(10) +
                                              Chr(10) +
                                              'Continuar?'+
                 Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
      if bButton = IDYES then
      begin
        //
        // ALTERACA
        //
        Form7.ibDataSet15.Close;
        Form7.ibDataSet15.SelectSQL.Clear;
        Form7.ibDataSet15.SelectSQL.Add('update VENDAS set OPERACAO='+QuotedStr(sNomeNovo)+' where OPERACAO='+QuotedStr(sNomeVolta)+'');
        Form7.ibDataSet15.Open;
        //
        // COMPRAS
        //
        Form7.ibDataSet24.Close;
        Form7.ibDataSet24.SelectSQL.Clear;
        Form7.ibDataSet24.SelectSQL.Add('update COMPRAS set OPERACAO='+QuotedStr(sNomeNovo)+' where OPERACAO='+QuotedStr(sNomeVolta)+'');
        Form7.ibDataSet24.Open;
        //
      end else
      begin
        ibDataSet14.Locate('NOME',sNomeNovo,[]);
        if ibDataSet14NOME.AsString = sNomeNovo then
        begin
          ibDataSet14.Edit;
          sNomeAnterior14 := sNomeVolta;
          ibDataSet14NOME.AsString := sNomeVolta;
          ibDataSet14.Post;
        end;
      end;
      //
    end;
  except ShowMessage('Erro 7/10042 comunique o suporte tcnico.') end;
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet14BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  //
  sNomeAnterior := Form7.ibDataSet14NOME.AsString;
  //
  if AllTrim(Form7.ibDataSet14NOME.AsString) <> '' then
  begin
    sApagar := 'O sistema encontrou lanamentos referentes a esta operao '+Chr(10)+
               'nos seguintes arquivos:'+chr(10)+chr(10);
    // ShowMessage(IntToStr(Length(sApagar)));
    // --------------- //
    // Vendas com NF   //
    // --------------- //
    ibDataSet15.First;
    while not ibDataSet15.Eof do
    begin
      if sNomeAnterior = ibDataSet15OPERACAO.AsString then
      begin
         sApagar := sApagar + '      Movimento de vendas'+Chr(10);
         ibDataSet15.Last;
      end;
      ibDataSet15.Next;
    end;
    Screen.Cursor := crDefault; // Cursor de Aguardo
    ibDataSet15.EnableControls;
    //
    ibDataSet24.DisableControls;
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    // Procura e altera o novo nome no Arquivo de VENDAS//
    ibDataSet24.First;
    while not ibDataSet24.Eof do
    begin
      if sNomeAnterior = ibDataSet24OPERACAO.AsString then
      begin
        sApagar := sApagar + '      Movimento de compras'+Chr(10);
        ibDataSet24.Last;
      end;
      ibDataSet24.Next;
    end;
    Screen.Cursor := crDefault; // Cursor de Aguardo
    ibDataSet24.EnableControls;
    //
    if Length(sApagar) <> 85 then
    begin
      sApagar := sApagar + Chr(10) + Chr(10) + 'Portanto no pode ser apagado.' + Chr(10)
                                             + Chr(10);
      ShowMessage(sApagar);
      Abort;
    end;
    //
  end;
end;

procedure TForm7.ibDataSet28AfterDelete(DataSet: TDataSet);
begin
  Form7.ibDataSet4.Edit;
  Form7.ibDataSet4CUSTOCOMPR.AsFloat := 0; // S atualiza o custo de produtos compostos
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet11PLANOSetText(Sender: TField; const Text: String);
begin
 Form7.ibDataSet12.First;
 while not ibDataSet12.Eof and (AllTrim(Form7.ibDataSet12CONTA.AsString) <> AllTrim(Text)) do ibDataSet12.Next;
 if AllTrim(Form7.ibDataSet12CONTA.AsString) = AllTrim(Text) then Sender.AsString := AllTrim(ibDataSet12CONTA.AsString) else
 begin
   ShowMessage('Esta conta no existe no plano de contas.');
   Sender.AsString := '';
 end;
end;

procedure TForm7.ibDataSet2DATANASSetText(Sender: TField; const Text: String);
begin
  { ------------------------------------------------------------------ }
  { Cuidado: Esta rotina est associada a todos os campos do tipo data }
  { ------------------------------------------------------------------ }
  if Text = '  /  /    ' then
  begin
    Sender.AsString := '';
  end else
  begin
    try
      Sender.AsString := Text;
    except
      begin
        bFlag := False;
        ShowMessage('Esta data no  vlida, digite-a novamente.');
      end;
    end;
  end;
end;

procedure TForm7.MenuItem119Click(Sender: TObject);
begin
  //
  Form37.Caption := 'Relatrio de convnio';
  if Form7.ibDataSet29.MoveBy(+1) = 1 then Form7.ibDataSet29.MoveBy(-1) else if Form7.ibDataSet29.MoveBy(-1) = -1 then ArquivoAberto.MoveBy(+1);
  Form37.ShowModal;
  Form37.Caption := 'Relatrio de comisses';
  //
end;

procedure TForm7.MenuItem118Click(Sender: TObject);
begin
  MenuItem119.Caption    := 'Relatrio do convnio '+AllTrim(ibDataSet29NOME.AsString)+'...';
end;

procedure TForm7.Relatriodetodososconvnios1Click(Sender: TObject);
begin
  //
  Form37.Caption := 'Relatrio de convnio TODOS';
  ibDataSet29.First;
  Form37.ShowModal;
  Form37.Caption := 'Relatrio de comisses';
  //
end;

procedure TForm7.ibDataSet29NOMESetText(Sender: TField;
  const Text: String);
begin
  if Valida_Campo('CONVENIO',Text,'NOME','Este convnio j foi cadastrado') then
  ibDataSet29NOME.AsString := Text;
end;

procedure TForm7.ibDataSet2CONVENIOSetText(Sender: TField; const Text: String);
begin
  //
  ibDataSet29.Locate('NOME',AllTrim(Text),[]);
  //
  if AllTrim(Text) = '' then ibDataSet2CONVENIO.AsString := Text else
    if Pos(AnsiUpperCase(AllTrim(Text)),AnsiUpperCase(ibDataSet29NOME.AsString)) <> 0 then ibDataSet2CONVENIO.AsString := ibDataSet29NOME.AsString else
      ShowMessage('Convnio no cadastrado.');
  //
end;

procedure TForm7.ibDataSet29BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de    }
  { alterar o nome. Se o nome for alterado deve ser  }
  { atualizado o arquivo CLIENTES                    }
  sNumeroAnterior := ibDataSet29REGISTRO.AsString;
  sNomeAnterior   := ibDataSet29NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet29AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  //
  // CONVENIO
  //
  if (sNomeAnterior <> ibDataSet29NOME.AsString) and (sNomeAnterior <> '')  and (sNumeroAnterior = ibDataSet29REGISTRO.AsString) then
  begin
    sNomeNovo  := ibDataSet29NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // VENDAS
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.SelectSQL.Clear;
    Form7.ibDataSet2.SelectSQL.Add('update CLIFOR set CONVENIO='+QuotedStr(sNomeNovo)+' where CONVENIO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet2.Open;
    //
  end;
  //
  if AllTrim(ibDataSet29NOME.AsString) = '' then ibDataSet29.Delete;
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet29BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  if AllTrim(Form7.ibDataSet29NOME.AsString) <> '' then
  begin
    //
    sApagar := '';
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.SelectSql.Clear;
    Form7.ibDataSet2.SelectSql.Add('select * from CLIFOR where CONVENIO <> ''''');
    Form7.ibDataSet2.Open;
    //
    Form7.ibDataSet2.First;
    while not Form7.ibDataSet2.Eof do
    begin
      if AllTrim(Form7.ibDataSet2CONVENIO.AsString) = AllTrim(Form7.ibDataSet29NOME.AsString) then sApagar := 'Este registro no pode ser apagado por'+Chr(10)+'estar relacionado ao cadastro de clientes.';
      Form7.ibDataSet2.Next;
    end;
    //
    if sApagar <> '' then
    begin
      ShowMessage(sApagar);
      Abort;
    end;
    //
  end;
end;

procedure TForm7.ibDataSet29DESCONTOSetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(ibDataSet29NOME.AsString) = '' then Form7.ibDataSet29.Delete else ibDataSet29DESCONTO.AsString := Text;;
end;

procedure TForm7.ibDataSet30NewRecord(DataSet: TDataSet);
begin
  ibDataSet30REGISTRO.AsString := sProximo;
  ibDataSet30CODIGO.AsString   := ibDataSet4CODIGO.AsString;
  ibDataSet30.Post;
  ibDataSet30.Edit;
end;
procedure TForm7.ibDataSet30FilterRecord(DataSet: TDataSet;
  var Accept: Boolean);
begin
  if ibDataSet30CODIGO.AsString = ibDataSet4CODIGO.AsString then Accept := True else Accept := False;

end;

procedure TForm7.Receberconvnio1Click(Sender: TObject);
begin
  //
  Form37.Caption := 'Receber convnio';
  if Form7.ibDataSet29.MoveBy(+1) = 1 then Form7.ibDataSet29.MoveBy(-1) else if Form7.ibDataSet29.MoveBy(-1) = -1 then ArquivoAberto.MoveBy(+1);
  Form37.Panel3.Visible := True;
  Form37.ShowModal;
  Form37.Caption := 'Relatrio de comisses';
  Form37.Panel3.Visible := False;
  //
end;

procedure TForm7.Acertodecontasde1Click(Sender: TObject);
var
  F: TextFile;
  fTotal, fTotal1 : Real;
  I : Integer;
  sNome : String;
begin
  //
  try
//    DeleteFile(pChar('ARQU'+Copy(Form7.ibDataSet20.TableName,5,4)+'.HTM'));
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    try
      Rewrite(F);                           // Abre para gravao
    except
      ShowMessage('No foi possvel gravar no arquivo '+'ARQU001.HTM'+Chr(10)+Chr(10)+'Este programa ser fechado.');
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
    end;
    //
    Writeln(F,'<html><head><title>'+AllTrim(Form7.Acertodecontasde1.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="30">');
    //
    WriteLn(F,'<center><img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font size=3 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font></center>');
    WriteLn(F,'<hr><font face="Microsoft Sans Serif" size=3 color=#000000><b>Cliente: '+AllTrim(Form7.ibDataSet7NOME.AsString)+'</b></font><hr>');
    //
    Form7.ibDataSet7.DisableControls;
    //
    // CONTAS A RECEBER
    //
    fTotal  := 0;
    fTotal1 := 0;
    //
    Writeln(F,'<br><font face="Microsoft Sans Serif" size=1><b>CONTAS A RECEBER</b>');
    WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Documento</td>');
    WriteLn(F,'  <td  width=300 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Histrico</td>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Vencimento</td>');
    WriteLn(F,'  <td  width=100 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Valor</td>');
    WriteLn(F,'  <td  width=100 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Valor Atual</td>');
    WriteLn(F,' </tr>');
    //
    sNome := Form7.ibDataSet7NOME.AsString;
    //
    Form7.ibDataSet7.First;
    while not (Form7.ibDataSet7.Eof) do
    begin
      if (Form7.ibDataSet7VALOR_RECE.AsFloat = 0) and (AllTrim(Form7.ibDataSet7NOME.AsString) = AllTrim(sNome)) then
      begin
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet7DOCUMENTO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet7HISTORICO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+DateTimeToStr(Form7.ibDataSet7VENCIMENTO.AsDateTime)+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%10.2n',[Form7.ibDataSet7VALOR_DUPL.AsFloat])+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%10.2n',[Form7.ibDataSet7VALOR_JURO.AsFloat])+'</td>');
        WriteLn(F,' </tr>');
        fTotal  := fTotal  + Form7.ibDataSet7VALOR_DUPL.AsFloat;
        fTotal1 := fTotal1 + Form7.ibDataSet7VALOR_JURO.AsFloat;
      end;
      Form7.ibDataSet7.Next;
    end;
    //
    // Totalizador
    //
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal])+'</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal1])+'</td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table><br><br><br>');
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
    I := Application.MessageBox(Pchar('Tem certeza que quer efetuar quitao das contas'
                            + chr(10)+'a receber do cliente '+AllTrim(sNome)+chr(10)
                            +' no valor de R$ '+AllTrim(Format('%12.2n',[fTotal]))+chr(10)
                            +' Conforme apresentado no relatrio?'
                            + Chr(10))
                            ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);
    if I = IDYES then
    begin
      //
      I := Application.MessageBox(Pchar('Imprimir recibo?'
                            + Chr(10))
                            ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION);
      if I = IDYES then
      begin
        Form7.fTotalDoRecibo       := fTotal;
        Form7.sReciboProvenienteDe := 'Referente ao pagamento das duplicatas de '+AllTrim(sNome);
        Form7.sReciboRecebemosDe   := AllTrim(sNome);
        Form7.RECIBOClick(Sender);
      end;
      //
      // CONTAS A RECEBER
      //
      Form7.sModulo := 'AUTOMATICO';
      //
      Form7.ibDataSet7.First;
      //
      while (not Form7.ibDataSet7.Eof) do
      begin
        //
        if (Form7.ibDataSet7VALOR_RECE.AsFloat = 0) and (Form7.ibDataSet7NOME.AsString = sNome) then
        begin
          Form7.ibDataSet7.Edit;
          Form7.ibDataSet7RECEBIMENT.AsDateTime := Date;
          Form7.ibDataSet7VALOR_RECE.AsFloat    := Form7.ibDataSet7VALOR_DUPL.AsFloat;
          Form7.ibDataSet7.Post;
        end;
        Form7.ibDataSet7.Next;
        //
        if ((Form7.ibDataSet7.Eof) and ((Form7.ibDataSet7VALOR_RECE.AsFloat = 0) and (Form7.ibDataSet7NOME.AsString = sNome))) then Form7.ibDataSet7.First;
        //
      end;
      Form7.sModulo := 'RECEBER';
      //
    end;
  except
  end;
  //
  Form7.ibDataSet7.EnableControls;
  //
end;

procedure TForm7.RECIBOClick(Sender: TObject);
var
  rRect : Trect;
  Mais1Ini : TiniFile;
  I, Tamanho, iTamanho, iColunas: Integer;
  sTexto : String;
begin
  try
    //
    Mais1Ini := TIniFile.Create('retaguarda.ini');
    Mais1Ini.UpdateFile;
    //
    //
    if PrintDialog1.Execute then
    begin
      //
      iTamanho := 10;
      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
      Printer.Canvas.Font.Style := [];                // Fonte
      Printer.Canvas.Font.Size  := iTamanho;          // Tamanho da Fonte
      Printer.Canvas.Font.Color := clBlack;           // Cor da Fonte
      Tamanho  := Printer.Canvas.TextWidth('a');       // Tamanho que cada caractere ocupa na impresso em pontos
      icolunas := (Printer.PageWidth div Tamanho)-2;
      //
      if iColunas > 80 then iTamanho := 11;
      if iColunas < 40 then iTamanho := 9;
      if iColunas < 30 then iTamanho := 6;
      //
      if iColunas > 80 then
      begin
        //
        rRect.Top     := Tamanho * 2;
        rRect.Left    := Tamanho * 2;
        rRect.Right   := ((Printer.PageWidth-(Tamanho*2))) div 3;
        rRect.Bottom  := ((Printer.PageWidth-(Tamanho*2)) div 4) div 3;
        //
      end else
      begin
        //
        rRect.Top     := Tamanho;
        rRect.Left    := Tamanho;
        rRect.Right   := (Printer.PageWidth-(Tamanho*2));
        rRect.Bottom  := (Printer.PageWidth-(Tamanho*2)) div 4;
        //
      end;
      ////////////////////////////////////////////////////////
      //         IMPRESSO DO RECIBO EM JATO DE TINTA       //
      ////////////////////////////////////////////////////////
      if FileExists(Form1.sAtual+'\LOGOTIP.BMP') then Form14.Image1.Picture.LoadFromFile('LOGOTIP.BMP');
      //
      Screen.Cursor             := crHourGlass;       // Cursor de Aguardo
      Printer.Canvas.Pen.Width  := 3;                // Largura da linha
      Printer.Canvas.Pen.Style  := psSolid;
      //
      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
      Printer.Canvas.Font.Style := [];                // Fonte
      Printer.Canvas.Font.Size  := iTamanho;          // Tamanho da Fonte
      Printer.Canvas.Font.Color := clBlack;           // Cor da Fonte
      //
      Tamanho  := Printer.Canvas.TextWidth('a');       // Tamanho que cada caractere ocupa na impresso em pontos
      icolunas := (Printer.PageWidth div Tamanho)-2;
      //
      Printer.Title := 'Recibo';                      // Este ttulo  visto no spoool da impressora
      //
      Printer.BeginDoc;   // Inicia o documento de impresso
      //
      Printer.Canvas.Font.Size  := iTamanho;
      Printer.Canvas.StretchDraw(rRect,Form14.Image1.Picture.Graphic);
      //
      // Linha da Margem Superior
      //
      Printer.Canvas.Brush.Style := bsClear;
      Printer.Canvas.Font.Size   := iTamanho;
      Printer.Canvas.Rectangle(10,10, (Printer.PageWidth)-10,(Tamanho * 60)-10);
      //
      // Titulo
      //
      Printer.Canvas.Font.Name  := 'Times';           // Fonte
      Printer.Canvas.Font.Size  := iTamanho * 3;      // Tamanho da Fonte
      Printer.Canvas.Font.Style := [fsBold];  // Coloca em negrito
      Printer.Canvas.TextOut(((Printer.PageWidth div 2) - (Printer.Canvas.TextWidth('Recibo') div 2)),Tamanho * 9,'Recibo');
      //
      // R$ Valor
      //
//      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
//      Printer.Canvas.Font.Size  := iTamanho * 2;        // Tamanho da Fonte
      Printer.Canvas.TextOut(((Printer.PageWidth div 2) - (Printer.Canvas.TextWidth('R$ '+AllTrim(Format('%10.2n',[fTotalDoRecibo]))) div 2)),Tamanho * 14,'R$ '+AllTrim(Format('%10.2n',[fTotalDoRecibo])));
      //
      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
      Printer.Canvas.Font.Style := [];
      Printer.Canvas.Font.Size  := iTamanho;
      //
      // Pagador
      //
      sTexto := 'Recebemos de: '+AllTrim(Form7.sReciboRecebemosDe)+' a importncia de ' + AllTrim(Extenso(fTotalDoRecibo)) + ' ' + Form7.sReciboProvenienteDe+Replicate(' ',500);
      //
      for I := 0 to 6 do
      begin
        Printer.Canvas.TextOut(Tamanho * 2,Tamanho * (21 + (I*2)),AllTrim(Copy(sTexto,((I*icolunas)+1),icolunas)));
      end;
      //
      // Local e data de pagamento
      //
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 36,Form7.ibDataSet13.FieldByName('MUNICIPIO').AsString + ' (' + Uppercase(Form7.ibDataSet13.FieldByname('ESTADO').AsString) + '),');
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 38,IntToStr(Day(Date)) + ' de ' + Alltrim(MesExtenso(Month(Date))) + ' de ' + IntToStr(Year(Date)));
      //
      // Assinatura
      // Dados do emitente
      //
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 44, Replicate('_', Length(Form7.ibDataSet13.FieldByName('NOME').AsString)));
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 46,Form7.ibDataSet13.FieldByName('NOME').AsString);
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 48,'CNPJ/CPF: '+Form7.ibDataSet13.FieldByName('CGC').AsString);
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 50,'Insc. Estadual '+Form7.ibDataSet13.FieldByName('IE').AsString);
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 52,AllTrim(Form7.ibDataSet13.FieldByName('ENDERECO').AsString)+' - '+AllTrim(Form7.ibDataSet13.FieldByName('COMPLE').AsString));
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 54,'Fone: '+AllTrim(Form7.ibDataSet13.FieldByName('TELEFO').AsString));
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 56,Form7.ibDataSet13.FieldByName('CEP').AsString+' ' + AllTrim(Form7.ibDataSet13.FieldByName('MUNICIPIO').AsString)+' - ' + AllTrim(Uppercase(Form7.ibDataSet13.FieldByname('ESTADO').AsString)));
      //
      Printer.EndDoc;
      Screen.Cursor := crDefault;
      //
    end;
  except end;
end;

procedure TForm7.ibDataSet12BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
  MyBookMark : TBookMark;
begin
  if AllTrim(Form7.ibDataSet12NOME.AsString) <> '' then
  begin
    //
    MyBookMark := Form7.ibDataSet12.GetBookmark;
    sApagar := '';
    Form7.ibDataSet1.DisableControls;
    Form7.ibDataSet1.First;
    while not Form7.ibDataSet1.Eof do
    begin
      if AllTrim(Form7.ibDataSet1NOME.AsString) = AllTrim(Form7.ibDataSet12NOME.AsString) then
      begin
        sApagar := 'Este registro no pode ser apagado por'+Chr(10)+'estar relacionado ao livro caixa.';
        Form7.ibDataSet1.Last;
      end;
      Form7.ibDataSet1.Next;
    end;
    Form7.ibDataSet1.EnableControls;
    //
    if sApagar <> '' then
    begin
      Form7.ibDataSet12.GotoBookmark(MyBookMark);
      ShowMessage(sApagar);
      Abort;
    end;
    //
  end;
end;

procedure TForm7.ibDataSet14NOMESetText(Sender: TField; const Text: String);
begin
  if Valida_Campo('ICM',Text,'NOME','Esta operao j foi cadastrada') then
  ibDataSet14NOME.AsString := Text;
end;

procedure TForm7.ibDataSet1AfterDelete(DataSet: TDataSet);
begin
  //
//  MybookMark := ibDataSet1.GetBookmark;
  if sModulo = 'CAIXA' then CalculaSAldo(True);
//  ibDataSet1.GotoBookmark(MybookMark);
  AgendaCommit(True);
  //
end;

procedure TForm7.Colunas1Click(Sender: TObject);
begin
  //
  Form9.Close;
  Form9.Show;
  //
end;

procedure TForm7.Image208Click(Sender: TObject);
begin
  //
  if (Form7.sModulo = 'OS')    or
     (Form7.sModulo = 'VENDA') or
     (Form7.sModulo = 'ORCAMENTO') or
     (Form7.sModulo = 'COMPRA')  then Abort;
  //
  if Form7.DBGrid1.Options = [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize] then // Boto Libera
  begin
    Form7.DBGrid1.Options   := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];        // Boto Libera
    Form7.dbGrid1.ReadOnly  := False;
    Form7.Image208.Visible  := False; Form7.Label208.Caption  := 'Bloquear';
    Form7.Image308.Visible  := True;
  end else
  begin
    Form7.DBGrid1.Options   := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];                                 // Boto Libera
    Form7.dbGrid1.ReadOnly  := True;
    Form7.Image308.Visible  := False;
    Form7.Image208.Visible  := True; Form7.Label208.Caption  := 'Liberar';
  end;
  //
  dBGrid1.Repaint;
  //
  if ArquivoAberto.Active then
  begin
    if Form7.DBGrid1.CanFocus then Form7.DBGrid1.SetFocus;
    if ArquivoAberto.MoveBy(+1) = 1 then ArquivoAberto.MoveBy(-1) else if ArquivoAberto.MoveBy(-1) = -1 then ArquivoAberto.MoveBy(+1);
  end;
  //
end;

procedure TForm7.ibDataSet8VALOR_DUPLChange(Sender: TField);
begin
  if ibDataSet8VALOR_DUPL.AsFloat < 0 then ibDataSet8VALOR_DUPL.AsFloat := 0;
end;

procedure TForm7.ibDataSet8VALOR_PAGOChange(Sender: TField);
begin
  if Form10.Visible then
  begin
    if Form10.Button1.CanFocus then
    begin
      Form10.Button1.Default := True;
      Form10.Button1.Default := False;
      Form10.Button1.SetFocus;
    end;
  end;
  if ibDataSet8VALOR_PAGO.AsFloat < 0 then
    ibDataSet8VALOR_PAGO.AsFloat := 0;
end;

procedure TForm7.ibDataSet8VALOR_PAGOValidate(Sender: TField);
begin
  //
  if ibDataSet1.Locate('HISTORICO',copy('Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString,1,25),[loPartialKey]) then
  begin
    if AllTrim(Copy(ibDataSet1HISTORICO.AsString,1,25)) = AllTrim(copy('Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString,1,25)) then
    begin
      ibDataSet1.Delete;
    end;
  end;
  //
  if ibDataSet8VALOR_PAGO.Value > 0
    then if ibDataSet8PAGAMENTO.AsString = ''
      then ibDataSet8PAGAMENTO.AsDateTime := Date + Time;
  //
  if ibDataSet8VALOR_PAGO.Value <> 0 then // Se valor Zero apaga o antigo mas no grava o novo
  begin
    ibDataSet1.Append;
    ibDataSet1DATA.AsDateTime    := ibDataSet8PAGAMENTO.AsDateTime + Time;
    ibDataSet1SAIDA.AsFloat      := ibDataSet8VALOR_PAGO.AsFloat;
    ibDataSet1HISTORICO.AsString := 'Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString;
    ibDataSet1NOME.AsString      := ibDataSet8CONTA.AsString;     // contas bancrias
    ibDataSet1.Post;
  end;
  //
end;

procedure TForm7.ibDataSet8NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet8REGISTRO.AsString := sProximo;
  ibDataSet8VALOR_PAGO.AsFloat    := 0;
  ibDataSet8VALOR_DUPL.AsFloat    := 0;
  ibDataSet8EMISSAO.AsDateTime    := Date;
  { Sugere sempre a data de vencimento de acordo com a configurao }
  ibDataSet8VENCIMENTO.AsDateTime := SomaDias(Date,StrToInt(AllTrim(Form19.MaskEdit4.Text)));
  ibDataSet8PORTADOR.AsString     := '';
  //
end;

procedure TForm7.Mostrartodososclientesefornecedores1Click(
  Sender: TObject);
begin
  //
  sWhere := '';
  //
  Form7.Close;
  Form7.Show;
  //
  Mostrartodososclientesefornecedores1.Checked := False;
  //
end;

procedure TForm7.Sosclientes1Click(Sender: TObject);
begin
  //
  sWhere := 'where CLIFOR='+QuotedStr('C')+ ' ';
  //
  Form7.Close;
  Form7.Show;
  //
  Mostrartodososclientesefornecedores1.Checked := False;
  //
end;

procedure TForm7.Sosfornecedores1Click(Sender: TObject);
begin
  //
  sWhere := 'where CLIFOR='+QuotedStr('F')+ ' ';
  //
  Form7.Close;
  Form7.Show;
  //
  Mostrartodososclientesefornecedores1.Checked := False;
  //
end;

procedure TForm7.Acertodecontasde2Click(Sender: TObject);
var
  F: TextFile;
  fTotal : Real;
  I : Integer;
  sNome : String;
begin
  //
  try
    DeleteFile(pChar(Senhas.UsuarioPub+'.HTM'));
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    try
      Rewrite(F);                           // Abre para gravao
    except
      ShowMessage('No foi possvel gravar no arquivo '+'ARQU001.HTM'+Chr(10)+Chr(10)+'Este programa ser fechado.');
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
    end;
    //
    Writeln(F,'<html><head><title>'+AllTrim(Form7.Acertodecontasde2.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="30">');
    //
    WriteLn(F,'<center><img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font size=3 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font></center>');
    WriteLn(F,'<hr><font face="Verdana" size=3 color=#000000><b>Fornecedor: '+AllTrim(Form7.ibDataSet8NOME.AsString)+'</b></font><hr>');
    //
    Form7.ibDataSet8.DisableControls;
    //
    // CONTAS A RECEBER
    //
    fTotal  := 0;
    //
    Writeln(F,'<br><font face="Verdana" size=1><b>CONTAS A PAGAR</b>');
    WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Documento</td>');
    WriteLn(F,'  <td  width=300 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Histrico</td>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Vencimento</td>');
    WriteLn(F,'  <td  width=100 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Valor</td>');
    WriteLn(F,' </tr>');
    //
    sNome := Form7.ibDataSet8NOME.AsString;
    //
    Form7.ibDataSet8.First;
    while not (Form7.ibDataSet8.Eof) do
    begin
      if (Form7.ibDataSet8VALOR_PAGO.AsFloat = 0) and (Form7.ibDataSet8NOME.AsString = sNome) then
      begin
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+Form7.ibDataSet8DOCUMENTO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+Form7.ibDataSet8HISTORICO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+DateTimeToStr(Form7.ibDataSet8VENCIMENTO.AsDateTime)+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+Format('%10.2n',[Form7.ibDataSet8VALOR_DUPL.AsFloat])+'</td>');
        WriteLn(F,' </tr>');
        fTotal  := fTotal  + Form7.ibDataSet8VALOR_DUPL.AsFloat;
      end;
      Form7.ibDataSet8.Next;
    end;
    //
    // Totalizador
    //
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Verdana" size=1>'+Format('%12.2n',[fTotal])+'</td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table><br><br><br>');
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
    I := Application.MessageBox(Pchar('Tem certeza que quer efetuar o pagamento das contas'
                            + chr(10)+'a pagar do fornecedor '+AllTrim(sNome)+chr(10)
                            +' no valor de R$ '+AllTrim(Format('%12.2n',[fTotal]))+chr(10)
                            +' Conforme apresentado no relatrio?'
                            + Chr(10))
                            ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);
    if I = IDYES then
    begin


      //
      // CONTAS A PAGAR
      //
      Form7.sModulo := 'AUTOMATICO';
      //
      Form7.ibDataSet8.First;
      //
      while (not Form7.ibDataSet8.Eof) do
      begin
        if (Form7.ibDataSet8VALOR_PAGO.AsFloat = 0) and (Form7.ibDataSet8NOME.AsString = sNome) then
        begin
          Form7.ibDataSet8.Edit;
          Form7.ibDataSet8VALOR_PAGO.AsFloat := Form7.ibDataSet8VALOR_DUPL.AsFloat;
          Form7.ibDataSet8.Post;
        end;
        Form7.ibDataSet8.Next;
        //
        if ((Form7.ibDataSet8.Eof) and ((Form7.ibDataSet8VALOR_PAGO.AsFloat = 0) and (Form7.ibDataSet8NOME.AsString = sNome))) then Form7.ibDataSet8.First;
        //
      end;
      Form7.sModulo := 'PAGAR';
      //
    end;
  except end;
  //
  Form7.ibDataSet8.EnableControls;
  //
end;

procedure TForm7.MenuItem71Click(Sender: TObject);
begin
  //
  if sModulo = 'PAGAR'  then
  begin
    Acertodecontasde1.Visible := False;
    //
    Acertodecontasde2.Visible := True;
    Acertodecontasde2.Caption := 'Pagar contas de: '+Form7.ibDataSet8NOME.AsString;
    //
  end;
  //
end;

procedure TForm7.odas1Click(Sender: TObject);
begin
  //
  // Destaca o menu ativo
  //
  sWhere := ''; 
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked         := True;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked := False;
  //
end;

procedure TForm7.Receber2Click(Sender: TObject);
begin
  //
  sWhere := ' where Coalesce(VALOR_RECE,0)=0';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Odas1.Checked          := False;
  Receber2.Checked       := True;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := False;
end;

procedure TForm7.Jrecebidas2Click(Sender: TObject);
begin
  //
  sWhere := ' where VALOR_RECE<>0';
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := True;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := False;
  //
end;

procedure TForm7.Atrasadas3Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_RECE = 0 and VENCIMENTO < CURRENT_DATE';
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := True;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := False;
  //
end;

procedure TForm7.Avencer3Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_RECE = 0 and VENCIMENTO > CURRENT_DATE';
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := True;
  Vencendohoje2.Checked  := False;
  //
end;

procedure TForm7.Vencendohoje2Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_RECE = 0 and VENCIMENTO = CURRENT_DATE';
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := True;
  //
end;

procedure TForm7.odas2Click(Sender: TObject);
begin
  //
  sWhere := '';
  //
  Form7.Close;
  Form7.Show;
  //
  Form7.odas2.Checked    := True;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Pagar2Click(Sender: TObject);
begin
  //
  sWhere := ' where VALOR_PAGO=0';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := True;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Jpagas2Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO<>0';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := True;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Avencer1Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO=0 and VENCIMENTO > CURRENT_DATE';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := True;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Atrasadas1Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO=0 and VENCIMENTO < CURRENT_DATE';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := True;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Vencendohoje3Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO=0 and VENCIMENTO=CURRENT_DATE';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := True;
  //
end;

procedure TForm7.odas3Click(Sender: TObject);
begin
  //
  sWhere := '';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativ
  //
  Odas3.Checked                  := True;
  Lanamentoscompensados1.Checked  := False;
  Lanamentosnocompensados1.Checked := False;
  //
end;

procedure TForm7.Lanamentoscompensados1Click(Sender: TObject);
begin
  //
  sWhere := 'where NOME=' + QuotedStr(Form1.sEscolhido)+' and COMPENS <>'+QuotedStr('1899/12/30');
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativ
  //
  Odas3.Checked                  := False;
  Lanamentoscompensados1.Checked  := True;
  Lanamentosnocompensados1.Checked := False;
  //
end;

procedure TForm7.Lanamentosnocompensados1Click(Sender: TObject);
var
  I : Integer;
begin
  //
  Screen.Cursor  := crHourGlass;    // Cursor de Aguardo
  sWhere := 'where NOME=' + QuotedStr(Form1.sEscolhido)+' and (COMPENS='+QuotedStr('1899/12/30')+' or coalesce(COMPENS,'+QuotedStr('1899/12/30')+')='+QuotedStr('1899/12/30')+') ';
  Form7.Close;
  Form7.Show;
  //
  sMostra := 'TTTTTFTFFFF';
  with ArquivoAberto do
  begin
    for I := 1 to iCampos do  if copy(sMostra,I,1) = 'T' then Fields[I-1].Visible := True
    else  Fields[I-1].Visible := False;
  end;
  //
end;

procedure TForm7.Label3MouseLeave(Sender: TObject);
begin
  with Sender as tLabel do Font.Style := [];
end;

procedure TForm7.Label3MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  with Sender as tLabel do Font.Style := [fsBold];
end;

procedure TForm7.ibDataSet2BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  if AllTrim(Form7.ibDataSet2NOME.AsString) <> '' then
  begin
    sApagar := 'O sistema encontrou lanamentos referentes a este cliente '+Chr(10)+
               'nos seguintes arquivos:'+chr(10)+chr(10);
    // --------------- //
    // Vendas com NF   //
    // --------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIENTE from VENDAS where CLIENTE='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIENTE').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Movimento de vendas'+Chr(10);
    // ---------------- //
    // Vendas no balco //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIFOR from ALTERACA where CLIFOR='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIFOR').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Vendas no balco'+Chr(10);
    // ---------------- //
    // Vendas no balco //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIFOR from ORCAMENT where CLIFOR='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIFOR').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Oramentos'+Chr(10);
    // ---------------- //
    // Contas a receber //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select NOME from RECEBER where NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('NOME').AsString = Form7.ibDataSet2NOME.AsString then  sApagar := sApagar + '      Contas a receber'+Chr(10);
    // --------------- //
    // Compras com NF  //
    // --------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select FORNECEDOR from COMPRAS where FORNECEDOR='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('FORNECEDOR').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Movimento de compras'+Chr(10);
    // --------------- //
    // OS              //
    // --------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIENTE from OS where CLIENTE='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIENTE').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      OS'+Chr(10);
    // ---------------- //
    // Contas a Pagar   //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select NOME from PAGAR where NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('NOME').AsString = Form7.ibDataSet2NOME.AsString then  sApagar := sApagar + '      Contas a pagar'+Chr(10);
    //
    if Length(sApagar) <> 84 then
    begin
      sApagar := sApagar + Chr(10) + Chr(10) + 'Portanto no pode ser apagado.' + Chr(10)
                                             + Chr(10)
                                             + 'Para tornar este cliente inativo entre no menu "Edita"'
                                             + Chr(10) + 'e desabilite a opo "Ativo".' + Chr(10);
      ShowMessage(sApagar);
      Abort;
    end;
    //
    DeleteFile(Pchar('contatos\'+AllTrim(LimpaLetrasPor_(Form7.ibDataSet2NOME.AsString))+'.txt')); // Quando apara o cliente
    //
  end;
  //
  Form7.ibDataSet9.Close;                                                    //
  Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
  Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME=:NOME'); //
  Form7.ibDataSet9.DataSource := DataSource2;
  Form7.ibDataSet9.Open;
  //
  if Form7.ibDataSet9NOME.AsString = Form7.ibDataset2NOME.AsString then
  begin
    try
      Form7.ibDataSet9.Delete;
    except end;
  end;
  //
end;

procedure TForm7.Image_FechaClick(Sender: TObject);
begin
  //
  try
    if Form12.Visible then Form12.Close;
  except end;
  //
  try
    if Form24.Visible then Form24.Close;
  except end;
  //
  Form7.Close;
  Label1.Caption := 'Small Commerce';
  Label2.Caption := 'Small Commerce';
  //
end;

procedure TForm7.Balanas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form7.sModulo   := 'BALANCA';
  Form38.Caption  := 'Exportao de arquivo TXT para balana';
  //
  Form38.Panel1.Visible := True;
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Fechadas1Click(Sender: TObject);
begin
  //
  sWhere := 'where upper(SITUACAO)='+QuotedStr('FECHADA');
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := True;
  //
end;

procedure TForm7.Abertas1Click(Sender: TObject);
begin
  //
  sWhere := 'where upper(SITUACAO)='+QuotedStr('ABERTA');
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := True;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := True ;
  Fechadas1.Checked         := False;
  //
end;

procedure TForm7.MenuItem147Click(Sender: TObject);
begin
  //
  sWhere := '';
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := True;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := False;
  //
end;

procedure TForm7.Image210Click(Sender: TObject);
begin
//  Form6.Show;
end;

procedure TForm7.ibDataSet3TOTAL_FRETChange(Sender: TField);
begin
  TotalizaOS(True);
end;

procedure TForm7.Image204Click(Sender: TObject);
begin
  //
  if (Form7.sModulo = 'ORCAMENTO') then
  begin
    if FileExists(Form1.sAtual+'\ORCAMENTOS\'+'Oramento '+Form7.ibDataSet97.FieldByname('Oramento').AsString+'.htm') then
    begin
      ShellExecute( 0,'Open',pChar(Form1.sAtual+'\ORCAMENTOS\'+'Oramento '+  Form7.ibDataSet97.FieldByname('Oramento').AsString  +'.htm'),'','', SW_SHOW);
    end else
    begin
      if FileExists(Form1.sAtual+'\Oramento '+Form7.ibDataSet97.FieldByname('Oramento').AsString+'.htm') then
      begin
        ShellExecute( 0,'Open',pChar('Oramento '+  Form7.ibDataSet97.FieldByname('Oramento').AsString  +'.htm'),'','', SW_SHOW);
      end;
    end;
    Abort;
  end;
  //
  Form38.DateTimePicker1.Date := StrToDate('31/12/1899');
  Form10.Image203Click(Sender);
  //
end;

procedure TForm7.ibDataSet9NewRecord(DataSet: TDataSet);
begin
  ibDataSet9.Edit;
  ibDataSet9REGISTRO.AsString := sProximo;
  //
  if Form7.sWhere  = 'where CLIFOR='+QuotedStr('Vendedor') then
  begin
    ibDataSet9FUNCAO.AsString   := 'VENDEDOR';
  end else
  begin
    ibDataSet9FUNCAO.AsString   := 'TECNICO';
  end;
  //
end;

procedure TForm7.ibDataSet34AfterPost(DataSet: TDataSet);
begin
  if AllTrim(Form7.ibDataSet35DESCRICAO.AsString) = '' then
  begin
    Form7.ibDataSet35.Delete;
    Form7.ibDataSet35.Append;
    Form7.ibDataSet35.Last;

  end;
end;

procedure TForm7.ibDataSet3BeforeDelete(DataSet: TDataSet);
begin
  //
  // Reaproveita o Nmero da OS
  //
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_NUMEROOS,0) from rdb$database');
  IBDataSet99.Open;
  //
  if Form7.ibDataSet3NUMERO.AsString = StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0) then
  begin
    //
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select gen_id(G_NUMEROOS,-1) from rdb$database');
    IBDataSet99.Open;
    //
  end;
  //
end;

procedure TForm7.Agendada1Click(Sender: TObject);
begin
  //
  sWhere := 'where upper(SITUACAO)='+QuotedStr('AGENDADA');
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := True;
  //
end;

procedure TForm7.Cadastrodetcnicos1Click(Sender: TObject);
begin
  //
  Label1.Caption := 'CADASTRO DE TCNICOS';
  //
  Form7.Close;
  Form7.sModulo := 'TECNICO';
  Form7.sTitulo := Label1.Caption;
  Form7.sRPS := 'N';
  Form7.Show;
  //
end;

procedure TForm7.RelatriodepeasemOSabertas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible          := True;
  Form38.Label3.Visible          := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Peas em OS abertas';
  Form38.ShowModal; // Ok
  Form38.Label17.Visible := False;
  IbDataSet3.EnableControls;
  //
end;

procedure TForm7.ibDataSet3SITUACAOChange(Sender: TField);
begin
  //
  if Form7.ibDataSet3SITUACAO.AsString = 'Fechada' then
  begin
    if AllTrim(Form7.ibDataSet3DATA_ENT.AsString) = '' then
    begin
      Form7.ibDataSet3.Edit;
      Form7.ibDataSet3DATA_ENT.AsDateTime := Date;
      Form7.ibDataSet3HORA_ENT.AsString   := TimeToStr(Time);
    end;
  end else
  begin
    Form7.ibDataSet3.Edit;
    Form7.ibDataSet3DATA_ENT.AsString := '';
    Form7.ibDataSet3HORA_ENT.AsString := '';
  end;
  //
end;

procedure TForm7.Imprimirrecibo1Click(Sender: TObject);
var
  F: TextFile;
begin
  //
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet3CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  begin
    //
    CriaJpg('logotip.jpg');
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    Writeln(F,'<html><head><title>'+AllTrim(Form7.ibDataSet13NOME.AsString) + ' - RECIBO DE ENTREGA</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<table  border=1  cellspacing=1 cellpadding=5 Width=600 style="border-collapse: collapse"  >');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  >');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=600>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <P><font face="Microsoft Sans Serif" size=1> '+Form7.ibDataSet13NOME.AsString);
    WriteLn(F,'   <BR>CNPJ: '+Form7.ibDataSet13CGC.AsString+' IE: '+Form7.ibDataSet13IE.AsString);
    WriteLn(F,'   <BR>' + AllTrim(Form7.ibDataSet13ENDERECO.AsString) + ' - ' + AllTrim(Form7.ibDataSet13COMPLE.AsString));
    WriteLn(F,'   <BR>' + AllTrim(Form7.ibDataSet13CEP.AsString) + ' ' + AllTrim(Form7.ibDataSet13MUNICIPIO.AsString) + ' - ' + AllTrim(UpperCase(Form7.ibDataSet13ESTADO.AsString)) );
    WriteLn(F,'   <BR>Telefone: ' + AllTrim(Form7.ibDataSet13TELEFO.AsString));
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'<table>');
    WriteLn(F,'<table  border=0 cellspacing=0 cellpadding=0 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <center><font face="Microsoft Sans Serif" size=4><b>RECIBO DE ENTREGA - OS '+Form7.ibDataSet3NUMERO.AsString+'</b></center>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Cliente: <b>'+Form7.ibDataSet2NOME.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Contato: <b>'+AllTrim(Form7.ibDataSet2CONTATO.AsString)+'</b> Telefone: <b>'+AllTrim(Form7.ibDataSet2FONE.AsString)+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Endereo: <b>'+AllTrim(Form7.ibDataSet2ENDERE.AsString)+' - '+ AllTrim(Form7.ibDataSet2COMPLE.AsString)+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Cidade: <b>'+Form7.ibDataSet2CEP.AsString + ' ' + AllTrim(Form7.ibDataSet2CIDADE.AsString) + ' ' + AllTrim(Form7.ibDataSet2ESTADO.AsString)+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Atendente: <b>'+Form7.ibDataSet3TECNICO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Data da entrada: <b>'+Form7.ibDataSet3DATA.AsString+' '+Form7.ibDataSet3HORA.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Agendado para: <b>'+Form7.ibDataSet3DATA_PRO.AsString+' '+Form7.ibDataSet3HORA_PRO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Tempo estimado: <b>'+Form7.ibDataSet3TEMPO.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');

    WriteLn(F,'       <font face="Microsoft Sans Serif" size=2>'+Form30.Label14.Caption+': <b>'+Form7.ibDataSet3DESCRICAO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label15.Caption+': <b>'+Form7.ibDataSet3IDENTIFI1.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label16.Caption+': <b>'+Form7.ibDataSet3IDENTIFI2.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'       <font face="Microsoft Sans Serif" size=2>'+Form30.Label17.Caption+': <b>'+Form7.ibDataSet3IDENTIFI3.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label18.Caption+': <b>'+Form7.ibDataSet3IDENTIFI4.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label30.Caption+': <b>'+Form7.ibDataSet3GARANTIA.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>'+Form30.Label19.Caption+': <b>'+Form7.ibDataSet3PROBLEMA.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>Observao: <b>'+Form7.ibDataSet3OBSERVACAO.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');



    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF width=50%>');

    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF width=50%>');
    WriteLn(F,'   <br><br><br><center><font face="Microsoft Sans Serif" size=2>______________________________________</b>');
    WriteLn(F,'   <br><center><font face="Microsoft Sans Serif" size=2>Assinatura do atendente</b>');

    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    WriteLn(F,'<center><font face="Microsoft Sans Serif" size=1></b>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
    + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
    + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br></center>');
    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center>pelo sistema Small Commerce, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a></font></center>');
    WriteLn(F,'</html>');
    CloseFile(F);
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
end;

procedure TForm7.ImprimirOrdemdeServio1Click(Sender: TObject);
var
  F: TextFile;
  fTotal1, fTotal2: Real;
  sArquivo : String;
begin
  //
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet3CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  begin
    //
    CriaJpg('logotip.jpg');
    //
    sArquivo := 'OS_'+Form7.ibDataSet3NUMERO.AsString;
    //
    AssignFile(F,pChar(sArquivo+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    //
    Writeln(F,'<html><head><title>OS '+Form7.ibDataSet3NUMERO.AsString+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    //
    WriteLn(F,'<table border=1 cellspacing=1 cellpadding=10 Width=640 style="border-collapse: collapse" >');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  >');
    WriteLn(F,'<table border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <img src="logotip.jpg" alt="'+AllTrim(ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=1>Data: <b>'+ibDataSet3.FieldByname('DATA').AsString+' '+TimeToStr(Time)+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=1>Atendente: <b>'+Form7.ibDataSet3TECNICO.AsString+'</b>');
    WriteLn(F,'   <br>Telefone: <b>' + AllTrim(ibDataSet13TELEFO.AsString));
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'<table>');
    WriteLn(F,'<table  border=0 cellspacing=0 cellpadding=0 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <center><font face="Microsoft Sans Serif" size=2><b>DOCUMENTO AUXILIAR DE VENDA - OS</b></center>');
    WriteLn(F,'   <center><font face="Microsoft Sans Serif" size=2><b>NO  DOCUMENTO FISCAL - NO  VLIDO COMO RECIBO E COMO GARANTIA DE</b></center>');
    WriteLn(F,'   <center><font face="Microsoft Sans Serif" size=2><b>MERCADORIA - NO COMPROVA PAGAMENTO</b></center>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'<table>');
    //
    WriteLn(F,'<br>');
    //
    WriteLn(F,'<table border=1 cellspacing=1 cellpadding=5 Width=100% style="border-collapse: collapse">');
    WriteLn(F,' <tr  height=25>');
    WriteLn(F,'  <td nowrap colspan=4 bgcolor=#FFFFFF vAlign=Top><font face="Microsoft Sans Serif" size=1><center>Identificao do Estabelecimento Emitente</center></td>');
    WriteLn(F,' </tr>');
    WriteLn(F,' <tr  height=25>');
    WriteLn(F,'  <td   nowrap   colspan=3><font face="Microsoft Sans Serif" size=1>Denominao:  <b>'+AllTrim(Copy(ibDataSet13NOME.AsString+Replicate(' ',35),1,35))+'</b>'+
    '<br>'+
    ibDataSet13.FieldByname('ENDERECO').AsString+'<br>'+
    ibDataSet13.FieldByname('CEP').AsString+' - '+ibDataSet13.FieldByname('MUNICIPIO').AsString+', '+ibDataSet13.FieldByname('ESTADO').AsString+'<br>'+
    ibDataSet13.FieldByname('COMPLE').AsString+'<br>'+
    'Telefone: '+ibDataSet13.FieldByname('TELEFO').AsString+'<br></td>');
    WriteLn(F,'  <td nowrap colspan=1 vAlign=Top width=50%><font face="Microsoft Sans Serif" size=1>CNPJ:  <b>'+ibDataSet13CGC.AsString+'</b></td>');
    WriteLn(F,' </tr>');
    //
    WriteLn(F,' <tr height=25>');
    WriteLn(F,'  <td nowrap colspan=4 bgcolor=#FFFFFF vAlign=Top><font face="Microsoft Sans Serif" size=1><center>Identificao do Destinatrio</center></td>');
    WriteLn(F,' </tr height=25>');
    WriteLn(F,' <tr>');
    //
    WriteLn(F,'  <td nowrap colspan=3><font face="Microsoft Sans Serif" size=1>Denominao:  <b>'+AllTrim(Copy(ibDataSet2.FieldByname('NOME').AsString+Replicate(' ',35),1,35))+'</b>');
    WriteLn(F,'<br>'+
    ibDataSet2.FieldByname('ENDERE').AsString+'<br>'+
    ibDataSet2.FieldByname('CEP').AsString+' - '+ibDataSet2.FieldByname('CIDADE').AsString+', '+ibDataSet2.FieldByname('ESTADO').AsString+'<br>'+
    ibDataSet2.FieldByname('COMPLE').AsString+'<br>'+
    'Telefone: '+ibDataSet2.FieldByname('FONE').AsString+'<br>'+'</td>');
    WriteLn(F,'  <td nowrap colspan=1 vAlign=Top width=50%><font face="Microsoft Sans Serif" size=1>CNPJ:  <b>'+ibDataSet2.FieldByname('CGC').AsString+'</b></td>');
    WriteLn(F,' </tr>');
    //
    WriteLn(F,' <tr height=25>');
    WriteLn(F,'  <td nowrap colspan=3 bgcolor=#FFFFFF><font face="Microsoft Sans Serif" size=1>Nmero do Documento: '+Form7.ibDataSet3NUMERO.AsString+'</b></center></td>');
    WriteLn(F,'  <td nowrap colspan=3 bgcolor=#FFFFFF width=50%><font face="Microsoft Sans Serif" size=1>Nmero do Documento Fiscal: '+Form7.ibDataSet3NF.AsString+'</b></center></td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    //
    // Dados da OS
    //
    WriteLn(F,'<table border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'       <font face="Microsoft Sans Serif" size=1>'+Form30.Label14.Caption+': <b>'+Form7.ibDataSet3DESCRICAO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=1>'+Form30.Label15.Caption+': <b>'+Form7.ibDataSet3IDENTIFI1.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=1>'+Form30.Label16.Caption+': <b>'+Form7.ibDataSet3IDENTIFI2.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'       <font face="Microsoft Sans Serif" size=1>'+Form30.Label17.Caption+': <b>'+Form7.ibDataSet3IDENTIFI3.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=1>'+Form30.Label18.Caption+': <b>'+Form7.ibDataSet3IDENTIFI4.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=1>'+Form30.Label30.Caption+': <b>'+Form7.ibDataSet3GARANTIA.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF vAlign=TOP>');
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=1>'+Form30.Label19.Caption+':<br>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF vAlign=TOP>');
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=1><b>'+StrTran(Form7.ibDataSet3PROBLEMA.AsString,chr(10),'<br>')+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    //
    // Peas
    //
    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><b><br>Peas:</b><br>');
    WriteLn(F,'<table  border=1  cellspacing=1 cellpadding=2 style="border-collapse: collapse"  >');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=50><font face="Microsoft Sans Serif" size=1>Cdigo</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Cd de barras</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=270><font face="Microsoft Sans Serif" size=1>Descrio</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Quantidade</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Unitrio</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Total</td>');
    WriteLn(F,' </tr>');
    //
    fTotal1 := 0;
    //
    Form7.ibDataSet16.DisableControls;
    Form7.ibDataSet16.First;
    while not Form7.ibDataSet16.Eof do // Disable
    begin
      //
      Form7.ibDataSet4.Close;                                                //
      Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
      Form7.ibDataSet4.Open;
      //
      if Form7.ibDataSet16CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString then
      begin
        //
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet16CODIGO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet4REFERENCIA.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet16DESCRICAO.AsString+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet16QUANTIDADE.AsFloat])+'</td>'); // Valor
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet16UNITARIO.AsFloat])+'</td>'); // Valor
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet16TOTAL.AsFloat])+'</td>'); // Valor
        WriteLn(F,' </tr>');
        //
        fTotal1 := fTotal1 + Form7.ibDataSet16TOTAL.AsFloat;
        //
      end else
      begin
        //
        if Alltrim(Form7.ibDataSet16DESCRICAO.AsString) <> '' then
        begin
          WriteLn(F,' <tr>');
          Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
          Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
          Writeln(F,'  <td   nowrap   colspan=5 bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet16DESCRICAO.AsString+'&nbsp</td>');
          WriteLn(F,' </tr>');
        end;
        //
      end;
      //
      Form7.ibDataSet16.Next;
      //
    end;
    //
    WriteLn(F,' <tr>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td   align=Right bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[fTotal1])+'</td>'); // Valor
    WriteLn(F,' </tr>');
    //
    Form7.ibDataSet16.EnableControls;
    WriteLn(F,'</table>');
    //
    // Servios
    //

    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><b><br>Servios:</b><br>');
    WriteLn(F,'<table  border=1  cellspacing=1 cellpadding=2 style="border-collapse: collapse"  >');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=270><font face="Microsoft Sans Serif" size=1>Descrio</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=140><font face="Microsoft Sans Serif" size=1>'+Form30.Label34.Caption+'</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Quantidade</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Unitrio</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' width=80><font face="Microsoft Sans Serif" size=1>Total</td>');
    WriteLn(F,' </tr>');
    //
    fTotal2 := 0;
    //
    Form7.ibDataSet35.DisableControls;
    Form7.ibDataSet35.First;
    while not Form7.ibDataSet35.Eof do
    begin
      //
      if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then
      begin
        //
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet35DESCRICAO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet35TECNICO.AsString+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet35QUANTIDADE.AsFloat])+'</td>'); // Valor
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet35UNITARIO.AsFloat])+'</td>'); // Valor
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet35TOTAL.AsFloat])+'</td>'); // Valor
        WriteLn(F,' </tr>');
        //
      end else
      begin
        //
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet35DESCRICAO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
        WriteLn(F,' </tr>');
        //
      end;
      //
      fTotal2 := fTotal2 + Form7.ibDataSet35TOTAL.AsFloat;
      //
      //
      Form7.ibDataSet35.Next;
      //
    end;
    //
    Form7.ibDataSet35.EnableControls;
    //
    WriteLn(F,' <tr>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td  ></td>');
    Writeln(F,'  <td   align=Right bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1 >'+Format('%12.'+Form1.ConfPreco+'n',[fTotal2])+'</td>'); // Valor
    WriteLn(F,' </tr>');
    WriteLn(F,'</table><br>');
    //
    // Fim de servios
    //
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=0 style="border-collapse: collapse"  >');
    WriteLn(F,' <tr>');
    //
    // Observao
    //
    WriteLn(F,'  <td   bgcolor=#FFFFFF vAlign=Top>');
    WriteLn(F,'   <font face="Microsoft Sans Serif" size=1>Observao: <b>'+Form7.ibDataSet3OBSERVACAO.AsString+'<b>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td  >');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=2 style="border-collapse: collapse"  >');
    //
    // TOTAIS
    //

    WriteLn(F,' <tr>');
    Writeln(F,'  <td   width=590 align=Right><font face="Microsoft Sans Serif" size=1 >Total de peas R$:</td>');
    Writeln(F,'  <td   width=80  align=Right><font face="Microsoft Sans Serif" size=1 ><b>'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet3TOTAL_PECA.AsFloat])+'</td>'); // total de peas
    WriteLn(F,' </tr>');

    WriteLn(F,' <tr>');
    Writeln(F,'  <td   width=590 align=Right><font face="Microsoft Sans Serif" size=1 >Total de servios R$:</td>');
    Writeln(F,'  <td   width=80  align=Right><font face="Microsoft Sans Serif" size=1 ><b>'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet3TOTAL_SERV.AsFloat])+'</td>'); // total servios
    WriteLn(F,' </tr>');

    WriteLn(F,' <tr>');
    Writeln(F,'  <td   width=590 align=Right><font face="Microsoft Sans Serif" size=1 >'+Form30.Label10.Caption+' R$:</td>');

    Writeln(F,'  <td   width=80  align=Right><font face="Microsoft Sans Serif" size=1 ><b>'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet3TOTAL_FRET.AsFloat])+'</td>'); // Frete
    WriteLn(F,' </tr>');

    WriteLn(F,' <tr>');
    Writeln(F,'  <td   width=590 align=Right><font face="Microsoft Sans Serif" size=1 >Desconto R$:</td>');
    Writeln(F,'  <td   width=80  align=Right><font face="Microsoft Sans Serif" size=1 ><b>'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet3DESCONTO.AsFloat])+'</td>'); // Frete
    WriteLn(F,' </tr>');

    WriteLn(F,' <tr>');
    Writeln(F,'  <td   width=590 align=Right><font face="Microsoft Sans Serif" size=1 >Total R$:</td>');
    Writeln(F,'  <td   width=80  align=Right><font face="Microsoft Sans Serif" size=1 ><b>'+Format('%12.'+Form1.ConfPreco+'n',[Form7.ibDataSet3TOTAL_OS.AsFloat])+'</td>'); // total da OS
    WriteLn(F,' </tr>');

    WriteLn(F,'</table>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    //
    // Fim dos totais
    //
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF vAlign=Top>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF width=50% vAlign=Bot>');
    WriteLn(F,'   <br><br><center><font face="Microsoft Sans Serif" size=2>______________________________________</b>');
    WriteLn(F,'   <br><center><font face="Microsoft Sans Serif" size=1>Assinatura do cliente</b>');
    WriteLn(F,'   <br><center><font face="Microsoft Sans Serif" size=1>Autorizo a execuo desta ordem de servios</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center> vedada a autenticao deste documento</font></center><br>');

    WriteLn(F,'<br><font size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
        + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
        + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font>');
    // Condio do relatrio
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    CloseFile(F);
    //
    AbreArquivoNoFormatoCerto(pChar(sArquivo));
    //
  end;
  //
end;

procedure TForm7.MenuItem12Click(Sender: TObject);
begin
  Imprimirrecibo1.Caption        := 'Imprimir recibo de entrega da Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  ImprimirOrdemdeServio1.Caption := 'Imprimir Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  Gerarnotafiscalsrie11.Caption  := 'Gerar Nota Fiscal srie 001 da Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  Gerarnotafiscalsrie21.Caption  := 'Gerar Nota Fiscal srie 002 da Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  //
  if Form7.ibDataSet3SITUACAO.AsString = 'Fechada' then
  begin
    Gerarnotafiscalsrie11.Enabled := False;
    Gerarnotafiscalsrie21.Enabled := False;
  end else
  begin
    Gerarnotafiscalsrie11.Enabled := True;
    Gerarnotafiscalsrie21.Enabled := True;
  end;
  //
end;

procedure TForm7.Agenda1Click(Sender: TObject);
begin
  // Form6.Show;
end;

procedure TForm7.ibDataSet19ELEMENTOSetText(Sender: TField;
  const Text: String);
var
  I : Integer;
begin
  I := Application.MessageBox('Este campo normalmente no deve ser alterado. Tem certeza que quer alterar este campo?', 'Ateno', mb_OKCancel + mb_DefButton1);
  if I = IDOK then
  begin
    ibDataSet19ELEMENTO.AsString := TExt;
  end else
  begin
    ibDataSet19ELEMENTO.AsString := ibDataSet19ELEMENTO.AsString;
  end;
end;

procedure TForm7.Grade1Click(Sender: TObject);
var
  F: TextFile;
  I, J: Integer;
  vGrade    : array [0..19,0..19] of String; // Cria uma matriz com 100 elementos
begin
  //
  // Processa o movimento antes de imprimir a ficha pois pode alterar a qtd inicial//
  //
  CriaJpg('logotip.jpg');
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
  Rewrite(F);
  Writeln(F,'<html><head><title>'+AllTrim(Form7.ibDataSet13NOME.AsString) + ' - '+Form7.sModulo+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  WriteLn(F,'<br><font size=3 color=#c0c0c0><b>'+Form7.Caption+'</b></font>');
  //    WriteLn(F,'<table  border=0 cellpadding=10 cellspacing=0><tr><td  >');
  WriteLn(F,'<br><br><font size=4 color=#000000><b>GRADE</b></font>');

  WriteLn(F,'<table  border=0 bgcolor=#FFFFFFFF cellspacing=1 cellpadding=4>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
//  WriteLn(F,'   <table  border=0 bgcolor=#000000 cellspacing=1 cellpadding=4>');
  //
  Form7.ibDataSet4.First;
  //
  while not Form7.ibDataSet4.Eof do
  begin
    //
    Form7.ibDataSet10.DisableControls;
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
    begin
      //
      for I := 0 to 19 do for J := 0 to 19 do vGrade[I,J] := '';
      //
      while (Form7.ibDataSet10CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString) and not (Form7.ibDataSet10.EOF) do
      begin
        if AllTrim(Form7.ibDataSet10QTD.AsString) <> '' then
        begin
          if StrToInt(Form7.ibDataSet10COR.AsString) + strtoInt(Form7.ibDataSet10TAMANHO.AsString) <> 0 then
          begin
            vGrade[StrToInt(Form7.ibDataSet10COR.AsString),strtoInt(Form7.ibDataSet10TAMANHO.AsString)] := Form7.ibDataSet10QTD.AsString;
          end;
        end;
        Form7.ibDataSet10.Next;
      end;
      //
      Writeln(F,'    <p align=center><font face="Microsoft Sans Serif" size=2><b>'+AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+'</b>');
      //
      WriteLn(F,'    <table  border=0 bgcolor=#000000 cellspacing=1 cellpadding=4>');
      for J := 0 to 19 do
      begin
        for I := 0 to 19 do
        begin
          if (I=0) and (J=0) then WriteLn(F,'     <tr><td   bgcolor=#'+Form1.sHtmlCor+' align=Right></td>');
          if vGrade[I,J] <> '' then
          begin
            if I = 0 then WriteLn(F,'     </tr><tr>');
            if (I = 0) then WriteLn(F,'      <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+vGrade[I,J]+'</td>') else
               if (J = 0) then WriteLn(F,'      <td   bgcolor=#'+Form1.sHtmlCor+' align=center width=70><font face="Microsoft Sans Serif" size=1>'+vGrade[I,J]+'</td>')
             else WriteLn(F,'      <td   bgcolor=#FFFFFFFF align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.'+Form1.ConfCasas+'n',[Abs(StrToFloat(LimpaNumeroDeixandoAVirgula(vGrade[I,J])))])+'</td>');
          end;
        end;
      end;
      //
      WriteLn(F,'     </tr>');
      WriteLn(F,'    </table>');
      Writeln(F,'    <font face="Microsoft Sans Serif" size=2><b>'+ Format('%12.'+Form1.ConfCasas+'n',[Form7.ibDataSet4QTD_ATUAL.AsFloat]) +'</b><br>');

    end;
    //
    Form7.ibDataSet4.Next;
    //
  end;
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table></td>');
  //
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
  + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br>');
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
  //
end;

procedure TForm7.Cartadecobrana1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\cobrana.doc'),'','', SW_SHOWMAXIMIZED);
end;

procedure TForm7.Imprimiretiquetaparacobrana1Click(Sender: TObject);
begin
  //
  Screen.Cursor  := crHourGlass;    // Cursor de Aguardo
  Form7.IBDataSet100.DisableControls;
  Form7.IBDataSet2.DisableControls;
  //
  Form7.IBDataSet100.Close;
  Form7.IBDataSet100.SelectSQL.Clear;
  Form7.IBDataSet100.SelectSQL.Add('update CLIFOR set COMPRA=(select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)');
  Form7.IBDataSet100.Open;
  //
  Form7.sModulo := 'CLIENTES';
  sWhere := ' where COMPRA<>0 ';
  Form7.IBDataSet2.EnableControls;
  Screen.Cursor  := crDefault;    // Cursor de Aguardo
  //
  Form7.Close;
  Form7.Show;
  //
  Form15.CheckBox2.Checked := True;
  Form15.ShowModal;
  //
  Form7.Close;
  //
  Form7.sModulo := 'RECEBER';
  Form7.Show;
  //
end;

procedure TForm7.Imprimircartadecobrana1Click(Sender: TObject);
begin
  //
  Form33.ShowModal;
  //
end;

procedure TForm7.ibDataSet2CEPSetText(Sender: TField; const Text: String);
begin
  Valida_Campo('CLIFOR',Text,'CEP','Auxilio na digitao do CEP.');
  ibDataSet2CEP.AsString := Text;
end;

procedure TForm7.ibDataSet4QTD_ATUALSetText(Sender: TField;
  const Text: String);
var
  bBlocoX : Boolean;  
begin
  //
  try
    if NaoHouveMovimento(Form7.ibDataSet4CODIGO.AsString) then
    begin
      //
      Form7.ibDataSet4QTD_ATUAL.AsString := Text;
      //
    end else
    begin
      //
      try
        //
        Form7.IBQuery1.Close;
        Form7.IBQuery1.SQL.Text := 'select first 1 * from BLOCOX where TIPO = ''REDUCAO''';
        Form7.IBQuery1.Open;
        //
        if Form7.IBQuery1.FieldByName('REGISTRO').AsString = '' then
        begin
          bBlocox := False;
        end else
        begin
          bBlocox := True;
        end;
        //
      except
        bBlocoX := False;
      end;
      //
      if not bBlocoX then
      begin
        if Form1.Modoinventrio1.Checked then
        begin
          Form7.ibDataSet4QTD_ATUAL.AsString := Text;
        end else
        begin
          ShowMessage('A quantidade do estoque no pode ser alterada manualmente.'
          +chr(10)+chr(10)+'Para alterar a quantidade entre em: Configuraes; Modo inventrio;');
        end;
      end else
      begin
        ShowMessage('A quantidade do estoque no pode ser alterada manualmente.'
        +chr(10)+chr(10)+'Para alterar a quantidade deste item somente emitindo um dos seguintes documentos fiscais:'
        +chr(10)+chr(10)+'NF-e de entrada (compra)'
        +chr(10)+'NF-e de sada (venda)'
        +chr(10)+'NFC-e de sada (venda)'
        +chr(10)+'Cupom Fiscal (venda)'+chr(10));
      end;
    end;
  except
    Form7.ibDataSet4QTD_ATUAL.AsString := Text;
  end;
  //
{
  if (NaoHouveMovimento(Form7.ibDataSet4CODIGO.AsString))
  or (Form7.sModulo <> 'ESTOQUE')
  or ((UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'SP'))
  or ((Pos('CONSUMO',UpperCase(Form7.ibDataSet4NOME.AsString)) <> 0)) then
  begin
    Form7.ibDataSet4QTD_ATUAL.AsString := Text;
  end else
  begin
    ShowMessage('A quantidade do estoque no pode ser alterada manualmente.'
    +chr(10)+chr(10)+'Para alterar a quantidade deste item somente emitindo um dos seguintes documentos fiscais:'
    +chr(10)+chr(10)+'NF-e de entrada (compra)'
    +chr(10)+'NF-e de sada (venda)'
    +chr(10)+'NFC-e de sada (venda)'
    +chr(10)+'Cupom Fiscal (venda)'+chr(10));
  end;
  //
}
end;

procedure TForm7.Resumodevendas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form38.Label21.Caption := Form7.ibDataSet2NOME.AsString;
  Form38.Label21.Visible := True;
  Form7.sModulo := 'Resumo das vendas';
  Form38.ShowModal; // Ok
  Form38.Label21.Visible := False;
  //
end;

procedure TForm7.DBGrid2DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  OldBkMode : Integer;
  xRect : tREct;
begin
  //
  dbGrid2.Canvas.Pen.Color   := clBlack;
  dbGrid2.Canvas.Brush.Color := Form7.Panel7.Color;
  dbGrid2.Canvas.Font.Color  := clBlack;
  //
  xRect.Left   := Rect.Left;
  xRect.Top    := -2;
  xRect.Right  := Rect.Right;
  xRect.Bottom := Rect.Bottom-Rect.Top + 2;
  dbGrid2.Canvas.FillRect(XrEct);
  //
  with dbgrid2.Canvas do
  begin
    OldBkMode := SetBkMode(Handle, TRANSPARENT);
    TextOut(Rect.Left+3,3,AllTrim(Field.DisplayLabel));
    dbgrid2.Canvas.Font.Color := clblack;
    SetBkMode(Handle, OldBkMode);
  end;
  //
  if sModulo = 'OS' then
  begin
    Form7.Panel9.Caption  := Format('%14.2n',[Form7.ibDataSet3TOTAL_PECA.AsFloat]);
    Form7.Panel10.Caption := Format('%14.2n',[Form7.ibDataSet3TOTAL_SERV.AsFloat]);
    Form7.Panel10.Repaint;
    Form7.Panel9.Repaint;
  end;
  //
  if sModulo = 'VENDA' then
  begin
    Form7.Panel9.Caption  := Format('%14.2n',[Form7.ibDataSet15MERCADORIA.AsFloat]);
    Form7.Panel10.Caption := Format('%14.2n',[Form7.ibDataSet15SERVICOS.AsFloat]);
    Form7.Panel10.Repaint;
    Form7.Panel9.Repaint;
  end;
  //
  if sModulo = 'COMPRA' then
  begin
    Form7.Panel9.Caption  := Format('%14.2n',[Form7.ibDataSet24MERCADORIA.AsFloat]);
  end;
  //
end;

procedure TForm7.DBGrid3DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  OldBkMode : Integer;
  xRect : tREct;
begin
  //
  dbGrid3.Canvas.Pen.Color := clBlack;
  dbGrid3.Canvas.Brush.Color := Form7.Panel7.Color;
  //
  xRect.Left   := Rect.Left;
  xRect.Top    := -2;
  xRect.Right  := Rect.Right;
  xRect.Bottom := Rect.Bottom - Rect.Top + 2;
  dbGrid3.Canvas.FillRect(XrEct);
  //
  {Sandro Silva 2022-09-23 inicio
  with dbGrid3.Canvas do
  begin
    OldBkMode := SetBkMode(Handle, TRANSPARENT);
    TextOut(Rect.Left + 3, 3, AllTrim(Field.DisplayLabel));
    dbGrid3.Canvas.Font.Color := clblack;
    SetBkMode(Handle, OldBkMode);
  end;
  }
  OldBkMode := SetBkMode(Handle, TRANSPARENT);
  dbGrid3.Canvas.TextOut(Rect.Left + 3, 3, Trim(Field.DisplayLabel));
  dbGrid3.Canvas.Font.Color := clblack;
  SetBkMode(Handle, OldBkMode);
  {Sandro Silva 2022-09-23 fim}
  //
end;

procedure TForm7.Vendas_1Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie 001';
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE 1');
  Mais1Ini.Free;
  //
end;

procedure TForm7.Compras_1Click(Sender: TObject);
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'COMPRA';
  Form7.sTitulo := 'Notas fiscais de entrada (compras)';
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.ibDataSet16AfterPost(DataSet: TDataSet);
var
  fFCP, fPercentualFCP, fPercentualFCPST, fTotalMercadoria, fRateioDoDesconto, fIPIPorUnidade, fSomaNaBase, TotalBASE, TotalICMS : Real;
  sreg, sReg4, sReg16, sEstado : String;
  tInicio : tTime;
  Hora, Min, Seg, cent: Word;
  IBQESTOQUE: TIBQuery; // Sandro Silva 2022-11-10 Para substituir Form7.IBDATASET99 que  usado em outros eventos disparados em cascatas
begin
  //
  //
  IBQESTOQUE := CriaIBQuery(Form7.IBDataSet99.Transaction);
  IBQESTOQUE.DisableControls;

  if Form7.sModulo <> 'NAO' then
  begin
    //                               //
    // Descrio em Branco no grava //
    //                               //
    if Form7.sModulo = 'VENDA' then
    begin
      //
      Screen.Cursor := crHourGlass; // Cursor de Aguardo

// tInicio := time;

      //
      IBQESTOQUE.Close;
      IBQESTOQUE.SQL.Clear;
      IBQESTOQUE.SQL.Add('select DESCRICAO, PRECO, TIPO_ITEM from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' '); // Ok
      IBQESTOQUE.Open;
      //
      if IBQESTOQUE.FieldByname('TIPO_ITEM').AsString = '09' then
      begin
        ShowMessage('O tipo do item NO deve ser "09 - Servio" na guia ICMS.'+chr(10)+'Os servios devem ser informados na tabela abaixo.' );
        Form7.ibDataSet16.Delete;
      end;
      //
      try
        //
        // Quando no tem produtos cadastrados e pq a NF e de complemento do ICMS
        //
        if Form7.ibDataSet15FINNFE.AsString <> '2' then
        begin
          //
          if (AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> '') or (Form7.ibDataSet15MERCADORIA.AsFloat <> 0) then
          begin
            //
            fTotalMercadoria := Form7.ibDataSet15MERCADORIA.AsFloat;
            //
            Form7.ibDataSet15.DisableControls;
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15MERCADORIA.AsFloat := 0;
            Form7.ibDataSet15BASEICM.AsFloat    := 0;
            Form7.ibDataSet15BASEISS.AsFloat    := 0;
            Form7.ibDataSet15ICMS.AsFloat       := 0;  // 16AfterPost
            Form7.ibDataSet15IPI.AsFloat        := 0;
            Form7.ibDataSet15ISS.AsFloat        := 0;
            Form7.ibDataSet15PESOLIQUI.AsFloat  := 0;
            //
            Form7.ibDataSet15BASESUBSTI.AsFloat := 0;
            Form7.ibDataSet15ICMSSUBSTI.AsFloat := 0;
            //
            ItensDaNota := 0;
            fFCPRetido  := 0;
            //
            sReg4  := Form7.ibDataSet4REGISTRO.AsString;
            sReg16 := Form7.ibDataSet16REGISTRO.AsString;
            //
            //
            Form7.ibDataSet4.DisableControls;
            Form7.ibDataSet101.DisableControls;
            //
            Form7.ibDataSet101.Close;
            Form7.ibDataSet101.SelectSQL.Clear;
            Form7.ibDataSet101.SelectSQL.Add('select * from ITENS001 where NUMERONF='+QuotedStr(ibDAtaSet15NUMERONF.AsString)+' ');
            Form7.ibDataSet101.Open;
            //
            Form7.ibDataSet101.First;
            //
            if Form7.ibDataSet15FINNFE.AsString = '4' then // Devolucao Devoluo
            begin
              while not Form7.ibDataSet101.Eof do // Disable
              begin
                //
                if Form7.ibDataSet101.FieldByname('QUANTIDADE').AsFloat <> 0 then
                begin
                  //
                  Form7.ibDataSet15MERCADORIA.AsFloat := Form7.ibDataSet15MERCADORIA.AsFloat + Arredonda(Form7.ibDataSet101.FieldByname('TOTAL').AsFloat,2);
                  Form7.ibDataSet15BASEICM.AsFloat    := Form7.ibDataSet15BASEICM.AsFloat    + Arredonda(Form7.ibDataSet101.FieldByname('VBC').AsFloat,2);
                  Form7.ibDataSet15ICMS.AsFloat       := Form7.ibDataSet15ICMS.AsFloat       + Arredonda(Form7.ibDataSet101.FieldByname('VICMS').AsFloat,2);
                  Form7.ibDataSet15IPI.AsFloat        := Form7.ibDataSet15IPI.AsFloat        + Arredonda(Form7.ibDataSet101.FieldByname('VIPI').AsFloat,2);
                  Form7.ibDataSet15ICMSSUBSTI.AsFloat := Form7.ibDataSet15ICMSSUBSTI.AsFloat + Arredonda(Form7.ibDataSet101.FieldByname('VICMSST').AsFloat,2);
                  Form7.ibDataSet15BASESUBSTI.AsFloat := Form7.ibDataSet15BASESUBSTI.AsFloat + Arredonda(Form7.ibDataSet101.FieldByname('VBCST').AsFloat,2);
                  Form7.ibDataSet15PESOLIQUI.AsFloat  := Form7.ibDataSet15PESOLIQUI.AsFloat  + Form7.ibDataSet101.FieldByname('PESO').AsFloat * Form7.ibDataSet101.FieldByname('QUANTIDADE').AsFloat;
                  //
                end;
                //
                Form7.ibDataSet101.Next;
                //
              end;
            end else
            begin
              //
              while not Form7.ibDataSet101.Eof do // Disable
              begin
                //
                Form7.ibDataSet4.Close;
                Form7.ibDataSet4.Selectsql.Clear;
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet101.FieldByname('CODIGO').AsString)+' ');  //
                Form7.ibDataSet4.Open;
                //
                if Form7.ibDataSet101.FieldByname('DESCRICAO').AsString <> '' then ItensDaNota := ItensDaNota + 1;
                //
                try
                  if ibDataSet15.FieldByname('DESCONTO').AsFloat <> 0 then fRateioDoDesconto  := Arredonda((ibDataSet15.FieldByname('DESCONTO').AsFloat / fTotalMErcadoria * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat),2) else fRateioDoDesconto := 0; // REGRA DE TRS ratiando o desconto no total
                except
                  fRateioDoDesconto := 0;
                end;
                //
                if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                begin
                  //
                  // Nova rotina para posicionar na tabla de CFOP
                  //
                  Form7.IBQuery14.Close;
                  Form7.IBQuery14.SQL.Clear;
                  Form7.IBQuery14.SQL.Add('select * from ICM where ST='+QuotedStr(Form7.ibDataSet4ST.AsString)+''); // Nova rotina
                  Form7.IBQuery14.Open;
                  //
                  if Form7.IBQuery14.FieldByName('ST').AsString <> Form7.ibDataSet4ST.AsString then
                  begin
                    Form7.IBQuery14.Close;
                    Form7.IBQuery14.SQL.Clear;
                    Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                    Form7.IBQuery14.Open;
                  end;
                  //
                end else
                begin
                  //
                  Form7.IBQuery14.Close;
                  Form7.IBQuery14.SQL.Clear;
                  Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                  Form7.IBQuery14.Open;
                  //
                end;
                //
                if Form7.ibDataSet101.FieldByname('QUANTIDADE').AsFloat <> 0 then
                begin
                  //
                  Form7.ibDataSet15PESOLIQUI.AsFloat  := Form7.ibDataSet15PESOLIQUI.AsFloat  + Form7.ibDataSet101.FieldByname('PESO').AsFloat * Form7.ibDataSet101.FieldByname('QUANTIDADE').AsFloat;
                  //
                  if (Pos(Alltrim(Form7.ibDataSet101.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5124 Industrializao efetuada para outra empresa no soma na base
                  begin
                    //
                    Form7.ibDataSet15BASEISS.AsFloat    := Form7.ibDataSet15BASEISS.AsFloat    + (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat * Form7.ibDataSet101.FieldByname('BASEISS').AsFloat / 100 );
                    if Form7.ibDataSet101.FieldByname('BASE').AsFloat > 0 then
                    begin
                      //
  //                    if ((ibDAtaset13.FieldByname('CRT').AsString = '1') and (ibDataSet4.FieldByname('CSOSN').AsString = '900'))
                      //
                      // NOTA DEVOLUCAO D E V
                      //
                      if ((ibDAtaset13.FieldByname('CRT').AsString = '1') and ( (ibDataSet4.FieldByname('CSOSN').AsString = '900') or (ibDataSet14.FieldByname('CSOSN').AsString = '900') ))
                      or ((ibDAtaset13.FieldByname('CRT').AsString <> '1') and (
                                                                                 (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '00') or
                                                                                 (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '10') or
                                                                                 (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '20') or
                                                                                 (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '51') or
                                                                                 (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '70') or
                                                                                 (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '90')))
                      then
                      begin
                        Form7.ibDataSet15BASEICM.AsFloat    := Form7.ibDataSet15BASEICM.AsFloat    + Arredonda((Form7.ibDataSet101.FieldByname('TOTAL').AsFloat * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 ),2);
                        Form7.ibDataSet15ICMS.AsFloat       := Form7.ibDataSet15ICMS.AsFloat       + Arredonda(( (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 *  Form7.IbDataSet101.FieldByName('ICM').AsFloat / 100 ),2); // Acumula em 16 After post
                      end;
                      //
                    end;
                    //
                    Form7.ibDataSet15ISS.AsFloat        := Form7.ibDataSet15ISS.AsFloat        + ( Form7.ibDataSet101.FieldByname('TOTAL').AsFloat *  Form7.ibDataSet101.FieldByname('ISS').AsFloat / 100 );
                    //
                  end;
                  //
                  // Soma o CFOP 5124 ou 6124 no TOTAL da nota mas no soma na MERCADORIA
                  // 5124 Industrializao efetuada para outra empresa
                  //
                  if (Form7.ibDataSet101.FieldByname('BASEISS').AsFloat <> 100) and (Pos(Alltrim(Form7.ibDataSet101.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then // 5124 Industrializao efetuada para outra empresa no soma na base
                  begin
                    Form7.ibDataSet15MERCADORIA.AsFloat := Form7.ibDataSet15MERCADORIA.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('TOTAL').AsFloat,2);
                  end;
                  //
                  if (Copy(Form7.ibQuery14.FieldByname('CFOP').AsString,1,4) = '5101') or (Copy(Form7.ibQuery14.FieldByname('CFOP').AsString,1,4) = '6101') or (Pos('IPI',Form7.ibQuery14.FieldByname('OBS').AsString) <> 0) then
                  begin
                    //
                    // IPI
                    //
                    if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                    begin
                      //
                      Form7.ibDataSet15IPI.AsFloat         := Form7.ibDataSet15IPI.AsFloat + Arredonda2((ibDataSet101.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)))),2); //
                      //
                      if ((Form7.ibQuery14.FieldByname('SOBREIPI').AsString = 'S')) then
                      begin
                        Form7.ibDataSet15BASEICM.AsFloat   := Form7.ibDataSet15BASEICM.AsFloat + Arredonda((ibDataSet101.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)))),2); //
                        Form7.ibDataSet15ICMS.AsFloat      := Form7.ibDataSet15ICMS.AsFloat    + Arredonda(((ibDataSet101.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.IbDataSet101.FieldByName('ICM').AsFloat / 100 )),2); // Acumula em 16 After post
                      end;
                      //
                    end else
                    begin
                      Form7.ibDataSet15IPI.Value         := Form7.ibDataSet15IPI.Value +
                                           Arredonda2((Form7.ibDataSet101.FieldByname('QUANTIDADE').Asfloat *
                                           Form7.ibDataSet101.FieldByname('UNITARIO').AsFloat   *
                                           ( Form7.ibDataSet101.FieldByname('IPI').Value / 100 )),2); // 450 Valor IPI do item Uso o int para arredondar 2 casas


                    end;
                    //
                    // Calcula o ICM
                    //
                    if ((Form7.ibQuery14.FieldByname('SOBREIPI').AsString = 'S')) and (ibDataSet101.FieldByname('IPI').AsFloat<>0) then
                    begin
                      if Form7.ibDataSet101.FieldByname('BASE').AsFloat > 0 then
                      begin
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          //
  //                        if ((ibDAtaset13.FieldByname('CRT').AsString = '1') and (ibDataSet4.FieldByname('CSOSN').AsString = '900'))
                          //
                          // NOTA DEVOLUCAO D E V
                          //
                          if ((ibDAtaset13.FieldByname('CRT').AsString = '1') and ( (ibDataSet4.FieldByname('CSOSN').AsString = '900') or (ibDataSet14.FieldByname('CSOSN').AsString = '900') ))
                          or ((ibDAtaset13.FieldByname('CRT').AsString <> '1') and (
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '00') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '10') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '20') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '51') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '70') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '90')))
                          then
                          begin
                            Form7.ibDataSet15BASEICM.AsFloat  := Form7.ibDataSet15BASEICM.AsFloat    + Arredonda(( ((ibDataSet101.FieldByname('IPI').AsFloat * ibDataSet101.FieldByname('TOTAL').AsFloat) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 ),2);
                            Form7.ibDataSet15ICMS.AsFloat     := Form7.ibDataSet15ICMS.AsFloat       + Arredonda(( ((ibDataSet101.FieldByname('IPI').AsFloat * ibDataSet101.FieldByname('TOTAL').AsFloat) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.IbDataSet101.FieldByName('ICM').AsFloat / 100 ),2); // Acumula em 16 After post
                          end;
                          //
                          // CALCULO DO IVA
                          //
                          if AliqICMdoCliente101() <= Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                          begin
                            //
                            if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                            begin
                              //
                              // VINICULAS
                              //
                              try
                                Form7.ibDataSet15BASESUBSTI.AsFloat := Arredonda(Form7.ibDataSet15BASESUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100) * Form7.ibDataset4PIVA.AsFloat ),2); // Rateio desconto
                                Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100) * Form7.ibDataset4PIVA.AsFloat),2); // Acumula em 16 After post                        //  // Rateio desconto
                              except end;
                            end else
                            begin
                              Form7.ibDataSet15BASESUBSTI.AsFloat := Arredonda(Form7.ibDataSet15BASESUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100) * Form7.ibDataset4PIVA.AsFloat ),2);
                              Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100) * Form7.ibDataset4PIVA.AsFloat),2); // Acumula em 16 After post                        //
                            end;
                            //
                            // Desconta do ICMS substituido o ICMS normal
                            //
                            Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat - ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * AliqICMdoCliente101() / 100 ),2); // Acumula em 16 After post
                            //
                          end else
                          begin
                            //
                            if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                            begin
                              //
                              // VINICULAS
                              //
                              try
                                Form7.ibDataSet15BASESUBSTI.AsFloat := Arredonda(Form7.ibDataSet15BASESUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100) * Form7.ibDataset4PIVA.AsFloat ),2);
                                Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * AliqICMdoCliente101() / 100) * Form7.ibDataset4PIVA.AsFloat),2); // Acumula em 16 After post                        //
                              except end;
                            end else
                            begin
                              Form7.ibDataSet15BASESUBSTI.AsFloat := Arredonda(Form7.ibDataSet15BASESUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100) * Form7.ibDataset4PIVA.AsFloat ),2);
                              Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat + ( ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * AliqICMdoCliente101() / 100) * Form7.ibDataset4PIVA.AsFloat),2); // Acumula em 16 After post                        //
                            end;
                            //
                            // Desconta do ICMS substituido o ICMS normal
                            //
                            Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat - ((ibDataSet101.FieldByname('IPI').AsFloat * (ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 ),2); // Acumula em 16 After post
                            //
                          end;
                          //
                        end else
                        begin
                          //
  //                        if ((ibDAtaset13.FieldByname('CRT').AsString = '1') and (ibDataSet4.FieldByname('CSOSN').AsString = '900'))
                          //
                          // NOTA DEVOLUCAO D E V
                          //
                          if ((ibDAtaset13.FieldByname('CRT').AsString = '1') and ( (ibDataSet4.FieldByname('CSOSN').AsString = '900') or (ibDataSet14.FieldByname('CSOSN').AsString = '900') ))
                          or ((ibDAtaset13.FieldByname('CRT').AsString <> '1') and (
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '00') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '10') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '20') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '51') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '70') or
                                                                                     (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '90')))
                          then
                          begin
                            Form7.ibDataSet15BASEICM.AsFloat  := Form7.ibDataSet15BASEICM.AsFloat    + Arredonda(((ibDataSet101.FieldByname('IPI').AsFloat * ibDataSet101.FieldByname('TOTAL').AsFloat / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 ),2);
                            Form7.ibDataSet15ICMS.AsFloat     := Form7.ibDataSet15ICMS.AsFloat       + Arredonda(((ibDataSet101.FieldByname('IPI').AsFloat * ibDataSet101.FieldByname('TOTAL').AsFloat / 100) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.IbDataSet101.FieldByName('ICM').AsFloat / 100 ),2); // Acumula em 16 After post
                          end;
                        end;
                      end;
                    end;
                    //
                  end;
                  //
                  // Fundo de combate a pobresa
                  //
                  //
                  if (
                      (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) <> '0') and
                      (
                       (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '10') or
                       (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '30') or
                       (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '70') or
                       (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '90')
                      )
                     ) or
                     (
                      (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) = '1') and
                      (
                       (ibDataSet4.FieldByname('CSOSN').AsString = '900')                           or
                       (ibDataSet4.FieldByname('CSOSN').AsString = '201')                           or
                       (ibDataSet4.FieldByname('CSOSN').AsString = '202')                           or
                       (ibDataSet4.FieldByname('CSOSN').AsString = '203')
                      )
                     ) then
                  begin
                    //
                    // 1 - Simples nacional
                    // 2 - Simples nacional - Excesso de Sublimite de Receita Bruta
                    // 3 - Regime normal
                    //
                    // Fundo de combate a pobresa Retido deve somar no total da nota
                    //
                    // ShowMessage('CRT: '+LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString)+chr(10)+
                    //             'CST: '+LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+Chr(10)+
                    //             'CSOSN: '+ibDataSet4.FieldByname('CSOSN').AsString);
                    // <FCP>


                    //
                    // fPercentualFCP 16 AfterPost
                    //
                    if (Form7.ibDataSet16PFCPUFDEST.AsFloat <> 0) or (Form7.ibDataSet16PICMSUFDEST.AsFloat <> 0) then
                    begin
                      //
                      // Quando preenche na nota no vai nada nessas tags
                      //
                      fPercentualFCP := 0;
                      fPercentualFCPST := 0; // fPercentualFCP; // tributos da NF-e 16 AfterPost
                      //
                    end else
                    begin
                      if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCP',Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        fPercentualFCP := StrTofloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCP',Form7.ibDataSet4.FieldByname('TAGS_').AsString))); // tributos da NF-e
                      end else
                      begin
                        fPercentualFCP := 0;
                      end;
                      //
                      // fPercentualFCPST 16 AfterPost
                      //
                      if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCPST',Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        fPercentualFCPST := StrTofloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCPST',Form7.ibDataSet4.FieldByname('TAGS_').AsString))); // tributos da NF-e 16 AfterPost
                      end else
                      begin
                        fPercentualFCPST := 0; // fPercentualFCP; // tributos da NF-e 16 AfterPost
                      end;
                    end;
                    //
                    if fPercentualFCP <> 0 then
                    begin
                      fFCP       := Arredonda((Form7.ibDataSet101.FieldByname('TOTAL').AsFloat*fPercentualFCP/100),2); // Valor do Fundo de Combate  Pobreza (FCP)
                    end else
                    begin
                      fFCP       := 0;
                    end;
                    //
                    if fPercentualFCPST <> 0 then
                    begin
                      //
                      if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                      begin
                        fFCPRetido := ((fFCPRetido + Arredonda( (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat * Form7.ibDataSet4PIVA.AsFloat * fPercentualFCPST / 100),2))-fFCP); // Valor do Fundo de Combate  Pobreza (FCP)
                      end else
                      begin
                        fFCPRetido := ((fFCPRetido + Arredonda( (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat * Form7.ibDataSet4PIVA.AsFloat * fPercentualFCPST / 100),2))); // Valor do Fundo de Combate  Pobreza (FCP)
                      end;
                      //
                    end;
                    //
                    // FCP - Fundo de Combate a Pobresa
                    //
                  end;
                  //
                  // SUBSTITUIO TRIBUTRIA
                  //
                  try
                    if Form7.ibDataSet4PIVA.AsFloat > 0 then
                    begin
                      //
                      // IPI Por Unidade
                      //
                      fIPIPorUnidade := 0;
                      if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        fIPIPorUnidade := (ibDataSet101.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                      end;
                      //
                      // CALCULO DO IVA
                      //
                      if AliqICMdoCliente101() <= Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                      begin
                        //
                        if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                        begin
                          //
                          // VINICULAS
                          //
                          try
                            //
                            Form7.ibDataSet15BASESUBSTI.AsFloat := Form7.ibDataSet15BASESUBSTI.AsFloat + Arredonda((
                            (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade)
                             * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataSet4PIVA.AsFloat),2);
                            //
                            Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat +
                            (((
                            (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade)
                            ) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100
                             *  Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat ),2);
                            //
                          except
                            on E: Exception do
                            begin
                              Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'no calculo do ICMS substituio. Verifique o valor da tag <BCST> Erro: 16687'
                              ),'Ateno',mb_Ok + MB_ICONWARNING);
                            end;
                          end;
                        end else
                        begin
                          //
                          Form7.ibDataSet15BASESUBSTI.AsFloat := Arredonda(Form7.ibDataSet15BASESUBSTI.AsFloat +
                          ((Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade)
                           * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.ibDataSet4PIVA.AsFloat),2);
                          //

                          Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat +
                          (((
                          ((Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                          ) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100
                           *  Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat ),2); // No pode arredondar aqui
                          //
                        end;
                        //
                        // Desconta do ICMS substituido o ICMS normal
                        //
                        Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat - (((Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)
                        ) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente101() / 100 ),2); // Acumula em 16 After post
                        //
                      end else
                      begin
                        //
                        if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                        begin
                          //
                          // VINICULAS
                          //
                          try
                            Form7.ibDataSet15BASESUBSTI.AsFloat := Form7.ibDataSet15BASESUBSTI.AsFloat + Arredonda((
                            (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade) *
                            StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2);
                            //
                            Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat +
                            (((
                            (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade)
                            ) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100
                             * AliqICMdoCliente101() / 100 )* Form7.ibDataset4PIVA.AsFloat ),2);
                          except end;
                          //
                        end else
                        begin
                          Form7.ibDataSet15BASESUBSTI.AsFloat := Form7.ibDataSet15BASESUBSTI.AsFloat + Arredonda((
                          (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade) *
                          Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2);
                          //
                          Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat +
                          (((
                          (Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto + fIPIPorUnidade)
                          ) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100
                           * AliqICMdoCliente101() / 100 )* Form7.ibDataset4PIVA.AsFloat ),2);
                        end;
                        //
                        // Desconta do ICMS substituido o ICMS normal
                        //
                        Form7.ibDataSet15ICMSSUBSTI.AsFloat := Arredonda(Form7.ibDataSet15ICMSSUBSTI.AsFloat - ((
                        ((Form7.ibDataSet101.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)
                        )) * Form7.ibDataSet101.FieldByname('BASE').AsFloat / 100 *   Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 ),2); // Acumula em 16 After post
                        //
                      end;
                      //
                    end;
                  except end;
                  //
                  // Prximo
                  //
                end;
                //
                Form7.ibDataSet101.Next;
                //
              end;
              //
              // Passa novamente para calcular a regra de tres de frete desconto outras
              //
              Form7.ibDataSet101.First;
              while not Form7.ibDataSet101.Eof do // Disable
              begin
                if Form7.ibDataSet101.FieldByname('QUANTIDADE').AsFloat <> 0 then
                begin
                  if (Pos(Alltrim(Form7.ibDataSet101.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5124 Industrializao efetuada para outra empresa no soma na base
                  begin
                    if Form7.ibDataSet101.FieldByname('BASE').AsFloat > 0 then
                    begin
                      if not ( Form7.ibDataSet4PIVA.AsFloat > 0 ) or (Copy(Form7.ibDataSet4.FieldByname('CST').AsString,2,2)='70') or (Copy(Form7.ibDataSet4.FieldByname('CST').AsString,2,2)='10') or (ibDataSet4.FieldByname('CSOSN').AsString = '900') then
                      begin
                        //
                        if (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) <> '1')
                        or (Copy(Form7.ibDataSet101.FieldByname('CFOP').AsString,2,3) = '201')
                        or (Copy(Form7.ibDataSet101.FieldByname('CFOP').AsString,2,3) = '202')
                        or (Copy(Form7.ibDataSet101.FieldByname('CFOP').AsString,2,3) = '411') then
                        begin
                          //
                          fSomaNaBase := 0;
                          //
                          if ibDataSet15.FieldByname('FRETE').AsFloat    <> 0 then if (ibDataSet15.FieldByname('FRETE').AsFloat    / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat) > 0.01 then fSomaNaBase  := fSomanaBase + (ibDataSet15.FieldByname('FRETE').AsFloat    / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat); // REGRA DE TRS ratiando o valor Total do Frete
                          if ibDataSet15.FieldByname('SEGURO').AsFloat   <> 0 then if (ibDataSet15.FieldByname('SEGURO').AsFloat   / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat) > 0.01 then fSomaNaBase  := fSomanaBase + (ibDataSet15.FieldByname('SEGURO').AsFloat   / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat); // REGRA DE TRS ratiando valor do Seguro
                          //
                          // Soma na base de calculo
                          //
                          if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                          begin
                            if ibDataSet15.FieldByname('DESPESAS').AsFloat <> 0 then if (ibDataSet15.FieldByname('DESPESAS').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat) > 0.01 then fSomaNaBase  := fSomanaBase + (ibDataSet15.FieldByname('DESPESAS').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat); // REGRA DE TRS ratiando o valor de outras
                          end;
                          //
                          if ibDataSet15.FieldByname('DESCONTO').AsFloat <> 0 then if (ibDataSet15.FieldByname('DESCONTO').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat) > 0.01 then fSomaNaBase  := fSomanaBase - (ibDataSet15.FieldByname('DESCONTO').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet101.FieldByname('TOTAL').AsFloat); // REGRA DE TRS ratiando o valor do frete descontando
                          //
                          Form7.ibDataSet15BASEICM.AsFloat  := Form7.ibDataSet15BASEICM.AsFloat    + Arredonda((ibDataSet101.FieldByname('BASE').AsFloat*fSomaNaBase/100),2);
                          Form7.ibDataSet15ICMS.AsFloat     := Form7.ibDataSet15ICMS.AsFloat       + Arredonda(((ibDataSet101.FieldByname('BASE').AsFloat*fSomaNaBase/100) * Form7.IbDataSet101.FieldByName('ICM').AsFloat / 100 ),2); // Acumula em 16 After post
                          //
                        end;
                      end;
                    end;
                  end;
                end;
                Form7.ibDataSet101.Next;
                //
              end;
            end;
            //
            Form7.ibDataSet4.Locate('REGISTRO',sReg4,[]);
            //
            // Particularidades do calculo do total do ICMS
            //
            try
              //
              // Verifica se pode usar tributao interestadual
              //
              if UpperCase(Copy(Form7.ibDataSet2IE.AsString,1,2)) = 'PR' then // Quando  produtor rural no precisa ter CGC
              begin
                sEstado := Form7.ibDataSet2ESTADO.AsString;
                if AllTrim(Form7.ibDataSet2CGC.AsString) = '' then sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString); // Quando  produtor rural tem que ter CPF
              end else
              begin
                if AllTrim((Limpanumero(Form7.ibDataSet2IE.AsString))) <> '' then sEstado := Form7.ibDataSet2ESTADO.AsString else sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
                if not CpfCgc(LimpaNumero(Form7.ibDataSet2CGC.AsString)) then sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
                if Length(AllTrim(Form7.ibDataSet2CGC.AsString)) < 18 then sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
              end;
              //
              sEstado := Form7.ibDataSet2ESTADO.AsString;
              //
              if Pos('1'+sEstado+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX2') = 0 then sEstado := 'MG';
              //
            except end;
            //
            try
              Form7.ibDataSet15.Post;
              Form7.ibDataSet15.Edit;
            except end;
            //
            // Libera a alterao
            //
          end;
          //
        end else
        begin
          Form12.SMALL_DBEdit16.ReadOnly := False;
        end;
        //
      except end;
      //
      // DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
      // ShowMessage('Tempo: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0));
      //
      Form7.ibDataSet15.EnableControls;

      {Sandro Silva 2022-11-08 inicio}
      if Trim(sReg16) <> '' then
        Form7.ibDataSet16.Locate('REGISTRO', sReg16, []);
      {Sandro Silva 2022-11-08 fim}

      //
      Screen.Cursor := crDefault;
      //
    end;
    //
    if Form7.sModulo = 'OS' then
      TotalizaOS(True);
    if Form7.sModulo = 'VENDA' then
      TotalizaServicos(True);
    //
  end;
  //
  Form7.ibDataSet4.EnableControls;
  Form7.IBQuery14.Close;
  AgendaCommit(True);
  //
  Form7.ibDataSet16.Tag := 0;

  FreeAndNil(IBQESTOQUE);

  //         //
  // The end //
  //         //
end;

procedure TForm7.ibDataSet16BeforeDelete(DataSet: TDataSet);
begin
  //
  if Form7.sModulo = 'OS' then
  begin
    if AllTrim(Form7.ibDataSet16NUMERONF.AsString) <> '' then
    begin
      if Form30.Visible then
      begin
        ShowMessage('No  possvel apagar este item porque foi importado para nota fiscal.');
        Abort;
      end;
    end;
  end;
  //
  Form1.rReserva := 0;
  //
  Form7.ibDataSet4.Close;
  Form7.ibDataSet4.Selectsql.Clear;
  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
  Form7.ibDataSet4.Open;
  //
  if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet16CODIGO.AsString) and (AllTrim(Form7.ibDataSet4CODIGO.AsString)<>'') then
  begin
    //
    // Grade
    //
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString) then
    begin
      try
        //
        // Grade // Quando deleta um item na venda
        //
        Form13.Button2.Enabled := False;
        Form7.sModulo := 'GRADE';
        Form13.Label1.Caption := 'Deletando um item da venda';
        Form13.ShowModal; // Quando deleta um item na venda
        Form7.sModulo := 'VENDA';
        Form13.Button2.Enabled := True;
      except end;
    end;
    //////////////////////////
    // Controle de serie    //
    // Esta rotina cancela  //
    // um item na venda     //
    //////////////////////////
    if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
    begin
      //
      Form7.ibDataSet30.Close;
      Form7.ibDataSet30.SelectSQL.Clear;
      Form7.ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
      Form7.ibDataSet30.Open;
      while not Form7.ibDataSet30.Eof do
      begin
        if Copy(Form7.ibDataSet30NFVENDA.AsString,1,6) = Copy(Form7.ibDataSet15NUMERONF.AsString,4,6) then
        begin
          Form7.ibDataSet30.Edit;
          Form7.ibDataSet30NFVENDA.AsString  := '';
          Form7.ibDataSet30VALVENDA.AsFloat  := 0;
          Form7.ibDataSet30DATVENDA.AsString := '';
        end;
        Form7.ibDataSet30.Next;
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet16NewRecord(DataSet: TDataSet);
begin
  //
//  ibDataSet16.Edit;
  Form7.ibDataSet16REGISTRO.AsString   := sProximo;
  Form7.ibDataSet16SINCRONIA.AsFloat   := 0;                                    // Resolvi este problema as 4 da madrugada no NoteBook em casa
  //
  if Form7.sModulo = 'OS' then
  begin
    Form7.ibDataSet16NUMEROOS.AsString := Form7.ibDataset3NUMERO.AsString;
  end else
  begin
    Form7.ibDataSet16NUMERONF.AsString := Form7.ibDataset15NUMERONF.AsString;
  end;
  //
end;

procedure TForm7.ibDataSet16CFOPSetText(Sender: TField; const Text: String);
begin
  //
  if LimpaNumero(Text) <> '' then
  begin
    if (Length(LimpaNumero(Text)) <> 4) or  ((Copy(LimpaNumero(Text),1,1) <> '5') and (Copy(LimpaNumero(Text),1,1) <> '6') and (Copy(LimpaNumero(Text),1,1) <> '7')) then
      ShowMessage('CFOP Invlido')
    else
      Form7.ibDataSet16CFOP.AsString := LimpaNumero(Text);
  end
  else
    Form7.ibDataSet16CFOP.AsString := '';
  if Form7.ibDataSet16TOTAL.AsFloat <=0 then
    Form7.ibDataSet16CFOP.AsString := '';
  //
end;

procedure TForm7.ibDataSet16DESCRICAOChange(Sender: TField);
var
  Mais1Ini: TiniFile;
  fQuantidadeVendida: Real;
  sModuloRes, sEstado, sCodigo: String;
  sSerial_: String;
  sTipoEtiqueta, sMensagem: String;
  bButton: Integer;
  sRegistro1:  String;
  bFind: Boolean;
  I: Integer;
  //
  // Hora, Min, Seg, cent : Word;
  // tInicio : tTime;
  //
  // Pis cofins da Operao
  //
  sCST_PIS_COFINS: String;
  rpPIS, rpCOFINS: Real;
  //
  // rPreco : Real;
  //
  ItemNFe: TItemNFe; // Sandro Silva 2022-11-11
begin
  //
  // tInicio := time;
  //
  try
    //
//    tInicio := time;
    //
    if (Form1.bFlag) and (Alltrim(ibDataSet16DESCRICAO.AsString) <> '') then
    begin
      //
      Form1.bflag        := False;
      bFind              := False;
      fQuantidadeVendida := 1;
      //
      Form7.ibDataSet4.DisableControls;
      //
      if AllTrim(Form7.ibDataSet16CODIGO.AsString) <> '' then
      begin
        if Form7.ibDataSet16CODIGO.AsString <> Form7.ibDataSet4CODIGO.AsString then
        begin
          Form7.ibDataSet4.Close;                                                //
          Form7.ibDataSet4.Selectsql.Clear;
          Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
          Form7.ibDataSet4.Open;
        end;
      end;
      //
      if Form7.ibDataSet16DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.AsString then
      begin
        //
        Form7.ibDataSet4.DisableControls;
        Form7.ibDataSet4.Close;
        Form7.ibDataSet4.SelectSQL.Clear;
        Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 order by upper(DESCRICAO)');
        Form7.ibDataSet4.Open;
        Form7.ibDataSet4.First;
        Form7.ibDataSet4.EnableControls;
        Form7.ibDataSet4.First;
        //
        // Procura por: cdigo
        //
        if (length(Alltrim(Form7.ibDataSet16DESCRICAO.AsString)) <= 5) and (LimpaNumero(Alltrim(Form7.ibDataSet16DESCRICAO.AsString))<>'') then
        begin
          try
            if StrToInt(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)) <> 0 then
              bFind := Form7.ibDataSet4.Locate('CODIGO',StrZero(StrToInt(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)),5,0),[]);
          except
          end;
        end;
        //
        if Pos(Alltrim(Form7.ibDataSet16DESCRICAO.AsString), Form7.ibDataSet4CODIGO.AsString) = 0 then
        begin
          //
          // Procura pela referencia
          //
          bFind := Form7.ibDataSet4.Locate('REFERENCIA',AllTrim(Form7.ibDataSet16DESCRICAO.AsString),[]);
          if Alltrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4REFERENCIA.AsString) then
          begin
            bFind := Form7.ibDataSet4.Locate('REFERENCIA',AnsiUppercase(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)),[]);
            if Alltrim(AnsiUppercase(Form7.ibDataSet16DESCRICAO.AsString)) = AllTrim(Form7.ibDataSet4REFERENCIA.AsString) then
            begin
              Form7.ibDataSet16DESCRICAO.AsString := Alltrim(AnsiUppercase(Form7.ibDataSet16DESCRICAO.AsString));
            end;
          end;
          // Se o produto no foi encontrado //
          if (Alltrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4REFERENCIA.AsString)) and (UpperCase(Alltrim(Form7.ibDataSet16DESCRICAO.AsString)) <> AllTrim(Form7.ibDataSet4REFERENCIA.AsString)) then
          begin
            //  produto pesado //
            if (Length(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)) = 13) and
             (Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),1,1) = '2' ) then
            begin
              bFind := Form7.ibDataSet4.Locate('REFERENCIA',Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),1,7),[]);
              if Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),1,7) = AllTrim(Form7.ibDataSet4REFERENCIA.AsString) then
              begin
                try
                  //
                  try
                    Mais1ini               := TIniFile.Create('FRENTE.INI');
                    sTipoEtiqueta          := Mais1Ini.ReadString('Frente de caixa' , 'Tipo etiqueta','KG');
                    Mais1Ini.Free;
                  except
                    sTipoEtiqueta := 'KG';
                  end;
                  //
                  if sTipoEtiqueta = 'KG' then
                  begin
                    if UpperCase(AllTrim(Form7.ibDataSet4MEDIDA.AsString)) = 'KU' then
                    begin
                      fQuantidadeVendida := StrToFloat(Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),8,5));
                    end else
                    begin
                      fQuantidadeVendida := StrToFloat(Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),8,5)) / 1000;
                    end;
                  end else
                  begin
                    fQuantidadeVendida := StrToFloat(Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),8,5)) / Form7.ibDataSet4.FieldByname('PRECO').AsFloat;
                  end;
                except
                end;
              end;
            end else
            begin
              //
              // Procura pela descrico
              //
              Form7.ibDataSet99.Close;
              Form7.ibDataSet99.SelectSQL.Clear;
              Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 and upper(DESCRICAO)='+QuotedStr(UpperCase(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)))+' order by upper(DESCRICAO)'); // Maa Verde
//              Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(AllTrim(ibDataSet16DESCRICAO.AsString))+'%')+' order by upper(DESCRICAO)');
              Form7.ibDataSet99.Open;
              Form7.ibDataSet99.First;
//              if Pos(UpperCAse(AllTrim(ibDataSet16DESCRICAO.AsString)),UpperCase(ibDataset99.FieldByname('DESCRICAO').AsString))<>0 then bFind := Form7.ibDataSet4.Locate('DESCRICAO',ibDataset99.FieldByname('DESCRICAO').AsString,[]);
              if Pos(UpperCAse(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)),UpperCase(Form7.ibDataset99.FieldByname('DESCRICAO').AsString))<> 0 then
                bFind := Form7.ibDataSet4.Locate('CODIGO',ibDataset99.FieldByname('CODIGO').AsString,[]); // ibDataSet16DESCRICAOChange
              //
            end;
          end;
        end;
      end
      else
        bFind := True;
      Form7.ibDataSet4.EnableControls;
      //
      //  Preenche os dados do arquivo NOTA0001.DBF
      //  se o produto for encontrado
      //
      if bFind then
      begin
        //
        // Grava no arquivo NOTA0001.DBF:
        //
        // 1. Descrico do produto
        // 2. Valor unitrio
        // 3. Quantidade
        // 4. Total
        // 5. Situao tributria
        // 6. Percentual do IPI
        // 7. Peso
        // 7. Cdigo
        //
        Form7.ibDataSet16.Edit;
        Form7.ibDataSet16DESCRICAO.AsString := AllTrim(Form7.ibDataSet16DESCRICAO.AsString);
        {Sandro Silva 2022-12-20 inicio}
        Form7.ibDataSet16IDENTIFICADORPLANOCONTAS.Value := Form7.ibDataSet4IDENTIFICADORPLANOCONTAS.Value;
        if Form7.ibDataSet16IDENTIFICADORPLANOCONTAS.AsString = '' then
          Form7.ibDataSet16IDENTIFICADORPLANOCONTAS.Clear;
        {Sandro Silva 2022-12-20 fim}
        //
        if Form7.ibDataSet16CODIGO.AsString <> Form7.ibDataSet4CODIGO.AsString then
        begin
          //
          if (ibDataSet4QTD_ATUAL.AsFloat <= 0) and (Form1.ConfNegat = 'No') and (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) = 0) then
          begin
            ShowMessage('No  possvel efetuar a venda, s tem ' + ibDataSet4QTD_ATUAL.AsString + ' no estoque. Cod. 1');
            Form7.ibDataSet16DESCRICAO.AsString   := '';
            Form7.ibDataSet16TOTAL.AsString       := '';
            Form7.ibDataSet16UNITARIO.AsString    := '';
            Form7.ibDataSet16QUANTIDADE.AsString  := '';
            Form7.ibDataSet16CODIGO.AsString      := '';
            Form7.ibDataSet16CFOP.AsString        := '';
          end else
          begin
            //
            if not Form41.Visible then
            begin
              ///////////////////////
              // Controle de serie //
              ///////////////////////
              if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
              begin
                //
                sCodigo := Form7.ibDataSet4.FieldByname('CODIGO').AsString;
                Form7.ibDataSet16.Edit;
                Form7.ibDataSet16DESCRICAO.AsString := Form7.ibDataSet4DESCRICAO.AsString;
                Form7.ibDataSet16CODIGO.AsString    := Form7.ibDataSet4CODIGO.AsString;
                //
                Form7.ibDataSet16.Edit;
                Form7.ibDataSet16QUANTIDADE.AsFloat := 0;
                //
                sSerial_ := '99';
                sMensagem := '';
                //
                while AllTrim(sSerial_) <> '' do
                begin
                  //
                  try
                    sRegistro1 := Form7.ibDataSet16REGISTRO.AsString;
                  except end;
                  //
                  sSerial_ := AllTrim(Form1.Small_InputForm('Venda de item','Nmero de srie:','')); // Nf de venda
                  //
                  if sSerial_ <> '' then
                  begin
                    //
                    Form7.ibDataSet30.Close;
                    Form7.ibDataSet30.SelectSQL.Clear;
                    Form7.ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString));
                    Form7.ibDataSet30.Open;
                    //
                    while not ibDataSet30.Eof do
                    begin
                      try
                        if ibDataSet30SERIAL.AsString = sSerial_ then
                        begin
                          if AllTrim(ibDataSet30NFVENDA.AsString) = '' then
                          begin
                            //
                            Form7.ibDataSet30.Edit;
                            Form7.ibDataSet30NFVENDA.AsString     := Copy(Form7.ibDataSet15NUMERONF.AsString,4,6);
                            Form7.ibDataSet30VALVENDA.AsFloat     := Form7.ibDataSet16UNITARIO.AsFloat;
                            Form7.ibDataSet30DATVENDA.AsDateTime  := Form7.ibDataSet15EMISSAO.AsDateTime;
                            Form7.ibDataSet16QUANTIDADE.AsFloat   := Form7.ibDataSet16QUANTIDADE.AsFloat + 1;
                            fQuantidadeVendida              := Form7.ibDataSet16QUANTIDADE.AsFloat;
                            Form7.ibDataSet16.Post;
                            //
                            Form1.bFlag := False;
                            //
                            Form7.ibDataSet16.Append;
                            Form7.ibDataSet16DESCRICAO.AsString := 'SERIAL ' +  ibDataSet30SERIAL.AsString;
                            Form7.ibDataSet16.Post;
                            Form7.ibDataSet16.Locate('REGISTRO',sRegistro1,[]);
                            Form7.ibDataSet16.Edit;
                            //
                            try
                              Form7.ibDataSet4.Close;
                              Form7.ibDataSet4.Selectsql.Clear;
                              Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(sCodigo)+' ');  //
                              Form7.ibDataSet4.Open;
                            except end;
                            //
                            Form1.bFlag := True;
                            //
                            sSerial_ := '0CONFIRMADO0';
                            sMensagem := '';
                            //
                          end else
                          begin
                            sMensagem := 'Nmero de srie j vendido.';
                          end;
                        end;
                        //
                      except end;
                      //
                      Form7.ibDataSet30.Next;
                      //
                    end;
                  end;
                  //
                  try
                    if (sMensagem = 'Nmero de srie j vendido.') then
                      ShowMessage(sMensagem)
                    else if (sSerial_ <> '0CONFIRMADO0') and (sSerial_ <> '') then
                      ShowMessage('Nmero de srie no encontrado no produto: '+Chr(10)+ibDataSet4DESCRICAO.AsString);
                  except
                  end;
                  //
                end;
                //
              end;
              //
            end;
            //
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16DESCRICAO.AsString := Form7.ibDataSet4DESCRICAO.AsString;
            Form7.ibDataSet16CODIGO.AsString    := Form7.ibDataSet4CODIGO.AsString;
            if Form7.ibDataSet16QUANTIDADE.AsFloat = 0 then
              Form7.ibDataSet16QUANTIDADE.AsFloat := 0;
            //
            if (Form7.ibDataSet15FINNFE.AsString = '4') and (Form7.Tag = 999) then // Devolucao Devoluo
            begin
              //
              // No faz nada est importando a NF para Devoluo
              //
            end else
            begin
              //
              // Desconto pelo convnio
              //
              if AllTrim(Form7.ibDataSet2CONVENIO.AsString) <> '' then
              begin
                Form7.ibDataSet29.Locate('NOME', Form7.ibDataSet2CONVENIO.AsString,[]);
                if Form7.ibDataSet29DESCONTO.AsFloat <> 0 then
                begin
                  bButton := Application.MessageBox(Pchar('Confirma um desconto de: % ' + AllTrim(Format('%12.2n',[Form7.ibDataSet29DESCONTO.AsFloat])) +
                    Chr(10) + 'Conforme convnio: ' + Form7.ibDataSet29NOME.AsString+
                    Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
                    //
                  if bButton = IDYES then
                    Form7.ibDataSet16UNITARIO.AsFloat    := Int(Form7.ibDataSet4PRECO.AsFloat * ( 1 - (Form7.ibDataSet29DESCONTO.AsFloat/100)) * StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco))))/StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco)))
                  else
                    Form7.ibDataSet16UNITARIO.AsFloat := Int(ibDataSet4PRECO.AsFloat * StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco))))/StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco)));
                end
                else
                  Form7.ibDataSet16UNITARIO.AsFloat   := Int(ibDataSet4PRECO.AsFloat * StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco))))/StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco)));
              end else
              begin
                //
                // Venda pelo custo
                //
                if Pos('0',Form7.ibDataSet14INTEGRACAO.asString) = 0 then
                begin
                  Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
                end else
                begin
                  Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat, StrToInt(Form1.ConfPreco));
                end;
                //
              end;
              //
              Form7.ibDataSet16ST.AsString        := Form7.ibDataSet4ST.AsString;
              Form7.ibDataSet16MEDIDA.AsString    := Form7.ibDataSet4MEDIDA.AsString;
              Form7.ibDataSet16IPI.AsFloat        := Form7.ibDataSet4IPI.AsFloat;
              Form7.ibDataSet16PESO.AsFloat       := Form7.ibDataSet4PESO.AsFloat;
              Form7.ibDataSet16CUSTO.AsFloat      := Form7.ibDataSet4CUSTOCOMPR.AsFloat;
              Form7.ibDataSet16LISTA.AsFloat      := Form7.ibDataSet4PRECO.AsFloat;
              //
              // Grade
              //
              if Form7.ibDataSet16DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString then
              begin
                //
                Form7.ibDataSet10.Close;
                Form7.ibDataSet10.SelectSQL.Clear;
                Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
                Form7.ibDataSet10.Open;
                Form7.ibDataSet10.First;
                //
                Form7.ibDataSet16.Edit;
                //
                if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
                begin
                  //
                  // Cadastro do item na VENDA quantidade geralemtne = 1
                  //
                  if (Form7.ibDataSet16QUANTIDADE.AsFloat = 0) or (Form7.ibDataSet4.FieldByname('SERIE').Value = 1) then
                  begin
                    //
                    Form1.rReserva := 0;
                    Form13.Label1.Caption := 'Cadastro do item na venda';
                    Form13.ShowModal; //  Cadastro do item na VENDA quantidade geralemtne = 1
                    //
                    // Mostra como comentrio
                    //
                    Form7.ibDataSet16.Post;
                    //
                    sRegistro1 := Form7.ibDataSet16REGISTRO.AsString;
                    //
                    Form7.ibDataSet16.Append;
                    Form7.ibDataSet16DESCRICAO.AsString := Form1.sGrade;
                    Form7.ibDataSet16.Post;
                    //
                    Form7.ibDataSet16.Locate('REGISTRO',sRegistro1,[]);
                    //
                    Form7.ibDataSet16.Edit;
                    //
                  end;
                end;
              end;
              //
              if (Form7.ibDataSet16QUANTIDADE.AsFloat = 0) and (Form7.ibDataSet16DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString) then
              begin
                Form7.ibDataSet16.Edit;
                Form7.ibDataSet16QUANTIDADE.AsFloat := fQuantidadeVendida;
              end;
              //
            end;

          end;
          //
          // Comentrio do produto
          //
          for I := 1 to 9 do
          begin
            if (Pos('<Obs'+IntToStr(I)+'>',Form7.ibDataSet4TAGS_.AsString) <> 0) and (Pos('</Obs'+IntToStr(I)+'>',Form7.ibDataSet4TAGS_.AsString) > Pos('<Obs'+IntToStr(I)+'>',ibDataSet4TAGS_.AsString)) then
            begin
              //
              // Mostra como comentrio
              sModuloREs := Form7.sMoDulo;
              Form7.sMoDulo := 'No';
              //
              Form7.ibDataSet16.Post;
              //
              sRegistro1 := Form7.ibDataSet16REGISTRO.AsString;
              //
              Form7.ibDataSet16.Append;
              Form1.bFlag := False;
              Form7.ibDataSet16DESCRICAO.AsString := Copy(Form7.ibDataSet4TAGS_.AsString,Pos('<Obs'+IntToStr(I)+'>',Form7.ibDataSet4TAGS_.AsString)+6,(Pos('</Obs'+IntToStr(I)+'>',ibDataSet4TAGS_.AsString)-Pos('<Obs'+IntToStr(I)+'>',ibDataSet4TAGS_.AsString))-6);
              Form7.ibDataSet16.Post;
              //
              // Form1.bFlag := True;
              //
              Form7.ibDataSet16.Locate('REGISTRO',sRegistro1,[]);
              //
              Form7.ibDataSet16.Edit;
              Form7.sMoDulo := sModuloRes;
              //
            end;
          end;
          //
        end;
        //
        if (Form7.sModulo = 'VENDA') or (Form7.sModulo = 'RETRIBUTA') then
        begin
          //
          if Form7.ibDataSet15OPERACAO.AsString <> Form7.ibDataSet14NOME.AsString then
          begin
            Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);       //
          end;
          //
          sCST_PIS_COFINS := Form7.ibDataSet14.FieldByname('CSTPISCOFINS').AsString;
          rpPIS           := Form7.ibDataSet14.FieldByname('PPIS').AsFloat;
          rpCOFINS        := Form7.ibDataSet14.FieldByname('PCOFINS').AsFloat;
          //
          try
            //
            // Verifica se pode usar tributao interestadual
            //
            if UpperCase(Copy(Form7.ibDataSet2IE.AsString,1,2)) = 'PR' then // Quando  produtor rural no precisa ter CGC
            begin
              sEstado := UpperCAse(Form7.ibDataSet2ESTADO.AsString);
              if AllTrim(Form7.ibDataSet2CGC.AsString) = '' then sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString); // Quando  produtor rural tem que ter CPF
            end else
            begin
              if AllTrim((Limpanumero(Form7.ibDataSet2IE.AsString))) <> '' then sEstado := Form7.ibDataSet2ESTADO.AsString else sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
              if not CpfCgc(LimpaNumero(Form7.ibDataSet2CGC.AsString)) then sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
              if Length(AllTrim(Form7.ibDataSet2CGC.AsString)) <= 14 then sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
            end;
            //
            sEstado := Form7.ibDataSet2ESTADO.AsString;
            //
            if Pos('1'+sEstado+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX2') = 0 then sEstado := 'MG';
            //
            // CFOP Dinamico
            //
            if (Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '107') and (Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '108') then // Esta faixa no muda dentro e fora do estado DOUGLAS - Electra - Sara Suporte
            begin
              if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '5') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '6') then
              begin
                try
                  if AllTrim(Form7.ibDataSet2ESTADO.AsString) = 'EX' then
                  begin
                    Form7.ibDataSet14.Edit;
                    Form7.ibDataSet14CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5);
                    Form7.ibDataSet14.Post;
                  end else
                  begin
                    Form7.ibDataSet14.Edit;
                    if (sEstado = UpperCase(Form7.ibDataSet13ESTADO.AsString)) or (AllTrim(Form7.ibDataSet2ESTADO.AsString)='') then
                      Form7.ibDataSet14CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5)
                    else
                      Form7.ibDataSet14CFOP.AsString := '6'+copy(Form7.ibDataSet14CFOP.AsString,2,5); // Ok
                    Form7.ibDataSet14.Post;
                  end;
                  //
                  try
                    if (Form12.Edit3.Text = '1-Consumidor Final') and (Form7.ibDataSet13ESTADO.AsString <> Form7.ibDataSet2ESTADO.AsString) then
                    begin
                      Form7.ibDataSet16PFCPUFDEST.Visible := True;
                      Form7.ibDataSet16PICMSUFDEST.Visible := True;
                    end else
                    begin
                      Form7.ibDataSet16PFCPUFDEST.Visible := False;
                      Form7.ibDataSet16PICMSUFDEST.Visible := False;
                    end;
                    //
                    if AllTrim(Form7.ibDataSet2ESTADO.AsString)='EX' then
                    begin
                      Form7.ibDataSet16PFCPUFDEST.Visible := False;
                      Form7.ibDataSet16PICMSUFDEST.Visible := False;
                    end;
                  except end;
                  //
                except end;
              end;
            end;
            //
            if Form7.ibDataSet14.FieldByName(sEstado+'_').AsFloat <> 0 then
            begin
              //
              // Se o ST do produto for <> de zero pode
              // ser que este produto tenha uma aliquota
              // reduzida, ou tributado de ISS
              //
              if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
              begin
                //
                // Nova rotina para posicionar na tabla de CFOP
                //
                Form7.IBQuery14.Close;
                Form7.IBQuery14.SQL.Clear;
                Form7.IBQuery14.SQL.Add('select * from ICM where ST='+QuotedStr(Form7.ibDataSet4ST.AsString)+''); // Nova rotina
                Form7.IBQuery14.Open;
                //
                if AllTrim(Form7.IBQuery14.FieldByName('ST').AsString) <> AllTrim(Form7.ibDataSet4ST.AsString) then
                begin
                  Form7.IBQuery14.Close;
                  Form7.IBQuery14.SQL.Clear;
                  Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                  Form7.IBQuery14.Open;
                end else
                begin
                  //
                  // Joga p/obs a obs na tabela de icm
                  //
                  ObservacaoProduto(False); // Obs do ibDAtaSet14 relacionado ao item
                  //
                end;
                //
              end else
              begin
                //
                Form7.IBQuery14.Close;
                Form7.IBQuery14.SQL.Clear;
                Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                Form7.IBQuery14.Open;
                //
              end;
              //
            end else
            begin
              Form7.IBQuery14.Close;
              Form7.IBQuery14.SQL.Clear;
              Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
              Form7.IBQuery14.Open;
            end;
            //
          except
          end;
          //
          // Se o UF do cliente for invlido ocorre um erro
          //
          try
            //
            Form7.ibDataSet16.Edit;
            //
            if Form7.ibDataSet15FINNFE.AsString <> '4' then // Devolucao Devoluo
            begin
              if AllTrim(Form7.ibDataSet14CFOP.AsString) <> '' then
              begin
                if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '7') and (Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '3') then // Exportao
                begin
                  //
                  try
                    if (Form12.Edit3.Text = '1-Consumidor Final') and (Form7.ibDataSet13ESTADO.AsString <> Form7.ibDataSet2ESTADO.AsString) then
                    begin
                      Form7.ibDataSet16PFCPUFDEST.Visible  := True;
                      Form7.ibDataSet16PICMSUFDEST.Visible := True;
                    end else
                    begin
                      Form7.ibDataSet16PFCPUFDEST.Visible  := False;
                      Form7.ibDataSet16PICMSUFDEST.Visible := False;
                    end;
                  except
                  end;
                  //
                  if AllTrim(Form7.ibDataSet2ESTADO.AsString) = 'EX' then
                  begin
                    Form7.ibDataSet16CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5);
                    Form7.ibDataSet16PFCPUFDEST.Visible  := False;
                    Form7.ibDataSet16PICMSUFDEST.Visible := False;
                  end else
                  begin
                    if (Form7.IBDataSet2ESTADO.AsString = UpperCase(Form7.ibDataSet13ESTADO.AsString)) or (AllTrim(Form7.ibDataSet2ESTADO.AsString)='') then
                      Form7.ibDataSet16CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5)
                    else
                      Form7.ibDataSet16CFOP.AsString := '6'+copy(Form7.ibDataSet14CFOP.AsString,2,5); // Ok
                  end;
                  //
                  //
                end;
              end;
              //
              // certo
              //
              Form7.ibDataSet16IPI.AsFloat     := Form7.ibDataSet4IPI.AsFloat;
              Form7.ibDataSet16ISS.AsFloat     := Form7.ibQuery14.FieldByName('ISS').AsFloat;
              Form7.ibDataSet16BASE.AsFloat    := Form7.ibQuery14.FieldByName('BASE').AsFloat;
              Form7.ibDataSet16BASEISS.AsFloat := Form7.ibQuery14.FieldByName('BASEISS').AsFloat;
              Form7.ibDataSet16ICM.AsFloat     := Form7.ibQuery14.FieldByName(sEstado+'_').AsFloat;
              //
              Form7.ibDataSet16CST_IPI.AsString     := Form7.ibDataSet4CST_IPI.AsString;   // Cst do IPI no estoque
              Form7.ibDataSet16CST_ICMS.AsString    := Form7.ibDataSet4CST.AsString;       // CST do ICMS no estoque

              {Sandro Silva 2022-11-11 inicio}
              try
                if Form7.ibDataSet13.FieldByName('CRT').AsString = '1' then
                begin
                  ItemNFe := TItemNFe.Create;
                  CsosnComOrigemdoProdutoNaOperacao(Form7.ibDataSet16CODIGO.AsString, Form7.ibDataSet15OPERACAO.AsString, ItemNFe);
                  Form7.ibDataSet16CSOSN.AsString := ItemNFe.CSOSN;
                end;
              except

              end;
              if ItemNFe <> nil then
                FreeAndNil(ItemNFe);
              {Sandro Silva 2022-11-11 fim} 

              //
              // Pis cofins da Operao
              //
              if Alltrim(sCST_PIS_COFINS) <> '' then
              begin
                Form7.ibDataSet16CST_PIS_COFINS.AsString := sCST_PIS_COFINS;
                Form7.ibDataSet16ALIQ_PIS.AsFloat        := rpPIS;
                Form7.ibDataSet16ALIQ_COFINS.AsFloat     := rpCOFINS;
              end else
              begin
                Form7.ibDataSet16CST_PIS_COFINS.AsString := Form7.ibDataSet4CST_PIS_COFINS_SAIDA.AsString;     // CST do PIS no ICM
                Form7.ibDataSet16ALIQ_PIS.AsFloat        := Form7.ibDataSet4ALIQ_PIS_SAIDA.AsFloat;
                Form7.ibDataSet16ALIQ_COFINS.AsFloat     := Form7.ibDataSet4ALIQ_COFINS_SAIDA.AsFloat;
              end;
              //
              {Sandro Silva 2022-09-28 inicio
              if AllTrim(Form7.ibQuery14.FieldByName('CFOP').AsString) <> '' then
              begin
                Form7.ibDataSet16CFOP.AsString := Copy(Form7.ibDataSet14CFOP.AsString,1,1)+Copy(Form7.ibQuery14.FieldByName('CFOP').AsString,2,3);
              end else
              begin
                Form7.ibDataSet16CFOP.AsString := Form7.ibDataSet14CFOP.AsString;
              end;
              }
            end;
            {Sandro Silva 2022-09-28 inicio}
            //Ficha 6273
            if AllTrim(Form7.ibQuery14.FieldByName('CFOP').AsString) <> '' then
            begin
              Form7.ibDataSet16CFOP.AsString := Copy(Form7.ibDataSet14CFOP.AsString,1,1)+Copy(Form7.ibQuery14.FieldByName('CFOP').AsString,2,3);
            end else
            begin
              Form7.ibDataSet16CFOP.AsString := Form7.ibDataSet14CFOP.AsString;
            end;
            {Sandro Silva 2022-09-28 fim}
            //
          except
            //
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16IPI.AsFloat      := 0;
            Form7.ibDataSet16BASE.AsFloat     := 100;
            Form7.ibDataSet16BASEISS.AsFloat  := 0;
            Form7.ibDataSet16ISS.AsFloat      := 0;
            Form7.ibDataSet16ICM.AsFloat      := 0;
            //
          end;
          //
          if not (Form7.ibDataSet4PIVA.AsFloat > 0) then
          begin
            if AllTrim(Form7.ibQuery14.FieldByName('CST').AsString) <> '' then // Tabela de ICM
            begin
              if (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '30') or
                 (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '40') or
                 (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '41') or
                 (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '50') or
                 (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '60') then
              begin
                Form7.ibDataSet16BASE.AsFloat     := 0;
              end;
            end else  //
            begin     // Estoque
              if (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '30') or
                 (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '40') or
                 (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '41') or
                 (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '50') or
                 (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '60') then
              begin
                Form7.ibDataSet16BASE.AsFloat     := 0;
              end;
            end;
          end;
          //
        end;
        //
      end else
      begin
        //
        // DESCRICAO NO CORPO DA NOTA
        //
        Form7.ibDataSet16.Edit;
        Form7.ibDataSet16QUANTIDADE.AsString := '';
        //
        // Form1.bFlag := False;
        //
      end;
      //
      Form1.bFlag := True;
      //
    end;
    //
  except
  end;
  //
  // DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
  // Form12.Label65.Hint := 'Tempo: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0);
  //
  Form7.IBQuery14.Close;
  //
  //
end;


procedure TForm7.ibDataSet16DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  //
  // Localiza pela descricao
  //
  if Limpanumero(Text) <> Text then
  begin
    //
//    Form7.ibDataSet4.DisableControls;
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.SelectSQL.Clear;
    Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 and  upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(Text)+'%')+' order by upper(DESCRICAO)');
    Form7.ibDataSet4.Open;
    Form7.ibDataSet4.First;
    Form7.ibDataSet4.EnableControls;
    //
    if AllTrim(ibDataSet16CODIGO.AsString) <> '' then
    begin
      //////////////////////////
      // Controle de serie    //
      // Esta rotina cancela  //
      // um item na venda     //
      //////////////////////////
      if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
      begin
        ibDataSet30.Close;
        ibDataSet30.SelectSQL.Clear;
        ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
        ibDataSet30.Open;
        while not ibDataSet30.Eof do
        begin
          if Copy(ibDataSet30NFVENDA.AsString,1,6) = Copy(Form7.ibDataSet15NUMERONF.AsString,4,6) then
          begin
            ibDataSet30.Edit;
            ibDataSet30NFVENDA.AsString := '';
          end;
          ibDataSet30.Next;
        end;
      end;
      /////////////////////////////////////////////
    end;
  end;
  //
  ibDataSet16DESCRICAO.AsString := Text;
  //
end;

procedure TForm7.ibDataSet16QUANTIDADEChange(Sender: TField);
var
  fDesconto : Real;
begin
  //                                               //
  // Quando altera a quantidade recalcula o valor  //
  // total, mas s quando o valor total  alterado //
  //                                               //
  if AllTrim(Form7.ibDataSet16QUANTIDADE.AsString) <> '' then
  begin
    //
    if Form7.ibDataSet16QUANTIDADE.AsFloat <> 0 then
    begin
      //
      fDesconto := 0;
      //
      if Form7.ibDataSet16QUANTIDADE.Asfloat >= Form7.ibDataSet4QTD_PRO1.AsFloat then fDesconto := form7.ibDataSet4DESCONT1.AsFloat;
      if Form7.ibDataSet16QUANTIDADE.Asfloat >= Form7.ibDataSet4QTD_PRO2.AsFloat then fDesconto := form7.ibDataSet4DESCONT2.AsFloat;
      //
      if fDesconto <> 0 then
      begin
//        if Form7.ibDataSet4PRECO.AsFloat = Form7.ibDataSet16UNITARIO.AsFloat then
        if Form7.sModulo <> 'ORCAMENTO' then
        begin
          if Application.MessageBox(Pchar('Confirma um desconto de: ' + AllTrim(Format('%12.2n',[fDesconto])) + ' % no produto: ' + Form7.ibDataSet4PRECO.AsString),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION) = IDYES then
          begin
            Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat - ( Form7.ibDataSet4PRECO.AsFloat * fDesconto / 100);
          end;
        end;
      end;
      //
      if Arredonda(Form7.ibDataSet16TOTAL.AsFloat,4) <> Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat *  Form7.ibDataSet16UNITARIO.AsFloat,4) then
      begin
        Form7.ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,4);
      end;
      //
      //
    end else
    begin
      if Form7.ibDataSet16TOTAL.AsFloat <> 0 then
      begin
        Form7.ibDataSet16TOTAL.AsFloat    := 0;
        Form7.ibDataSet16UNITARIO.AsFloat := 0;
      end;
    end;
    //
    //
  end;
  //          //
  // the end  //
  //          //
end;

procedure TForm7.ibDataSet16QUANTIDADESetText(Sender: TField;
  const Text: String);
begin
  //
  // Quando o produto no ta cadastrado fica como comentrio em cinza
  //
  if ibDataSet16QUANTIDADE.AsFloat <> StrToFloat(Text) then
  begin
    //
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;
    //
    if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',44),1,44) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',44),1,44)) then
    begin
      Form7.ibDataSet16UNITARIO.AsString   := '';
      Form7.ibDataSet16TOTAL.AsString      := '';
      Form7.ibDataSet16QUANTIDADE.AsString := '';
    end else
    begin
      /////////////////////////////////////////////////////////////////////////
      // Grade                                                               //
      /////////////////////////////////////////////////////////////////////////
      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;
      //
      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
      begin
        Form7.ibDataSet16QUANTIDADE.AsString  := Form7.ibDataSet16QUANTIDADE.AsString; // Fica 1
      end else
      begin
        //
        // Controle de nmero de Serie
        //
        if StrToFloat(LimpaNumero('0'+Text)) <> 0 then
        begin
          if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then                                      //
          begin                                                                    //
            Form7.ibDataSet16QUANTIDADE.AsString  := Form7.ibDataSet16QUANTIDADE.AsString; // Fica 1
          end else                                                                 //
          begin                                                                    //
            /////////////////////////////////////////////////////////////////////////////
            // No permite quantidade negativa                                         //
            /////////////////////////////////////////////////////////////////////////////
            if ibDataSet16QUANTIDADE.AsFloat < 0 then ibDataSet16QUANTIDADE.AsFloat := 0 else
            begin
              if (Form1.ConfNegat = 'No') and (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) = 0) then
              begin
                if (StrToFloat(Text) > ibDataSet4QTD_ATUAL.AsCurrency) then
                begin
                  ShowMessage('No  possvel efetuar a venda, s tem ' + ibDataSet4QTD_ATUAL.AsString + ' no estoque. Cod. 3');
                  Form7.ibDataSet16DESCRICAO.AsString   := '';
                  Form7.ibDataSet16TOTAL.AsString       := '';
                  Form7.ibDataSet16UNITARIO.AsString    := '';
                  Form7.ibDataSet16QUANTIDADE.AsString  := '';
                  Form7.ibDataSet16CODIGO.AsString      := '';
                  Form7.ibDataSet16CFOP.AsString        := '';
                end
                else
                  ibDataSet16QUANTIDADE.AsFloat := StrToFloat(Text);
              end
              else
                ibDataSet16QUANTIDADE.AsFloat := StrToFloat(Text);
            end;
          end;
        end else
        begin
          //
          // No permite quantidade negativa
          //
          Form7.ibDataSet16QUANTIDADE.AsString  := Form7.ibDataSet16QUANTIDADE.AsString; // Fica 1
          //
        end;
      end;
    end;
    //
  end;
  //
  //
  // the end
  //
end;

procedure TForm7.ibDataSet16UNITARIOChange(Sender: TField);
begin
  //
  // Verifica se ta cadastrado
  //
  if AllTrim(Form7.ibDataSet16UNITARIO.AsString) <> '' then
  begin
    //
    // Quando o produto no ta cadatrado  comntario fica em cinza
    //
    if Form7.ibDataSet16DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.AsString then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;
    //
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) = AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      //
      // Se o produto ta com pro zerado tem que preencher com 0.001 lei de MG
      //
      if Form7.ibDataSet4PRECO.Value = 0 then
      begin
        Form7.ibDataSet4.Edit;
        Form7.ibDataSet4PRECO.Value := 0.01;
      end;
      //
      // No aceita zerado
      //
      if Form7.ibDataSet16UNITARIO.AsFloat = 0 then
      begin
        //
        Form7.ibDataSet16.Edit;
        //
        // Venda pelo custo
        //
        if Pos('0',Form7.ibDataSet14INTEGRACAO.asString) = 0 then
        begin
          Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
        end else
        begin
          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
        end;
        //
      end;
      //
      // Calcula o desconto quando  negativo
      //
      if Form7.ibDataSet16UNITARIO.AsFloat < 0 then
      begin
        Form7.ibDataSet16.Edit;
        Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat * (1- ((Form7.ibDataSet16UNITARIO.AsFloat *-1) /100));
      end;
      //
      // Quando altera a quantidade recalcula o valor
      // total, mas s quando o valor total  alterado
      //
      if Form7.ibDataSet16QUANTIDADE.AsFloat <> 0 then
      begin
        if Arredonda(Form7.ibDataSet16TOTAL.AsFloat,5) <> Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,9) then
        begin
           Form7.ibDataSet16.Edit;
           Form7.ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,9);
        end;
      end;
    end;
  end;
  //
  // the end
  //
end;

procedure TForm7.ibDataSet16UNITARIOSetText(Sender: TField;
  const Text: String);
begin
  try
    //                                                     //
    // No permite alterar a OS quando a NF ja foi emitida //
    //                                                     //
    if Form7.sModulo = 'OS' then
    begin
      if Form7.ibDataSet16NUMERONF.AsString <> '' then
      begin
        if Form30.Visible then
        begin
          ShowMessage('No  possvel alterar o valor deste item porque foi importado para nota fiscal.');
          ibDataSet16UNITARIO.AsFloat := ibDataSet16UNITARIO.AsFloat;
          Abort;
        end;
      end;
    end;
    //                                                                           //
    // Se o produto no ta cadastrado  comentrio                               //
    //                                                                           //
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;
    //
    if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',44),1,44) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',44),1,44)) then
    begin
    // ShowMessage('Teste'+chr(10)+chr(10)+Form7.ibDataSet16DESCRICAO.AsString+chr(10)+Form7.ibDataSet16CODIGO.AsString+chr(10)+Form7.ibDataSet4DESCRICAO.AsString+chr(10)+Form7.ibDataSet4CODIGO.AsString+chr(10)+Form7.ibDataSet4.SelectSql.Text);
      //                                                              //
      // Quando o produto no ta cadatrado  comntario fica em cinza //
      //                                                              //
      Form7.ibDataSet16UNITARIO.AsString   := '';
      Form7.ibDataSet16TOTAL.AsString      := '';
      Form7.ibDataSet16QUANTIDADE.AsString := '';
    end else
    begin
      //                                   //
      // No permite venda abaixo do custo //
      //                                   //
      if StrToFloat(LimpaNumero('0'+Text)) <> 0 then
      begin
        if StrToFloat(Text) >= 0 then   // Se for -  desconto
        begin                           //
          if (Form1.ConfCusto = 'No') then
          begin
            if StrToFloat(Text) < ibDataSet4CUSTOCOMPR.AsFloat then
            begin
              ShowMessage('No  possvel efetuar vendas com o preo abaixo do custo');
            end else ibDataSet16UNITARIO.AsFloat := Arredonda(StrToFloat(Text),9);
          end else ibDataSet16UNITARIO.AsFloat   := Arredonda(StrToFloat(Text),9);
        end else ibDataSet16UNITARIO.AsFloat     := Arredonda(StrToFloat(Text),9);

{
            end else ibDataSet16UNITARIO.AsFloat := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
          end else ibDataSet16UNITARIO.AsFloat   := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
        end else ibDataSet16UNITARIO.AsFloat     := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
}
      end else
      begin
        //
        //
        // Venda pelo custo
        //
        if Pos('0',Form7.ibDataSet14INTEGRACAO.asString) = 0 then
        begin
          Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
        end else
        begin
          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
        end;
        //
      end;
      //
    end;
    //
    // the end
    //
  except
  end;
end;

procedure TForm7.ibDataSet16TOTALChange(Sender: TField);
begin
  try
    if AllTrim(Form7.ibDataSet16TOTAL.AsString) <> '' then
    begin
      //
      // No permite valor negativo no total
      //
      if Form7.ibDataSet16TOTAL.AsFloat <= 0 then
      begin
        Form7.ibDataSet16.Edit;
        Form7.ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));
      end;
      //
      // S altera o valor unitrio quando for necessrio
      //
      if Form7.ibDataSet16QUANTIDADE.Asfloat <> 0 then
      begin
        //
        // + ou menos 0.001
        //
        if (Form7.ibDataSet16UNITARIO.AsFloat - (Form7.ibDataSet16TOTAL.AsFloat / Form7.ibDataSet16QUANTIDADE.Asfloat) > 0.001)
        or ((Form7.ibDataSet16TOTAL.AsFloat / Form7.ibDataSet16QUANTIDADE.Asfloat) - Form7.ibDataSet16UNITARIO.AsFloat > 0.001) then
        begin
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet16TOTAL.AsFloat / Form7.ibDataSet16QUANTIDADE.Asfloat,StrToInt(Form1.ConfPreco));
        end;
      end;
    end;
  except
  end;
  //
  // The end no modifi
  //
end;

procedure TForm7.ibDataSet16TOTALSetText(Sender: TField; const Text: String);
begin
  //
  // Verifica se ta cadastrado
  //
  try
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;
    //
    if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',44),1,44) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',44),1,44)) then
    begin
      //
      // Quando o produto no ta cadatrado  comntario fica em cinza
      //
      Form7.ibDataSet16UNITARIO.AsString   := '';
      Form7.ibDataSet16TOTAL.AsString      := '';
      Form7.ibDataSet16QUANTIDADE.AsString := '';
    end else
    begin
      //
      // No permite alterar a OS quando a NF ja foi emitida
      //
      if Form7.sModulo = 'OS' then
      begin
        if Form7.ibDataSet16NUMERONF.AsString <> '' then
        begin
          if Form30.Visible then
          begin
            ShowMessage('No  possvel alterar o valor deste item porque foi importado para nota fiscal.');
            ibDataSet16TOTAL.AsFloat := ibDataSet16TOTAL.AsFloat;
          end;
        end else ibDataSet16TOTAL.AsString := Text;
      end;
      //
      // No permite venda abaixo do custo
      //
      if StrToFloat(LimpaNumero('0'+Text)) > 0 then
      begin
        if Form1.ConfCusto = 'No' then
        begin
          if (StrToFloat(Text)/ibDataSet16QUANTIDADE.AsFloat) < ibDataSet4CUSTOCOMPR.AsFloat then
          begin
            ShowMessage('No  possvel efetuar vendas com o preo abaixo do custo');
            ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet4PRECO.AsFloat * ibDataSet16QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
          end else ibDataSet16TOTAL.AsFloat := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
        end else ibDataSet16TOTAL.AsFloat   := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
      end else
      begin
        ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet4PRECO.AsFloat * ibDataSet16QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
      end;
    end;
  except
  end;
  //
end;

procedure TForm7.ibDataSet15NewRecord(DataSet: TDataSet);
var
  sN, sNovoNumero : String;
begin
  //
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_NSU,1) from rdb$database');
  IBDataSet99.Open;
  sNSU := StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0);
  IBDataSet99.Close;
  //
  try
    //
    Form7.IBDataSet99.Close;
    Form7.IBDataSet99.SelectSQL.Clear;
    //
    // Notas fiscais de sada (vendas) srie 001
    // Notas fiscais de sada (vendas) srie 002
    // Notas fiscais de sada (vendas) srie XXX
    //
    if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then
    begin
      Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE1,1) from rdb$database');
    end else
    begin
      if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then
      begin
        Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE2,1) from rdb$database');
      end else
      begin
        if Form7.sTitulo = 'Notas fiscais de sada (vendas) com CPF srie 920' then
        begin
          Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE920,1) from rdb$database');
        end else
        begin
          Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE'+Right(Form7.sTitulo,3)+',1) from rdb$database');
        end;
      end;
    end;
    //
    Form7.IBDataSet99.Open;
    //
  except
    //
    on E: Exception do
    begin
      ShowMessage(E.Message);
    end
    //
  end;
  //
  // Notas fiscais de sada (vendas) srie 001
  // Notas fiscais de sada (vendas) srie 002
  // Notas fiscais de sada (vendas) srie XXX
  //
  //
  sNovoNumero := StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+Right(Form7.sTitulo,3);
  sN          := StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0);
  //
  if sN = '000000001' then
  begin
    //
    while Application.MessageBox(pChar(
    chr(10) +'Iniciar a numerao de '+ sN +' para a srie '+ Right(Form7.sTitulo,3) +'?'),
    'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION) <> idYes do
    begin
      try
        sN := StrZero(StrtoFloat(Form1.Small_InputForm('Sequncia da numerao','Informe a sequncia para iniciar a numerao da srie '+ Right(Form7.sTitulo,3) + ': ',sN)),9,0);
      except
        ShowMessage('Numerao invalida.');
        sN := '000000001';
      end;
    end;
    //
    //
    if Application.MessageBox(pChar('Voc tem certeza que quer iniciar a numerao de '+ sN +' para a srie '+Right(Form7.sTitulo,3)+'? Considere pedir ajuda ao seu contador.'),'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION) = idYes then
    begin
      sNovoNumero := sN+Right(Form7.sTitulo,3);
    end else
    begin
      sN := '000000001';
    end;
    //
//    if Right(Form7.sTitulo,3) = 'RPS' then
//    begin
//      if sN = '000000001' then
//      begin
//        sN := '090000001';
//      end;
//    end;
    //
    sNovoNumero := sN+Right(Form7.sTitulo,3);
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    //
    if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then
    begin
      Form1.ibQuery1.SQL.Add('set generator G_SERIE1 to '+SN+' ');
    end else
    begin
      if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then
      begin
        Form1.ibQuery1.SQL.Add('set generator G_SERIE2 to '+sN+' ');
      end else
      begin
        if Form7.sTitulo = 'Notas fiscais de sada (vendas) com CPF srie 920' then
        begin
          Form1.ibQuery1.SQL.Add('set generator G_SERIE920 to '+sN+' ');
        end else
        begin
          if Right(Form7.sTitulo,3) = 'RPS' then
          begin
            Form1.ibQuery1.SQL.Add('set generator G_SERIERPS to '+SN+' ');
          end else
          begin
            Form1.ibQuery1.SQL.Add('set generator G_SERIE'+Form1.sSerieEspecial+' to '+SN+' ');
          end;
        end;
      end;
    end;
    //
    //
    // ShowMessage(Form1.ibQuery1.TExt);
    //
    Form1.ibQuery1.ExecSQL;
    //
  end;
  //
  Form7.IBDataSet99.Close;
  //
  Form7.ibDataSet15.Edit;
  Form7.ibDataSet15REGISTRO.AsString   := sProximo;
  Form7.ibDataSet15NSU.AsString        := sNSU;
  Form7.ibDataSet15NSUD.AsDatetime     := Date;
  Form7.ibDataSet15NSUH.AsString       := TimeToStr(Time);
  Form7.ibDataSet15NUMERONF.AsString   := sNovoNumero;
  Form7.ibDataSet15EMITIDA.AsString    := 'J';
  Form7.ibDataSet15FRETE12.AsString    := '0';
  Form7.ibDataSet15ESPECIE.AsString    := Form1.ConfEspecie;
  Form7.ibDataSet15MARCA.AsString      := Form1.ConfMarca;
  Form7.ibDataSet15VOLUMES.AsFloat     := 1;
  Form7.ibDataSet15MERCADORIA.Value    := 0;
  Form7.ibDataSet15SERVICOS.Value      := 0; // Nova nota
  Form7.ibDataSet15FRETE.Value         := 0;
  Form7.ibDataSet15DESCONTO.Value      := 0;
  Form7.ibDataSet15SEGURO.Value        := 0;
  Form7.ibDataSet15IPI.Value           := 0;
  Form7.ibDataSet15DESPESAS.Value      := 0;
  Form7.ibDataSet15BASEICM.Value       := 0;
  Form7.ibDataSet15ISS.Value           := 0;
  Form7.ibDataSet15ICMS.Value          := 0;
  Form7.ibDataSet15EMISSAO.Value       := Date;
  Form7.ibDataSet15SAIDAD.Value        := Date;
  Form7.ibDataSet15SAIDAH.Value        := TimeToStr(Time);
  //
  if Right(Form7.sTitulo,3) = 'RPS' then
  begin
    Form7.ibDataSet15MODELO.Value        := 'SV';
  end;
  //
  Form7.ibDataSet15.Post;
  //
  if Form12.Visible then
    Form7.ibDataSet2.Append;
  //
end;

procedure TForm7.ibDataSet2MAESetText(Sender: TField; const Text: String);
begin
  //
  // Labels inteligentes
  //
  if Pos('$',Sender.DisplayLabel) <> 0 then
  begin
    Sender.AsString  := AllTrim(Format('%22.2n',[StrToFloat(LimpaNumeroDeixandoAvirgula('0'+Text))]));
  end else
  begin
    if Pos('DATA',UpperCase(Sender.DisplayLabel)) <> 0 then
    begin
      Sender.AsString := Copy(LimpaNumero(Text),1,2)+'/'+Copy(LimpaNumero(Text),3,2)+'/'+Copy(LimpaNumero(Text),5,4);
    end else
    begin
      Sender.AsString := Text;
    end;
  end;
  //
  if Form10.Visible then
  begin
    if (pos('<',Sender.AsString)<>0) and (pos('>',Sender.AsString)<>0) then
    begin
      ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.');
    end;
    //
    if Length(LimpaNumero(Sender.AsString))=9 then
    begin
      ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.');
    end;
  end;
  //
end;

procedure TForm7.Imprimirdocumento1Click(Sender: TObject);
begin
  //
  Form1.Image201Click(Sender);
  Form7.ibDataSet3.First;
  //
  while not Form7.ibDataSet3.Eof do
  begin
    //
    if form7.ibDataSet3NF.AsString = '' then
    begin
      Form12.Close;
      Form7.ibDataSet3.Next;
    end;
    //
  end;
  //
  Form1.Image201Click(Sender);
  Form1.Image201_Click(Sender);
  //
end;

procedure TForm7.Enviartorpedo1Click(Sender: TObject);
var
  //
  sMsg : String;
  //
begin
  //
  Form40.CheckBox1.Visible := False;
  Form40.MaskEdit1.Visible := False;
  Form40.Edit1.Visible     := False;
  Form40.Label1.Visible    := False;
  Form40.Label3.Visible    := False;
  Form40.Label4.Visible    := False;
  Form40.Caption           := 'Enviar WhatsApp';
  //
  Form40.OpenDialog1.FileName := '';
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<HISTORICO>');
  Form40.Memo2.Lines.Add('<PORTADOR>');
  Form40.Memo2.Lines.Add('<DOCUMENTO>');
  Form40.Memo2.Lines.Add('<EMISSAO>');
  Form40.Memo2.Lines.Add('<VENCIMENTO>');
  Form40.Memo2.Lines.Add('<VALOR_DUPL>');
  Form40.Memo2.Lines.Add('<VALOR_JURO>');
  Form40.Memo2.Lines.Add('<CODEBAR>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>');
  //
  Form40.ShowModal;
  //
  Form40.MaskEdit1.Visible := True;
  Form40.Edit1.Visible     := True;
  Form40.Label1.Visible    := True;
  Form40.Label4.Visible    := True;
  Form40.Label3.Visible    := True;
  Form40.Caption           := 'Enviar e-mail texto';
  //
  if Form1.Tag = 1 then
  begin
    //
    if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
    begin
      //
      sMsg := Form40.Memo1.Lines.Text;
      //
      // CLIENTES
      //
      sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
      sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
      sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
      sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
      sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
      sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
      sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
      sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
      sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
      sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
      sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
      sMsg := StrTran(sMsg,'<WHATSAPP>'           ,Form7.ibDataSet2.FieldByName('WHATSAPP'      ).AsString);
      sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
      sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
      sMsg := StrTran(sMsg,'<CONTATOS>'      ,Form7.ibDataSet2.FieldByName('CONTATOS' ).AsString);
      sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
      sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
      //
      sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
      //
      sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
      sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
      sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
      sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
      //
      sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
      sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
      sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
      sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
      sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
      sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
      sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
      //
      sMsg := StrTran(sMsg,' ','%20');
      sMsg := StrTran(sMsg,chr(10),'%0A');
      sMsg := StrTran(sMsg,chr(13),'');
      //
      ShellExecute( 0, 'Open', pChar('https://api.whatsapp.com/send?phone=55'+LimpaNumero(StrTran(ibDataSet2WHATSAPP.AsString,'0xx',''))+'&text='+sMSG),'','', SW_SHOW);
      //
    end;
  end;
  //
end;

procedure TForm7.ibDataSet16AfterDelete(DataSet: TDataSet);
begin
  if Form7.sModulo = 'OS' then
    TotalizaOS(True);
  AgendaCommit(True);
end;

procedure TForm7.DBGrid4DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  OldBkMode : Integer;
  xRect : tREct;
begin
  //
  if  Field.DataType <> ftFloat  then
  begin
    if Form7.sModulo = 'VENDA' then
    begin
      if ibDataSet7Vencimento.Value < date then
        DBGrid4.Canvas.Font.Color := clRed;
      if ibDataSet7Vencimento.Value = date then
        DBGrid4.Canvas.Font.Color := clBlue;
      if ibDataSet7Valor_Rece.Value <> 0 then
        DBGrid4.Canvas.Font.Color := clGreen;
      if ibDataSet7ATIVO.AsString='1' then
        DBGrid4.Canvas.Font.Color := clSilver;
    end;
    //
    dbGrid4.Canvas.FillRect(Rect);
    DbGrid4.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Field.AsString);
    //
  end;
  //
  if Field.Name = 'ibDataSet7VENCIMENTO' then
  begin
    dbGrid4.Canvas.Brush.Color := clWhite;
    dbGrid4.Canvas.Font := dbGrid4.Font;
    if (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 7) then
      dbGrid4.Canvas.Font.Color   := clRed
    else
      dbGrid4.Canvas.Font.Color   := clBlack;
    dbGrid4.Canvas.TextOut(Rect.Left+dbGrid4.Canvas.TextWidth('99/99/9999_'),Rect.Top+2,Copy(DiaDaSemana(Form7.ibDataSet7VENCIMENTO.AsDateTime),1,3) );
  end;
  //
  dbGrid4.Canvas.Pen.Color := clBlack;
  dbGrid4.Canvas.Brush.Color := Form7.Panel7.Color;
  //
  xRect.Left   := Rect.Left;
  xRect.Top    := -2;
  xRect.Right  := Rect.Right;
  xRect.Bottom := Rect.Bottom-Rect.Top + 2;
  dbGrid4.Canvas.FillRect(XrEct);
  //
  with dbGrid4.Canvas do
  begin
    OldBkMode := SetBkMode(Handle, TRANSPARENT);
    dbGrid4.Canvas.Font.Color := clblack;
    TextOut(Rect.Left+3,3,AllTrim(Field.DisplayLabel));
    dbGrid4.Canvas.Font.Color := clblack;
    SetBkMode(Handle, OldBkMode);
  end;
  //
end;

procedure TForm7.DBGrid4ColEnter(Sender: TObject);
begin
  dbGrid4.Repaint;
end;

procedure TForm7.ibDataSet35AfterPost(DataSet: TDataSet);
begin
  //
  if AllTrim(Form7.ibDataSet35DESCRICAO.AsString) = '' then
  begin
    if not Form7.ibDataSet35.Eof then Form7.ibDataSet35.Delete;
    Form7.ibDataSet35.Append;
    Form7.ibDataSet35.Last;
  end else
  begin
    //
    Form7.ibDataSet99.Close;
    Form7.ibDataSet99.SelectSQL.Clear;
    Form7.IBDataSet99.SelectSQL.Add('select CODIGO, DESCRICAO, PRECO, TIPO_ITEM from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet35DESCRICAO.AsString)+' '); // Ok
    Form7.ibDataSet99.Open;
    //
    Form7.ibDataSet35.Edit;
    if Form7.IBDataSet99.FieldByname('DESCRICAO').AsString = Form7.ibDataSet35DESCRICAO.AsString then
    begin
      if Form7.IBDataSet99.FieldByname('TIPO_ITEM').AsString = '09' then
      begin
        Form7.ibDataSet35CODIGO.AsString    := Form7.IBDataSet99.FieldByname('CODIGO').AsString;
        Form7.ibDataSet35DESCRICAO.AsString := Form7.IBDataSet99.FieldByname('DESCRICAO').AsString;
        //
        // TESTE
        //
        if Form7.ibDataSet35QUANTIDADE.AsFloat <= 0 then
          Form7.ibDataSet35QUANTIDADE.AsFloat := 1;
        if Form7.ibDataSet35UNITARIO.AsFloat   <= 0 then
          Form7.ibDataSet35UNITARIO.AsFloat   := Form7.IBDataSet99.FieldByname('PRECO').AsFloat;
        //
      end else
      begin
        ShowMEssage('O tipo do item deve ser "09 - Servio" na guia ICMS.');
        Form7.ibDataSet35CODIGO.AsString    := '';
        Form7.ibDataSet35DESCRICAO.AsString := '';
      end;
    end else
    begin
      ShowMEssage('Servio no cadastrado. (O tipo do item deve ser "09 - Servio" na guia ICMS)');
      Form7.ibDataSet35DESCRICAO.AsString := '';
    end;
    //
  end;
  //
  if Form7.sModulo = 'VENDA' then
    TotalizaServicos(True);
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet35AfterDelete(DataSet: TDataSet);
begin
  if Form7.sModulo = 'OS' then
    TotalizaOS(True);
  if Form7.sModulo = 'VENDA' then
    TotalizaServicos(True);
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet35TOTALChange(Sender: TField);
begin
  //
  if Form7.ibDataSet35QUANTIDADE.AsFloat > 0 then
  begin
    //
    if Format('%12.4n',[(Form7.ibDataSet35TOTAL.AsFloat)]) <> Format('%12.4n',[(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat)]) then
    begin
      //
      Form7.ibDataSet35.Edit;
      Form7.ibDataSet35TOTAL.AsFloat := Arredonda(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
      //
    end;
    //
    if Form7.sModulo = 'OS' then
      TotalizaOS(True);
    if Form7.sModulo = 'VENDA' then
      TotalizaServicos(True);
    //
  end;
  //
  //
end;

procedure TForm7.ibDataSet23AfterPost(DataSet: TDataSet);
begin
  //
  if Form7.sModulo <> 'NAO' then
  begin
    try
      //
      ibDataSet24.Edit;
      ibDataSet24MERCADORIA.AsFloat := 0;
      ibDataSet24ISS.AsFloat        := 0;
      ibDataSet24SERVICOS.AsFloat   := 0;
      //
      ibDataSet24ICMS.AsFloat       := 0;
      ibDataSet24BASEICM.AsFloat    := 0;
      ibDataSet24ICMSSUBSTI.AsFloat := 0;
      ibDataSet24BASESUBSTI.AsFloat := 0;
      ibDataSet24IPI.AsFloat        := 0;
      //
      Form7.ibDataSet101.DisableControls;
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSQL.Clear;
      Form7.ibDataSet101.SelectSQL.Add('select * from ITENS002 where NUMERONF='+QuotedStr(Form7.ibDAtaSet24NUMERONF.AsString)+' and FORNECEDOR='+QuotedStr(Form7.ibDataSet24FORNECEDOR.AsString)+' ');
      Form7.ibDataSet101.Open;
      //
      ibDataSet101.First;
      while not Form7.ibDataSet101.Eof do
      begin
        //
        // Ok
        //
        try
          Form7.ibDataSet24MERCADORIA.AsFloat := Form7.ibDataSet24MERCADORIA.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('TOTAL').AsFloat,2);
          Form7.ibDataSet24IPI.Value          := Form7.ibDataSet24IPI.AsFloat        +  Arredonda(Form7.ibDataSet101.FieldByname('VIPI').AsFloat,2);
          Form7.ibDataSet24BASEICM.AsFloat    := Form7.ibDataSet24BASEICM.AsFloat    +  Arredonda(Form7.ibDataSet101.FieldByname('VBC').AsFloat,2);
          Form7.ibDataSet24ICMS.AsFloat       := Form7.ibDataSet24ICMS.AsFloat       +  Arredonda(Form7.ibDataSet101.FieldByname('VICMS').AsFloat,2);
          Form7.ibDataSet24BASESUBSTI.AsFloat := Form7.ibDataSet24BASESUBSTI.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('VBCST').AsFloat,2);
          Form7.ibDataSet24ICMSSUBSTI.AsFloat := Form7.ibDataSet24ICMSSUBSTI.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('VICMSST').AsFloat,2);
        except end;
        //
        ibDataSet101.Next;
        //
      end;
      //
    except end;
    //
    AgendaCommit(True);
    //
  end;
  //
end;

procedure TForm7.ibDataSet23BeforeDelete(DataSet: TDataSet);
begin
  //
  Form1.rReserva := 0;
  //
  Form7.ibDataSet4.Close;                                                //
  Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');  //
  Form7.ibDataSet4.Open;
  //
  if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet23CODIGO.AsString) and (AllTrim(Form7.ibDataSet4CODIGO.AsString)<>'') then
  begin
    //
    // Grade
    //
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString) then
    begin
      try
        //
        // Grade // Quando deleta um item na compra
        //
        Form13.Button2.Enabled := False;
        Form7.sModulo := 'GRADE';
        Form13.Label1.Caption := 'Deletando um item da compra';
        Form13.ShowModal; // Quando deleta um item na compra
        Form7.sModulo := 'COMPRA';
        Form13.Button2.Enabled := True;
      except end;
    end;
    //////////////////////////
    // Controle de serie    //
    // Esta rotina cancela  //
    // um item na venda     //
    //////////////////////////
    if ibDataSet4.FieldByname('SERIE').Value = 1 then
    begin
      //
      ibDataSet30.Close;
      ibDataSet30.SelectSQL.Clear;
      ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
      ibDataSet30.Open;
      while not ibDataSet30.Eof do
      begin
        if Copy(ibDataSet30NFCOMPRA.AsString,1,6) = Copy(Form7.ibDataSet24NUMERONF.AsString,4,6) then
        begin
          ibDataSet30.Delete;
        end else ibDataSet30.Next;
      end;
    end;
  end;
  //
  if ibDataSet23QUANTIDADE.Asfloat > 0 then
  begin
    try
      ibDataSet23.Edit;
      ibDataSet23QUANTIDADE.Value := 0;
      ibDataSet23TOTAL.Value := 0;
      ibDataSet23.Post;
    except end;
  end;
  ibDataSet23AfterPost(DataSet);
  //
end;

procedure TForm7.ibDataSet23BeforePost(DataSet: TDataSet);
var
  sRegistro14 : String;
begin
  //
  try
    if Alltrim(Form7.ibDataSet23QUANTIDADE.AsString) <> '' then
    begin
      //
      //      Form7.ibDataSet23BASE.AsString := '100';       // 23 Before post 2
      //
      if Form7.ibDataSet23BASE.Value < 0.01 then
      begin
        //
        if Form7.ibDataSet14.Active then
        begin
          //
          if (Alltrim(Form7.ibDataSet23CFOP.AsString)<>Alltrim(Form7.ibDataSet14CFOP.AsString)) and (AllTrim(Form7.ibDataSet23CFOP.AsString) <> '') then
          begin
            //
            sRegistro14 := Form7.ibDataSet14REGISTRO.AsString;
            Form7.ibDataSet14.DisableControls;
            Form7.ibDataSet14.Locate('CFOP',Alltrim(Form7.ibDataSet23CFOP.AsString),[]);
            //
            if Alltrim(Form7.ibDataSet14CFOP.AsString) = Alltrim(Form7.ibDataSet23CFOP.AsString) then
            begin
              Form7.ibDataSet23.Edit;
              Form7.ibDataSet23BASE.Value := Form7.ibDataSet14BASE.AsFloat;       // 23 Before post 2
            end;
            //
            Form7.ibDataSet14.Locate('REGISTRO',sRegistro14,[]);
            Form7.ibDataSet14.EnableControls;
            //
          end;
        end;
      end;  
    end else
    begin
      Form7.ibDataSet23BASE.AsString := '';
    end;
  except
    // ShowMessage('Erro 20646');
  end;
  //
end;

procedure TForm7.ibDataSet23DESCRICAOChange(Sender: TField);
var
  I : Integer;
//  MeuBookMark: TBookmark;
  sCodigoAnterior : String;
  sSerial : string;
  //
  // Pis cofins da Operao
  //
  sCST_PIS_COFINS : String;
  rpPIS, rpCOFINS : Real;

begin
  //
  if (Form1.bFlag) and (Alltrim(ibDataSet23DESCRICAO.AsString) <> '') then
  begin
    //
// Erro do vdeo
    Form7.ibDataSet23.DisableControls;
    Form7.ibDataSet4.DisableControls;
    //
    // S procura se estiver diferente
    //
    if ibDataSet14.FieldByname('CSTPISCOFINS').AsString <> ibDataSet24OPERACAO.AsString then ibDataSet14.Locate('NOME',ibDataSet24OPERACAO.AsString,[]);
    //
    sCST_PIS_COFINS := ibDataSet14.FieldByname('CSTPISCOFINS').AsString;
    rpPIS           := ibDataSet14.FieldByname('PPIS').AsFloat;
    rpCOFINS        := ibDataSet14.FieldByname('PCOFINS').AsFloat;
    //
    if not (Form7.ibDataset23.State in ([dsEdit, dsInsert])) then Form7.ibDataset23.Edit;
    if ibDataSet23CFOP.AsString = '' then ibDataSet23CFOP.AsString := ibDataSet14CFOP.AsString;
    //
    Form1.bflag := False;
    //
    if (Form7.ibDataSet23DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.Value) then
    begin
      //
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.SelectSQL.Clear;
      Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE order by upper(DESCRICAO)');
      Form7.ibDataSet4.Open;
      Form7.ibDataSet4.First;
      Form7.ibDataSet4.EnableControls;
      Form7.ibDataSet4.First;
      {                      }
      { Procura por: cdigo  }
      {                      }
      if (length(Alltrim(ibDataSet23DESCRICAO.AsString)) <= 5) and (LimpaNumero(Alltrim(ibDataSet23DESCRICAO.AsString))<>'') then
      begin
        try
          if StrToInt(AllTrim(ibDataSet23DESCRICAO.AsString)) <> 0 then
            Form7.ibDataSet4.Locate('CODIGO',StrZero(StrToInt(AllTrim(ibDataSet23DESCRICAO.AsString)),5,0),[]);
        except end;
      end;
      //
      if Pos(Alltrim(ibDataSet23DESCRICAO.AsString),ibDataSet4CODIGO.AsString) = 0 then
      begin
        // Procura pela referencia //
        Form7.ibDataSet4.Locate('REFERENCIA',AllTrim(ibDataSet23DESCRICAO.AsString),[]);
        // Se o produto no foi encontrado //
        if Alltrim(ibDataSet23DESCRICAO.AsString) <> AllTrim(ibDataSet4REFERENCIA.AsString) then
        begin
          //
          // Procura pela descrico
          //
          Form7.ibDataSet99.Close;
          Form7.ibDataSet99.SelectSQL.Clear;
//          Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(AllTrim(ibDataSet23DESCRICAO.AsString))+'%')+' order by upper(DESCRICAO)');
          Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where upper(DESCRICAO)='+QuotedStr(UpperCase(AllTrim(ibDataSet23DESCRICAO.AsString)))+' order by upper(DESCRICAO)'); // Maa verde
          Form7.ibDataSet99.Open;
          Form7.ibDataSet99.First;
          //
//        if not Form7.ibDataSet4.Locate('DESCRICAO',ibDataset99.FieldByname('DESCRICAO').AsString,[]) then
          if not Form7.ibDataSet4.Locate('CODIGO',ibDataset99.FieldByname('CODIGO').AsString,[]) then
          begin
            Form7.ibDataSet4.Last;
//            ibDataSet23DESCRICAO.AsString := '';
//            Abort;
          end;
          //
        end;
      end;
    end;
    {                                           }
    {  Preenche os dados do arquivo ENTRADA.DBF }
    {  se o produto for encontrado              }
    {                                           }
    if not Form7.ibDataSet4.Eof then
    begin
      {                               }
      { Grava no arquivo ENTRADA.DBF: }
      {                               }
      { 1. Descrico do produto       }
      { 2. Valor unitrio             }
      { 3. Quantidade                 }
      { 4. Total                      }
      { 5. Situao tributria        }
      { 6. Percentual do IPI          }
      { 7. Peso                       }
      { 7. Cdigo                     }
      {                               }
      //
      Form7.ibDataSet23.Edit;
      //
      if AllTrim(Form7.ibDataSet23DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
      begin
        Form7.ibDataSet23CODIGO.AsString    := '';
      end;
      //
      if (AllTrim(ibDataSet23CODIGO.AsString) <> '') and (ibDataSet23CODIGO.AsString <> ibDataSet4CODIGO.AsString) then
      begin
        //
        sCodigoAnterior := ibDataSet4CODIGO.AsString;
        ibDataSet4.Locate('CODIGO',ibDataSet23CODIGO.AsString,[]);
        //
        Form1.rReserva := 0;
        //
        Form7.ibDataSet10.Close;
        Form7.ibDataSet10.SelectSQL.Clear;
        Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
        Form7.ibDataSet10.Open;
        Form7.ibDataSet10.First;
        //
        if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
        begin
          try
            // Deleta na compra
            Form7.sModulo := 'ESTOQUE';
            Form13.Button2.Enabled := False;
            Form13.Label1.Caption := 'Deleta na compra';
            Form13.ShowModal;  // Deleta na compra
            Form13.Button2.Enabled := True;
            Form7.sModulo := 'COMPRA';
          except end;
        end;
        //
//        ibDataSet4.IndexFieldNames := 'CODIGO';
        ibDataSet4.Locate('CODIGO',sCodigoAnterior,[]);
        //
      end;
//////////////////////////////////
      //
      Form7.ibDataSet23DESCRICAO.AsString := Form7.ibDataSet4DESCRICAO.AsString;
      //
      // So altera se for um produto novo //
      //
      if AllTrim(Form7.ibDataSet23CODIGO.AsString) = '' then
      begin
        //
        // se tem grade quantidade = zero
        //
        Form7.ibDataSet10.Close;
        Form7.ibDataSet10.SelectSQL.Clear;
        Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
        Form7.ibDataSet10.Open;
        Form7.ibDataSet10.First;
        //
        Form7.ibDataSet23.Edit;
        //
        if (Form7.ibDataSet4CODIGO.AsString <> Form7.ibDataSet10CODIGO.AsString) and (Form7.ibDataSet4.FieldByname('SERIE').Value <> 1) then
        begin
          Form7.ibDataSet23QUANTIDADE.AsFloat     := 1;
          Form7.ibDataSet23QTD_ORIGINAL.AsFloat   := 1;
        end;
        //
        // Form7.ibDataSet23UNITARIO_O.Asfloat   := 0;
        // Form7.ibDataSet23UNITARIO.Asfloat     := 0;
        //
        Form7.ibDataSet23UNITARIO.Asfloat       := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
        Form7.ibDataSet23UNITARIO_O.Asfloat     := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
        //
        Form7.ibDataSet23ST.AsString        := Form7.ibDataSet4ST.AsString;
        Form7.ibDataSet23ICM.AsFloat        := 0;
        Form7.ibDataSet23PESO.AsFloat       := Form7.ibDataSet4PESO.AsFloat;
        Form7.ibDataSet23MEDIDA.AsString    := Form7.ibDataSet4MEDIDA.AsString;
        Form7.ibDataSet23PESO.AsString      := Form7.ibDataSet4PESO.AsString;
        //
        if (AllTrim(Form7.ibDataSet23CST_ICMS.AsString)='') then
        begin
          if (AllTrim(Form7.ibDataSet23CST_ICMS.AsString)='') then if (AllTrim(Form7.ibDataSet14CST.AsString)<>'') then Form7.ibDataSet23CST_ICMS.AsString := Form7.ibDataSet14CST.AsString;
        end;
        if (AllTrim(Form7.ibDataSet23CST_ICMS.AsString)='') then
        begin
          if (AllTrim(Form7.ibDataSet4CST.AsString)<>'') then Form7.ibDataSet23CST_ICMS.AsString  := Form7.ibDataSet4CST.AsString;
        end;
        //
        // certo
        //
        //
      end;
      //
      if Alltrim(sCST_PIS_COFINS) <> '' then
      begin
        Form7.ibDataSet23CST_PIS_COFINS.AsString := sCST_PIS_COFINS;
        Form7.ibDataSet23ALIQ_PIS.AsFloat        := rpPIS;
        Form7.ibDataSet23ALIQ_COFINS.AsFloat     := rpCOFINS;
      end else
      begin
        Form7.ibDataSet23CST_PIS_COFINS.AsString   := Form7.ibDataSet4CST_PIS_COFINS_ENTRADA.AsString;     // CST do PIS no ICM
        Form7.ibDataSet23ALIQ_PIS.AsFloat          := Form7.ibDataSet4ALIQ_PIS_ENTRADA.AsFloat;
        Form7.ibDataSet23ALIQ_COFINS.AsFloat       := Form7.ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat;
      end;
      //
      Form7.ibDataSet23CODIGO.AsString           := Form7.ibDataSet4CODIGO.AsString;
      ///////////////////////
      // Controle de serie //
      ///////////////////////

      if (Form7.ibDataSet4.FieldByname('SERIE').Value = 1) and (Form7.ibDataSet23QUANTIDADE.AsFloat=0) then
      begin
        //
        sSerial := '99';
        ibDataSet23QUANTIDADE.AsFloat := 0;
        while AllTrim(sSerial) <> '' do
        begin
          //
          I := 0;
          //
          while I <> 6 do
          begin
            //
            sSerial := AllTrim(Form1.Small_InputForm('Compra de item','Nmero de srie:',''));
            //
            if sSerial <> '' then
            begin
              //
              ibDataSet100.Close;
              ibDataSet100.SelectSQL.Clear;
              ibDataSet100.SelectSQL.Add('select * from SERIE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' and SERIAL='+QuotedStr(sSerial)+' ');
              ibDataSet100.Open;
              //
              if ibDAtaSet100.FieldByName('SERIAL').AsString = sSerial then
              begin
                I := Application.MessageBox(pChar(
                                          chr(10) +'O nmero de srie: '+sSerial+' j est cadastrado no produto: '+
                                          chr(10)+Alltrim(ibDataSet4DESCRICAO.AsString)+' '+
                                          chr(10)+
                                          chr(10) +'Incluir novamente este nmero de srie?'+Chr(10)+
                                          chr(10)),
                                          'Ateno',mb_YesNo + mb_DefButton2 +  MB_ICONWARNING);
                if I <> 6 then sSerial := '';
              end else I := 6;
              //
            end else I := 6;
          end;
          //
          ibDataSet100.Close;
          //
          if sSerial <> '' then
          begin
            //
            ibDataSet30.Append;
            ibDataSet30CODIGO.AsString      := Form7.ibDataSet23CODIGO.AsString;
            ibDataSet30SERIAL.AsString      := sSerial;
            ibDataSet30NFCOMPRA.AsString    := Copy(Form7.ibDataSet24NUMERONF.AsString,4,6);
            ibDataSet23QUANTIDADE.AsFloat   := ibDataSet23QUANTIDADE.AsFloat + 1;
            ibDataSet23QTD_ORIGINAL.AsFloat := ibDataSet23QUANTIDADE.AsFloat;
            ibDataSet30.Post;
            //
            Form24.DbGrid1.Refresh;
            //
          end;
        end;
      end;
      //
      //  the end SERIE
      //

      //
      // Grade
      //
      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;
      //
      try
        //
//        if not Jatem(Form7.ibDataSet23,Form7.ibDataSet23DESCRICAO,False) then
        begin
          if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
          begin
            //
            // Quantiade na compra sempre 1
            //
            if (Form7.ibDataSet23QUANTIDADE.AsFloat = 0) then
            begin
              Form1.rReserva := 0;
              Form13.Label1.Caption := 'Quantidade na compra';
              Form13.ShowModal;  // Quantiade na compra sempre 1
            end;
          end;
          //
        end;
      except end;
      //
      if (Form7.ibDataSet23QUANTIDADE.AsFloat = 0) and (Form7.ibDataSet23DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString) then
      begin
        if Form7.ibDataSet4.FieldByname('SERIE').Value <> 1 then
        begin
          Form7.ibDataSet23.Edit;
          Form7.ibDataSet23QUANTIDADE.AsFloat := 1;
        end else
        begin
          Form7.ibDataSet23DESCRICAO.AsString := '';
          Form7.ibDataSet23QUANTIDADE.AsString := '';
          Form7.ibDataSet23UNITARIO.AsString := '';
          Form7.ibDataSet23TOTAL.AsString := '';
          Form7.ibDataSet23CFOP.AsString := '';
          Form7.ibDataSet23ICM.AsString := '';
          Form7.ibDataSet23CST_ICMS.AsString := '';
          Form7.ibDataSet23CODIGO.AsString := '';
          //
          Form24.DbGrid1.SelectedIndex := 6;
          //
        end;
      end;
      //
      {         }
      { the end }
      {         }
    end else
    begin
//      Form1.bflag := True;
      Form7.ibDataSet23.Edit;
//      Form7.ibDataSet23DESCRICAO.AsString := '';
      Form7.ibDataSet23QUANTIDADE.AsString := '';
      Form7.ibDataSet23UNITARIO.AsString := '';
      Form7.ibDataSet23TOTAL.AsString := '';
//      Form7.ibDataSet23.Append;
    end;
    //
//
// Erro do vdeo
    ibDataSet4.EnableControls;
    ibDataSet23.EnableControls;
    //
    Observacao2(False);
    //
  end;
  //
  //
end;

procedure TForm7.ibDataSet23DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  //
  if Limpanumero(Text) <> Text then
  begin
    //
    // Localiza pela descricao
    //
    Form7.ibDataSet4.DisableControls;
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.SelectSQL.Clear;
    Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(Text)+'%')+' order by upper(DESCRICAO)');
    Form7.ibDataSet4.Open;
    Form7.ibDataSet4.First;
    Form7.ibDataSet4.EnableControls;
    //
    //
  end;
  //
  ibDataSet23DESCRICAO.AsString := Text;
  //
end;

procedure TForm7.ibDataSet23QUANTIDADEChange(Sender: TField);
begin
  //
  // Quando altera a quantidade recalcula o valor
  // total, mas s quando o valor total  alterado
  //
  if (Form7.ibDataSet23QUANTIDADE.Value < 0) then
  begin
    ShowMessage('Valor invlido na quantidade.');
    Form7.ibDataSet23.Edit;
    Form7.ibDataSet23QUANTIDADE.Value := 0;
  end;
  if (Form7.ibDataSet23UNITARIO.Value < 0 ) then
  begin
    ShowMessage('Valor invlido na campo valor unitrio.');
    Form7.ibDataSet23.Edit;
    Form7.ibDataSet23UNITARIO.Value := 0;
  end;
  //
  if Form7.ibDataSet23QUANTIDADE.Value <> 0 then
  begin
//    if Arredonda(Form7.ibDataSet23TOTAL.Value,9) <> Arredonda(Form7.ibDataSet23QUANTIDADE.AsFloat * Form7.ibDataSet23UNITARIO.AsFloat,9) then
//    begin
//      Form7.ibDataSet23.Edit;
//      Form7.ibDataSet23TOTAL.Value := Arredonda(Form7.ibDataSet23QUANTIDADE.AsFloat * Form7.ibDataSet23UNITARIO.AsFloat,9);
//    end;
    //
    if Arredonda(Form7.ibDataSet23TOTAL.Value,StrToInt(Form1.ConfPreco)) <> Arredonda(Form7.ibDataSet23QUANTIDADE.AsFloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco)) then
    begin
      Form7.ibDataSet23.Edit;
      Form7.ibDataSet23TOTAL.Value := Arredonda(Form7.ibDataSet23QUANTIDADE.AsFloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));
    end;
    //
  end else
  begin
    if Form7.ibDataSet23TOTAL.Value <> 0 then
    begin
      Form7.ibDataSet23.Edit;
      Form7.ibDataSet23TOTAL.Value := 0;
      Form7.ibDataSet23UNITARIO.Value := 0;
    end;
  end;
  //
  // the end
  //
end;

procedure TForm7.ibDataSet23QUANTIDADESetText(Sender: TField;
  const Text: String);
begin
  //
  // Serie
  //
  if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
  begin
    Form7.ibDataSet23QUANTIDADE.AsString  := Form7.ibDataSet23QUANTIDADE.AsString;
    Form7.ibDataSet23QTD_ORIGINAL.AsString  := Form7.ibDataSet23QTD_ORIGINAL.AsString;
  end else
  begin
    //
    // Grade
    //
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
    begin
      Form1.rReserva := ibDataSet23QUANTIDADE.AsFloat;
    end else
    begin
      ibDataSet23QUANTIDADE.AsFloat   := StrToFloat(Text);
      ibDataSet23QTD_ORIGINAL.AsFloat := StrToFloat(Text);
    end;
  end;
  //
end;

procedure TForm7.ibDataSet23TOTALChange(Sender: TField);
begin
  {                                                   }
  { S altera o valor unitrio quando for necessrio  }
  {                                                   }
  if Form7.ibDataSet23QUANTIDADE.Value <> 0 then
  begin
    if (Form7.ibDataSet23UNITARIO.AsFloat - (Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat) > 0.001)
    or ((Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat) - Form7.ibDataSet23UNITARIO.AsFloat > 0.001) then
    begin
      Form7.ibDataSet23.Edit;
//      Form7.ibDataSet23UNITARIO.AsFloat    := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat,StrToInt(Form1.ConfPreco));
//      Form7.ibDataSet23UNITARIO_O.Asfloat  := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QTD_ORIGINAL.Asfloat,StrToInt(Form1.ConfPreco));
      Form7.ibDataSet23UNITARIO.AsFloat    := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat,4);
      Form7.ibDataSet23UNITARIO_O.Asfloat  := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QTD_ORIGINAL.Asfloat,4);
    end;
  end;
  //
end;

procedure TForm7.ibDataSet23IPIChange(Sender: TField);
begin
  if Sender.AsFloat >= 100 then Sender.AsFloat := 0;
end;

procedure TForm7.ibDataSet23CFOPSetText(Sender: TField; const Text: String);
begin
  if LimpaNumero(Text) <> '' then
  begin
    if
    //(Length(LimpaNumero(Text)) <> 4) or
      ((Copy(LimpaNumero(Text),1,1) <> '1')
        and (Copy(LimpaNumero(Text),1,1) <> '2')
          and (Copy(LimpaNumero(Text),1,1) <> '3'))
            then ShowMessage('CFOP Invlido')
              else ibDataSet23CFOP.AsString := LimpaNumero(Text);

  end else ibDataSet23CFOP.AsString := '';
end;

procedure TForm7.ibDataSet23NewRecord(DataSet: TDataSet);
begin
  //
  if Alltrim(ibDataSet24FORNECEDOR.AsString) <> '' then
  begin
    ibDataSet23REGISTRO.AsString   := sProximo;
    ibDataSet23SINCRONIA.AsFloat   := 0;                                    // Resolvi este problema as 4 da madrugada no NoteBook em casa
    ibDataSet23NUMERONF.AsString   := Form7.ibDataset24NUMERONF.AsString;
    ibDataSet23FORNECEDOR.AsString := ibDataSet24FORNECEDOR.AsString;
    //
//    ibDataSet23VICMS.AsFloat       := 0;
//    ibDataSet23VBC.AsFloat         := 0;
//    ibDataSet23VBCST.AsFloat       := 0;
//    ibDataSet23VICMSST.AsFloat     := 0;
//    ibDataSet23VIPI.AsFloat        := 0;
    //
//    ibDataSet23LISTA.AsFloat       := 0;
    //


  end else
  begin
    ShowMessage('Selecione um fornecedor.');
    //
    try
      if Form24.SMALL_DBEdit39.CanFocus then Form24.SMALL_DBEdit39.SetFocus;
    except end;
    //
    Abort;
  end;
  //
end;

procedure TForm7.ibDataSet24NewRecord(DataSet: TDataSet);
begin
  //
  sFornecedorAntigo := '';
  //
  Form7.ibDataSet24.DisableControls;
  Form7.ibDataSet23.DisableControls;
  Form7.ibDataSet8.DisableControls;
  //
  Form7.ibDataSet24REGISTRO.AsString  := sProximo;
  Form7.ibDataSet24MERCADORIA.Value   := 0;
  Form7.ibDataSet24SERVICOS.Value     := 0;
  Form7.ibDataSet24FRETE.Value        := 0;
  Form7.ibDataSet24SEGURO.Value       := 0;
  Form7.ibDataSet24IPI.Value          := 0;
  Form7.ibDataSet24DESPESAS.Value     := 0;
  Form7.ibDataSet24BASEICM.Value      := 0;
  Form7.ibDataSet24ISS.Value          := 0;
  Form7.ibDataSet24ICMS.Value         := 0;
  Form7.ibDataSet24EMISSAO.Value  := Date;
  Form7.ibDataSet24SAIDAD.Value   := Date;
  Form7.ibDataSet24SAIDAH.Value   := TimeToStr(Time);
  Form7.ibDataSet24NFEID.Value    := '0000000000000000000000000000000000000000000';
  //
  Form7.ibDataSet24.Post;
  Form7.ibDataSet24.Edit;
  //
end;

procedure TForm7.Label201MouseLeave(Sender: TObject);
begin
  if Form7.Label201.Font.Style <> [] then
  begin
    Form7.Image201.Picture    := Form7.Image201_R.Picture;
    Form7.Label201.Font.Style := [];
  end;
end;

procedure TForm7.Label201MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
  if Form7.Label201.Font.Style <> [fsBold] then
  begin
    Form7.Image201.Picture    := Form7.Image201_X.Picture;
    Form7.Label201.Font.Style := [fsBold];
  end;
end;

procedure TForm7.ibDataSet3AfterDelete(DataSet: TDataSet);
begin
  ibDataSet3.First;
  if ibDataSet3.Eof then ibDataSet3.Append;
  AgendaCommit(True);  
end;

procedure TForm7.ibDataSet35UNITARIOChange(Sender: TField);
begin
  //
  if Form7.ibDataSet35QUANTIDADE.AsFloat > 0 then
  begin
//    if Format('%12.4n',[(Form7.ibDataSet35UNITARIO.AsFloat)]) <> Format('%12.4n',[(Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.AsFloat)]) then
    if StrZero(Form7.ibDataSet35TOTAL.AsFloat,12,4) <> StrZero(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,12,4) then
    begin
      Form7.ibDataSet35.Edit;
//      Form7.ibDataSet35TOTAL.AsFloat := Arredonda(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
      Form7.ibDataSet35TOTAL.AsString := StrZero(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,12,4);
    end;
    if Form7.sModulo = 'OS' then
      TotalizaOS(True);
    if Form7.sModulo = 'VENDA' then
      TotalizaServicos(True);
  end;
  //
end;

procedure TForm7.ibDataSet15BeforeDelete(DataSet: TDataSet);
var
  bButton : Integer;
  ssModulo : String;
begin
  //
  // Antes de apagar
  //
  ssModulo := Form7.sModulo;
  //
  if (AllTrim(Form7.ibDataSet15STATUS.AsString) = '') or (Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada') or (Pos('denegado',LowerCase(Form7.ibDataSet15STATUS.AsString)) <> 0) or (AllTrim(Form7.ibDataSet15CLIENTE.AsString)='') then
  begin
    //
    if AllTrim(Form7.ibDataSet15STATUS.AsString) = '' then
    begin
      //
      if AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '' then
      begin
        bButton := Application.MessageBox(Pchar('Ateno:'+chr(10)
                                          + Chr(10)
                                          + 'Cancelar a NF ' + Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) + '?'
                                          + Chr(10))
                                          ,'Ateno',
                                                mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);

        Screen.Cursor := crHourGlass; // Cursor de Aguardo
      end else bButton := IDYES;
      //
    end else
    begin
      //
      if Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada' then bButton := IDYES else bButton := IDNO;
      //
      if (Pos('denegado',LowerCase(Form7.ibDataSet15STATUS.AsString)) <> 0) then
      begin
          ShowMessage(Pchar('Ateno:'+chr(10)
                                            + Chr(10)
                                            + 'Esta nota fiscal foi denegada (Por irregularidade fiscal). O nmero desta NF-e no podera ser reutilizado e o XML devera ser guardado pelo praso decadencial.'
                                            + Chr(10)));
          bButton := IDYES;
      end;
      //
    end;
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    if bButton = IDYES then
    begin
      //
      try
        //
        // Servicos
        //
        Screen.Cursor := crHourGlass; // Cursor de Aguardo
        //
        Form7.ibDataSet35.First;
        while not Form7.ibDataSet35.Eof do
        begin
          if AllTrim(Form7.ibDataSet35NUMEROOS.AsString) = '' then  Form7.ibDataSet35.Delete else
          begin
            Form7.ibDataSet35.Edit;
            Form7.ibDataSet35NUMERONF.AsString := '';
            Form7.ibDataSet35.Next;
          end;
        end;
        //
        // Produtos
        //
        if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet15OPERACAO.AsString then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
        Screen.Cursor := crHourGlass; // Cursor de Aguardo
        //
        Form7.ibDataSet16.DisableControls;
        Form7.ibDataSet16.First;
        while not Form7.ibDataSet16.Eof do // Disable
        begin
          //
          Screen.Cursor := crHourGlass; // Cursor de Aguardo
          //
          if AllTrim(Form7.ibDataSet16NUMEROOS.AsString) = '' then
          begin
            //
            try
              Form7.ibDataSet4.Close;
              Form7.ibDataSet4.Selectsql.Clear;
              Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
              Form7.ibDataSet4.Open;
            except end;
            //
            if (Form7.ibDataSet16DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString) and (AllTRim(Form7.ibDataSet4DESCRICAO.AsString)<>'') then
            begin
              try
                //
                // Quando nao baixa estoque tambem nao pode devolver
                //
                if (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) = 0) and (Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '929') then
                begin
                  Form7.ibDataSet4.Edit;
                  Form7.ibDataSet4QTD_ATUAL.AsFloat := Form7.ibDataSet4QTD_ATUAL.AsFloat + Form7.ibDataSet16SINCRONIA.AsFloat; // S retorna o SINCRONIA que realmente saiu do estoque. No caso de nf qua ainda no foi autorizada SINCRONIA  igual a 0 (zero)
                  Form7.ibDataSet4.Post;
                end;
              except end;
            end;
            //
            Form7.ibDataSet16.Delete
            //
          end else
          begin
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16NUMERONF.AsString := '';
            Form7.ibDataSet16.Next;
            //
            Form7.ibDataSet3.Close;
            Form7.ibDataSet3.SelectSQL.Clear;
            Form7.ibDataSet3.SelectSQL.Add('select * from OS where NUMERO='+QuotedStr(Form7.ibDataSet16NUMEROOS.AsString)+' ');
            Form7.ibDataSet3.Open;
            Form7.ibDataSet3.First;
            //
            while not Form7.ibDataSet3.Eof do
            begin
              Form7.ibDataSet3.Edit;
              Form7.ibDataSet3SITUACAO.AsString := 'Aberta';
              Form7.ibDataSet3.Post;
              Form7.ibDataSet3.Next;
            end;
            //
          end;
        end;
        //
        Form7.ibDataSet15.EnableControls;
        //
        // Receber
        //
        if sModulo = 'VENDA' then
        begin
          //
          Screen.Cursor := crHourGlass; // Cursor de Aguardo
          Form7.ibDataSet7.First;
          //
          if Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada' then
          begin
            //
            while not Form7.ibDataSet7.Eof do
            begin
              //
              if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
              begin
                if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
                begin
                  Form7.ibDataSet7.Edit;
                  Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
                end else
                begin
                  Form7.ibDataSet7.Edit;
                  Form7.ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
                end;
                //
                Form7.ibDataSet7ATIVO.AsString := '1';
                Form7.ibDataSet7.Post;
                Form7.ibDataSet7.Next;
                //
              end else
              begin
                Form7.ibDataSet7.Next;
              end;
              //
            end;
            //
          end else
          begin
            //
            while not Form7.ibDataSet7.Eof do
            begin
              if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
              begin
                Form7.ibDataSet7.Delete;
              end else
              begin
                Form7.ibDataSet7.Next;
              end;
            end;
            //
          end;
        end;
        //
        // CAIXA
        //
        ApagaIntegracaoComOCaixa(True);
        //
        //
        Form7.ibDataSet15.EnableControls;
        Form7.ibDataSet35.EnableControls;
        //
        if form21.Visible then form21.Close;
        //
      except end;
      //
      // Reaproveita o Nmero do NSU
      //
      IBDataSet99.Close;
      IBDataSet99.SelectSQL.Clear;
      IBDataSet99.SelectSQL.Add('select gen_id(G_NSU,0) from rdb$database');
      IBDataSet99.Open;
      //
      if (Form7.ibDataSet15NSU.AsString = StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0)) and (Form7.ibDataSet15STATUS.AsString = '') then
      begin
        //
        IBDataSet99.Close;
        IBDataSet99.SelectSQL.Clear;
        IBDataSet99.SelectSQL.Add('select gen_id(G_NSU,-1) from rdb$database');
        IBDataSet99.Open;
        //
        // Reaproveita o Nmero da NF
        //
        if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then
        begin
          Form7.IBDataSet99.Close;
          Form7.IBDataSet99.SelectSQL.Clear;
          Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE1,0) from rdb$database');
          Form7.IBDataSet99.Open;
          if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+'001' then
          begin
            IBDataSet99.Close;
            IBDataSet99.SelectSQL.Clear;
            IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE1,-1) from rdb$database');
            IBDataSet99.Open;
          end;
        end else
        begin
          //
          if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then
          begin
            Form7.IBDataSet99.Close;
            Form7.IBDataSet99.SelectSQL.Clear;
            Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE2,0) from rdb$database');
            Form7.IBDataSet99.Open;
            if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+'002' then
            begin
              IBDataSet99.Close;
              IBDataSet99.SelectSQL.Clear;
              IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE2,-1) from rdb$database');
              IBDataSet99.Open;
            end;
          end else
          begin
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) com CPF srie 920' then
            begin
              //
              // Notas fiscais de sada (vendas) srie 001
              // Notas fiscais de sada (vendas) srie 002
              // Notas fiscais de sada (vendas) srie XXX
              // Notas fiscais de sada (vendas) com CPF srie 920
              //
              Form7.IBDataSet99.Close;
              Form7.IBDataSet99.SelectSQL.Clear;
              Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE920,0) from rdb$database');
              Form7.IBDataSet99.Open;
              //
              if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+'920' then
              begin
                IBDataSet99.Close;
                IBDataSet99.SelectSQL.Clear;
                IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE920,-1) from rdb$database');
                IBDataSet99.Open;
              end;
              //
            end else
            begin
              //
              Form7.IBDataSet99.Close;
              Form7.IBDataSet99.SelectSQL.Clear;
              Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE'+Right(Form7.sTitulo,3)+',0) from rdb$database');
              Form7.IBDataSet99.Open;
              //
              if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+Right(Form7.sTitulo,3) then
              begin
                IBDataSet99.Close;
                IBDataSet99.SelectSQL.Clear;
                IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE'+Right(Form7.sTitulo,3)+',-1) from rdb$database');
                IBDataSet99.Open;
              end;
              //
            end;
          end;
        end;
      end else
      begin
        //
        Form7.ibDataSet15.Edit; Form7.ibDataSet15MERCADORIA.AsFloat    := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15DESCONTO.AsFloat      := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15SERVICOS.AsFloat      := 0; // Reaproveita a nota
        Form7.ibDataSet15.Edit; Form7.ibDataSet15ICMSSUBSTI.AsFloat    := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15DESPESAS.AsFloat      := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15FRETE.AsFloat         := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15SEGURO.AsFloat        := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15IPI.AsFloat           := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15ICMS.AsFloat          := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15BASEICM.AsFloat       := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15EMITIDA.AsString      := 'X';
        //
        Screen.Cursor := crDefault; // Cursor de Aguardo
        Form7.sModulo := ssModulo;
        Abort;
        //
      end;
    end else
    begin
      Screen.Cursor := crDefault; // Cursor de Aguardo
      Form7.sModulo := ssModulo;
      Abort;
    end;
  end else
  begin
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.sModulo := ssModulo;
    Abort;
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.sModulo := ssModulo;
  //
end;

procedure TForm7.ibDataSet24BeforeDelete(DataSet: TDataSet);
var
  bButton : Integer;
begin
  //
  if Form7.sModulo <> 'DUPLA' then
  begin
    //
    if AllTrim(Form7.ibDataSet24FORNECEDOR.AsString) <> '' then
    begin
      bButton := Application.MessageBox(Pchar('Ateno:'+chr(10)
                                        + Chr(10)
                                        + 'Apagar a NF de compra ' + Form7.ibDataSet24NUMERONF.AsString + '?'
                                        + Chr(10))
                                        ,'Ateno',
                                              mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    end else bButton := IDYES;
    //
    if bButton = IDYES then
    begin
      //
      Screen.Cursor := crHourGlass; // Cursor de Aguardo
      //
      if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet24OPERACAO.AsString then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet24OPERACAO.AsString,[]);
      //
      Form7.ibDataSet23.DisableControls;
      Form7.ibDataSet4.DisableControls;
      //
      Form7.ibDataSet23.First;
      while not Form7.ibDataSet23.Eof do
      begin
        //
        Form7.ibDataSet4.Close;
        Form7.ibDataSet4.Selectsql.Clear;
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet23DESCRICAO.AsString)+' ');
        Form7.ibDataSet4.Open;
        //
        if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet23CODIGO.AsString) and (Form7.ibDataSet4CODIGO.AsString <>'') then
        begin
          if (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) = 0) then
          begin
            Form7.ibDataSet4.Edit;
            Form7.ibDataSet4QTD_ATUAL.AsFloat := Form7.ibDataSet4QTD_ATUAL.AsFloat - Form7.ibDataSet23QUANTIDADE.AsFloat;
            Form7.ibDataSet4.Post;
          end;
        end;
        //
        Form7.ibDataSet23.Delete;
        Form7.ibDataSet23.First;
        //
      end;
      //
      Form7.ibDataSet23.EnableControls;
      Form7.ibDataSet4.EnableControls;
      //
      // Contas a PAGAR
      //
      if sModulo = 'COMPRA' then
      begin
        Form7.ibDataSet8.First;
        while not Form7.ibDataSet8.Eof do
        begin
          if Form7.ibDataSet8NUMERONF.AsString = Form7.ibDataSet24NUMERONF.AsString then
            Form7.ibDataSet8.Delete
          else
            Form7.ibDataSet8.Next;
        end;
      end;
      //
      Screen.Cursor := crDefault; // Cursor de Aguardo
      //
    end else Abort;
  end;
  //
end;

procedure TForm7.MenuItem183Click(Sender: TObject);
begin
  //
  ImprimirNF3.Caption := 'Imprimir NF nmero '+ Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet24FORNECEDOR.AsString;
  DevolverNF1.Caption := 'Devolver NF nmero '+ Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet24FORNECEDOR.AsString;
  //
  if FileExists(Form1.sAtual+'\CaulculoDoCustoDaUlimtaNota.txt') then ClculodoCustodaltimaNota1.Enabled := True else ClculodoCustodaltimaNota1.Enabled := False;
  //
end;

procedure TForm7.ImprimirNF3Click(Sender: TObject);
begin
  Unit24.ImprimeOuNaoANota2(True)
end;

procedure TForm7.Enviaremailparatodos1Click(Sender: TObject);
var
  //
  sRegistro, sX, sMsg, sEmail, sAssunto : String;
  bButton, I, II  : Integer;
  Mais1ini : tIniFile;
  //
  F : TExtfile;
  //
begin
  //
  Form40.OpenDialog1.FileName := '';
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<HISTORICO>');
  Form40.Memo2.Lines.Add('<PORTADOR>');
  Form40.Memo2.Lines.Add('<DOCUMENTO>');
  Form40.Memo2.Lines.Add('<EMISSAO>');
  Form40.Memo2.Lines.Add('<VENCIMENTO>');
  Form40.Memo2.Lines.Add('<VALOR_DUPL>');
  Form40.Memo2.Lines.Add('<CODEBAR>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>');
  //
  Form40.ShowModal;
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail para os clientes e' + chr(10) +
              Chr(10) + 'fornecedores filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    I := 0;
    //
    if bButton = IDYES then
    begin
      //
      sX := '';
      //
      Form7.ibDataSet2.First;
      //
      // Retorna onde parou
      //
      Mais1ini := TIniFile.Create('frente.ini');
      sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;
      //
      AssignFile(F,pchar(Form1.sAtual+'\E-MAIL.TXT'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      //
      if sRegistro <> 'FIM' then
      begin
        //
        bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        if bButton = IDYES then
        begin
          //
          while (not Form7.ibDataSet2.Eof) and (sRegistro <> Form7.ibDataSet2.FieldByName('REGISTRO').AsString) do
          begin
            //
            if VAlidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
          if sRegistro = Form7.ibDataSet2.FieldByName('REGISTRO').AsString then
          begin
            //
            if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
        end;
        //
      end;
      //
      Mais1ini.Free;
      //
      Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
      Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
      Form7.Panel1.Visible := True;
      //
      while not Form7.ibDataSet2.Eof do
      begin
        //
        if VAlidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
        begin
          //
          if I <> 0 then
          begin
            for II := 1 to 700 do
            begin
              //
              try
                Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
              except end;
              //
              Application.ProcessMessages;
              //
            end;
          end;
          //
          sASsunto := Form40.Edit1.Text;
          sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          //
          sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
          //
          sMsg := Form40.Memo1.Lines.Text;
          //
          // CLIENTES
          //
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
          sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
          sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
          sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
          sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
          sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
          sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
          sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
          sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
          sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
          sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
          sMsg := StrTran(sMsg,'<CONTATOS>'      ,Form7.ibDataSet2.FieldByName('CONTATOS' ).AsString);
          sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
          sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
          //
          sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
          //
          sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
          sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
          sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
          sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
          //
          sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
          sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
          sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
          sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
          sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
          sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
          sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
          //
          if (FileExists(pChar(Form40.OpenDialog1.FileName))) and (Alltrim(Form40.OpenDialog1.FileName)<>'') then
          begin
            EnviarEMail('',sEmail,'',sAssunto,sMSG,pChar(Form40.OpenDialog1.FileName), False);
          end else
          begin
            EnviarEMail('',sEmail,'',sAssunto,sMSG,'', False);
          end;
          //
          I := I + 1;
          //
          Mais1ini := TIniFile.Create('frente.ini');
          Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet2.FieldByName('REGISTRO').AsString));
          Mais1Ini.Free;
          //
          Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
          Form7.Panel1.Repaint;
          //
        end;
        //
        Form7.ibDataSet2.Next;
        //
      end;
      //
      try
        CloseFile(F); // Fecha o arquivo
      except end;
      //
    end;
    //
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
    try
      Mais1ini := TIniFile.Create('frente.ini');
      Mais1Ini.WriteString('mail','Registro','FIM');
      Mais1Ini.Free;
    except end;
  end;  
  //
end;

procedure TForm7.Emaildecobrana1Click(Sender: TObject);
var
  sSecoes :  TStrings;
  sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, II, J : Integer;
  PDF: TPrintPDF;
begin
  //
  Form40.Tag := 0;
  Form40.CheckBox1.Visible := True;
  Form40.ShowModal;
  //
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail de cobrana para os clientes' + chr(10) +
              Chr(10) + 'filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    try
      //
      if bButton = IDYES then
      begin
        //
        I := 0;
        Form7.ibDataSet7.First;
        //
        // Retorna onde parou
        //
        Mais1ini := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;
        //
        if sRegistro <> 'FIM' then
        begin
          //
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          if bButton = IDYES then
          begin
            //
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if Form7.ibDataSet7ATIVO.AsFloat <> 1 then
              begin
                if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
                begin
                  I := I + 1;
                end;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              //
              if Form7.ibDataSet7ATIVO.AsFloat <> 1 then
              begin
                if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
                begin
                  I := I + 1;
                end;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
          end;
          //
        end;
        //
        Mais1ini.Free;
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          try
            //
            // No relacionar os inativos
            //
            if Form7.ibDataSet7ATIVO.AsFloat <> 1 then
            begin
              //                                                                    //
              // Relaciona os clientes com o arquivo de vendas                     //
              //                                                                  //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                //
                sArquivo := '';
                //
                if Form7.sModulo = 'RECEBER' then
                begin
                  //
                  if Form40.CheckBox1.Checked then
                  begin
                    //
                    while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf') do
                    begin
                      DeleteFile(pchar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf'));
                      Sleep(1000);
                    end;
                    //
                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;
                    //
                    try
                      //
                      // Cria o PDF
                      //
                      // Sandro Silva 2022-12-22 sDocParaGerarPDF := Copy(AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'XXXXXXXXX',1,9);
                      PDF := TPrintPDF.Create(Self);
                      //
                      // Configuraes do documento
                      //
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;
                      //
                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf';// sFileCFeSAT;
                      //
                      // Inicia o documento pdf
                      //
                      PDF.BeginDoc;
                      //
                      while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                      begin
                        DeleteFile(pChar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg'));
                        Sleep(1000);
                      end;
                      //
                      Form1.sEscolhido := '';
                      //
                      try
                        //
                        sSecoes := TStringList.Create;
                        Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                        Mais1Ini.ReadSections(sSecoes);
                        //
                        // BANCO (001)
                        // REMESSA (001)
                        //
                        for J := 0 to (sSecoes.Count - 1) do
                        begin
                          if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                           or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                          and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                          or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                          begin
                            Form1.sEscolhido := sSecoes[J];
                          end;
                        end;
                        //
                        Mais1Ini.Free;
                        //
                      except
                      end;
                      //
//                      if AllTrim(Form1.sEscolhido) <> '' then
                      begin
                        //
                        Form25.Show; // Em Form7.Emaildecobrana1Click()
                        Form7.Repaint;
                        //
                        while not FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                        begin
                          Sleep(1000);
                        end;
                        //
                        PDF.DrawJPEG(0, 0, Form25.Image2.Picture.Bitmap);
                        //
                        // PDF.DrawBitmap(0,0, Form25.Image2.Picture.Bitmap);
                        //
                        PDF.EndDoc;
                        //
                        // Fecha o pdf
                        //
                        if FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf') then
                          sArquivo := Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf'
                        else
                          sArquivo := '';
                        //
                      end;
                      //
                    except
                    end;
                    //
                    Form25.Close;
                    Form7.Repaint;
                    //
                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                  end;
                end;
                //
                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                //
                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
                //
                sMsg := Form40.Memo1.Lines.Text;
                //
                // CLIENTES
                //
                if I <> 0 then
                begin
                  for II := 1 to 700 do
                  begin
                    //
                    try
                      Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
                    except
                    end;
                    //
                    Application.ProcessMessages;
                    //
                  end;
                end;
                //
                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                // CONTAS A RECEBER
                sMsg := StrTran(sMsg,'<HISTORICO>'     ,Form7.ibDataSet7.FieldByName('HISTORICO'     ).AsString);
                sMsg := StrTran(sMsg,'<PORTADOR>'      ,Form7.ibDataSet7.FieldByName('PORTADOR'      ).AsString);
                sMsg := StrTran(sMsg,'<DOCUMENTO>'     ,Form7.ibDataSet7.FieldByName('DOCUMENTO'     ).AsString);
                sMsg := StrTran(sMsg,'<EMISSAO>'       ,Form7.ibDataSet7.FieldByName('EMISSAO'       ).AsString);
                sMsg := StrTran(sMsg,'<VENCIMENTO>'    ,Form7.ibDataSet7.FieldByName('VENCIMENTO'    ).AsString);
                //
                sMsg := StrTran(sMsg,'<VALOR_DUPL>'    ,AllTrim(Format('%12.2n',[Form7.ibDataSet7.FieldByName('VALOR_DUPL').AsFloat])));
                sMsg := StrTran(sMsg,'<VALOR_JURO>'    ,AllTrim(Format('%12.2n',[Form7.ibDataSet7.FieldByName('VALOR_JURO').AsFloat])));
                sMsg := StrTran(sMsg,'<CODEBAR>'       ,AllTrim(Form7.ibDataSet7.FieldByName('CODEBAR').AsString));
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));

                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
                //
                EnviarEMail('',sEmail,'',sAssunto,sMSG,sArquivo, False);
                //
                I := I + 1;
                //
                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;
                //
                //
                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;
                //
                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
                Form7.Panel1.Repaint;
                //
              end;
            end;
            //
          except end;
          //
          Form7.ibDataSet7.Next;
          //
        end;
      end;
      //
    except
    end;
    //
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
  end;
  //
end;

procedure TForm7.NotasfiscaisdesadavendasSrie11Click(Sender: TObject);
var
  Mais1ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie 002';
  Form7.sRPS := 'N';
  //
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE 2');
  Mais1Ini.Free;
  //
end;

procedure TForm7.Rankingdedevedores1Click(Sender: TObject);
begin
  //
  sModuloAnterior                 := sModulo;
  Form38.ComboBox1.Visible        := True;
  Form38.Panel6.Visible           := True;
  Form7.sModulo                   := 'Ranking de devedores';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet1BeforeInsert(DataSet: TDataSet);
begin
  //
  // if (Form7.ibDataSet1ENTRADA.AsFloat + Form7.ibDataSet1SAIDA.AsFloat) = 0 then Abort;
  //
  try
    ibDataset99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CAIXA,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except abort end;
  //
  fValorAnterior := 0;
  //
end;

procedure TForm7.IBDataSet2NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet2REGISTRO.AsString   := sProximo;
  ibDataSet2CADASTRO.AsDateTime := Date;
  //
end;

procedure TForm7.DBGrid1ColEnter(Sender: TObject);
begin
  //
  ArquivoAberto.DisableControls;
  if ArquivoAberto.MoveBy(+1) = 1 then
    ArquivoAberto.MoveBy(-1)
  else if ArquivoAberto.MoveBy(-1) = -1 then
    ArquivoAberto.MoveBy(+1);
  ArquivoAberto.EnableControls;
  //
end;

procedure TForm7.ibDataSet15BeforeInsert(DataSet: TDataSet);
begin
  //
//  try if Alltrim(Form7.ibDataSet15CLIENTE.AsString) = '' then Form7.ibDataSet15.Delete; except end;
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_VENDAS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
  //
end;

procedure TForm7.ibDataSet16BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENS001,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet19BeforeInsert(DataSet: TDataSet);
begin
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_NOTA,1) from rdb$database');
  ibDataset99.Open;
  sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
  ibDataset99.Close;
end;

procedure TForm7.ibDataSet24BeforeInsert(DataSet: TDataSet);
begin
  //
  try if Alltrim(Form7.ibDataSet24FORNECEDOR.AsString) = '' then Form7.ibDataSet24.Delete; except end;
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_COMPRAS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
  //
end;

procedure TForm7.ibDataSet3BeforeInsert(DataSet: TDataSet);
begin
  //
  if (not Form7.ibDataSet3.Bof) then try if Alltrim(Form7.ibDataSet3CLIENTE.AsString) = '' then Form7.ibDataSet3.Delete; except end;
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_OS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
  //
end;

procedure TForm7.IBDataSet2BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CLIFOR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet7BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_RECEBER,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
  fValorAnterior := 0;
  //
end;

procedure TForm7.ibDataSet9BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_VENDEDOR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet12BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CONTAS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet14BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ICM,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet8BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_PAGAR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
  fValorAnterior := 0;
  //
end;

procedure TForm7.ibDataSet18BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_TRANSPOR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet29BeforeInsert(DataSet: TDataSet);
begin
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_CONVENIO,1) from rdb$database');
  ibDataset99.Open;
  sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
  ibDataset99.Close;
end;

procedure TForm7.ibDataSet5BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_MOVIMENT,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
  fValorAnterior := 0;
end;

procedure TForm7.ibDataSet23BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENS002,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet35BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENS003,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet30BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_SERIE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet27BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ALTERACA,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_HASH_ALTERACA,1) from rdb$database');
    ibDataset99.Open;
    //
  except Abort end;
  //
  HasHs('ALTERACA',True);
  //
end;

procedure TForm7.ibDataSet25BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_FLUXO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet26BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_RESUMO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet13BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_EMITENTE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet21BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_GRUPO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet10BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_GRADE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet28BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_COMPOSTO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet26NewRecord(DataSet: TDataSet);
begin
  Form7.ibDataSet26.FieldByName('REGISTRO').AsString := sProximo;
end;

procedure TForm7.ibDataSet27NewRecord(DataSet: TDataSet);
begin
  ibDataSet27REGISTRO.AsString  := sProximo;
end;

procedure TForm7.ibDataSet14NewRecord(DataSet: TDataSet);
begin
  ibDataSet14REGISTRO.AsString  := sProximo;
end;

procedure TForm7.ibDataSet18NewRecord(DataSet: TDataSet);
begin
  ibDataSet18REGISTRO.AsString := sProximo;

end;

procedure TForm7.ibDataSet29NewRecord(DataSet: TDataSet);
begin
  ibDataSet29REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet35NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet35.Edit;
  ibDataSet35REGISTRO.AsString := sProximo;
  if form7.sModulo = 'OS' then
  begin
    ibDataSet35NUMEROOS.AsString := Form7.ibDataset3NUMERO.AsString;
  end else
  begin
    ibDataSet35NUMERONF.AsString := Form7.ibDataset15NUMERONF.AsString;
  end;
  //
end;

procedure TForm7.ibDataSet19NewRecord(DataSet: TDataSet);
begin
  ibDataSet19REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet25NewRecord(DataSet: TDataSet);
begin
  ibDataSet25REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet13NewRecord(DataSet: TDataSet);
begin
  ibDataSet13REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet10NewRecord(DataSet: TDataSet);
begin
  ibDataSet10REGISTRO.AsString := sProximo;
end;

procedure TForm7.Panel7MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Hint := TabelaAberta.SelectSQL.Text;
end;

procedure TForm7.ibDataSet23UNITARIOChange(Sender: TField);
begin
  //                           //
  // Verifica se ta cadastrado //
  //                           //
  if Form7.ibDataSet23DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.AsString then
  begin
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.Selectsql.Clear;
    Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet23DESCRICAO.AsString)+' ');
    Form7.ibDataSet4.Open;
  end;
  //
  if Form7.ibDataSet23DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString then
  begin
    //
    // Quando altera a quantidade recalcula o valor
    // total, mas s quando o valor total  alterado
    //
    if Form7.ibDataSet23QUANTIDADE.AsFloat <> 0 then
    begin
      if Arredonda(Form7.ibDataSet23TOTAL.AsFloat,StrToInt(Form1.ConfPreco)) <> Arredonda(Form7.ibDataSet23QUANTIDADE.Asfloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco)) then
      begin
         Form7.ibDataSet23.Edit;
//       Form7.ibDataSet23TOTAL.AsFloat := Arredonda(Form7.ibDataSet23QUANTIDADE.Asfloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));
         Form7.ibDataSet23TOTAL.AsFloat := Arredonda(Form7.ibDataSet23QUANTIDADE.Asfloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));

      end;
    end;
  end;
  //
  // the end
  //
end;

procedure TForm7.ibDataSet3DESCONTOChange(Sender: TField);
begin
  TotalizaOS(True);
end;

procedure TForm7.ibDataSet21NewRecord(DataSet: TDataSet);
begin
  ibDataSet21REGISTRO.AsString  := sProximo;
end;

procedure TForm7.ibDataSet5BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet5ENTRADA_.AsFloat + (ibDataSet5SAIDA_.AsFloat*-1);
end;

procedure TForm7.Etiquetaparamaladireta1Click(Sender: TObject);
begin
  //
  Form15.CheckBox2.Checked := True;
  Form15.ShowModal;
  //
end;

procedure TForm7.ibDataset40AfterPost(DataSet: TDataSet);
begin
  if ibDataset40.FieldByName('DESCRICAO').AsString = '' then ibDataset40.Delete;
  AgendaCommit(True);
end;

procedure TForm7.MenuItem56Click(Sender: TObject);
var
  Mais1ini: tIniFile;
  I: Integer;
  NovItem1, NovItem2: TmenuItem;
  GeraEnvioItem1, GeraEnvioItem2: TmenuItem;
  bI: Boolean;
begin
  //
  Gerarboletoeenviodeemaildecobranatotalizadoporcliente1.Visible := Form1.DisponivelSomenteParaNos; // Sandro Silva 2022-12-26
  GerCNAB400.Visible := True;
  GerCNAB240.Visible := True;
  //
  ibDataSet11.First;
  //
  while not ibDataSet11.eof do
  begin
    //
    // Bloquetos
    //
    bI := True;
    for I := 0 to Bloquetos1.Count -1 do
    begin
      if Bloquetos1.Items[I].Caption = ibDataSet11NOME.Value then
        bI := False;
    end;

    if bI then
    begin
      //
      NovItem1 := TMenuItem.Create(Bloquetos1);
      NovItem1.Caption := ibDataSet11NOME.Value;
      Bloquetos1.Add(NovItem1);
      NovItem1.OnClick := Form1.EscolheOBloqueto;

      {Sandro Silva 2022-12-26 inicio}
      GeraEnvioItem1 := TMenuItem.Create(Bloquetos1);
      GeraEnvioItem1.Caption := ibDataSet11NOME.Value;
      Gerarboletoeenviodeemaildecobranatotalizadoporcliente1.Add(GeraEnvioItem1);
      GeraEnvioItem1.OnClick := EscolheOBancoParaGerarBoletoEEnviarEmail;
      {Sandro Silva 2022-12-26 fim}
      //
    end;
    //
    // CNAB 400
    //
    bI := True;
    for I := 0 to GerCNAB400.Count -1 do
    begin
      if GerCNAB400.Items[I].Caption = ibDataSet11NOME.Value then
        bI := False;
    end;

    if bI then
    begin
      //
      NovItem2 := TMenuItem.Create(GerCNAB400);
      NovItem2.Caption := ibDataSet11NOME.Value;
      GerCNAB400.Add(NovItem2);
      NovItem2.OnClick := Form1.EscolheCNAB400;
      //
    end;
    //
    // CNAB 240
    //
    bI := True;
    for I := 0 to GerCNAB240.Count -1 do
    begin
      if GerCNAB240.Items[I].Caption = ibDataSet11NOME.Value then
        bI := False;
    end;

    if bI then
    begin
      //
      NovItem2 := TMenuItem.Create(GerCNAB240);
      NovItem2.Caption := ibDataSet11NOME.Value;
      GerCNAB240.Add(NovItem2);
      NovItem2.OnClick := Form1.EscolheCNAB240;
      //
    end;
    ibDataSet11.Next;
    //
  end;
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
  for I := 0 to GerCNAB240.Count -1 do
  begin
    if Mais1Ini.ReadString(pChar('Boleto de cobrana do '+GerCNAB240.Items[I].Caption),'CNAB240','') = 'Sim' then
      GerCNAB240.Items[I].Enabled := True
    else
      GerCNAB240.Items[I].Enabled := False;
  end;

  for I := 0 to GerCNAB400.Count -1 do
  begin
    if Mais1Ini.ReadString(pChar('Boleto de cobrana do '+GerCNAB400.Items[I].Caption),'CNAB400','') = 'Sim' then
      GerCNAB400.Items[I].Enabled := True
    else
      GerCNAB400.Items[I].Enabled := False;
  end;
  Mais1ini.Free;
  //
  if Form7.ibDataSet7VALOR_RECE.AsFloat <> 0 then
    Imprimirrecibo2.Enabled := True
  else
    Imprimirrecibo2.Enabled := False;
  //
end;

procedure TForm7.ibDataSet1CalcFields(DataSet: TDataSet);
begin
  try
    if AllTrim(ibDataSet1.FieldByName('REGISTRO').AsString) <> '' then Form7.ibDataSet1.FieldByName('SALDO').AsFloat := fSaldoVetorCaixa[ibDataSet1.FieldByName('REGISTRO').AsInteger];
  except end;
end;

procedure TForm7.ibDataSet5CalcFields(DataSet: TDataSet);
begin
  if AllTrim(ibDataSet5.FieldByName('REGISTRO').AsString) <> '' then Form7.ibDataSet5.FieldByName('SALDO_BANC').AsFloat := fSaldoVetorBanco[ibDataSet5.FieldByName('REGISTRO').AsInteger];
//  ShowMessage(ibDataSet5.FieldByName('REGISTRO').AsString+chr(10)+floattoStr( fSaldoVetorBanco[ibDataSet5.FieldByName('REGISTRO').AsInteger]));
end;

procedure TForm7.Rankingdedevedores2Click(Sender: TObject);
begin
  //
  Form38.ComboBox1.Visible  := True;
  sModuloAnterior := sModulo;
  Form7.sWhere := '';
  Form38.Panel6.Visible := True;
  Form7.sModulo                   := 'Ranking de devedores';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet11BeforeInsert(DataSet: TDataSet);
begin
  //
  try if AllTrim(Form7.ibDataSet11NOME.AsString)='' then Form7.ibDataSet11.Delete; except end;
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_BANCOS,1) from rdb$database');
  ibDataset99.Open;
  sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
  ibDataset99.Close;
  //
end;

procedure TForm7.ibDataSet11NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet11REGISTRO.AsString := sProximo;
  //
end;

procedure TForm7.ibDataSet1DATAChange(Sender: TField);
begin
  if sModulo = 'CAIXA' then CalculaSaldo(True);
end;

procedure TForm7.ibDataSet5COMPENSChange(Sender: TField);
begin
  if Form7.sModulo = 'BANCOS' then SaldoBanco(True);
end;

procedure TForm7.IBDataSet2EditError(DataSet: TDataSet; E: EDatabaseError;
  var Action: TDataAction);
begin
//  ShowMessage('Este registro est sendo usado por outro usurio. '+Chr(10)+Chr(10)+Chr(10)+Chr(10)+Chr(10)+'Edit');
  Abort;
end;

procedure TForm7.IBDataSet2UpdateError(DataSet: TDataSet;
  E: EDatabaseError; UpdateKind: TUpdateKind;
  var UpdateAction: TIBUpdateAction);
begin
//  ShowMessage('Este registro est sendo usado por outro usurio. '+Chr(10)+Chr(10)+Chr(10)+Chr(10)+Chr(10)+'Update');
  /////////////////////////////////////////////// 2022-07-18
  try
    if (ibDataSet13CGC.AsString = CNPJ_SMALLSOFT) then
    begin
      // Comercial da Small est perdendo dados de contatos
      if AnsiContainsText(E.Message, 'deadlock') then
        Audita('CONTATOS','SMALL', Senhas.UsuarioPub, Form7.smodulo + ' Conflito L23774 ' + RightStr(E.Message, 50),0,0) // Ato, Modulo, Usurio, Histrico, Valor
      else
        Audita('CONTATOS','SMALL', Senhas.UsuarioPub, Form7.smodulo + ' ' + Copy('Salvar contatos L23776 ' + E.Message, 1, 80),0,0); // Ato, Modulo, Usurio, Histrico, Valor

    end;
  except
  end;
  ///////////////////////////////////////////////

  Abort;
end;

procedure TForm7.IBDataSet2DeleteError(DataSet: TDataSet;
  E: EDatabaseError; var Action: TDataAction);
begin
//  ShowMessage('Este registro est sendo usado por outro usurio. '+Chr(10)+Chr(10)+Chr(10)+Chr(10)+Chr(10)+'Delete');
  Abort;
end;

procedure TForm7.IBDataSet2PostError(DataSet: TDataSet; E: EDatabaseError;
  var Action: TDataAction);
begin
//  ShowMessage('Este registro est sendo usado por outro usurio. '+Chr(10)+Chr(10)+Chr(10)+Chr(10)+Chr(10)+'Post');
  DataSet.Cancel;
  Abort;
end;

procedure TForm7.MenuItem75Click(Sender: TObject);
begin
  Form20.ShowModal;
end;

procedure TForm7.este1Click(Sender: TObject);
var
  //
  sRegistro, sX, sMsg : String;
  bButton, I, J : Integer;
  Mais1ini : tIniFile;
  //
  F : TExtfile;
  //
begin
  //
  Form40.CheckBox1.Visible := False;
  Form40.MaskEdit1.Visible := False;
  Form40.Edit1.Visible     := False;
  Form40.Label1.Visible    := False;
  Form40.Label3.Visible    := False;
  Form40.Label4.Visible    := False;
  Form40.Caption           := 'Enviar WhatsApp';
  //
  Form40.OpenDialog1.FileName := '';
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<HISTORICO>');
  Form40.Memo2.Lines.Add('<PORTADOR>');
  Form40.Memo2.Lines.Add('<DOCUMENTO>');
  Form40.Memo2.Lines.Add('<EMISSAO>');
  Form40.Memo2.Lines.Add('<VENCIMENTO>');
  Form40.Memo2.Lines.Add('<VALOR_DUPL>');
  Form40.Memo2.Lines.Add('<VALOR_JURO>');
  Form40.Memo2.Lines.Add('<CODEBAR>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>');
  //
  Form40.ShowModal;
  //
  Form40.MaskEdit1.Visible := True;
  Form40.Edit1.Visible     := True;
  Form40.Label1.Visible    := True;
  Form40.Label4.Visible    := True;
  Form40.Label3.Visible    := True;
  Form40.Caption           := 'Enviar e-mail texto';
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este WhatsApp para os clientes e' + chr(10) +
              Chr(10) + 'fornecedores filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    I := 0;
    J := 0;
    //
    if bButton = IDYES then
    begin
      //
      sX := '';
      //
      Form7.ibDataSet2.First;
      //
      // Retorna onde parou
      //
      Mais1ini := TIniFile.Create('frente.ini');
      sRegistro := Mais1Ini.ReadString('whatsapp','registro','FIM') ;
      //
      AssignFile(F,pchar(Form1.sAtual+'\WHATSAPP.TXT'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      //
      if sRegistro <> 'FIM' then
      begin
        //
        bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        if bButton = IDYES then
        begin
          //
          while (not Form7.ibDataSet2.Eof) and (sRegistro <> Form7.ibDataSet2.FieldByName('REGISTRO').AsString) do
          begin
            //
            if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
          if sRegistro = Form7.ibDataSet2.FieldByName('REGISTRO').AsString then
          begin
            //
            if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
        end;
        //
      end;
      //
      Mais1ini.Free;
      //
      Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
      Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
      Form7.Panel1.Visible := True;
      //
      //
      while (not Form7.ibDataSet2.Eof) and (J < 20) do
      begin
        //
        if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
        begin
          //
          Application.ProcessMessages;
          //
          sMsg := Form40.Memo1.Lines.Text;
          //
          // CLIENTES
          //
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
          sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
          sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
          sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
          sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
          sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
          sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
          sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
          sMsg := StrTran(sMsg,'<WHATSAPP>'           ,Form7.ibDataSet2.FieldByName('WHATSAPP'      ).AsString);
          sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
          sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
          sMsg := StrTran(sMsg,'<CONTATOS>'      ,Form7.ibDataSet2.FieldByName('CONTATOS' ).AsString);
          sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
          sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
          //
          sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
          //
          sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
          sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
          sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
          sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
          //
          sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
          sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
          sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
          sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
          sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
          sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
          sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
          //
          sMsg := StrTran(sMsg,' ','%20');
          sMsg := StrTran(sMsg,chr(10),'%0A');
          sMsg := StrTran(sMsg,chr(13),'');
          //
          ShellExecute( 0, 'Open', pChar('https://api.whatsapp.com/send?phone=55'+LimpaNumero(StrTran(ibDataSet2WHATSAPP.AsString,'0xx',''))+'&text='+sMSG),'','', SW_SHOW);
          //
          J := J + 1;
          I := I + 1;
          //
          Mais1ini := TIniFile.Create('frente.ini');
          Mais1Ini.WriteString('whatsapp','Registro',pchar(Form7.ibDataSet2.FieldByName('REGISTRO').AsString));
          Mais1Ini.Free;
          //
          Form7.Panel1.Caption := AllTrim(IntToStr(I))+' WhatsApps enviados.';
          Form7.Panel1.Repaint;
          //
        end;
        //
        Form7.ibDataSet2.Next;
        //
      end;
      //
      try
        CloseFile(F); // Fecha o arquivo
      except end;
      //
    end;
    //
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
    if J >= 20 then
    begin
      ShowMessage('Mximo de 20 mensagens pelo WhatsApp. Se continuar do registro que parou poder mandar mais 20.');
    end else
    begin
      try
        Mais1ini := TIniFile.Create('frente.ini');
        Mais1Ini.WriteString('whatsapp','Registro','FIM');
        Mais1Ini.Free;
      except end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet11BeforePost(DataSet: TDataSet);
begin
  //
  if (AllTrim(ibDataSet11NOME.AsString) <> '') and (AllTrim(ibDataSet11PLANO.AsString) = '') then
  begin
    //
    ibDataSet12.Close;
    ibDataSet12.SelectSql.Clear;
    ibDataSet12.SelectSQL.Add('select * from CONTAS where SUBSTRING(CONTA FROM 1 FOR 1)='+QuotedStr('5')+'order by CONTA');
    ibDataSet12.Open;
    ibDataSet12.Last;
    //
    if LimpaNumero(Right(ibDataSet12CONTA.AsString,2)) <> '' then
    begin
      ibDataSet11.Edit;
      ibDataSet11PLANO.AsString := '510'+StrZero(StrToInt(LimpaNumero(Right(ibDataSet12CONTA.AsString,2)))+1,2,0);
    end;
    //
    ibDataSet12.Append;
    ibDataSet12CONTA.AsString := ibDataSet11PLANO.AsString;
    ibDataSet12NOME.AsString := ibDataSet11NOME.AsString;
    ibDataSet12.Post;
    //
  end;
  //
end;

procedure TForm7.Gerarnotafiscalsrie11Click(Sender: TObject);
begin
  //
  // Gera a nota fiscal
  //
  if Form1.bNotaVendaLiberada then
  begin
    //
    if Form7.ibDataSet3SITUACAO.AsString <> 'Fechada' then
    begin
      //
      Form41.MaskEdit1.Text := Form7.ibDataSet3NUMERO.AsString;
      Form7.Close;
      Form7.Vendas_1Click(Sender);                        // Nota fiscal srie 1
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.ImportarOS2Click(Sender);                    // Importa OS
      //
    end;
  end else
  begin
    ShowMessage('Emisso de NF no liberada para este usurio.');
  end;
  //
end;

procedure TForm7.Gerarnotafiscalsrie21Click(Sender: TObject);
begin
  //
  // Gera a nota fiscal
  //
  if Form1.bNotaVendaLiberada then
  begin
    //
    if Form7.ibDataSet3SITUACAO.AsString <> 'Fechada' then
    begin
      //
      Form41.MaskEdit1.Text := Form7.ibDataSet3NUMERO.AsString;
      Form7.NotasfiscaisdesadavendasSrie11Click(Sender);  // Nota fiscal srie 002
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.ImportarOS2Click(Sender);                    // Importa OS
      //
    end;
    //
  end else
  begin
    ShowMessage('Emisso de NF no liberada para este usurio.');
  end;
  //
end;

procedure TForm7.Relatriodecorrelao1Click(Sender: TObject);
var
  F : TextFile;
begin
  //
  DeleteFile(pChar(Form1.sAtual+'\CORRELACAO.TXT'));   // Apaga o arquivo anterior
  AssignFile(F,pchar(Form1.sAtual+'\CORRELACAO.TXT'));
  //
  Rewrite(F);           // Abre para gravao
  Writeln(F,'         RELATRIO DE CORRELAO         ');
  Writeln(F,'');
  Writeln(F,'NSU        NF/SERIE DATA       HORA     VALOR TOTAL ');
  Writeln(F,'---------- -------- ---------- -------- -------------');
  //
  ibDataSet15.DisableControls;
  ibDataSet15.Close;
  ibDataSet15.SelectSQL.Clear;
  ibDataSet15.SelectSQL.Add('select * from VENDAS where EMITIDA=''S'' order by NSU');
  ibDataSet15.Open;
  //
  ibDataSet15.First;
  while not ibDataSet15.Eof do
  begin
    try
      Writeln(F,ibDataSet15NSU.AsString+' '+copy(ibDataSet15NUMERONF.AsString,1,9)+'/'+copy(ibDataSet15NUMERONF.AsString,10,3)+' '+DateToStr(ibDataSet15NSUD.AsDateTime)+' '+TimeToStr(ibDataSet15NSUH.AsDateTime)+' '+' '+Format('%12.2n',[ibDataSet15TOTAL.AsFloat]));
    except end;
    ibDataSet15.Next;
  end;
  //
  Writeln(F,'');
  Writeln(F,'');
  Writeln(F,'                   PRODUTOS COM ESTOQUE NEGATIVO                    ');
  Writeln(F,'');
  Writeln(F,'CODIGO        DESCRICO                                QUANTIDADE');
  Writeln(F,'------------- ---------------------------------------- -------------');
  //
  ibDataSet4.First;
  while not ibDataSet4.Eof do
  begin
    try
      if ibDataSet4QTD_ATUAL.AsFloat < 0 then Writeln(F,ibDataSet4CODIGO.AsString+'         '+Copy(ibDataSet4DESCRICAO.AsString+Replicate(' ',40),1,40)+' '+Format('%14.2n',[ibDataSet4QTD_ATUAL.AsFloat]));
    except end;
    ibDataSet4.Next;
  end;
  //
  Writeln(F,'');
  Writeln(F,'');
  Writeln(F,'MOTIVO REINICIO: No houve reinicio de NSU.');
  //
  CloseFile(F);  // Fecha o arquivo
  //
  Form7.Close;
  Form7.Show;
  //
  if FileExists(Form1.sAtual+'\CORRELACAO.TXT') then ShellExecute( 0, 'Open','notepad.exe',PChar('CORRELACAO.TXT'), '', SW_SHOW);
  //
end;

procedure TForm7.Sosclientescomcontasatrasadas1Click(Sender: TObject);
begin
  //
  //sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)<>0'; // se mudar aqui mudar o traduz sql (Inadimplante)
  //2022-07-19 Estava considerando as contas inativas como em atraso. Alfredo precisa enviar cobranas apenas para quem realmente tem conta em atraso
  sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE and COALESCE(RECEBER.ATIVO, 0) <> 1)<>0 '; // se mudar aqui mudar o traduz sql (Inadimplante)
  //
  Form7.Close;
  Form7.Show;
  //
end;

procedure TForm7.Sosclientescomsuascontasemdia1Click(Sender: TObject);
begin
  //
  sWhere := ' where (select Coalesce(sum(VALOR_DUPL),0) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)=0'; // se mudar aqui mudar o traduz sql (Inadimplante)
  Form7.Close;
  Form7.Show;
  //
end;

procedure TForm7.Sosclientescomcontasareceber1Click(Sender: TObject);
begin
  //
  //sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0)<>0'; // se mudar aqui mudar o traduz sql (Contas a receber) Mauricio Parizotto 2023-02-28 
  sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and COALESCE(RECEBER.ATIVO, 0) <> 1 )<>0'; // se mudar aqui mudar o traduz sql (Contas a receber)
  Form7.Close;
  Form7.Show;
  //
end;

procedure TForm7.ibDataSet4INDEXADORChange(Sender: TField);
begin
  if ibDataSet4INDEXADOR.Asfloat < 0 then ibDataSet4INDEXADOR.Asfloat := 0;
end;

procedure TForm7.ibDataSet4CUSTOMEDIOChange(Sender: TField);
begin
  if ibDataSet4CUSTOMEDIO.Asfloat < 0 then ibDataSet4CUSTOMEDIO.Asfloat := 0;
end;

procedure TForm7.ibDataSet24DESCONTOChange(Sender: TField);
begin
  Form7.ibDataSet24MERCADORIAChange(Sender);
end;

procedure TForm7.IBDataSet119BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CONFOS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.IBDataSet119NewRecord(DataSet: TDataSet);
begin
  ibDataSet119REGISTRO.AsString := sProximo;
end;

procedure TForm7.FloatField3SetText(Sender: TField; const Text: String);
var
  I : Integer;
begin
  I := Application.MessageBox('Este campo normalmente no deve ser alterado. Tem certeza que quer alterar este campo?', 'Ateno', mb_OKCancel + mb_DefButton1);
  if I = IDOK then
  begin
    ibDataSet19ELEMENTO.AsString := TExt;
  end else
  begin
    ibDataSet19ELEMENTO.AsString := ibDataSet19ELEMENTO.AsString;
  end;
end;

procedure TForm7.ArquivotextoNotaFiscalPaulista1Click(Sender: TObject);
begin
  //
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'SP' then if FileExists(Form1.sAtual+'\sintegra.exe') then ShellExecute( 0, 'Open', 'sintegra.exe', 'PAULISTA', '', SW_SHOW) else ShowMessage('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.');
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'AL' then if FileExists(Form1.sAtual+'\sintegra.exe') then ShellExecute( 0, 'Open', 'sintegra.exe', 'ALAGOANA', '', SW_SHOW) else ShowMessage('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.');
  //
end;

procedure TForm7.ibDataSet4BeforeInsert(DataSet: TDataSet);
begin
  //
  try
//    if Alltrim(Form7.ibDataSet4DESCRICAO.AsString)='' then Form7.ibDataSet4.Delete;
  except end;
  //
  try
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ESTOQUE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_HASH_ESTOQUE,1) from rdb$database');
    ibDataset99.Open;
    //
  except end;
  //
end;

procedure TForm7.ImprimirtodasasOSfiltradas1Click(Sender: TObject);
var
  I : Integer;
begin
  //
  I := Application.MessageBox(pChar(
                            chr(10) +'Quer realmente imprimir todas as OS filtradas?'
                            +chr(10)+
                            'Imprimir agora?'),
                            'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
  if I = 6 then
  begin
    //
    Form7.ibDataSet3.First;
    while not Form7.ibDataSet3.Eof do
    begin
      Form7.ImprimirOrdemdeServio1Click(Sender);
      Form7.ibDataSet3.Next;
    end;
    //
  end;
  //
end;

procedure TForm7.ibDataSet3SITUACAOSetText(Sender: TField;
  const Text: String);
begin
//  if UpperCase(AllTrim(ibDataSet3SITUACAO.AsString)) = 'FECHADA' then ibDataSet3SITUACAO.AsString := 'Fechada' else ibDataSet3SITUACAO.AsString := Text;
end;

procedure TForm7.ibDataSet11AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  //
  // NOME DO BANCO
  //
  if (sNomeAnterior <> ibDataSet11NOME.AsString) and (sNomeAnterior <> '')  and (sNumeroAnterior = ibDataSet11REGISTRO.AsString) then
  begin
    sNomeNovo  := ibDataSet11NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // MOVIMENTO
    //
    Form7.ibDataSet5.Close;
    Form7.ibDataSet5.SelectSQL.Clear;
    Form7.ibDataSet5.SelectSQL.Add('update MOVIMENT set NOME='+QuotedStr(sNomeNovo)+' where upper(NOME)='+QuotedStr(UpperCase(sNomeVolta))+'');
    Form7.ibDataSet5.Open;
  end;
  //
  AgendaCommit(True);
  //
end;
  
procedure TForm7.ibDataSet11BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de    }
  { alterar o nome. Se o nome for alterado deve ser  }
  { atualizado o arquivo VENDAS e o arquivo ALTERACA }
  sNumeroAnterior := ibDataSet11REGISTRO.AsString;
  sNomeAnterior   := ibDataSet11NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.Notasfiscaiscanceladas1Click(Sender: TObject);
begin
  //
  sWhere := sWhere + ' and EMITIDA='+QuotedStr('X');
  Form7.Close;
  Form7.Show;
  //
  Notasfiscaiscanceladas1.Checked := True;
  Notasfiscaisabertas1.Checked    := False;
  //
end;

procedure TForm7.Notasfiscaisabertas1Click(Sender: TObject);
begin
  //
  sWhere := sWhere + ' and EMITIDA<>'+QuotedStr('S')+' and EMITIDA<>'+QuotedStr('X');
  Form7.Close;
  Form7.Show;
  //
  Notasfiscaiscanceladas1.Checked := False;
  Notasfiscaisabertas1.Checked    := True;
  //
end;

procedure TForm7.odas4Click(Sender: TObject);
begin
  //
  sWhere := '';
  Form7.Close;
  Form7.Show;
  //
  Notasfiscaiscanceladas1.Checked := True;
  Notasfiscaisabertas1.Checked    := False;
  //
end;

procedure TForm7.Exportar1Click(Sender: TObject);
begin
  ExportaNF(True);
end;

procedure TForm7.ImportarOS1Click(Sender: TObject);
begin
  //
  AgendaCommit(True);
  Form7.Close;
  Form7.Show;
  //
  Form7.Image101Click(Sender);
  Form12.ImportarOS2Click(Sender);
  //
end;

procedure TForm7.ImportarCupomFiscal1Click(Sender: TObject);
begin
  //
  AgendaCommit(True);
  Form7.Close;
  Form7.Show;
  //
  Form7.Image101Click(Sender);
  Form12.Emitirnotafiscaldevendasnobalco1Click(Sender);
  //
end;

procedure TForm7.ImportarOramento1Click(Sender: TObject);
begin
  //
  AgendaCommit(True);
  //
  Form7.Close;
  Form7.Show;
  //
  Form7.ibDataSet97.Close;
  Form7.ibDataSet97.Selectsql.Clear;
  Form7.ibDataSet97.Selectsql.Add('select PEDIDO as "Oramento", DATA as "Data", CLIFOR as "Cliente", VENDEDOR as "Vendedor", sum(TOTAL) as "Total", NUMERONF as "Doc. Fiscal", PEDIDO as "Registro" from ORCAMENT group by PEDIDO, DATA, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO');  //
  Form7.ibDataSet97.Open;
  Form7.ibDataSet97.EnableControls;
  //
  //
  Form7.Image101Click(Sender);
  Form12.Importaroramentos1Click(Sender);
  //
end;

procedure TForm7.ImportarNotaFiscal1Click(Sender: TObject);
begin
  ImportaNF(True,'');
end;

procedure TForm7.IBDataSet2CIDADESetText(Sender: TField;
  const Text: String);
begin
  //
  if ibDataSet39NOME.AsString <> '' then
  begin
    //
    if Length(AllTrim(Form7.IBDataSet2ESTADO.AsString)) <> 2 then
    begin
      Form7.IBDataSet39.Close;
      Form7.IBDataSet39.SelectSQL.Clear;
      Form7.IBDataSet39.SelectSQL.Add('select * from MUNICIPIOS order by NOME'); // Procura em todo o Pais o estado est em branco
      Form7.IBDataSet39.Open;
    end else
    begin
      Form7.IBDataSet39.Close;
      Form7.IBDataSet39.SelectSQL.Clear;
      Form7.IBDataSet39.SelectSQL.Add('select * from MUNICIPIOS where UF='+QuotedStr(Form7.IBDataSet2ESTADO.AsString)+ '  order by NOME'); // Procura dentro do estado
      Form7.IBDataSet39.Open;
    end;
    //
    ibDataSet39.Locate('NOME',AllTrim(Text),[loCaseInsensitive, loPartialKey]);
    //
    if AllTrim(Text) = '' then
      ibDataSet2CIDADE.AsString := Text
    else if Pos(AnsiUpperCase(AllTrim(Text)),AnsiUpperCase(ibDataSet39NOME.AsString)) <> 0 then
      ibDataSet2CIDADE.AsString := ibDataSet39NOME.AsString
    else
      ShowMessage('Municpio invlido.');
  end
  else
    ibDataSet2CIDADE.AsString := Text;
  //
end;

procedure TForm7.Movimentaodositemskardex1Click(Sender: TObject);
begin
  Form7.sModulo := 'KARDEX';
  Form10.Image203Click(Sender);
  Form7.sModulo := 'ESTOQUE';
end;

procedure TForm7.ibDataSet30SERIALSetText(Sender: TField;
  const Text: String);
begin
  if Form10.Visible then
  begin
    if Valida_Campo('SERIE',Text,'SERIAL','Este nmero de srie j foi cadastrado.') then
    ibDataSet30SERIAL.AsString := Text;
  end;  
end;

procedure TForm7.Vendasporvendedor1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de vendas por vendedor';
  //
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet15AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
  //
  Form1.ibQuery2.Close;
  Form1.ibQuery2.SQL.Clear;
  Form1.ibQuery2.SQL.Add('set generator G_GRAFICO_VENDAS to 0');
  Form1.ibQuery2.ExecSQL;
  //
end;

procedure TForm7.ibDataSet24AfterPost(DataSet: TDataSet);
begin
  //
  if AllTrim(sFornecedorAntigo) <> '' then
  begin
    if sFornecedorAntigo <> Form7.IbDataSet24FORNECEDOR.AsString then
    begin
      //
      Screen.Cursor := crHourGlass; // Cursor de Aguardo
      //
      Form7.IBQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update ITENS002 set FORNECEDOR='+QuotedStr(Form7.IbDataSet24FORNECEDOR.AsString)+' where NUMERONF='+QuotedStr(Form7.IbDataSet24NUMERONF.AsString)+' and FORNECEDOR='+QuotedStr(sFornecedorAntigo)+'');
      Form7.IBQuery1.Open;
      //
      Form7.IBQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update PAGAR set NOME='+QuotedStr(Form7.IbDataSet24FORNECEDOR.AsString)+' where NUMERONF='+QuotedStr(Form7.IbDataSet24NUMERONF.AsString)+' and NOME='+QuotedStr(sFornecedorAntigo)+'');
      Form7.IBQuery1.Open;
      //
      Screen.Cursor := crDefault; // Cursor de Aguardo
      //
    end;
  end;
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet3AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet1AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
  //
  Form1.ibQuery2.Close;
  Form1.ibQuery2.SQL.Clear;
  Form1.ibQuery2.SQL.Add('set generator G_GRAFICO_CAIXA to 0');
  Form1.ibQuery2.ExecSQL;
  //
end;

procedure TForm7.ibDataSet8AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet18AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet5AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet30AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet27AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet25AfterPost(DataSet: TDataSet);
begin
//  AgendaCommit(True);
end;

procedure TForm7.ibDataSet26AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet13AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet10AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet28AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet37AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet15AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet24AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet2AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet7AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet9AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet12AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet14AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet8AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet18AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet29AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet5AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
  if sModulo = 'BANCOS' then CalculaSAldo(True);
end;

procedure TForm7.IBDataSet99AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet23AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet19AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet30AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet27AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet25AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet26AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet13AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet21AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet10AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataset40AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet11AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet37AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet119AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.Relatriodetotaldeserviosporvendedor1Click(
  Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de servios por tcnico';
  Form38.ShowModal; // Ok
  //

end;

procedure TForm7.Resumodascompras1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Resumo das compras'; // 1
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Resumodascomrpas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form38.Label21.Caption := Form7.ibDataSet2NOME.AsString;
  Form38.Label21.Visible := True;
  Form7.sModulo := 'Resumo das compras';
  Form38.ShowModal; // Ok
  Form38.Label21.Visible := False;
  //
end;

procedure TForm7.MenuItem117Click(Sender: TObject);
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
end;

procedure TForm7.ibDataSet1BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'CAIXA' then
  begin
    if (Date <> ibDataSet1DATA.AsDAteTime) and (ibDataSet1DATA.AsString<>'') then
    begin
      if (fValorAnterior <> ibDataSet1ENTRADA.AsFloat + (ibDataSet1SAIDA.AsFloat*-1)) and (fValorAnterior <> 0) then
      begin
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
        ibDataSet1DATA.AsString + ' - ' + Alltrim(ibDataSet1HISTORICO.AsString),
        (fValorAnterior)
        ,(ibDataSet1ENTRADA.AsFloat+(ibDataSet1SAIDA.AsFloat*-1)) );   // Ato, Modulo, Usurio, Histrico
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet5BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'BANCOS' then
  begin
    if (Date <> ibDataSet5EMISSAO.AsDAteTime) and (ibDataSet5EMISSAO.AsString<>'') then
    begin
      if (fValorAnterior <> ibDataSet5ENTRADA_.AsFloat + (ibDataSet5SAIDA_.AsFloat*-1)) and  (fValorAnterior <> 0) then
      begin
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
        ibDataSet5EMISSAO.AsString + ' - ' + Alltrim(ibDataSet5HISTORICO.AsString),
        (fValorAnterior)
        ,(ibDataSet5ENTRADA_.AsFloat+(ibDataSet5SAIDA_.AsFloat*-1)) );   // Ato, Modulo, Usurio, Histrico
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet7BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet7VALOR_DUPL.AsFloat;
end;

procedure TForm7.ibDataSet8BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet8VALOR_DUPL.AsFloat;
end;

procedure TForm7.ibDataSet7BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'RECEBER' then
  begin
    if (fValorAnterior <> ibDataSet7VALOR_DUPL.AsFloat) and (fValorAnterior <> 0) then
    begin
      Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
      Alltrim(ibDataSet7VENCIMENTO.AsString + ' - ' + Alltrim(ibDataSet7DOCUMENTO.AsString + ' - ' + ibDataSet7HISTORICO.AsString)),
      fValorAnterior, (ibDataSet7VALOR_DUPL.AsFloat));   // Ato, Modulo, Usurio, Histrico
    end;
  end;
  //
end;

procedure TForm7.ibDataSet7BeforeDelete(DataSet: TDataSet);
var
  sS : String;
begin
  //
  if sModulo = 'RECEBER' then
  begin
    //
    sS := '';
    //
    sS := Form1.Small_InputForm('Motivo', 'Informe o motivo de estar apagando esta conta:', '');
    //
    if AllTrim(sS) = '' then
    begin
      ShowMessage('A Conta no foi apagada. Informe um motivo.');
      Abort;
    end;
    //
    Audita('APAGOU', sModulo, Senhas.UsuarioPub,
    Alltrim(ibDataSet7DOCUMENTO.AsString + ' - ' + AllTrim(Copy(sS+replicate(' ',60),1,60))),
    (ibDataSet7VALOR_DUPL.AsFloat),0
    );   // Ato, Modulo, Usurio, Histrico
    //
  end;
  //
end;

procedure TForm7.ibDataSet8BeforeDelete(DataSet: TDataSet);
begin
  //
  if sModulo = 'PAGAR' then
  begin
    Audita('APAGOU', sModulo, Senhas.UsuarioPub,
    Alltrim(ibDataSet8VENCIMENTO.AsString +' - ' +Alltrim(ibDataSet8DOCUMENTO.AsString + ' - ' + ibDataSet8HISTORICO.AsString)),
    (ibDataSet8VALOR_DUPL.AsFloat)
    ,0);   // Ato, Modulo, Usurio, Histrico
  end;
  //
end;

procedure TForm7.ibDataSet8BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'PAGAR' then
  begin
    if (fValorAnterior <> ibDataSet8VALOR_DUPL.AsFloat) and (fValorAnterior <> 0) then
    begin
      Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
      Alltrim(ibDataSet8VENCIMENTO.AsString +' - ' +Alltrim(ibDataSet8DOCUMENTO.AsString + ' - ' + ibDataSet8HISTORICO.AsString)),
      fValorAnterior, (ibDataSet8VALOR_DUPL.AsFloat));   // Ato, Modulo, Usurio, Histrico
    end;
  end;
  //
end;

procedure TForm7.N4ImprimirDANFE1Click(Sender: TObject);
var
  Device : array[0..255] of char;
  Driver : array[0..255] of char;
  Port   : array[0..255] of char;
  hDMode : THandle;
  sFormato, sLote : String;
begin
  //
  //
  if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') or (bContingencia) then
  begin
    //
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption := 'Imprimindo o DANFE'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHom.ini';
    spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProd.ini';
    //
    ConfiguraNFE(True);
    //
    // Recupera na tabela VENDAS o XML
    //
    fNFE :=  Form7.ibDataSet15NFEXML.AsString;
    //
    // Recupera na tabela VENDAS o XML
    //
    try
      //
      // if Form7.bProximas then spdNFe.ImprimirDanfe(sLote, fNFe,'',CorrentPrinter) else
      //
      if Form7.ibDataSet15EMITIDA.AsString = 'X' then
      begin
        sFormato := Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento;
      end else
      begin
        sFormato := Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm';
      end;
      //
      if bProximas then
      begin
        //
        Printer.GetPrinter(Device, Driver, Port, hDMode);
        //
        spdNFe.ImprimirDanfe(sLote, fNFe, sFormato,Device);
        //
      end else
      begin
        spdNFe.ImprimirDanfe(sLote, fNFe, sFormato);
      end;
      //
      if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
      begin
        Form7.ibDataSet15.Edit;
        Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
        Form7.ibDataSet15.Post;
      end;
      //
    except end;
    //
    DecimalSeparator := ',';
    DateSeparator    := '/';
    //
    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    //
    Screen.Cursor            := crDefault;
    //
    if bContingencia then
    begin
      Form7.ibDataset15.Edit;
      Form7.ibDataSet15STATUS.AsString   := 'DANFE impresso em formulrio de segurana.';
      Form7.ibDataset15.Post;
    end;
    //
  end;
  //
end;


procedure TForm7.N1EnviarNFe1Click(Sender: TObject);
var
  //
  spMVAST, spICMSST, sChave, sEx1, sEx2, sEx3, sEx4, sEx5, sEx6, sEx7, sEx8, sEx9, sEx10, sEx11, sEx12, sEx13, sEx14, sEx15, sEx16, sEx17, sEx18 : String;
  fTotalDupl, fRateioDoDesconto, vTotalImpostoImportacao : Real;
  sCodigoANP : String;
  //
  F: TextFile;
  _file : TStringList;
  //
  I, J, iAnoRef : integer;
  sReg : String;
  sComplemento : String;
  sLote : String;
  sRetorno : String;
  sRecibo : String;
  sCupomReferenciado : String;
  sDentroOuForadoEStado, sUFEmbarq, sLocaldeEmbarque, sLocalDespacho, sPais, sCodPais : String;
  vST, vBC, vBCST, vPIS, vPIS_S, vCOFINS, vCOFINS_S, vICMS : Real;
  fTotaldeTriubutos, fTotaldeTriubutos_uf, fTotaldeTriubutos_muni , fSomaNaBase, vIVA60_B_ICMST, vIVA60_V_ICMST : Real;
  fIPIPorUnidade, fAliquota : Real;
  Mais1Ini : tIniFile;
  sJustificativa : String;
  //
  // Pis cofins da Operao
  //
  sCST_PIS_COFINS : String;
  rpPIS, rpCOFINS : Real;
  bTributa : Boolean;
  //
  // Rateio
  //
  fCalculo, vFRETE, vOUTRAS, vDESCONTO, vSEGURO : Real;
  fDesconto, fFrete, fOutras, fSeguro : array[0..999] of double;
  //
  sDIFAL_OBS : String;
  fAliquotaPadrao, fPercentualDeReducaoDeBC, fICMSDesonerado, vICMSDeson, fFCPST, fFCPUFDest, fICMSUFDest, fICMSUFREmet, fDIFAL, fIPIDevolvido, fPercentualFCP, fPercentualFCPST, fFCP: Real;
  //
  stpOp_VeiculosNovos,
  sChassi_VeiculosNovos,
  sCCor_VeiculosNovos,
  sXCor_VeiculosNovos,
  sPot_VeiculosNovos,
  scilin_VeiculosNovos,
  spesoL_VeiculosNovos,
  spesoB_VeiculosNovos,
  snSerie_VeiculosNovos,
  stpComb_VeiculosNovos,
  snMotor_VeiculosNovos,
  sCMT_VeiculosNovos,
  sdist_VeiculosNovos,
  sanoMod_VeiculosNovos,
  sanoFab_VeiculosNovos,
  stpPint_VeiculosNovos,
  stpVeic_VeiculosNovos,
  sespVeic_VeiculosNovos,
  sVIN_VeiculosNovos,
  scondVeic_VeiculosNovos,
  scMod_VeiculosNovos,
  scCorDENATRAN_VeiculosNovos,
  slota_VeiculosNovos,
  stpRest_VeiculosNovos : String;
  //
begin
  //
  if AllTrim(Form7.ibDataSet15NFEID.AsString) <> '' then
  begin
    Form7.RRecuperaroXMLdestaNFe1Click(Sender);
  end;
  //
  if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + Form7.ibDataSet15NFEID.AsString + '-nfe.xml')) then
  begin
    //
    if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
    Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
    //
  end else
  begin
    //
    //
    //
    fAliquota := 0;
    fTotaldeTriubutos := 0;
    fTotaldeTriubutos_uf := 0;
    fTotaldeTriubutos_muni := 0;
    //
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      //
      begin
        //
        Form7.ibDataset15.Edit;
        Form7.ibDataSet15STATUS.AsString    := '';
        //
        if alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '' then
        begin
          //
          try
            //
            begin
              //
              // Incio gerao do xml
              //
              //
              (* Sandro Silva 2022-09-12 inicio
              Movido para ugeraxmlnfe



              Screen.Cursor            := crHourGlass;
              Form7.Panel7.Caption     := 'Verificando status do servio...'+replicate(' ',100);
              Form7.Panel7.Repaint;
              //
              ConfiguraNFE(True);
              //
              if LimpaNumero(AllTrim(ibDataSet13.FieldByname('TELEFO').AsString)) = '' then
              begin
                Form7.ibDataset15.Edit;
                Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o telefone do emitente no foi informado.';
                Abort;
              end;
              //
              if AllTrim(ibDataSet13.FieldByname('CEP').AsString) = '' then
              begin
                Form7.ibDataset15.Edit;
                Form7.ibDataSet15STATUS.AsString    := 'Erro: CEP do emitente invlido.';
                Abort;
              end;
              //
              Form7.Panel7.Caption := 'Gerando arquivo XML...'+replicate(' ',100);
              Form7.Panel7.Repaint;
              //
              if Form7.ibDataSet15EMITIDA.AsString = 'E' then
              begin
      //               //
      // E N T R A D A //
      //               //
                //
                // ENTRADA
                //
                Form7.ibDataSet24.Close;
                Form7.ibDataSet24.SelectSQL.Clear;
                Form7.ibDataSet24.SelectSQL.Add('select * from COMPRAS where NUMERONF='+QuotedStr(Copy(Form7.ibDataSet15NUMERONF.AsString,1,12))+' and FORNECEDOR='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString) );
                Form7.ibDataSet24.Open;
                //
                Form7.ibDataSet14.Close;
                Form7.ibDataSet14.SelectSQL.Clear;
                Form7.ibDataSet14.SelectSQL.Add('select * FROM ICM order by upper(NOME)');
                Form7.ibDataSet14.Open;
                //
                ibDataSet8.Close;
                ibDataSet8.DataSource := DataSource24;
                ibDataSet8.Selectsql.Clear;
                ibDataSet8.Selectsql.Add('select * from PAGAR where NUMERONF=:NUMERONF and NOME=:FORNECEDOR');
                ibDataSet8.Open;
                //
                ibDataSet23.Close;
                ibDataSet23.DataSource  := DataSource24;
                ibDataSet23.Selectsql.Clear;
                ibDataSet23.Selectsql.Add('select * from ITENS002 where NUMERONF=:NUMERONF and FORNECEDOR=:FORNECEDOR');
                ibDataSet23.Open;
                //
                Form7.ibDataSet24.EnableControls;
                Form7.ibDataSet23.EnableControls;
                //
                if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = '' then Form7.ibDataSet14.Append else Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                //
                // Pis cofins da Operao
                //
                sCST_PIS_COFINS := ibDataSet14.FieldByname('CSTPISCOFINS').AsString;
                rpPIS           := ibDataSet14.FieldByname('PPIS').AsFloat;
                rpCOFINS        := ibDataSet14.FieldByname('PCOFINS').AsFloat;
                //
                // Relaciona os clientes com o arquivo de vendas
                //
                Form7.ibDataSet2.Close;
                Form7.ibDataSet2.Selectsql.Clear;
                Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
                Form7.ibDataSet2.Open;
                //
                Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet24TRANSPORTA.AsString,[]);
                //
                // Informaes do Emitente da NFe
                //
                ibDataset99.Close;
                ibDataset99.SelectSql.Clear;
                ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
                ibDataset99.Open;
                //
                if AllTrim(Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7)) = '' then
                begin
                  Form7.ibDataset15.Edit;
                  Form7.ibDataSet15STATUS.AsString    := 'Erro: Nome do municpio do emitente invlido.';
                  Abort;
                end;
                //
                spdNFeDataSets.LoteNFe.Clear;
                //
                spdNFeDataSets.Incluir; // Inicia a insercao de dados na NFe
                //

                //
                // Autorizao para obter XML
                //
                if Form7.ibDataSet13ESTADO.AsString = 'BA' then
                begin
                  if Length(LimpaNumero(sCNPJContabilidade)) = 0 then
                  begin
                    sCNPJContabilidade := LimpaNumero('13.937.073/0001-56');
                  end;
                end;
                //
                if Length(LimpaNumero(sCNPJContabilidade)) <> 0 then
                begin
                  //
                  spdNFeDataSets.IncluirPart('AUTXML');
                  if Length(LimpaNumero(sCNPJContabilidade)) = 11 then
                  begin
                    spdNFeDataSets.Campo('CPF_GA03').Value  := LimpaNumero(sCNPJContabilidade);
                  end else
                  begin
                    spdNFeDataSets.Campo('CNPJ_GA02').Value := LimpaNumero(sCNPJContabilidade);
                  end;
                  spdNFeDataSets.SalvarPart('AUTXML');
                  //
                end;
                //
                // Then end Autorizao para obter XML
                //
                spdNFeDataSets.Campo('Id_A03').Value      := ''; // Calcula Automtico. Essa linha  desnecessria
                //
                if Form1.sVersaoLayout = '4.00' then // Ok
                begin
                  spdNFeDataSets.Campo('versao_A02').Value  := '4.00'; // Verso do Layout que est utilizando
                end else
                begin
                  spdNFeDataSets.Campo('versao_A02').Value  := '3.10'; // Verso do Layout que est utilizando
                end;
                //
                spdNFeDataSets.Campo('cUF_B02').Value     := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,2);  //Codigo da UF para o estado SC = '42'
                spdNFeDataSets.Campo('cNF_B03').Value     := '004640327'; // Cdigo Interno do Sistema que est integrando com a NFe
                spdNFeDataSets.Campo('natOp_B04').Value   := ConverteAcentos2(ibDataSet15.FieldByname('OPERACAO').AsString);
                //
                if Copy(ibDataSet15.FieldByname('OPERACAO').AsString,1,13) = '999 - Estorno' then
                begin
                  //
                  sChave                                      := Form1.Small_InputForm('NFe', 'Chave de acesso da NF-e referenciada (ID da NF-e)', '');
                  //
  //                ShowMessage(sChave);
                  //
{
                  ibDataset97.Close;
                  ibDataset97.SelectSql.Clear;
                  ibDataset97.SelectSQL.Add('select * from VENDAS where NFEID='+QuotedStr(sChave)+' ');
                  ibDataset97.Open;
                  //
                  if sChave = Form7.IBDataSet97.FieldByName('NFEID').AsString then
                  begin
                    ShowMessage('Chave de acesso da NF-e referenciada (ID da NF-e) confirmada.');
                  end else
                  begin
                    ShowMessage('Chave de acesso da NF-e referenciada (ID da NF-e) no existente.');
                    Abort;
                  end;
  }
                  //
                  try
                    if sChave <> '' then
                    begin
                      spdNFeDataSets.IncluirPart('NREF');
                      spdNFeDataSets.Campo('refNFe_BA02').Value := sChave;
                      spdNFeDataSets.SalvarPart('NREF');
                    end;
                  except
                    on E: Exception do
                    begin
                      Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar NREF 1'
                      ),'Ateno',mb_Ok + MB_ICONWARNING);
                    end;
                  end;
                  //
                  try
                    spdNFeDataSets.Campo('finNFe_B25').Value  := '3'; // Finalidade da NFe (1-Normal, 2-Complementar, 3-de Ajuste, 4-Devoluo de mercadoria)
                    spdNFeDataSets.Campo('natOp_B04').Value   := '999 - Estorno de NF-e no cancelada no prazo legal';
                    //
                  except
                    ShowMessage('Erro ao gravar natOp_B04');
                  end;
                  //
                end else
                begin
                  //
                  if Form7.ibDataSet24FINNFE.AsString = '2' then
                  begin
                    //
                    sChave                                      := Form1.Small_InputForm('NFe', 'Chave de acesso da NF-e referenciada (ID da NF-e)', '');
                    //
                    try
                      if sChave <> '' then
                      begin
                        spdNFeDataSets.IncluirPart('NREF');
                        spdNFeDataSets.Campo('refNFe_BA02').Value := sChave;
                        spdNFeDataSets.SalvarPart('NREF');
                      end;
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar NREF 2'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                    //
                  end else
                  begin
                    //
                    if Form7.ibDataSet24FINNFE.AsString = '4'  then
                    begin
                      //
                      sChave                                      := Form1.Small_InputForm('NFe', pChar('Chave de acesso da NF-e de devoluo referenciada'+chr(10)+
                                                                                                        '(ID da NF-e) ou Nmero do ECF (3) + COO (6) para'+chr(10)+
                                                                                                        'cupom fiscal referenciado') , '');
                      //
                      try
                        if Length(LimpaNumero(sChave))= 9 then
                        begin
                          spdNFeDataSets.IncluirPart('NREF');
                          spdNFeDataSets.Campo('mod_BA21').Value    := '2D';
                          spdNFeDataSets.Campo('nECF_BA22').Value   := Copy(LimpaNumero(sChave),1,3);
                          spdNFeDataSets.Campo('nCOO_BA23').Value   := Copy(LimpaNumero(sChave),4,6);
                          spdNFeDataSets.SalvarPart('NREF');
                        end else
                        begin
                          if Length(LimpaNumero(sChave))= 44 then
                          begin
                            spdNFeDataSets.IncluirPart('NREF');
                            spdNFeDataSets.Campo('refNFe_BA02').Value := sChave;
                            spdNFeDataSets.SalvarPart('NREF');
                          end else
                          begin
                            ShowMessage('Informao invlida informe a'+chr(10)+
                                        'Chave de acesso da NF-e de devoluo referenciada'+chr(10)+
                                        '(ID da NF-e) ou Nmero do ECF (3) + COO (6) para'+chr(10)+
                                        'cupom fiscal referenciado');
                            Abort;
                          end;
                        end;
                      except
                        on E: Exception do
                        begin
                          Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar NREF 3'
                          ),'Ateno',mb_Ok + MB_ICONWARNING);
                          Abort;
                        end;
                      end;
                      //
                    end;
                  end;
                  //
                  spdNFeDataSets.Campo('finNFe_B25').Value     := Form7.ibDataSet24FINNFE.AsString; // Finalidade da NFe (1-Normal, 2-Complementar, 3-de Ajuste, 4-Devoluo de mercadoria)
                  //
                end;
                //
                spdNFeDataSets.Campo('indFinal_B25a').Value  := Form7.ibDataSet24INDFINAL.AsString; // Indica operao com Consumidor final] deve ser preenchido. Dica: Utilize: 0-No, 1-Consumidor Final'. Process stopped. Use Step or Run to continue.
                spdNFeDataSets.Campo('indPres_B25b').Value   := Form7.ibDataSet24INDPRES.AsString;  // Indicador de presena do comprador no estabelecimento comercial.. Utilize: 0-No, 1-Operao presencial, 2-Operao no presencial, Internet, 3-Operao No presencial, teleatendimento, 9-Operao no presencial, outros.'.
                //
                if Form1.sVersaoLayout = '4.00' then // Ok
                begin

                end else
                begin
                  if ibDataSet14.FieldByname('INTEGRACAO').AsString = 'Pagar' then
                  begin
                    spdNFeDataSets.Campo('indPag_B05').Value  := '1'; //Indicador da Forma de Pgto (0=Pagamento  vista; 1=Pagamento  prazo; 2=outros)
                  end else
                  begin
                    if AllTrim(ibDataSet14.FieldByname('INTEGRACAO').AsString) = '' then
                    begin
                      spdNFeDataSets.Campo('indPag_B05').Value  := '2'; //Indicador da Forma de Pgto (0=Pagamento  vista; 1=Pagamento  prazo; 2=outros)
                    end else
                    begin
                      spdNFeDataSets.Campo('indPag_B05').Value  := '0'; //Indicador da Forma de Pgto (0=Pagamento  vista; 1=Pagamento  prazo; 2=outros)
                    end;
                  end;
                end;
                //
                spdNFeDataSets.Campo('mod_B06').Value     := '55'; //Cdigo do Modelo de Documento Fiscal
                //
                if Form1.bModoSCAN then
                begin
                  spdNFeDataSets.Campo('serie_B07').Value   := IntToStr(StrToInt(Copy(ibDataSet15.FieldByname('NUMERONF').AsString,10,3))+900); // Srie SCAN
                end else
                begin
                  spdNFeDataSets.Campo('serie_B07').Value   := IntToStr(StrToInt(Copy(ibDataSet15.FieldByname('NUMERONF').AsString,10,3))); // Srie do Documento
                end;
                //
                spdNFeDataSets.Campo('nNF_B08').Value      := IntToStr(StrToInt(Copy(ibDataSet15.FieldByname('NUMERONF').AsString,1,9))); // Nmero da Nota Fiscal
                spdNFeDataSets.Campo('dhEmi_B09').Value    := StrTran(DateToStrInvertida(ibDataSet24.FieldByname('EMISSAO').AsDateTime),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso; // Data de Emisso da Nota Fiscal
                //
                // Permite data e hora de sada em branco
                //
                if AllTrim(ibDataSet24.FieldByname('SAIDAD').AsString) <> '' then
                begin
                  spdNFeDataSets.Campo('dhSaiEnt_B10').Value := StrTran(DateToStrInvertida(ibDataSet24.FieldByname('SAIDAD').AsDateTime),'/','-')+'T'+ibDataSet15.FieldByname('SAIDAH').AsString+Form7.sFuso; // Data de Sada ou Entrada da Nota Fiscal
                  if spdNFeDataSets.Campo('dhSaiEnt_B10').Value < spdNFeDataSets.Campo('dhEmi_B09').Value then spdNFeDataSets.Campo('dhSaiEnt_B10').Value := spdNFeDataSets.Campo('dhEmi_B09').Value;
                end;
                //
                spdNFeDataSets.Campo('tpNF_B11').Value     := '0'; // Tipo de Documento Fiscal (0-Entrada, 1-Sada)
                //
                // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                //
                if Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '3' then
                begin
                  spdNFeDataSets.Campo('idDest_B11a').Value  := '3'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                end else
                begin
                  if (UpperCase(Form7.ibDataSet2ESTADO.AsString) <> UpperCase(Form7.ibDataSet13ESTADO.AsString))  then
                  begin
                    spdNFeDataSets.Campo('idDest_B11a').Value  := '2'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                  end else
                  begin
                    spdNFeDataSets.Campo('idDest_B11a').Value  := '1'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                  end;
                end;
                //
                spdNFeDataSets.Campo('cMunFG_B12').Value   := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo da Cidade do Emitente (Tabela do IBGE)
                //
                // B20a Tag Nota de Produtor Rural
                //
                if Copy(ibDAtaset2.FieldByname('IE').AsString,1,2) = 'PR' then // Produtor Rural
                begin
                  //
                  Form11.ShowModal; // Nota de Produtor Rural
                  //
                  //
                  try
                    //
  //                  spdNFeDataSets.IncluirPart('NREF');
                    spdNFeDataSets.IncluirPart('NREF');
                    //
                    ibDataset100.Close;
                    ibDataset100.SelectSql.Clear;
                    ibDataset100.SelectSQL.Add('select * from MUNICIPIOS where UF='+QuotedStr(UpperCase(Form11.Edit1.Text))+' ');
                    ibDataset100.Open;
  {
                    //
                    spdNFeDataSets.Campo('cUF_BA04').Value   := Copy(ibDAtaSet100.FieldByname('CODIGO').AsString,1,2);  // Cdigo da UF do emitente do Documento Fiscal
                    spdNFeDataSets.Campo('AAMM_BA05').Value  := Form11.Edit2.Text; // Ano e Ms de emisso da NF-e
                    //
                    if Length(LimpaNumero(Form11.Edit3.Text)) = 11 then
                    begin
                      spdNFeDataSets.Campo('CPF_BA14').Value  := LimpaNumero(Form11.Edit3.Text); // CPF do emitente
                    end else
                    begin
                      spdNFeDataSets.Campo('CNPJ_BA06').Value  := LimpaNumero(Form11.Edit3.Text); // CNPJ do emitente
                    end;
                    //
                    spdNFeDataSets.Campo('mod_BA07').Value   := '01'; // Modelo do documento fiscal
                    spdNFeDataSets.Campo('serie_BA08').Value := IntToStr(StrToInt(LimpaNumero(Form11.Edit5.Text))); // Srie
                    spdNFeDataSets.Campo('nNF_BA09').Value   := IntToStr(StrToInt(LimpaNumero(Form11.Edit6.Text))); // Nmero do documento fiscal
                    //
  }
                    spdNFeDataSets.Campo('cUF_BA11').Value   := Copy(ibDAtaSet100.FieldByname('CODIGO').AsString,1,2);  // Cdigo da UF do emitente do Documento Fiscal
                    spdNFeDataSets.Campo('AAMM_BA12').Value  := Form11.Edit2.Text; // Ano e Ms de emisso da NF-e
                    //
                    if length(LimpaNumero(Form11.Edit3.Text)) = 11 then
                    begin
                      spdNFeDataSets.Campo('CPF_BA14').Value  := LimpaNumero(Form11.Edit3.Text); // CPF do emitente
                    end else
                    begin
                      spdNFeDataSets.Campo('CNPJ_BA13').Value  := LimpaNumero(Form11.Edit3.Text); // CNPJ do emitente
                    end;
                    //
                    if LimpaNumero(Form11.Edit4.Text) = '' then
                    begin
                      spdNFeDataSets.Campo('IE_BA15').Value      := 'ISENTO'; // IE do emitente
                    end else
                    begin
                      spdNFeDataSets.Campo('IE_BA15').Value      := LimpaNumero(Form11.Edit4.Text); // IE do emitente
                    end;
                    //
                    spdNFeDataSets.Campo('mod_BA16').Value   := Copy(Form11.ComboBox7.Items[Form11.ComboBox7.ItemIndex]+'04',1,2); // Informar o cdigo 04 - NF de Produtor ou 01 - Para NF avulsa
                    spdNFeDataSets.Campo('serie_BA17').Value := IntToStr(StrToInt(LimpaNumero(Form11.Edit5.Text))); // Srie
                    spdNFeDataSets.Campo('nNF_BA18').Value   := IntToStr(StrToInt(LimpaNumero(Form11.Edit6.Text))); // Nmero do documento fiscal
                    //
                    spdNFeDataSets.SalvarPart('NREF');
                    //
                  except
                    on E: Exception do
                    begin
                      Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ ' ao criar xml para nota de produtor rural.'
                      ),'Ateno',mb_Ok + MB_ICONWARNING);
                    end;
                  end;
                  //
                end;
                //
                spdNFeDataSets.Campo('tpImp_B21').Value   := '1'; // Tipo de Impresso da Danfe (1- Retrato , 2-Paisagem)
                //
                if Form1.bModoSCAN then
                begin
                  spdNFeDataSets.Campo('tpEmis_B22').Value  := '3';
                end else
                begin
                  //
                  if bContingencia then
                  begin
                    spdNFeDataSets.Campo('tpEmis_B22').Value  := '5'; // Papel normal Contingncia
                  end else
                  begin
                    //
                    if Form1.bModoSVC then
                    begin
                      //
                      if (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'AM') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'BA') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'CE') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'ES') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'GO') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'MA') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'MS') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'MT') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PA') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PE') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PI') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PR') then
                      begin
                        spdNFeDataSets.Campo('tpEmis_B22').Value  := '7'; // SVC-RS
                      end else
                      begin
                        spdNFeDataSets.Campo('tpEmis_B22').Value  := '6'; // SVC-AN
                      end;
                      //
                    end else
                    begin
                      spdNFeDataSets.Campo('tpEmis_B22').Value  := '1'; //Forma de Emisso da NFe (1-Normal, 2-Contingncia 3-SCAN)
                    end;
                  end;
                end;
                //
                spdNFeDataSets.Campo('cDV_B23').Value     := ''; // Calcula Automatico - Linha desnecessria j que o componente calcula o Dgito Verificador automaticamente e coloca no devido campo
                //
                if Form1.bHomologacao then spdNFeDataSets.Campo('tpAmb_B24').Value := '2' else spdNFeDataSets.Campo('tpAmb_B24').Value := '1';
                //
                spdNFeDataSets.Campo('procEmi_B26').Value := '0'; // Identificador do Processo de emisso (0-Emisso da Nfe com Aplicativo do Contribuinte). Ver outras opes no manual da Receita.
                spdNFeDataSets.Campo('verProc_B27').Value := '001'; // Verso do Aplicativo Emissor
                //
                // NFe com CPF
                //
                if Length(LimpaNumero(Form7.ibDataSet13CGC.AsString)) = 11 then
                begin
                  spdNFeDataSets.Campo('CPF_C02a').Value    := LimpaNumero(ibDAtaset13.FieldByname('CGC').AsString); // CNPJ do Emitente
                end else
                begin
                  spdNFeDataSets.Campo('CNPJ_C02').Value    := LimpaNumero(ibDAtaset13.FieldByname('CGC').AsString); // CNPJ do Emitente
                end;
                //
                spdNFeDataSets.Campo('xNome_C03').Value   := ConverteAcentos2(ibDAtaset13.FieldByname('NOME').AsString); // Razao Social ou Nome do Emitente
                spdNFeDataSets.Campo('xFant_C04').Value   := ConverteAcentos2(ibDAtaset13.FieldByname('NOME').AsString); ; // Nome Fantasia do Emitente
                //
                spdNFeDataSets.Campo('xLgr_C06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset13.FieldByname('ENDERECO').AsString)); // Logradouro do Emitente
                spdNFeDataSets.Campo('nro_C07').Value     := Numero_Sem_Endereco(ibDAtaset13.FieldByname('ENDERECO').AsString); // Numero do Logradouro do Emitente
                //
                spdNFeDataSets.Campo('xBairro_C09').Value := ConverteAcentos2(ibDAtaset13.FieldByname('COMPLE').AsString); // Bairro do Emitente
                //
                spdNFeDataSets.Campo('cMun_C10').Value    := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo da Cidade do Emitente (Tabela do IBGE)
                spdNFeDataSets.Campo('xMun_C11').Value    := ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString); // Nome da Cidade do Emitente
                //
                spdNFeDataSets.Campo('UF_C12').Value      := ibDAtaSet99.FieldByname('UF').AsString; // Cdigo do Estado do Emitente (Tabela do IBGE)
                spdNFeDataSets.Campo('CEP_C13').Value     := LimpaNumero(ibDataSet13.FieldByname('CEP').AsString); // Cep do Emitente
                //
                if Alltrim(ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString))='' then
                begin
                  Form7.ibDataset15.Edit;
                  Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o CEP do emitente';
                  Abort;
                end;
                //
                spdNFeDataSets.Campo('cPais_C14').Value   := '1058'; // Cdigo do Pas do Emitente (Tabela BACEN)
                spdNFeDataSets.Campo('xPais_C15').Value   := 'BRASIL'; // Nome do Pas do Emitente
                //
                if Length(LimpaNumero(ibDAtaset13.FieldByname('TELEFO').AsString)) = 11 then spdNFeDataSets.Campo('fone_C16').Value    := Copy(LimpaNumero(ibDAtaset13.FieldByname('TELEFO').AsString),2,10) else spdNFeDataSets.Campo('fone_C16').Value    := LimpaNumero(ibDAtaset13.FieldByname('TELEFO').AsString); // Fone do Emitente
                //
                spdNFeDataSets.Campo('IE_C17').Value := LimpaNumero(ibDAtaset13.FieldByname('IE').AsString); // Inscrio Estadual do Emitente
                //
                if LimpaNumero(ibDAtaset13.FieldByname('IM').AsString) <> '' then
                begin
                  spdNFeDataSets.Campo('IM_C19').Value      := StrTran(LimpaNumero(ibDAtaset13.FieldByname('IM').AsString),'-',''); // Inscrio Estadual do Emitente
                  //
                  if AllTrim(ibDAtaset13.FieldByname('CNAE').AsString) <> '' then
                  begin
                    spdNFeDataSets.Campo('CNAE_C20').Value      := AllTrim(ibDAtaset13.FieldByname('CNAE').AsString); // CNAE
                  end else
                  begin
                    spdNFeDataSets.Campo('CNAE_C20').Value    := '0000000'; // CNAE
                  end;
                  //
                end;
                //
                // Informaes do Destinatrio da NFe
                //
                if Form7.ibDataSet2ESTADO.AsString <> 'EX' then
                begin
                  //
                  // Informaes do Destinatrio da NFe
                  //
                  ibDataset99.Close;
                  ibDataset99.SelectSql.Clear;
                  ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet2CIDADE.AsString)+' and UF='+QuotedStr(ibDataSet2ESTADO.AsString)+' ');
                  ibDataset99.Open;
                  //
                  if Alltrim(ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString))='' then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o municpio do destinatrio';
                    Abort;
                  end;
                  //
                  if Form7.spdNFe.Ambiente = spdNFeType.akHomologacao then
                  begin
                    //
                    spdNFeDataSets.Campo('CNPJ_E02').Value      := '99999999000191'; // CNPJ do Destinatrio
                    spdNFeDataSets.Campo('xNome_E04').Value     := 'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL'; // Razao social ou Nome do Destinatrio
                    spdNFeDataSets.Campo('IE_E17').Value        := '';
                    //
                    if (Form7.ibDataSet2ESTADO.AsString ='AM') or
                       (Form7.ibDataSet2ESTADO.AsString ='BA') or
                       (Form7.ibDataSet2ESTADO.AsString ='CE') or
                       (Form7.ibDataSet2ESTADO.AsString ='GO') or
                       (Form7.ibDataSet2ESTADO.AsString ='MG') or
                       (Form7.ibDataSet2ESTADO.AsString ='MS') or
                       (Form7.ibDataSet2ESTADO.AsString ='MT') or
                       (Form7.ibDataSet2ESTADO.AsString ='PE') or
                       (Form7.ibDataSet2ESTADO.AsString ='RN') or
                       (Form7.ibDataSet2ESTADO.AsString ='SE') or
                       (Form7.ibDataSet2ESTADO.AsString ='SP') then
                    begin
                      spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';    // 1-Contribuinte; 2-Isento; 9-No contribuinte
                    end else
                    begin
                      spdNFeDataSets.Campo('indIEDest_E16a').Value  := '2';    // 1-Contribuinte; 2-Isento; 9-No contribuinte
                    end;
                    //
                  end else
                  begin
                    //
                    if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 18) then spdNFeDataSets.Campo('CNPJ_E02').Value := AllTrim(LimpaNumero(ibDAtaset2.FieldByname('CGC').AsString)); // CNPJ do Destinatrio
                    if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 14) then spdNFeDataSets.Campo('CPF_E03').Value  := AllTrim(LimpaNumero(ibDAtaset2.FieldByname('CGC').AsString)); // CPF do Destinatrio
                    spdNFeDataSets.Campo('xNome_E04').Value   := ConverteAcentos2(ibDAtaset2.FieldByname('NOME').AsString); // Razao social ou Nome do Destinatrio
                    //
                  end;
                  //
                  spdNFeDataSets.Campo('xLgr_E06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset2.FieldByname('ENDERE').AsString)); // Logradouro do Emitente
                  spdNFeDataSets.Campo('nro_E07').Value     := Numero_Sem_Endereco(ibDAtaset2.FieldByname('ENDERE').AsString); // Numero do Logradouro do Emitente
                  //
                  spdNFeDataSets.Campo('xBairro_E09').Value := Alltrim(ConverteAcentos2(ibDAtaset2.FieldByname('COMPLE').AsString)); // Bairro do Destinatario
                  spdNFeDataSets.Campo('cMun_E10').Value    := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo do Municpio do Destinatrio (Tabela IBGE)
                  //
                  spdNFeDataSets.Campo('xMun_E11').Value    := Alltrim(ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString)); //Nome da Cidade do Destinatrio
                  spdNFeDataSets.Campo('UF_E12').Value      := ibDAtaSet99.FieldByname('UF').AsString; // Sigla do Estado do Destinatrio
                  //
                  spdNFeDataSets.Campo('CEP_E13').Value     := LimpaNumero(ibDataSet2.FieldByname('CEP').AsString); // Cep do Destinatrio
                  spdNFeDataSets.Campo('cPais_E14').Value   := '1058'; // Cdigo do Pais do Destinatrio (Tabela do BACEN)
                  spdNFeDataSets.Campo('xPais_E15').Value   := 'BRASIL';// Nome do Pas do Destinatrio
                  //
                  if Length(LimpaNumero(ibDAtaset2.FieldByname('FONE').AsString)) = 11 then spdNFeDataSets.Campo('fone_E16').Value    := Copy(LimpaNumero(ibDAtaset2.FieldByname('FONE').AsString),2,10) else spdNFeDataSets.Campo('fone_E16').Value    := LimpaNumero(ibDAtaset2.FieldByname('FONE').AsString); // Fone do Destinatrio
                  //
                  if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 0) then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: CNPJ ou CPF do destinatrio invlido';
                    Abort;
                  end;
                  //
                  if (Length(AllTrim(Form7.ibDataSet2CEP.AsString)) <> 9) then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: CEP do destinatrio invlido';
                    Abort;
                  end;
                  //
                  if Limpanumero(Form7.ibDataSet2FONE.AsString) <> '' then
                  begin
                    if Length(Limpanumero(Form7.ibDataSet2FONE.AsString)) < 8 then
                    begin
                      Form7.ibDataset15.Edit;
                      Form7.ibDataSet15STATUS.AsString    := 'Erro: Telefone do destinatrio invlido.';
                      Abort;
                    end;
                  end;
                  //
                  if Form7.spdNFe.Ambiente <> spdNFeType.akHomologacao then
                  begin
                    //
                    if Copy(ibDAtaset2.FieldByname('IE').AsString,1,2) = 'PR' then // Produtor Rural
                    begin
                      //
                      spdNFeDataSets.Campo('IE_E17').Value          := LimpaNumero(ibDAtaset2.FieldByname('IE').AsString); // Inscrio Estadual do Destinatrio
                      spdNFeDataSets.Campo('indIEDest_E16a').Value  := '1';      // Contribuinte ICMS
                      //
                      // spdNFeDataSets.Campo('IE_E17').Value          := ''; // Produtor rural
                      //
                    end else
                    begin
                      //
                      if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 18) then
                      begin
                        //
                        if AllTrim(ibDAtaset2.FieldByname('IE').AsString) = '' then
                        begin
                          //
                          // Form7.IBDataSet2.Edit;
                          // Form7.ibDAtaset2.FieldByname('IE').AsString := 'ISENTO';
                          // spdNFeDataSets.Campo('IE_E17').Value        := ibDAtaset2.FieldByname('IE').AsString; // Inscrio Estadual do Destinatrio
                          //
                          spdNFeDataSets.Campo('IE_E17').Value          := '';
                          //
                          spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9'; // 1-Contribuinte; 2-Isento; 9-No contribuinte
                          //
                        end else
                        begin
                          if not ConsisteInscricaoEstadual(LimpaNumero(Form7.ibDataSet2IE.AsString),Form7.ibDataSet2ESTADO.AsString) then
                          begin
                            //
                            if ibDAtaset2.FieldByname('IE').AsString = 'ISENTO' then
                            begin
                              //
                              spdNFeDataSets.Campo('indIEDest_E16a').Value  := '2';  // 1-Contribuinte; 2-Isento; 9-No contribuinte
                              spdNFeDataSets.Campo('IE_E17').Value          := '';
                              //
                            end else
                            begin
                              spdNFeDataSets.Campo('indIEDest_E16a').Value  := '1';  // 1-Contribuinte; 2-Isento; 9-No contribuinte
                              spdNFeDataSets.Campo('IE_E17').Value      := LimpaNumero(ibDAtaset2.FieldByname('IE').AsString); // Inscrio Estadual do Destinatrio
                            end;
                            //
                          end else
                          begin
                            //
                            if ibDAtaset2.FieldByname('IE').AsString = 'ISENTO' then
                            begin
                              spdNFeDataSets.Campo('indIEDest_E16a').Value  := '2'; // 1-Contribuinte; 2-Isento; 9-No contribuinte
                            end else
                            begin
                              Form7.ibDataset15.Edit;
                              Form7.ibDataSet15STATUS.AsString    := 'Erro: Inscrio Estadual Invlida';
                              Abort;
                            end;
                          end;
                        end;
                      end else
                      begin
                        //
                        spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';   // 1-Contribuinte; 2-Isento; 9-No contribuinte
                        spdNFeDataSets.Campo('IE_E17').Value          := '';
                        //
                        // quando  CPF no deve mostrar o IE
                        //
                      end;
                    end;
                  end;
                  //
                end else
                begin
                  //
                  // Vendedor estrangeiro
                  //
                  spdNFeDataSets.Campo('xLgr_E06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset2.FieldByname('ENDERE').AsString)); // Logradouro do Emitente
                  spdNFeDataSets.Campo('nro_E07').Value     := Numero_Sem_Endereco(ibDAtaset2.FieldByname('ENDERE').AsString); // Numero do Logradouro do Emitente
                  //
                  spdNFeDataSets.Campo('xBairro_E09').Value := ConverteAcentos2(ibDAtaset2.FieldByname('COMPLE').AsString); // Bairro do Destinatario
                  spdNFeDataSets.Campo('cMun_E10').Value    := '9999999';   // Cdigo do Municpio do Destinatrio (Tabela IBGE)
                  spdNFeDataSets.Campo('xMun_E11').Value    := 'EXTERIOR'; //Nome da Cidade do Destinatrio
                  spdNFeDataSets.Campo('UF_E12').Value      := 'EX';      // Sigla do Estado do Destinatrio
                  //
                  spdNFeDataSets.Campo('CEP_E13').Value         := '00000000'; // Cep do Destinatrio
                  spdNFeDataSets.Campo('fone_E16').Value        := '';        // Fone do Destinatrio
                  spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';      // No Contribuinte
                  //
                  if Form7.spdNFe.Ambiente = spdNFeType.akHomologacao then
                  begin
                    spdNFeDataSets.Campo('xNome_E04').Value   := 'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL'; // Razao social ou Nome do Destinatrio
                  end else
                  begin
                    spdNFeDataSets.Campo('xNome_E04').Value   := ConverteAcentos2(ibDAtaset2.FieldByname('NOME').AsString); // Razao social ou Nome do Destinatrio
                  end;
                  //
                  if Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '3' then
                  begin
                    //
                    spdNFeDataSets.Campo('cPais_E14').Value            := '1058';  // Cdigo do Pais do Destinatrio (Tabela do BACEN)
                    spdNFeDataSets.Campo('xPais_E15').Value            := 'Brasil';    // Nome do Pas do Destinatrio
                    spdNFeDataSets.Campo('idEstrangeiro_E03a').Value   := Form1.Small_InputForm('Identificao de estrangeiro','Nmero do passaporte ou documento legal do comprador estrangeiro: ',''); // Identificacao do destinatario no caso de comprador estrangeiro
                    //
                  end else
                  begin
                    //
                    // Importao
                    //
                    sEx3 := '';
                    Mais1ini := TIniFile.Create(Form1.sAtual+'\importac.ini');
                    //
                    sPais    := 'Estados Unidos';
                    sCodPais := '2496';
                    sEx1     := Mais1Ini.ReadString('DI','Ex1','999999999');
                    sEx2     := Mais1Ini.ReadString('DI','Ex2','2010-12-01');
                    sEx3     := Mais1Ini.ReadString('DI','Ex3','Alfandega do porto de Santos');
                    sEx4     := Mais1Ini.ReadString('DI','Ex4','SP');
                    sEx5     := Mais1Ini.ReadString('DI','Ex5','2011-10-03');
                    sEx6     := Mais1Ini.ReadString('DI','Ex6','0001');
                    sEx7     := Mais1Ini.ReadString('DI','Ex7','1');
                    //
                    Form29.Label_01.Visible := True;
                    Form29.Label_02.Visible := True;
                    Form29.Label_03.Visible := True;
                    Form29.Label_04.Visible := True;
                    Form29.Label_05.Visible := True;
                    Form29.Label_06.Visible := True;
                    Form29.Label_07.Visible := True;
                    Form29.Label_08.Visible := True;
                    Form29.Label_09.Visible := True;
                    Form29.Label_10.Visible := True;
                    //
                    Form29.Edit_01.Visible := True;
                    Form29.Edit_02.Visible := True;
                    Form29.Edit_03.Visible := True;
                    Form29.Edit_04.Visible := True;
                    Form29.Edit_05.Visible := True;
                    Form29.Edit_06.Visible := True;
                    Form29.Edit_07.Visible := True;
                    Form29.Edit_08.Visible := True;
                    Form29.Edit_09.Visible := True;
                    Form29.Edit_10.Visible := True;
                    //
                    Form29.Label_01.Caption := 'Pas de origem:';
                    Form29.Label_02.Caption := 'Cdigo do Pas de origem:';
                    Form29.Label_03.Caption := 'Nmero do Documento de Importao (DI/DSI/DA):';
                    Form29.Label_04.Caption := 'Data de Registro da DI/DSI/DA no formato AAAA-MM-DD:';
                    Form29.Label_05.Caption := 'Local de desembarao:';
                    Form29.Label_06.Caption := 'Sigla da UF onde ocorreu o Desembarao Aduaneiro:';
                    Form29.Label_07.Caption := 'Data do Desembarao Aduaneiro Formato AAAA-MM-DD:';
                    Form29.Label_08.Caption := 'Cdigo do exportador:';
                    Form29.Label_09.Caption := 'Nmero da adio:';
                    Form29.Label_10.Caption := 'Identificao do destinatrio no caso de comprador estrangeiro:';
                    //
                    Form29.Edit_01.Text := sPais;
                    Form29.Edit_02.Text := sCodPais;
                    Form29.Edit_03.Text := sEx1;
                    Form29.Edit_04.Text := sEx2;
                    Form29.Edit_05.Text := sEx3;
                    Form29.Edit_06.Text := sEx4;
                    Form29.Edit_07.Text := sEx5;
                    Form29.Edit_08.Text := sEx6;
                    Form29.Edit_09.Text := sEx7;
                    Form29.Edit_10.Text := sEx15;
                    //
                    Form1.Small_InputForm_Dados('Importao');
                    //
                    sPais     := Form29.Edit_01.Text;
                    sCodPais  := Form29.Edit_02.Text;
                    sEx1      := Form29.Edit_03.Text;
                    sEx2      := Form29.Edit_04.Text;
                    sEx3      := Form29.Edit_05.Text;
                    sEx4      := Form29.Edit_06.Text;
                    sEx5      := Form29.Edit_07.Text;
                    sEx6      := Form29.Edit_08.Text;
                    sEx7      := Form29.Edit_09.Text;
                    sEx15     := Form29.Edit_10.Text;
                    //
{
                    sPais    := Form1.Small_InputForm('NFe', 'Pas destino', 'Estados Unidos');
                    sCodPais := Form1.Small_InputForm('NFe', 'Cdigo do Pas destino', '2496');
                    sEx1     := Form1.Small_InputForm('NF-e importao', 'Nmero do Documento de Importao (DI/DSI/DA):',sEx1);
                    sEx2     := Form1.Small_InputForm('NF-e importao', 'Data de Registro da DI/DSI/DA no formato AAAA-MM-DD:',sEx2);
                    sEx3     := Form1.Small_InputForm('NF-e importao', 'Local de desembarao:',sEx3);
                    sEx4     := Form1.Small_InputForm('NF-e importao', 'Sigla da UF onde ocorreu o Desembarao Aduaneiro:',sEx4);
                    sEx5     := Form1.Small_InputForm('NF-e importao', 'Data do Desembarao Aduaneiro Formato AAAA-MM-DD:',sEx5);
                    sEx6     := Form1.Small_InputForm('NF-e importao', 'Cdigo do exportador:',sEx6);
                    sEx7     := Form1.Small_InputForm('NF-e importao', 'Nmero da adio:',sEx7);
                    sEx15    := Form1.Small_InputForm('NF-e importao', 'Identificao do destinatrio no caso de comprador estrangeiro:',sEx15);
}

                    //
                    // http://www.tecno-services.com/, acesse o painel administrador
                    // suporte@smallsoft.com.br
                    // genesis
                    //
                    Mais1Ini.WriteString('DI','Ex1',sEx1);
                    Mais1Ini.WriteString('DI','Ex2',sEx2);
                    Mais1Ini.WriteString('DI','Ex3',sEx3);
                    Mais1Ini.WriteString('DI','Ex4',sEx4);
                    Mais1Ini.WriteString('DI','Ex5',sEx5);
                    Mais1Ini.WriteString('DI','Ex6',sEx6);
                    Mais1Ini.WriteString('DI','Ex7',sEx7);
                    Mais1Ini.WriteString('DI','Ex15',sEx15);
                    //
                    Mais1ini.Free;
                    //
                    spdNFeDataSets.Campo('xLgr_E06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset2.FieldByname('ENDERE').AsString)); // Logradouro do Emitente
                    spdNFeDataSets.Campo('nro_E07').Value     := Numero_Sem_Endereco(ibDAtaset2.FieldByname('ENDERE').AsString); // Numero do Logradouro do Emitente
                    //
                    spdNFeDataSets.Campo('xBairro_E09').Value := ConverteAcentos2(ibDAtaset2.FieldByname('COMPLE').AsString); // Bairro do Destinatario
                    spdNFeDataSets.Campo('cMun_E10').Value    := '9999999'; // Cdigo do Municpio do Destinatrio (Tabela IBGE)
                    spdNFeDataSets.Campo('xMun_E11').Value    := 'EXTERIOR'; //Nome da Cidade do Destinatrio
                    spdNFeDataSets.Campo('UF_E12').Value      := 'EX'; // Sigla do Estado do Destinatrio
                    //
                    spdNFeDataSets.Campo('CEP_E13').Value         := '00000000';  // Cep do Destinatrio
                    spdNFeDataSets.Campo('fone_E16').Value        := '';         // Fone do Destinatrio
                    spdNFeDataSets.Campo('cPais_E14').Value       := sCodPais;  // Cdigo do Pais do Destinatrio (Tabela do BACEN)
                    spdNFeDataSets.Campo('xPais_E15').Value       := sPais;    // Nome do Pas do Destinatrio
                    spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';     // No Contribuinte
                    //
                    try
                      if AllTrim(sEx15) = '' then
                      begin
                        spdNFeDataSets.Campo('idEstrangeiro_E03a').GeraTagVazia   := True;     // Indentificao do destinario no caso de comprador estrangeiro
                      end else
                      begin
                        spdNFeDataSets.Campo('idEstrangeiro_E03a').Value  := sEx15;      // Indentificao do destinario no caso de comprador estrangeiro
                      end;
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'Identificao do destinatrio no caso de comprador estrangeiro'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                    //
                  end;
                  //
                end;
                //
                // Calcular o desconto do Item
                //
                vDESCONTO := 0;
                vFRETE    := 0;
                vSEGURO   := 0;
                vOUTRAS   := 0;
                //
                for I := 1 to 999 do
                begin
                  fOutras[I]   := 0;
                  fFrete[I]    := 0;
                  fseguro[I]   := 0;
                  fDesconto[I] := 0;
                end;
                //
                I := 0;
                //
                vPIS           := 0;
                vCOFINS        := 0;
                //
                ibDataSet23.First;
                while not ibDataSet23.Eof do
                begin
                  //
                  Form7.ibDataSet4.Close;
                  Form7.ibDataSet4.Selectsql.Clear;
                  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');  //
                  Form7.ibDataSet4.Open;
                  //
                  if (Alltrim(ibDataSet4DESCRICAO.AsString) = Alltrim(ibDAtaSet23DESCRICAO.AsString)) and (Alltrim(ibDataSet4DESCRICAO.AsString) <> '') then
                  begin
                    //
                    I := I + 1;
                    //
  //                  if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                    begin
                      fOutras[I]   := Arredonda((ibDataSet24.FieldByname('DESPESAS').AsFloat / ibDataSet24.FieldByname('MERCADORIA').AsFloat * ibDataSet23.FieldByname('TOTAL').AsFloat),2);
                    end;
                    //
                    fFrete[I]    := Arredonda((ibDataSet24.FieldByname('FRETE').AsFloat / ibDataSet24.FieldByname('MERCADORIA').AsFloat * ibDataSet23.FieldByname('TOTAL').AsFloat),2);
                    fSeguro[I]   := Arredonda((ibDataSet24.FieldByname('SEGURO').AsFloat / ibDataSet24.FieldByname('MERCADORIA').AsFloat * ibDataSet23.FieldByname('TOTAL').AsFloat),2);
                    fDesconto[I] := Arredonda((ibDataSet24.FieldByname('DESCONTO').AsFloat / ibDataSet24.FieldByname('MERCADORIA').AsFloat * ibDataSet23.FieldByname('TOTAL').AsFloat),2);
                    //
                    vFRETE       := vFRETE + fFrete[I];
                    vSEGURO      := vSEGURO + fSeguro[I];
                    vOUTRAS      := vOUTRAS + fOutras[I];
                    vDESCONTO    := vDESCONTO + fDesconto[I];
                    //
                  end;
                  //
                  ibDataSet23.Next;
                  //
                end;
                //
                vDESCONTO      := (ibDataSet24.FieldByname('DESCONTO').AsFloat - vDESCONTO);
                vSEGURO        := (ibDataSet24.FieldByname('SEGURO').AsFloat - vSEGURO);
                vFRETE         := (ibDataSet24.FieldByname('FRETE').AsFloat - vFRETE);
                //
  //              if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                begin
                  vOUTRAS        := (ibDataSet24.FieldByname('DESPESAS').AsFloat - vOUTRAS);
                end;
                //
                for I := 1 to 999 do
                begin
                  //
                  // DIFERENCA DE CENTAVOS DO DESCONTO
                  //
                  if vDESCONTO <> 0 then
                  begin
                    if fDesconto[I] = Math.MAxValue( fDesconto ) then
                    begin
  //                    ShowMessage('Diferena: '+FloatToStr(vDESCONTO)+chr(10)+
  //                    'Desconto do item: '+FloatToStr(vDESCONTO)+chr(10)+
  //                    'Desconto do item + Diferena: '+FloatToStr(fDesconto[I] + vDESCONTO)+chr(10));
                      fDesconto[I] := fDesconto[I] + vDESCONTO;
                      vDESCONTO := 0;
                    end;
                  end;
                  //
                  // DIFERENCA DE CENTAVOS DO FRETE
                  //
                  if vFRETE <> 0 then
                  begin
                    if fFRETE[I] = Math.MaxValue( fFRETE ) then
                    begin
                      fFRETE[I] := fFRETE[I] + vFRETE;
                      vFRETE := 0;
                    end;
                  end;
                  //
                  // DIFERENCA DE CENTAVOS DO SEGURO
                  //
                  if vSEGURO <> 0 then
                  begin
                    if fSEGURO[I] = Math.MaxValue( fSEGURO ) then
                    begin
                      fSEGURO[I] := fSEGURO[I] + vSEGURO;
                      vSEGURO := 0;
                    end;
                  end;
                  //
                  // DIFERENCA DE CENTAVOS DO OUTRAS
                  //
                  if vOUTRAS <> 0 then
                  begin
                    if fOUTRAS[I] = Math.MaxValue( fOUTRAS ) then
                    begin
                      fOUTRAS[I] := fOUTRAS[I] + vOUTRAS;
                      vOUTRAS := 0;
                    end;
                  end;
                  //
                end;
                //
                // Ok
                //
                I := 0;
                vTotalImpostoImportacao := 0;
                //
                //
                ibDataSet23.First;
                while not ibDataSet23.Eof do
                begin
                  //
                  Form7.ibDataSet4.Close;
                  Form7.ibDataSet4.Selectsql.Clear;
                  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');  //
                  Form7.ibDataSet4.Open;
                  //
                  if (Alltrim(ibDataSet4DESCRICAO.AsString) = AllTrim(ibDAtaSet23DESCRICAO.AsString)) and (copy(ibDAtaSet23CFOP.AsString,2,3)<>'604') then
                  begin
                    //
                    I := I + 1;
                    //
                    try
                      //
                      if spdNFeDataSets.Campo('indIEDest_E16a').Value = '9' then spdNFeDataSets.Campo('IE_E17').Value          := ''; // spdNFeDataSets.Campo('IE_E17').GeraTagVazia := True;
                      if spdNFeDataSets.Campo('indIEDest_E16a').Value = '2' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                      //
                      spdNFeDataSets.SalvarItem;
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao salvar item cdigo: '+spdNFeDataSets.Campo('cProd_I02').Value+chr(10)+spdNFeDataSets.Campo('xProd_I04').Value+chr(10)+
                        chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                    //
                    spdNFeDataSets.IncluirItem;
                    //
                    // Informaes Referentes aos ITens da NFe
                    //
                    spdNFeDataSets.Campo('nItem_H02').Value := IntToStr(I); // Nmero do Item da NFe (1 at 990)
                    //
                    // Dados do Produto Comprado
                    //
                    if (RetornaValorDaTagNoCampo('cProd', form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '') then //
                      spdNFeDataSets.Campo('cProd_I02').Value    := Copy(RetornaValorDaTagNoCampo('cProd', form7.ibDataSet4.FieldByname('TAGS_').AsString), 1, 60)
                    else
                      if _ecf65_ValidaGtinNFCe(form7.ibDataSet4.FieldByname('REFERENCIA').AsString) then
                        spdNFeDataSets.Campo('cProd_I02').Value    := form7.ibDataSet4.FieldByname('CODIGO').AsString //Cdigo do PRoduto ou Servio
                      else
                        //spdNFeDataSets.Campo('cProd_I02').Value   := LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // Cdigo de BARRAS
                        if Length(Alltrim(LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString))) < 6 then
                          spdNFeDataSets.Campo('cProd_I02').Value    := form7.ibDataSet4.FieldByname('CODIGO').AsString //Cdigo do PRoduto ou Servio
                        else
                          spdNFeDataSets.Campo('cProd_I02').Value   := LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // Cdigo de BARRAS

                    spdNFeDataSets.Campo('cEAN_I03').Value := 'SEM GTIN'; // EAN do Produto
                    if _ecf65_ValidaGtinNFCe(form7.ibDataSet4.FieldByname('REFERENCIA').AsString) then
                      spdNFeDataSets.Campo('cEAN_I03').Value := LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // EAN do Produto
                    //
                    spdNFeDataSets.Campo('xProd_I04').Value    := ConverteAcentos2(ibDataSet4.FieldByname('DESCRICAO').AsString);// Descrio do PRoduto
                    //
                    // NCM
                    //
                    if Length(Alltrim(LimpaNumero(ibDataSet4.FieldByname('CF').AsString))) = 8 then
                    begin
                      spdNFeDataSets.Campo('NCM_I05').Value      := Alltrim(LimpaNumero(ibDataSet4.FieldByname('CF').AsString)); // Cdigo do NCM - informar de acordo com o Tabela oficial do NCM
                    end else
                    begin
                      //
                      // Servio
                      //
                      spdNFeDataSets.Campo('NCM_I05').Value      := '00'; // Cdigo do NCM - informar de acordo com o Tabela oficial do NCM
                    end;
                    //
                    //
                    spdNFeDataSets.Campo('CFOP_I08').Value     := Alltrim(ibDataSet23.FieldByname('CFOP').AsString); // CFOP incidente neste Item da NF
                    if Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)) <> '' then spdNFeDataSets.Campo('uCom_I09').Value     := ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString) // Unidade de Medida do Item
                      else spdNFeDataSets.Campo('uCom_I09').Value     := 'UND';
                    spdNFeDataSets.Campo('qCom_I10').Value     := StrTran(ibDataSet23.FieldByname('QUANTIDADE').AsString,',','.'); // Quantidade Comercializada do Item
  //                  spdNFeDataSets.Campo('qCom_I10').Value     := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet23.FieldByname('QUANTIDADE').AsFloat)),',','.'); // Quantidade Comercializada do Item
                    spdNFeDataSets.Campo('vUnCom_I10a').Value  := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet23.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Comercializado do Item
                    spdNFeDataSets.Campo('vProd_I11').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat)),',','.'); // Valor Total Bruto do Item
                    //
                    if Form7.ibDataSet4CEST.AsString <> '' then
                    begin
                      spdNFeDataSets.Campo('CEST_I05c').Value    := Form7.ibDataSet4CEST.AsString; // Cdigo CEST
                    end;
                    //
                    // Campo obrigatrio
                    //
                    if ibDataSet24.FieldByname('FRETE').AsFloat    <> 0 then if (fFrete[I])    > 0.01 then spdNFeDataSets.Campo('vFrete_I15').Value  := StrTran(Alltrim(FormatFloat('##0.00',(fFrete[I]))),',','.');    // REGRA DE TRS ratiando o valor do frete Valor Total do Frete
                    if ibDataSet24.FieldByname('SEGURO').AsFloat   <> 0 then if (fSeguro[I])   > 0.01 then spdNFeDataSets.Campo('vSeg_I16').Value    := StrTran(Alltrim(FormatFloat('##0.00',(fSeguro[I]))),',','.');   // REGRA DE TRS ratiando o valor do frete Valor Total do Seguro
                    //
  //                  if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                    begin
                      if ibDataSet24.FieldByname('DESPESAS').AsFloat <> 0 then if (fOutras[I])   > 0.01 then spdNFeDataSets.Campo('vOutro_I17a').Value := StrTran(Alltrim(FormatFloat('##0.00',(fOutras[I]))),',','.');   // REGRA DE TRS ratiando o valor do frete Valor Total do DESPESAS
                    end;
                    //
                    if ibDataSet24.FieldByname('DESCONTO').AsFloat <> 0 then if (fDesconto[I]) > 0.01 then spdNFeDataSets.Campo('vDesc_I17').Value   := StrTran(Alltrim(FormatFloat('##0.00',(fDesconto[I]))),',','.'); // REGRA DE TRS ratiando o valor do frete Valor Total do Desconto
                    //
                    if Alltrim(spdNFeDataSets.Campo('NCM_I05').Value) = '' then
                    begin
                      Form7.ibDataset15.Edit;
                      Form7.ibDataSet15STATUS.AsString    := 'Erro: Informe o NCM do produto '+ConverteAcentos2(ibDataSet4.FieldByname('DESCRICAO').AsString);
                      Abort;
                    end;
                    //
                    if (RetornaValorDaTagNoCampo('cBenef',Form7.ibDataSet4.FieldByname('TAGS_').AsString)<>'') and (RetornaValorDaTagNoCampo('cBenef',Form7.ibDataSet4.FieldByname('TAGS_').AsString)<>'0000000000') then
                    begin
                      //
                      spdNFeDataSets.Campo('cBenef_I05f').Value     := RetornaValorDaTagNoCampo('cBenef',Form7.ibDataSet4.FieldByname('TAGS_').AsString);      // Cdigo de Benefcio Fiscal na UF aplicado ao item
                      //
                    end;

                    //
                    if (Pos(Alltrim(Form7.ibDataSet23.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then // 5104 Industrializao efetuada para outra empresa no soma na base
                    begin
                      spdNFeDataSets.Campo('indTot_I17b').Value   := '1'; // 0 - O valor do Item NO compe o valor total da nota 1 - O valor do Item compe o valor total da nota
                    end else
                    begin
                      spdNFeDataSets.Campo('indTot_I17b').Value   := '0'; // 0 - O valor do Item NO compe o valor total da nota 1 - O valor do Item compe o valor total da nota
                    end;
                    //
                    spdNFeDataSets.Campo('cEANTrib_I12').Value := 'SEM GTIN'; // EAN do Produto
                    //
                    if (RetornaValorDaTagNoCampo('cEANTrib', Form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '') and (_ecf65_ValidaGtinNFCe(RetornaValorDaTagNoCampo('cEANTrib', Form7.ibDataSet4.FieldByname('TAGS_').AsString))) then
                      spdNFeDataSets.Campo('cEANTrib_I12').Value := RetornaValorDaTagNoCampo('cEANTrib', Form7.ibDataSet4.FieldByname('TAGS_').AsString)
                    else
                      if _ecf65_ValidaGtinNFCe(Form7.ibDataSet4.FieldByname('REFERENCIA').AsString) then
                        spdNFeDataSets.Campo('cEANTrib_I12').Value := LimpaNumero(Form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // EAN do Produto
                    //
                    // Quantidade tributvel
                    //
                    if RetornaValorDaTagNoCampo('uTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then
                    begin
                      //
                      spdNFeDataSets.Campo('uTrib_I13').Value    := RetornaValorDaTagNoCampo('uTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      //
                      if LimpaNumero(RetornaValorDaTagNoCampo('qTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        spdNFeDataSets.Campo('qTrib_I14').Value    := FormatFloatXML(ibDataSet23.FieldByname('QUANTIDADE').AsFloat * StrToFloat( RetornaValorDaTagNoCampo('qTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString)  ));  // Quantidade Tributvel do Item
                        spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet23.FieldByname('TOTAL').AsFloat / StrToFloat(StrTran(spdNFeDataSets.Campo('qTrib_I14').AsString,'.',',')))),',','.'); // Valor Tributvel do Item
                      end else
                      begin

                        spdNFeDataSets.Campo('qTrib_I14').Value    := StrTran(ibDataSet23.FieldByname('QUANTIDADE').AsString,',','.');  // Quantidade Tributvel do Item
                        spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet23.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Tributvel do Item
                      end;
                    end else
                    begin
                      if Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)) <> '' then spdNFeDataSets.Campo('uTrib_I13').Value    := ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString) else spdNFeDataSets.Campo('uTrib_I13').Value    := 'UND'; // Unidade de Medida Tributvel do Item
                      spdNFeDataSets.Campo('qTrib_I14').Value    := StrTran(ibDataSet23.FieldByname('QUANTIDADE').AsString,',','.');  // Quantidade Tributvel do Item
                      spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet23.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Tributvel do Item
                    end;
                    //
                    // Combustveis
                    //
                    try
                      //
                      if (copy(ibDAtaSet23CFOP.AsString,2,2)='65') or (copy(ibDAtaSet23CFOP.AsString,2,2)='66') then
                      begin
                        //
                        if RetornaValorDaTagNoCampo('cProdANP',form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then
                        begin
                          sCodigoANP := RetornaValorDaTagNoCampo('cProdANP',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                        end;
                        //
                        while Length(sCodigoANP) <> 9 do
                        begin
                          sCodigoANP := LimpaNumero(Form1.Small_InputForm('Informe o Cdigo ANP:',chr(10)+'Esta informao pode ser digitada'+chr(10)+'no controle de estoque na'+chr(10)+'aba Tags: cProdANP: 000000000', ''));
                        end;
                        //
                        if Length(sCodigoANP) = 9 then
                        begin
                          //
                          if RetornaValorDaTagNoCampo('cProdANP',form7.ibDataSet4.FieldByname('TAGS_').AsString) = '' then
                          begin
                            if not (Form7.ibDataset4.State in ([dsEdit, dsInsert])) then Form7.ibDataset4.Edit;
                            Form7.ibDataSet4TAGS_.AsString := Form7.ibDataSet4TAGS_.AsString + chr(10) + '<cProdANP>'+sCodigoANP + '</cProdANP>';
                            Form7.ibDataset4.Post;
                            Form7.ibDataset4.Edit;
                          end;
                          //
                          spdNFeDataSets.incluirPart('L1');
                          spdNFeDataSets.Campo('cProdANP_LA02').value := sCodigoANP; // Cdigo de produto da ANP
                          spdNFeDataSets.Campo('UFCons_LA06').value   := ibDAtaSet99.FieldByname('UF').AsString; // Sigla do Estado do Destinatrio
                          //
                          if Form1.sVersaoLayout = '4.00' then
                          begin
                            //
                            if (RetornaValorDaTagNoCampo('descANP', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') then
                            begin
                              ShowMessage('Incluir no controle de estoque na aba Tags: descANP: Descrio do produto conforme ANP');
                            end else
                            begin
                              spdNFeDataSets.campo('descANP_LA03').Value := RetornaValorDaTagNoCampo('descANP',Form7.ibDataSet4TAGS_.AsString);                                                  // Descrio do produto conforme ANP
                            end;
                            //
                            if (spdNFeDataSets.Campo('cProdANP_LA02').Value = '210203001') then
                            begin
                              //
                              if (RetornaValorDaTagNoCampo('pGLP', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') or
                                 (RetornaValorDaTagNoCampo('pGNn', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') or
                                 (RetornaValorDaTagNoCampo('pGNi', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') then
                              begin
                                ShowMessage('Incluir no controle de estoque na aba Tags:'+
                                            Chr(10)+
                                            Chr(10)+'pGLP: 0,0000'+
                                            Chr(10)+'pGNn: 0,0000'+
                                            Chr(10)+'pGNi: 0,0000'+
                                            Chr(10)+'vPart: 0,00'
                                            );
                                Abort;
                              end else
                              begin
                                //
                                if (StrToFloatDef(RetornaValorDaTagNoCampo('pGLP', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                + StrToFloatDef(RetornaValorDaTagNoCampo('pGNn', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                + StrToFloatDef(RetornaValorDaTagNoCampo('pGNi', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)) <> 100 then
                                begin
                                  //
                                  ShowMessage('Erro: LA01 grupo LA Combustvel (pGLP + pGNn + pGNi) = '
                                  + FormatFloat('#,##0.0000', StrToFloatDef(RetornaValorDaTagNoCampo('pGLP', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                  + StrToFloatDef(RetornaValorDaTagNoCampo('pGNn', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                  + StrToFloatDef(RetornaValorDaTagNoCampo('pGNi', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)) + '%' + Chr(10)
                                  + 'Rejeio: Somatrio percentuais de GLP derivado do petrleo, pGLP(id:LA03a) e pGNn(id:LA03b) e pGNi(id:LA03c) diferente de 100. Verifique no cadastro do produto '
                                                            + Chr(10) + spdNFeDataSets.Campo('cProd_I02').Value + ' ' + spdNFeDataSets.Campo('xProd_I04').Value);
                                  Abort;
                                  //
                                end else
                                begin
                                  spdNFeDataSets.Campo('pGLP_LA03a').Value   := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pGLP', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0),4);  // Percentual do GLP derivado do petrleo no produto GLP (cProdANP=210203001) E LA01 N 0-1 3v4 Informar em nmero decimal o percentual do GLP derivado de petrleo no produto GLP. Valores de 0 a 100.
                                  spdNFeDataSets.Campo('pGNn_LA03b').Value   := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pGNn', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0),4);  // Percentual de Gs Natural Nacional  GLGNn para o produto GLP (cProdANP=210203001) E LA01 N 0-1 3v4 Informar em nmero decimal o percentual do Gs Natural Nacional  GLGNn para o produto GLP. Valores de 0 a 100.
                                  spdNFeDataSets.Campo('pGNi_LA03c').Value   := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pGNi', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0),4);  // Percentual de Gs Natural Importado  GLGNi para o produto GLP (cProdANP=210203001) E LA01 N 0-1 3v4 Informar em nmero decimal o percentual do Gs Natural Importado  GLGNi para o produto GLP. Valores de 0 a 100.
                                  //
                                end;
                              end;
                            end;
                            //
                            if RetornaValorDaTagNoCampo('vPart', Form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then spdNFeDataSets.Campo('vPart_LA03d').Value := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('vPart', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)); // Valor de partida (cProdANP=210203001)
                            //
                          end;
                          //
                          spdNFeDataSets.SalvarPart('L1');
                          //
                        end;
                        //
                      end;
                    except end;
      ///////////////////////////////
      //
      // TAGS - ENTRADA
      //
      ///////////////////////////////
                    //
                    //////////////////// Aqui comeam os Impostos Incidentes sobre o Item////////////////////////
                    /// Verificar Manual pois existe uma variao nos campos de acordo com Tipo de Tribucao ////
                    // ICMS
                    //
                    fPercentualFCP := 0;
                    //
                    if (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) <> '1') then
                    begin
                      //
                      // 1 - Simples nacional
                      // 2 - Simples nacional - Excesso de Sublimite de Receita Bruta
                      // 3 - Regime normal
                      //
                      // N11 e N12 todos Tem
                      //
                      try
                        if AllTrim(ibDAtaSet14.FieldByName('CST').AsString) <> '' then
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                          spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                          spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                        end;
                      except
                        spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                        spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                      end;
                      //
                      // Tem que voltar ao CFOP original da nota
                      //

                      //
                      // Posiciona na tabla de CFOP
                      //
                      Form7.ibDataSet14.DisableControls;
                      Form7.ibDataSet14.Close;
                      Form7.ibDataSet14.SelectSQL.Clear;
                      Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''1'' or  SubString(CFOP from 1 for 1) = ''2'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''3''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                      Form7.ibDataSet14.Open;
                      Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet24OPERACAO.AsString,[]);
                      Form7.ibDataSet14.EnableControls;
                      //
                      // TAGS
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '00')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '10')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '20')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '51')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '70')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        if (ibDataSet23.FieldByname('BASE').AsFloat = 0) then
                        begin
                          spdNFeDataSets.Campo('vBC_N15').Value   := '0'; // Valor da Base de Clculo do ICMS
                          spdNFeDataSets.Campo('vICMS_N17').Value := '0'; // Valor do ICMS em Reais
                        end else
                        begin
                          spdNFeDataSets.Campo('vBC_N15').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBC').AsFloat)),',','.');  // BC
                          spdNFeDataSets.Campo('vICMS_N17').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMS').AsFloat)),',','.');     // Valor do ICMS em Reais
                        end;
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '00' then
                      begin
                        //
                        // St 00
                        //
                        spdNFeDataSets.Campo('modBC_N13').Value   := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        spdNFeDataSets.Campo('pICMS_N16').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        //
                        //
                      end;
                      //
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '10')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '30')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '60')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '70')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        // St 60 s tem N21 e N23
                        //
                        if Form7.ibDataSet24BASESUBSTI.AsFloat <> 0 then
                        begin
                          //
                          if spdNFeDataSets.Campo('CST_N12').AssTring <> '60' then
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value      := '100'; // Percentual de margem de valor adicionado do ICMS ST
                          end;
                          //
                          spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBCST').AsFloat)),',','.');    // Valor da BC do ICMS ST
                          spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMSST').AsFloat)),',','.');  // VAlor do ICMS ST
                          //
                          if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                          begin
                            //
                            // FICHA 2786
                            //
                            spdNFeDataSets.Campo('vbCSTRet_N26').Value          := '0.00'; // Valor cobrado anteriormente por ST Ok
                            spdNFeDataSets.Campo('pST_N26a').Value              := '0.00'; // Aliquota suportada pelo consumidor
                            spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                            spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := '0.00'; // Valor do ICMS ST em Reais
                            //
                          end else
                          begin
                            //
                            spdNFeDataSets.Campo('vbCSTRet_N26').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBCST').AsFloat)),',','.');  // Valor do BC do ICMS ST retido na UF Emitente ok
                            spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMSST').AsFloat)),',','.');  //  Valor do ICMS ST retido na UF Emitente
                            //
                          end;
                          //
                        end else
                        begin
                          //
                          if spdNFeDataSets.Campo('CST_N12').AssTring <> '60' then
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value      := '0'; // Percentual de margem de valor adicionado do ICMS ST
                          end else
                          begin
                            spdNFeDataSets.Campo('pST_N26a').Value      := '0.00'; // Aliquota suportada pelo consumidor
                            spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                          end;
                          //
                          spdNFeDataSets.Campo('vbCST_N21').Value       := '0.00'; // Valor cobrado anteriormente por ST
                          spdNFeDataSets.Campo('vICMSST_N23').Value     := '0.00';  // Valor do ICMS ST em Reais
                          //
                          spdNFeDataSets.Campo('vbCSTRet_N26').Value    := '0.00'; // Valor cobrado anteriormente por ST Ok
                          spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := '0.00'; // Valor do ICMS ST em Reais
                          //
                        end;
                        //
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '10' then
                      begin
                        //
                        // St 10
                        //
                        spdNFeDataSets.Campo('modBC_N13').Value     := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        //
                        if ibDataSet23.FieldByname('VBCST').AsFloat > 0 then spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBCST').AsFloat) * 100))),',','.');  // Aliquota do Imposto do ICMS ST
                        //
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '40') or (spdNFeDataSets.Campo('CST_N12').AssTring = '41') or (spdNFeDataSets.Campo('CST_N12').AssTring = '50') then
                      begin
  //                      spdNFeDataSets.Campo('vICMS_N17').Value       := ''; // Valor do ICMS em Reais
  //                      spdNFeDataSets.Campo('motDesICMS_N28').Value  := '9'; // Motivo da desonerao do ICMS
                        spdNFeDataSets.Campo('vbCSTRet_N26').Value    := '';  // Valor cobrado anteriormente por ST
                        spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := '';  // Valor do ICMS ST em Reais
                        spdNFeDataSets.Campo('vBCSTDest_N31').Value   := '';  // Valor da BC do ICMS ST da UF Destino
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '20') or (spdNFeDataSets.Campo('CST_N12').AssTring = '51') then
                      begin
                        //
                        // St 20
                        //
                        spdNFeDataSets.Campo('modBC_N13').Value     := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        //
                        if (100-ibDataSet23.FieldByname('BASE').AsFloat) = 100 then
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := '100'; // Percentual da reduo de BC
                        end else
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet23.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        end;
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '51' then
                        begin
                          try
                            //
                            spdNFeDataSets.Campo('vICMSOp_N16a').Value   := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet23.FieldByname('ICM').AsFloat*(ibDataSet23.FieldByname('TOTAL').AsFloat)/100*ibDataSet23.FieldByname('BASE').AsFloat/100,2))),',','.');
                            spdNFeDataSets.Campo('pDif_N16b').Value      := '100';
                            spdNFeDataSets.Campo('vICMSDif_N16c').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('ICM').AsFloat*(ibDataSet23.FieldByname('TOTAL').AsFloat)/100*ibDataSet23.FieldByname('BASE').AsFloat/100)),',','.');
                            //
                            // Ficha 2756
                            //
                            spdNFeDataSets.Campo('vICMS_N17').Value      := '0'; // Valor do ICMS em Reais
                            //
                          except
                            on E: Exception do
                            begin
                              Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+' Erro: 2756'
                              ),'Ateno',mb_Ok + MB_ICONWARNING);
                            end;
                          end;
                          //
                        end;
                        //
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '30' then
                      begin
                        //
                        // St 30
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        if ibDataSet23.FieldByname('VBCST').AsFloat > 0 then spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBCST').AsFloat) * 100))),',','.');  // Aliquota do Imposto do ICMS ST
                       //
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                      begin
                        //
                        // St 60
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        if ibDataSet23.FieldByname('VBCST').AsFloat > 0 then spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBCST').AsFloat) * 100))),',','.');  // Aliquota do Imposto do ICMS ST
                        //
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '70')
                      or  (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        // St 70
                        //
                        spdNFeDataSets.Campo('modBC_N13').Value     := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        //
                        if (100-ibDataSet23.FieldByname('BASE').AsFloat) = 100 then
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := '100'; // Percentual da reduo de BC
                        end else
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet23.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        end;
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                        if ibDataSet23.FieldByname('VBCST').AsFloat > 0 then spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBCST').AsFloat) * 100))),',','.') else spdNFeDataSets.Campo('pICMSST_N22').Value   := '0.00';  // Aliquota do Imposto do ICMS ST
                        //
                      end;
                      //
                      if LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) = '1' then
                      begin
                        spdNFeDataSets.Campo('vBC_N15').Value     := '0';  // BC
                        spdNFeDataSets.Campo('vICMS_N17').Value   := '0';  // Valor do ICMS em Reais
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '30') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '40') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '41') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '50') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '60') then
                      begin
  //                      spdNFeDataSets.Campo('vBC_N15').Value     := '0';  // BC
  //                      spdNFeDataSets.Campo('vICMS_N17').Value   := '0';  // Valor do ICMS em Reais
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '30') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '10') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '70') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                      end;
                      //
                      if Form1.sVersaoLayout = '4.00' then
                      begin
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                        begin
                          //
                          spdNFeDataSets.campo('pST_N26a').Value                := '0.00'; // Alquota suportada pelo Consumidor Final
                          spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value    := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                          //
                          if Pos(sCodigoANP,pChar('210203001, 320101001, 320101002, 320102002, 320102001, 320102003, 320102005, 320201001, 320103001,'+
                                            '220102001, 320301001, 320103002, 820101032, 820101026, 820101027, 820101004, 820101005, 820101022,'+
                                            '820101031, 820101030, 820101014, 820101006, 820101016, 820101015, 820101025, 820101017, 820101018,'+
                                            '820101019, 820101020, 820101021, 420105001, 420101005, 420101004, 420102005, 420102004, 420104001,'+
                                            '820101033, 820101034, 420106001, 820101011, 820101003, 820101013, 820101012, 420106002, 830101001,'+
                                            '420301004, 420202001, 420301001, 420301002, 410103001, 410101001, 410102001, 430101004, 510101001,'+
                                            '510101002, 510102001, 510102002, 510201001, 510201003, 510301003, 510103001, 510301001')) <> 0 then
                          begin
                            spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                            spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                            spdNFeDataSets.Campo('vbCSTRet_N26').Value    := '0.00';  // Valor cobrado anteriormente por ST Ok
                            spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := '0.00';  // Valor do ICMS ST em Reais
                            spdNFeDataSets.Campo('vBCSTDest_N31').Value   := '0.00';  // Valor da BC do ICMS ST da UF Destino
                            spdNFeDataSets.Campo('vICMSSTDest_N32').Value := '0.00';  // Informar o valor do ICMS ST da UF destino
                          end;
                          //
                        end;
                      end;
                      //
                      //
                      // Entrada empresa no Regime normal por CST
                      //
                      {
                      if Form1.sVersaoLayout = '4.00' then
                      begin
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '00' then
                        begin
                          //
                          spdNFeDataSets.campo('pFCP_N17b').Value     := '0.00'; // Percentual do Fundo de Combate  Pobreza (FCP)
                          spdNFeDataSets.campo('vFCP_N17c').Value     := '0.00'; // Valor do Fundo de Combate  Pobreza (FCP)
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '10' then
                        begin
                          //
                          spdNFeDataSets.campo('vBCFCP_N17a').Value   := '0.00'; // Valor da Base de Clculo do FCP
                          spdNFeDataSets.campo('pFCP_N17b').Value     := '0.00'; // Percentual do Fundo de Combate  Pobreza (FCP)
                          spdNFeDataSets.campo('vFCP_N17c').Value     := '0.00'; // Valor do Fundo de Combate  Pobreza (FCP)
                          //
                          spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '20' then
                        begin
                          //
                          spdNFeDataSets.campo('vBCFCP_N17a').Value   := '0.00'; // Valor da Base de Clculo do FCP
                          spdNFeDataSets.campo('pFCP_N17b').Value     := '0.00'; // Percentual do Fundo de Combate  Pobreza (FCP)
                          spdNFeDataSets.campo('vFCP_N17c').Value     := '0.00'; // Valor do Fundo de Combate  Pobreza (FCP)
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '30' then
                        begin
                          //
                          spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '51' then
                        begin
                          //
                          spdNFeDataSets.campo('vBCFCP_N17a').Value   := '0.00'; // Valor da Base de Clculo do FCP
                          spdNFeDataSets.campo('pFCP_N17b').Value     := '0.00'; // Percentual do Fundo de Combate  Pobreza (FCP)
                          spdNFeDataSets.campo('vFCP_N17c').Value     := '0.00'; // Valor do Fundo de Combate  Pobreza (FCP)
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                        begin
                          //
                          spdNFeDataSets.campo('pST_N26a').Value       := '0.00'; // Alquota suportada pelo Consumidor Final
                          //
                          spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                          //
                        end;
                        //
                        if (spdNFeDataSets.Campo('CST_N12').AssTring = '70') or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                        begin
                          //
                          spdNFeDataSets.campo('vBCFCP_N17a').Value   := '0.00'; // Valor da Base de Clculo do FCP
                          spdNFeDataSets.campo('pFCP_N17b').Value     := '0.00'; // Percentual do Fundo de Combate  Pobreza (FCP)
                          spdNFeDataSets.campo('vFCP_N17c').Value     := '0.00'; // Valor do Fundo de Combate  Pobreza (FCP)
                          //
                          spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                          spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                          //
                        end;
                      end;
                      }
                      ///////////////////////////////
                      //
                      // TAGS - ENTRADA - End CST
                      //
                      ///////////////////////////////
                    end;
                    //
                    // TAGS - Simples NAcional - CSOSN
                    //
                    if LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) = '1' then
                    begin

                      // 1 - Simples nacional
                      // 2 - Simples nacional - Excesso de Sublimite de Receita Bruta
                      // 3 - Regime normal


                      //
                      // N12a Tem em todas - e e referencia para classificar as tags
                      //
                      if AllTrim(ibDAtaSet14.FieldByName('CSOSN').AsString) <> '' then
                      begin
                        spdNFeDataSets.Campo('CSOSN_N12a').Value  := ibDataSet14.FieldByname('CSOSN').AsString;
                      end else
                      begin
                        spdNFeDataSets.Campo('CSOSN_N12a').Value  := ibDataSet4.FieldByname('CSOSN').AsString;
                      end;
                      //
                      // N11 - Tem em todas
                      //
                      try
                        if AllTrim(ibDAtaSet14.FieldByName('CST').AsString) <> '' then
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                        end else
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                        end;
                      except
                        spdNFeDataSets.Campo('orig_N11').Value   := '0';
                      end;
                      //
                      if  (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '101') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '102') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '103') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '201') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '202') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '203') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '300') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '400') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '500') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '900') then
                      begin
                        //
                        Form7.ibDataset15.Edit;
                        Form7.ibDataSet15STATUS.AsString    := 'Erro: Informe o CSOSN do produto '+ConverteAcentos2(ibDataSet4.FieldByname('DESCRICAO').AsString);
                        Abort;
                        //
                      end;
                      //
                      // CSOSN 101
                      //
                      if spdNFeDataSets.Campo('CSOSN_N12a').Value = '101' then
                      begin
                        //
                        // 101 Tributada pelo simples nacional com permisso de credito
                        //
                        fAliquota := 2.82;
                        //
                        spdNFeDataSets.Campo('pCredSN_N29').VAlue       := StrTran(Alltrim(FormatFloat('##0.00',fAliquota)),',','.'); // Aliquota aplicave de clculo de crdito (Simples Nacional)
                        spdNFeDataSets.Campo('vCredICMSSN_N30').VAlue   := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet23.FieldByname('TOTAL').AsFloat * fAliquota / 100)),',','.'); // VAlor de crdito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)
                        //
                      end;
                      //
                      // CSOSN 102, 103, 300, 400
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '102')
                      or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '103')
                      or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '300')
                      or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '400') then
                      begin
                        //
                        // N11 - J esta preenchido acima todos tem
                        //
                      end;
                      //
                      // CSOSN 201 - Tributado pelo Simples Nacional Com permisso de Crdito e com cobrana do ICMS por substituio Tributria
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '201') then
                      begin
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pMVAST_N19').Value    := '100'; // Percentual de margem de valor adicionado do ICMS ST
                        spdNFeDataSets.Campo('pREDBCST_N20').Value  := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                        fAliquota := 2.82;
                        //
                        if Form7.ibDataSet23.FieldByname('BASE').AsFloat > 0 then
                        begin
                          //
                          spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBCST').AsFloat)),',','.');    // Valor da BC do ICMS ST
                          spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMSST').AsFloat)),',','.');  // VAlor do ICMS ST
                          //
                        end;
                        //
                        if ibDataSet23.FieldByname('VBCST').AsFloat > 0 then spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBCST').AsFloat) * 100))),',','.');  // Aliquota do Imposto do ICMS ST
                        spdNFeDataSets.Campo('pCredSN_N29').VAlue     := StrTran(Alltrim(FormatFloat('##0.00',fAliquota)),',','.'); // Aliquota aplicave de clculo de crdito (Simples Nacional)
                        spdNFeDataSets.Campo('vCredICMSSN_N30').VAlue := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet23.FieldByname('TOTAL').AsFloat * fAliquota / 100)),',','.'); // VAlor de crdito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)
                        //
                      end;
                      //
                      // CSOSN 202, 203 -
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '202') or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '203') then
                      begin
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pMVAST_N19').Value      := '100'; // Percentual de margem de valor adicionado do ICMS ST
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                        if Form7.ibDataSet23.FieldByname('BASE').AsFloat > 0 then
                        begin
                          //
                          spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBCST').AsFloat)),',','.');    // Valor da BC do ICMS ST
                          spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMSST').AsFloat)),',','.');  // VAlor do ICMS ST
                          //
                        end;
                        //
                        if ibDataSet23.FieldByname('VBCST').AsFloat > 0 then spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBCST').AsFloat) * 100))),',','.');  // Aliquota do Imposto do ICMS ST
                        //
                      end;
                      //
                      // CSOSN 500
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '500') then
                      begin
                        //
                        spdNFeDataSets.Campo('pST_N26a').Value                  := '0.00'; // Aliquota suportada pelo consumidor
                        spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value      := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                        spdNFeDataSets.Campo('vbCSTRet_N26').Value              := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBCST').AsFloat)),',','.');  // Valor do BC do ICMS ST retido na UF Emitente ok
                        spdNFeDataSets.Campo('vICMSSTRet_N27').Value            := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMSST').AsFloat)),',','.');  //  Valor do ICMS ST retido na UF Emitente
                        //
                      end;
                      //
                      // CSOSN 900
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '900') then
                      begin
                        //
                        // 900  Outros  Classificam-se neste cdigo as demais operaes que no se enquadrem nos cdigos 101, 102, 103, 201, 202, 203, 300, 400 e 500.
                        //
                        // N11 - J est preenchido acima - todos tem
                        // N12a - J est preenchido acima - todos tem
                        spdNFeDataSets.Campo('modBC_N13').Value  := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        //
                        if (ibDataSet23.FieldByname('BASE').AsFloat = 0) then
                        begin
                          spdNFeDataSets.Campo('vBC_N15').Value   := '0'; // Valor da Base de Clculo do ICMS
                          spdNFeDataSets.Campo('vICMS_N17').Value := '0'; // Valor do ICMS em Reais
                        end else
                        begin
                          //
                          spdNFeDataSets.Campo('vBC_N15').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBC').AsFloat)),',','.');  // BC
                          spdNFeDataSets.Campo('vICMS_N17').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMS').AsFloat)),',','.');     // Valor do ICMS em Reais
                          //
                        end;
                        //
                        if (100-ibDataSet23.FieldByname('BASE').AsFloat) <> 0 then
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet23.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        end else
                        begin
  //                            spdNFeDataSets.Campo('pRedBC_N14').Value := '100';
                        end;
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          if Form7.ibDataSet23.FieldByname('BASE').AsFloat > 0 then
                          begin
                            // (1.3 * 100) - 100

                            spdNFeDataSets.Campo('pMVAST_N19').Value := StrTran(Alltrim(FormatFloat('##0.00', (Form7.ibDataset4PIVA.AsFloat*100)-100 )),',','.'); // Percentual de margem de valor adicionado do ICMS ST
                          end else
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                          end;
                        end else
                        begin
                          spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                        end;
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                        if Form7.ibDataSet23.FieldByname('VBCST').AsFloat > 0 then
                        begin
                          //
                          try
                            spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBCST').AsFloat)),',','.');    // Valor da BC do ICMS ST
                            spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet23.FieldByname('VICMSST').AsFloat / ibDataSet23.FieldByname('VBC').AsFloat) * 100))),',','.');  // Aliquota do Imposto do ICMS ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMSST').AsFloat)),',','.');  // VAlor do ICMS ST
                          except
                            spdNFeDataSets.Campo('vbCST_N21').Value     :=  '0'; // Valor da BC do ICMS ST
                            spdNFeDataSets.Campo('pICMSST_N22').Value   :=  '0'; // Aliquota do Imposto do ICMS ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value   :=  '0'; // VAlor do ICMS ST
                          end;
                          //
                        end else
                        begin
                          //
                          spdNFeDataSets.Campo('vbCST_N21').Value     :=  '0'; // Valor da BC do ICMS ST
                          spdNFeDataSets.Campo('pICMSST_N22').Value   :=  '0'; // Aliquota do Imposto do ICMS ST
                          spdNFeDataSets.Campo('vICMSST_N23').Value   :=  '0'; // VAlor do ICMS ST
                          //
                        end;
                        //
                        spdNFeDataSets.Campo('pCredSN_N29').VAlue       := StrTran(Alltrim(FormatFloat('##0.00',fAliquota)),',','.'); // Aliquota aplicave de clculo de crdito (Simples Nacional)
                        spdNFeDataSets.Campo('vCredICMSSN_N30').VAlue  := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet23.FieldByname('TOTAL').AsFloat * fAliquota / 100)),',','.'); // VAlor de crdito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)
                        //
                        if Form1.sVersaoLayout = '4.00' then
                        begin
                          //
                          // Nf de entrada Entrada Simples Nacinal
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            //
                            if spdNFeDataSets.Campo('CSOSN_N12a').Value = '201' then
                            begin
                              spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                            end;
                            //
                            if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '202') or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '203') then
                            begin
                              spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                            end;
                            //
                            if (ibDataSet4.FieldByname('CSOSN').AsString = '900') then
                            begin
                              spdNFeDataSets.campo('vBCFCPST_N23a').Value  := '0.00'; // Valor da Base de Clculo do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('pFCPST_N23b').Value    := '0.00'; // Percentual do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := '0.00'; // Valor do FCP retido por Substituio Tributria
                            end;
                          end;
                        end;
                        //
                      end;
                    end;
      ///////////////////////////////
      //
      // FIM TAGS - ENTRADA
      //
      ///////////////////////////////
                    //
                    // IPI
                    //
                    if AllTrim(ibDataSet23.FieldByname('CST_IPI').AsString) <> '' then
                    begin
                      //
                      // CST IPI
                      //
                      // 00 Entrada com recuperao de crdito
                      // 01 Entrada tributada com alquota zero
                      // 02 Entrada isenta
                      // 03 Entrada no-tributada
                      // 04 Entrada imune
                      // 05 Entrada com suspenso
                      // 49 Outras entradas
                      // 50 Sada tributada
                      // 51 Sada tributada com alquota zero
                      // 52 Sada isenta
                      // 53 Sada no-tributada
                      // 54 Sada imune
                      // 55 Sada com suspenso
                      // 99 Outras sadas
                      //
                      if Form1.sVersaoLayout = '4.00' then
                      begin
                      end else
                      begin
                        spdNFeDataSets.Campo('clEnq_O02').Value     := 'NDA'; // Classe de enquadramento do IPI para cigarros e Bebidas
                      end;
                      //
                      spdNFeDataSets.Campo('CNPJProd_O03').Value  := '00000000000000'; // CNPJ do produtor quando diferente do emitente
                      spdNFeDataSets.Campo('cSelo_O04').Value     := '';   // Cdigo do celo de controle IPI
                      spdNFeDataSets.Campo('qSelo_O05').Value     := '0';   // Quantidade de celo de controle
                      spdNFeDataSets.Campo('cEnq_O06').Value      := '999'; // Tabela RFB - Ainda no foi criada
                      spdNFeDataSets.Campo('CST_O09').Value       := ibDataSet23.FieldByname('CST_IPI').AsString;
                      spdNFeDataSets.Campo('vBC_O10').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da BC do IPI
                      spdNFeDataSets.Campo('pIPI_O13').Value      := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('IPI').AsFloat)),',','.'); // Percentual do IPI
                      spdNFeDataSets.Campo('vIPI_O14').Value      := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet23.FieldByname('IPI').AsFloat*ibDataSet23.FieldByname('TOTAL').AsFloat/100,2))),',','.'); // Valor do IPI
                      //
                    end;
                    //
                    // PIS / COFINS
                    //
                    if AllTrim(sCST_PIS_COFINS) <> '' then
                    begin
                      //
                      // Pega o CST PIS COFINS e o PERCENTUAL da Tabela
                      //
                      spdNFeDataSets.Campo('CST_Q06').Value     := sCST_PIS_COFINS;
                      //
                      if rpPIS <> 0 then
                      begin
                        spdNFeDataSets.Campo('vBC_Q07').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := StrTran(Alltrim(FormatFloat('##0.00',rpPIS)),',','.'); // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat*rpPIS/100)),',','.'); // Valor do PIS em Reais
                        vPIS := vPIS + arredonda(ibDataSet23.FieldByname('TOTAL').AsFloat*rpPIS/100,2);
                      end else
                      begin
                        spdNFeDataSets.Campo('vBC_Q07').Value     := '0.00'; // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := '0.00'; // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := '0.00'; // Valor do PIS em Reais
                      end;
                      //
                    end else
                    begin
                      //
                      if (Form7.ibDAtaSet4ALIQ_PIS_ENTRADA.AsFloat <> 0) then
                      begin
                        //
                        // Pega o CST PIS COFINS e o PERCENTUAL do iten
                        //
                        spdNFeDataSets.Campo('CST_Q06').Value     := Form7.ibDAtaSet4CST_PIS_COFINS_ENTRADA.AsString;
                        spdNFeDataSets.Campo('vBC_Q07').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet4ALIQ_PIS_ENTRADA.AsFloat)),',','.'); // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat*ibDataSet4ALIQ_PIS_ENTRADA.AsFloat/100)),',','.'); // Valor do PIS em Reais
                        vPIS := vPIS + arredonda(ibDataSet23.FieldByname('TOTAL').AsFloat*ibDataSet4ALIQ_PIS_ENTRADA.AsFloat/100,2);
                        //
                        // vPIS := vPIS + ibDataSet23.FieldByname('TOTAL').AsFloat*ibDataSet4ALIQ_PIS_ENTRADA.AsFloat/100;
                        //
                      end else
                      begin
                        //
                        if AllTrim(Form7.ibDAtaSet4CST_PIS_COFINS_ENTRADA.AsString) = '' then
                        begin
                          spdNFeDataSets.Campo('CST_Q06').Value     := '08';   // Codigo de Situacao Tributria - ver opes no Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('CST_Q06').Value     := Form7.ibDAtaSet4CST_PIS_COFINS_ENTRADA.AsString;
                        end;
                        //
                        spdNFeDataSets.Campo('vBC_Q07').Value     := '0.00'; // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := '0.00'; // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := '0.00'; // Valor do PIS em Reais
                        //
                      end;
                    end;
                    //
                    // COFINS
                    //
                    if AllTrim(sCST_PIS_COFINS) <> '' then
                    begin
                      //
                      spdNFeDataSets.Campo('CST_S06').Value        := sCST_PIS_COFINS;
                      //
                      if rpCOFINS <> 0 then
                      begin
                        spdNFeDataSets.Campo('vBC_S07').Value        := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := StrTran(Alltrim(FormatFloat('##0.00',rpCOFINS)),',','.'); // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat*rpCOFINS/100)),',','.'); // Valor do COFINS em Reais
                        //
                        vCOFINS := vCOFINS + arredonda(ibDataSet23.FieldByname('TOTAL').AsFloat*rpCOFINS/100,2);
                        //
                      end else
                      begin
                        spdNFeDataSets.Campo('vBC_S07').Value        := '0.00'; // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := '0.00'; // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := '0.00'; // Valor do COFINS em Reais
                      end;
                    end else
                    begin
                      //
                      if (Form7.ibDAtaSet4ALIQ_COFINS_ENTRADA.AsFloat <> 0) then
                      begin
                        //
                        // Pega o CST PIS COFINS e o PERCENTUAL do iten
                        //
                        spdNFeDataSets.Campo('CST_S06').Value        := Form7.ibDAtaSet4CST_PIS_COFINS_ENTRADA.AsString;
                        spdNFeDataSets.Campo('vBC_S07').Value        := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat)),',','.'); // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('TOTAL').AsFloat*ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat/100)),',','.'); // Valor do COFINS em Reais
                        //
                        vCOFINS := vCOFINS + arredonda(ibDataSet23.FieldByname('TOTAL').AsFloat*ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat/100,2);
                        //
                        // vCOFINS := vCOFINS + ibDataSet23.FieldByname('TOTAL').AsFloat*ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat/100;
                        //
                      end else
                      begin
                        //
                        if AllTrim(Form7.ibDAtaSet4CST_PIS_COFINS_ENTRADA.AsString) = '' then
                        begin
                          spdNFeDataSets.Campo('CST_S06').Value     := '08';   // Codigo de Situacao Tributria - ver opes no Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('CST_S06').Value     := Form7.ibDAtaSet4CST_PIS_COFINS_ENTRADA.AsString;
                        end;
                        //
                        spdNFeDataSets.Campo('vBC_S07').Value        := '0.00'; // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := '0.00'; // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := '0.00'; // Valor do COFINS em Reais
                        //
                      end;
                    end;
                    //
                    // THE END PIS/COFINS
                    //
                    // Importao
                    //
                    if sEx3 <> '' then
                    begin
                      //
                      // Controle de importao por Item
                      //
                      Mais1ini := TIniFile.Create(Form1.sAtual+'\importac.ini');
                      //
                      sEx8   := Mais1Ini.ReadString('DI','Ex8','0');
                      sEx9   := Mais1Ini.ReadString('DI','Ex9','0');
                      sEx10  := Mais1Ini.ReadString('DI','Ex10','0');
                      sEx11  := Mais1Ini.ReadString('DI','Ex11','0');
                      sEx12  := Mais1Ini.ReadString('DI','Ex12','0');
                      sEx13  := Mais1Ini.ReadString('DI','Ex13','0');
                      sEx14  := Mais1Ini.ReadString('DI','Ex14','0');
                      sEx18  := Mais1Ini.ReadString('DI','Ex18','0');
                      //
                      Form29.Label_01.Visible := True;
                      Form29.Label_02.Visible := True;
                      Form29.Label_03.Visible := True;
                      Form29.Label_04.Visible := True;
                      Form29.Label_05.Visible := True;
                      Form29.Label_06.Visible := True;
                      Form29.Label_07.Visible := True;
                      Form29.Label_08.Visible := True;
                      //
                      Form29.Edit_01.Visible := True;
                      Form29.Edit_02.Visible := True;
                      Form29.Edit_03.Visible := True;
                      Form29.Edit_04.Visible := True;
                      Form29.Edit_05.Visible := True;
                      Form29.Edit_06.Visible := True;
                      Form29.Edit_07.Visible := True;
                      Form29.Edit_08.Visible := True;
                      //
                      Form29.Label_01.Caption := 'Base de Calculo (BC):';
                      Form29.Label_02.Caption := 'Despesas aduaneiras:';
                      Form29.Label_03.Caption := 'Valor do Imposto de Importao (II):';
                      Form29.Label_04.Caption := 'Valor do Imposto sobre Operaes Financeiras (IOF):';
                      Form29.Label_05.Caption := 'Valor da Base de Calculo do IPI:';
                      Form29.Label_06.Caption := 'Valor de AFRMM (Adicional ao Frete para Renovao da Marinha Mercante):';
                      Form29.Label_07.Caption := 'Nmero do ato concessrio de Drawback:';
                      Form29.Label_08.Caption := 'Via de transporte internacional informada (DI):'+chr(10)+chr(10)+
                                                 '1=Martima;'+chr(10)+
                                                 '2=Fluvial;'+chr(10)+
                                                 '3=Lacustre;'+chr(10)+
                                                 '4=Area;'+chr(10)+
                                                 '5=Postal;'+chr(10)+
                                                 '6=Ferroviria;'+chr(10)+
                                                 '7=Rodoviria;'+chr(10)+
                                                 '8=Conduto / Rede Transmisso;'+chr(10)+
                                                 '9=Meios Prprios;'+chr(10)+
                                                 '10=Entrada / Sada ficta; 11=Courier; 12=Handcarry.';
                      //
                      Form29.Edit_01.Text := sEx8;
                      Form29.Edit_02.Text := sEx9;
                      Form29.Edit_03.Text := sEx10;
                      Form29.Edit_04.Text := sEx11;
                      Form29.Edit_05.Text := sEx18;
                      Form29.Edit_06.Text := sEx13;
                      Form29.Edit_07.Text := sEx14;
                      Form29.Edit_08.Text := sEx12;
                      //
                      Form1.Small_InputForm_Dados('Importao do Item: '+ibDataSet4.FieldByname('DESCRICAO').AsString);
                      //
                      sEx8   := Form29.Edit_01.Text;
                      sEx9   := Form29.Edit_02.Text;
                      sEx10  := Form29.Edit_03.Text;
                      sEx11  := Form29.Edit_04.Text;
                      sEx18  := Form29.Edit_05.Text;
                      sEx13  := Form29.Edit_06.Text;
                      sEx14  := Form29.Edit_07.Text;
                      sEx12  := Form29.Edit_08.Text;
                      //
                      //
                      try
                        //
                        spdNFeDataSets.IncluirPart('DI');
                        //
                        spdNFeDataSets.Campo('nDI_I19').Value            := sEx1; // Nmero do Documento de Importao (DI/DSI/DA)
                        spdNFeDataSets.Campo('dDI_I20').Value            := sEx2; // Data de Registro da DI/DSI/DA no formato AAAA-MM-DD
                        spdNFeDataSets.Campo('xLocDesemb_I21').Value     := sEx3; // Local de desembarao
                        spdNFeDataSets.Campo('UFDesemb_I22').Value       := sEx4; // Sigla da UF onde ocorreu o Desembarao Aduaneiro
                        spdNFeDataSets.Campo('dDesemb_I23').Value        := sEx5; // Data do Desembarao Aduaneiro Formato AAAA-MM-DD
                        spdNFeDataSets.Campo('cExportador_I24').Value    := sEx6; // Cdigo do exportador
                        spdNFeDataSets.Campo('tpIntermedio_I23c').Value  := '1';  // Forma de importao quanto a E I18 N 1-1 1 1=Importao por conta prpria
                        spdNFeDataSets.Campo('tpViaTransp_I23a').Value   := LimpaNumero(sEx12); // Via de transporte internacional informada na Declarao de Importao (DI)
                        //
                        if sEx12 = '1' then
                        begin
                          spdNFeDataSets.Campo('vAFRMM_I23b').Value  := sEx13;      // Valor de AFRMM (Adicional ao Frete para Renovao da Marinha Mercante)
                        end;
                        //
                        spdNFeDataSets.SalvarPart('DI');
                        //
                      except
                        on E: Exception do
                        begin
                          Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao salvar DI'
                          ),'Ateno',mb_Ok + MB_ICONWARNING);
                        end;
                      end;
                      //
                      try
                        //
                        spdNFeDataSets.IncluirPart('adi');
                        spdNFeDataSets.Campo('nAdicao_I26').Value        := sEx7;         // Numero da adio
                        spdNFeDataSets.Campo('nSeqAdic_I27').Value       := IntToStr(I);  // Cdigo sequencial
                        spdNFeDataSets.Campo('cFabricante_I28').Value    := '1';
                        spdNFeDataSets.Campo('nDraw_I29a').Value  := sEx14;      // Nmero do ato concessrio de Drawback
                        //
                        spdNFeDataSets.SalvarPart('adi');
                        //
                      except
                        on E: Exception do
                        begin
                          Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao salvar adi'
                          ),'Ateno',mb_Ok + MB_ICONWARNING);
                        end;
                      end;
                      //
                      Mais1Ini.WriteString('DI','Ex8' ,sEx8);
                      Mais1Ini.WriteString('DI','Ex9' ,sEx9);
                      Mais1Ini.WriteString('DI','Ex10',sEx10);
                      Mais1Ini.WriteString('DI','Ex11',sEx11);
                      Mais1Ini.WriteString('DI','Ex12',sEx12);
                      Mais1Ini.WriteString('DI','Ex13',sEx13);
                      Mais1Ini.WriteString('DI','Ex14',sEx14);
                      Mais1Ini.WriteString('DI','Ex15',sEx15);
                      Mais1Ini.WriteString('DI','Ex18',sEx18);
                      //
                      Mais1ini.Free;
                      //
                      try
                        spdNFeDataSets.SalvarPart('DI');
                      except
                        on E: Exception do
                        begin
                          Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao salvar DI'
                          ),'Ateno',mb_Ok + MB_ICONWARNING);
                        end;
                      end;
                      //
                      spdNFeDataSets.Campo('vBC_P02').Value      := sEx8;  // Valor da BC do Imposto de Importao
                      spdNFeDataSets.Campo('vDespAdu_P03').Value := sEx9;  // Valor das despesas aduaneiras
                      spdNFeDataSets.Campo('vII_P04').Value      := sEx10; // Valor do Imposto de Importao
                      spdNFeDataSets.Campo('vIOF_P05').Value     := sEx11; // Valor do Imposto sobre Operaes Financeiras
                      //
                      // Recalcula o IPI somando o valor do Imposto de Importao na BASE do IPI
                      //
                      spdNFeDataSets.Campo('vBC_O10').Value       := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(sEx18,'.',',')) )),',','.'); // Valor da BC do IPI
                      spdNFeDataSets.Campo('vIPI_O14').Value      := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet23.FieldByname('IPI').AsFloat* (StrToFloat(StrTran(sEx18,'.',',')) )/100,2))),',','.'); // Valor do IPI
                      //
                      vTotalImpostoImportacao := vTotalImpostoImportacao + StrToFloat(StrTran(sEx10,'.',','));
                      //
                    end;
                    //
                  end else
                  begin
                    //
                    if copy(ibDAtaSet23CFOP.AsString,2,3)='604' then
                    begin
                      //
                      I := I + 1;
                      //
                      try
                        //
                        if spdNFeDataSets.Campo('indIEDest_E16a').Value = '9' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                        if spdNFeDataSets.Campo('indIEDest_E16a').Value = '2' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                        //
                        spdNFeDataSets.SalvarItem;
                        //
                      except
                        on E: Exception do
                        begin
                          Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao salvar item cdigo: '+spdNFeDataSets.Campo('cProd_I02').Value+chr(10)+spdNFeDataSets.Campo('xProd_I04').Value+chr(10)+
                          chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                          ),'Ateno',mb_Ok + MB_ICONWARNING);
                        end;
                      end;
                      //
                      spdNFeDataSets.IncluirItem;
                      //
                      // Informaes Referentes aos ITens da NFe
                      //
                      spdNFeDataSets.Campo('nItem_H02').Value := IntToStr(I); // Nmero do Item da NFe (1 at 990)
                      spdNFeDataSets.Campo('cProd_I02').Value    := 'CFOP'+ibDAtaSet23CFOP.AsString; //Cdigo do PRoduto ou Servio
                      spdNFeDataSets.Campo('xProd_I04').Value    := 'Ativo permanente - ICMS a ser apropriado';// Descrio do PRoduto
                      spdNFeDataSets.Campo('NCM_I05').Value      := '00000000'; // Cdigo do NCM - informar de acordo com o Tabela oficial do NCM
                      spdNFeDataSets.Campo('CFOP_I08').Value     := Alltrim(ibDataSet23.FieldByname('CFOP').AsString); // CFOP incidente neste Item da NF
                      spdNFeDataSets.Campo('uCom_I09').Value     := 'UND';
                      spdNFeDataSets.Campo('qCom_I10').Value     := '0.00'; // Quantidade Comercializada do Item
                      spdNFeDataSets.Campo('vUnCom_I10a').Value  := '0.00'; // Valor Comercializado do Item
                      spdNFeDataSets.Campo('vProd_I11').Value    := '0.00'; // Valor Total Bruto do Item
                      //
                      // Campo obrigatrio
                      //
                      spdNFeDataSets.Campo('indTot_I17b').Value   := '0'; // 0 - O valor do Item NO compe o valor total da nota 1 - O valor do Item compe o valor total da nota
                      spdNFeDataSets.Campo('uTrib_I13').Value     := 'UND'; // Unidade de Medida Tributvel do Item
                      //
                      spdNFeDataSets.Campo('qTrib_I14').Value    := '1'; // Quantidade Tributvel do Item
  //                    spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBC').AsFloat)),',','.');  // Valor Tributvel do Item
                      spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet23.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Tributvel do Item
                      //
                      spdNFeDataSets.Campo('vBC_N15').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VBC').AsFloat)),',','.');  // BC
                      spdNFeDataSets.Campo('vICMS_N17').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet23.FieldByname('VICMS').AsFloat)),',','.');     // Valor do ICMS em Reais
                      spdNFeDataSets.Campo('modBC_N13').Value  := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                      spdNFeDataSets.Campo('pICMS_N16').Value  := '100'; // Alquota do ICMS em Percentual
                      //
                      if (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) = '1') then
                      begin
                        spdNFeDataSets.Campo('CSOSN_N12a').Value := '900';
                      end;
                      //
                      spdNFeDataSets.Campo('orig_N11').Value   := '0'; //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                      spdNFeDataSets.Campo('CST_N12').Value    := '90';  // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                      //
                      spdNFeDataSets.Campo('CST_Q06').Value     := '08';   // Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,2); // Codigo de Situacao Tributria - ver opes no Manual
                      spdNFeDataSets.Campo('CST_S06').Value     := '08'; // Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,2); // Cdigo de Situacao Tributria - ver opes no Manual
                      //
                    end else
                    begin
                      //
                      // Comentarios no corpo da nota
                      //
                      spdNFeDataSets.Campo('InfAdProd_V01').Value := AllTrim(AllTrim(spdNFeDataSets.Campo('InfAdProd_V01').Value) + ' ' + ConverteAcentos2(AllTrim(ibDataSet23.FieldByname('DESCRICAO').AsString)));
                      //
                    end;
                  end;
                  //
                  ibDataset23.Next;
                  //
                end;
                //
                try
                  //
                  if spdNFeDataSets.Campo('indIEDest_E16a').Value = '9' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                  if spdNFeDataSets.Campo('indIEDest_E16a').Value = '2' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                  //
                  spdNFeDataSets.SalvarItem;
                  //
                except
                  on E: Exception do
                  begin
                    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao salvar item cdigo: '+spdNFeDataSets.Campo('cProd_I02').Value+chr(10)+spdNFeDataSets.Campo('xProd_I04').Value+chr(10)+
                    chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                    ),'Ateno',mb_Ok + MB_ICONWARNING);
                  end;
                end;
                //
                // Totalizadores da NFe
                //
                spdNFeDataSets.Campo('vBC_W03').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('BASEICM').AsFloat)),',','.'); //Base de Clculo do ICMS
                spdNFeDataSets.Campo('vICMS_W04').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('ICMS').AsFloat)),',','.'); // Valor Total do ICMS
                //
                spdNFeDataSets.Campo('vICMSDeson_W04a').Value    := '0.00'; // Desonerado
                //
                spdNFeDataSets.Campo('vBCST_W05').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('BASESUBSTI').AsFloat)),',','.'); // Base de Clculo do ICMS Subst. Tributria
                //
                if Form1.sVersaoLayout = '4.00' then
                begin
                  //
                  // No caso de nota fiscal de devolucao
                  //
                  spdNFeDataSets.campo('vIPIDevol_W12a').Value  := '0.00'; // Valor Total do IPI devolvido
                  //
                  spdNFeDataSets.campo('vFCP_W04h').Value       := '0.00'; // Valor Total do FCP (Fundo de Combate  Pobreza)
                  spdNFeDataSets.campo('vFCPST_W06a').Value     := '0.00'; // Valor Total do FCP (Fundo de Combate  Pobreza) retido por substituio tributria
                  spdNFeDataSets.campo('vFCPSTRet_W06b').Value  := '0.00'; // Valor Total do FCP retido anteriormente por Substituio Tributria
                  //
                end;
                //
                spdNFeDataSets.Campo('vST_W06').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('ICMSSUBSTI').AsFloat)),',','.');; // Valor Total do ICMS Sibst. Tributria
                spdNFeDataSets.Campo('vProd_W07').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('MERCADORIA').AsFloat)),',','.'); // Valor Total de Produtos
                spdNFeDataSets.Campo('vFrete_W08').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('FRETE').AsFloat)),',','.'); // Valor Total do Frete
                spdNFeDataSets.Campo('vSeg_W09').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('SEGURO').AsFloat)),',','.'); // Valor Total do Seguro
                spdNFeDataSets.Campo('vDesc_W10').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('DESCONTO').AsFloat)),',','.'); // Valor Total de Desconto
                spdNFeDataSets.Campo('vII_W11').Value     := StrTran(Alltrim(FormatFloat('##0.00',vTotalImpostoImportacao )),',','.'); // Valor Total do Imposto de Importao
                spdNFeDataSets.Campo('vIPI_W12').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('IPI').AsFloat)),',','.'); // Valor Total do IPI
                spdNFeDataSets.Campo('vPIS_W13').Value    := StrTran(Alltrim(FormatFloat('##0.00',vPIS)),',','.'); // Valor Toal do PIS
                spdNFeDataSets.Campo('vCOFINS_W14').Value := StrTran(Alltrim(FormatFloat('##0.00',vCOFINS)),',','.');; // Valor Total do COFINS
                spdNFeDataSets.Campo('vOutro_W15').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('DESPESAS').AsFloat)),',','.'); // OUtras Despesas Acessrias
                spdNFeDataSets.Campo('vNF_W16').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet24.FieldByname('TOTAL').AsFloat + vTotalImpostoImportacao )),',','.'); // Valor Total da NFe
                //
                // Dados do Transporte da NFe
                //
                spdNFeDataSets.Campo('modFrete_X02').Value := Alltrim(ibDAtaSet15.FieldByname('FRETE12').AsString);
                //
                if AllTrim(Form7.ibDataSet24TRANSPORTA.AsString)<>'' then
                begin
                  //
                  if (Length(AllTrim(ibDataSet18.FieldByname('CGC').AsString)) = 0) then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: CNPJ da transportadora invlido';
                    Abort;
                  end;
                  //
                  if (Length(AllTrim(ibDataSet18.FieldByname('CGC').AsString)) = 18) then
                  begin
                    if LimpaNumero(Form7.ibDataSet18IE.AsString) <> '' then
                    begin
                      if ConsisteInscricaoEstadual(LimpaNumero(Form7.ibDataSet18IE.AsString),Form7.ibDataSet18UF.AsString) then
                      begin
                        //
                        Form7.ibDataset15.Edit;
                        Form7.ibDataSet15STATUS.AsString    := 'Erro: Inscrio Estadual da transportadora Invlida.';
                        //
                        Abort;
                        //
                      end;
                    end;
                  end;
                  if (Length(AllTrim(ibDataSet18.FieldByname('CGC').AsString)) = 18) then
                  begin
                    spdNFeDataSets.Campo('CNPJ_X04').Value     := LimpaNumero(ibDataSet18.FieldByname('CGC').AsString); // CNPJ do Transportador
                  end else
                  begin
                    spdNFeDataSets.Campo('CPF_X05').Value     := LimpaNumero(ibDataSet18.FieldByname('CGC').AsString); // CNPJ do Transportador
                  end;
                  //
                  spdNFeDataSets.Campo('xNome_X06').Value    := ConverteAcentos2(ibDAtaSet18.FieldByname('NOME').AsString); // Nome do Transportador
                  //
                  if AllTrim(ibDataSet18.FieldByname('IE').AsString) <> '' then
                  begin
                    if AllTrim(ibDataSet18.FieldByname('IE').AsString) <> '' then
                    begin
                      if UpperCase(ibDataSet18.FieldByname('IE').AsString)='ISENTO' then
                      begin
                        spdNFeDataSets.Campo('IE_X07').Value       := 'ISENTO'; //  Inscrio estadual do Transportador
                      end else
                      begin
                        spdNFeDataSets.Campo('IE_X07').Value       := LimpaNumero(ibDataSet18.FieldByname('IE').AsString); //  Inscrio estadual do Transportador
                      end;
                    end;
                  end;
                  //
                  spdNFeDataSets.Campo('xEnder_X08').Value   := ConverteAcentos2(ibDAtaSet18.FieldByname('ENDERECO').AsString); // Endereo do Transportador
                  spdNFeDataSets.Campo('xMun_X09').Value     := ConverteAcentos2(ibDAtaSet18.FieldByname('MUNICIPIO').AsString); // Nome do Municpio do Transportador
                  spdNFeDataSets.Campo('UF_X10').Value       := ibDAtaSet18.FieldByname('UF').AsString; // Sigla do Estado do Transportador
                  //
                  if Length(StrTran(StrTran(ibDAtaSet15.FieldByname('PLACA').AsString,' ',''),'-','')) = 7 then
                  begin
                    spdNFeDataSets.Campo('placa_X19').Value    := StrTran(StrTran(ibDAtaSet15.FieldByname('PLACA').AsString,' ',''),'-',''); // Placa do Veculo
                    spdNFeDataSets.Campo('uf_X20').Value       := ibDAtaSet18.FieldByname('ESTADO').AsString; // Sigla do Estado da Placa do Veculo
                    spdNFeDataSets.Campo('rntc_X21').Value     := ibDAtaSet18.FieldByname('ANTT').AsString; // Registro nacional de Trasportador de Cargas (ANTT)
                  end;
                  //
                end else
                begin
                  //
                  spdNFeDataSets.Campo('CNPJ_X04').Value     := ''; // CNPJ do Transportador
                  spdNFeDataSets.Campo('CPF_X05').Value      := ''; // CNPJ do Transportador
                  spdNFeDataSets.Campo('xNome_X06').Value    := ''; // Nome do Transportador
                  spdNFeDataSets.Campo('IE_X07').Value       := ''; //  Inscrio estadual do Transportador
                  spdNFeDataSets.Campo('xEnder_X08').Value   := ''; // Endereo do Transportador
                  spdNFeDataSets.Campo('xMun_X09').Value     := ''; // Nome do Municpio do Transportador
                  spdNFeDataSets.Campo('UF_X10').Value       := ''; // Sigla do Estado do Transportador
                  spdNFeDataSets.Campo('placa_X19').Value    := ''; // Placa do Veculo
                  spdNFeDataSets.Campo('uf_X20').Value       := ''; // Sigla do Estado da Placa do Veculo
                  spdNFeDataSets.Campo('rntc_X21').Value     := ''; // Registro nacional de Trasportador de Cargas (ANTT)
                  //
                end;
                //
                // Dados da Carga Transportada
                //
                spdNFeDataSets.Campo('qVol_X27').Value     := LimpaNumero(ibDataSet24.FieldByname('VOLUMES').AsString); // Quantidade de Volumes transportados
                spdNFeDataSets.Campo('esp_X28').Value      := ConverteAcentos2(ibDataSet24.FieldByname('ESPECIE').AsString); // Espcie de Carga Transportada
                spdNFeDataSets.Campo('marca_X29').Value    := ConverteAcentos2(ibDataSet24.FieldByname('MARCA').AsString); // MArca da Carga Transportada
                spdNFeDataSets.Campo('nVol_X30').Value     := ConverteAcentos2(ibDataSet24.FieldByname('NVOL').AsString);; // Numerao dos Volumes transportados
                //
                spdNFeDataSets.Campo('pesoL_X31').Value    := StrTran(Alltrim(FormatFloat('##0.000',ibDataSet24.FieldByname('PESOLIQUI').AsFloat)),',','.'); // Peso Lquido
                spdNFeDataSets.Campo('pesoB_X32').Value    := StrTran(Alltrim(FormatFloat('##0.000',ibDataSet24.FieldByname('PESOBRUTO').AsFloat)),',','.'); // Peso Bruto
                //
                // Dados De Cobrana
                //
                // 1 Fatura  - 3 Duplicatas //
                //
                if Form1.sVersaoLayout = '4.00' then
                begin
                  //
                  spdNFeDataSets.IncluirPart('YA');
                  //
                  // 01=Dinheiro
                  // 02=Cheque
                  // 03=Carto de Crdito
                  // 04=Carto de Dbito
                  // 05=Crdito Loja
                  // 10=Vale Alimentao
                  // 11=Vale Refeio
                  // 12=Vale Presente
                  // 13=Vale Combustvel
                  // * Removida * 14=Duplicata Mercantil *
                  // 15=Boleto Bancrio
                  // 90= Sem pagamento
                  // 99=Outros
                  //
                  if (spdNFeDataSets.Campo('finNFe_B25').Value = '4') or (spdNFeDataSets.Campo('finNFe_B25').Value = '3') or (spdNFeDataSets.Campo('finNFe_B25').Value = '2') then // Finalidade da NFe (1-Normal, 2-Complementar, 3-de Ajuste, 4-Devoluo de mercadoria)
                  begin
  //                  spdNFeDataSets.campo('indPag_YA01b').Value    := '0';   // Pagamento a vista
                    spdNFeDataSets.campo('tPag_YA02').Value       := '90';  // Sem Pagamento
                  end else
                  begin
                    if Copy(Uppercase(ibDataSet14.FieldByname('INTEGRACAO').AsString)+'       ',1,5) = 'PAGAR' then
                    begin
  //                    spdNFeDataSets.campo('indPag_YA01b').Value    := '1';   // Pagamento a prazo
  //                  spdNFeDataSets.campo('tPag_YA02').Value       := '05';  // Crdito Loja
                      spdNFeDataSets.campo('tPag_YA02').Value       := '14';  // Duplicata Mercantil
                    end else
                    begin
  //                    spdNFeDataSets.campo('indPag_YA01b').Value    := '0';   // Pagamento a vista
                      spdNFeDataSets.campo('tPag_YA02').Value       := '01';  // Forma de pagamento
                    end;
                  end;
                  //
                  if spdNFeDataSets.campo('tPag_YA02').Value = '90' then
                  begin
                    //
                    // Sem Pagamento
                    //
                    spdNFeDataSets.campo('vPag_YA03').Value       := '0.00';
  //                  spdNFeDataSets.campo('vTroco_YA09').Value     := '0.00';  // valor do troco
                    //
                  end else
                  begin
                    spdNFeDataSets.campo('vPag_YA03').Value       :=  spdNFeDataSets.Campo('vNF_W16').Value;
                    spdNFeDataSets.campo('vTroco_YA09').Value     := '0.00';  // valor do troco
                  end;
                  //
                  spdNFeDataSets.SalvarPart('YA');
                  //
                end;
                //
                spdNFeDataSets.Y.Append; // Inclui somente nessa Parte "Y" da NFe
                spdNFeDataSets.Campo('nFat_Y03').Value  := Copy(Form7.ibDataSet24NUMERONF.AsString,1,9); // Nmero da Farura
                spdNFeDataSets.Campo('vOrig_Y04').Value := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet24TOTAL.AsFloat)),',','.'); // Valor Original da Fatura
                //
                if Form1.sVersaoLayout = '4.00' then
                begin
  //                if Form7.spdNFe.Ambiente = spdNFeType.akHomologacao then
                  begin
                    spdNFeDataSets.Campo('vDesc_Y05').Value := '0.00'; // Valor do Desconto
                  end;
                end;
                //
                spdNFeDataSets.Campo('vLiq_Y06').Value  := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet24TOTAL.AsFloat)),',','.'); // Valor Lquido da Fatura
                //
                J := 0;
                //
                Form7.ibDataset8.First;
                while not Form7.ibDataset8.Eof do
                begin
                  //
                  // Note que Os dados da Fatura se encontram no Parte "Y" da NFe que vamos
                  // fazer vrias inseres para a Mesma NFe como demonstracao
                  // Dados da Fatura
                  //
                  //
                  // Duplicatas
                  //
                  J := J + 1;
                  //
                  spdNFeDataSets.IncluirCobranca;
                  spdNFeDataSets.Campo('nDup_Y08').Value  := StrZero(J,3,0); // Nmero da parcela
                  spdNFeDataSets.Campo('dVenc_Y09').Value := StrTran(DateToStrInvertida(Form7.ibDataSet8VENCIMENTO.AsDateTime),'/','-');; // Data de Vencimento da Duplicata
                  spdNFeDataSets.Campo('vDup_Y10').Value  := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet8VALOR_DUPL.AsFloat)),',','.'); // Valor da Duplicata
                  spdNFeDataSets.SalvarCobranca;
                  //
                  Form7.ibDataset8.Next;
                  //
                end;
                //
                spdNFeDataSets.Y.Post; // Grava a Duplicata em questo.
                //
                // Dados Adicionais da NFe - Observaes
                //
                spdNFeDataSets.Campo('infAdFisco_Z02').Value := ''; // INteresse do Fisco
                spdNFeDataSets.Campo('infCpl_Z03').Value     := AllTrim(ConverteAcentos2(AllTrim(Form7.ibDataSet24COMPLEMENTO.AsString))); // Informacoes Complementares
                //
                try
                  Form7.ibDataset24.Edit;
                  Form7.ibDataSet24MODELO.AsString    := '55';
                  Form7.ibDataset24.Post;
                except end;
                //
                // ENTRADA
                //
              end else
              begin
      //           //
      // S A I D A //
      //           //
                //
                // SAIDA
                //
                if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = ''
                  then Form7.ibDataSet14.Append
                     else Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                //
                if Form7.ibDataSet14BASE.AsFloat <> 0 then bTributa := True else bTributa := False;
                //
                // Pis cofins da Operao
                //
                sCST_PIS_COFINS := ibDataSet14.FieldByname('CSTPISCOFINS').AsString;
                rpPIS           := ibDataSet14.FieldByname('PPIS').AsFloat;
                rpCOFINS        := ibDataSet14.FieldByname('PCOFINS').AsFloat;
                //
                // Relaciona os clientes com o arquivo de vendas
                //
                Form7.ibDataSet2.Close;
                Form7.ibDataSet2.Selectsql.Clear;
                Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
                Form7.ibDataSet2.Open;
                //
                // Data da ltima venda para o cliente
                //
                try
                  if  Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime then
                  begin
                    Form7.ibDataSet2.Edit;
                    Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
                    Form7.ibDataSet2.Post;
                  end;
                except
                  try
                    Form7.ibDataSet15.Edit;
                    Form7.ibDataSet15LOKED.AsString := 'S';
                    Form7.ibDataSet15.Post;
                  except end;
                end;
                //
                Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
                Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
                //
                // Informaes do Emitente da NFe
                //
                ibDataset99.Close;
                ibDataset99.SelectSql.Clear;
                ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
                ibDataset99.Open;
                //
                if AllTrim(Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7)) = '' then
                begin
                  Form7.ibDataset15.Edit;
                  Form7.ibDataSet15STATUS.AsString    := 'Erro: Nome do municpio do emitente invlido.';
                  Abort;
                end;
                //
                spdNFeDataSets.LoteNFe.Clear;
                //
                spdNFeDataSets.Incluir; // Inicia a insercao de dados na NFe
                //

                //
                // Autorizao para obter XML
                //
                if Form7.ibDataSet13ESTADO.AsString = 'BA' then
                begin
                  if Length(LimpaNumero(sCNPJContabilidade)) = 0 then
                  begin
                    sCNPJContabilidade := LimpaNumero('13.937.073/0001-56');
                  end;
                end;
                //
                if Length(LimpaNumero(sCNPJContabilidade)) <> 0 then
                begin
                  //
                  spdNFeDataSets.IncluirPart('AUTXML');
                  if Length(LimpaNumero(sCNPJContabilidade)) = 11 then
                  begin
                    spdNFeDataSets.Campo('CPF_GA03').Value  := LimpaNumero(sCNPJContabilidade);
                  end else
                  begin
                    spdNFeDataSets.Campo('CNPJ_GA02').Value := LimpaNumero(sCNPJContabilidade);
                  end;
                  spdNFeDataSets.SalvarPart('AUTXML');
                  //
                end;
                //
                // Then end Autorizao para obter XML
                //
                spdNFeDataSets.Campo('Id_A03').Value      := ''; // Calcula Automtico. Essa linha  desnecessria
                //
                if Form1.sVersaoLayout = '4.00' then
                begin
                  spdNFeDataSets.Campo('versao_A02').Value  := '4.00'; // Verso do Layout que est utilizando
                end else
                begin
                  spdNFeDataSets.Campo('versao_A02').Value  := '3.10'; // Verso do Layout que est utilizando
                end;
                //
                spdNFeDataSets.Campo('cUF_B02').Value     := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,2);  //Codigo da UF para o estado SC = '42'
                spdNFeDataSets.Campo('cNF_B03').Value     := '004640327'; // Cdigo Interno do Sistema que est integrando com a NFe
                spdNFeDataSets.Campo('natOp_B04').Value   := ConverteAcentos2(ibDataSet15.FieldByname('OPERACAO').AsString);
                //
                if Form1.sVersaoLayout = '4.00' then
                begin

                end else
                begin
                  //
                  if Copy(Uppercase(ibDataSet14.FieldByname('INTEGRACAO').AsString)+'       ',1,7) = 'RECEBER' then
                  begin
                    spdNFeDataSets.Campo('indPag_B05').Value  := '1'; //Indicador da Forma de Pgto (0=Pagamento  vista; 1=Pagamento  prazo; 2=outros)
                  end else
                  begin
                    if allTrim(Copy(Uppercase(ibDataSet14.FieldByname('INTEGRACAO').AsString)+'       ',1,7)) = '' then
                    begin
                      spdNFeDataSets.Campo('indPag_B05').Value  := '2'; //Indicador da Forma de Pgto (0=Pagamento  vista; 1=Pagamento  prazo; 2=outros)
                    end else
                    begin
                      spdNFeDataSets.Campo('indPag_B05').Value  := '0'; //Indicador da Forma de Pgto (0=Pagamento  vista; 1=Pagamento  prazo; 2=outros)
                    end;
                  end;
                  //
                end;
                //
                spdNFeDataSets.Campo('mod_B06').Value     := '55'; //Cdigo do Modelo de Documento Fiscal
                //
                if Form1.bModoSCAN then
                begin
                  spdNFeDataSets.Campo('serie_B07').Value   := IntToStr(StrToInt(Copy(ibDataSet15.FieldByname('NUMERONF').AsString,10,3))+900); // Srie SCAN
                end else
                begin
                  spdNFeDataSets.Campo('serie_B07').Value   := IntToStr(StrToInt(Copy(ibDataSet15.FieldByname('NUMERONF').AsString,10,3))); // Srie do Documento
                end;
                //
                spdNFeDataSets.Campo('nNF_B08').Value      := IntToStr(StrToInt(Copy(ibDataSet15.FieldByname('NUMERONF').AsString,1,9))); // Nmero da Nota Fiscal
                //
                spdNFeDataSets.Campo('dhEmi_B09').Value    := StrTran(DateToStrInvertida(ibDataSet15.FieldByname('EMISSAO').AsDateTime),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso; // Data de Emisso da Nota Fiscal
                //
                // Permite data e hora de sada em branco
                //
                if AllTrim(ibDataSet15.FieldByname('SAIDAD').AsString) <> '' then
                begin
                  spdNFeDataSets.Campo('dhSaiEnt_B10').Value := StrTran(DateToStrInvertida(ibDataSet15.FieldByname('SAIDAD').AsDateTime),'/','-')+'T'+ibDataSet15.FieldByname('SAIDAH').AsString+Form7.sFuso; // Data de Sada ou Entrada da Nota Fiscal
                  if spdNFeDataSets.Campo('dhSaiEnt_B10').Value < spdNFeDataSets.Campo('dhEmi_B09').Value then spdNFeDataSets.Campo('dhSaiEnt_B10').Value := spdNFeDataSets.Campo('dhEmi_B09').Value;
                end;
                //
                spdNFeDataSets.Campo('tpNF_B11').Value     := '1'; // Tipo de Documento Fiscal (0-Entrada, 1-Sada)
                //
                // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                //
  //              if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = 'EX' then
                if Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '7' then
                begin
                  spdNFeDataSets.Campo('idDest_B11a').Value  := '3'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                end else
                begin
                  if (UpperCase(Form7.ibDataSet2ESTADO.AsString) <> UpperCase(Form7.ibDataSet13ESTADO.AsString))  then
                  begin
                    //
                    if (Pos('<idDest>1<',Form7.ibDataSet14OBS.AsString)<>0) then
                    begin
                      spdNFeDataSets.Campo('idDest_B11a').Value  := '1'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                    end else
                    begin
                      if Form7.IBDataSet2ESTADO.AsString = 'EX' then
                      begin
                        spdNFeDataSets.Campo('idDest_B11a').Value  := '1'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                      end else
                      begin
                        spdNFeDataSets.Campo('idDest_B11a').Value  := '2'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                      end;
                    end;
                    //
                  end else
                  begin
                    //
                    if (Pos('<idDest>2<',Form7.ibDataSet14OBS.AsString)<>0) then
                    begin
                      spdNFeDataSets.Campo('idDest_B11a').Value  := '2'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                    end else
                    begin
                      spdNFeDataSets.Campo('idDest_B11a').Value  := '1'; // Identificador do local de destino da operao 1-Operao Interna, 2-Operao Interestadual e 3-Operao com exterior
                    end;
                    //
                  end;
                end;
                //
                spdNFeDataSets.Campo('cMunFG_B12').Value   := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo da Cidade do Emitente (Tabela do IBGE)
                //
                // B20a Tag Nota de Produtor Rural Sada
                //
                //
                spdNFeDataSets.Campo('tpImp_B21').Value   := '1'; // Tipo de Impresso da Danfe (1- Retrato , 2-Paisagem)
                //
                if Form1.bModoSCAN then
                begin
                  spdNFeDataSets.Campo('tpEmis_B22').Value  := '3';
                end else
                begin
                  if bContingencia then
                  begin
                    spdNFeDataSets.Campo('tpEmis_B22').Value  := '5'; // Papel normal Contingncia
                  end else
                  begin
                    //
                    if Form1.bModoSVC then
                    begin
                      //
                      if (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'AM') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'BA') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'CE') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'ES') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'GO') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'MA') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'MS') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'MT') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PA') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PE') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PI') or
                         (UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'PR') then
                      begin
                        spdNFeDataSets.Campo('tpEmis_B22').Value  := '7'; // SVC-RS
                      end else
                      begin
                        spdNFeDataSets.Campo('tpEmis_B22').Value  := '6'; // SVC-AN
                      end;
                      //
                    end else
                    begin
                      spdNFeDataSets.Campo('tpEmis_B22').Value  := '1'; //Forma de Emisso da NFe (1-Normal, 2-Contingncia 3-SCAN)
                    end;
                  end;
                end;
                //
                spdNFeDataSets.Campo('cDV_B23').Value     := ''; // Calcula Automatico - Linha desnecessria j que o componente calcula o Dgito Verificador automaticamente e coloca no devido campo
                //
                if Form1.bHomologacao then spdNFeDataSets.Campo('tpAmb_B24').Value := '2' else spdNFeDataSets.Campo('tpAmb_B24').Value   := '1';
                //
                spdNFeDataSets.Campo('finNFe_B25').Value       := Form7.ibDataSet15FINNFE.AsString;    // Finalidade da NFe (1-Normal, 2-Complementar, 3-de Ajuste, 4-Devoluo de mercadoria)
                spdNFeDataSets.Campo('indFinal_B25a').Value    := Form7.ibDataSet15INDFINAL.AsString;  // Indica operao com Consumidor final] deve ser preenchido. Dica: Utilize: 0-No, 1-Consumidor Final'. Process stopped. Use Step or Run to continue.
                spdNFeDataSets.Campo('indPres_B25b').Value     := Form7.ibDataSet15INDPRES.AsString;   // Indicador de presena do comprador no estabelecimento comercial.. Utilize: 0-No, 1-Operao presencial, 2-Operao no presencial, Internet, 3-Operao No presencial, teleatendimento, 9-Operao no presencial, outros.'.
                //
                if (Form7.ibDataSet15INDPRES.AsString = '2') or (Form7.ibDataSet15INDPRES.AsString = '3') or (Form7.ibDataSet15INDPRES.AsString = '4') or (Form7.ibDataSet15INDPRES.AsString = '9') then
                begin
                  if AllTrim(Form7.IBDataSet15MARKETPLACE.AsString) = '' then
                  begin
                    spdNFeDataSets.Campo('indIntermed_B25c').Value := '0';  // Indicador de intermediador/marketplace E B01 N 0-1 1 0=Operao sem intermediador (em site ou plataforma prpria) 1=Operao em site ou plataforma de terceiros (intermediadores/marketplace)
                  end else
                  begin
                    //
                    try
                      //
                      Form1.ibDataSet200.Close;
                      Form1.ibDataSet200.SelectSql.Clear;
                      Form1.ibDataSet200.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15MARKETPLACE.AsString)+' ');  //
                      Form1.ibDataset200.Open;
                      //
                      if Form7.IBDataSet15MARKETPLACE.AsString = Form1.ibDataSet200.FieldByname('NOME').AsString then
                      begin
                        //
                        spdNFeDataSets.Campo('indIntermed_B25c').Value  := '1';  // Indicador de intermediador/marketplace E B01 N 0-1 1 0=Operao sem intermediador (em site ou plataforma prpria) 1=Operao em site ou plataforma de terceiros (intermediadores/marketplace)
                        spdNFeDataSets.Campo('CNPJ_YB02').Value         := LimpaNumero(Form1.ibDataSet200.FieldByname('CGC').AsString);  // CNPJ do Intermediador da Transao (agenciador, plataforma de delivery, marketplace e similar) de servios e de negcios.
                        //
                        if AllTrim(RetornaValorDaTagNoCampo('idCadIntTran',Form1.ibDataSet200.FieldByname('OBS').AsString)) <> '' then
                        begin
                          spdNFeDataSets.Campo('idCadIntTran_YB03').Value := AllTrim(RetornaValorDaTagNoCampo('idCadIntTran',Form1.ibDataSet200.FieldByname('OBS').AsString)); // Identificador cadastrado no intermediador
                        end else
                        begin
                          spdNFeDataSets.Campo('idCadIntTran_YB03').Value := ConverteAcentos2(ibDAtaset13.FieldByname('NOME').AsString); // Identificador cadastrado no intermediador
                        end;
                        //
                      end;
                      //
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar MKP'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                  end;
                end;
                //
                // Complemento de ICMS
                //
                // ibDataSet16.First;
                //
                if Form7.ibDataSet15FINNFE.AsString = '2' then
                begin
                  //
                  sChave                                      := Form1.Small_InputForm('NFe', 'Chave de acesso da NF-e referenciada (ID da NF-e)', '');
                  //
                  try
                    if sChave <> '' then
                    begin
                      spdNFeDataSets.IncluirPart('NREF');
                      spdNFeDataSets.Campo('refNFe_BA02').Value := sChave;
                      spdNFeDataSets.SalvarPart('NREF');
                    end;
                  except
                    on E: Exception do
                    begin
                      Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar NREF 2'
                      ),'Ateno',mb_Ok + MB_ICONWARNING);
                    end;
                  end;
                  //
                end else
                begin
                  //
                  if Form7.ibDataSet15FINNFE.AsString = '4' then
                  begin
                    //
                    sChave := '';
                    //
                    if Pos('ID da NF-e referenciada:',Form7.ibDataSet15COMPLEMENTO.AsString) <> 0 then
                    begin
                      sChave := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+Replicate(' ',30), Pos('ID da NF-e referenciada:',Form7.ibDataSet15COMPLEMENTO.AsString)+24,44);
                    end;
                    //
                    // S pede se no est na obs
                    //
                    if Length(LimpaNumero(sChave)) <> 44 then
                    begin
                      sChave                                      := Form1.Small_InputForm('NFe', pChar('Chave de acesso da NF-e de devoluo referenciada'+chr(10)+
                                                                                                        '(ID da NF-e) ou Nmero do ECF (3) + COO (6) para'+chr(10)+
                                                                                                        'cupom fiscal referenciado') , sChave);
                    end;
                    //
                    try
                      if Length(LimpaNumero(sChave))= 9 then
                      begin
                        spdNFeDataSets.IncluirPart('NREF');
                        spdNFeDataSets.Campo('mod_BA21').Value    := '2D';
                        spdNFeDataSets.Campo('nECF_BA22').Value   := Copy(LimpaNumero(sChave),1,3);
                        spdNFeDataSets.Campo('nCOO_BA23').Value   := Copy(LimpaNumero(sChave),4,6);
                        spdNFeDataSets.SalvarPart('NREF');
                      end else
                      begin
                        if Length(LimpaNumero(sChave))= 44 then
                        begin
                          spdNFeDataSets.IncluirPart('NREF');
                          spdNFeDataSets.Campo('refNFe_BA02').Value := sChave;
                          spdNFeDataSets.SalvarPart('NREF');
                        end else
                        begin
                          ShowMessage('Informao invlida informe a'+chr(10)+
                                      'Chave de acesso da NF-e de devoluo referenciada'+chr(10)+
                                      '(ID da NF-e) ou Nmero do ECF (3) + COO (6) para'+chr(10)+
                                      'cupom fiscal referenciado');
                          Abort;
                        end;
                      end;
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar NREF 3'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                        Abort;
                      end;
                    end;
                  end;
                  //
                end;
                //
                // Complemento de ICMS
                //
                spdNFeDataSets.Campo('procEmi_B26').Value := '0'; // Identificador do Processo de emisso (0-Emisso da Nfe com Aplicativo do Contribuinte). Ver outras opes no manual da Receita.
                spdNFeDataSets.Campo('verProc_B27').Value := '001'; // Verso do Aplicativo Emissor
                //
                // NFe com CPF
                //
                if Length(LimpaNumero(Form7.ibDataSet13CGC.AsString)) = 11 then
                begin
                  spdNFeDataSets.Campo('CPF_C02a').Value    := LimpaNumero(ibDAtaset13.FieldByname('CGC').AsString); // CNPJ do Emitente
                end else
                begin
                  spdNFeDataSets.Campo('CNPJ_C02').Value    := LimpaNumero(ibDAtaset13.FieldByname('CGC').AsString); // CNPJ do Emitente
                end;
                //
                spdNFeDataSets.Campo('xNome_C03').Value   := ConverteAcentos2(ibDAtaset13.FieldByname('NOME').AsString); // Razao Social ou Nome do Emitente
                spdNFeDataSets.Campo('xFant_C04').Value   := ConverteAcentos2(ibDAtaset13.FieldByname('NOME').AsString); ; // Nome Fantasia do Emitente
                //
                spdNFeDataSets.Campo('xLgr_C06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset13.FieldByname('ENDERECO').AsString)); // Logradouro do Emitente
                spdNFeDataSets.Campo('nro_C07').Value     := Numero_Sem_Endereco(ibDAtaset13.FieldByname('ENDERECO').AsString); // Numero do Logradouro do Emitente
                //
                spdNFeDataSets.Campo('xBairro_C09').Value := ConverteAcentos2(ibDAtaset13.FieldByname('COMPLE').AsString); // Bairro do Emitente
                //
                spdNFeDataSets.Campo('cMun_C10').Value    := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo da Cidade do Emitente (Tabela do IBGE)
                spdNFeDataSets.Campo('xMun_C11').Value    := ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString); // Nome da Cidade do Emitente
                //
                spdNFeDataSets.Campo('UF_C12').Value      := ibDAtaSet99.FieldByname('UF').AsString; // Cdigo do Estado do Emitente (Tabela do IBGE)
                spdNFeDataSets.Campo('CEP_C13').Value     := LimpaNumero(ibDataSet13.FieldByname('CEP').AsString); // Cep do Emitente
                //
                if Alltrim(ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString))='' then
                begin
                  Form7.ibDataset15.Edit;
                  Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o CEP do emitente';
                  Abort;
                end;
                //
                spdNFeDataSets.Campo('cPais_C14').Value   := '1058'; // Cdigo do Pas do Emitente (Tabela BACEN)
                spdNFeDataSets.Campo('xPais_C15').Value   := 'BRASIL'; // Nome do Pas do Emitente
                //
                if Length(LimpaNumero(ibDAtaset13.FieldByname('TELEFO').AsString)) = 11 then spdNFeDataSets.Campo('fone_C16').Value    := Copy(LimpaNumero(ibDAtaset13.FieldByname('TELEFO').AsString),2,10) else spdNFeDataSets.Campo('fone_C16').Value    := LimpaNumero(ibDAtaset13.FieldByname('TELEFO').AsString); // Fone do Emitente
                spdNFeDataSets.Campo('IE_C17').Value      := LimpaNumero(ibDAtaset13.FieldByname('IE').AsString); // Inscrio Estadual do Emitente
                //
                if LimpaNumero(ibDAtaset13.FieldByname('IM').AsString) <> '' then
                begin
                  spdNFeDataSets.Campo('IM_C19').Value      := StrTran(LimpaNumero(ibDAtaset13.FieldByname('IM').AsString),'-',''); // Inscrio Estadual do Emitente
                  //
                  if AllTrim(ibDAtaset13.FieldByname('CNAE').AsString) <> '' then
                  begin
                    spdNFeDataSets.Campo('CNAE_C20').Value      := AllTrim(ibDAtaset13.FieldByname('CNAE').AsString); // CNAE
                  end else
                  begin
                    spdNFeDataSets.Campo('CNAE_C20').Value    := '0000000'; // CNAE
                  end;
                  //
                end;
                //
                if UpperCase(AllTrim(Form12.Label28.Caption)) = UpperCase('IE SUBSTITUTO') then
                begin
                  spdNFeDataSets.Campo('IEST_C18').Value    := LimpaNumero(Form7.ibDataSet15IDENTIFICADOR1.AsString); // Inscrio Estadual do Substituto Tributrio Emitente
                end;
                //
                sDentroOuForadoEStado := Copy(Form7.ibDataSet14CFOP.AsString,1,1);
                //
                // Informaes do Destinatrio da NFe
                //
                if Form7.ibDataSet2ESTADO.AsString <> 'EX' then
                begin
                  //
                  ibDataset99.Close;
                  ibDataset99.SelectSql.Clear;
                  ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet2CIDADE.AsString)+' and UF='+QuotedStr(ibDataSet2ESTADO.AsString)+' ');
                  ibDataset99.Open;
                  //
                  if Alltrim(ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString))='' then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o municpio do destinatrio';
                    Abort;
                  end;
                  //
                  if Form7.spdNFe.Ambiente = spdNFeType.akHomologacao then
                  begin
                    //
                    spdNFeDataSets.Campo('xNome_E04').Value     := 'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL'; // Razao social ou Nome do Destinatrio
                    spdNFeDataSets.Campo('CNPJ_E02').Value      := '99999999000191'; // CNPJ do Destinatrio
                    spdNFeDataSets.Campo('IE_E17').Value        := '';
                    //
                    if (Form7.ibDataSet2ESTADO.AsString ='AM') or
                       (Form7.ibDataSet2ESTADO.AsString ='BA') or
                       (Form7.ibDataSet2ESTADO.AsString ='CE') or
                       (Form7.ibDataSet2ESTADO.AsString ='GO') or
                       (Form7.ibDataSet2ESTADO.AsString ='MG') or
                       (Form7.ibDataSet2ESTADO.AsString ='MS') or
                       (Form7.ibDataSet2ESTADO.AsString ='MT') or
                       (Form7.ibDataSet2ESTADO.AsString ='PE') or
                       (Form7.ibDataSet2ESTADO.AsString ='RN') or
                       (Form7.ibDataSet2ESTADO.AsString ='SE') or
                       (Form7.ibDataSet2ESTADO.AsString ='SP') then
                    begin
                      spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';    // 1-Contribuinte; 2-Isento; 9-No contribuinte
                    end else
                    begin
                      spdNFeDataSets.Campo('indIEDest_E16a').Value  := '2';    // 1-Contribuinte; 2-Isento; 9-No contribuinte
                    end;
                    //
                  end else
                  begin
                    //
                    if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 18) then spdNFeDataSets.Campo('CNPJ_E02').Value := AllTrim(LimpaNumero(ibDAtaset2.FieldByname('CGC').AsString)); // CNPJ do Destinatrio
                    if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 14) then spdNFeDataSets.Campo('CPF_E03').Value  := AllTrim(LimpaNumero(ibDAtaset2.FieldByname('CGC').AsString)); // CPF do Destinatrio
                    spdNFeDataSets.Campo('xNome_E04').Value   := ConverteAcentos2(ibDAtaset2.FieldByname('NOME').AsString); // Razao social ou Nome do Destinatrio
                    //
                  end;
                  //
                  spdNFeDataSets.Campo('xLgr_E06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset2.FieldByname('ENDERE').AsString)); // Logradouro do Emitente
                  spdNFeDataSets.Campo('nro_E07').Value     := Numero_Sem_Endereco(ibDAtaset2.FieldByname('ENDERE').AsString); // Numero do Logradouro do Emitente
                  //
                  spdNFeDataSets.Campo('xBairro_E09').Value := ConverteAcentos2(ibDAtaset2.FieldByname('COMPLE').AsString); // Bairro do Destinatario
                  spdNFeDataSets.Campo('cMun_E10').Value    := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo do Municpio do Destinatrio (Tabela IBGE)
                  spdNFeDataSets.Campo('xMun_E11').Value    := ConverteAcentos2(ibDAtaSet99.FieldByname('NOME').AsString); //Nome da Cidade do Destinatrio
                  spdNFeDataSets.Campo('UF_E12').Value      := ibDAtaSet99.FieldByname('UF').AsString; // Sigla do Estado do Destinatrio
                  //
                  spdNFeDataSets.Campo('CEP_E13').Value     := LimpaNumero(ibDataSet2.FieldByname('CEP').AsString); // Cep do Destinatrio
                  spdNFeDataSets.Campo('cPais_E14').Value   := '1058'; // Cdigo do Pais do Destinatrio (Tabela do BACEN)
                  spdNFeDataSets.Campo('xPais_E15').Value   := 'BRASIL';// Nome do Pas do Destinatrio
                  if Length(LimpaNumero(ibDAtaset2.FieldByname('FONE').AsString)) = 11 then spdNFeDataSets.Campo('fone_E16').Value    := Copy(LimpaNumero(ibDAtaset2.FieldByname('FONE').AsString),2,10) else spdNFeDataSets.Campo('fone_E16').Value    := LimpaNumero(ibDAtaset2.FieldByname('FONE').AsString); // Fone do Destinatrio
                  //
                  if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 0) then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: CNPJ ou CPF do destinatrio invlido';
                    Abort;
                  end;
                  //
                  if (Length(AllTrim(Form7.ibDataSet2CEP.AsString)) <> 9) then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: CEP do destinatrio invlido';
                    Abort;
                  end;
                  //
                  if Limpanumero(Form7.ibDataSet2FONE.AsString) <> '' then
                  begin
                    if Length(Limpanumero(Form7.ibDataSet2FONE.AsString)) < 8 then
                    begin
                      Form7.ibDataset15.Edit;
                      Form7.ibDataSet15STATUS.AsString    := 'Erro: Telefone do destinatrio invlido.';
                      Abort;
                    end;
                  end;
                  //
                  if Form7.spdNFe.Ambiente <> spdNFeType.akHomologacao then
                  begin
                    //
                    if Copy(ibDAtaset2.FieldByname('IE').AsString,1,2) = 'PR' then // Produtor Rural
                    begin
                      //
                      spdNFeDataSets.Campo('IE_E17').Value          := LimpaNumero(ibDAtaset2.FieldByname('IE').AsString); // Inscrio Estadual do Destinatrio
                      spdNFeDataSets.Campo('indIEDest_E16a').Value  := '1';      // Contribuinte ICMS
                      //
                      // spdNFeDataSets.Campo('IE_E17').Value          := ''; // Produtor rural
                      //
                    end else
                    begin
                      //
                      if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 18) then
                      begin
                        //
                        if allTrim(ibDAtaset2.FieldByname('IE').AsString) = '' then
                        begin
                          //
                          spdNFeDataSets.Campo('IE_E17').Value          := '';
                          spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';   // 1-Contribuinte; 2-Isento; 9-No contribuinte
                          //
                        end else
                        begin
                          //
                          if (not ConsisteInscricaoEstadual(LimpaNumero(Form7.ibDataSet2IE.AsString),Form7.ibDataSet2ESTADO.AsString)) then 
                          begin
                            //
                            if ibDAtaset2.FieldByname('IE').AsString = 'ISENTO' then
                            begin
                              //
                              spdNFeDataSets.Campo('indIEDest_E16a').Value  := '2';  // 1-Contribuinte; 2-Isento; 9-No contribuinte
                              spdNFeDataSets.Campo('IE_E17').Value          := '';
                              //
                            end else
                            begin
                              spdNFeDataSets.Campo('indIEDest_E16a').Value  := '1';  // 1-Contribuinte; 2-Isento; 9-No contribuinte
                              spdNFeDataSets.Campo('IE_E17').Value      := LimpaNumero(ibDAtaset2.FieldByname('IE').AsString); // Inscrio Estadual do Destinatrio
                            end;
                            //
                          end else
                          begin
                            if ibDAtaset2.FieldByname('IE').AsString = 'ISENTO' then   // DLL IE NOVA
                            begin
                              //
                              spdNFeDataSets.Campo('indIEDest_E16a').Value  := '2';  // 1-Contribuinte; 2-Isento; 9-No contribuinte
                              spdNFeDataSets.Campo('IE_E17').Value          := '';
                              //
                            end else
                            begin
                              Form7.ibDataset15.Edit;
                              Form7.ibDataSet15STATUS.AsString    := 'Erro: Inscrio Estadual do Destinatrio Invlida';
                              Abort;
                            end;
                          end;
                        end;
                      end else
                      begin
                        //
                        // spdNFeDataSets.Campo('IE_E17').Value := 'ISENTO'; // Inscrio Estadual do Destinatrio
                        //
                        spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';   // 1-Contribuinte; 2-Isento; 9-No contribuinte
                        spdNFeDataSets.Campo('IE_E17').Value          := '';
                        //
                        // quando  CPF no deve mostrar o IE
                        //
                      end;
                    end;
                  end;
                  //
                  // Inscrio SUFRAMA Superintendncia da Zona Franca de Manaus
                  //
                  try
                    if RetornaValorDaTagNoCampo('SUFRAMA', form7.ibDataSet2.FieldByname('OBS').AsString) <> '' then
                    begin
                      spdNFeDataSets.Campo('ISUF_E18').Value := RetornaValorDaTagNoCampo('SUFRAMA', form7.ibDataSet2.FieldByname('OBS').AsString);
                    end;
                  except end;  
                  //
                end else
                begin
                  //
                  // Consumidor estrangeiro
                  //
                  try
                    spdNFeDataSets.Campo('xLgr_E06').Value    := ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset2.FieldByname('ENDERE').AsString)); // Logradouro do Emitente
                    spdNFeDataSets.Campo('nro_E07').Value     := Numero_Sem_Endereco(ibDAtaset2.FieldByname('ENDERE').AsString); // Numero do Logradouro do Emitente
                    //
                    spdNFeDataSets.Campo('xBairro_E09').Value := ConverteAcentos2(ibDAtaset2.FieldByname('COMPLE').AsString); // Bairro do Destinatario
                    spdNFeDataSets.Campo('cMun_E10').Value    := '9999999';   // Cdigo do Municpio do Destinatrio (Tabela IBGE)
                    spdNFeDataSets.Campo('xMun_E11').Value    := 'EXTERIOR'; //Nome da Cidade do Destinatrio
                    spdNFeDataSets.Campo('UF_E12').Value      := 'EX';      // Sigla do Estado do Destinatrio
                    //
                    spdNFeDataSets.Campo('CEP_E13').Value         := '00000000'; // Cep do Destinatrio
                    spdNFeDataSets.Campo('fone_E16').Value        := '';        // Fone do Destinatrio
                    spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';      // No Contribuinte
                    //
                    if Form7.spdNFe.Ambiente = spdNFeType.akHomologacao then
                    begin
                      spdNFeDataSets.Campo('xNome_E04').Value   := 'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL'; // Razao social ou Nome do Destinatrio
                    end else
                    begin
                      spdNFeDataSets.Campo('xNome_E04').Value   := ConverteAcentos2(ibDAtaset2.FieldByname('NOME').AsString); // Razao social ou Nome do Destinatrio
                    end;
                    //
                    if Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '7' then
                    begin
                      //
                      sPais    := Form1.Small_InputForm('NFe', 'Pas destino', 'Estados Unidos');
                      sCodPais := Form1.Small_InputForm('NFe', 'Cdigo do Pas destino', '2496');
                      //
                      spdNFeDataSets.Campo('cPais_E14').Value            := sCodPais;       // Cdigo do Pais do Destinatrio (Tabela do BACEN)
                      spdNFeDataSets.Campo('xPais_E15').Value            := sPais;    // Nome do Pas do Destinatrio
                      spdNFeDataSets.Campo('idEstrangeiro_E03a').Value   := Form1.Small_InputForm('Identificao de estrangeiro','Nmero do passaporte ou documento legal do comprador estrangeiro: ',''); // Identificacao do destinatario no caso de comprador estrangeiro
                      //
                    end else
                    begin
                      //
                      // Exportacao Exportao
                      //
                      try
                        //
                        spdNFeDataSets.Campo('IE_E17').Value := '';
                        spdNFeDataSets.Campo('CNPJ_E02').Value := '';
                        //
                        sPais    := 'Estados Unidos';
                        sCodPais := '2496';
                        //
                        Form29.Label_01.Visible := True;
                        Form29.Label_02.Visible := True;
                        Form29.Label_03.Visible := True;
                        Form29.Label_04.Visible := True;
                        Form29.Label_05.Visible := True;
                        Form29.Label_06.Visible := True;

                        //
                        Form29.Edit_01.Visible := True;
                        Form29.Edit_02.Visible := True;
                        Form29.Edit_03.Visible := True;
                        Form29.Edit_04.Visible := True;
                        Form29.Edit_05.Visible := True;
                        Form29.Edit_06.Visible := True;
                        //
                        Form29.Label_01.Caption := 'Pas destino:';
                        Form29.Label_02.Caption := 'Cdigo do Pas destino:';
                        Form29.Label_03.Caption := 'Identificao do destinatrio no caso de comprador estrangeiro:';
                        Form29.Label_04.Caption := 'UF de embarque:';
                        Form29.Label_05.Caption := 'Local de embarque:';
                        Form29.Label_06.Caption := 'Descrio do Recinto Alfandegado'+chr(10)+
                                                   'onde foi efetivado o despacho'+chr(10)+
                                                   'conforme padronizao da RFB:';

                        //
                        Form29.Edit_01.Text := sPais;
                        Form29.Edit_02.Text := sCodPais;
                        Form29.Edit_03.Text := '';
                        Form29.Edit_04.Text := UpperCase(Form7.ibDataSet13ESTADO.AsString);
                        Form29.Edit_05.Text := '';
                        Form29.Edit_06.Text := '';
                        //
                        Form1.Small_InputForm_Dados('Exportao');
                        //
                        sPais            := Form29.Edit_01.Text;
                        sCodPais         := Form29.Edit_02.Text;
                        sEx15            := Form29.Edit_03.Text;
                        sUFEmbarq        := Form29.Edit_04.Text;
                        sLocaldeEmbarque := Form29.Edit_05.Text;
                        sLocalDespacho   := Form29.Edit_06.Text;
                        //
{
                        sPais    := Form1.Small_InputForm('NFe', 'Pas destino', 'Estados Unidos');
                        sCodPais := Form1.Small_InputForm('NFe', 'Cdigo do Pas destino', '2496');
                        sEx15  := Form1.Small_InputForm('NF-e importao', 'Identificao do destinatrio no caso de comprador estrangeiro:',sEx15);
}
                        spdNFeDataSets.Campo('cPais_E14').Value       := sCodPais;  // Cdigo do Pais do Destinatrio (Tabela do BACEN)
                        spdNFeDataSets.Campo('xPais_E15').Value       := sPais;    // Nome do Pas do Destinatrio
                        //
                        spdNFeDataSets.Campo('UFSaidaPais_ZA02').Value   := sUFEmbarq;     // Estado do embarque = Estado do Emitente
                        spdNFeDataSets.Campo('xLocExporta_ZA03').Value   := sLocaldeEmbarque;                  // Local do embarque
                        spdNFeDataSets.Campo('xLocDespacho_ZA04').Value  := sLocalDespacho;                  // Local do Despacho
                        spdNFeDataSets.Campo('indIEDest_E16a').Value  := '9';  // 1-Contribuinte; 2-Isento; 9-No contribuinte
                        //
                        if AllTrim(sEx15) = '' then
                        begin
                          spdNFeDataSets.Campo('idEstrangeiro_E03a').GeraTagVazia   := True;     // Indentificao do destinario no caso de comprador estrangeiro
                        end else
                        begin
                          spdNFeDataSets.Campo('idEstrangeiro_E03a').Value  := sEx15;      // Indentificao do destinario no caso de comprador estrangeiro
                        end;
                      except
                        on E: Exception do
                        begin
                          Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'Ao preencher Identificao do destinatrio no caso de comprador estrangeiro'
                          ),'Ateno',mb_Ok + MB_ICONWARNING);
                        end;
                      end;
                      //
                    end;
                  except
                    on E: Exception do
                    begin
                      Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao preencher dados para exportao'),'Ateno',mb_Ok + MB_ICONWARNING);
                    end;
                  end;
                end;
                //
                // Calcular o desconto do Item
                //
                vDESCONTO := 0;
                vFRETE    := 0;
                vSEGURO   := 0;
                vOUTRAS   := 0;
                //
                for I := 1 to 999 do
                begin
                  fOutras[I]   := 0;
                  fFrete[I]    := 0;
                  fseguro[I]   := 0;
                  fDesconto[I] := 0;
                end;
                //
                I := 0;
                //
                if ibDataSet15.FieldByname('MERCADORIA').AsFloat <> 0 then
                begin
                  //
                  ibDataSet16.First;
                  while not ibDataSet16.Eof do
                  begin
                    //
                    Form7.ibDataSet4.Close;
                    Form7.ibDataSet4.Selectsql.Clear;
                    Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                    Form7.ibDataSet4.Open;
                    //
                    if (Alltrim(ibDataSet4DESCRICAO.AsString) = Alltrim(ibDAtaSet16DESCRICAO.AsString)) and (Alltrim(ibDataSet4DESCRICAO.AsString) <> '') then
                    begin
                      //
                      I := I + 1;
                      //
      //                  if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                      begin
                        fOutras[I]   := Arredonda((ibDataSet15.FieldByname('DESPESAS').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * ibDataSet16.FieldByname('TOTAL').AsFloat),2);
                      end;
                      //
                      fFrete[I]    := Arredonda((ibDataSet15.FieldByname('FRETE').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * ibDataSet16.FieldByname('TOTAL').AsFloat),2);
                      fSeguro[I]   := Arredonda((ibDataSet15.FieldByname('SEGURO').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * ibDataSet16.FieldByname('TOTAL').AsFloat),2);
                      fDesconto[I] := Arredonda((ibDataSet15.FieldByname('DESCONTO').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * ibDataSet16.FieldByname('TOTAL').AsFloat),2);
                      //
                      vFRETE       := vFRETE + fFrete[I];
                      vSEGURO      := vSEGURO + fSeguro[I];
                      vOUTRAS      := vOUTRAS + fOutras[I];
                      vDESCONTO    := vDESCONTO + fDesconto[I];
                      //
                      //
                    end;
                    //
                    ibDataSet16.Next;
                    //
                  end;
                end;
                //
                vDESCONTO      := (ibDataSet15.FieldByname('DESCONTO').AsFloat - vDESCONTO);
                vSEGURO        := (ibDataSet15.FieldByname('SEGURO').AsFloat - vSEGURO);
                vFRETE         := (ibDataSet15.FieldByname('FRETE').AsFloat - vFRETE);
                //
  //              if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                begin
                  vOUTRAS        := (ibDataSet15.FieldByname('DESPESAS').AsFloat - vOUTRAS);
                end;
                //
                for I := 1 to 999 do
                begin
                  //
                  // DIFERENCA DE CENTAVOS DO DESCONTO
                  //
                  if vDESCONTO <> 0 then
                  begin
                    if fDesconto[I] = Math.MaxValue( fDesconto ) then
                    begin
  //                    ShowMessage('Diferena: '+FloatToStr(vDESCONTO)+chr(10)+
  //                    'Desconto do item: '+FloatToStr(vDESCONTO)+chr(10)+
  //                    'Desconto do item + Diferena: '+FloatToStr(fDesconto[I] + vDESCONTO)+chr(10));
                      fDesconto[I] := fDesconto[I] + vDESCONTO;
                      vDESCONTO := 0;
                    end;
                  end;
                  //
                  // DIFERENCA DE CENTAVOS DO FRETE
                  //
                  if vFRETE <> 0 then
                  begin
                    if fFRETE[I] = Math.MaxValue( fFRETE ) then
                    begin
                      fFRETE[I] := fFRETE[I] + vFRETE;
                      vFRETE := 0;
                    end;
                  end;
                  //
                  // DIFERENCA DE CENTAVOS DO SEGURO
                  //
                  if vSEGURO <> 0 then
                  begin
                    if fSEGURO[I] = Math.MaxValue( fSEGURO ) then
                    begin
                      fSEGURO[I] := fSEGURO[I] + vSEGURO;
                      vSEGURO := 0;
                    end;
                  end;
                  //
                  // DIFERENCA DE CENTAVOS DO OUTRAS
                  //
                  if vOUTRAS <> 0 then
                  begin
                    if fOUTRAS[I] = Math.MaxValue( fOUTRAS ) then
                    begin
                      fOUTRAS[I] := fOUTRAS[I] + vOUTRAS;
                      vOUTRAS := 0;
                    end;
                  end;
                  //
                end;
                //
                vIVA60_B_ICMST := 0;
                vIVA60_V_ICMST := 0;
                vPIS           := 0;
                vPIS_S         := 0;
                vCOFINS        := 0;
                vCOFINS_S      := 0;
                vBCST          := 0;
                vST            := 0;
                vBC            := 0;
                VICMS          := 0;
                I              := 0;
                fFCPUFDest     := 0;
                fICMSUFDest    := 0;
                fICMSUFREmet   := 0;
                fFCPST         := 0;
                fFCP           := 0;
                fIPIDevolvido  := 0;
                vICMSDeson     := 0;
                //
                sComplemento := '';
                sCupomReferenciado := '';
                //
                // Itens da nota de SAIDA
                //
                ibDataSet16.First;
                while not ibDataSet16.Eof do
                begin
                  //
                  fPercentualFCP := 0;
                  //
                  Form7.ibDataSet4.Close;
                  Form7.ibDataSet4.Selectsql.Clear;
                  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                  Form7.ibDataSet4.Open;
                  //
                  if (Alltrim(ibDataSet4DESCRICAO.AsString) = Alltrim(ibDAtaSet16DESCRICAO.AsString)) and (Alltrim(ibDataSet4DESCRICAO.AsString) <> '') then
                  begin
                    //
                    I := I + 1;
                    //
                    try
                      //
                      if spdNFeDataSets.Campo('indIEDest_E16a').Value = '9' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                      if spdNFeDataSets.Campo('indIEDest_E16a').Value = '2' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                      spdNFeDataSets.SalvarItem;
                      //
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao salvar item cdigo: '+spdNFeDataSets.Campo('cProd_I02').Value+chr(10)+spdNFeDataSets.Campo('xProd_I04').Value+chr(10)+
                        chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                    //
                    spdNFeDataSets.IncluirItem;
                    //
                    // Informaes Referentes aos ITens da NFe
                    //
                    spdNFeDataSets.Campo('nItem_H02').Value := IntToStr(I); // Nmero do Item da NFe (1 at 990)
                    //
                    // Dados do Produto Vendido
                    //
                    if (RetornaValorDaTagNoCampo('cProd', form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '') then //
                      spdNFeDataSets.Campo('cProd_I02').Value    := Copy(RetornaValorDaTagNoCampo('cProd', form7.ibDataSet4.FieldByname('TAGS_').AsString), 1, 60)
                    else
                      if _ecf65_ValidaGtinNFCe(form7.ibDataSet4.FieldByname('REFERENCIA').AsString) then
                        spdNFeDataSets.Campo('cProd_I02').Value    := form7.ibDataSet4.FieldByname('CODIGO').AsString //Cdigo do PRoduto ou Servio
                      else
                        //spdNFeDataSets.Campo('cProd_I02').Value   := LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // Cdigo de BARRAS
                        if Length(Alltrim(LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString))) < 6 then
                          spdNFeDataSets.Campo('cProd_I02').Value    := form7.ibDataSet4.FieldByname('CODIGO').AsString //Cdigo do PRoduto ou Servio
                        else
                          spdNFeDataSets.Campo('cProd_I02').Value   := LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // Cdigo de BARRAS

                    spdNFeDataSets.Campo('cEAN_I03').Value := 'SEM GTIN'; // EAN do Produto
                    if _ecf65_ValidaGtinNFCe(form7.ibDataSet4.FieldByname('REFERENCIA').AsString) then
                      spdNFeDataSets.Campo('cEAN_I03').Value := LimpaNumero(form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // EAN do Produto
                    //
                    spdNFeDataSets.Campo('xProd_I04').Value    := Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('DESCRICAO').AsString));// Descrio do PRoduto
                    //
                    // NCM
                    //
                    if Length(Alltrim(LimpaNumero(ibDataSet4.FieldByname('CF').AsString))) = 8 then
                    begin
                      //
                      spdNFeDataSets.Campo('NCM_I05').Value      := Alltrim(LimpaNumero(ibDataSet4.FieldByname('CF').AsString)); // Cdigo do NCM - informar de acordo com o Tabela oficial do NCM
                      //
{                      if ((ibDAtaset13.FieldByname('CRT').AsString <> '1') and (
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '20') or
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '30') or
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '40') or
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '41') or
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '50') or
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '70') or
                                                                               (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2) = '90')))
}
                      fICMSDesonerado := 0;
                      //
                      if (ibDAtaset13.FieldByname('CRT').AsString <> '1') then
                      begin
                        if (RetornaValorDaTagNoCampo('cBenef',Form7.ibDataSet4.FieldByname('TAGS_').AsString)<>'') and (RetornaValorDaTagNoCampo('cBenef',Form7.ibDataSet4.FieldByname('TAGS_').AsString)<>'0000000000') then
                        begin
                          //
                          spdNFeDataSets.Campo('cBenef_I05f').Value     := RetornaValorDaTagNoCampo('cBenef',Form7.ibDataSet4.FieldByname('TAGS_').AsString);      // Cdigo de Benefcio Fiscal na UF aplicado ao item
                          //
                          if AllTrim(RetornaValorDaTagNoCampo('motDesICMS',Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                          begin
                            //
                            spdNFeDataSets.Campo('motDesICMS_N28').Value  := RetornaValorDaTagNoCampo('motDesICMS',Form7.ibDataSet4.FieldByname('TAGS_').AsString);  // Motivo da desonerao do ICMS
                            //
                            if (Form7.ibDataSet16BASE.Asfloat <> 100) and (Form7.ibDataSet16BASE.Asfloat <> 0) then
                            begin
                              //
                              Form7.IBQuery14.Close;
                              Form7.IBQuery14.SQL.Clear;
                              Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                              Form7.IBQuery14.Open;
                              //
                              fAliquotaPadrao := (Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat)/100;
                              fPercentualDeReducaoDeBC := (100 - ibDataSet16.FieldByname('BASE').AsFloat)/100;
                              //
                              //
                              fICMSDesonerado := ibDataSet16.FieldByname('TOTAL').AsFloat * ( 1 - ( fAliquotaPadrao * ( 1 - fPercentualDeReducaoDeBC))) / ( 1 - fAliquotaPadrao) - ibDataSet16.FieldByname('TOTAL').AsFloat;
                              //
{
                              ShowMessage('Teste do valor do ICMS desonerado:'+chr(10)+
                                                                               chr(10)+
                                                                               'Aliquotapadro: '+FloatToStr(fAliquotaPadrao)+chr(10)+
                                                                               'PercentualDeReducao De BC: '+FloatToStr(fPercentualDeReducaoDeBC)+chr(10)+
                                                                               'Preo na Nota Fiscal: '+ibDataSet16.FieldByname('TOTAL').AsString+chr(10)+
                                                                               'Valor do ICMS Desonerado: '+FloatToStr(fICMSDesonerado) );
}
                            end else
                            begin
                              //
                              if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                              begin
                                //
                                // Nova rotina para posicionar na tabla de CFOP
                                //
                                Form7.IBQuery14.Close;
                                Form7.IBQuery14.SQL.Clear;
                                Form7.IBQuery14.SQL.Add('select * from ICM where ST='+QuotedStr(Form7.ibDataSet4ST.AsString)+''); // Nova rotina
                                Form7.IBQuery14.Open;
                                //
                                if Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat = 0 then
                                begin
                                  //
                                  Form7.IBQuery14.Close;
                                  Form7.IBQuery14.SQL.Clear;
                                  Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                                  Form7.IBQuery14.Open;
                                  //
                                  fAliquotaPadrao := (Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat)/100;
                                  //
                                  fICMSDesonerado := ibDataSet16.FieldByname('TOTAL').AsFloat / (1 - fAliquotaPadrao)* fAliquotaPadrao;
                                  //
{
                                  ShowMessage('Teste do valor do ICMS desonerado:'+chr(10)+
                                                                                   chr(10)+
                                                                                   'Aliquotapadro: '+FloatToStr(fAliquotaPadrao)+chr(10)+
                                                                                   'Preo na Nota Fiscal: '+ibDataSet16.FieldByname('TOTAL').AsString+chr(10)+
                                                                                   'Valor do ICMS Desonerado: '+FloatToStr(fICMSDesonerado) );
}
                                end;
                                //
                                Form7.IBQuery14.Close;
                                Form7.IBQuery14.SQL.Clear;
                                Form7.IBQuery14.SQL.Add('select * from ICM where ST='+QuotedStr(Form7.ibDataSet4ST.AsString)+''); // Nova rotina
                                Form7.IBQuery14.Open;
                                //
                              end;
                            end;
                            //
{
                            if (Form7.ibDataSet16BASE.Asfloat <> 100) and (Form7.ibDataSet16BASE.Asfloat <> 0) then
                            begin
                              //
                              // ShowMessage('Teste do valor do ICMS desonerado - Reduo na base');
                              //
                              fICMSDesonerado := (ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat)/100*100/100) -
                                                 (ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat)/100*ibDataSet16.FieldByname('BASE').AsFloat/100);
                              //
                            end else
                            begin
                              //
                              // ShowMessage('Teste do valor do ICMS desonerado - Aliquota reduzida '+Form7.ibDataSet15OPERACAO.AsString);
                              //
                              Form7.IBQuery14.Close;
                              Form7.IBQuery14.SQL.Clear;
                              Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                              Form7.IBQuery14.Open;
                              //
                              fICMSDesonerado := (Form7.ibQuery14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat)/100*100/100)-
                                                 (ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat)/100*100/100);
                              //
                              //
                            end;
}
                            //
                            spdNFeDataSets.Campo('vICMSDeson_N28a').Value := StrTran(Alltrim(FormatFloat('##0.00',
                            fICMSDesonerado
                              )),',','.');  // Valor do ICMS desonerado
                            //
                            vICMSDeson := vICMSDeson + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMSDeson_N28a').AsString,',',''),'.',','));
                            //
                          end;
                          //
                        end;
                      end;
                      //
                    end else
                    begin
                      //
                      // Servio
                      //
                      spdNFeDataSets.Campo('NCM_I05').Value      := '00'; // Cdigo do NCM - informar de acordo com o Tabela oficial do NCM
                    end;
                    //
                    spdNFeDataSets.Campo('CFOP_I08').Value     := Alltrim(ibDataSet16.FieldByname('CFOP').AsString); // CFOP incidente neste Item da NF
                    if Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)) <> '' then spdNFeDataSets.Campo('uCom_I09').Value     := ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString) // Unidade de Medida do Item
                      else spdNFeDataSets.Campo('uCom_I09').Value     := 'UND';
                    spdNFeDataSets.Campo('qCom_I10').Value     := StrTran(ibDataSet16.FieldByname('QUANTIDADE').AsString,',','.'); // Quantidade Comercializada do Item
                    spdNFeDataSets.Campo('vUnCom_I10a').Value  := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet16.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Comercializado do Item
                    spdNFeDataSets.Campo('vProd_I11').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor Total Bruto do Item
                    //
                    if AllTrim(Form7.ibDataSet4CEST.AsString) <> '' then
                    begin
                      spdNFeDataSets.Campo('CEST_I05c').Value    := Form7.ibDataSet4CEST.AsString; // Cdigo CEST
                    end;
                    //
                    // B2B
                    //
                    if (Copy(Form7.ibDataSet16XPED.AsString,1,2) <> 'CF') then
                    begin
                      if AllTrim(Form7.ibDataSet16XPED.AsString)     <> '' then spdNFeDataSets.Campo('xPed_I60').AsString       := AllTrim(Form7.ibDataSet16XPED.AsString);
                      if AllTrim(Form7.ibDataSet16NITEMPED.AsString) <> '' then spdNFeDataSets.Campo('nItemPed_I61').AsString   := AllTrim(Form7.ibDataSet16NITEMPED.AsString);
                    end;
                    //
                    // B2B
                    //

  {
                    //
                    // incluir na 2014
                    //
                    if (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1) = '3') or
                       (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1) = '5') or
                       (Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1) = '8') then
                    begin
                      sEx70  := Form1.Small_InputForm( 'Origem da mercadoria = '+(Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',1,1)) ,'Item: '+chr(10)+chr(10)+ibDataSet4.FieldByname('DESCRICAO').AsString+chr(10)+chr(10)+ 'Nmero de controle da FCI - Ficha de Contedo de Importao: ',sEx70);
                      spdNFeDataSets.Campo('nFCI_I70').Value           := sEx70; // Nmero de controle da FCI - Ficha de Contedo de Importao
                    end;
  }

                    //
                    // Tributos
                    //
                    if bTributa then
                    begin
                      //
                      if Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '7' then // Exportao
                      begin
  //                    if Form7.ibDataSet2ESTADO.AsString <> 'EX' then
                        if  (ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]*ibDataSet4.FieldByname('IIA').AsFloat/100)) > 0  then
                        begin
                          //
                          spdNFeDataSets.Campo('vTotTrib_M02').Value  :=  StrTran(Alltrim(FormatFloat('##0.00',
                          Arredonda(((ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]))*ibDataSet4.FieldByname('IIA').AsFloat/100),2) +    // Federais
                          Arredonda(((ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]))*ibDataSet4.FieldByname('IIA_UF').AsFloat/100),2) + // Estaduais
                          Arredonda(((ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]))*ibDataSet4.FieldByname('IIA_MUNI').AsFloat/100),2) // Municipais
                          )),',','.'); // Valor aproximado total de tributos
                          //
                          // Federais
                          //
                          fTotaldeTriubutos := fTotaldeTriubutos +
                          Arredonda(((ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]))*ibDataSet4.FieldByname('IIA').AsFloat/100),2);
                          //
                          // Estaduais
                          //
                          fTotaldeTriubutos_uf := fTotaldeTriubutos_uf +
                          Arredonda(((ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]))*ibDataSet4.FieldByname('IIA_UF').AsFloat/100),2);
                          //
                          // Municipais
                          //
                          fTotaldeTriubutos_muni := fTotaldeTriubutos_muni +
                          Arredonda(((ibDataSet16.FieldByname('TOTAL').AsFloat-(fDesconto[I]))*ibDataSet4.FieldByname('IIA_MUNI').AsFloat/100),2);
                          //
                        end;
                      end
                      //
                    end;
                    //
                    try
                      if ibDataSet15.FieldByname('DESCONTO').AsFloat <> 0 then fRateioDoDesconto  := Arredonda((ibDataSet15.FieldByname('DESCONTO').AsFloat / ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.ibDataSet16.FieldByname('TOTAL').AsFloat),2) else fRateioDoDesconto := 0; // REGRA DE TRS ratiando o desconto no total
                    except
                      fRateioDoDesconto := 0;
                    end;
                    //
                    // Campo obrigatrio
                    //
                    if (Pos(Alltrim(Form7.ibDataSet16.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then  // 5104 Industrializao efetuada para outra empresa no soma na base
                    begin
                      //
                      if ibDataSet15.FieldByname('DESCONTO').AsFloat <> 0 then if (fDesconto[I]) > 0.01 then spdNFeDataSets.Campo('vDesc_I17').Value    := StrTran(Alltrim(FormatFloat('##0.00',fDesconto[I])),',','.'); // REGRA DE TRS ratiando o valor do frete Valor Total do Desconto
                      //
  //                    if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                      begin
                        if ibDataSet15.FieldByname('DESPESAS').AsFloat <> 0 then if (fOutras[I])   > 0.01 then spdNFeDataSets.Campo('vOutro_I17a').Value  := StrTran(Alltrim(FormatFloat('##0.00',(fOutras[I]))),',','.'); // REGRA DE TRS ratiando o valor de outras
                      end;
                      //
                      if ibDataSet15.FieldByname('FRETE').AsFloat    <> 0 then if (fFrete[I])    > 0.01 then spdNFeDataSets.Campo('vFrete_I15').Value   := StrTran(Alltrim(FormatFloat('##0.00',(fFrete[I]))),',','.');   // REGRA DE TRS ratiando o valor do frete Valor Total do Frete
                      if ibDataSet15.FieldByname('SEGURO').AsFloat   <> 0 then if (fseguro[I])   > 0.01 then spdNFeDataSets.Campo('vSeg_I16').Value     := StrTran(Alltrim(FormatFloat('##0.00',(fSeguro[I]))),',','.'); // REGRA DE TRS ratiando o valor do frete Valor Total do Seguro
                      //
                      fSomaNaBase := 0;
                      //
                      if ibDataSet15.FieldByname('FRETE').AsFloat    <> 0 then if (fFrete[I])    > 0.01 then fSomaNaBase  := fSomanaBase + (fFrete[I]);    // REGRA DE TRS ratiando o valor Total do Frete
                      if ibDataSet15.FieldByname('SEGURO').AsFloat   <> 0 then if (fSeguro[I])   > 0.01 then fSomaNaBase  := fSomanaBase + (fSeguro[I]);   // REGRA DE TRS ratiando valor do Seguro
                      //
                      if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
                      begin
                        if ibDataSet15.FieldByname('DESPESAS').AsFloat <> 0 then if (fOutras[I])   > 0.01 then fSomaNaBAse  := fSomanaBase + (fOutras[I]);   // REGRA DE TRS ratiando o valor de outras
                      end;
                      //
                      if ibDataSet15.FieldByname('DESCONTO').AsFloat <> 0 then if (fDesconto[I]) > 0.01 then fSomaNaBase  := fSomanaBase - (fDesconto[I]); // REGRA DE TRS ratiando o valor do frete descontando
                      //
                    end else
                    begin
                      //
                      fSomaNaBase := 0;
                      //
                    end;
                    //
                    if (Form7.ibDataSet14SOBREIPI.AsString = 'S') then
                    begin
                      //
                      // ICM Sobre o IPI
                      //
                      fSomaNaBase := fSomaNaBase + ibDataSet16.FieldByname('IPI').AsFloat * ibDataSet16.FieldByname('TOTAL').AsFloat / 100;  // Soma o valor do IPI na base
                      //
                    end;
                    //
                    if (Pos(Alltrim(Form7.ibDataSet16.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5104 Industrializao efetuada para outra empresa no soma na base
                    begin
                      spdNFeDataSets.Campo('indTot_I17b').Value   := '1'; // 0 - O valor do Item NO compe o valor total da nota 1 - O valor do Item compe o valor total da nota
                    end else
                    begin
                      spdNFeDataSets.Campo('indTot_I17b').Value   := '0'; // 0 - O valor do Item NO compe o valor total da nota 1 - O valor do Item compe o valor total da nota
                    end;
                    //
                    spdNFeDataSets.Campo('cEANTrib_I12').Value := 'SEM GTIN'; // EAN do Produto
                    //
                    if (RetornaValorDaTagNoCampo('cEANTrib', Form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '') and (_ecf65_ValidaGtinNFCe(RetornaValorDaTagNoCampo('cEANTrib', Form7.ibDataSet4.FieldByname('TAGS_').AsString))) then
                      spdNFeDataSets.Campo('cEANTrib_I12').Value := RetornaValorDaTagNoCampo('cEANTrib', Form7.ibDataSet4.FieldByname('TAGS_').AsString)
                    else
                      if _ecf65_ValidaGtinNFCe(Form7.ibDataSet4.FieldByname('REFERENCIA').AsString) then
                        spdNFeDataSets.Campo('cEANTrib_I12').Value := LimpaNumero(Form7.ibDataSet4.FieldByname('REFERENCIA').AsString); // EAN do Produto
                    //
                    // Quantidade tributvel
                    //
                    if RetornaValorDaTagNoCampo('uTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then
                    begin
                      //
                      spdNFeDataSets.Campo('uTrib_I13').Value    := RetornaValorDaTagNoCampo('uTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      //
                      if LimpaNumero(RetornaValorDaTagNoCampo('qTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        spdNFeDataSets.Campo('qTrib_I14').Value    := FormatFloatXML(ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat( RetornaValorDaTagNoCampo('qTrib',form7.ibDataSet4.FieldByname('TAGS_').AsString)  ));  // Quantidade Tributvel do Item
                        spdNFeDataSets.Campo('vUnTrib_I14a').Value := FormatFloatXML(ibDataSet16.FieldByname('TOTAL').AsFloat / StrToFloat(StrTran(spdNFeDataSets.Campo('qTrib_I14').AsString,'.',',')),10); // Valor Tributvel do Item
                      end else
                      begin
                        spdNFeDataSets.Campo('qTrib_I14').Value    := StrTran(ibDataSet16.FieldByname('QUANTIDADE').AsString,',','.');  // Quantidade Tributvel do Item
                        spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet16.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Tributvel do Item
                      end;
                    end else
                    begin
                      if Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)) <> '' then spdNFeDataSets.Campo('uTrib_I13').Value    := ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString) else spdNFeDataSets.Campo('uTrib_I13').Value    := 'UND'; // Unidade de Medida Tributvel do Item
                      spdNFeDataSets.Campo('qTrib_I14').Value    := StrTran(ibDataSet16.FieldByname('QUANTIDADE').AsString,',','.');  // Quantidade Tributvel do Item
                      spdNFeDataSets.Campo('vUnTrib_I14a').Value := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet16.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Tributvel do Item
                    end;
                    //
                    // FCI
                    //
                    if AllTrim(Form7.ibDataSet4CODIGO_FCI.AsString) <> '' then
                    begin
                      //
                      spdNFeDataSets.Campo('nFCI_I70').Value := Form7.ibDataSet4CODIGO_FCI.AsString; // Nmero de controle da FCI - Ficha de Contedo de Importao
                      //
                      // Informao relacionada com a Resoluo 13/2012 do
                      // Senado Federal. Formato: Algarismos, letras maisculas
                      // de "A" a "F" e o caractere hfen. Exemplo:
                      // B01F70AF-10BF-4B1F-848C-65FF57F616FE
                      //
                    end;
                    //
                    // JA. Detalhamento Especfico de Veculos Novos
                    //
                    if RetornaValorDaTagNoCampo('tpOp',form7.ibDataSet4.FieldByname('TAGS_').AsString)<> '' then
                    begin
                      //
                      // Pegar estes dados nas tags do produto
                      //
                      stpOp_VeiculosNovos     := RetornaValorDaTagNoCampo('tpOp',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      spot_VeiculosNovos      := RetornaValorDaTagNoCampo('pot',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      scilin_VeiculosNovos    := RetornaValorDaTagNoCampo('cilin',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      spesoL_VeiculosNovos    := RetornaValorDaTagNoCampo('pesoL',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      spesoB_VeiculosNovos    := RetornaValorDaTagNoCampo('pesoB',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      stpComb_VeiculosNovos   := RetornaValorDaTagNoCampo('tpComb',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      sCMT_VeiculosNovos      := RetornaValorDaTagNoCampo('CMT',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      sdist_VeiculosNovos     := RetornaValorDaTagNoCampo('dist',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      sanoMod_VeiculosNovos   := RetornaValorDaTagNoCampo('anoMod',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      sanoFab_VeiculosNovos   := RetornaValorDaTagNoCampo('anoFab',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      stpPint_VeiculosNovos   := RetornaValorDaTagNoCampo('tpPint',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      stpVeic_VeiculosNovos   := RetornaValorDaTagNoCampo('tpVeic',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      sespVeic_VeiculosNovos  := RetornaValorDaTagNoCampo('espVeic',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      sVIN_VeiculosNovos      := RetornaValorDaTagNoCampo('VIN',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      scondVeic_VeiculosNovos := RetornaValorDaTagNoCampo('condVeic',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      scMod_VeiculosNovos     := RetornaValorDaTagNoCampo('cMod',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      slota_VeiculosNovos     := RetornaValorDaTagNoCampo('lota',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                      //
                      // Pegar estes dados na funo dados
                      //
                      Form29.Label_01.Visible := True;
                      Form29.Label_02.Visible := True;
                      Form29.Label_03.Visible := True;
                      Form29.Label_04.Visible := True;
                      Form29.Label_05.Visible := True;
                      Form29.Label_06.Visible := True;
                      Form29.Label_07.Visible := True;
                      //
                      Form29.Edit_01.Visible := True;
                      Form29.Edit_02.Visible := True;
                      Form29.Edit_03.Visible := True;
                      Form29.Edit_04.Visible := True;
                      Form29.Edit_05.Visible := True;
                      Form29.Edit_06.Visible := True;
                      Form29.Edit_07.Visible := True;
                      //
                      Form29.Label_01.Caption := 'Chassi do veculo VIN (cdigo-identificao-veculo):';
                      Form29.Label_02.Caption := 'Cor Cdigo de cada montadora:';
                      Form29.Label_03.Caption := 'Descrio da Cor:';
                      Form29.Label_04.Caption := 'Serial (srie):';
                      Form29.Label_05.Caption := 'Nmero de Motor:';
                      Form29.Label_06.Caption := 'Cdigo da Cor (Ver tab. DENATRAN):';
                      Form29.Label_07.Caption := 'Restrio:'+chr(10)+chr(10)+'0=No h'+chr(10)+'1=Alienao Fiduciria'+chr(10)+'2=Arrendamento Mercantil'+chr(10)+'3=Reserva de Domnio'+chr(10)+'4=Penhor de Veculos'+chr(10)+'9=Outras';
                      //
                      Form29.Edit_01.Text := '';
                      Form29.Edit_02.Text := '';
                      Form29.Edit_03.Text := '';
                      Form29.Edit_04.Text := '';
                      Form29.Edit_05.Text := '';
                      Form29.Edit_06.Text := '';
                      Form29.Edit_07.Text := '';
                      //
                      Form1.Small_InputForm_Dados('Detalhamento de Veculos novos: '+ibDataSet4.FieldByname('DESCRICAO').AsString);
                      //
                      sChassi_VeiculosNovos       := Form29.Edit_01.Text;
                      sCCor_VeiculosNovos         := Form29.Edit_02.Text;
                      sXCor_VeiculosNovos         := Form29.Edit_03.Text;
                      snSerie_VeiculosNovos       := Form29.Edit_04.Text;
                      snMotor_VeiculosNovos       := Form29.Edit_05.Text;
                      scCorDENATRAN_VeiculosNovos := Form29.Edit_06.Text;
                      stpRest_VeiculosNovos       := Form29.Edit_07.Text;
                      //
                      spdNFeDataSets.Campo('tpOp_J02').Value          := stpOp_VeiculosNovos;         // 1=Venda concessionria, 2=Faturamento direto para consumidor final 3=Venda direta para grandes consumidores (frotista, governo, ...) 0=Outros
                      spdNFeDataSets.Campo('chassi_J03').Value        := sChassi_VeiculosNovos;       // Chassi do veculo VIN (cdigo-identificao-veculo)
                      spdNFeDataSets.Campo('cCor_J04').Value          := sCCor_VeiculosNovos;         // Cor Cdigo de cada montadora
                      spdNFeDataSets.Campo('xCor_J05').Value          := sXCor_VeiculosNovos;         // Descrio da Cor
                      spdNFeDataSets.Campo('pot_J06').Value           := sPot_VeiculosNovos;          // Potncia Motor (CV) Potncia mxima do motor do veculo em cavalo vapor
                      spdNFeDataSets.Campo('cilin_J07').Value         := scilin_VeiculosNovos;        // Cilindradas Capacidade voluntria do motor expressa em centmetros cbicos (CC). (cilindradas) (v2.0)
                      spdNFeDataSets.Campo('pesoL_J08').Value         := spesoL_VeiculosNovos;        // Peso Lquido Em toneladas - 4 casas decimais
                      spdNFeDataSets.Campo('pesoB_J09').Value         := spesoB_VeiculosNovos;        // Peso Bruto Peso Bruto Total - em tonelada - 4 casas decimais
                      spdNFeDataSets.Campo('nSerie_J10').Value        := snSerie_VeiculosNovos;       // Serial (srie)
                      spdNFeDataSets.Campo('tpComb_J11').Value        := stpComb_VeiculosNovos;       // Tipo de combustvel
                      spdNFeDataSets.Campo('nMotor_J12').Value        := snMotor_VeiculosNovos;       // Nmero de Motor
                      spdNFeDataSets.Campo('CMT_J13').Value           := sCMT_VeiculosNovos;          // Capacidade Mxima de Trao CMT-Capacidade Mxima de Trao - em Toneladas 4 casas decimais (v2.0)
                      spdNFeDataSets.Campo('dist_J14').Value          := sdist_VeiculosNovos;         // Distncia entre eixos
                      spdNFeDataSets.Campo('anoMod_J16').Value        := sanoMod_VeiculosNovos;       // Ano Modelo de Fabricao
                      spdNFeDataSets.Campo('anoFab_J17').Value        := sanoFab_VeiculosNovos;       // Ano de Fabricao
                      spdNFeDataSets.Campo('tpPint_J18').Value        := stpPint_VeiculosNovos;       // Tipo de Pintura
                      spdNFeDataSets.Campo('tpVeic_J19').Value        := stpVeic_VeiculosNovos;       // Tipo de Veculo Utilizar Tabela RENAVAM, conforme exemplos abaixo: 02=CICLOMOTO; 03=MOTONETA; 04=MOTOCICLO; 05=TRICICLO; 06=AUTOMVEL; 07=MICRONIBUS; 08=NIBUS; 10=REBOQUE; 11=SEMIRREBOQUE; 13=CAMINHONETA; 14=CAMINHO; 17=C. TRATOR; 22=ESP / NIBUS; 23=MISTO / CAM; 24=CARGA/CAM; ...
                      spdNFeDataSets.Campo('espVeic_J20').Value       := sespVeic_VeiculosNovos;      // Espcie de Veculo Utilizar Tabela RENAVAM 1=PASSAGEIRO; 2=CARGA; 3=MISTO; 4=CORRIDA; 5=TRAO; 6=ESPECIAL;
                      spdNFeDataSets.Campo('VIN_J21').Value           := sVIN_VeiculosNovos;          // Condio do VIN Informa-se o veculo tem VIN (chassi) remarcado. R=Remarcado; N=Normal
                      spdNFeDataSets.Campo('condVeic_J22').Value      := scondVeic_VeiculosNovos;     // Condio do Veculo 1=Acabado; 2=Inacabado; 3=Semiacabado
                      spdNFeDataSets.Campo('cMod_J23').Value          := scMod_VeiculosNovos;         // Cdigo Marca Modelo Utilizar Tabela RENAVAM
                      spdNFeDataSets.Campo('cCorDENATRAN_J24').Value  := scCorDENATRAN_VeiculosNovos; // Cdigo da Cor Segundo as regras de pr-cadastro do DENATRAN (v2.0) 01=AMARELO, 02=AZUL, ...
                      spdNFeDataSets.Campo('lota_J25').Value          := slota_VeiculosNovos;         // Capacidade mxima de lotao Quantidade mxima permitida de passageiros sentados, inclusive o motorista. (v2.0)
                      spdNFeDataSets.Campo('tpRest_J26').Value        := stpRest_VeiculosNovos;       // Restrio 0=No h; 1=Alienao Fiduciria; 2=Arrendamento Mercantil; 3=Reserva de Domnio; 4=Penhor de Veculos; 9=Outras. (v2.0)
                      //
                      if spdNFeDataSets.Campo('tpOp_J02').Value = '2' then
                      begin
                        spdNFeDataSets.Campo('CNPJ_G02').Value        :=  spdNFeDataSets.Campo('CNPJ_E02').Value;    // CNPJ Informar CNPJ ou CPF
                        spdNFeDataSets.Campo('CPF_G02a').Value        :=  spdNFeDataSets.Campo('CPF_E03').Value;     // CPF Preencher os zeros no significativos
                        spdNFeDataSets.Campo('xLgr_G03').Value        :=  spdNFeDataSets.Campo('xLgr_E06').Value;    // Logradouro
                        spdNFeDataSets.Campo('nro_G04').Value         :=  spdNFeDataSets.Campo('nro_E07').Value;     // Nmero
                        spdNFeDataSets.Campo('xBairro_G06').Value     :=  spdNFeDataSets.Campo('xBairro_E09').Value; // Bairro
                        spdNFeDataSets.Campo('cMun_G07').Value        :=  spdNFeDataSets.Campo('cMun_E10').Value;    // Cdigo do municpio Utilizar a Tabela do IBGE (Anexo IX - Tabela de UF, Municpio e Pas). Informar 9999999 para operaes com o exterior.
                        spdNFeDataSets.Campo('xMun_G08').Value        :=  spdNFeDataSets.Campo('xMun_E11').Value;    // Nome do municpio E G01 C 1-1 2-60 Informar EXTERIOR para operaes com o exterior.
                        spdNFeDataSets.Campo('UF_G09').Value          :=  spdNFeDataSets.Campo('UF_E12').Value;      // Sigla da UF Informar EX para operaes com o exterior.
                        spdNFeDataSets.Campo('xCpl_G05').Value        :=  ''; // Complemento
                      end;
                      //
                    end;
                    //
                    // Combustveis
                    //
                    try
                      //
                      if (copy(ibDAtaSet16CFOP.AsString,2,2)='65') or (copy(ibDAtaSet16CFOP.AsString,2,2)='66') then
                      begin
                        //
                        if RetornaValorDaTagNoCampo('cProdANP',form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then
                        begin
                          sCodigoANP := RetornaValorDaTagNoCampo('cProdANP',form7.ibDataSet4.FieldByname('TAGS_').AsString);
                        end;
                        //
                        while Length(sCodigoANP) <> 9 do
                        begin
                          sCodigoANP := LimpaNumero(Form1.Small_InputForm('Cdigo ANP',chr(10)+'Informe o cdigo ANP:'+chr(10)+chr(10)+'(Esta informao pode ser digitada no controle de estoque na aba Tags: cProdANP: 000000000)', ''));
                        end;
                        //
                        if Length(sCodigoANP) = 9 then
                        begin
                          //
                          if AllTrim(RetornaValorDaTagNoCampo('cProdANP',form7.ibDataSet4.FieldByname('TAGS_').AsString)) = '' then
                          begin
                            //
                            if not (Form7.ibDataset4.State in ([dsEdit, dsInsert])) then Form7.ibDataset4.Edit;
                            Form7.ibDataSet4TAGS_.AsString := Form7.ibDataSet4TAGS_.AsString + chr(10) + '<cProdANP>'+sCodigoANP + '</cProdANP>';
                            Form7.ibDataset4.Post;
                            Form7.ibDataset4.Edit;
                            //
                          end;
                          //
                          spdNFeDataSets.incluirPart('L1');
                          spdNFeDataSets.Campo('cProdANP_LA02').value := sCodigoANP; // Cdigo de produto da ANP
                          spdNFeDataSets.Campo('UFCons_LA06').value   := ibDAtaSet99.FieldByname('UF').AsString; // Sigla do Estado do Destinatrio
                          //
                          if Form1.sVersaoLayout = '4.00' then
                          begin
                            //
                            if (RetornaValorDaTagNoCampo('descANP', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') then
                            begin
                              ShowMessage('Incluir no controle de estoque na aba Tags: descANP: Descrio do produto conforme ANP');
                            end else
                            begin
                              spdNFeDataSets.campo('descANP_LA03').Value := RetornaValorDaTagNoCampo('descANP',Form7.ibDataSet4TAGS_.AsString);                                                  // Descrio do produto conforme ANP

                            end;
                            //
                            if (spdNFeDataSets.Campo('cProdANP_LA02').Value = '210203001') then
                            begin
                              //
                              if (RetornaValorDaTagNoCampo('pGLP', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') or
                                 (RetornaValorDaTagNoCampo('pGNn', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') or
                                 (RetornaValorDaTagNoCampo('pGNi', Form7.ibDataSet4.FieldByname('TAGS_').AsString) = '') then
                              begin
                                ShowMessage('Incluir no controle de estoque na aba Tags:'+
                                            Chr(10)+
                                            Chr(10)+'pGLP: 0,0000'+
                                            Chr(10)+'pGNn: 0,0000'+
                                            Chr(10)+'pGNi: 0,0000'+
                                            Chr(10)+'vPart: 0,00'
                                            );
                                Abort;
                              end else
                              begin
                                //
                                if (StrToFloatDef(RetornaValorDaTagNoCampo('pGLP', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                + StrToFloatDef(RetornaValorDaTagNoCampo('pGNn', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                + StrToFloatDef(RetornaValorDaTagNoCampo('pGNi', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)) <> 100 then
                                begin
                                  //
                                  ShowMessage('Erro: LA01 grupo LA Combustvel (pGLP + pGNn + pGNi) = '
                                  + FormatFloat('#,##0.0000', StrToFloatDef(RetornaValorDaTagNoCampo('pGLP', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                  + StrToFloatDef(RetornaValorDaTagNoCampo('pGNn', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)
                                  + StrToFloatDef(RetornaValorDaTagNoCampo('pGNi', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)) + '%' + Chr(10)
                                  + 'Rejeio: Somatrio percentuais de GLP derivado do petrleo, pGLP(id:LA03a) e pGNn(id:LA03b) e pGNi(id:LA03c) diferente de 100. Verifique no cadastro do produto '
                                                            + Chr(10) + spdNFeDataSets.Campo('cProd_I02').Value + ' ' + spdNFeDataSets.Campo('xProd_I04').Value);
                                  Abort;
                                  //
                                end else
                                begin
                                  //
                                  spdNFeDataSets.Campo('pGLP_LA03a').Value   := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pGLP', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0),4);  // Percentual do GLP derivado do petrleo no produto GLP (cProdANP=210203001) E LA01 N 0-1 3v4 Informar em nmero decimal o percentual do GLP derivado de petrleo no produto GLP. Valores de 0 a 100.
                                  spdNFeDataSets.Campo('pGNn_LA03b').Value   := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pGNn', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0),4);  // Percentual de Gs Natural Nacional  GLGNn para o produto GLP (cProdANP=210203001) E LA01 N 0-1 3v4 Informar em nmero decimal o percentual do Gs Natural Nacional  GLGNn para o produto GLP. Valores de 0 a 100.
                                  spdNFeDataSets.Campo('pGNi_LA03c').Value   := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pGNi', form7.ibDataSet4.FieldByname('TAGS_').AsString), 0),4);  // Percentual de Gs Natural Importado  GLGNi para o produto GLP (cProdANP=210203001) E LA01 N 0-1 3v4 Informar em nmero decimal o percentual do Gs Natural Importado  GLGNi para o produto GLP. Valores de 0 a 100.
                                  //
                                end;
                              end;
                            end;
                            //
                            if RetornaValorDaTagNoCampo('vPart', Form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then spdNFeDataSets.Campo('vPart_LA03d').Value := FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('vPart', Form7.ibDataSet4.FieldByname('TAGS_').AsString), 0)); // Valor de partida (cProdANP=210203001)
                            //
                          end;
                          //
                          spdNFeDataSets.SalvarPart('L1');
                          //
                        end;
                        //
                      end;
                    except end;

{
Decidimos no informar estas TAGs porque quando informa pede as TAGs de rastreabilidade


                    //
                    // Grupo K. Detalhamento Especfico de Medicamento e de matrias-primas farmacuticas
                    // ANVISA
                    // Grupo de detalhamento de Medicamentos (med)
                    //
                    if (Copy(Alltrim(spdNFeDataSets.Campo('NCM_I05').Value),1,4) = '3001') or
                       (Copy(Alltrim(spdNFeDataSets.Campo('NCM_I05').Value),1,4) = '3002') or
                       (Copy(Alltrim(spdNFeDataSets.Campo('NCM_I05').Value),1,4) = '3003') or
                       (Copy(Alltrim(spdNFeDataSets.Campo('NCM_I05').Value),1,4) = '3004') or
                       (Copy(Alltrim(spdNFeDataSets.Campo('NCM_I05').Value),1,4) = '3005') or
                       (Copy(Alltrim(spdNFeDataSets.Campo('NCM_I05').Value),1,4) = '3006') then
                    begin
                      //
                      if AllTrim(RetornaValorDaTagNoCampo('cProdANVISA',Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        //
                        spdNFeDataSets.Campo('cProdANVISA_K01a').Value      := RetornaValorDaTagNoCampo('cProdANVISA',Form7.ibDataSet4.FieldByname('TAGS_').AsString);  // Cdigo de Produto da ANVISA
                        //
                        if RetornaValorDaTagNoCampo('cProdANVISA',Form7.ibDataSet4.FieldByname('TAGS_').AsString) = 'ISENTO' then
                        begin
                          spdNFeDataSets.Campo('xMotivoIsencao_K01b').Value   := RetornaValorDaTagNoCampo('xMotivoIsencao',Form7.ibDataSet4.FieldByname('TAGS_').AsString);  // Motivo da iseno da ANVISA
                        end;
                        //
                        spdNFeDataSets.Campo('vPMC_K06').Value              :=  StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet4.FieldByname('PRECO').AsFloat)),',','.'); // Preo mximo consumidor
                        //
                        // Decidimos no informar estas TAGs porque quando informa pede as TAGs de rastreabilidade
                        //
                        spdNFeDataSets.Campo('nLote_I81').Value              := '00000000000000000001';   // Nmero do Lote do produto
                        spdNFeDataSets.Campo('qLote_I82').Value              := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet4.FieldByname('QTD_ATUAL').AsFloat)),',','.');;   // Quantidade de produto no Lote
                        spdNFeDataSets.Campo('dFab_I83').Value               := '2021-12-31';   // Data de fabricao/ Produo
                        spdNFeDataSets.Campo('dVal_I84').Value               := '2022-12-31';   // Data de validade
                        spdNFeDataSets.Campo('cAgreg_I85').Value             := '';   // Cdigo de Agregao
                        //
                      end;
                    end;
}

      ///////////////////////////////
      //
      // TAGS - Sada
      //
      ///////////////////////////////
                    //
                    //////////////////// Aqui comeam os Impostos Incidentes sobre o Item////////////////////////
                    /// Verificar Manual pois existe uma variao nos campos de acordo com Tipo de Tribucao ////
                    // ICMS
                    //

                    //
                    // fPercentualFCP
                    //
                    if (Form7.ibDataSet16PFCPUFDEST.AsFloat <> 0) or (Form7.ibDataSet16PICMSUFDEST.AsFloat <> 0) then
                    begin
                      //
                      // Quando preenche na nota no vai nada nessas tags
                      //
                      fPercentualFCP := 0; // Form7.ibDataSet16PFCPUFDEST.AsFloat;
                      fPercentualFCPST := 0; // fPercentualFCP; // tributos da NF-e
                      //
                    end else
                    begin
                      //
                      // Quando nao esta preenchido da nota pega valores nas tags
                      //
                      if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCP',Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        fPercentualFCP := StrTofloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCP',Form7.ibDataSet4.FieldByname('TAGS_').AsString))); // tributos da NF-e
                      end else
                      begin
                        fPercentualFCP := 0;
                      end;
                      //
                      // fPercentualFCPST
                      //
                      if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCPST',Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        fPercentualFCPST := StrTofloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCPST',Form7.ibDataSet4.FieldByname('TAGS_').AsString))); // tributos da NF-e
                      end else
                      begin
                        fPercentualFCPST := 0; // fPercentualFCP; // tributos da NF-e
                      end;
                      //
                    end;
                    //
                    if (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) <> '1') then
                    begin
                      ///////////////////////////////
                      //
                      // Incio TAGS sada por CST - CRT 2 ou 3 - Regime normal
                      //
                      ///////////////////////////////

                      //
                      // N11 e N12 todos Tem
                      //
                      try
                        if AllTrim(ibDAtaSet14.FieldByName('CST').AsString) <> '' then
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                          spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                          spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                        end;
                      except
                        spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                        spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                      end;
                      //
                      // Tem que voltar ao CFOP original da nota
                      //

                      //
                      // Posiciona na tabla de CFOP
                      //
                      if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                      begin
                        //
                        sReg := Form7.ibDataSet14REGISTRO.AsString;
                        Form7.ibDataSet14.DisableControls;
                        Form7.ibDataSet14.Close;
                        Form7.ibDataSet14.SelectSQL.Clear;
                        Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                        Form7.ibDataSet14.Open;
                        if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                        Form7.ibDataSet14.EnableControls;
                        //
                      end else
                      begin
                        //
                        Form7.ibDataSet14.DisableControls;
                        Form7.ibDataSet14.Close;
                        Form7.ibDataSet14.SelectSQL.Clear;
                        Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                        Form7.ibDataSet14.Open;
                        Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                        Form7.ibDataSet14.EnableControls;
                      end;
                      //
                      // TAGS
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '00')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '10')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '20')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '51')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '70')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        if (ibDataSet16.FieldByname('BASE').AsFloat = 0) then
                        begin
                          //
                          spdNFeDataSets.Campo('vBC_N15').Value   := '0'; // Valor da Base de Clculo do ICMS
                          spdNFeDataSets.Campo('vICMS_N17').Value := '0'; // Valor do ICMS em Reais
                          //
                        end else
                        begin
                          //
                          fIPIPorUnidade := 0;
                          //
                          if ((Form7.ibDataSet14SOBREIPI.AsString = 'S')) then
                          begin
                            //
                            // IPI Por Unidade
                            //
                            fIPIPorUnidade := 0;
                            if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                            begin
                              fIPIPorUnidade := (ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                            end;
                          end;
                          //
                          spdNFeDataSets.Campo('vBC_N15').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('BASE').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fIPIPorUnidade + fSomaNaBase )/100)),',','.');  // BC
                          spdNFeDataSets.Campo('vICMS_N17').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fIPIPorUnidade + fSomaNaBase )/100*ibDataSet16.FieldByname('BASE').AsFloat/100)),',','.');     // Valor do ICMS em Reais
                          //
                        end;
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '00' then
                      begin
                        //
                        // St 00
                        //
                        spdNFeDataSets.Campo('modBC_N13').Value   := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        spdNFeDataSets.Campo('pICMS_N16').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        //
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '10')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '30')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '60')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '70')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        // St 60 s tem N21 e N23
                        //
                        // Posiciona na tabla de CFOP
                        //
                        if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                        begin
                          //
                          sReg := Form7.ibDataSet14REGISTRO.AsString;
                          Form7.ibDataSet14.DisableControls;
                          Form7.ibDataSet14.Close;
                          Form7.ibDataSet14.SelectSQL.Clear;
                          Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                          Form7.ibDataSet14.Open;
                          if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                          Form7.ibDataSet14.EnableControls;
                          //
                        end else
                        begin
                          //
                          Form7.ibDataSet14.DisableControls;
                          Form7.ibDataSet14.Close;
                          Form7.ibDataSet14.SelectSQL.Clear;
                          Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                          Form7.ibDataSet14.Open;
                          Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                          Form7.ibDataSet14.EnableControls;
                        end;
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          //
                          if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                          begin
                            //
                            // IPI Por Unidade
                            //
                            fIPIPorUnidade := 0;
                            if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                            begin
                              fIPIPorUnidade := (ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                            end;
                            //
                            if ((Form7.ibDataSet14SOBREIPI.AsString = 'S')) and (Form7.ibDataSet16.FieldByname('IPI').AsFloat>0) then
                            begin
                              //
                              // CALCULO DO IVA
                              //
                              if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                              begin
                                //
                                // VINICULAS
                                //
                                try
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                  + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                  )
                                  * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2))),',','.'); // Valor da BST
                                except end;
                              end else
                              begin
                                spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                )
                                * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2))),',','.'); // Valor da BST
                              end;
                              //
                              if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                              begin
                                //
                                // Desconta o ICM normal
                                //
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    Arredonda(((
                                    (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                    )
                                    ) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - ((
                                    ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                    ),2))),',','.'); // Valor do ICMS ST em Reais

                                  except end;
                                end else
                                begin
                                  //
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda(
                                  Arredonda(((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                  + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                  )
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((
                                  ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                  + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                  ,2))),',','.'); // Valor do ICMS ST em Reais

                                  //
                                end;
                                //
                              end else
                              begin
                                //
                                // Desconta o ICM normal
                                //
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    arredonda(((
                                    (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                    )
                                    ) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat  / 100 )
                                    ),2))),',','.'); // Valor do ICMS ST em Reais


                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda(
                                  Arredonda(((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                  + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                  )
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                  + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat  / 100 )
                                  ,2))),',','.'); // Valor do ICMS ST em Reais


                                end;
                                //
                              end;
                              //
                            end else
                            begin
                              //
                              // CALCULO DO IVA
                              //
                              if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                              begin
                                //
                                // VINICULAS
                                //
                                try
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                  * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                except end;
                              end else
                              begin
                                spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda(( ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                              end;
                              if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                              begin
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    Arredonda((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)+ fIPIPorUnidade) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                    ),2) )),',','.'); // Valor do ICMS ST em Reais
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)+ fIPIPorUnidade) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end;
                              end else
                              begin
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    Arredonda((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)+ fIPIPorUnidade) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                    ),2) )),',','.'); // Valor do ICMS ST em Reais
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)+ fIPIPorUnidade) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end;
                              end;
                            end;
                            //
                            if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                            begin
                              //
                              //  CALCULO DO IVA
                              //
                              vIVA60_B_ICMST := vIVA60_B_ICMST + ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat;
                              //
                              if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                              begin
                                //
                                vIVA60_V_ICMST := vIVA60_V_ICMST + ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat
                                - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 );
                                //
                              end else
                              begin
                                //
                                vIVA60_V_ICMST := vIVA60_V_ICMST + ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat
                                - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 );
                                //
                              end;
                            end;
                            //
                            // Desconta o ICM sobre IPI normal do ST    CALCULO DO IVA
                            //
                            if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                            begin
                              //
                              // FICHA 2786
                              //
                              spdNFeDataSets.Campo('pST_N26a').Value              := '0.00'; // Aliquota suportada pelo consumidor
                              spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                              spdNFeDataSets.Campo('vbCSTRet_N26').Value          := '0.00'; // Valor cobrado anteriormente por ST ok
                              spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := '0.00'; // Valor do ICMS ST em Reais
                              //
                            end else
                            begin

                              spdNFeDataSets.Campo('vbCSTRet_N26').Value    := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                              (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat)
                              ),2) )),',','.'); // Valor da BC do ICMS ST cobrado anteriormente por ST (v2.0) NAO
                              //
                              if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                              begin
                                spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat
                                - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                ),2) )),',','.'); // Valor do ICMS ST em Reais
                              end else
                              begin
                                spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat
                                - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                ),2) )),',','.'); // Valor do ICMS ST em Reais
                              end;
                            end;
                            //
                          end;
                          //
                        end else
                        begin
                          //
                          if Form7.ibDataSet15BASESUBSTI.AsFloat <> 0 then
                          begin
                            //
                            if spdNFeDataSets.Campo('CST_N12').AssTring <> '60' then
                            begin
                              spdNFeDataSets.Campo('pMVAST_N19').Value      := '100'; // Percentual de margem de valor adicionado do ICMS ST
                            end;
                            //
                            // incluir + fSomaNaBase
                            //
                            if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                            begin
                              //
                              if spdNFeDataSets.Campo('indFinal_B25a').Value  = '1' then
                              begin
                                //
                                spdNFeDataSets.campo('pRedBCEfet_N34').Value      := StrTran(Alltrim(FormatFloat('##0.00',100-Form7.ibDataSet14BASE.AsFloat)),',','.');                                                                                              // Percentual de reduo da base de clculo efetiva
                                spdNFeDataSets.campo('vBCEfet_N35').Value         := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase) * Form7.ibDataSet14BASE.AsFloat / 100))),',','.');                              // Valor da base de clculo efetiva
                                spdNFeDataSets.campo('pICMSEfet_N36').Value       := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.');                                                                                                         // Alquota do ICMS efetiva
                                spdNFeDataSets.campo('vICMSEfet_N37').Value       := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16()*(((ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase) * Form7.ibDataSet14BASE.AsFloat / 100))/100)),',','.'); // Valor do ICMS efetivo
                                //
                              end else
                              begin
                                //
                                // Procura pela ltima compra deste item
                                //
                                Form7.ibQuery1.Close;
                                Form7.ibQuery1.Sql.Clear;
                                Form7.ibQuery1.Sql.Add('select first 1 ITENS002.CODIGO, ITENS002.QUANTIDADE, ITENS002.VBCST, ITENS002.VICMSST from ITENS002, COMPRAS where ITENS002.NUMERONF = COMPRAS.NUMERONF and Coalesce(ITENS002.VICMSST,0)<>0 and ITENS002.CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by COMPRAS.EMISSAO desc');
                                Form7.ibQuery1.Open;
                                //
                                if Form7.ibQuery1.FieldByname('VICMSST').AsFloat <> 0 then
                                begin
                                  //
                                  spdNFeDataSets.Campo('pST_N26a').Value              := StrTran(Alltrim(FormatFloat('##0.00',(Form7.ibQuery1.FieldByname('VICMSST').AsFloat / Form7.ibQuery1.FieldByname('VBCST').AsFloat)*100)),',','.');  // Aliquota suportada pelo consumidor
                                  spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                                  spdNFeDataSets.Campo('vbCSTRet_N26').Value          := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibQuery1.FieldByname('VBCST').AsFloat / Form7.ibQuery1.FieldByname('QUANTIDADE').AsFloat * Form7.ibDataSet16QUANTIDADE.AsFloat)),',','.');  // Valor do BC do ICMS ST retido na UF Emitente ok
                                  spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibQuery1.FieldByname('VICMSST').AsFloat / Form7.ibQuery1.FieldByname('QUANTIDADE').AsFloat * Form7.ibDataSet16QUANTIDADE.AsFloat)),',','.');  //  Valor do ICMS ST retido na UF Emitente
                                  //
                                end else
                                begin
                                  spdNFeDataSets.Campo('pST_N26a').Value              := '0.00'; // Aliquota suportada pelo consumidor
                                  spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                                  spdNFeDataSets.Campo('vbCSTRet_N26').Value          := '0.00'; // Valor cobrado anteriormente por ST Ok
                                  spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := '0.00'; // Valor do ICMS ST em Reais
                                end;
                                //
                              end;
                              //
                            end else
                            begin
                              //
                              spdNFeDataSets.Campo('vbCSTRet_N26').Value    := '0.00'; // Valor cobrado anteriormente por ST Ok
                              spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := '0.00'; // Valor do ICMS ST em Reais
                              //
                            end;
                            //
                            spdNFeDataSets.Campo('vbCST_N21').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor cobrado anteriormente por ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((AliqICMdoCliente16()*(ibDataSet16.FieldByname('TOTAL').AsFloat)/100),2) )),',','.'); // Valor do ICMS ST em Reais
                            //
                          end else
                          begin
                            //
                            if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                            begin
                              //
                              spdNFeDataSets.Campo('pMVAST_N19').Value      := '0'; // Percentual de margem de valor adicionado do ICMS ST
                              //
                              if spdNFeDataSets.Campo('indFinal_B25a').Value  = '1' then
                              begin
                                //
                                spdNFeDataSets.campo('pRedBCEfet_N34').Value      := StrTran(Alltrim(FormatFloat('##0.00',100-Form7.ibDataSet14BASE.AsFloat)),',','.');                                                                                              // Percentual de reduo da base de clculo efetiva
                                spdNFeDataSets.campo('vBCEfet_N35').Value         := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase) * Form7.ibDataSet14BASE.AsFloat / 100))),',','.');                              // Valor da base de clculo efetiva
                                spdNFeDataSets.campo('pICMSEfet_N36').Value       := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.');                                                                                                         // Alquota do ICMS efetiva
                                spdNFeDataSets.campo('vICMSEfet_N37').Value       := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16()*(((ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase) * Form7.ibDataSet14BASE.AsFloat / 100))/100)),',','.'); // Valor do ICMS efetivo
                                //
                              end else
                              begin
                                //
                                // Procura pela ltima compra deste item
                                //
                                Form7.ibQuery1.Close;
                                Form7.ibQuery1.Sql.Clear;
                                Form7.ibQuery1.Sql.Add('select first 1 ITENS002.CODIGO, ITENS002.QUANTIDADE, ITENS002.VBCST, ITENS002.VICMSST from ITENS002, COMPRAS where ITENS002.NUMERONF = COMPRAS.NUMERONF and Coalesce(ITENS002.VICMSST,0)<>0 and ITENS002.CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by COMPRAS.EMISSAO desc');
                                Form7.ibQuery1.Open;
                                //
                                if Form7.ibQuery1.FieldByname('VICMSST').AsFloat <> 0 then
                                begin
                                  //
                                  spdNFeDataSets.Campo('pST_N26a').Value              := StrTran(Alltrim(FormatFloat('##0.00',(Form7.ibQuery1.FieldByname('VICMSST').AsFloat / Form7.ibQuery1.FieldByname('VBCST').AsFloat)*100)),',','.');  // Aliquota suportada pelo consumidor
                                  spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                                  spdNFeDataSets.Campo('vbCSTRet_N26').Value          := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibQuery1.FieldByname('VBCST').AsFloat / Form7.ibQuery1.FieldByname('QUANTIDADE').AsFloat * Form7.ibDataSet16QUANTIDADE.AsFloat)),',','.');  // Valor do BC do ICMS ST retido na UF Emitente ok
                                  spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibQuery1.FieldByname('VICMSST').AsFloat / Form7.ibQuery1.FieldByname('QUANTIDADE').AsFloat * Form7.ibDataSet16QUANTIDADE.AsFloat)),',','.');  //  Valor do ICMS ST retido na UF Emitente
                                  //
                                end else
                                begin
                                  spdNFeDataSets.Campo('pST_N26a').Value              := '0.00'; // Aliquota suportada pelo consumidor
                                  spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                                  spdNFeDataSets.Campo('vbCSTRet_N26').Value          := '0.00'; // Valor cobrado anteriormente por ST Ok
                                  spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := '0.00'; // Valor do ICMS ST em Reais
                                end;
                                //
                              end;
                              //
                            end;
                            //
                            spdNFeDataSets.Campo('vbCST_N21').Value       := '0.00'; // Valor cobrado anteriormente por ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value     := '0.00';  // Valor do ICMS ST em Reais
                            //
                          end;
                          //
                        end;
                        //
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '10' then
                      begin
                        //
                        // St 10
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          spdNFeDataSets.Campo('modBC_N13').Value     := '0'; // Modalidade de determinao da Base de Clculo - ver Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('modBC_N13').Value     := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        end;
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                        //
                      end;
                      //
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '40') or (spdNFeDataSets.Campo('CST_N12').AssTring = '41') or (spdNFeDataSets.Campo('CST_N12').AssTring = '50') then
                      begin
                        spdNFeDataSets.Campo('vbCSTRet_N26').Value    := '';  // Valor cobrado anteriormente por ST
                        spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := '';  // Valor do ICMS ST em Reais
                        spdNFeDataSets.Campo('vBCSTDest_N31').Value   := '';  // Valor da BC do ICMS ST da UF Destino
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '20') or (spdNFeDataSets.Campo('CST_N12').AssTring = '51') then
                      begin
                        //
                        // St 20
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          spdNFeDataSets.Campo('modBC_N13').Value     := '0'; // Modalidade de determinao da Base de Clculo - ver Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('modBC_N13').Value     := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        end;
                        //
                        if (100-ibDataSet16.FieldByname('BASE').AsFloat) = 100 then
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := '100'; // Percentual da reduo de BC
                        end else
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet16.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        end;
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('vICMSOp_N16a').Value   := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2( (ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100*ibDataSet16.FieldByname('BASE').AsFloat/100) ,2))),',','.');
                        //
                        //
                        // Tag OBS no ICMS <pDIF>33,33</pDIF>
                        //
                        if RetornaValorDaTagNoCampo('pDif', form7.ibDataSet14.FieldByname('OBS').AsString) <> '' then
                        begin
                          spdNFeDataSets.Campo('pDif_N16b').Value      :=  FormatFloatXML(StrToFloatDef(RetornaValorDaTagNoCampo('pDif', form7.ibDataSet14.FieldByname('OBS').AsString), 0));
                        end else
                        begin
                          spdNFeDataSets.Campo('pDif_N16b').Value      := '100';
                        end;
                        //
                        // Frmula complexa poderia ser simplificada mas foi testada e est funcionando
                        //
                        spdNFeDataSets.Campo('vICMSDif_N16c').Value :=
                        StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100*ibDataSet16.FieldByname('BASE').AsFloat/100
                        )*StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pDif_N16b').AsString,',',''),'.',','))/100)),',','.');
                        //
                        //
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '51' then
                        begin
                          spdNFeDataSets.Campo('vICMS_N17').Value := StrTran(Alltrim(FormatFloat('##0.00',
                          Arredonda2( (ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100*ibDataSet16.FieldByname('BASE').AsFloat/100),2)
                          - StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMSDif_N16c').AsString,',',''),'.',','))
                          )),',','.');
                        end;
                        //
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '30' then
                      begin
                        //
                        // St 30
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                        //
                      end;
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                      begin
                        //
                        // St 60
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        spdNFeDataSets.Campo('pICMSST_N22').Value     := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                        //
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '70')
                      or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        // St 70
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          spdNFeDataSets.Campo('modBC_N13').Value     := '0'; // Modalidade de determinao da Base de Clculo - ver Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('modBC_N13').Value     := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                        end;
                        //
                        if (100-ibDataSet16.FieldByname('BASE').AsFloat) = 100 then
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := '100'; // Percentual da reduo de BC
                        end else
                        begin
                          spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet16.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        end;
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        //
                        if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                        begin
                          //
                          // VINICULAS
                          //
                          try
                            spdNFeDataSets.Campo('pREDBCST_N20').Value    :=  StrTran(Alltrim(FormatFloat('##0.00',  StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5))   )),',','.')
                          except end;
                        end else
                        begin
                          spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        end;
                        //
                      end;
                      //
                      if LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) = '1' then
                      begin
                        spdNFeDataSets.Campo('vBC_N15').Value     := '0';  // BC
                        spdNFeDataSets.Campo('vICMS_N17').Value   := '0';  // Valor do ICMS em Reais
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '30') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '10') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '70') or
                         (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := StrTran(Alltrim(FormatFloat('##0.00', (Form7.ibDataset4PIVA.AsFloat*100)-100 )),',','.'); // Percentual de margem de valor adicionado do ICMS ST
                          end else
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                          end;
                        end else
                        begin
                          spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                        end;
                      end;
                      //
                      // Sada empresa no Regime normal por CST
                      //
                      if Form1.sVersaoLayout = '4.00' then
                      begin
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                        begin
                          //
                          if Pos(sCodigoANP,pChar('210203001, 320101001, 320101002, 320102002, 320102001, 320102003, 320102005, 320201001, 320103001,'+
                                            '220102001, 320301001, 320103002, 820101032, 820101026, 820101027, 820101004, 820101005, 820101022,'+
                                            '820101031, 820101030, 820101014, 820101006, 820101016, 820101015, 820101025, 820101017, 820101018,'+
                                            '820101019, 820101020, 820101021, 420105001, 420101005, 420101004, 420102005, 420102004, 420104001,'+
                                            '820101033, 820101034, 420106001, 820101011, 820101003, 820101013, 820101012, 420106002, 830101001,'+
                                            '420301004, 420202001, 420301001, 420301002, 410103001, 410101001, 410102001, 430101004, 510101001,'+
                                            '510101002, 510102001, 510102002, 510201001, 510201003, 510301003, 510103001, 510301001')) <> 0 then
                          begin
                            spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                            spdNFeDataSets.Campo('CST_N12').Value    := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',2,2); // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                            spdNFeDataSets.Campo('vbCSTRet_N26').Value    := '0.00';  // Valor cobrado anteriormente por ST Ok
                            spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := '0.00';  // Valor do ICMS ST em Reais
                            spdNFeDataSets.Campo('vBCSTDest_N31').Value   := '0.00';  // Valor da BC do ICMS ST da UF Destino
                            spdNFeDataSets.Campo('vICMSSTDest_N32').Value := '0.00';  // Informar o valor do ICMS ST da UF destino
                          end;
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '00' then
                        begin
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            spdNFeDataSets.campo('pFCP_N17b').Value     := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCP)),',','.'); // Percentual do Fundo de Combate  Pobreza (FCP)
                            spdNFeDataSets.campo('vFCP_N17c').Value     := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*fPercentualFCP/100)),',','.'); // Valor do Fundo de Combate  Pobreza (FCP)
                          end;
                          //
                        end;
                        //

                        if spdNFeDataSets.Campo('CST_N12').AssTring = '10' then
                        begin
                          //
                          // fPercentualFCP
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            spdNFeDataSets.campo('vBCFCP_N17a').Value   := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',',')))),',','.'); ; // Valor da Base de Clculo do FCP
                            spdNFeDataSets.campo('pFCP_N17b').Value     := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCP)),',','.'); // Percentual do Fundo de Combate  Pobreza (FCP)
                            spdNFeDataSets.campo('vFCP_N17c').Value     := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*fPercentualFCP/100)),',','.'); // Valor do Fundo de Combate  Pobreza (FCP)
                          end;
                          //
                          // fPercentualFCPST
                          //
                          if fPercentualFCPST <> 0 then
                          begin
                            //
                            spdNFeDataSets.campo('vBCFCPST_N23a').Value  := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP retido por Substituio Tributria
                            spdNFeDataSets.campo('pFCPST_N23b').Value    := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCPST)),',','.'); // Percentual do FCP retido por Substituio Tributria
                            //
                            if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                            begin
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100)-(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vFCP_N17c').AsString,'.',','))))),',','.'); // Valor do FCP retido por Substituio Tributria
                            end else
                            begin
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100))),',','.'); // Valor do FCP retido por Substituio Tributria
                            end;
                            //
                          end;
                          //
                          // ok
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '20' then
                        begin
                          //
                          // fPercentualFCP
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            spdNFeDataSets.campo('vBCFCP_N17a').Value   := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP
                            spdNFeDataSets.campo('pFCP_N17b').Value     := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCP)),',','.'); // Percentual do Fundo de Combate  Pobreza (FCP)
                            spdNFeDataSets.campo('vFCP_N17c').Value     := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*fPercentualFCP/100)),',','.'); // Valor do Fundo de Combate  Pobreza (FCP)
                          end;
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '30' then
                        begin
                          //
                          // fPercentualFCP
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            fCalculo := (ibDataSet16.FieldByname('BASE').AsFloat * (ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100)*fPercentualFCP/100;
                          end;
                          //
                          // fPercentualFCPST
                          //
                          if fPercentualFCPST <> 0 then
                          begin
                            //
                            spdNFeDataSets.campo('vBCFCPST_N23a').Value  := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP retido por Substituio Tributria
                            spdNFeDataSets.campo('pFCPST_N23b').Value    := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCPST)),',','.'); // Percentual do FCP retido por Substituio Tributria
                            //
                            if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                            begin
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100)-(fCalculo))),',','.'); // Valor do FCP retido por Substituio Tributria
                            end else
                            begin
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100))),',','.'); // Valor do FCP retido por Substituio Tributria
                            end;
                            //
                          end;
                          //
                          // ok
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '51' then
                        begin
                          //
                          // fPercentualFCP
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            spdNFeDataSets.campo('vBCFCP_N17a').Value   := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP
                            spdNFeDataSets.campo('pFCP_N17b').Value     := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCP)),',','.'); // Percentual do Fundo de Combate  Pobreza (FCP)
                            spdNFeDataSets.campo('vFCP_N17c').Value     := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*fPercentualFCP/100)),',','.'); // Valor do Fundo de Combate  Pobreza (FCP)
                          end;
                          //
                        end;
                        //
                        if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                        begin
                          //
//                          spdNFeDataSets.campo('vBCFCPSTRet_N27a').Value := '0.00'; // Valor da Base de Clculo do FCP retido anteriormente por ST
//                          spdNFeDataSets.campo('pFCPSTRet_N27b').Value   := '0.00'; // Percentual do FCP retido anteriormente por Substituio Tributria
//                          spdNFeDataSets.campo('vFCPSTRet_N27d').Value   := '0.00'; // Valor do FCP retido por Substituio Tributria
                          //
                        end;
                        //
                        if (spdNFeDataSets.Campo('CST_N12').AssTring = '70') or (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                        begin
                          //
                          // fPercentualFCP
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            spdNFeDataSets.campo('vBCFCP_N17a').Value   := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',',')))),',','.'); ; // Valor da Base de Clculo do FCP
                            spdNFeDataSets.campo('pFCP_N17b').Value     := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCP)),',','.'); // Percentual do Fundo de Combate  Pobreza (FCP)
                            spdNFeDataSets.campo('vFCP_N17c').Value     := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*fPercentualFCP/100)),',','.'); // Valor do Fundo de Combate  Pobreza (FCP)
                          end;
                          //
                          // fPercentualFCPST
                          //
                          if fPercentualFCPST <> 0 then
                          begin
                            //
                            spdNFeDataSets.campo('vBCFCPST_N23a').Value  := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP retido por Substituio Tributria
                            spdNFeDataSets.campo('pFCPST_N23b').Value    := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCPST)),',','.'); // Percentual do FCP retido por Substituio Tributria
                            //
                            if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                            begin
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100)-(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vFCP_N17c').AsString,'.',','))))),',','.'); // Valor do FCP retido por Substituio Tributria
                            end else
                            begin
                              spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100))),',','.'); // Valor do FCP retido por Substituio Tributria
                            end;
                            //
                          end;
                          //
                          // ok
                          //
                        end;
                        //
                      end;
                      //
                      // final TAGS saada por CST - CRT 2 ou 3 - Regime normal
                      //
                      ///////////////////////////////
                      //
                    end;
                    //
                    if (LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) = '1') then
                    begin
                      ///////////////////////////////
                      //
                      // Incio TAGS sada por CSOSN - CRT = 1 imples Nacional
                      //
                      ///////////////////////////////

                      //
                      // TAGS - Simples NAcional - CSOSN
                      //
                      // N12a Tem em todas - e e referencia para classificar as tags
                      //
                      // Posiciona na tabla de CFOP
                      //
                      if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                      begin
                        //
                        sReg := Form7.ibDataSet14REGISTRO.AsString;
                        Form7.ibDataSet14.DisableControls;
                        Form7.ibDataSet14.Close;
                        Form7.ibDataSet14.SelectSQL.Clear;
                        Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                        Form7.ibDataSet14.Open;
                        if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                        Form7.ibDataSet14.EnableControls;
                        //
                        if not (AllTrim(ibDAtaSet14.FieldByName('CSOSN').AsString) <> '') then
                        begin
                          //
                          Form7.ibDataSet14.DisableControls;
                          Form7.ibDataSet14.Close;
                          Form7.ibDataSet14.SelectSQL.Clear;
                          Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                          Form7.ibDataSet14.Open;
                          Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                          Form7.ibDataSet14.EnableControls;
                          //
                        end;
                        //
                      end else
                      begin
                        //
                        Form7.ibDataSet14.DisableControls;
                        Form7.ibDataSet14.Close;
                        Form7.ibDataSet14.SelectSQL.Clear;
                        Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                        Form7.ibDataSet14.Open;
                        Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                        Form7.ibDataSet14.EnableControls;
                        //
                      end;
                      //
                      if AllTrim(ibDAtaSet14.FieldByName('CSOSN').AsString) <> '' then
                      begin
                        spdNFeDataSets.Campo('CSOSN_N12a').Value  := ibDataSet14.FieldByname('CSOSN').AsString;
                      end else
                      begin
                        spdNFeDataSets.Campo('CSOSN_N12a').Value  := ibDataSet4.FieldByname('CSOSN').AsString;
                      end;
                      //
                      // N11 - Tm em todas
                      //
                      try
                        if AllTrim(ibDAtaSet14.FieldByName('CST').AsString) <> '' then
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet14.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                        end else
                        begin
                          spdNFeDataSets.Campo('orig_N11').Value   := Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,1); //Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                        end;
                      except
                        spdNFeDataSets.Campo('orig_N11').Value   := '0';
                      end;
                      //
                      if  (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '101') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '102') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '103') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '201') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '202') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '203') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '300') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '400') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '500') and
                          (spdNFeDataSets.Campo('CSOSN_N12a').Value <> '900') then
                      begin
                        Form7.ibDataset15.Edit;
                        Form7.ibDataSet15STATUS.AsString    := 'Erro: Informe o CSOSN do produto '+ConverteAcentos2(ibDataSet4.FieldByname('DESCRICAO').AsString);
                        Abort;
                      end;
                      //
                      // CSOSN 101
                      //
                      if spdNFeDataSets.Campo('CSOSN_N12a').Value = '101' then
                      begin
                        //
                        // 101 Tributada pelo simples nacional com permisso de credito
                        //
                        if Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO' then
                        begin
                          //
                          // PERMITE O APROVEITAMENTO DO CRDITO DE ICMS NO VALOR DE R$; CORRESPONDENTE  ALQUOTA DE 2,82%, NOS TERMOS DO ART. 23 DA LC 123
                          //
                          try
                            fAliquota := StrToFloat(Alltrim(StrTran(Copy(Form7.ibDataSet14OBS.AsString,90,4),'.',',')));
                          except
                            fAliquota := 2.82;
                          end;
                          //
                        end else
                        begin
                          // fAliquota := 2.82;
                          fAliquota := 0;
                        end;
                        //
                        spdNFeDataSets.Campo('pCredSN_N29').VAlue       := StrTran(Alltrim(FormatFloat('##0.00',fAliquota)),',','.'); // Aliquota aplicave de clculo de crdito (Simples Nacional)
                        spdNFeDataSets.Campo('vCredICMSSN_N30').VAlue  := StrTran(Alltrim(FormatFloat('##0.00',((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * fAliquota / 100)),',','.'); // VAlor de crdito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)
                        //
                      end;
                      //
                      // CSOSN 102, 103, 300, 400
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '102')
                      or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '103')
                      or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '300')
                      or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '400') then
                      begin
                        //
                        // N11 - J esta preenchido acima todos tem
                        //
                      end;
                      //
                      // CSOSN 201 - Tributado pelo Simples Nacional Com permisso de Crdito e com cobrana do ICMS por substituio Tributria
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '201') then
                      begin
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := StrTran(Alltrim(FormatFloat('##0.00', (Form7.ibDataset4PIVA.AsFloat*100)-100 )),',','.'); // Percentual de margem de valor adicionado do ICMS ST
                          end else
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                          end;
                        end else
                        begin
                          spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                        end;
                        //
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                        if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                        begin
                          //
                          if Form7.ibDataSet4PIVA.AsFloat > 0 then
                          begin
                            try
                              //
                              // IPI Por Unidade
                              //
                              fIPIPorUnidade := 0;
                              if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                              begin
                                fIPIPorUnidade := (ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                              end;
                              //
                              if ((Form7.ibDataSet14SOBREIPI.AsString = 'S')) and (Form7.ibDataSet16.FieldByname('IPI').AsFloat>0) then
                              begin
                                //
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                    +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    )
                                     * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  )
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                end;
                                //
                                // Desconta o ICM sobre IPI normal do ST  CALCULO DO IVA
                                //
                                if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end;
                              end else
                              begin
                                //
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    )
                                     * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  )
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                end;
                                //
                                // Posiciona na tabla de CFOP
                                //
                                if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                                begin
                                  //
                                  sReg := Form7.ibDataSet14REGISTRO.AsString;
                                  Form7.ibDataSet14.DisableControls;
                                  Form7.ibDataSet14.Close;
                                  Form7.ibDataSet14.SelectSQL.Clear;
                                  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                  Form7.ibDataSet14.Open;
                                  if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                                  Form7.ibDataSet14.EnableControls;
                                  //
                                end else
                                begin
                                  //
                                  Form7.ibDataSet14.DisableControls;
                                  Form7.ibDataSet14.Close;
                                  Form7.ibDataSet14.SelectSQL.Clear;
                                  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                  Form7.ibDataSet14.Open;
                                  Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                                  Form7.ibDataSet14.EnableControls;
                                end;
                                //
                                // Desconta o ICM sobre IPI normal do ST  CALCULO DO IVA
                                //
                                if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end;
                              end;
                            except
                              //
                              Form7.ibDataset15.Edit;
                              Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o IVA do produto cdigo: '+ibDataSet4CODIGO.AsString;
                              Abort;
                              //
                            end;
                          end else
                          begin
                            spdNFeDataSets.Campo('vbCST_N21').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor cobrado anteriormente por ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value     := StrTran(Alltrim(FormatFloat('##0.00',Arredonda((AliqICMdoCliente16()*ibDataSet16.FieldByname('TOTAL').AsFloat/100),2) )),',','.'); // Valor do ICMS ST em Reais
                          end;
                          //
                        end;
                        //
                        //
                        spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('pCredSN_N29').VAlue       := StrTran(Alltrim(FormatFloat('##0.00',fAliquota)),',','.'); // Aliquota aplicave de clculo de crdito (Simples Nacional)
                        spdNFeDataSets.Campo('vCredICMSSN_N30').VAlue  := StrTran(Alltrim(FormatFloat('##0.00',((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * fAliquota / 100)),',','.'); // VAlor de crdito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)
                        //
                      end;
                      //
                      // CSOSN 202, 203 -
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '202') or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '203') then
                      begin
                        //
                        spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        //
                        if Form7.ibDataSet4PIVA.AsFloat > 0 then
                        begin
                          if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := StrTran(Alltrim(FormatFloat('##0.00', (Form7.ibDataset4PIVA.AsFloat*100)-100 )),',','.'); // Percentual de margem de valor adicionado do ICMS ST
                          end else
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                          end;
                        end else
                        begin
                          spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                        end;
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                        if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                        begin
                          //
                          if Form7.ibDataSet4PIVA.AsFloat > 0 then
                          begin
                            try
                              //
                              // IPI Por Unidade
                              //
                              fIPIPorUnidade := 0;
                              if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                              begin
                                fIPIPorUnidade := (ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                              end;
                              //
                              // Valor da Base de Calculo de ISMS St do item
                              //
                              if ((Form7.ibDataSet14SOBREIPI.AsString = 'S')) and (Form7.ibDataSet16.FieldByname('IPI').AsFloat>0) then
                              begin
                                //
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                    +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    )
                                     * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda(((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  )
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                end;
                                //
                                // Posiciona na tabla de CFOP
                                //
                                if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                                begin
                                  //
                                  sReg := Form7.ibDataSet14REGISTRO.AsString;
                                  Form7.ibDataSet14.DisableControls;
                                  Form7.ibDataSet14.Close;
                                  Form7.ibDataSet14.SelectSQL.Clear;
                                  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                  Form7.ibDataSet14.Open;
                                  if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                                  Form7.ibDataSet14.EnableControls;
                                  //
                                end else
                                begin
                                  //
                                  Form7.ibDataSet14.DisableControls;
                                  Form7.ibDataSet14.Close;
                                  Form7.ibDataSet14.SelectSQL.Clear;
                                  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                  Form7.ibDataSet14.Open;
                                  Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                                  Form7.ibDataSet14.EnableControls;
                                end;
                                //
                                // Desconta o ICM sobre IPI normal do ST  CALCULO DO IVA
                                //
                                if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end;
                              end else
                              begin
                                //
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    )
                                     * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda(((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  )
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                end;
                                //
                                // Posiciona na tabla de CFOP
                                //
                                if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                                begin
                                  //
                                  sReg := Form7.ibDataSet14REGISTRO.AsString;
                                  Form7.ibDataSet14.DisableControls;
                                  Form7.ibDataSet14.Close;
                                  Form7.ibDataSet14.SelectSQL.Clear;
                                  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                  Form7.ibDataSet14.Open;
                                  if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                                  Form7.ibDataSet14.EnableControls;
                                  //
                                end else
                                begin
                                  //
                                  Form7.ibDataSet14.DisableControls;
                                  Form7.ibDataSet14.Close;
                                  Form7.ibDataSet14.SelectSQL.Clear;
                                  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                  Form7.ibDataSet14.Open;
                                  Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                                  Form7.ibDataSet14.EnableControls;
                                end;
                                //
                                // Desconta o ICM sobre IPI normal do ST  CALCULO DO IVA
                                //
                                if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end else
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                  - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                  ),2) )),',','.'); // Valor do ICMS ST em Reais
                                end;
                              end;
                              //
                            except
                              //
                              Form7.ibDataset15.Edit;
                              Form7.ibDataSet15STATUS.AsString    := 'Erro: Verifique o IVA do produto cdigo: '+ibDataSet4CODIGO.AsString;
                              Abort;
                              //
                            end;
                          end else
                          begin
                            spdNFeDataSets.Campo('vbCST_N21').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor cobrado anteriormente por ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value     := StrTran(Alltrim(FormatFloat('##0.00',Arredonda((AliqICMdoCliente16()*ibDataSet16.FieldByname('TOTAL').AsFloat/100),2) )),',','.'); // Valor do ICMS ST em Reais
                          end;
                          //
                        end;
                        //
                        if Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO' then
                        begin
                          //
                          // PERMITE O APROVEITAMENTO DO CRDITO DE ICMS NO VALOR DE R$; CORRESPONDENTE  ALQUOTA DE 2,82%, NOS TERMOS DO ART. 23 DA LC 123
                          //
                          try
                            fAliquota := StrToFloat(Alltrim(StrTran(Copy(Form7.ibDataSet14OBS.AsString,90,4),'.',',')));
                          except
                            fAliquota := 2.82;
                          end;
                          //
                        end else
                        begin
                          // fAliquota := 2.82;
                          fAliquota := 0;
                        end;
                        //
                        spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                        //
                      end;
                      //
                      // CSOSN 500
                      //
                      if (ibDataSet4.FieldByname('CSOSN').AsString = '500') then
                      begin
                        //
                        if spdNFeDataSets.Campo('indFinal_B25a').Value  = '1' then
                        begin
                          //
                          spdNFeDataSets.campo('pRedBCEfet_N34').Value      := StrTran(Alltrim(FormatFloat('##0.00',100-Form7.ibDataSet14BASE.AsFloat)),',','.');                                                                                              // Percentual de reduo da base de clculo efetiva
                          spdNFeDataSets.campo('vBCEfet_N35').Value         := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase) * Form7.ibDataSet14BASE.AsFloat / 100))),',','.');                              // Valor da base de clculo efetiva
                          spdNFeDataSets.campo('pICMSEfet_N36').Value       := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.');                                                                                                         // Alquota do ICMS efetiva
                          spdNFeDataSets.campo('vICMSEfet_N37').Value       := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16()*(((ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase) * Form7.ibDataSet14BASE.AsFloat / 100))/100)),',','.'); // Valor do ICMS efetivo
                          //
                        end else
                        begin
                          //
                          // Procura pela ltima compra deste item
                          //
                          Form7.ibQuery1.Close;
                          Form7.ibQuery1.Sql.Clear;
                          Form7.ibQuery1.Sql.Add('select first 1 ITENS002.CODIGO, ITENS002.QUANTIDADE, ITENS002.VBCST, ITENS002.VICMSST from ITENS002, COMPRAS where ITENS002.NUMERONF = COMPRAS.NUMERONF and Coalesce(ITENS002.VICMSST,0)<>0 and ITENS002.CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by COMPRAS.EMISSAO desc');
                          Form7.ibQuery1.Open;
                          //
                          if Form7.ibQuery1.FieldByname('VICMSST').AsFloat <> 0 then
                          begin
                            //
                            spdNFeDataSets.Campo('pST_N26a').Value              := StrTran(Alltrim(FormatFloat('##0.00',(Form7.ibQuery1.FieldByname('VICMSST').AsFloat / Form7.ibQuery1.FieldByname('VBCST').AsFloat)*100)),',','.');  // Aliquota suportada pelo consumidor
                            spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                            spdNFeDataSets.Campo('vbCSTRet_N26').Value          := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibQuery1.FieldByname('VBCST').AsFloat / Form7.ibQuery1.FieldByname('QUANTIDADE').AsFloat * Form7.ibDataSet16QUANTIDADE.AsFloat)),',','.');  // Valor do BC do ICMS ST retido na UF Emitente ok
                            spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibQuery1.FieldByname('VICMSST').AsFloat / Form7.ibQuery1.FieldByname('QUANTIDADE').AsFloat * Form7.ibDataSet16QUANTIDADE.AsFloat)),',','.');  //  Valor do ICMS ST retido na UF Emitente
                            //
                          end else
                          begin
                            spdNFeDataSets.Campo('pST_N26a').Value              := '0.00'; // Aliquota suportada pelo consumidor
                            spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                            spdNFeDataSets.Campo('vbCSTRet_N26').Value          := '0.00'; // Valor cobrado anteriormente por ST Ok
                            spdNFeDataSets.Campo('vICMSSTRet_N27').Value        := '0.00'; // Valor do ICMS ST em Reais
                          end;
                          //
                        end;
                        //
                      end;
                      //
                      // CSOSN 900
                      //
                      //
                      // NOTA DEVOLUCAO D E V
                      //
                      if (ibDataSet4.FieldByname('CSOSN').AsString = '900') or (ibDataSet14.FieldByname('CSOSN').AsString = '900') then
                      begin
                        //
                        //
                        // 900  Outros  Classificam-se neste cdigo as demais operaes que no se enquadrem nos cdigos 101, 102, 103, 201, 202, 203, 300, 400 e 500.
                        //
                        // N11 - J est preenchido acima - todos tem
                        // N12a - J est preenchido acima - todos tem
                        //
                        try
                          //
                          spdNFeDataSets.Campo('modBC_N13').Value  := '3'; // Modalidade de determinao da Base de Clculo - ver Manual
                          //
                          if (ibDataSet16.FieldByname('BASE').AsFloat = 0) then
                          begin
                            spdNFeDataSets.Campo('vBC_N15').Value   := '0'; // Valor da Base de Clculo do ICMS
                            spdNFeDataSets.Campo('vICMS_N17').Value := '0'; // Valor do ICMS em Reais
                          end else
                          begin
                            //
                            if (ibDataSet16.FieldByname('BASE').AsFloat = 0) then
                            begin
                              //
                              spdNFeDataSets.Campo('vBC_N15').Value   := '0'; // Valor da Base de Clculo do ICMS
                              spdNFeDataSets.Campo('vICMS_N17').Value := '0'; // Valor do ICMS em Reais
                              //
                            end else
                            begin
                              //
                              spdNFeDataSets.Campo('vBC_N15').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('BASE').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100)),',','.');  // BC
                              spdNFeDataSets.Campo('vICMS_N17').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat*(ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100*ibDataSet16.FieldByname('BASE').AsFloat/100)),',','.');     // Valor do ICMS em Reais
                              //
                            end;
                            //
                          end;
                          //
                          if (100-ibDataSet16.FieldByname('BASE').AsFloat) <> 0 then
                          begin
                            spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet16.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                          end else
                          begin
    //                            spdNFeDataSets.Campo('pRedBC_N14').Value := '100';
                          end;
                          //
                          spdNFeDataSets.Campo('pICMS_N16').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('ICM').AsFloat)),',','.'); // Alquota do ICMS em Percentual
                          //
                          spdNFeDataSets.Campo('modBCST_N18').Value   := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                          //
                          if Form7.ibDataSet4PIVA.AsFloat > 0 then
                          begin
                            if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                            begin
                              spdNFeDataSets.Campo('pMVAST_N19').Value := StrTran(Alltrim(FormatFloat('##0.00', (Form7.ibDataset4PIVA.AsFloat*100)-100 )),',','.'); // Percentual de margem de valor adicionado do ICMS ST
                            end else
                            begin
                              spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                            end;
                          end else
                          begin
                            spdNFeDataSets.Campo('pMVAST_N19').Value := '100'; // Percentual de margem de valor adicionado do ICMS ST
                          end;
                          spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                          //
                          if Form7.ibDataSet4PIVA.AsFloat > 0 then
                          begin
                            if Form7.ibDataSet16.FieldByname('BASE').AsFloat > 0 then
                            begin
                              //
                              // Posiciona na tabla de CFOP
                              //
                              if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                              begin
                                //
                                sReg := Form7.ibDataSet14REGISTRO.AsString;
                                Form7.ibDataSet14.DisableControls;
                                Form7.ibDataSet14.Close;
                                Form7.ibDataSet14.SelectSQL.Clear;
                                Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                Form7.ibDataSet14.Open;
                                if not Form7.ibDataSet14.Locate('ST',Form7.ibDataSet4ST.AsString,[loCaseInsensitive, loPartialKey]) then Form7.ibDataSet14.Locate('REGISTRO',sReg,[]);
                                Form7.ibDataSet14.EnableControls;
                                //
                              end else
                              begin
                                //
                                Form7.ibDataSet14.DisableControls;
                                Form7.ibDataSet14.Close;
                                Form7.ibDataSet14.SelectSQL.Clear;
                                Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                                Form7.ibDataSet14.Open;
                                Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                                Form7.ibDataSet14.EnableControls;
                              end;
                              //
                              if ((Form7.ibDataSet14SOBREIPI.AsString = 'S')) and (Form7.ibDataSet16.FieldByname('IPI').AsFloat>0) then
                              begin
                                //
                                // IPI Por Unidade
                                //
                                fIPIPorUnidade := 0;
                                if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                                begin
                                  fIPIPorUnidade := (ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                                end;
                                //
                                // Valor da Base de Calculo de ISMS St do item
                                //
                                spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', ((
                                (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) +  fIPIPorUnidade)
                                +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                )
                                 * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat) )),',','.'); // Valor da B ST
                                //
                                // Desconta o ICM sobre IPI normal do ST   CALCULO DO IVA
                                //
                                if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                begin
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) +(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100))
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat),2)
                                   -((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))+(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100)) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100) // Desconta o ICMS Normal
                                   ),2))),',','.'); // Valor do ICMS ST em Reais
                                  //
                                end else
                                begin
                                  //
                                  spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  Arredonda(((
                                  (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))+(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100))
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat),2)
                                   -((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))+(Form7.ibDataSet16.FieldByname('IPI').AsFloat * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100)
                                   ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100) // Desconta o ICMS Normal
                                  ),2))),',','.'); // Valor do ICMS ST em Reais
                                  //
                                end;
                                //
                              end else
                              begin
                                //
                                // IPI Por Unidade
                                //
                                fIPIPorUnidade := 0;
                                if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                                begin
                                  fIPIPorUnidade := (ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))));
                                end;
                                //
                                // Valor da Base de Calculo de ISMS St do item
                                //

                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
                                  //
                                  // VINICULAS
                                  //
                                  try
                                    spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    )
                                     * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                  except end;
                                end else
                                begin
                                  spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                  ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) + fIPIPorUnidade)
                                  +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                  )
                                   * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
                                end;

{
                                spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Arredonda(((
                                (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))  + fIPIPorUnidade)
                                +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                )
                                 * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 * Form7.ibDataset4PIVA.AsFloat),2) )),',','.'); // Valor da B ST
}


                                //
                                // Desconta o ICM sobre IPI normal do ST    CALCULO DO IVA
                                //

//ShowMessage('Teste <BCST>');
                                if pos('<BCST>',ibDataSet14OBS.AsString) <> 0 then
                                begin
{
//
ShowMessage('Teste: '+chr(10)+
'Aliquota configurada no .inf : ' + FloatToSTr(AliqICMdoCliente16())+chr(10)+
'Aliquota na tabela do ESTADO : ' + FloatToSTr(Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat)+chr(10)+
'BC do iten                   : ' + Form7.ibDataSet16.FieldByname('BASE').AsString + chr(10) +
'Total do iten                : ' + Form7.ibDataSet16.FieldByname('TOTAL').AsString + chr(10) +
'IVA do iten                  : ' + Form7.ibDataset4PIVA.AsString + chr(10) +
'IPI por unidade              : ' + FloatToStr(fIPIPorUnidade) + chr(10) +
'IPI                          : ' + Form7.ibDataSet16.FieldByname('IPI').AsString + Chr(10) +
'<BCST> na obs                : ' + Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5) + Chr(10)
);
}
                                  if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                  begin
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    Arredonda(((
                                    (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                    )
                                    ) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - ((
                                    ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                    ),2))),',','.'); // Valor do ICMS ST em Reais
                                  end else
                                  begin
                                    //
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00',
                                    Arredonda(
                                    ((
                                    (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                    )) * StrToFloat(Copy(ibDataSet14OBS.AsString,pos('<BCST>',ibDataSet14OBS.AsString)+6,5)) / 100 *
                                    AliqICMdoCliente16()
                                     / 100 ) * Form7.ibDataset4PIVA.AsFloat,2)
                                    -
                                    Arredonda(
                                    ((
                                    (((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) + fIPIPorUnidade)
                                    + (Form7.ibDataSet16.FieldByname('IPI').AsFloat * (Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto) / 100)
                                    )) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *
                                    Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat
                                     / 100 ),2)
                                    )),',','.'); // Valor do ICMS ST em Reais
                                    //
                                  end;
                                end else
                                begin
                                  if AliqICMdoCliente16() < Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat then
                                  begin
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )
                                    ),2) )),',','.'); // Valor do ICMS ST em Reais
                                  end else
                                  begin
                                    spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Arredonda((
                                    Arredonda(((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  AliqICMdoCliente16() / 100 )* Form7.ibDataset4PIVA.AsFloat,2)
                                    - ((((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto))
                                    +(0 * ((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) / 100) // Teste inclui esta linha
                                    ) * Form7.ibDataSet16.FieldByname('BASE').AsFloat / 100 *  Form7.ibDataSet14.FieldByname(UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_').AsFloat / 100 )
                                    ),2) )),',','.'); // Valor do ICMS ST em Reais
                                  end;
                                end;
                                //
                              end;
                            end else
                            begin
                              spdNFeDataSets.Campo('vbCST_N21').Value     := '0'; // Valor da B ST
                              spdNFeDataSets.Campo('vICMSST_N23').Value   := '0';
                            end;
                            //
                          end else
                          begin
                            //
                            spdNFeDataSets.Campo('vbCST_N21').Value       := '0'; // Valor cobrado anteriormente por ST
                            spdNFeDataSets.Campo('vICMSST_N23').Value     := '0';  // Valor do ICMS ST em Reais
                            //
                          end;
                          //
                          if spdNFeDataSets.Campo('vICMSST_N23').Value <> '0' then // Mudei 11/05/2022
                          begin
                            spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',AliqICMdoCliente16())),',','.'); // Alquota do ICMS em Percentual
                          end else
                          begin
                            spdNFeDataSets.Campo('pICMSST_N22').Value     := '0';       // Alquota do ICMS em Percentual
                            spdNFeDataSets.Campo('pMVAST_N19').Value      := '0.00';   // Percentual de margem de valor adicionado do ICMS ST
                            spdNFeDataSets.Campo('pREDBCST_N20').Value    := '0.00';  // Percentual de reduo de BC do ICMS ST
                          end;
                          //
                          if Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO' then
                          begin
                            //
                            // PERMITE O APROVEITAMENTO DO CRDITO DE ICMS NO VALOR DE R$; CORRESPONDENTE  ALQUOTA DE 2,82%, NOS TERMOS DO ART. 23 DA LC 123
                            //
                            try
                              fAliquota := StrToFloat(Alltrim(StrTran(Copy(Form7.ibDataSet14OBS.AsString,90,4),'.',',')));
                            except
                              fAliquota := 2.82;
                            end;
                            //
                          end else
                          begin
    //                          fAliquota := 2.82;
                            fAliquota := 0;
                          end;
                          //
                          try
                            spdNFeDataSets.Campo('pCredSN_N29').VAlue       := StrTran(Alltrim(FormatFloat('##0.00',fAliquota)),',','.'); // Aliquota aplicave de clculo de crdito (Simples Nacional)
                            spdNFeDataSets.Campo('vCredICMSSN_N30').VAlue  := StrTran(Alltrim(FormatFloat('##0.00',((Form7.ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)) * fAliquota / 100)),',','.'); // VAlor de crdito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)
                          except end;
                          //
                        except
                          on E: Exception do
                          begin
                            Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao calcular FCP.'
                            ),'Ateno',mb_Ok + MB_ICONWARNING);
                          end;
                        end;
                      end;
                      //
                      if Form1.sVersaoLayout = '4.00' then
                      begin
                        //
                        try
                          //
                          fCalculo := (ibDataSet16.FieldByname('BASE').AsFloat * (ibDataSet16.FieldByname('TOTAL').AsFloat + fSomaNaBase )/100)*fPercentualFCP/100;
                          //
                          if spdNFeDataSets.Campo('CSOSN_N12a').Value = '201' then
                          begin
                            //
                            // fPercentualFCPST
                            //
                            if fPercentualFCPST <> 0 then
                            begin
                              //
                              spdNFeDataSets.campo('vBCFCPST_N23a').Value  := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('pFCPST_N23b').Value    := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCPST)),',','.'); // Percentual do FCP retido por Substituio Tributria
                              //
                              if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                              begin
                                spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100)-(fCalculo))),',','.'); // Valor do FCP retido por Substituio Tributria
                              end else
                              begin
                                spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100))),',','.'); // Valor do FCP retido por Substituio Tributria
                              end;
                            end;
                            //
                            // ok
                            //
                          end;
                          //
                          if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '202') or (spdNFeDataSets.Campo('CSOSN_N12a').Value = '203') then
                          begin
                            //
                            // fPercentualFCPST
                            //
                            if fPercentualFCPST <> 0 then
                            begin
                              //
                              spdNFeDataSets.campo('vBCFCPST_N23a').Value  := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP retido por Substituio Tributria
                              spdNFeDataSets.campo('pFCPST_N23b').Value    := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCPST)),',','.'); // Percentual do FCP retido por Substituio Tributria
                              //
                              if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                              begin
                                spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100)-(fCalculo))),',','.'); // Valor do FCP retido por Substituio Tributria
                              end else
                              begin
                                spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100))),',','.'); // Valor do FCP retido por Substituio Tributria
                              end;
                              //
                            end;
                            //
                            // ok
                            //
                          end;
                          //
                          if (ibDataSet4.FieldByname('CSOSN').AsString = '500') then
                          begin
//                            spdNFeDataSets.campo('vBCFCPSTRet_N27a').Value := '0.00'; // Valor da Base de Clculo do FCP retido anteriormente por ST
//                            spdNFeDataSets.campo('pFCPSTRet_N27b').Value   := '0.00'; // Percentual do FCP retido anteriormente por Substituio Tributria
//                            spdNFeDataSets.campo('vFCPSTRet_N27d').Value   := '0.00'; // Valor do FCP retido por Substituio Tributria
                          end;
                          //
                          //
                          // NOTA DEVOLUCAO D E V
                          //
                          if (ibDataSet4.FieldByname('CSOSN').AsString = '900') or (ibDataSet14.FieldByname('CSOSN').AsString = '900') then
                          begin
                            try
                              //
                              // fPercentualFCPST
                              //
                              if fPercentualFCPST <> 0 then
                              begin
                                //
                                spdNFeDataSets.campo('vBCFCPST_N23a').Value  := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do FCP retido por Substituio Tributria
                                spdNFeDataSets.campo('pFCPST_N23b').Value    := StrTran(Alltrim(FormatFloat('##0.00', fPercentualFCPST)),',','.'); // Percentual do FCP retido por Substituio Tributria
                                //
                                if (UpperCase(Form7.ibDataSet2ESTADO.AsString) = UpperCase(Form7.ibDataSet13ESTADO.AsString)) and (UpperCase(Form7.ibDataSet13ESTADO.AsString)='RJ') then
                                begin
                                  spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100)-(fCalculo))),',','.'); // Valor do FCP retido por Substituio Tributria
                                end else
                                begin
                                  spdNFeDataSets.campo('vFCPST_N23d').Value    := StrTran(Alltrim(FormatFloat('##0.00',(StrToFloat(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,'.',','))*fPercentualFCPST/100))),',','.'); // Valor do FCP retido por Substituio Tributria
                                end;
                              end;
                            except
                              on E: Exception do
                              begin
                                Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao calcular Percentual do FCP retido por Substituio Tributria CSOSN 900'),'Ateno',mb_Ok + MB_ICONWARNING);
                              end;
                            end;
                            //
                            // ok
                            //
                          end;
                          //
                        except
                          on E: Exception do
                          begin
                            Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao calcular FCP 2.'
                            ),'Ateno',mb_Ok + MB_ICONWARNING);
                          end;
                        end;
                        //
                      end;
                      ///////////////////////////////
                      //
                      // Final TAGS sada por CSOSN - CRT = 1 imples Nacional
                      //
                      ///////////////////////////////
                    end;
                    //
                    // FCP
                    //
                    if Form1.sVersaoLayout = '4.00' then
                    begin
                      //
                      // Nesta nova verso no haver alterao no leiaute do DANFE. As informaes relativas ao Fundo de Combate  Pobreza (FCP) devem ser informadas:
                      // - No campo de "Informaes Adicionais do Produto, tag: indAdProd", os valores informados por item nos campos (vBCFCP, pFCP, vFCP, vBCFCPST, pFCPST, vFCPST), quando existirem; e
                      //
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCFCP_N17a').AsString,',',''),'.',','))   <> 0 then spdNFeDataSets.campo('InfAdProd_V01').Value := AllTrim(spdNFeDataSets.campo('InfAdProd_V01').Value + ' vBCFCP '  + spdNFeDataSets.campo('vBCFCP_N17a').Value);
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pFCP_N17b').AsString,',',''),'.',','))     <> 0 then spdNFeDataSets.campo('InfAdProd_V01').Value := AllTrim(spdNFeDataSets.campo('InfAdProd_V01').Value + ' pFCP '    + spdNFeDataSets.campo('pFCP_N17b').Value);
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCP_N17c').AsString,',',''),'.',','))     <> 0 then spdNFeDataSets.campo('InfAdProd_V01').Value := AllTrim(spdNFeDataSets.campo('InfAdProd_V01').Value + ' vFCP '    + spdNFeDataSets.campo('vFCP_N17c').Value);
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCFCPST_N23a').AsString,',',''),'.',',')) <> 0 then spdNFeDataSets.campo('InfAdProd_V01').Value := AllTrim(spdNFeDataSets.campo('InfAdProd_V01').Value + ' vBCFCPST '+ spdNFeDataSets.campo('vBCFCPST_N23a').Value);
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pFCPST_N23b').AsString,',',''),'.',','))   <> 0 then spdNFeDataSets.campo('InfAdProd_V01').Value := AllTrim(spdNFeDataSets.campo('InfAdProd_V01').Value + ' pFCPST '  + spdNFeDataSets.campo('pFCPST_N23b').Value);
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCPST_N23d').AsString,',',''),'.',','))   <> 0 then spdNFeDataSets.campo('InfAdProd_V01').Value := AllTrim(spdNFeDataSets.campo('InfAdProd_V01').Value + ' vFCPST '  + spdNFeDataSets.campo('vFCPST_N23d').Value);
                      //
                    end;
                    //
                    // IPI
                    //
                    if AllTrim(ibDataSet16.FieldByname('CST_IPI').AsString) <> '' then
                    begin
                      //
                      // CST IPI
                      //
                      // 00 Entrada com recuperao de crdito
                      // 01 Entrada tributada com alquota zero
                      // 02 Entrada isenta
                      // 03 Entrada no-tributada
                      // 04 Entrada imune
                      // 05 Entrada com suspenso
                      // 49 Outras entradas
                      // 50 Sada tributada
                      // 51 Sada tributada com alquota zero
                      // 52 Sada isenta
                      // 53 Sada no-tributada
                      // 54 Sada imune
                      // 55 Sada com suspenso
                      // 99 Outras sadas
                      //
                      if Form1.sVersaoLayout = '4.00' then
                      begin
                      end else
                      begin
                        spdNFeDataSets.Campo('clEnq_O02').Value     := 'NDA'; // Classe de enquadramento do IPI para cigarros e Bebidas
                      end;
                      //
                      spdNFeDataSets.Campo('CNPJProd_O03').Value  := '00000000000000'; // CNPJ do produtor quando diferente do emitente
                      spdNFeDataSets.Campo('cSelo_O04').Value     := '';   // Cdigo do celo de controle IPI
                      spdNFeDataSets.Campo('qSelo_O05').Value     := '0';   // Quantidade de celo de controle
                      //
                      if LimpaNumero(Form7.ibDAtaSet4ENQ_IPI.AsString) <> '' then
                      begin
                        spdNFeDataSets.Campo('cEnq_O06').Value      := Form7.ibDAtaSet4ENQ_IPI.AsString; // Enquadramento legal do IPI
                      end else
                      begin
                        spdNFeDataSets.Campo('cEnq_O06').Value      := '999'; // Enquadramento legal do IPI
                      end;
                      //
                      // spdNFeDataSets.Campo('CST_O09').Value       := '50';  // Sada tributada de IPI
                      //
                      spdNFeDataSets.Campo('CST_O09').Value       :=  ibDataSet16.FieldByname('CST_IPI').AsString; // Sada tributada de IPI
                      //
                      if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        spdNFeDataSets.Campo('qUnid_O11').Value := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet16.FieldByname('QUANTIDADE').AsFloat)),',','.'); // Quantidade Total da Unidade padrao para tributacao
                        spdNFeDataSets.Campo('vUnid_O12').Value := StrTran(Alltrim(FormatFloat('##0.0000',StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString))))),',','.'); // Valor por unidade tributavel
                        spdNFeDataSets.Campo('pIPI_O13').Value  := ''; // Percentual do IPI
                        spdNFeDataSets.Campo('vIPI_O14').Value  := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2((ibDataSet16.FieldByname('QUANTIDADE').AsFloat * StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('vUnid',form7.ibDataSet4.FieldByname('TAGS_').AsString)))),2))),',','.'); // Valor do IPI
                      end else
                      begin
                        //
                        spdNFeDataSets.Campo('vBC_O10').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da BC do IPI
                        spdNFeDataSets.Campo('pIPI_O13').Value      := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('IPI').AsFloat)),',','.'); // Percentual do IPI
                        //
                        if Form7.ibDataSet15FINNFE.AsString = '4' then // Devolucao Devoluo No deve mudar
                        begin
                          spdNFeDataSets.Campo('vIPI_O14').Value      := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet16.FieldByname('VIPI').AsFloat,2))),',','.'); // Valor do IPI
                        end else
                        begin
                          spdNFeDataSets.Campo('vIPI_O14').Value      := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet16.FieldByname('IPI').AsFloat*ibDataSet16.FieldByname('TOTAL').AsFloat/100,2))),',','.'); // Valor do IPI
                        end;
                      end;
                    end;
                    //
                    // CST PIS E CST COFINS
                    //
                    // 11 - Operao Tributvel (base de clculo = valor da operao alquota normal (cumulativo/no cumulativo))
                    // 22 - Operao Tributvel (base de clculo = valor da operao (alquota diferenciada))
                    // 33 - Operao Tributvel (base de clculo = quantidade vendida x alquota por unidade de produto)
                    // 44 - Operao Tributvel (tributao monofsica (alquota zero))
                    // 55 - Operao Tributvel (substituio tributria)
                    // 66 - Operao Tributvel (alquota zero)
                    // 77 - Operao Isenta da Contribuio
                    // 88 - Operao Sem Incidncia da Contribuio
                    // 99 - Operao com Suspenso da Contribuio
                    // 99 - Outras Operaes
                    //
                    // PIS
                    //
                    //
                    //
                    // Para calcular o PIS e o COFINS na NF-e:
                    //
                    // 1 - Na OBS do produto incluir: PIS COFINS
                    // 2 - Na tabela de ICM na natureza da opereo preencher: BC PIS, % PIS, BC COFINS, % COFINS e CST PIS COFINS=99
                    //
                    //
                    if AllTrim(sCST_PIS_COFINS) <> '' then
                    begin
                      //
                      // Pega o CST PIS COFINS e o PERCENTUAL da Tabela
                      //
                      spdNFeDataSets.Campo('CST_Q06').Value     := sCST_PIS_COFINS;
                      //
                      if rpPIS <> 0 then
                      begin
                        //
                        // Descontei o rateio do desconto em 11/07/2022 NO PIS
                        //
                        spdNFeDataSets.Campo('vBC_Q07').Value     := StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := StrTran(Alltrim(FormatFloat('##0.00',rpPIS)),',','.'); // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))*rpPIS/100)),',','.'); // Valor do PIS em Reais
                        //
                        // Excluso do ICMS base do PISCOFINS FICHA 5375
                        //
                      end else
                      begin
                        spdNFeDataSets.Campo('vBC_Q07').Value     := '0.00'; // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := '0.00'; // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := '0.00'; // Valor do PIS em Reais
                      end;
                      //
                    end else
                    begin
                      //
                      if (Form7.ibDAtaSet4ALIQ_PIS_SAIDA.AsFloat <> 0) then
                      begin
                        //
                        // Pega o CST PIS COFINS e o PERCENTUAL do iten
                        //
                        spdNFeDataSets.Campo('CST_Q06').Value     := Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString;
                        //
                        if Copy(Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString,1,2) = '03' then // Pis por unidade
                        begin
                          spdNFeDataSets.Campo('vBC_Q07').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da Base de Clculo do PIS
                          spdNFeDataSets.Campo('pPIS_Q08').Value      := '0.00';
                          spdNFeDataSets.Campo('vPIS_Q09').Value      := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('QUANTIDADE').AsFloat*ibDataSet4ALIQ_PIS_SAIDA.AsFloat)),',','.'); // Valor do PIS em Reais
                          spdNFeDataSets.Campo('qBCPROD_Q10').Value   := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet16.FieldByname('QUANTIDADE').AsFloat)),',','.'); // Quantidade Vendida
                          spdNFeDataSets.Campo('vAliqPROD_Q11').Value := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet4ALIQ_PIS_SAIDA.AsFloat)),',','.'); // Alquota do PIS (em reais)
                        end else
                        begin
                          //
                          spdNFeDataSets.Campo('pPIS_Q08').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet4ALIQ_PIS_SAIDA.AsFloat)),',','.'); // Alquota em Percencual do PIS
                          //
                          if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('BCPISCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then  // A tag BCPISCOFINS est preenchida
                          begin
                            //
                            spdNFeDataSets.Campo('vBC_Q07').Value     := StrTran(Alltrim(FormatFloat('##0.00', StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('BCPISCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) )),',','.'); // Valor da Base de Clculo do PIS
                            spdNFeDataSets.Campo('vPIS_Q09').Value    := StrTran(Alltrim(FormatFloat('##0.00', StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('BCPISCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) *ibDataSet4ALIQ_PIS_SAIDA.AsFloat/100)),',','.'); // Valor do PIS em Reais
                            //
                          end else
                          begin
                            //
                            // Descontei o rateio do desconto em 11/07/2022 NO PIS
                            //
                            spdNFeDataSets.Campo('vBC_Q07').Value     := StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do PIS
                            spdNFeDataSets.Campo('vPIS_Q09').Value    := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))*ibDataSet4ALIQ_PIS_SAIDA.AsFloat/100)),',','.'); // Valor do PIS em Reais
                            //
                            // Excluso do ICMS base do PISCOFINS FICHA 5375
                            //
                          end;
                        end;
                        //
                      end else
                      begin
                        //
                        if AllTrim(Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString) = '' then
                        begin
                          spdNFeDataSets.Campo('CST_Q06').Value     := '08';   // Codigo de Situacao Tributria - ver opes no Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('CST_Q06').Value     := Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString;
                        end;
                        //
                        spdNFeDataSets.Campo('vBC_Q07').Value     := '0.00'; // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value    := '0.00'; // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value    := '0.00'; // Valor do PIS em Reais
                        //
                      end;
                    end;
                    //
                    vPIS := vPIS + Arredonda(StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vPIS_Q09').AsString,',',''),'.',',')),2);
                    //
                    // COFINS
                    //
                    if AllTrim(sCST_PIS_COFINS) <> '' then
                    begin
                      //
                      // Pega o CST PIS COFINS e o PERCENTUAL da Tabela
                      //
                      spdNFeDataSets.Campo('CST_S06').Value        := sCST_PIS_COFINS;
                      //
                      if rpCOFINS <> 0 then
                      begin
                        //
                        // Descontei o rateio do desconto em 11/07/2022 no COFINS
                        //
                        spdNFeDataSets.Campo('vBC_S07').Value        := StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := StrTran(Alltrim(FormatFloat('##0.00',rpCOFINS)),',','.'); // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))*rpCOFINS/100)),',','.'); // Valor do COFINS em Reais
                        //
                        // Excluso do ICMS base do PISCOFINS FICHA 5375
                        //
                      end else
                      begin
                        spdNFeDataSets.Campo('vBC_S07').Value        := '0.00'; // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := '0.00'; // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := '0.00'; // Valor do COFINS em Reais
                      end;
                      //
                    end else
                    begin
                      //
                      if (Form7.ibDAtaSet4ALIQ_COFINS_SAIDA.AsFloat <> 0) then
                      begin
                        //
                        // Pega o CST PIS COFINS e o PERCENTUAL do iten
                        //
                        spdNFeDataSets.Campo('CST_S06').Value        := Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString;
                        //
                        if Copy(Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString,1,2) = '03' then // Cofins por unidade
                        begin
                          spdNFeDataSets.Campo('vBC_S07').Value        := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da Base de Clculo do COFINS
                          spdNFeDataSets.Campo('pCOFINS_S08').Value    := '0.00';
                          spdNFeDataSets.Campo('vCOFINS_S11').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('QUANTIDADE').AsFloat*ibDataSet4ALIQ_COFINS_SAIDA.AsFloat)),',','.'); // Valor do COFINS em Reais
                          spdNFeDataSets.Campo('qBCPROD_S09').Value    := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet16.FieldByname('QUANTIDADE').AsFloat)),',','.'); // Quantidade Vendida
                          spdNFeDataSets.Campo('vAliqPROD_S10').Value  := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet4ALIQ_COFINS_SAIDA.AsFloat)),',','.'); // Alquota do COFINS (em reais)
                        end else
                        begin
                          //
                          spdNFeDataSets.Campo('pCOFINS_S08').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet4ALIQ_COFINS_SAIDA.AsFloat)),',','.'); // Alquota em Percencual do COFINS
                          //
                          if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('BCPISCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then  // A tag BCPISCOFINS est preenchida
                          begin
                            //
                            spdNFeDataSets.Campo('vBC_S07').Value        := StrTran(Alltrim(FormatFloat('##0.00', StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('BCPISCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) )),',','.'); // Valor da Base de Clculo do COFINS
                            spdNFeDataSets.Campo('vCOFINS_S11').Value    := StrTran(Alltrim(FormatFloat('##0.00', StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('BCPISCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) *ibDataSet4ALIQ_COFINS_SAIDA.AsFloat/100)),',','.'); // Valor do COFINS em Reais
                            //
                          end else
                          begin
                            //
                            // Descontei o rateio do desconto em 11/07/2022 no COFINS
                            //
                            spdNFeDataSets.Campo('vBC_S07').Value        := StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))),',','.'); // Valor da Base de Clculo do COFINS
                            spdNFeDataSets.Campo('pCOFINS_S08').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet4ALIQ_COFINS_SAIDA.AsFloat)),',','.'); // Alquota em Percencual do COFINS
                            spdNFeDataSets.Campo('vCOFINS_S11').Value    := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16.FieldByname('TOTAL').AsFloat-fRateioDoDesconto)-StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')))*ibDataSet4ALIQ_COFINS_SAIDA.AsFloat/100)),',','.'); // Valor do COFINS em Reais
                            //
                            // Excluso do ICMS base do PISCOFINS FICHA 5375
                            //
                          end;
                        end;
                        //
                      end else
                      begin
                        //
                        if AllTrim(Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString) = '' then
                        begin
                          spdNFeDataSets.Campo('CST_S06').Value     := '08';   // Codigo de Situacao Tributria - ver opes no Manual
                        end else
                        begin
                          spdNFeDataSets.Campo('CST_S06').Value     := Form7.ibDAtaSet4CST_PIS_COFINS_SAIDA.AsString;
                        end;
                        //
                        spdNFeDataSets.Campo('vBC_S07').Value        := '0.00'; // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value    := '0.00'; // Alquota em Percencual do COFINS
                        spdNFeDataSets.Campo('vCOFINS_S11').Value    := '0.00'; // Valor do COFINS em Reais
                        //
                      end;
                    end;
                    //
                    vCOFINS := vCOFINS + Arredonda(StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vCOFINS_S11').AsString,',',''),'.',',')),2);
                    //
                    // totalizador da nota complementar
                    //
                    if Form7.ibDataSet15FINNFE.AsString = '2' then // Complementar
                    begin
                      //
                      spdNFeDataSets.Campo('qTrib_I14').Value    := '0.00'; // Quantidade Tributvel do Item
                      spdNFeDataSets.Campo('vUnTrib_I14a').Value := '0.00'; // Valor Tributvel do Item
                      //
                      spdNFeDataSets.Campo('qCom_I10').Value     := '0.00'; // Quantidade Comercializada do Item
                      spdNFeDataSets.Campo('vUnCom_I10a').Value  := '0.00'; // Valor Comercializado do Item
                      spdNFeDataSets.Campo('vProd_I11').Value    := '0.00'; // Valor Total Bruto do Item
                      //
                      spdNFeDataSets.Campo('vBC_N15').Value         := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('BASEICM').AsFloat)),',','.'); // BC
  //                  spdNFeDataSets.Campo('pICMS_N16').Value       := StrTran(Alltrim(FormatFloat('##0.00',100)),',','.'); // Alquota do ICMS em Percentual
                      spdNFeDataSets.Campo('pICMS_N16').Value       := StrTran(Alltrim(FormatFloat('##0.00',0)),',','.'); // Alquota do ICMS em Percentual
                      spdNFeDataSets.Campo('vICMS_N17').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('ICMS').AsFloat)),',','.');     // Valor do ICMS em Reais
                      //
                      spdNFeDataSets.Campo('vbCST_N21').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('BASESUBSTI').AsFloat)),',','.'); // Valor cobrado anteriormente por ST
                      spdNFeDataSets.Campo('vICMSST_N23').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('ICMSSUBSTI').AsFloat)),',','.'); // Valor do ICMS ST em Reais
  //                    spdNFeDataSets.Campo('pICMSST_N22').Value     := StrTran(Alltrim(FormatFloat('##0.00',100)),',','.'); // Alquota do ICMS em Percentual
                      if spdNFeDataSets.Campo('vICMSST_N23').Value <> '0' then // Mudei 11/05/2022
                      begin
                        spdNFeDataSets.Campo('pICMSST_N22').Value     := StrTran(Alltrim(FormatFloat('##0.00',0)),',','.'); // Alquota do ICMS em Percentual
                      end else
                      begin
                        spdNFeDataSets.Campo('pICMSST_N22').Value     := '0';      // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('pMVAST_N19').Value      := '0.00';  // Percentual de margem de valor adicionado do ICMS ST
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '0.00'; // Percentual de reduo de BC do ICMS ST
                      end;
                      //
                    end;
                    //
                    // Devolucao
                    //
                    if Form7.ibDataSet15FINNFE.AsString = '4' then // Devolucao Devoluo
                    begin
                      //
                      // Imposto da NF de DEVOLUCAO devoluo
                      //
                      // neste ponto  possvel informar os impostos com os valores da nota de entrada
                      // no importa que j foram informados o que vai valer so estes valores
                      //
                      // ShowMEssage(Form7.ibDataSet16DESCRICAO.AsString+chr(10)+Form7.ibDataSet16CST_ICMS.AsString);
                      //
                      spdNFeDataSets.Campo('vBC_N15').Value       := StrTran(Alltrim(FormatFloat('##0.00', Form7.ibDataSet16VBC.AsFloat)),',','.'); // BC
                      spdNFeDataSets.Campo('CST_N12').Value       := Right(Form7.ibDataSet16CST_ICMS.AsString,2);                                   // Tipo da Tributao do ICMS (00 - Integralmente) ver outras formas no Manual
                      //
                      //
                      spdNFeDataSets.Campo('vICMS_N17').Value     := '';
                      //
                      if (spdNFeDataSets.Campo('CSOSN_N12a').Value = '900') then
                      begin
                        spdNFeDataSets.Campo('vICMS_N17').Value     := StrTran(Alltrim(FormatFloat('##0.00', Form7.ibDataSet16VICMS.AsFloat)),',','.');     // Valor do ICMS em Reais
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring <> '40') and (spdNFeDataSets.Campo('CST_N12').AssTring <> '41') then
                      begin
                        spdNFeDataSets.Campo('vICMS_N17').Value     := StrTran(Alltrim(FormatFloat('##0.00', Form7.ibDataSet16VICMS.AsFloat)),',','.');     // Valor do ICMS em Reais
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '10') then
                      begin
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4'; // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '20') then
                      begin
                        spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet16.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '30') then
                      begin
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4';   // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '60') then
                      begin
                        //
                        spdNFeDataSets.Campo('vbCSTRet_N26').Value    := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet16VBCST.AsFloat)),',','.');  // Valor do BC do ICMS ST retido na UF Emitente ok
                        spdNFeDataSets.Campo('vICMSSTRet_N27').Value  := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet16VICMSST.AsFloat)),',','.');  //  Valor do ICMS ST retido na UF Emitente
                        spdNFeDataSets.Campo('vICMSSubstituto_N26b').Value  := '0.00'; // Valor do icms prprio do substituto cobrado em operao anterior
                        //
                        if (Form7.ibDataset16VICMSST.AsFloat > 0) and (Form7.ibDataset16VBCST.AsFloat > 0) then
                        begin
                          spdNFeDataSets.Campo('pST_N26a').Value        := StrTran(Alltrim(FormatFloat('##0.00',(Form7.ibDataset16VICMSST.AsFloat / Form7.ibDataset16VBCST.AsFloat)*100)),',','.');  // Aliquota suportada pelo consumidor
                        end else
                        begin
                          spdNFeDataSets.Campo('pST_N26a').Value        := '0.00';
                        end;
                        //
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '70') then
                      begin
                        //
                        spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet16.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4';   // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                        //
                      end;
                      //
                      if (spdNFeDataSets.Campo('CST_N12').AssTring = '90') then
                      begin
                        spdNFeDataSets.Campo('pRedBC_N14').Value := StrTran(Alltrim(FormatFloat('##0.00',100-ibDataSet16.FieldByname('BASE').AsFloat)),',','.'); // Percentual da reduo de BC
                        spdNFeDataSets.Campo('modBCST_N18').Value     := '4';   // Modalidade de determinao da Base de Clculo do ICMS ST - ver Manual
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '100'; // Percentual de reduo de BC do ICMS ST
                      end;
                      //
                      spdNFeDataSets.Campo('vbCST_N21').Value     := StrTran(Alltrim(FormatFloat('##0.00', Form7.ibDataSet16VBCST.AsFloat)),',','.');    // Valor da BC do ICMS ST
                      spdNFeDataSets.Campo('vICMSST_N23').Value   := StrTran(Alltrim(FormatFloat('##0.00', Form7.ibDataSet16VICMSST.AsFloat)),',','.');  // VAlor do ICMS ST
                      //
                      // Criar estes dois campos e armazenar no ibDAtaSet16 e recuperar na nota de devoluo
                      //
                      spMVAST  := '0,00';
                      spICMSST := '0,00';
                      //
                      // S pede se tem Valor de ICMSST
                      //
                      if ibDataSet16VICMSST.AsFloat > 0 then
                      begin
                        spMVAST  := Form1.Small_InputForm('NFe', 'Informe o pMVAST (% de margem de valor adicionado do ICMS ST) para o produto: '+Form7.ibDataSet16DESCRICAO.AsString, '0,00');
                        spICMSST := Form1.Small_InputForm('NFe', 'Informe o pICMSST (% Aliquota do Imposto do ICMS ST) para o produto: '+Form7.ibDataSet16DESCRICAO.AsString, '0,00');
                      end;
                      //
                      spdNFeDataSets.Campo('pMVAST_N19').Value    := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAVirgula(spMVAST)))),',','.');  // Percentual de margem de valor adicionado do ICMS ST
                      //
                      if spdNFeDataSets.Campo('vICMSST_N23').Value <> '0' then // Mudei 20/06/2022
                      begin
                        spdNFeDataSets.Campo('pICMSST_N22').Value   := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAVirgula(spICMSST)))),',','.'); // Alquota do ICMS em Percentual
                      end else
                      begin
                        //
                        //
                        spdNFeDataSets.Campo('pICMSST_N22').Value     := '0';      // Alquota do ICMS em Percentual
                        spdNFeDataSets.Campo('pMVAST_N19').Value      := '0.00';  // Percentual de margem de valor adicionado do ICMS ST
                        spdNFeDataSets.Campo('pREDBCST_N20').Value    := '0.00'; // Percentual de reduo de BC do ICMS ST
                        //
                      end;
                      //
                      // IPI
                      //

                      //
                      // UA. Tributos Devolvidos (para o item da NF-e)
                      //
                      ibDataset97.Close;
                      ibDataset97.SelectSql.Clear;
                      ibDataset97.SelectSQL.Add('select * from ITENS002 ,COMPRAS where  COMPRAS.NFEID='+QuotedStr(sChave)+' and COMPRAS.NUMERONF=ITENS002.NUMERONF and ITENS002.CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
                      ibDataset97.Open;

                      if AllTrim(ibDataSet16.FieldByname('CST_IPI').AsString) <> '' then
                      begin
                        //
                        spdNFeDataSets.Campo('vBC_O10').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('TOTAL').AsFloat)),',','.'); // Valor da BC do IPI
                        spdNFeDataSets.Campo('pIPI_O13').Value      := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16.FieldByname('IPI').AsFloat)),',','.'); // Percentual do IPI
                        //
                        if Form7.ibDataSet15FINNFE.AsString = '4' then // Devolucao Devoluo No deve mudar
                        begin
                          //
                          spdNFeDataSets.Campo('vIPI_O14').Value      := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet16.FieldByname('VIPI').AsFloat,2))),',','.'); // Valor do IPI
                          //
                        end else
                        begin
                          spdNFeDataSets.Campo('vIPI_O14').Value      := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet16.FieldByname('IPI').AsFloat*ibDataSet16.FieldByname('TOTAL').AsFloat/100,2))),',','.'); // Valor do IPI
                        end;
                        //
                        //  ShowMessage('Teste: 1.2'+chr(10)+
                        //  chr(10) +
                        //  'Valor da BC do IPI '+'vBC_O10 =' +  spdNFeDataSets.Campo('vBC_O10').Value  + chr(10) +
                        //  'Percentual do IPI '+'pIPI_O13 =' +  spdNFeDataSets.Campo('pIPI_O13').Value + chr(10) +
                        //  'Valor do IPI '+'vIPI_O14 ='      +  spdNFeDataSets.Campo('vIPI_O14').Value + chr(10));
                        //
                      end else
                      begin
                        //
                        if sChave <> '' then
                        begin
                          //
                          // J est no item certo
                          //
                          if sChave = Form7.IBDataSet97.FieldByName('NFEID').AsString then
                          begin
                            //
                            spdNFeDataSets.campo('pDevol_UA02').Value        := StrTran(Alltrim(FormatFloat('##0.00',((ibDataSet16QUANTIDADE.AsFloat/ibDataset97.FieldByname('QTD_ORIGINAL').Asfloat) * 100))),',','.');    // Percentual da mercadoria devolvida
                            spdNFeDataSets.campo('vIPIDevol_UA04').Value     := StrTran(Alltrim(FormatFloat('##0.00', (ibDataset97.FieldByname('VIPI').Asfloat /ibDataset97.FieldByname('QTD_ORIGINAL').Asfloat ) * ibDataSet16QUANTIDADE.AsFloat )),',','.'); // Valor do IPI devolvido
                            //
                            fIPIDevolvido     := fIPIDevolvido + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vIPIDevol_UA04').AsString,',',''),'.',','));
                            //
                          end else
                          begin
                            //
                            spdNFeDataSets.campo('pDevol_UA02').Value        := '100.00';    // Percentual da mercadoria devolvida
                            spdNFeDataSets.campo('vIPIDevol_UA04').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet16VIPI.AsFloat)),',','.'); // Valor do IPI devolvido
                            //
                            fIPIDevolvido     := fIPIDevolvido + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vIPIDevol_UA04').AsString,',',''),'.',','));
                            //
                            ShowMessage('Nota fiscal referenciada no encontrada');
                            //
                          end;
                        end;
                      end;
//
// TEste 01/09/2022
//
                      //
                      if sChave <> Form7.IBDataSet97.FieldByName('NFEID').AsString then
                      begin
                        //
                        // Devoluo Quando no tem NF relacionada calcula a aliquota
                        //
                        spdNFeDataSets.Campo('pICMS_N16').Value       := StrTran(Alltrim(FormatFloat('##0.00',Arredonda(((StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',',')) / StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))) * 100),1))),',','.'); // Calcula a Alquota do ICMS em Percentual
                        //
                      end;
                      //
                    end;
                    //
                    // TOTALIZADOR DA NOTA
                    //
                    //
                    // Calculo do valor real
                    //
                    // vICMS
                    // vBCST
                    //
                    try
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring = '60' then
                      begin
                        spdNFeDataSets.Campo('vICMSST_N23').Value     := '0';  // Isso aqui no est certo teria que remover a soma na tag CST 60
                      end;
                      //
                      vICMS          := vICMS + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMS_N17').AsString,',',''),'.',','));
                      vBC            := vBC   + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','));
                      vST            := vST   + Arredonda(StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMSST_N23').AsString,',',''),'.',',')),2);
                      //
                      if spdNFeDataSets.Campo('CST_N12').AssTring <> '60' then
                      begin
                        vBCST          := vBCST + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vbCST_N21').AsString,',',''),'.',','));
                      end;
                      //
                      fFCP     := fFCP + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCP_N17c').AsString,',',''),'.',','));
                      fFCPST   := fFCPST + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCPST_N23d').AsString,',',''),'.',','));
                      //
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao calcular o totalizadores da NF-e Erro: 25275'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                    //
{
                    if Form1.sVersaoLayout = '4.00' then
                    begin
                      fFCP     := fFCP + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCP_N17c').AsString,',',''),'.',','));
                      fFCPST   := fFCPST + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCPST_N23d').AsString,',',''),'.',','));
                    end;
}
                    //
                  end else
                  begin
                    //
                    // INICIO OBS no produto na informaes complementares
                    //
                    spdNFeDataSets.Campo('InfAdProd_V01').Value := AllTrim(AllTrim(spdNFeDataSets.Campo('InfAdProd_V01').Value) + ' ' + ConverteAcentos2(AllTrim(ibDataSet16.FieldByname('DESCRICAO').AsString)));
                    //
                    // sComplemento := sComplemento + ' ' + ibDataSet16.FieldByname('DESCRICAO').AsString;
                    //
                    // FINAL OBS no produto na informaes complementares
                    //

                  end;
                  //
                  // Veculos
                  //

      {
      <veicProd>
        <tpOp>1</tpOp>
        <chassi>9321JD5109M027807</chassi>
        <cCor>044</cCor>
        <xCor>AZUL</xCor>
        <pot>7</pot>
        <CM3>15</CM3>
        <pesoL>313.0000</pesoL>
        <pesoB>350.0000</pesoB>
        <nSerie>123456789</nSerie>
        <tpComb>GASOLINA</tpComb>
        <nMotor>JD59027807</nMotor>
        <CMKG>1</CMKG>
        <dist>16</dist>
        <RENAVAM>000011231</RENAVAM>
        <anoMod>2009</anoMod>
        <anoFab>2009</anoFab>
        <tpPint>S</tpPint>
        <tpVeic>04</tpVeic>
        <espVeic>1</espVeic>
        <VIN>N</VIN>    // Veicle Identificao Number
        <condVeic>1</condVeic> // 1-Acabado 2-Inacabado 3-Semi-Acabado
        <cMod>000001</cMod>
        </veicProd>
      }

                  //
                  if Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '7' then // Exportao
                  begin
  //                if (Form7.ibDataSet2ESTADO.AsString = 'EX')  then
                    //
                    // Controle de Exportao por Item
                    //
                    spdNFeDataSets.IncluirPart('adi');
                    //
                    // Drawback (Regime Aduaneiro Especial de Drawback)
                    //
                    Mais1ini := TIniFile.Create(Form1.sAtual+'\exportac.ini');
                    sEx14    := Mais1Ini.ReadString('DI','Ex14','');
                    //
                    try
                      //
                      sEx14 := Form1.Small_InputForm('NF-e exportao','Item: '+chr(10)+chr(10)+ibDataSet4.FieldByname('DESCRICAO').AsString+chr(10)+chr(10)+ 'Nmero do ato concessrio de Drawback:',sEx14);
                      spdNFeDataSets.Campo('nDraw_I51').Value  := sEx14;      // Nmero do ato concessrio de Drawback
                      //
                      // Nota fiscal de exportao referenciada
                      //
                      if (Copy(Form7.ibDataSet16CFOP.AsString,2,3) = '503') or (Copy(Form7.ibDataSet16CFOP.AsString,2,3) = '501') then
                      begin
                        //
                        sEx16 := Form1.Small_InputForm('NF-e exportao','Item: '+chr(10)+chr(10)+ibDataSet4.FieldByname('DESCRICAO').AsString+chr(10)+chr(10)+ 'Nmero de Registro de Exportao:',sEx16);
                        spdNFeDataSets.Campo('nRE_I53').Value  := sEx16;      // Nmero de Registro de Exportao
                        //
                        sEx15 := Form1.Small_InputForm('NF-e exportao','Item: '+chr(10)+chr(10)+ibDataSet4.FieldByname('DESCRICAO').AsString+chr(10)+chr(10)+ 'Chave de Acesso da NF-e recebida para exportao:',sEx15);
                        spdNFeDataSets.Campo('chNFe_I54').Value  := sEx15;      // Chave de Acesso da NF-e recebida para exportao
                        spdNFeDataSets.Campo('qExport_I55').Value := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet16.FieldByname('QUANTIDADE').AsFloat)),',','.'); // Quantidade do item realmente exportado
                        //
                        try
                          spdNFeDataSets.IncluirPart('nRef');
                          spdNFeDataSets.Campo('refNFe_BA02').Value  := sEx15;      // Chave de Acesso da NF-e recebida para exportao
                          spdNFeDataSets.SalvarPart('nRef');
                        except end;
                        //
                      end;
                      //
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+ 'ao informar Nmero do ato concessrio de Drawback'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                    //
                    spdNFeDataSets.SalvarPart('adi');
                    //
                    // Fim - The End - Controle de Exportao por Item
                    //
                  end;
                  //
                  //
                  // BC: BASE DE CLCULO DO ICMS
                  // FCP: FUNDO DE COMBATE  POBREZA DO ESTADO DESTINATRIO
                  // ALQ: ALQUOTA DO IMPOSTO
                  // ALQ INTER: ALQUOTA INTERESTADUAL APLICVEL  OPERAO OU PRESTAO
                  // ALQ INTRA: ALQUOTA INTERNA NA UF DE DESTINO APLICVEL  OPERAO OU PRESTAO
                  // DIFAL: ICMS CORRESPONDENTE  DIFERENA ENTRE A ALQUOTA INTERNA DO ESTADO DESTINATRIO E A ALQUOTA INTERESTADUAL
                  //
                  if ((spdNFeDataSets.Campo('idDest_B11a').Value  = '2') and (spdNFeDataSets.Campo('indFinal_B25a').Value  = '1')) then
                  begin
                    //
                    // Calculo do DIFAL
                    //
                    // vBCUFDest (R$ 1.000) X pICMSUFDest (17%) = 170
                    // vBCUFDest (R$ 1.000) X pICMSInter (12%)  = 120
                    // Valor do DIFAL 170 - 120 = 50
                    //
                    //
                    try
                      if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',',')) >= 0.01 then
                      begin
                        //
                        if (Form7.ibDataSet16PICMSUFDEST.AsFloat >= 0.01) then // or (Pos('<FCP>',Form7.ibDataSet4TAGS_.AsString) <> 0) then
                        begin
                          //
                          spdNFeDataSets.Campo('vBCUFDest_NA03').Value         := spdNFeDataSets.Campo('vBC_N15').Value;              // Valor da BC do ICMS na UF de destino
                          //
                          if Form1.sVersaoLayout = '4.00' then
                          begin
                            spdNFeDataSets.campo('vBCFCPUFDest_NA04').Value := spdNFeDataSets.Campo('vBC_N15').Value; // Valor da BC FCP na UF de destino
                          end;
                          //
                          // fPercentualFCP
                          //
                          if (Form7.ibDataSet16PFCPUFDEST.AsFloat <> 0) or (Form7.ibDataSet16PICMSUFDEST.AsFloat <> 0) then
                          begin
                            spdNFeDataSets.Campo('pFCPUFDest_NA05').Value        := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet16PFCPUFDEST.AsFloat)),',','.'); // Percentual do ICMS relativo ao Fundo de Combate  Pobreza (FCP) na UF de destino
                            spdNFeDataSets.Campo('pICMSUFDest_NA07').Value       := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet16PICMSUFDEST.AsFloat)),',','.');
                            spdNFeDataSets.Campo('vFCPUFDest_NA13').Value        := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*(Form7.ibDataSet16PFCPUFDEST.AsFloat)/100)),',','.'); // Valor do ICMS relativo ao Fundo de Combate  Pobreza (FCP) da UF de destino
                          end;
                          //
                          // Alquota interestadual das UF envolvidas:
                          // - 4% alquota interestadual para produtos importados;
                          // - 7% para os Estados de origem do Sul e Sudeste (exceto ES),
                          // destinado para os Estados do Norte, Nordeste, CentroOeste
                          // e Esprito Santo;
                          // - 12% para os demais casos
                          //
                          if (Copy(Form7.ibDataSet4CST.AsString,1,1) = '1')
                          or (Copy(Form7.ibDataSet4CST.AsString,1,1) = '2')
                          or (Copy(Form7.ibDataSet4CST.AsString,1,1) = '3')
                          or (Copy(Form7.ibDataSet4CST.AsString,1,1) = '8') then // Produto importado
                          begin
                            spdNFeDataSets.Campo('pICMSInter_NA09').Value        := '4.00'; // Alquota interna da UF de destino
                          end else
                          begin
                            //
                            if (pos('|'+Form7.IBDataSet13ESTADO.AsString+'|','|RS|SC|PR|SP|MG|RJ|')>0) and (pos('|'+Form7.IBDataSet2ESTADO.AsString+'|','|RS|SC|PR|SP|MG|RJ|')=0) then
                            begin
                              spdNFeDataSets.Campo('pICMSInter_NA09').Value := '7.00'; // Alquota interna da UF de destino
                            end else
                            begin
                              spdNFeDataSets.Campo('pICMSInter_NA09').Value := '12.00'; // Alquota interna da UF de destino
                            end;
                            //
                          end;
                          //
                          try
                            //
                            // Quando  uma NF-e referenciada pega o ano da nota referenciada se no peda da data da emisso
                            //
                            if Length(LimpaNumero(spdNFeDataSets.Campo('refNFe_BA02').Value)) > 20 then
                            begin
                              iAnoRef := 2000+StrToInt(Copy(spdNFeDataSets.Campo('refNFe_BA02').Value,3,2));
                            end else
                            begin
                              iAnoRef := Year(Date);
                            end;
                          except
                            iAnoRef := Year(Date);
                          end;
                          //
                          if iAnoRef = 2016 then
                          begin
                            spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',40)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                          end else
                          begin
                            if iAnoRef = 2017 then
                            begin
                              spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',60)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                            end else
                            begin
                              if iAnoRef = 2018 then
                              begin
                                spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',80)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                              end else
                              begin
                                if iAnoRef >= 2019 then
                                begin
                                  spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',100)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                                end;
                              end;
                            end;
                          end;
                          //
                          if (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCUFDest_NA03').AsString,',',''),'.',',')) * StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pICMSUFDest_NA07').AsString,',',''),'.',',')) / 100)
                             > (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCUFDest_NA03').AsString,',',''),'.',',')) * StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pICMSInter_NA09').AsString,',',''),'.',',')) / 100) then
                          begin
                            fDIFAL := (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCUFDest_NA03').AsString,',',''),'.',',')) * StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pICMSUFDest_NA07').AsString,',',''),'.',',')) / 100)
                                    - (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCUFDest_NA03').AsString,',',''),'.',',')) * StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pICMSInter_NA09').AsString,',',''),'.',',')) / 100);
                          end else
                          begin
                            fDIFAL := (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCUFDest_NA03').AsString,',',''),'.',',')) * StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pICMSInter_NA09').AsString,',',''),'.',',')) / 100)
                                    - (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBCUFDest_NA03').AsString,',',''),'.',',')) * StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('pICMSUFDest_NA07').AsString,',',''),'.',',')) / 100)
                          end;
                          //
                          // fPercentualFCP
                          //
                          if fPercentualFCP <> 0 then
                          begin
                            spdNFeDataSets.Campo('vFCPUFDest_NA13').Value        := StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vBC_N15').AsString,',',''),'.',','))*(fPercentualFCP)/100)),',','.'); // Valor do ICMS relativo ao Fundo de Combate  Pobreza (FCP) da UF de destino
                          end;
                          //
                          // Percentual de ICMS Interestadual para a UF de destino:
                          // - 40% em 2016;
                          // - 60% em 2017;
                          // - 80% em 2018;
                          // - 100% a partir de 2019
                          //
                          if (fPercentualFCP <> 0) and not ((spdNFeDataSets.Campo('idDest_B11a').Value  = '2') and (spdNFeDataSets.Campo('indFinal_B25a').Value  = '1')) then
                          begin
                            spdNFeDataSets.Campo('vICMSUFDest_NA15').Value       := '0.00';  // Valor do ICMS Interestadual para a UF de destino
                            spdNFeDataSets.Campo('vICMSUFRemet_NA17').Value      := '0.00';  // Valor do ICMS Interestadual para a UF do remetente
                          end else
                          begin
                            if iAnoRef = 2016 then
                            begin
                              spdNFeDataSets.Campo('vICMSUFDest_NA15').Value       := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*40/100)),',','.');  // Valor do ICMS Interestadual para a UF de destino
                              spdNFeDataSets.Campo('vICMSUFRemet_NA17').Value      := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*60/100)),',','.');  // Valor do ICMS Interestadual para a UF do remetente
                            end else
                            begin
                              if iAnoRef = 2017 then
                              begin
                                spdNFeDataSets.Campo('vICMSUFDest_NA15').Value       := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*60/100)),',','.');  // Valor do ICMS Interestadual para a UF de destino
                                spdNFeDataSets.Campo('vICMSUFRemet_NA17').Value      := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*40/100)),',','.');  // Valor do ICMS Interestadual para a UF do remetente
                              end else
                              begin
                                if iAnoRef = 2018 then
                                begin
                                  spdNFeDataSets.Campo('vICMSUFDest_NA15').Value       := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*80/100)),',','.');  // Valor do ICMS Interestadual para a UF de destino
                                  spdNFeDataSets.Campo('vICMSUFRemet_NA17').Value      := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*20/100)),',','.');  // Valor do ICMS Interestadual para a UF do remetente
                                end else
                                begin
                                  if iAnoRef >= 2019 then
                                  begin
                                    spdNFeDataSets.Campo('vICMSUFDest_NA15').Value       := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*100/100)),',','.');  // Valor do ICMS Interestadual para a UF de destino
                                    spdNFeDataSets.Campo('vICMSUFRemet_NA17').Value      := StrTran(Alltrim(FormatFloat('##0.00',fDIFAL*0/100)),',','.');  // Valor do ICMS Interestadual para a UF do remetente
                                  end;
                                end;
                              end;
                            end;
                          end;
                          //
                          fFCPUFDest   := fFCPUFDest   + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCPUFDest_NA13').AsString,',',''),'.',','));
                          fICMSUFDest  := fICMSUFDest  + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMSUFDest_NA15').AsString,',',''),'.',','));
                          fICMSUFREmet := fICMSUFREmet + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vICMSUFREmet_NA17').AsString,',',''),'.',','));
                          //
                        end else
                        begin
                          //
                          ShowMessage('Ateno'+chr(10)+chr(10)+'Preencher nos itens da NF o valor da Alquota Interna da UF de destino e do (FCP) Fundo de Combate a Pobreza se necessrio.'+Chr(10)+Chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.');
                          Abort;
                          Abort;
                          //
                        end;
                        //
                      end else
                      begin
                        //
                        spdNFeDataSets.Campo('vBCUFDest_NA03').Value         := '0.00'; // Valor da BC do ICMS na UF de destino
                        //
                        if Form1.sVersaoLayout = '4.00' then
                        begin
                          spdNFeDataSets.campo('vBCFCPUFDest_NA04').Value := spdNFeDataSets.Campo('vBC_N15').Value; // Valor da BC FCP na UF de destino
                        end;
                        //
                        spdNFeDataSets.Campo('pFCPUFDest_NA05').Value        := '0.00'; // Percentual do ICMS relativo ao Fundo de Combate  Pobreza (FCP) na UF de destino
                        spdNFeDataSets.Campo('pICMSUFDest_NA07').Value       := '0.00'; // Aliquota interestadual das UF envolvidas
  //                      spdNFeDataSets.Campo('pICMSInter_NA09').Value        := '0.00'; // Alquota interna da UF de destino
                        //
                        // Alquota interestadual das UF envolvidas:
                        // - 4% alquota interestadual para produtos importados;
                        // - 7% para os Estados de origem do Sul e Sudeste (exceto ES),
                        // destinado para os Estados do Norte, Nordeste, CentroOeste
                        // e Esprito Santo;
                        // - 12% para os demais casos
                        //
                        if (Copy(Form7.ibDataSet4CST.AsString,1,1) = '1')
                        or (Copy(Form7.ibDataSet4CST.AsString,1,1) = '2')
                        or (Copy(Form7.ibDataSet4CST.AsString,1,1) = '3')
                        or (Copy(Form7.ibDataSet4CST.AsString,1,1) = '8') then // Produto importado
                        begin
                          spdNFeDataSets.Campo('pICMSInter_NA09').Value        := '4.00'; // Alquota interna da UF de destino
                        end else
                        begin
                          //
                          if (pos('|'+Form7.IBDataSet13ESTADO.AsString+'|','|RS|SC|PR|SP|MG|RJ|')>0) and (pos('|'+Form7.IBDataSet2ESTADO.AsString+'|','|RS|SC|PR|SP|MG|RJ|')=0) then
                          begin
                            spdNFeDataSets.Campo('pICMSInter_NA09').Value := '7.00'; // Alquota interna da UF de destino
                          end else
                          begin
                            spdNFeDataSets.Campo('pICMSInter_NA09').Value := '12.00'; // Alquota interna da UF de destino
                          end;
                          //
                        end;
                        //
                        try
                          //
                          // Quando  uma NF-e referenciada pega o ano da nota referenciada se no peda da data da emisso
                          //
                          if Length(LimpaNumero(spdNFeDataSets.Campo('refNFe_BA02').Value)) > 20 then
                          begin
                            iAnoRef := 2000+StrToInt(Copy(spdNFeDataSets.Campo('refNFe_BA02').Value,3,2));
                          end else
                          begin
                            iAnoRef := Year(Date);
                          end;
                        except
                          iAnoRef := Year(Date);
                        end;
                        //
                        if iAnoRef = 2016 then
                        begin
                          spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',40)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                        end else
                        begin
                          if iAnoRef = 2017 then
                          begin
                            spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',60)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                          end else
                          begin
                            if iAnoRef = 2018 then
                            begin
                              spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',80)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                            end else
                            begin
                              if iAnoRef >= 2019 then
                              begin
                                spdNFeDataSets.Campo('pICMSInterPart_NA11').Value    := StrTran(Alltrim(FormatFloat('##0.00',100)),',','.');  // Percentual provisrio de partilha do ICMS Interestadual
                              end;
                            end;
                          end;
                        end;
                        //
                        spdNFeDataSets.Campo('vFCPUFDest_NA13').Value        := '0.00'; // Valor do ICMS relativo ao Fundo de Combate  Pobreza (FCP) da UF de destino
                        spdNFeDataSets.Campo('vICMSUFDest_NA15').Value       := '0.00'; // Valor do ICMS Interestadual para a UF de destino
                        spdNFeDataSets.Campo('vICMSUFRemet_NA17').Value      := '0.00'; // Valor do ICMS Interestadual para a UF do remetente
                        //
                      end;
                      //
                    except
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao calcular o Grupo de Tributao do ICMS para UF Destino item cdigo: '+spdNFeDataSets.Campo('cProd_I02').Value+chr(10)+spdNFeDataSets.Campo('xProd_I04').Value+chr(10)+
                        chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                    end;
                  end;
                  //
                  // Cupom Fiscal Referenciado
                  //
                  if (Copy(Form7.ibDataSet16XPED.AsString,1,2) = 'CF') and (Length(AllTrim(Form7.ibDataSet16XPED.AsString))=13) then
                  begin
                    try
                      //
                      // CF123456CX123
                      //
                      if Pos(('REF COO: '+Copy(Form7.ibDataSet16XPED.AsString,3,6)+' CAIXA: '+Copy(Form7.ibDataSet16XPED.AsString,11,3)),sCupomReferenciado) = 0 then
                      begin
                        //
                        spdNFeDataSets.IncluirPart('NREF');
                        //
                        try
                          //
                          Form7.ibQuery1.Close;
                          Form7.ibQuery1.Sql.Clear;
                          Form7.ibQuery1.Sql.Add('select NUMERONF, CAIXA, NFEID from NFCE where NUMERONF='+QuotedStr(Copy(Form7.ibDataSet16XPED.AsString,3,6))+' and CAIXA='+QuotedStr(Copy(Form7.ibDataSet16XPED.AsString,11,3))+' ');
                          Form7.ibQuery1.Open;
                          //
                          if Form7.ibQuery1.FieldByname('NFEID').AsString <> '' then
                          begin
                            //
                            spdNFeDataSets.Campo('refNFe_BA02').Value  := Form7.ibQuery1.FieldByname('NFEID').AsString;
                            //
                          end else
                          begin
                            //
                            if Form7.IBQuery1.FieldByName('NUMERONF').AsString = Copy(Form7.ibDataSet16XPED.AsString,3,6) then
                            begin
                              spdNFeDataSets.Campo('mod_BA21').Value  := '2B'; // NFCE ou PAF
                            end else
                            begin
                              spdNFeDataSets.Campo('mod_BA21').Value  := '2D'; // PAF ECF
                            end;
                            //
                            spdNFeDataSets.Campo('nECF_BA22').Value := Copy(Form7.ibDataSet16XPED.AsString,11,3);
                            spdNFeDataSets.Campo('nCOO_BA23').Value := Copy(Form7.ibDataSet16XPED.AsString,3,6);
                            spdNFeDataSets.SalvarPart('NREF');
                            //
                          end;
                          //
                        except
                          spdNFeDataSets.Campo('mod_BA21').Value  := '2D'; // PAF ECF
                          spdNFeDataSets.Campo('nECF_BA22').Value := Copy(Form7.ibDataSet16XPED.AsString,11,3);
                          spdNFeDataSets.Campo('nCOO_BA23').Value := Copy(Form7.ibDataSet16XPED.AsString,3,6);
                          spdNFeDataSets.SalvarPart('NREF');
                        end;
                        //
                        sCupomReferenciado := sCupomReferenciado + 'REF COO: '+Copy(Form7.ibDataSet16XPED.AsString,3,6)+' CAIXA: '+Copy(Form7.ibDataSet16XPED.AsString,11,3)+' ';
                        //
                      end;
                      //
                    except
                      //
                      on E: Exception do
                      begin
                        Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao gravar NREF 0'
                        ),'Ateno',mb_Ok + MB_ICONWARNING);
                      end;
                      //
                    end;
                  end;
                  //
                  // Fim Cupom fiscal referenciado
                  //
                  //
                  ibDataset16.Next;
                  //
                end;
                //
                try
                  //
                  if spdNFeDataSets.Campo('indIEDest_E16a').Value = '9' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                  if spdNFeDataSets.Campo('indIEDest_E16a').Value = '2' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                  spdNFeDataSets.SalvarItem;
                  //
                except
                  on E: Exception do
                  begin
                    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao salvar item cdigo: '+spdNFeDataSets.Campo('cProd_I02').Value+chr(10)+spdNFeDataSets.Campo('xProd_I04').Value+chr(10)+
                    chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                    ),'Ateno',mb_Ok + MB_ICONWARNING);
                  end;
                end;
                //
                // Totalizadores da NFe
                //
                spdNFeDataSets.Campo('vBC_W03').Value     := StrTran(Alltrim(FormatFloat('##0.00',vBC)),',','.'); //Base de Clculo do ICMS
                spdNFeDataSets.Campo('vICMS_W04').Value   := StrTran(Alltrim(FormatFloat('##0.00',vICMS)),',','.'); // Valor Total do ICMS
                //
                sDIFAL_OBS := '';
                //
                if (spdNFeDataSets.Campo('idDest_B11a').Value  = '2') and (spdNFeDataSets.Campo('indFinal_B25a').Value  = '1') then
                begin
                  spdNFeDataSets.Campo('vFCPUFDest_W04c').Value := StrTran(Alltrim(FormatFloat('##0.00',fFCPUFDest)),',','.');    // Valor total do ICMS relativo Fundo de Combate  Pobreza (FCP) da UF de destino
                  spdNFeDataSets.Campo('vICMSUFDest_W04e').Value := StrTran(Alltrim(FormatFloat('##0.00',fICMSUFDest)),',','.');    // Valor total do ICMS Interestadual para a UF de destino
                  spdNFeDataSets.Campo('vICMSUFREmet_W04g').Value := StrTran(Alltrim(FormatFloat('##0.00',fICMSUFREmet)),',','.');    // Valor total do ICMS Interestadual para a UF do remetente
                  sDIFAL_OBS := 'Valores totais do ICMS Interestadual: DIFAL da UF destino R$'+AllTrim(spdNFeDataSets.Campo('vICMSUFDest_W04e').AsString)+' + FCP R$'+AllTrim(spdNFeDataSets.Campo('vFCPUFDest_W04c').AsString)+'; DIFAL da UF Origem R$'+AllTrim(spdNFeDataSets.Campo('vICMSUFREmet_W04g').AsString);
                end else
                begin
                  if fFCPUFDest <> 0 then // Fundo de combate a probreza
                  begin
                    spdNFeDataSets.Campo('vFCPUFDest_W04c').Value := StrTran(Alltrim(FormatFloat('##0.00',fFCPUFDest)),',','.');    // Valor total do ICMS relativo Fundo de Combate  Pobreza (FCP) da UF de destino
                    spdNFeDataSets.Campo('vICMSUFDest_W04e').Value := StrTran(Alltrim(FormatFloat('##0.00',fICMSUFDest)),',','.');    // Valor total do ICMS Interestadual para a UF de destino
                    spdNFeDataSets.Campo('vICMSUFREmet_W04g').Value := StrTran(Alltrim(FormatFloat('##0.00',fICMSUFREmet)),',','.');    // Valor total do ICMS Interestadual para a UF do remetente
                    sDIFAL_OBS := 'FCP R$'+AllTrim(spdNFeDataSets.Campo('vFCPUFDest_W04c').AsString);
                  end;
                end;
                //
                spdNFeDataSets.Campo('vICMSDeson_W04a').Value    := StrTran(Alltrim(FormatFloat('##0.00',vICMSDeson)),',','.'); // Desonerado
                //
                // No caso de nota fiscal de devolucao
                //
                if (Form7.ibDataSet15FINNFE.AsString = '4') and (AllTrim(ibDataSet16.FieldByname('CST_IPI').AsString) = '') then
                begin
                  spdNFeDataSets.campo('vIPIDevol_W12a').Value  := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(fIPIDevolvido,2))),',','.'); // Valor Total do IPI devolvido
                  spdNFeDataSets.Campo('vIPI_W12').Value        := '0.00'; // Valor Total do IPI
                end else
                begin
                  spdNFeDataSets.campo('vIPIDevol_W12a').Value  := '0.00'; // Valor Total do IPI devolvido
                  spdNFeDataSets.Campo('vIPI_W12').Value        := StrTran(Alltrim(FormatFloat('##0.00',Arredonda2(ibDataSet15.FieldByname('IPI').AsFloat,3))),',','.'); // Valor Total do IPI
                end;
                //
                spdNFeDataSets.campo('vFCP_W04h').Value       := StrTran(Alltrim(FormatFloat('##0.00',fFCP)),',','.'); // Valor Total do FCP (Fundo de Combate  Pobreza)
                spdNFeDataSets.campo('vFCPST_W06a').Value     := StrTran(Alltrim(FormatFloat('##0.00',fFCPST)),',','.'); // Valor Total do FCP (Fundo de Combate  Pobreza) retido por substituio tributria
                spdNFeDataSets.campo('vFCPSTRet_W06b').Value  := '0.00'; // Valor Total do FCP retido anteriormente por Substituio Tributria
                //
                spdNFeDataSets.Campo('vBCST_W05').Value   := StrTran(Alltrim(FormatFloat('##0.00',vBCST - vIVA60_B_ICMST)),',','.'); // Valor Total do ICMS Sibst. Tributria
                spdNFeDataSets.Campo('vST_W06').Value     := StrTran(Alltrim(FormatFloat('##0.00',vST)),',','.');; // Valor Total do ICMS Sibst. Tributria
                //
                spdNFeDataSets.Campo('vFrete_W08').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('FRETE').AsFloat)),',','.'); // Valor Total do Frete
                spdNFeDataSets.Campo('vSeg_W09').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SEGURO').AsFloat)),',','.'); // Valor Total do Seguro
                spdNFeDataSets.Campo('vDesc_W10').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.'); // Valor Total de Desconto
                spdNFeDataSets.Campo('vII_W11').Value     := '0.00'; // Valor Total do II
                spdNFeDataSets.Campo('vPIS_W13').Value    := StrTran(Alltrim(FormatFloat('##0.00',vPIS)),',','.'); // Valor Toal do PIS
                spdNFeDataSets.Campo('vCOFINS_W14').Value := StrTran(Alltrim(FormatFloat('##0.00',vCOFINS)),',','.');; // Valor Total do COFINS
                spdNFeDataSets.Campo('vOutro_W15').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('DESPESAS').AsFloat)),',','.'); // OUtras Despesas Acessrias
                //
                if Form7.ibDataSet15FINNFE.AsString = '2' then // Complemento de ICMS
                begin
                  spdNFeDataSets.Campo('vProd_W07').Value   := '0.00'; // Valor Total de Produtos e Servios
                end else
                begin
                  spdNFeDataSets.Campo('vProd_W07').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('MERCADORIA').AsFloat)),',','.'); // Valor Total de Produtos e Servios
                end;
                //
                try
                  //
                  // Recalcula o total da nota
                  //
                  if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vST_W06').AsString,',',''),'.',',')) <> 0 then
                  begin
                    spdNFeDataSets.Campo('vNF_W16').Value     := StrTran(Alltrim(FormatFloat('##0.00',
                    (
                      StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vProd_W07').asString  ,',',''),'.',',')) // Mercadoria
                    + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFrete_W08').asString ,',',''),'.',',')) // Frete
                    + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vSeg_W09').asString   ,',',''),'.',',')) // Seguro
                    + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vIPI_W12').asString   ,',',''),'.',',')) // IPI
                    + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vST_W06').asString    ,',',''),'.',',')) // Valor do ICMS substituio
                    + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vOutro_W15').asString ,',',''),'.',',')) // Despesas
                    + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCPST_W06a').asString ,',',''),'.',','))// Valor Total do FCP (Fundo de Combate  Pobreza) retido por substituio tributria
                    - StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vDesc_W10').asString  ,',',''),'.',',')) // Desconto
                    + Form7.ibDataSet15SERVICOS.AsFloat
//                    - vICMSDeson
                    + fIPIDevolvido))
                    )
                    ,',','.'); // Valor Total da NFe
                    //
                    // Ficou fora a reteno
                    //
                  end else
                  begin
//                    spdNFeDataSets.Campo('vNF_W16').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('TOTAL').AsFloat + fIPIDevolvido)),',','.');
                    spdNFeDataSets.Campo('vNF_W16').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('TOTAL').AsFloat)),',','.');
                  end;
                except
                  on E: Exception do
                  begin
                    Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING);
                  end;
                end;
                //
                if Form1.sVersaoLayout = '4.00' then
                begin
                  //
                  // Nesta nova verso no haver alterao no leiaute do DANFE. As informaes relativas ao Fundo de Combate  Pobreza (FCP) devem ser informadas:
                  // - Os valores de totais do FCP (id: W04b e W06a) devem ser informados em "Informaes Adicionais de Interesse do Fisco, campo "infAdFisco", quando existirem.
                  //
                  if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCP_W04h').AsString,',',''),'.',','))       <> 0 then spdNFeDataSets.campo('infAdFisco_Z02').Value := AllTrim(spdNFeDataSets.campo('infAdFisco_Z02').Value  + ' vFCP '  + spdNFeDataSets.campo('vFCP_W04h').Value);
                  if StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vFCPST_W06a').AsString,',',''),'.',','))     <> 0 then spdNFeDataSets.campo('infAdFisco_Z02').Value := AllTrim(spdNFeDataSets.campo('infAdFisco_Z02').Value  + ' vFCPST ' + spdNFeDataSets.campo('vFCPST_W06a').Value);
                  //
                end;
                //
                if Form7.ibDataSet15FINNFE.AsString = '2' then // Complemento de ICMS
                begin
                  if ibDataSet15.FieldByname('MERCADORIA').AsFloat = 0.01 then
                  begin
                    spdNFeDataSets.Campo('vNF_W16').Value     := '0.00'; // Valor Total de Produtos e Servios
                  end;
                end;
                //
                // ISSQN
                //
                if ibDataSet15.FieldByname('SERVICOS').AsFloat >= 0.01 then
                begin
                  //
                  Form7.ibDataSet14.First;
                  while (Form7.ibDataSet14ISS.AsFloat = 0) and ( not Form7.ibDataSet14.EOF) do Form7.ibDataSet14.Next;
                  if Form7.ibDataSet14ISS.AsFloat = 0 then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                  //
                  try
                    //
                    ibDataSet35.First;
                    while not ibDataSet35.Eof do
                    begin
                      //
                      Form7.ibDataSet4.Close;
                      Form7.ibDataSet4.Selectsql.Clear;
                      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet35DESCRICAO.AsString)+' ');  //
                      Form7.ibDataSet4.Open;
                      //
                      I := I + 1;
                      //
                      //
                      spdNFeDataSets.IncluirItem;
                      //
                      // Informaes Referentes aos ITens da NFe
                      //
                      spdNFeDataSets.Campo('nItem_H02').Value := IntToStr(I); // Nmero do Item da NFe (1 at 990)
                      //
                      // Dados do Produto Vendido
                      //
                      spdNFeDataSets.Campo('cProd_I02').Value    := '0000000000000'; //Cdigo do PRoduto ou Servio
                      spdNFeDataSets.Campo('cEAN_I03').Value     := 'SEM GTIN'; // EAN do Produto
                      spdNFeDataSets.Campo('xProd_I04').Value    := Alltrim(ConverteAcentos2(ibDataSet35.FieldByname('DESCRICAO').AsString));// Descrio do Servico
                      //
                      spdNFeDataSets.Campo('NCM_I05').Value      := '00'; // Cdigo do NCM - informar de acordo com o Tabela oficial do NCM
                      spdNFeDataSets.Campo('CFOP_I08').Value     := sDentroOuForadoEStado+'933'; //  Prestao de servio, cujo imposto  de competncia municipal, desde que informado em Nota Fiscal modelo 1 ou 1-A. (NR Ajuste SINIEF 06/2005)a partir de 01/01/2006
                      //
                      spdNFeDataSets.Campo('uCom_I09').Value     := 'UND';
                      spdNFeDataSets.Campo('qCom_I10').Value     := StrTran(ibDataSet35.FieldByname('QUANTIDADE').AsString,',','.'); // Quantidade Comercializada do Item
                      spdNFeDataSets.Campo('vUnCom_I10a').Value  := StrTran(Alltrim(FormatFloat('##0.'+Replicate('0',StrToInt(Form1.ConfPreco)),ibDataSet35.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Comercializado do Item
                      spdNFeDataSets.Campo('vProd_I11').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.'); // Valor Total Bruto do Item
                      spdNFeDataSets.Campo('cEANTrib_I12').Value := 'SEM GTIN'; // EAN do Produto
                      //
                      // ISS
                      //
                      spdNFeDataSets.Campo('uTrib_I13').Value     := 'UND'; // Unidade de Medida Tributvel do Item
                      spdNFeDataSets.Campo('qTrib_I14').Value     := StrTran(ibDataSet35.FieldByname('QUANTIDADE').AsString,',','.');  // Quantidade Tributvel do Item
                      spdNFeDataSets.Campo('vUnTrib_I14a').Value  := StrTran(Alltrim(FormatFloat('##0.0000',ibDataSet35.FieldByname('UNITARIO').AsFloat)),',','.'); // Valor Tributvel do Item
                      spdNFeDataSets.Campo('indTot_I17b').Value   := '0'; // 0 - O valor do Item NO compe o valor total da nota 1 - O valor do Item compe o valor total da nota
                      spdNFeDataSets.Campo('orig_N11').Value      := '0'; // Origemd da Mercadoria (0-Nacional, 1-Estrangeira, 2-Estrangeira adiquirida no Merc. Interno)
                      //
                      // Servios
                      //

                      //
                      // De olho no imposto Servios
                      //
                      spdNFeDataSets.Campo('vTotTrib_M02').Value  :=  StrTran(Alltrim(FormatFloat('##0.00',
                      Arredonda(((ibDataSet35.FieldByname('TOTAL').AsFloat)*ibDataSet4.FieldByname('IIA').AsFloat/100),2) +    // Federais
                      Arredonda(((ibDataSet35.FieldByname('TOTAL').AsFloat)*ibDataSet4.FieldByname('IIA_UF').AsFloat/100),2) + // Estaduais
                      Arredonda(((ibDataSet35.FieldByname('TOTAL').AsFloat)*ibDataSet4.FieldByname('IIA_MUNI').AsFloat/100),2) // Municipais
                      )),',','.'); // Valor aproximado total de tributos
                      //
                      // Federais
                      //
                      fTotaldeTriubutos := fTotaldeTriubutos +
                      Arredonda(((ibDataSet35.FieldByname('TOTAL').AsFloat)*ibDataSet4.FieldByname('IIA').AsFloat/100),2);
                      //
                      // Estaduais
                      //
                      fTotaldeTriubutos_uf := fTotaldeTriubutos_uf +
                      Arredonda(((ibDataSet35.FieldByname('TOTAL').AsFloat)*ibDataSet4.FieldByname('IIA_UF').AsFloat/100),2);
                      //
                      // Municipais
                      //
                      fTotaldeTriubutos_muni := fTotaldeTriubutos_muni +
                      Arredonda(((ibDataSet35.FieldByname('TOTAL').AsFloat)*ibDataSet4.FieldByname('IIA_MUNI').AsFloat/100),2);
                      //
                      spdNFeDataSets.Campo('vBC_U02').Value       := StrTran(Alltrim(FormatFloat('##0.00', ibDataSet14.FieldByname('BAseISS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100)),',','.'); // Valor da BC do ISSSQN
                      spdNFeDataSets.Campo('vAliq_U03').Value     := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet14.FieldByname('ISS').AsFloat)),',','.');  // Aliquota de ISSQN
                      spdNFeDataSets.Campo('vISSQN_U04').Value    := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('ISS').AsFloat)),',','.');// Valor do ISSQN
                      spdNFeDataSets.Campo('cMunFG_U05').Value    := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7); // Cdigo do municpio IBGE;
                      //
                      if RetornaValorDaTagNoCampo('cListServ',form7.ibDataSet4.FieldByname('TAGS_').AsString) <> '' then
                      begin
                        spdNFeDataSets.Campo('cListServ_U06').Value := RetornaValorDaTagNoCampo('cListServ',form7.ibDataSet4.FieldByname('TAGS_').AsString); // Item da lista de servios; Padro ABRASF
                      end else
                      begin
                        spdNFeDataSets.Campo('cListServ_U06').Value := '14.01'; // Item da lista de servios; Padro ABRASF
                      end;
                      //
                      spdNFeDataSets.Campo('indISS_U12').Value        := '1'; // Indicador da exigibilidade do ISS 1-Exigvel; 2-No incidente; 3-Iseno; 4-Exportao; 5-Imunidade; 6-Exig.Susp. Judicial; 7-Exig.Susp. ADM
                      //
                      if AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                      begin
                        spdNFeDataSets.Campo('cServico_U13').Value      := AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString)); // Cdigo do servio prestado dentro do municpio
                      end else
                      begin
                        spdNFeDataSets.Campo('cServico_U13').Value      := '00000000000000000001'; // Cdigo do servio prestado dentro do municpio
                      end;
                      //
                      spdNFeDataSets.Campo('cMun_U14').Value          := spdNFeDataSets.Campo('cMun_E10').Value; // Valor outras retenes Tabela do IBGE. Informar 9999999 para servio fora do Pais.
                      spdNFeDataSets.Campo('cPais_U15').Value         := '1058'; // Cdigo do pas onde o servio foi prestado no caso Brasil
                      spdNFeDataSets.Campo('nProcesso_U16').Value      := '';    // Nmero do Processo administrativo ou judicial de suspeno do processo Informar somente quando declarada a suspenso da exigibilidade do ISSQN.
                      spdNFeDataSets.Campo('indIncentivo_U17').Value   := '2';   // indIncentivo Indicador de incentivo Fiscal 1  SIm; 2  No;
                      //
                      // PIS Sobre Servios
                      //
                      if (ibDataSet14.FieldByname('PPIS').AsFloat * ibDataSet14.FieldByname('BCPIS').AsFloat <> 0) then
                      begin
                        spdNFeDataSets.Campo('CST_Q06').Value   := ibDataSet14.FieldByname('CSTPISCOFINS').AsString; // Codigo de Situacao Tributria PIS - ver opes no Manual
                        spdNFeDataSets.Campo('vBC_Q07').Value   := StrTran(Alltrim(FormatFloat('##0.00', ibDataSet14.FieldByname('BCPIS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100 )),',','.'); // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet14.FieldByname('PPIS').AsFloat)),',','.'); // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value  := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet14.FieldByname('PPIS').AsFloat * ibDataSet14.FieldByname('BCPIS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100 / 100)),',','.');  // Valor do PIS sobre servios
                        vPIS_S := vPIS_S + Arredonda(ibDataSet14.FieldByname('PPIS').AsFloat * ibDataSet14.FieldByname('BCPIS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100 / 100,2);
                      end else
                      begin
                        spdNFeDataSets.Campo('CST_Q06').Value   := '08';   // Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,2); // Codigo de Situacao Tributria - ver opes no Manual
                        spdNFeDataSets.Campo('vBC_Q07').Value   := '0.00'; // Valor da Base de Clculo do PIS
                        spdNFeDataSets.Campo('pPIS_Q08').Value  := '0.00'; // Alquota em Percencual do PIS
                        spdNFeDataSets.Campo('vPIS_Q09').Value  := '0.00';  // Valor do PIS sobre servios
                      end;
                      //
                      // COFINS Sobre Servios
                      //
                      if (ibDataSet14.FieldByname('PCOFINS').AsFloat * ibDataSet14.FieldByname('BCCOFINS').AsFloat <> 0) then
                      begin
                        spdNFeDataSets.Campo('CST_S06').Value     := ibDataSet14.FieldByname('CSTPISCOFINS').AsString;  // Cdigo de Situacao Tributria COFINS - ver opes no Manual
                        spdNFeDataSets.Campo('vBC_S07').Value     := StrTran(Alltrim(FormatFloat('##0.00', ibDataSet14.FieldByname('BCCOFINS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100 )),',','.');; // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet14.FieldByname('PCOFINS').AsFloat)),',','.');; // Alquota do COFINS em Percentual
                        spdNFeDataSets.Campo('vCOFINS_S11').Value := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet14.FieldByname('PCOFINS').AsFloat * ibDataSet14.FieldByname('BCCOFINS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100 / 100)),',','.');; // Valor do COFINS em Reais
                        //
                        vCOFINS_S := vCOFINS_S + arredonda(ibDataSet14.FieldByname('PCOFINS').AsFloat * ibDataSet14.FieldByname('BCCOFINS').AsFloat * ibDataSet35.FieldByname('TOTAL').AsFloat / 100 / 100,2);
                        //
                      end else
                      begin
                        spdNFeDataSets.Campo('CST_S06').Value     := '08'; // Copy(LimpaNumero(ibDataSet4.FieldByname('CST').AsString)+'000',1,2); // Cdigo de Situacao Tributria - ver opes no Manual
                        spdNFeDataSets.Campo('vBC_S07').Value     := '0.00'; // Valor da Base de Clculo do COFINS
                        spdNFeDataSets.Campo('pCOFINS_S08').Value := '0.00'; // Alquota do COFINS em Percentual
                        spdNFeDataSets.Campo('vCOFINS_S11').Value := '0.00'; // Valor do COFINS em Reais
                      end;
                      //
                      if spdNFeDataSets.Campo('indIEDest_E16a').Value = '9' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                      if spdNFeDataSets.Campo('indIEDest_E16a').Value = '2' then spdNFeDataSets.Campo('IE_E17').Value          := '';
                      //
                      spdNFeDataSets.SalvarItem;
                      //
                      ibDataset35.Next;
                      //
                    end;
                    //
                    spdNFeDataSets.Campo('vServ_W18').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat)),',','.'); // Valor Total de servios
                    //
                    Form7.ibDataSet14.DisableControls;
                    Form7.ibDataSet14.Close;
                    Form7.ibDataSet14.SelectSQL.Clear;
                    Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
                    Form7.ibDataSet14.Open;
                    Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                    Form7.ibDataSet14.EnableControls;
                    //
                    if (ibDataSet15.FieldByname('SERVICOS').AsFloat <>  0) then
                    begin
                      //
                      if (ibDataSet14.FieldByname('BASEISS').AsFloat * ibDataSet14.FieldByname('ISS').AsFloat) =  0 then
                      begin
                        //
                        Form7.ibDataSet14.First;
                        while (Form7.ibDataSet14ISS.AsFloat = 0) and ( not Form7.ibDataSet14.EOF) do Form7.ibDataSet14.Next;
                        if Form7.ibDataSet14ISS.AsFloat = 0 then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                        //
                      end;
                      //
                      if (ibDataSet14.FieldByname('BASEISS').AsFloat * ibDataSet14.FieldByname('ISS').AsFloat) <>  0 then
                      begin
                        //
                        spdNFeDataSets.Campo('vBC_W19').Value        := StrTran(Alltrim(FormatFloat('##0.00', ibDataSet14.FieldByname('BAseISS').AsFloat * ibDataSet15.FieldByname('SERVICOS').AsFloat / 100)),',','.'); // Base de calculo do ISS
                        spdNFeDataSets.Campo('vISS_W20').Value       := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('ISS').AsFloat)),',','.'); // Valor Total de ISS
                        //
                      end;
                      //
                      //
                      //
                      // Pis Sobre Servios
                      //
                      if (ibDataSet14.FieldByname('PPIS').AsFloat * ibDataSet14.FieldByname('BCPIS').AsFloat <> 0) then
                      begin
  //                      spdNFeDataSets.Campo('vPIS_W21').Value  :=  StrTran(Alltrim(FormatFloat('##0.00',ibDataSet14.FieldByname('PPIS').AsFloat * ibDataSet14.FieldByname('BCPIS').AsFloat * ibDataSet15.FieldByname('SERVICOS').AsFloat / 100 / 100)),',','.');  // Valor do PIS sobre servios
                        spdNFeDataSets.Campo('vPIS_W21').Value  :=  StrTran(Alltrim(FormatFloat('##0.00',vPIS_S)),',','.');  // Valor do PIS sobre servios
                      end;
                      //
                      // COFINS Sobre Servios
                      //
                      if (ibDataSet14.FieldByname('PCOFINS').AsFloat * ibDataSet14.FieldByname('BCCOFINS').AsFloat <> 0) then
                      begin
                        spdNFeDataSets.Campo('vCOFINS_W22').Value  :=  StrTran(Alltrim(FormatFloat('##0.00',vCOFINS_S)),',','.');  // Valor do COFINS sobre servios
                      end;
                      //
                      spdNFeDataSets.Campo('dCompet_W22a').Value       := StrTran(DateToStrInvertida(Date),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso;
                      //
                    end;
                    //
                    // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
                    //
                    try
                      if ibDataSet15.FieldByname('SERVICOS').AsFloat >= Form1.ConfLimite  then
                      begin
                        spdNFeDataSets.Campo('vBCIRRF_W27').Value := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat)),',','.'); // Base de Clculo do IRRF
                        spdNFeDataSets.Campo('vIRRF_W28').Value   := StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat * ((Form1.ConfIR / 100) * 1))),',','.'); // Valor Retido do IRRF
                      end;
                    except end;
                    //
                  except
                    //
                    on E: Exception do
                    begin
                      //
                      Application.MessageBox(pChar(E.Message+chr(10)+
                      chr(10)+'Ao informar servios.'+
                      chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                      ),'Ateno',mb_Ok + MB_ICONWARNING);
                      //
                      Form7.ibDataset15.Edit;
                      Form7.ibDataSet15STATUS.AsString    := 'Erro: Ao salvar XML.';
                      Abort;
                      //
                    end;
                    //
                  end;
                end;
                //
                // Valor aproximado total de tributos
                //
                if Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '7' then // Exportao
  //              if Form7.ibDataSet2ESTADO.AsString <> 'EX' then
                begin
                  //
                  if (fTotaldeTriubutos + fTotaldeTriubutos_uf + fTotaldeTriubutos_muni) > 0 then
                  begin
                    //
                    spdNFeDataSets.Campo('vTotTrib_W16a').Value  := StrTran(Alltrim(FormatFloat('##0.00', fTotaldeTriubutos + fTotaldeTriubutos_uf + fTotaldeTriubutos_muni )),',','.'); // Valor aproximado total de tributos
                    //
                    if fTotaldeTriubutos + fTotaldeTriubutos_uf + fTotaldeTriubutos_muni <> 0 then
                    begin
                      sComplemento := sComplemento + 'Trib aprox R$: ';
                    end;
                    //
                    if fTotaldeTriubutos <> 0 then sComplemento := sComplemento + Alltrim(FormatFloat('##0.00', fTotaldeTriubutos )) + ' Federal ';
                    if fTotaldeTriubutos_uf <> 0 then sComplemento := sComplemento + Alltrim(FormatFloat('##0.00', fTotaldeTriubutos_uf )) + ' Estadual ';
                    if fTotaldeTriubutos_muni <> 0 then sComplemento := sComplemento + Alltrim(FormatFloat('##0.00', fTotaldeTriubutos_muni )) + ' Municipal ';
                    //
                    if fTotaldeTriubutos + fTotaldeTriubutos_uf + fTotaldeTriubutos_muni <> 0 then
                    begin
                      //
                      Form7.ibQuery3.Close;
                      Form7.ibQuery3.SQL.Clear;
                      Form7.ibQuery3.SQL.Add('select first 1 FONTE, CHAVE from IBPT_');
                      Form7.ibQuery3.Open;
                      //
                      sComplemento := sComplemento + 'Fonte: ' + alltrim(Form7.ibQuery3.FieldByname('FONTE').AsString) + ' ' + AllTrim(Form7.ibQuery3.FieldByname('CHAVE').AsString);
                      //
                    end;
                    //
                  end;
                end;
                //
                // Dados do Transporte da NFe
                //
                spdNFeDataSets.Campo('modFrete_X02').Value := Alltrim(ibDAtaSet15.FieldByname('FRETE12').AsString);
                //
                if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)<>'' then
                begin
                  //
                  if (Length(AllTrim(ibDataSet18.FieldByname('CGC').AsString)) = 0) then
                  begin
                    Form7.ibDataset15.Edit;
                    Form7.ibDataSet15STATUS.AsString    := 'Erro: CNPJ da transportadora invlido';
                    Abort;
                  end;
                  //
                  if (Length(AllTrim(ibDataSet18.FieldByname('CGC').AsString)) = 18) then
                  begin
                    if LimpaNumero(Form7.ibDataSet18IE.AsString) <> '' then
                    begin
                      if ConsisteInscricaoEstadual(LimpaNumero(Form7.ibDataSet18IE.AsString),Form7.ibDataSet18UF.AsString) then
                      begin
                        //
                        Form7.ibDataset15.Edit;
                        Form7.ibDataSet15STATUS.AsString    := 'Erro: Inscrio Estadual da transportadora Invlida.';
                        //
                        Abort;
                        //
                      end;
                    end;
                  end;
                  if (Length(AllTrim(ibDataSet18.FieldByname('CGC').AsString)) = 18) then
                  begin
                    spdNFeDataSets.Campo('CNPJ_X04').Value     := LimpaNumero(ibDataSet18.FieldByname('CGC').AsString); // CNPJ do Transportador
                  end else
                  begin
                    spdNFeDataSets.Campo('CPF_X05').Value     := LimpaNumero(ibDataSet18.FieldByname('CGC').AsString); // CNPJ do Transportador
                  end;
                  //
                  spdNFeDataSets.Campo('xNome_X06').Value    := ConverteAcentos2(ibDAtaSet18.FieldByname('NOME').AsString); // Nome do Transportador
                  //
                  if AllTrim(ibDataSet18.FieldByname('IE').AsString) <> '' then
                  begin
                    if UpperCase(ibDataSet18.FieldByname('IE').AsString)='ISENTO' then
                    begin
                      spdNFeDataSets.Campo('IE_X07').Value       := 'ISENTO'; //  Inscrio estadual do Transportador
                    end else
                    begin
                      spdNFeDataSets.Campo('IE_X07').Value       := LimpaNumero(ibDataSet18.FieldByname('IE').AsString); //  Inscrio estadual do Transportador
                    end;
                  end;
                  //
                  spdNFeDataSets.Campo('xEnder_X08').Value   := ConverteAcentos2(ibDAtaSet18.FieldByname('ENDERECO').AsString); // Endereo do Transportador
                  spdNFeDataSets.Campo('xMun_X09').Value     := ConverteAcentos2(ibDAtaSet18.FieldByname('MUNICIPIO').AsString); // Nome do Municpio do Transportador
                  spdNFeDataSets.Campo('UF_X10').Value       := ibDAtaSet18.FieldByname('UF').AsString; // Sigla do Estado do Transportador
                  //
                  if Length(StrTran(StrTran(ibDAtaSet15.FieldByname('PLACA').AsString,' ',''),'-','')) = 7 then
                  begin
                    spdNFeDataSets.Campo('placa_X19').Value    := StrTran(StrTran(ibDAtaSet15.FieldByname('PLACA').AsString,' ',''),'-',''); // Placa do Veculo
                    spdNFeDataSets.Campo('uf_X20').Value       := ibDAtaSet18.FieldByname('ESTADO').AsString; // Sigla do Estado da Placa do Veculo
                    spdNFeDataSets.Campo('rntc_X21').Value     := ibDAtaSet18.FieldByname('ANTT').AsString; // Registro nacional de Trasportador de Cargas (ANTT)
                  end;
                  //
                end else
                begin
                  //
                  spdNFeDataSets.Campo('CNPJ_X04').Value     := ''; // CNPJ do Transportador
                  spdNFeDataSets.Campo('CPF_X05').Value      := ''; // CNPJ do Transportador
                  spdNFeDataSets.Campo('xNome_X06').Value    := ''; // Nome do Transportador
                  spdNFeDataSets.Campo('IE_X07').Value       := ''; //  Inscrio estadual do Transportador
                  spdNFeDataSets.Campo('xEnder_X08').Value   := ''; // Endereo do Transportador
                  spdNFeDataSets.Campo('xMun_X09').Value     := ''; // Nome do Municpio do Transportador
                  spdNFeDataSets.Campo('UF_X10').Value       := ''; // Sigla do Estado do Transportador
                  spdNFeDataSets.Campo('placa_X19').Value    := ''; // Placa do Veculo
                  spdNFeDataSets.Campo('uf_X20').Value       := ''; // Sigla do Estado da Placa do Veculo
                  spdNFeDataSets.Campo('rntc_X21').Value     := ''; // Registro nacional de Trasportador de Cargas (ANTT)
                  //
                end;
                //
                if Form1.sVersaoLayout = '4.00' then
                begin
                  //
                  spdNFeDataSets.IncluirPart('YA');
                  //
                  // 01=Dinheiro
                  // 02=Cheque
                  // 03=Carto de Crdito
                  // 04=Carto de Dbito
                  // 05=Crdito Loja
                  // 10=Vale Alimentao
                  // 11=Vale Refeio
                  // 12=Vale Presente
                  // 13=Vale Combustvel
                  // * Removida * 14=Duplicata Mercantil *
                  // 15=Boleto Bancrio
                  // 90= Sem pagamento
                  // 99=Outros
                  //


                  if (spdNFeDataSets.Campo('finNFe_B25').Value = '4') or (spdNFeDataSets.Campo('finNFe_B25').Value = '3') or (spdNFeDataSets.Campo('finNFe_B25').Value = '2') then // Finalidade da NFe (1-Normal, 2-Complementar, 3-de Ajuste, 4-Devoluo de mercadoria)
                  begin
  //                  spdNFeDataSets.campo('indPag_YA01b').Value    := '0';   // Pagamento a vista
                    spdNFeDataSets.campo('tPag_YA02').Value       := '90';  // Sem Pagamento
                  end else
                  begin
                    //
                    Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                    //
                    if Copy(Uppercase(ibDataSet14.FieldByname('INTEGRACAO').AsString)+'       ',1,7) = 'RECEBER' then
                    begin
  //                    spdNFeDataSets.campo('indPag_YA01b').Value    := '1';   // Pagamento a prazo
  //                  spdNFeDataSets.campo('tPag_YA02').Value       := '05';  // Forma de pagamento
                      spdNFeDataSets.campo('tPag_YA02').Value       := '14';  // Duplicata Mercantil
                    end else
                    begin
  //                    spdNFeDataSets.campo('indPag_YA01b').Value    := '0';   // Pagamento a vista
                      spdNFeDataSets.campo('tPag_YA02').Value       := '01';  // Forma de pagamento
                    end;
                  end;
                  //
                  if spdNFeDataSets.campo('tPag_YA02').Value = '90' then
                  begin
                    //
                    // Sem Pagamento
                    //
                    spdNFeDataSets.campo('vPag_YA03').Value       := '0.00';
  //                  spdNFeDataSets.campo('vTroco_YA09').Value     := '0.00';  // valor do troco
                    //
                  end else
                  begin
                    spdNFeDataSets.campo('vPag_YA03').Value       :=  spdNFeDataSets.Campo('vNF_W16').Value;
                    spdNFeDataSets.campo('vTroco_YA09').Value     := '0.00';  // valor do troco
                  end;
                  //
                  if False then
                  begin
                    //
                    // Se for Carto
                    //
                    spdNFeDataSets.campo('tpIntegra_YA04a').Value := '2';  // Tipo de Integrao para pagamento
                    spdNFeDataSets.campo('CNPJ_YA05').Value       := '';  // CNPJ da Credenciadora de carto de crdito e/ou dbito
                    spdNFeDataSets.campo('tBand_YA06').Value      := '';  // Bandeira da operadora de carto de crdito e/ou dbito
                    spdNFeDataSets.campo('cAut_YA07').Value       := '';  // Nmero de autorizao da operao carto de crdito e/ou dbito
                  end;
                  //
                  spdNFeDataSets.SalvarPart('YA');
                  //
                end;
                //
                if Form7.ibDataSet15FINNFE.AsString <> '2' then
                begin
                  //
                  // Dados da Carga Transportada
                  //
                  spdNFeDataSets.Campo('qVol_X27').Value     := LimpaNumero(ibDataSet15.FieldByname('VOLUMES').AsString); // Quantidade de Volumes transportados
                  spdNFeDataSets.Campo('esp_X28').Value      := ConverteAcentos2(ibDataSet15.FieldByname('ESPECIE').AsString); // Espcie de Carga Transportada
                  spdNFeDataSets.Campo('marca_X29').Value    := ConverteAcentos2(ibDataSet15.FieldByname('MARCA').AsString); // MArca da Carga Transportada
                  spdNFeDataSets.Campo('nVol_X30').Value     := ConverteAcentos2(ibDataSet15.FieldByname('NVOL').AsString);; // Numerao dos Volumes transportados
                  //
                  spdNFeDataSets.Campo('pesoL_X31').Value    := StrTran(Alltrim(FormatFloat('##0.000',ibDataSet15.FieldByname('PESOLIQUI').AsFloat)),',','.'); // Peso Lquido
                  spdNFeDataSets.Campo('pesoB_X32').Value    := StrTran(Alltrim(FormatFloat('##0.000',ibDataSet15.FieldByname('PESOBRUTO').AsFloat)),',','.'); // Peso Bruto
                  //
                  // Dados De Cobrana
                  //
                  // 1 Fatura  - 3 Duplicatas //
                  //
                  spdNFeDataSets.Y.Append; // Inclui somente nessa Parte "Y" da NFe
                  spdNFeDataSets.Campo('nFat_Y03').Value  := Copy(Form7.ibDataSet15NUMERONF.AsString,1,9); // Nmero da Farura
                  spdNFeDataSets.Campo('vOrig_Y04').Value := spdNFeDataSets.Campo('vNF_W16').Value; // Valor Original da Fatura
                  //
                  if Form1.sVersaoLayout = '4.00' then
                  begin
  //                  if Form7.spdNFe.Ambiente = spdNFeType.akHomologacao then
                    begin
                      spdNFeDataSets.Campo('vDesc_Y05').Value := '0.00'; // Valor do Desconto
                    end;
                  end;
                  //
                  spdNFeDataSets.Campo('vLiq_Y06').Value  := spdNFeDataSets.Campo('vNF_W16').Value; // Valor Lquido da Fatura
                  //
                  J := 0;
                  fTotalDupl := 0;
                  //
                  Form7.ibDataSet7.First;
                  while not Form7.ibDataSet7.Eof do
                  begin
                    //
                    // Note que Os dados da Fatura se encontram no Parte "Y" da NFe que vamos
                    // fazer vrias inseres para a Mesma NFe como demonstracao
                    // Dados da Fatura
                    //
                    //
                    // Duplicatas
                    //
                    J := J + 1;
                    //
                    spdNFeDataSets.IncluirCobranca;
                    spdNFeDataSets.Campo('nDup_Y08').Value  := StrZero(J,3,0); // Nmero da parcela
  //                  spdNFeDataSets.Campo('nDup_Y08').Value  := Form7.ibDataSet7DOCUMENTO.AsString; // Nmero da Duplicata
                    spdNFeDataSets.Campo('dVenc_Y09').Value := StrTran(DateToStrInvertida(Form7.ibDataSet7VENCIMENTO.AsDateTime),'/','-');; // Data de Vencimento da Duplicata
                    spdNFeDataSets.Campo('vDup_Y10').Value  := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet7VALOR_DUPL.AsFloat)),',','.'); // Valor da Duplicata
                    //
                    // Soma o total das parcelas
                    //
                    try
                      //
                      fTotalDupl := fTotalDupl + StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vDup_Y10').AsString,',',''),'.',','));
                      //
                      Form7.ibDataSet7.Next;
                      //
                      if Form7.ibDataSet7.Eof then
                      begin
                        if fTotalDupl <> StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vNF_W16').AsString,',',''),'.',',')) then
                        begin
                          //
                          // Soma a diferena na ltima
                          //
                          spdNFeDataSets.Campo('vDup_Y10').Value := StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet7VALOR_DUPL.AsFloat +  (StrToFloat(StrTran(StrTran('0'+spdNFeDataSets.Campo('vNF_W16').AsString,',',''),'.',',')) - fTotalDupl)  )),',','.');
                          // ShowMessage('Teste: ' + spdNFeDataSets.Campo('vNF_W16').AsString);
                        end;
                      end;
                    except end;
                    //
                    spdNFeDataSets.SalvarCobranca;
                    //
                  end;
                  //
                  //
                  spdNFeDataSets.Y.Post; // Grava a Duplicata em questo.
                  //
                end;
                //
                // Dados Adicionais da NFe - Observaes
                //
                if RetornaValorDaTagNoCampo('infAdFisco', form7.ibDataSet14.FieldByname('OBS').AsString) <> '' then
                begin
                  spdNFeDataSets.Campo('infAdFisco_Z02').Value      := AllTrim(spdNFeDataSets.Campo('infAdFisco_Z02').Value +' '+ RetornaValorDaTagNoCampo('infAdFisco', form7.ibDataSet14.FieldByname('OBS').AsString));
                  spdNFeDataSets.Campo('infCpl_Z03').Value          := AllTrim(ConverteAcentos2(AllTrim(sTrTran(pChar('<infAdFisco>'+
                  RetornaValorDaTagNoCampo('infAdFisco', form7.ibDataSet14.FieldByname('OBS').AsString)+'</infAdFisco>'),AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString),'')+
                  ' '+AllTrim(sComplemento)+' '+sDIFAL_OBS + ' ' + sCupomReferenciado))); // Informacoes Complementares
                end else
                begin
                  spdNFeDataSets.Campo('infCpl_Z03').Value     := AllTrim(ConverteAcentos2(AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString+' '+AllTrim(sComplemento)+' '+sDIFAL_OBS + ' ' + sCupomReferenciado))); // Informacoes Complementares
                end;
                //
                //
                // spdNFeDataSets.Campo('xPed_ZB03').Value      := Form7.ibDataSet16NUMEROOS.AsString; // Informar o pedido no caso a OS
                //
                // SAIDA
                //
              end;
              //
              // Grupo ZD. Informaes do Responsvel Tcnico
              //
//              if Form1.bHomologacao then
              begin
                spdNFeDataSets.Campo('CNPJ_ZD02').Value                         := '07426598000124';
                spdNFeDataSets.Campo('xContato_ZD04').Value                     := 'Ronei Ivo Weber';
                spdNFeDataSets.Campo('email_ZD05').Value                        := 'smallsoft@smallsoft.com.br';
                spdNFeDataSets.Campo('fone_ZD06').Value                         := '4934255800';
              end;
              //
              if Form1.bModoSVC then
              begin
                //
                sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',chr(10)+'Para imprimir a nf-e em modo de SVC informe uma justificativa (min. 15 caracteres)'+chr(10)+chr(10), ''));
                //
                if Length(sJustificativa) >= 15 then
                begin
                  //
                  spdNFeDataSets.Campo('xJust_B29').Value    := sJustificativa;
  //                  spdNFeDataSets.Campo('dhCont_B28').Value    := StrTran(DateToStrInvertida(Date),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso;
                  spdNFeDataSets.Campo('dhCont_B28').Value   := StrTran(DateToStrInvertida(Date),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso; // Data de Emisso da Nota Fiscal
                end else
                begin
                  if AllTrim(sJustificativa) <> '' then
                  begin
                    ShowMessage('A justificativa tem que ter no minimo 15 caracteres.');
                    Abort;
                  end;
                end;
              end;
              //
              if Form1.bModoScan then
              begin
                //
                sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',chr(10)+'Para imprimir a nf-e em modo de SCAN informe uma justificativa (min. 15 caracteres)'+chr(10)+chr(10), ''));
                //
                if Length(sJustificativa) >= 15 then
                begin
                   spdNFeDataSets.Campo('xJust_B29').Value    := sJustificativa;
  //                 spdNFeDataSets.Campo('dhCont_B28').Value   := Copy(DateToStr(Date),7,4)+'-'+Copy(DateToStr(Date),4,2)+'-'+Copy(DateToStr(Date),1,2)+'T'+TimeToStr(Time);
                   spdNFeDataSets.Campo('dhCont_B28').Value   := StrTran(DateToStrInvertida(Date),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso; // Data de Emisso da Nota Fiscal
                end else
                begin
                  if AllTrim(sJustificativa) <> '' then
                  begin
                    ShowMessage('A justificativa tem que ter no minimo 15 caracteres.');
                    Abort;
                  end;
                end;
              end;
              //
              if bContingencia then
              begin
                //
                sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',chr(10)+

                                                  'Esta opo somente deve ser usada em caso de emergncia, quando o servidor da receita no estiver disponvel.'+Chr(10)+Chr(10)+
                                                  'Quando o servidor estiver disponvel novamente esta NF-e dever ser transmitida e autorizada.'+Chr(10)+Chr(10)+
                                                  'O formulrio de contingncia deve ser autorizado pelo fisco.'+Chr(10)+Chr(10)+
                                                  'Para imprimir a nf-e em modo de contingncia informe uma justificativa (min. 15 caracteres)'+chr(10)+chr(10), ''));
                //
                if Length(sJustificativa) >= 15 then
                begin
                   spdNFeDataSets.Campo('xJust_B29').Value         := sJustificativa;
  //                 spdNFeDataSets.Campo('dhCont_B28').Value   := Copy(DateToStr(Date),7,4)+'-'+Copy(DateToStr(Date),4,2)+'-'+Copy(DateToStr(Date),1,2)+'T'+TimeToStr(Time);
                   spdNFeDataSets.Campo('dhCont_B28').Value   := StrTran(DateToStrInvertida(Date),'/','-')+'T'+TimeToStr(Time)+Form7.sFuso; // Data de Emisso da Nota Fiscal
                end else
                begin
                  if AllTrim(sJustificativa) <> '' then
                  begin
                    ShowMessage('A justificativa tem que ter no minimo 15 caracteres.');
                    Abort;
                  end;
                end;
              end;
              //
              if LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString) <> '' then
              begin
                spdNFeDataSets.Campo('CRT_C21').Value      := LimpaNumero(ibDAtaset13.FieldByname('CRT').AsString); // 1 - Simples nacional 2 - Simples Nacional excesso 3 - Regime normal
              end else
              begin
                spdNFeDataSets.Campo('CRT_C21').Value      := '1'; // 1 - Simples nacional 2 - Simples Nacional excesso 3 - Regime normal
              end;
              //
              if Form1.sVersaoLayout = '4.00' then
              begin
                spdNFeDataSets.Campo('versao_A02').Value  := '4.00'; // Verso do Layout que est utilizando
              end else
              begin
                spdNFeDataSets.Campo('versao_A02').Value  := '3.10'; // Verso do Layout que est utilizando
              end;
              //
              try
                spdNFeDataSets.Salvar; // Salva DataSets e Converte em XML montando um LOTE de XMLS a ser assinados
              except
                on E: Exception do
                begin
                  //
                  Application.MessageBox(pChar(E.Message+chr(10)+
                  chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                  ),'Ateno',mb_Ok + MB_ICONWARNING);
                  //
                  Form7.ibDataset15.Edit;
                  Form7.ibDataSet15STATUS.AsString    := 'Erro: Ao salvar XML.';
                  Abort;
                  //
                end;
              end;
              //
              // Assinando
              //
              try
                //
                Form7.Panel7.Caption          := 'Fechando arquivo XML...'+replicate(' ',100);
                Form7.Panel7.Repaint;
                fNFe := spdNFeDataSets.LoteNFe.GetText;  //Copia XML que est Componente p/ Field fNFe
                //
              except
                //
        //        ShowMessage(fNFe);
                //
                Form7.ibDataset15.Edit;
                Form7.ibDataSet15STATUS.AsString    := 'Erro: No XML';
                Form7.ibDataset15.Post;
                Form7.ibDataset15.Edit;
                Abort;
                //
              end;
              //
              // Permite alterar quaquer coisa na nfe modo DBUG
              //
              sLote := ibDataSet15.FieldByname('NUMERONF').AsString;
              //
              if Form1.sModoDbug = 'S0S' then
              begin
                //
                AssignFile(F,pChar(Form1.sAtual+'\dbug.txt'));  // Direciona o arquivo F para EXPORTA.TXT
                Rewrite(F);
                Writeln(F,fNFe);
                CloseFile(F);
                //
                ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\dbug.txt'),'','', SW_SHOWMAXIMIZED);
                ShowMessage('Tecle Ok para continuar');
                //
                if FileExists(pChar(Form1.sAtual+'\dbug.txt')) then
                begin
                  //
                  _file := TStringList.Create;
                  _file.LoadFromFile(pChar(Form1.sAtual+'\dbug.txt'));
                  //
                  fNFe := _File.Text;
                  //
                end;
                //
              end;
              *)
              sLote := Form7.ibDataSet15.FieldByName('NUMERONF').AsString;
              fNFe := GeraXmlNFe;//(False);
              //
              // Fim da gerao do XML
              //

              //
              // Assinando
              //
  //       ShowMessage(fNFe);
              try
                //
                fNFe := spdNFe.AssinarNota(fNFe);
                Screen.Cursor            := crHourGlass;
                //
              except
                //
                Form7.ibDataset15.Edit;
                Form7.ibDataSet15STATUS.AsString    := 'Erro ao assinar NFE';
                Form7.ibDataset15.Post;
                Form7.ibDataset15.Edit;
  //              Abort;
              end;
              //
              // Transmitindo
              //
              Form7.ibDataset15.Edit;
              Form7.ibDataSet15NFEXML.AsString    := fNFe;
              Form7.ibDataset15.Post;
              //
              if not bContingencia then
              begin
                try
                  Form7.Panel7.Caption          := 'Transmitindo arquivo XML...'+replicate(' ',100);
                  Form7.Panel7.Repaint;
                  sRetorno := spdNFe.EnviarNF(sLote, fNFe);
                  // SHowMEssage(sREtorno);
                  Screen.Cursor            := crHourGlass;
                  //
                  if Pos('<nRec>',sRetorno) <> 0 then
                  begin
                    sRecibo := Copy(sRetorno+'   ',Pos('<nRec>',sRetorno)+6,Pos('</nRec>',sRetorno)-Pos('<nRec>',sRetorno)-6);
                  end else
                  begin
                    ShowMessage(sRetorno);

                    {Sandro Silva 2022-09-13 inicio}
                    // Ocorreu erro
                    //ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos(fNFe, sRetorno);
                    {Sandro Silva 2022-09-13 fim}

                  end;
                  //
                  //             ShowMessage(sRecibo)
                  //
                  // ShowMessage('teste: '+chr(10)+ sRecibo+Chr(10)+IntToStr(Length(sRecibo)));
                  //
                except
                  on E: Exception do
                  begin
                    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao enviar NFe'
                    ),'Ateno',mb_Ok + MB_ICONWARNING);
                  end;
                end;
                //
                // Grava na tabela VENDAS os dados da NF-e
                //
                Form7.Panel7.Caption          := 'Gravando nmero do recibo e arquivo XML...'+replicate(' ',100);
                Form7.Panel7.Repaint;
                //
  //              ShowMessage('Teste'+chr(10)+spdNFeDataSets.Campo('Id_A03').AsString+chr(10)+IntToStr(Length(spdNFeDataSets.Campo('Id_A03').AsString)));
                //
                Form7.ibDataset15.Edit;
                Form7.ibDataSet15NFEID.AsString     := Copy(spdNFeDataSets.Campo('Id_A03').AsString,4,44); // Copia o ID da NFe p/ o Edit
                Form7.ibDataSet15NFERECIBO.AsString := Copy(sRecibo+REplicate(' ',15),1,15);
                //
  //              ShowMessage(Form7.ibDataSet15NFERECIBO.AsString +chr(10)+ sRecibo);
                //
                Form7.ibDataSet15NFEXML.AsString    := fNFe;
                Form7.ibDataSet15MODELO.AsString    := '55';
                //
                if Alltrim(sRecibo) <> '' then
                begin
                  if Copy(Form7.ibDataSet15STATUS.AsString,1,4) <> 'Erro' then Form7.ibDataSet15STATUS.AsString := 'Consulte o recibo desta NF-e'
                end else
                begin
                  //
                  Form7.ibDataSet15STATUS.AsString := 'No foi possvel acessar o servidor da receita.';
                  Form7.N0TestarservidorNFe1Click(Sender);
                  //
                end;
                //
              end else
              begin
                //
        //        Form7.ibDataset15.Edit;
        //        Form7.ibDataSet15NFEID.AsString     := Copy(spdNFeDataSets.Campo('Id_A03').AsString,4,44); // Copia o ID da NFe p/ o Edit
        //        Form7.ibDataset15.Post;
                //
              end;
              //
              // End Transmitindo
              //
            end;
          except end;
          //
          DecimalSeparator := ',';
          DateSeparator    := '/';
          //
          Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
          Form7.Panel7.Repaint;
          //
        end;
        //
        Screen.Cursor            := crDefault;
        //
      end;
    end;
    //
    try
      Form7.ibDataSet14.DisableControls;
      Form7.ibDataSet14.Close;
      Form7.ibDataSet14.SelectSQL.Clear;
      Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
      Form7.ibDataSet14.Open;
      Form7.ibDataSet14.EnableControls;
      Form7.ibDataSet15.EnableControls;
      //
    except end;
  end;
  //
end;


procedure TForm7.N2ConsultarrecibodaNFe1Click(Sender: TObject);
var
  sRetorno, sStatus : String;
  I : Integer;
begin
  //
  if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0) and (Alltrim(Form7.ibDataSet15NFERECIBO.AsString)<>'') then
  begin
    //
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption          := 'Consultando recibo da NF-e...'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    Form7.ibDataSet15.Edit;
    Form7.ibDataset15STATUS.AsString := 'Consultando recibo da NF-e';
    //
    ConfiguraNFE(True);
    Form7.spdNFe.TimeOut                      := 60000*30;
    //
    try
      //
      for I := 1 to 10 do
      begin
        if Pos('<cStat>104</cStat>',sRetorno) = 0 then
        begin
          sRetorno := Form7.spdNFe.ConsultarRecibo(Form7.ibDataSet15NFERECIBO.AsString);
          if Pos('<cStat>104</cStat>',sRetorno) = 0 then sLeep(3000);
        end;
      end;
      //
      // Autorizao de uso
      //
      Form7.ibDataSet15.Edit;
      Form7.ibDAtaSet15RECIBOXML.AsString := sRetorno; // Retorno da NF-e
      //
      sStatus := '';
      while sRetorno <> '' do
      begin
        if copy(sRetorno,1,9)='<xMotivo>' then
        begin
          sStatus  := Copy(sRetorno,10,Pos('</xMotivo>',sRetorno)-10);
          sRetorno := Copy(sRetorno,9,Length(sRetorno)-10);
        end else
        begin
          sRetorno := Copy(sRetorno,2,Length(sRetorno)-1);
        end;
      end;
      //
      //
      Form7.ibDataSet15.Edit;
      Form7.ibDataSet15STATUS.AsString       := sStatus;
      Form7.ibDataSet15.Post;
      Form7.ibDataSet15.Edit;
      //
      if (Pos('<cStat>100</cStat>',Form7.ibDataSet15RECIBOXML.AsString) = 0) and (Pos('<cStat>105</cStat>',Form7.ibDataSet15RECIBOXML.AsString) = 0) then
      begin
        //
        ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos(Form7.ibDataSet15NFEXML.AsString, Form7.ibDataSet15RECIBOXML.AsString);

        Application.MessageBox(pChar(sStatus+chr(10)+
        ItemRejeicao(Form7.ibDataSet15RECIBOXML.AsString, Form7.ibDataSet15NFEXML.AsString)+chr(10)+
        chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
        ),'Ateno',mb_Ok + MB_ICONWARNING);
        //
      end;
      //
    except end;
    //
    DecimalSeparator := ',';
    DateSeparator    := '/';
    //
    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    Screen.Cursor            := crDefault;
    //

  end;
  //
end;

procedure TForm7.N3ConsultarNFe1Click(Sender: TObject);
var
  sRetorno : String;
begin
  //
  try
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      //
      begin
        //
        if Alltrim(Form7.ibDataSet15NFERECIBO.AsString) <> '' then
        begin
          //
          Screen.Cursor            := crHourGlass;
          Form7.Panel7.Caption     := 'Consultando NF-e...'+replicate(' ',100);
          Form7.Panel7.Repaint;
          //
          Form7.ibDataSet15.Edit;
          Form7.ibDataset15STATUS.AsString := 'Consultando NF-e';
          //
          ConfiguraNFE(True);
          Form7.spdNFe.TimeOut                      := 60000*30;
          //
          try
            //
            sRetorno := spdNFe.ConsultarNF(Alltrim(Form7.ibDataSet15NFEID.AsString));
            //
            Form7.ibDataSet15.Edit;
            Form7.ibDataset15STATUS.AsString       := Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
            Form7.ibDataSet15NFEPROTOCOLO.AsString := Copy(sRetorno+'   ',Pos('<nProt>',sRetorno)+7,Pos('</nProt>',sRetorno)-Pos('<nProt>',sRetorno)-7);
            Form7.ibDataSet15.Post;
            Form7.ibDataSet15.Edit;
            //
            if Form7.ibDataSet15NFEPROTOCOLO.AsString <> '' then
            begin
              //
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
              //
              if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
              begin
                Form7.ibDataSet15EMITIDA.AsString := 'S'; // Emitida
                //
              end;
              //
              Form7.ibDataSet15.Post;
              //
              BaixaEstoqueDaNFeAutorizada('');
              //
              Form7.ibDataSet128.active := True;
              //
              if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) <> 'URB' then
              begin
                PegaImpostosDoXML(Form7.ibDataSet15.FieldByName('NUMERONF').AsString);
              end;
              //
              try
                //
                // Relaciona a natureza da operao com o arquivo de vendas
                //
                if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = ''
                then Form7.ibDataSet14.Append
                   else Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                //
                if Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,5) = 'CAIXA' then
                begin
                  //
                  ibDataSet128.Append;
                  //
                  ibDataSet128.FieldByName('DATA').AsDateTime    := Form7.ibDataSet15EMISSAO.AsDateTIme;
                  ibDataSet128.FieldByName('PEDIDO').AsString    := Copy(Form7.ibDataSet15NUMERONF.AsString,4,6);
                  ibDataSet128.FieldByName('CLIFOR').AsString    := Form7.ibDataSet15CLIENTE.AsString;
                  ibDataSet128.FieldByName('VENDEDOR').AsString  := Form7.ibDataSet15VENDEDOR.AsString;
                  //
                  if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '1') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '2') then
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '02 Dinheiro NF-e entrada';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet24TOTAL.AsFloat;
                  end else
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '02 Dinheiro NF-e';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet15TOTAL.AsFloat;
                  end;
                  //
                  ibDataSet128.Post;
                  //
                end;
                //
                if ((Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,7) = 'RECEBER') and (Form7.ibDataSet15TOTAL.AsFloat > 0)) or
                   ((Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,5) = 'PAGAR') and (Form7.ibDataSet24TOTAL.AsFloat > 0)) then
                begin
                  //
                  ibDataSet128.Append;
                  //
                  ibDataSet128.FieldByName('DATA').AsDateTime    := Form7.ibDataSet15EMISSAO.AsDateTIme;
                  ibDataSet128.FieldByName('PEDIDO').AsString    := Copy(Form7.ibDataSet15NUMERONF.AsString,4,6);
                  ibDataSet128.FieldByName('CLIFOR').AsString    := Form7.ibDataSet15CLIENTE.AsString;
                  ibDataSet128.FieldByName('VENDEDOR').AsString  := Form7.ibDataSet15VENDEDOR.AsString;
                  //
                  if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '1') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '2') then
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '04 A prazo NF-e entrada';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet24TOTAL.AsFloat;
                  end else
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '04 A prazo NF-e';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet15TOTAL.AsFloat;
                  end;
                  //
                  ibDataSet128.Post;
                  //
                end;
              except end;
              //
              Form7.ibDataSet128.active := False;
              //
            end;
            //
          except end;
          //
          Screen.Cursor            := crDefault;
          //
        end;
      end;
    end;
    //
    DenegadoOuCancelado(True);
    //
  except end;
  //
  RecuperaXML(True);
  //
  AgendaCommit(True);
  //
  Form7.Close;
  Form7.Show;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.CancelarNFe1Click(Sender: TObject);
var
  sJustificativa : string;
  sRetorno, sStatus : String;
  sEmail : String;
begin
  //
  try
    if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
    begin
      //
      Screen.Cursor            := crHourGlass;
      Form7.Panel7.Caption          := 'Cancelando NF-e...'+replicate(' ',100);
      Form7.Panel7.Repaint;
      //
      ConfiguraNFE(True);
      //
      try
        //
        sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',
        chr(10)+
        'Voc est prestes a cancelar uma NF-e. O DANFE'+chr(10)+
        'referente a esta NF-e se tornar invlido e no'+chr(10)+
        'poder ser utilizado para acompanhar a mercadoria.'+chr(10)+
        chr(10)+
        'Para cancelar a NF-e: '+Form7.ibDataSet15NUMERONF.AsString+' insira uma justificativa (min. 15 caracteres)'+chr(10)+
        chr(10), ''));
        //
        if Length(sJustificativa) >= 15 then
        begin
          //
          // Cancelamento da NF-e por evento.
          //
          try
            sRetorno := spdNFe.CancelarNFeEvento(Form7.ibDataSet15NFEID.AsString,Form7.ibDataSet15NFEPROTOCOLO.AsString,sJustificativa, FormatDateTime('yyyy-mm-dd"T"hh:nn:"00"',Now), 1, Form7.sFuso);
          except end;
          //
          if (Pos('<cStat>135</cStat>',sRetorno) <> 0) or (Pos('<cStat>136</cStat>',sRetorno) <> 0) or FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) then
          begin
            //
            if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet15OPERACAO.AsString then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
            if Form7.ibDataSet14NOME.AsString = Form7.ibDataSet15OPERACAO.AsString then
            begin
              //
              if (Copy(Form7.ibDataSet14CFOP.AsString,2,3) = '929') then
              begin
                try
                  //
                  // Recupera o cupom
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.SQL.Clear;
                  Form7.ibQuery1.SQL.Add('update ALTERACA set VALORICM=Null where VALORICM='+   IntToStr(StrToInt(Form7.ibDataSet15NUMERONF.AsString)) +' ');
                  Form7.ibQuery1.Open;
                  //
                except
                  on E: Exception do
                  begin
                    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+Form7.ibQuery1.SQL.Text),'Ateno',mb_Ok + MB_ICONWARNING);
                  end;
                end;
              end;
            end;
            //
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15STATUS.AsString       := 'NF-e cancelada';
            //
            // Exemplo da funo xmlnodevalue xml node value feita pelo Sandro
            //
            //            Form7.ibDataSet15NFEPROTOCOLO.AsString := xmlNodeValue(sRetorno, '//retEnvEvento/retEvento/infEvento/nProt');
            //
            // No estou gravando para manter o PROTOCOLO original da NFE
            //
            Form7.ibDataSet15EMITIDA.AsString := 'X';
            Form7.ibDataSet15.Post;
            //
            while not FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) do
            begin
              //
              Sleep(100);
              //
            end;
            //
            if FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) then
            begin
              //
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
              Form7.ibDataSet15.Post;
              //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
              //
              if sZiparXML = 'S' then
              begin
                //
                ShellExecute( 0, 'Open','szip.exe', pChar('backup "'+Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml')+'" "'+ Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.zip')+'"'),'', SW_SHOWMAXIMIZED);
                //
                while ConsultaProcesso('szip.exe') do
                begin
                  Application.ProcessMessages;
                  sleep(100);
                end;
                //
                while not FileExists(pChar(Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.zip'))) do
                begin
                  sleep(100);
                end;
                //
                // CopyFile(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.zip')),pChar(Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.zip')),false);
                //
                Unit7.EnviarEMail('',sEmail,'','Cancelamento de NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo o cancelamento sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve'+'.zip') ,False);
                //
              end else
              begin
                //
                Unit7.EnviarEMail('',sEmail,'','Cancelamento de NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo o cancelamento sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)),pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml')),False);
                //
              end;
              //
            end;
            //
            // Este cdigo  so pra homologacao do paf
            //
            try
              //
              if (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) <> 0) or (Copy(Form7.ibDataSet14CFOP.AsString,2,3) = '929') then
              begin
                //
                // No caso de importao de cupom fiscal '929' ou = na integrao nao deve voltar a quantidade no estoque
                // Porque no baixou estoque quando fez a nota.
                //
              end else
              begin
                //
                // Volta a quantidade no estoque
                //
                Form7.ibDataSet16.First;
                while not Form7.ibDataset16.Eof do
                begin
                  //
                  if Form7.ibDataSet16SINCRONIA.AsFloat <> 0 then
                  begin
                    //
                    if AllTrim(Form7.ibDataSet16CODIGO.AsString)<>'' then
                    begin
                      //
                      Form7.ibDataSet4.Close;
                      Form7.ibDataSet4.SelectSQL.Clear;
                      Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
                      Form7.ibDataSet4.Open;
                      //
                      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet16CODIGO.AsString then
                      begin
                        ibDataSet4.Edit;
                        ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat + ibDataSet16SINCRONIA.AsFloat; // Mantem a sincronia
                        ibDataSet4.Post;
                        Form7.sModulo := 'CANCELA';
                        ibDataSet16.Edit;
                        ibDataSet16SINCRONIA.AsFloat   := 0; // Resolvi este problema as 4 da madrugada no NoteBook em casa
                        ibDataSet16.Post;
                        Form7.sModulo := 'VENDA';
                      end;
                      //
                    end;
                  end;
                  //
                  Form7.ibDataset16.Next;
                  //
                end;
              end;
              //
            except
              //
              on E: Exception do
              begin
                Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING);
              end;
              //
            end;
            //
            // Este cdigo altera a quantidade no estoque
            //
            //
            // Este cdigo  so pra homologacao do paf
            //
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'X';
            Form7.ibDataSet15.Post;
            //
            // Receber
            //
            if sModulo = 'VENDA' then
            begin
              //
              Form7.ibDataSet7.First;
              //
              if Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada' then
              begin
                //
                while not Form7.ibDataSet7.Eof do
                begin
                  //
                  if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
                  begin
                    if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
                    begin
                      Form7.ibDataSet7.Edit;
                      Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
                    end else
                    begin
                      Form7.ibDataSet7.Edit;
                      Form7.ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
                    end;
                    //
                    Form7.ibDataSet7ATIVO.AsString := '1';
                    Form7.ibDataSet7.Post;
                    Form7.ibDataSet7.Next;
                    //
                  end else
                  begin
                    Form7.ibDataSet7.Next;
                  end;
                  //
                end;
                //
              end;
            end;
            //
            // CAIXA
            //
            ApagaIntegracaoComOCaixa(True);
            //
            // Relaciona os clientes com o arquivo de vendas
            //
            Form7.ibDataSet2.Close;
            Form7.ibDataSet2.Selectsql.Clear;
            Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
            Form7.ibDataSet2.Open;
            //
            // Data da ltima venda para o cliente
            //
            try
              Form7.ibDataSet2.Edit;
              Form7.ibDataSet2ULTIMACO.AsString := '';
              Form7.ibDataSet2.Post;
            except end;
            //
            commitatudo(True);
            //
            Form7.Close;
            Form7.Show;
            //
          end else
          begin
            //
            sStatus := '';
            while sRetorno <> '' do
            begin
              if copy(sRetorno,1,9)='<xMotivo>' then
              begin
                sStatus  := sStatus + chr(10) + Copy(sRetorno,10,Pos('</xMotivo>',sRetorno)-10);
                sRetorno := Copy(sRetorno,9,Length(sRetorno)-10);
              end else
              begin
                sRetorno := Copy(sRetorno,2,Length(sRetorno)-1);
              end;
            end;
            //
            if Alltrim(sStatus) <> '' then
            begin
              ShowMessage(sStatus);
            end;
            //
          end;
        end else
        begin
          if AllTrim(sJustificativa) <> '' then
          begin
            ShowMessage('A justificativa tem que ter no minimo 15 caracteres.');
          end;
        end;
        //
      except end;
      //
      DecimalSeparator := ',';
      DateSeparator    := '/';
      Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
      Form7.Panel7.Repaint;
      //
    end;
    //
  except end;
  //
  Form7.sModulo := 'VENDA';
  //
  if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
  begin
    Form7.N3ConsultarNFe1Click(Sender);
  end;
  //
  Form7.Close;
  Form7.Show;
  Form7.DBGrid1.SetFocus;
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.N6EnviarNFeConsultareImprimirDANFE1Click(Sender: TObject);
var
  Hora, Min, Seg, cent : Word;
  tInicio : tTime;
begin
  //
  if Form7.sRPS = 'S' then
  begin
    //
    ransmitirNotaFiscaldeServioNFSe1Click(Sender);
    Screen.Cursor            := crDefault;
    //
  end else
  begin
    //
    tInicio := Time;
    //
    if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
    begin
      Form7.ibDataSet15.DisableControls;
      try
        //
        if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
        begin
          //
          if (Length(LimpaNumero(Form7.ibDataSet15NFEID.AsString)) = 44) and (Pos('Duplicidade',Form7.ibDataSet15STATUS.AsString)<>0)then
          begin
            //
            Form7.N3ConsultarNFe1Click(Sender);
            //
          end else
          begin
            //
            Form7.N1EnviarNFe1Click(Sender);
            Screen.Cursor            := crHourGlass;
            Form7.N2ConsultarrecibodaNFe1Click(Sender); Screen.Cursor            := crHourGlass;
            //
            if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') and
               (Copy(Form7.ibDataSet15STATUS.AsString,1,8) <> 'Rejeicao') and
               (Copy(Form7.ibDataSet15STATUS.AsString,1,4) <> 'Erro') then
            begin
              Form7.N3ConsultarNFe1Click(Sender);
            end;
            //
          end;
        end;
        //
        DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
        Form7.Panel7.Hint := 'Tempo para autorizar a NF-e: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0);
        //
        if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
        begin
          try
            Form7.N4ImprimirDANFE1Click(Sender);
            Screen.Cursor  := crHourGlass;
            Form7.N5EnviarDANFEporemail1Click(Sender);
            Screen.Cursor  := crHourGlass;
          except end;
        end;
        //
      except end;
      Form7.ibDataSet15.EnableControls;
    end;
    //
    {Sandro Silva 2022-09-29 inicio
    VVerificaresquemashema1Click(Sender);
    }
    if PermiteValidarSchema(Form7.ibDataSet15) then
      VerificarShemaXsd(Form7.ibDataSet15NFEXML.AsString, False);
    {Sandro Silva 2022-09-29 fim}
    //
    Screen.Cursor            := crDefault;
    //
  end;
  //
end;

procedure TForm7.N0TestarservidorNFe1Click(Sender: TObject);
var
  sStatus, sRetorno : String;
begin
  //
  Screen.Cursor            := crHourGlass;
  //
  ConfiguraNFE(True);
  //
  try
    //
    sRetorno := spdNFe.StatusDoServico;
    //
    if Pos('<cStat>',sRetorno) <> 0 then
    begin
      sStatus := Alltrim(Copy(sRetorno+'   ',Pos('<cStat>',sRetorno)+7,Pos('</cStat>',sRetorno)-Pos('<cStat>',sRetorno)-7));
    end else sStatus := '';
    //
    if sStatus = '109' then
    begin
      //
      Application.MessageBox(pChar(chr(10) +'Aguarde, no  possvel enviar esta NF-e no momento.'+Chr(10)+
      'Servio Paralisado sem Previso.'+Chr(10)+
      chr(10)+
      'OBS: Tente ativar o modo SCAN (Configuraes; Configurao da NF-e; (SCAN) Sistema de Contingncia do Ambiente Nacional). No ligue para o suporte tcnico da Smallsoft por este motivo.'),
      'Ateno',mb_Ok + MB_ICONWARNING);
      //
    end;
    //
    if sStatus = '108' then
    begin
      //
      Application.MessageBox(pChar(chr(10) +'Aguarde, no  possvel enviar esta NF-e no momento.'+Chr(10)+
      'Servio Paralisado Momentaneamente (curto prazo).'+Chr(10)+
      chr(10)+
      'OBS: No ligue para o suporte tcnico da Smallsoft por este motivo.'),
      'Ateno',mb_Ok + MB_ICONWARNING);
      //
    end;
    //
    if sStatus <> '107' then
    begin
      ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
    end else
    begin
      ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
    end;
    //
  except
    //
    on E: Exception do
    begin
      if Pos('CERTIFICADO',Uppercase(e.Message)) <> 0 then
      begin
        //
        Application.MessageBox(
        pChar(
        chr(10) +'Erro:'
        +Chr(10)
        +Chr(10)+E.Message
        +Chr(10)
        +chr(10)+'1 - Verifique se o seu certificado est instalado'
        +chr(10)+'2 - Verifique se o seu certificado est selecionado (Configuraes da NF-e; Selecionar Certificado Digital...)'
        +chr(10)+'3 - Seu certificado pode estar vencido'
        +chr(10)+'4 - Seu certificado pode ser invlido'
        + chr(10)
        +chr(10)+'Certificados recomendados pela Smallsoft'
        +chr(10)+''
        +chr(10)+'1. Certificados SERASA'
        +chr(10)+'    * A1'
        +chr(10)+'    * SmartCard'
        +chr(10)+'    * E-CNPJ'
        +chr(10)+'2. Certificados Certisign A1 e A3'
        +chr(10)+'3. Certificados dos Correios A1 e A3'
        +chr(10)+'4. Certificados A3 PRONOVA ACOS5'
        +chr(10)
        +chr(10)
        +'OBS: No ligue para o suporte tcnico da Smallsoft por este motivo.'),
        'Ateno',mb_Ok + MB_ICONWARNING);
        //
      end else
      begin
        //
        Application.MessageBox(
        pChar(
        chr(10) +'Erro:'
        +Chr(10)
        +Chr(10)+E.Message
        +Chr(10)
        +chr(10) +'No foi possvel acessar o servidor da receita.'
        +Chr(10)
        +chr(10)+'1 - Verifique sua conexo de internet'
        +chr(10)+'2 - Verifique a disponibilidade dos servios (Configuraes da NF-e; Disponibilidade dos Servios)'
        + chr(10)
        + chr(10)
        +'OBS: No ligue para o suporte tcnico da Smallsoft por este motivo.'),
        'Ateno',mb_Ok + MB_ICONWARNING);
        //
      end;
    end;
    //
  end;
  //
  DecimalSeparator := ',';
  DateSeparator    := '/';
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.ransmitirNFe1Click(Sender: TObject);
begin
  bProximas := True;
  while not Form7.ibDataSet15.Eof do
  begin
    Form7.N6EnviarNFeConsultareImprimirDANFE1Click(Sender);
    Form7.ibDataSet15.Next;
  end;
  bProximas := False;
end;

procedure TForm7.N5EnviarDANFEporemail1Click(Sender: TObject);
var
  sLote    : String;
  sEmail   : String;
  sEmail1  : String;
begin
  //
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
  //
  DistribuicaoNFe('XML');
  //
  if ibDataSet2NOME.AsString = ibDataSet15CLIENTE.AsString then
  begin
    if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') then
    begin
      //
      Screen.Cursor            := crHourGlass;
      Form7.Panel7.Caption := 'Imprimindo o DANFE'+replicate(' ',100);
      Form7.Panel7.Repaint;
      //
      ConfiguraNFE(True);
      //
      // Recupera na tabela VENDAS o XML
      //
      fNFE :=  Form7.ibDataSet15NFEXML.AsString;
      //
      // Recupera na tabela VENDAS o XML
      //
      try
        //
        sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
        //
        if Alltrim(Form7.ibDataSet15TRANSPORTA.AsString) = Alltrim(Form7.ibDataSet18NOME.AsString) then
        begin
          sEmail1 := Form7.ibDataSet18EMAIL.AsString; // XML POR EMAIL
        end else
        begin
          sEmail1  := '';
        end;
        //
        if (validaEmail(sEmail)) or (validaEmail(sEmail1)) then
        begin
          //
          if sEnviarDAnfePorEmail = 'S' then
          begin
            //
            while FileExists(pChar('danfe.pdf')) do
            begin
              DeleteFile(pChar('danfe.pdf'));
              Sleep(100);
            end;
            //
            spdNFe.ExportarDanfe(sLote, fNfe, Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm',1,Form1.sAtual+'\danfe.pdf');
            //
            if FileExists(pChar('danfe.pdf')) then
            begin
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','DANFE (Documento Auxiliar da NF-e)',pchar('Segue em anexo seu DANFE em arquivo PDF.'+chr(10)+Form1.sPropaganda),pChar(Form1.sAtual+'\danfe.pdf'),False);
              end;
              if (validaEmail(sEmail1)) then
              begin
                Unit7.EnviarEMail('',sEmail1,'','DANFE (Documento Auxiliar da NF-e)',pchar('Segue em anexo DANFE em arquivo PDF para transportadora.'+chr(10)+Form1.sPropaganda),pChar(Form1.sAtual+'\danfe.pdf'),False);
              end;
            end;
            //
          end;
          //
          if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
          begin
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
            Form7.ibDataSet15.Post;
          end;
          //
          if FileExists(pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml')) then
          begin
            //
            if sZiparXML = 'S' then
            begin
              //
              ShellExecute( 0, 'Open','szip.exe',pChar('backup "'+pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml')+'" "'+pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip')+'"'), '', SW_SHOWMAXIMIZED);
              //
              while ConsultaProcesso('szip.exe') do
              begin
                Application.ProcessMessages;
                sleep(100);
              end;
              //
              while not FileExists(pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip')) do
              begin
                sleep(100);
              end;
              //
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip'),False);
              end;
              //
              if (validaEmail(sEmail1)) then
              begin
                Unit7.EnviarEMail('',sEmail1,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo NF-e em arquivo XML para transportadora.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip'),False);
              end;
              //
            end else
            begin
              //
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'),False);
              end;
              //
              if (validaEmail(sEmail1)) then
              begin
                Unit7.EnviarEMail('',sEmail1,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo NF-e em arquivo XML para transportadora.'+chr(10)+Form1.sPropaganda+
                chr(10)),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'),False);
              end;
              //
            end;
            //
          end;
          //
        end;
        //
      except
        Screen.Cursor            := crDefault;
      end;
      //
      DecimalSeparator := ',';
      DateSeparator    := '/';
      //
      Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
      Form7.Panel7.Repaint;
      Screen.Cursor            := crDefault;
    end;
  end; // else ShowMessage('Cliente no cadastrado');
  //
end;

procedure TForm7.N6VisualizarDANFE1Click(Sender: TObject);
var
  sFormato, sLote : String;
  bTentarVisualizar: Boolean; // Sandro Silva 2023-02-14
begin
  //
  {Sandro Silva 2023-02-14 inicio
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') then
  begin
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption := 'Visualizando o DANFE'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    ConfiguraNFE(True);
    //
    // Recupera na tabela VENDAS o XML
    //
    fNFE :=  Form7.ibDataSet15NFEXML.AsString;

    //
    // Recupera na tabela VENDAS o XML
    //
    if Form7.ibDataSet15EMITIDA.AsString = 'X' then
    begin
      sFormato := Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento;
    end else
    begin
      sFormato := Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm';
    end;
    //
    try
      spdNFe.VisualizarDanfe(sLote, fNFe, sFormato);
    except
      Screen.Cursor            := crDefault;
    end;
    //
    DecimalSeparator := ',';
    DateSeparator    := '/';
    //
    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    Screen.Cursor            := crDefault;
  end;
  //
  }
  bTentarVisualizar := False;
  if sModulo = 'VENDA' then
  begin
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') then
      bTentarVisualizar := True;
  end;

  if sModulo = 'COMPRA' then
  begin
    if Form7.ibDataSet24NFEXML.AsString <> '' then
      bTentarVisualizar := True;
  end;

  //
  //if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') then
  if bTentarVisualizar then
  begin
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption := 'Visualizando o DANFE'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    ConfiguraNFE(True);
    //
    // Recupera na tabela VENDAS o XML
    //
    sFormato := Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm';
    if sModulo = 'VENDA' then
    begin

      fNFE :=  Form7.ibDataSet15NFEXML.AsString;

      //
      // Recupera na tabela VENDAS o XML
      //
      if Form7.ibDataSet15EMITIDA.AsString = 'X' then
      begin
        sFormato := Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento;
      end;
    end;

    if sModulo = 'COMPRA' then
    begin
      fNFE :=  Form7.ibDataSet24NFEXML.AsString;
      Form7.spdNFe.DanfeSettings.LogotipoEmitente := '';
    end;
    //
    try
      spdNFe.VisualizarDanfe(sLote, fNFe, sFormato);
    except
      Screen.Cursor            := crDefault;
    end;
    //
    DecimalSeparator := ',';
    DateSeparator    := '/';
    //
    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    Screen.Cursor            := crDefault;
  end;
  //

end;

procedure TForm7.ibDataset40NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet40.Edit;
  ibDataSet40REGISTRO.AsString  := sProximo;
  //
end;

procedure TForm7.ibDataset40BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENSETI,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
{
  if Column.FieldName = 'DOCUMENTO' then
  begin
    DBGrid1.Canvas.FillRect(Rect);
    if ibDataSet7ATIVO.AsString='1' then DrawFrameControl(DBGrid1.Canvas.Handle,Rect,DFC_BUTTON, DFCS_BUTTONCHECK or DFCS_CHECKED) else DrawFrameControl(DBGrid1.Canvas.Handle,Rect,DFC_BUTTON, DFCS_BUTTONCHECK or DFCS_FLAT);
  end;
}
end;

procedure TForm7.GerarNFedeentrada1Click(Sender: TObject);
var
  sSerie : String;
begin
  //
  try
    //
    Screen.Cursor            := crHourGlass;
    sSerie := Copy(Form7.ibDAtaSet24NUMERONF.AsString,10,3);
    //
    Form7.ibDataSet15.Close;
    Form7.ibDataSet15.SelectSQL.Clear;
    Form7.ibDataSet15.SelectSQL.Add('select * from VENDAS where NUMERONF like '+QuotedStr('%'+sSerie)+ ' order by NUMERONF');
    Form7.ibDataSet15.Open;
    Form7.ibDataSet15.Last;
    //
    if Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) = Right(StrZero(StrToInt('0'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9))+1,9,0),9) then
    begin
      //
      Form7.sTitulo := 'Notas fiscais de sada (vendas) srie '+sSerie;
      Form7.ibDataSet15.Append;
      Form7.ibDataSet15.Edit; Form7.ibDataSet15NUMERONF.AsString := Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) + sSerie;
      Form7.ibDataSet15.Edit; Form7.ibDataSet15CLIENTE.AsString  := Form7.ibDataSet24FORNECEDOR.AsString;
      Form7.ibDataSet15.Edit; Form7.ibDataSet15OPERACAO.AsString := Form7.ibDataSet24OPERACAO.AsString;
      //
      if AllTrim(Form7.ibDataSet24FRETE12.AsString) <> '' then
      begin
        Form7.ibDataSet15.Edit; Form7.ibDataSet15FRETE12.AsString  := Form7.ibDataSet24FRETE12.AsString;
      end else
      begin
        Form7.ibDataSet15.Edit; Form7.ibDataSet15FRETE12.AsString  := '0';
      end;
      //
      Form7.ibDataSet15.Edit; Form7.ibDataSet15COMPLEMENTO.AsString := 'ENTRADA';
      Form7.ibDataSet15.Edit; Form7.ibDataSet15EMITIDA.AsString     := 'E';
      //
      Form7.ibDataSet15.Post;
      //
      ShowMessage('Nota fiscal de entrada gerada com sucesso.');
      //
    end else
    begin
      ShowMessage('Nota Fiscal fora de sequncia.');
    end;
    //
  except end;
  //
  Form7.sModulo := 'COMPRA';
  Screen.Cursor            := crDefault;
  //
  //
end;

procedure TForm7.N9ImprimirDANFEemformulriodecontingncia1Click(
  Sender: TObject);
var
  bPode : Boolean;
//  bButton : Integer;
//  sRetorno : String;
begin
  //
  ConfiguraNFE(True);
  //
{
  bPode := False;
  //
  try
    sRetorno := spdNFe.StatusDoServico;
    if Copy(sRetorno+'   ',Pos('<cStat>',sRetorno)+7,3) <> '107' then
    begin
      ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
      bPode := True;
    end else
    begin
      ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
      ShowMessage('No  necessrio imprimir DANFE em formulrio de segurana, o servidor est ativo.');
    end;
    //
  except
    bPode := True;
  end;
}
  bPode := True;
  //
  if bPode then
  begin
    //
    Form7.ibDataSet15.DisableControls;
    try
      //
      if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') then
      begin
        //
        begin
          //
          bContingencia := True;
          Form7.N1EnviarNFe1Click(Sender);
          Form7.N4ImprimirDANFE1Click(Sender); Screen.Cursor := crHourGlass;
          //
          if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
          begin
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'S';
            Form7.ibDataSet15.Post;
          end;
          //
          BaixaEstoqueDaNFeAutorizada('');
          //
          bContingencia := False;
          //
        end;
      end else
      begin
        ShowMessage('NF-e j foi enviada.');
      end;
      //
    except end;
    //
    Form7.ibDataSet15.EnableControls;
    //
  end;
  //
  DecimalSeparator := ',';
  DateSeparator    := '/';
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.Agrupar1Click(Sender: TObject);
begin
  //
  //
  Form1.Panel4.Visible := False;
  //
  Form1.SQLMododecomando1Click(Sender);
  //
  if Pos('ORDER BY',UpperCase(Form7.TabelaAberta.SelectSQL.Text))<> 0 then
  begin
    Form1.Edit200.Text := Copy(Form7.TabelaAberta.SelectSQL.Text,1,Pos('ORDER BY',UpperCase(Form7.TabelaAberta.SelectSQL.Text))-1);
  end else
  begin
    Form1.Edit200.Text := Form7.TabelaAberta.SelectSQL.Text;
  end;
  //
  Form1.Edit200.Text := StrTran(Form1.Edit200.Text,'*',' '+Form7.DBGrid1.SelectedField.FieldName+' as "'+Form7.DBGrid1.SelectedField.DisplayName+'", count('+QuotedStr(Form7.DBGrid1.SelectedField.FieldName)+')as "Ocorrncias"')+' group by '+Form7.DBGrid1.SelectedField.FieldName+' order by "Ocorrncias"' ;
  FechaTudo(Form1.bFechaTudo);
  //
end;

procedure TForm7.ExportarNFesemarquivoXML1Click(Sender: TObject);
var
  bTem   : Boolean;
  sEmail  : string;
  Mais1Ini : tIniFile;
  SearchRec : tSearchREC;
  Encontrou  : Integer;
begin
  //
  // Form s para pedir o perodo e o e-mail do contador.
  //
  Form28.ShowModal;
  //
  if Form28.DateTimePicker1.Date <> StrToDate('01/01/1998') then
  begin
    //
    if ValidaEmail(Form28.Edit1.Text) then
    begin
      //
      Form7.Close;
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
      Mais1Ini.WriteString('XML','e-mail contabilidade',AllTrim(Form28.Edit1.Text));
      Mais1Ini.WriteString('XML','Periodo Inicial',DateToStr(Form28.DateTimePicker1.Date));
      Mais1Ini.WriteString('XML','Periodo Final',DateToStr(Form28.DateTimePicker2.Date));
      Mais1ini.Free;
      //
      Form7.ibDataSet15.Close;
      Form7.ibDataSet15.SelectSql.Clear;
//
//      Form7.ibDataSet15.Selectsql.Add('select * from VENDAS where EMISSAO<='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker2.Date))+
//      ' and EMISSAO>='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker1.Date))+' and coalesce(NFERECIBO,'''')<>'''' order by EMISSAO, NUMERONF');
//      Form7.ibDataset15.Open;
//
      //
      Form7.ibDataSet15.Selectsql.Add('select * from VENDAS where EMISSAO<='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker2.Date))+
      ' and EMISSAO>='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker1.Date))+' order by EMISSAO, NUMERONF');
      //
      Form7.ibDataset15.Open;
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
      sEmail := Alltrim(Mais1Ini.ReadString('XML','e-mail contabilidade',''));
      Mais1ini.Free;
      //
      // Apaga todos os arquivos .XML da pasta CONTABIL
      //
      FindFirst(Form1.sAtual+'\CONTABIL\*.xml', faAnyFile, SearchRec);
      Encontrou :=0;
      while Encontrou = 0 do
      begin
        DeleteFile(pChar(Form1.sAtual+'\CONTABIL\'+Searchrec.Name));
        Encontrou := FindNext(SearchRec);
      end;
      //
      bTem := False;
      //
      // NFE e CANCELADAS
      //
      Form7.ibDataSet15.First;
      while not Form7.ibDataSet15.Eof do
      begin
        DistribuicaoNFe('CONTABIL');
        Form7.ibDataSet15.Next;
        bTem := True;
      end;
      //
      // INUTILIZADAS
      //
      Form7.IBQuery99.Close;
      Form7.IBQuery99.SQL.Clear;
      Form7.IBQuery99.SQL.Add('select XML, DATA, REGISTRO from INUTILIZACAO where DATA<='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker2.Date))+
      ' and DATA>='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker1.Date))+' order by DATA');
      Form7.IBQuery99.Open;
      //
      Form7.IBQuery99.First;
      while not Form7.IBQuery99.Eof do
      begin
        DistribuicaoNFeINUTILIZADA('CONTABIL');
        Form7.IBQuery99.Next;
        bTem := True;
      end;
      //
      //
      if bTem then
      begin
        //
        // Apaga o ZIP anterior
        //
        while FileExists(pChar(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'.zip')) do
        begin
          DeleteFile(pChar(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'.zip'));
          Sleep(1000);
        end;
        //
        ShellExecute( 0, 'Open','szip.exe',pChar('backup "'+Alltrim(Form1.sAtual + '\CONTABIL\*.xml')+'" "'+Alltrim(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'.zip')+'"'), '', SW_SHOWMAXIMIZED);
        //
        while ConsultaProcesso('szip.exe') do
        begin
          Application.ProcessMessages;
          sleep(100);
        end;
        //
        while not FileExists(pChar(Form1.sAtual+'\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'.zip')) do
        begin
          sleep(100);
        end;
        //
        // Apaga todos os arquivos .XML da pasta CONTABIL
        //
        FindFirst(Form1.sAtual+'\CONTABIL\*.xml', faAnyFile, SearchRec);
        Encontrou :=0;
        while Encontrou = 0 do
        begin
          DeleteFile(pChar(Form1.sAtual+'\CONTABIL\'+Searchrec.Name));
          Encontrou := FindNext(SearchRec);
        end;
        //
        Unit7.EnviarEMail('',Form28.Edit1.Text,'','NF-es (Notas Fiscais Eletrnicas)',
          pchar('Segue em anexo arquivo zipado com as NF-es de sada da empresa '+AllTrim(Form7.ibDataSet13NOME.AsString)+'.'
          +' Perodo de '+DateToStr(Form28.DateTimePicker1.Date)+' at '+DateToStr(Form28.DateTimePicker2.Date)+'.'
          +chr(10)
          +Form1.sPropaganda)
          ,pChar(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'.zip'),False);
        //
      end else
      begin
        ShowMessage('No encontrado XML para contabilidade neste perodo.');
      end;
    end;
  end;
  //
  try
    Form7.Close;
    Form7.ShowModal;
  except end;  
  //
end;

procedure TForm7.ibDataSet4ULT_VENDASetText(Sender: TField;
  const Text: String);
begin
  Application.MessageBox(Pchar('Esta data no pode ser alterada manualmente. Por estar diretamente'+ Chr(10) +
                                        'relacionada a relatrios de venda.' + Chr(10))
                                         ,'Ateno',mb_Ok);
end;

procedure TForm7.XConsultarcadastro1Click(Sender: TObject);
var
  sRetorno : String;
begin
  //
  Screen.Cursor            := crHourGlass;
  //
  try
    sRetorno := Form7.spdNFe.ConsultarCadastro(LimpaNumero(Form7.ibDataSet13CGC.AsString),'CNPJ',Form7.ibDataSet13ESTADO.AsString);
    sRetorno := Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
  except
    if Form1.bHomologacao then
    begin
      ShowMessage('O Servio no esta disponvel no web service, ou o endereo no est configurado no arquivo '+Pchar(Form1.sAtual+'\NFE\nfeServidoresHom.ini'));
    end else
    begin
      ShowMessage('O Servio no esta disponvel no web service, ou o endereo no est configurado no arquivo '+Pchar(Form1.sAtual+'\NFE\nfeServidoresProd.ini'));
    end;
  end;
  //
  ShowMessage(sRetorno);
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.vendasparaClick(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form38.Label21.Caption := Form7.ibDataSet2NOME.AsString;
  Form38.Label21.Visible := True;
  Form7.sModulo := 'Vendas para';
  Form38.ShowModal; // Ok
  Form38.Label21.Visible := False;
  //
end;

procedure TForm7.Ca1Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  //
  if Form7.sModulo = 'ESTOQUE' then
  begin
    Form7.Caption := 'Catlogo de produtos';
    { L as configuraes no .INF }
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    { -- Mais1Ini.WriteString(Mais.sEscolhido,'L'+alltrim(IntToStr(I)), -- }
    Form39.CheckBox4.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo1','7'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00') +'%';
    Form39.CheckBox5.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo2','14'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00') +'%';
    Form39.CheckBox6.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo3','21'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00') +'%';
    //
    Form39.Label1.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00');
    Form39.Label2.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00');
    Form39.Label3.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00');
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    //
    Form39.Height := 80;
    //
  end;
  Form9.Show;
  Form14.Caption := 'Assistente para catlogo de produtos';
  Form14.Show;
  //
  // Form39.Show;
  //
end;

procedure TForm7.lbumdefotografias1Click(Sender: TObject);
begin
  //
  Form7.Caption := 'lbum de fotografias';
  Form14.Caption := 'Assistente para lbum de fotografias';
  Form9.Show;
  Form14.Show;
  //
  // Form39.Show;
  //
end;

procedure TForm7.SPEDFiscal1Click(Sender: TObject);
begin

  if not FileExists(Form1.sAtual+'\sped.exe') then ShellExecute( 0, 'Open', 'sped_setup.exe', '', '', SW_SHOW);

  if FileExists(Form1.sAtual+'\sped.exe') then
    ShellExecute( 0, 'Open', 'sped.exe', '', '', SW_SHOW) else
      ShowMessage('O executvel sped.exe no foi encontrado na pasta de instalao do programa.');

end;

procedure TForm7.ibDataSet8DOCUMENTOSetText(Sender: TField;
  const Text: String);
begin
  Form7.ibDataSet8DOCUMENTO.AsString := AllTrim(Text);
end;

procedure TForm7.SMALL_DBEdit2Change(Sender: TObject);
begin
  if Form7.sModulo = 'RECEBER' then
  begin
    if Form7.ibDataSet7ATIVO.AsFloat >= 5 then
    begin
      Edit2.Text := SMALL_DBEdit2.Text;
      Form7.SMALL_DBEdit1.Visible := True;
    end else
    begin
      Edit2.Text := '';
      Form7.SMALL_DBEdit1.Visible := False;
    end;
  end else
  begin
    if Form7.ibDataSet8ATIVO.AsFloat >= 5 then
    begin
      Edit2.Text := SMALL_DBEdit2.Text;
      Form7.SMALL_DBEdit1.Visible := True;
    end else
    begin
      Edit2.Text := '';
      Form7.SMALL_DBEdit1.Visible := False;
    end;
  end;
end;

procedure TForm7.Edit2KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
  bAchou : Boolean;
begin
  //
  if (Key = Vk_Return) or (Key = Vk_Tab) then
  begin
    //
    if Alltrim(Edit2.Text) <> '' then
    begin
      //
      if Form7.sModulo = 'PAGAR' then
      begin
        //
        bAchou := Form7.ibDataSet8.Locate('DOCUMENTO',Edit2.Text,[]);
        //
        if not bAchou then
        begin
          //
          Form7.IBQuery99.Close;
          Form7.IBQuery99.SQL.Clear;
          Form7.IBQuery99.SQL.Add('select DOCUMENTO from PAGAR where DOCUMENTO like '+QuotedStr('%'+Edit2.Text+'%')+' and  coalesce(VALOR_PAGO,0)=0 ');
          Form7.IBQuery99.Open;
          //
          if AllTrim(Form7.IBQuery99.FieldByname('DOCUMENTO').AsString) <> '' then
          begin
            Edit2.Text := Form7.IBQuery99.FieldByname('DOCUMENTO').AsString;
            bAchou := Form7.ibDataSet8.Locate('DOCUMENTO',Edit2.Text,[]);
          end;
        end;
        //
        if bAchou then
        begin
          //
          if Form7.ibDataSet8ATIVO.AsFloat < 5 then
          begin
            //
            if Form7.ibDataSet8VALOR_PAGO.AsFloat = 0 then
            begin
              //
              Form7.SMALL_DBEdit1.Visible := True;
              Form7.Edit2.Text        := Form7.SMALL_DBEdit2.Text;
              //
              Form7.ibDataSet8.Edit;
              if Form7.ibDataSet8ATIVO.AsFloat < 5 then
              begin
                //
                Form7.ibDataSet8ATIVO.AsFloat := Form7.ibDataSet8ATIVO.AsFloat + 5;
                Form7.ibDataSet8VALOR_PAGO.AsFloat := Form7.ibDataSet8VALOR_DUPL.AsFloat;
                //
              end;
              //
              Form7.ibDataSet8.Post;
              //
              Form1.IBDataSet200.Close;
              Form1.IBDataSet200.Open;
              //
              Form7.ibQuery1.Close;
              Form7.IBQuery1.SQL.Clear;
              Form7.IBQuery1.SQL.Add('select sum(VALOR_PAGO) from PAGAR where ATIVO >= 5');
              Form7.IBQuery1.Open;
              //
              Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
              Form7.Panel10.Repaint;
              //
              SMALL_DBEdit1.SetFocus;
              //
            end else
            begin
              //
              Edit2.Text := '';
              Edit2.SetFocus;
              ShowMessage('Documento j foi pago');
              //
            end;
            //
          end else
          begin
            Edit2.SetFocus;
            ShowMessage('Documento j foi selecionado');
          end;
          //
        end else
        begin
          //
          Edit2.Text := '';
          Edit2.SetFocus;
          ShowMessage('Documento j foi quitado');
          //
        end;
      end else
      begin
        //
        bAchou := Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Edit2.Text),[]);
        //
        if not bAchou then
        begin
          //
          Form7.IBQuery99.Close;
          Form7.IBQuery99.SQL.Clear;
          Form7.IBQuery99.SQL.Add('select DOCUMENTO from RECEBER where DOCUMENTO like '+QuotedStr('%'+Edit2.Text+'%')+'  and coalesce(VALOR_RECE,0)=0 ');
          Form7.IBQuery99.Open;
          //
          if AllTrim(Form7.IBQuery99.FieldByname('DOCUMENTO').AsString) <> '' then
          begin
            Edit2.Text := Form7.IBQuery99.FieldByname('DOCUMENTO').AsString;
            bAchou := Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Edit2.Text),[]);
          end;
        end;
        //
        if bAchou then
        begin
          //
          if Form7.ibDataSet7ATIVO.AsFloat < 5 then
          begin
            //
            if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
            begin
              //
              Form7.SMALL_DBEdit1.Visible := True;
              Form7.Edit2.Text        := Form7.SMALL_DBEdit2.Text;
              //
              Form7.ibDataSet7.Edit;
              if Form7.ibDataSet7ATIVO.AsFloat < 5 then
              begin
                //
                Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
                Form7.ibDataSet7VALOR_RECE.AsFloat := Form7.ibDataSet7VALOR_DUPL.AsFloat;
                //
              end;
              //
              Form7.ibDataSet7.Post;
              //
              Form1.IBDataSet200.Close;
              Form1.IBDataSet200.Open;
              //
              Form7.ibQuery1.Close;
              Form7.IBQuery1.SQL.Clear;
              Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
              Form7.IBQuery1.Open;
              //
              Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
              Form7.Panel10.Repaint;
              //
              SMALL_DBEdit1.SetFocus;
              //
            end else
            begin
              Edit2.Text := '';
              Edit2.SetFocus;
              ShowMessage('Documento j foi pago');
            end;
            //
          end else
          begin
            Edit2.Text := '';
            Edit2.SetFocus;
            ShowMessage('Documento j foi selecionado');
          end;
          //
        end else
        begin
          Edit2.SetFocus;
          ShowMessage('Documento no encontrado......');
        end;
      end;
    end else
    begin
      SMALL_DBEdit6.SetFocus;
    end;
  end;
end;

procedure TForm7.SMALL_DBEdit1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = Vk_Return) or (Key = Vk_Tab) then
  begin
    //
    if (Form7.ibDataset7.State in ([dsEdit, dsInsert])) then Form7.ibDataset7.Post;
//    Form7.ibDataSet7.Post;
    Form7.ibDataSet7.Edit;
    //
    Form1.IBDataSet200.Close;
    Form1.IBDataSet200.Open;
    //
    CalculaTotalRecebido(True);
    Form7.Edit2.SetFocus;
    // 
  end;
end;

procedure TForm7.DBGrid3KeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if Form7.sModulo = 'PAGAR' then
  begin
    Form7.ibDataSet8.Locate('REGISTRO',Form1.IBDataSet200.FieldByname('REGISTRO').AsString,[]);
  end;
  if Form7.sModulo = 'RECEBER' then
  begin
    Form7.ibDataSet7.Locate('REGISTRO',Form1.IBDataSet200.FieldByname('REGISTRO').AsString,[]);
  end;
end;

procedure TForm7.SMALL_DBEdit6Exit(Sender: TObject);
var
  ftotal : Real;
begin
  //
  CalculaTotalRecebido(True);
  fTotal := StrToFloat(LimpaNumeroDeixandoAVirgula(Form7.Label49.CAption));
  //
  ComboBox2.Items.Clear;
  ComboBox2.Items.Add('<Plano de contas para a diferena>');
  ComboBox2.ItemIndex := 0;
  //
  Form7.ibDataSet12.Close;
  Form7.ibDataSet12.SelectSQL.Clear;
  Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
  Form7.ibDataSet12.Open;
  //
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.Eof do
  begin
    if Form7.sModulo = 'RECEBER' then
    begin
      //
      if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal then
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '1' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end else
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '3' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end;
      //
      Edit1.Text := 'Recebimentos';
      //
    end;
    if Form7.sModulo = 'PAGAR' then
    begin
      if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal then
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '3' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end else
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '1' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end;
      //
      Edit1.Text := 'Pagamentos';
      //
    end;
    Form7.ibDataSet12.Next;
  end;
  //
  if Form7.ibDataSet25DIFERENCA_.AsFloat <> fTotal then
  begin
    ComboBox2.Enabled := True;
  end else
  begin
    ComboBox2.Enabled := False;
  end;
  //
  if Form7.ComboBox1.CanFocus then Form7.ComboBox1.SetFocus;
  //
end;

procedure TForm7.SMALL_DBEdit1Exit(Sender: TObject);
begin
  Form7.SMALL_DBEdit1.Visible := False;
  Form7.Edit2.Text        := '';
end;

procedure TForm7.SMALL_DBEdit6KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  //
  if (Key = Vk_Return) or (Key = Vk_Tab) then
  begin
    Button7Click(Sender);
  end;
  //
end;

procedure TForm7.Romaneiodecarga1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Romaneio de carga';
  Form38.ShowModal; // Ok
end;

procedure TForm7.ConsultarvalidadedaNFe1Click(Sender: TObject);
var
  sUf, sRetorno, sNota : String;
begin
  //
  // DANFE da minha Harley
  // 41100504072870001794550010000025129999974873
  //
  sUF := UpperCase(AllTrim(Form1.Small_InputForm('Consultar validade da NF-e','UF do Emitente da NF-e:',''))); // Nf de venda
  //
  if Pos('1'+UpperCase(sUF)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX212') = 0 then
  begin
    ShowMessage('Estado invlido');
    Abort;
  end;
  //
  sNota := AllTrim(Form1.Small_InputForm('Consultar validade da NF-e','Chave de acesso da NF-e:','')); // Nf de venda
  //
  if Length(AllTrim(LimpaNumero(sNota))) = 44 then
  begin
    //
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption          := 'Consultando NF-e...'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    ConfiguraNFE(True);
    //
    Form7.spdNFe.UF       := sUF;
    //
    // Form7.spdNFe.Ambiente := akProducao;
    //
    try
      //
      sRetorno := spdNFe.ConsultarNF(Alltrim(sNota));
      //
      ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
      //
    except end;
    //
  end else
  begin
    ShowMessage('Chave de acesso da NF-e invlido');
  end;
  //
  Screen.Cursor            := crDefault;
  DecimalSeparator := ',';
  DateSeparator    := '/';
  Form7.Panel7.Caption  := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
  Form7.Panel7.Repaint;
  //
end;

procedure TForm7.ibDataSet16BeforePost(DataSet: TDataSet);
begin
  //
  if Form7.ibDataSet16.Modified then
    Form7.ibDataSet16.Tag := 1
  else
    Form7.ibDataSet16.Tag := 0;
  //
  if Form7.ibDataSet15FINNFE.AsString <> '4' then // Devolucao Devoluco
  begin
    try
      if (Copy(Form7.ibDataSet14CFOP.AsString,1,4) = '5101') or (Copy(Form7.ibDataSet14CFOP.AsString,1,4) = '6101') or (Pos('IPI',Form7.ibDataSet14OBS.AsString) <> 0) then
      begin
        //
        if Form7.ibDataSet16IPI.AsFloAt <> Form7.ibDataSet4IPI.AsFloat then
        begin
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16IPI.AsFloAt := Form7.ibDataSet4IPI.AsFloat;
        end;
        //
      end else
      begin
        if Form7.ibDataSet16IPI.AsFloAt <> 0 then
        begin
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16IPI.AsFloAt := 0;
        end;
      end;
    except end;
  end;

  //
  AssinaRegistro('ITENS001',DataSet, True);
  //
end;

procedure TForm7.GerarNotaFiscalSrie12Click(Sender: TObject);
begin
  //
  // Gera a nota fiscal
  //
  if Form1.bNotaVendaLiberada then
  begin
    //
    if Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString = '' then
    begin
      //
      Form41.MaskEdit1.Text := Form7.ibDataSet97.FieldByname('Oramento').AsString;
      Form7.Close;
      Form7.Vendas_1Click(Sender);                        // Nota fiscal srie 001
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.Importaroramentos1Click(Sender);             // Importa OS
      //
    end;
  end else
  begin
    ShowMessage('Emisso de NF no liberada para este usurio.');
  end;
  //
end;

procedure TForm7.GerarNotaFiscalSrie22Click(Sender: TObject);
begin
  //
  // Gera a nota fiscal
  //
  if Form1.bNotaVendaLiberada then
  begin
    //
    if Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString = '' then
    begin
      //
      Form41.MaskEdit1.Text := Form7.ibDataSet97.FieldByname('Oramento').AsString;
      Form7.Close;
      Form7.NotasfiscaisdesadavendasSrie11Click(Sender);  // Nota fiscal srie 002
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.Importaroramentos1Click(Sender);             // Importa OS
      //
    end;
  end else
  begin
    ShowMessage('Emisso de NF no liberada para este usurio.');
  end;
  //

end;

procedure TForm7.Relatriodeoramentospendentes2Click(Sender: TObject);
begin
  Form7.Relatriodeoramentospendentes1Click(Sender);
end;

procedure TForm7.ibDataSet27BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('ALTERACA',DataSet, True);
end;

procedure TForm7.ibDataSet37BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('ORCAMENT',DataSet, True);
end;

procedure TForm7.VVerificaresquemashema1Click(Sender: TObject);
{Sandro Silva 2022-09-29 inicio 
var
  DOMDocument : IXMLDOMDocument3;
  ParseError  : IXMLDOMParseError;
  Schema      : XMLSchemaCache;
  sErro, sMErro, sVersaoManual : String;
  rcpNFExml   : tStringList;
  DOMDocumentNFe: IXMLDOMDocument;
  xNodeNFe: IXMLDOMNodeList;
}
begin
  //
  Screen.Cursor := crHourGlass;
  //
  // Protocolo
  //
  (*{Sandro Silva 2022-09-29 inicio}
  if PermiteValidarSchema(Form7.ibDataSet15) then // Ficha 6275 Sandro Silva 2022-09-28 if Pos('Falha no Schema',Form7.ibDataSet15STATUS.AsString)<> 0 then
  begin
    //
    // Validar Shema
    //
    try
      //
      DOMDocument := CoDOMDocument50.Create;
      //
      DOMdocument.Async := False;
      DOMdocument.ResolveExternals := False;
      DOMdocument.ValidateOnParse  := True;
      //
      // Carrega s uma parte do XML
      //
      XMLDocument1.Active := false;
      XMLDocument1.XML.Text := Form7.IbDAtaSet15NFEXML.AsString;
      XMLDocument1.Active := True;
      rcpNFExml := TStringList.Create;
      // Sandro Silva 2022-09-28 rcpNFExml.Text := XMLDocument1.ChildNodes['NFe'].XML;
      DOMDocumentNFe := CoDOMDocument.Create; // Precisa ser criado com est herana para no ocorrer erro na linha DOMDocumentNFe.selectNodes('//NFe');
      DOMDocumentNFe.loadXML(Form7.IbDAtaSet15NFEXML.AsString);

      xNodeNFe := DOMDocumentNFe.selectNodes('//NFe');
      if xNodeNFe.length > 0 then
      begin
        rcpNFExml.Text := xNodeNFe.item[0].xml;

        DOMdocument.LoadXML(rcpNFExml.Text); //XML COM ERRO
        rcpNFExml.Free;
        //
        Schema := CoXMLSchemaCache50.Create;
        //
        // Verso 2.0 da NFE 4.0 do manual
        //
        {Sandro Silva 2022-09-28 inicio
        spdNFe.VersaoManual := vm50a;
        sVersaoManual := 'vm50a\nfe_v2.00.xsd';
        }
        spdNFe.VersaoManual := vm60;
        sVersaoManual := 'vm60\nfe_v4.00.xsd';
        {Sandro Silva 2022-09-28 fim}
        //
        Schema.add('http://www.portalfiscal.inf.br/nfe', Form1.sAtual+'\Nfe\Esquemas\'+sVersaoManual);
        //
        DOMdocument.Schemas := Schema;
        ParseError          := DOMdocument.validate;
        sErro := '';
        sMErro := '';
        sErro := ParseError.reason; /// retorno da validao
      end;
      DOMDocument         := Nil;
      ParseError          := Nil;
      Schema              := Nil;
      DOMDocumentNFe      := nil;
      xNodeNFe            := nil;
      //
      // Fim valida schema
      //
    except
    end;
  end;
  //
  Screen.Cursor := crDefault;
  try
    if sErro <> '' then
      ShowMessage('Mensagem de erro retornada: '+chr(10)+chr(10)+strTran(sErro,'{http://www.portalfiscal.inf.br/nfe}',''))
  except
  end;
  //
  *)
  if PermiteValidarSchema(Form7.ibDataSet15) then // Ficha 6275 Sandro Silva 2022-09-28 if Pos('Falha no Schema',Form7.ibDataSet15STATUS.AsString)<> 0 then
    VerificarShemaXsd(Form7.ibDataSet15NFEXML.AsString, True); 
  {Sandro Silva 2022-09-29 fim}
end;

procedure TForm7.Importarretornodevendaambulante1Click(Sender: TObject);
begin
  ImportaNF(False,'');
end;

procedure TForm7.ibDataSet24BeforeEdit(DataSet: TDataSet);
begin
  //
  sFornecedorAntigo := Form7.IbDataSet24FORNECEDOR.AsString;
  //
end;

procedure TForm7.ibDataSet4MEDIDASetText(Sender: TField;
  const Text: String);
begin
  //
  if ibDataSet4MEDIDA.AsString <> '' then
  begin
    //
    Form7.IBDataSet49.Close;
    Form7.IBDataSet49.SelectSQL.Clear;
    Form7.IBDataSet49.SelectSQL.Add('select * from MEDIDA order by SIGLA'); // Medida
    Form7.IBDataSet49.Open;
    //
    ibDataSet49.Locate('SIGLA',AllTrim(Text),[loCaseInsensitive, loPartialKey]);
    //
    if AllTrim(Text) = '' then ibDataSet4MEDIDA.AsString := Text else
      if Pos(AnsiUpperCase(AllTrim(Text)),AnsiUpperCase(ibDataSet49.FieldByname('SIGLA').AsString)) <> 0 then ibDataSet4MEDIDA.AsString := ibDataSet49.FieldByname('SIGLA').AsString else
        ShowMessage('Unidade de medida invlida.');
  end else ibDataSet4MEDIDA.AsString := Text;
  //
end;

procedure TForm7.RRecuperaroXMLdestaNFe1Click(Sender: TObject);
//var
  //NodePrim, NodePai, NodeSec: IXMLNode; // Node  um n do XML
begin
  //
  try
    //
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      //
      //    ShowMessage('Recuperando XML da pasta \LOG');
      //
      Form7.ibDataSet15.Edit;
      Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
      Form7.ibDataSet15.Post;
    end;
    //
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      RecuperaXML(True);
    end;
    //
{
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      //
      Form7.OpenDialog1.FileName := '';
      Form7.OpenDialog1.Title    := 'Recuperar XML da NF-e';
      //
      if not Form7.OpenDialog1.Execute then Exit;
      //
      if LowerCase(Right(Form7.OpenDialog1.FileName,4))='.xml' then
      begin
        //
        try
          Form7.XMLDocument1.DOMVendor := GetDOMVendor('Open XML');
          Form7.XMLDocument1.LoadFromFile(Form7.OpenDialog1.FileName);
        except
          Form7.XMLDocument1.DOMVendor := GetDOMVendor('MSXML');
          Form7.XMLDocument1.LoadFromFile(Form7.OpenDialog1.FileName);
        end;
        //
        NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe');
        NodePai  := NodePrim.ChildNodes.FindNode('infNFe');
        NodeSec  := NodePai.ChildNodes.FindNode('emit');
        NodeSec.ChildNodes.First;
        //
        if (LimpaNumero(Form7.ibDataSet13CGC.AsString) = NodeSec.ChildNodes['CNPJ'].Text) then
        begin
          //
          NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe');
          NodePai  := NodePrim.ChildNodes.FindNode('infNFe');
          NodeSec  := NodePai.ChildNodes.FindNode('ide');
          NodeSec.ChildNodes.First;
          //
          if StrZero(StrToInt((NodeSec.ChildNodes['nNF'].Text + NodeSec.ChildNodes['serie'].Text)),7,0) = Form7.ibDAtaSet15NUMERONF.AsString then
          begin
            //
            NodePrim := Form7.XMLDocument1.DocumentElement.ChildNodes.FindNode('NFe');
            NodePai  := NodePrim.ChildNodes.FindNode('infNFe');
            NodeSec  := NodePai.ChildNodes.FindNode('dest');
            NodeSec.ChildNodes.First;
            //
            Form7.ibDataSet2.Close;
            Form7.ibDataSet2.Selectsql.Clear;
            Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
            Form7.ibDataSet2.Open;
            //
            if (LimpaNumero(Form7.ibDataSet2CGC.AsString) = NodeSec.ChildNodes['CNPJ'].Text) then
            begin
              //
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15NFEXML.AsString := Form7.XMLDocument1.XML.Text;
              Form7.ibDataSet15.Post;
            end else
            begin
              ShowMessage('No foi possver recuperar o XML. Esta NF-e no foi emitida para o CNPJ: '+Form7.ibDataSet2CGC.AsString+' foi emitida para o CNPJ: '+ ConverteCpfCgc(NodeSec.ChildNodes['CNPJ'].Text));
            end;
            //
          end else
          begin
            ShowMessage('No foi possver recuperar o XML. Nmero da nota diferente de: '+Form7.ibDAtaSet15NUMERONF.AsString);
          end;
          //
        end else
        begin
          //
          ShowMessage('No foi possver recuperar o XML. Esta NF-e no foi emitida pelo CNPJ: '+Form7.ibDataSet13CGC.AsString);
          //
        end;
        //
      end;
    end;
}
  except end;
  //
end;

procedure TForm7.ExportarNFesfiltradasemarquivoXML1Click(Sender: TObject);
var
  sDirectory : string;
//  Mais1Ini : tIniFile;
begin
  //
//  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
//  sDirectory := Alltrim(Mais1Ini.ReadString('XML','Pasta da contabilidade',''));
  SelectDirectory('Select folder', '', sDirectory);
//  Mais1Ini.WriteString('XML','Pasta da contabilidade',sDirectory);
//  Mais1ini.Free;
  //
  if AllTrim(sDirectory) <> ''  then
  begin
    //
    Form7.ibDataSet15.First;
    while not Form7.ibDataSet15.Eof do
    begin
      DistribuicaoNFe2(sDirectory);
      Form7.ibDataSet15.Next;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet23ICMChange(Sender: TField);
begin
  if Sender.AsFloat >= 100 then Sender.AsFloat := 0;
end;

procedure TForm7.Imprimirrecibo2Click(Sender: TObject);
begin
  Form7.Button6Click(Sender);
end;

procedure TForm7.Imprimirrecibo3Click(Sender: TObject);
begin
  Form7.Button6Click(Sender);
end;

procedure TForm7.ibDataSet4LIVRE4Validate(Sender: TField);
begin
  //
  if Copy(Sender.Text,1,5)='<pIVA' then
  begin
    ShowMessage('Use o campo especfico IVA');
  end;
  //
end;

procedure TForm7.Image205Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
begin
  //
  Form39.Height := 80;
  Form9.Show;
  Form14.Caption := 'Assistente de relatrios';
  Form14.Show;
  //
  if Form7.sModulo = 'ESTOQUE' then
  begin
    { L as configuraes no .INF }
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    { -- Mais1Ini.WriteString(Mais.sEscolhido,'L'+alltrim(IntToStr(I)), -- }
    Form39.CheckBox4.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo1','7'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00') +'%';
    Form39.CheckBox5.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo2','14'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00') +'%';
    Form39.CheckBox6.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo3','21'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00') +'%';
    //
    Form39.Label1.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00');
    Form39.Label2.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00');
    Form39.Label3.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00');
    //
    Form39.CheckBox1.Visible := True;
    Form39.CheckBox2.Visible := True;
    Form39.CheckBox3.Visible := True;
    Form39.CheckBox4.Visible := False;
    Form39.CheckBox5.Visible := False;
    Form39.CheckBox6.Visible := False;
    Form39.Height := 80;
    //
    Form39.Show;
  end;
  //
  if Form7.sModulo = 'CLIENTES' then
  begin
    //
    if not (Form1.iReduzida = 1) then
    begin
      //
      Form39.CheckBox4.Caption := 'Recebido       ';
      Form39.CheckBox5.Caption := 'A receber      ';
      Form39.CheckBox6.Caption := 'Atrasado       ';
      //
      Form39.Label1.Caption := '';
      Form39.Label2.Caption := '';
      Form39.Label3.Caption := '';
      //
      Form39.CheckBox1.Visible := False;
      Form39.CheckBox2.Visible := False;
      Form39.CheckBox3.Visible := False;
      Form39.CheckBox4.Visible := True;
      Form39.CheckBox5.Visible := True;
      Form39.CheckBox6.Visible := True;
      //
      Form39.Show;
    end;
    //
  end;
  //
  if Form7.sModulo = 'FORNECED' then
  begin
    //
    Form39.CheckBox4.Caption := 'Pago           ';
    Form39.CheckBox5.Caption := 'A pagar        ';
    Form39.CheckBox6.Caption := 'Atrasado       ';
    //
    Form39.Label1.Caption := '';
    Form39.Label2.Caption := '';
    Form39.Label3.Caption := '';
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    //
    Form39.Show;
  end;
  //
  if Form7.sModulo = 'RECEBER' then
  begin
    //
    Form39.CheckBox4.Caption := 'Endereo       ';
    Form39.CheckBox5.Caption := 'Cidade         ';
    Form39.CheckBox6.Caption := 'Telefone       ';
    //
    Form39.Label1.Caption := '';
    Form39.Label2.Caption := '';
    Form39.Label3.Caption := '';
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    //
    Form39.Show;
  end;
  //
  Form14.Button1.SetFocus;
  //
end;

procedure TForm7.ibDataSet27BeforeDelete(DataSet: TDataSet);
begin
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_HASH_ALTERACA,-1) from rdb$database');
  ibDataset99.Open;
  //
end;

procedure TForm7.Button6Click(Sender: TObject);
begin
  //
  if Form7.ibDataSet7.FieldByName('VALOR_RECE').AsFloat <> 0 then
  begin
    Form7.fTotalDoRecibo := Form7.ibDataSet7.FieldByName('VALOR_RECE').AsFloat;
    Form7.sReciboProvenienteDe := 'Proveniente: dp. ' + Form7.ibDataSet7.FieldByName('DOCUMENTO').AsString + ', Referente ' + AllTrim(Form7.ibDataSet7.FieldByName('HISTORICO').AsString);
    Form7.sReciboRecebemosDe   := Form7.ibDataSet7.FieldByName('NOME').AsString;
  end else
  begin
    Form7.fTotalDoRecibo       := 0;
    Form7.sReciboProvenienteDe := '';
    Form7.sReciboRecebemosDe   := '';
  end;
  //
  if Form7.fTotalDoRecibo<>0 then Form7.RECIBOClick(Sender) else ShowMessage('No  possvel imprimir o recibo. Valor recebido igual a zero.');
  //
end;

procedure TForm7.Button7Click(Sender: TObject);
var
  ftotal : Real;
begin
  //
  Form7.Edit2.SetFocus;
  //
  CalculaTotalRecebido(True);
  fTotal := StrToFloat(LimpaNumeroDeixandoAVirgula(Form7.Label49.CAption));
  //
  if Form7.sModulo = 'PAGAR' then
  begin
    //
    if Form7.ibDataSet25DIFERENCA_.AsFloat = 0 then
    begin
      Form7.SMALL_DBEdit6.Visible := True;
      ShowMessage('Informe o total pago.');
      Form7.SMALL_DBEdit6.SetFocus;
      Abort;
    end else
    begin
      //
      if AllTrim(ComboBox1.Text) = '' then ComboBox1.Text := '<Dinheiro';
      //
      if (fTotal <> Form7.ibDataSet25DIFERENCA_.AsFloat) and ( Form7.ibDataSet25DIFERENCA_.AsFloat <> 0 ) then
      begin
        //
        if ComboBox2.Text = '<Plano de contas para a diferena>' then
        begin
          ShowMessage('Informe o <Plano de contas para a diferena>.');
          Form7.ComboBox2.SetFocus;
          Abort;
        end;
        //
        Form7.ibDataSet1.Append;
        //
        Form7.ibDataSet1HISTORICO.AsString     := 'Diferena';
        Form7.ibDataSet1NOME.AsString          := ComboBox2.Text;
        //
        Form7.ibDataSet1DATA.AsDateTime        := Date;
        if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal
         then Form7.ibDataSet1SAIDA.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat - fTotal
           else Form7.ibDataSet1ENTRADA.AsFloat := fTotal - Form7.ibDataSet25DIFERENCA_.AsFloat;
        //
        Form7.ibDataSet1.Post;
        //
      end;
      //
      if (Copy(ComboBox1.Text,1,9) <> '<Dinheiro') and (Form7.ibDataSet25DIFERENCA_.AsFloat <> 0) then
      begin
        //
        Form7.ibDataSet1.Append;
        Form7.ibDataSet1HISTORICO.AsString     := Edit1.Text;
        Form7.ibDataSet1NOME.AsString          := ComboBox1.Text;
        Form7.ibDataSet1DATA.AsDateTime        := Date; // A pedido da center
        Form7.ibDataSet1ENTRADA.AsFloat        := Form7.ibDataSet25DIFERENCA_.AsFloat;
        //
        // Este procedimento  para mudar a ordem do registro
        // para o caixa no ficar negativo
        //
//        Form7.ibDataSet1REGISTRO.AsString := sRegistro;
        //
        Form7.ibDataSet1.Post;
        //
      end;
      //
      //
      // Cancela todas as contas marcadas para receber
      //
      Form7.ibQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update PAGAR set ATIVO = ATIVO-5 where ATIVO >= 5');
      Form7.IBQuery1.Open;
      //
      Form7.ibDataSet25.Edit;
      Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
      Form7.ibDataSet25.Post;
      Form7.ibDataSet25.Edit;
      //
      Form7.Close;
      Form7.Show;
      Form7.DBGrid1.SetFocus;
      //
    end;
  end else
  begin
    if Form7.ibDataSet25DIFERENCA_.AsFloat = 0 then
    begin
      Form7.SMALL_DBEdit6.Visible := True;
      ShowMessage('Informe o total recebido.');
      Form7.SMALL_DBEdit6.SetFocus;
      Abort;
    end else
    begin
      //
      if AllTrim(ComboBox1.Text) = '' then ComboBox1.Text := '<Dinheiro';
      //
      if (fTotal <> Form7.ibDataSet25DIFERENCA_.AsFloat) and ( Form7.ibDataSet25DIFERENCA_.AsFloat <> 0 ) then
      begin
        //
        if ComboBox2.Text = '<Plano de contas para a diferena>' then
        begin
          ShowMessage('Informe o <Plano de contas para a diferena>.');
          Form7.ComboBox2.SetFocus;
          Abort;
        end;
        //
        Form7.ibDataSet1.Append;
        //
        Form7.ibDataSet1HISTORICO.AsString     := 'Diferena';
        Form7.ibDataSet1NOME.AsString          := ComboBox2.Text;
        //
        Form7.ibDataSet1DATA.AsDateTime        := Date;
        if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal
         then Form7.ibDataSet1ENTRADA.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat - fTotal
           else Form7.ibDataSet1SAIDA.AsFloat := fTotal - Form7.ibDataSet25DIFERENCA_.AsFloat;
        //
        Form7.ibDataSet1.Post;
        //
      end;
      //
      if (Copy(ComboBox1.Text,1,9) <> '<Dinheiro') and (Form7.ibDataSet25DIFERENCA_.AsFloat <> 0) then
      begin
        //
        Form7.ibDataSet1.Append;
        Form7.ibDataSet1HISTORICO.AsString     := Edit1.Text;
        Form7.ibDataSet1NOME.AsString          := ComboBox1.Text;
        Form7.ibDataSet1DATA.AsDateTime      := Date; // A pedido da center
        Form7.ibDataSet1SAIDA.AsFloat        := Form7.ibDataSet25DIFERENCA_.AsFloat;
        Form7.ibDataSet1.Post;
        //
      end;
      //
      //
      // Cancela todas as contas marcadas para receber
      //
      Form7.ibQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update RECEBER set ATIVO = ATIVO-5 where ATIVO >= 5');
      Form7.IBQuery1.Open;
      //
      Form7.ibDataSet25.Edit;
      Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
      Form7.ibDataSet25.Post;
      Form7.ibDataSet25.Edit;
      //
      Form7.Close;
      Form7.Show;
      Form7.DBGrid1.SetFocus;
      //
    end;
  end;
  //


end;

procedure TForm7.Button8Click(Sender: TObject);
begin
  //
  //
  //
  if Form7.sModulo = 'PAGAR' then
  begin
    //
    // Cancela todas as contas marcadas para pagar
    //
    Form7.ibDataSet8.DisableControls;
    //
    Form7.ibDataSet8.Close;
    Form7.ibDataSet8.SelectSQL.Clear;
    Form7.ibDataSet8.SelectSQL.Add('select * from PAGAR where ATIVO >=5');
    Form7.ibDataSet8.Open;
    //
    Form7.ibDataSet8.First;
    //
    while not Form7.ibDataSet8.Eof do
    begin
      //
      if Form7.ibDataSet8ATIVO.AsFloat >= 5 then
      begin
        Form7.ibDataSet8.Edit;
        Form7.ibDataSet8VALOR_PAGO.AsFloat := 0;
        Form7.ibDataSet8.Post;
      end;
      //
      Form7.ibDataSet8.Next;
      //
    end;
    //
    Label49.CAption := 'R$ 0,00';
    //
    Form7.ibQuery1.Close;
    Form7.IBQuery1.SQL.Clear;
    Form7.IBQuery1.SQL.Add('update PAGAR set ATIVO = ATIVO-5 where ATIVO >= 5');
    Form7.IBQuery1.Open;
    //
  end else
  begin
    //
    // Cancela todas as contas marcadas para receber
    //
    Form7.ibDataSet7.DisableControls;
    //
    Form7.ibDataSet7.Close;
    Form7.ibDataSet7.SelectSQL.Clear;
    Form7.ibDataSet7.SelectSQL.Add('select * from RECEBER where ATIVO >=5');
    Form7.ibDataSet7.Open;
    //
    Form7.ibDataSet7.First;
    //
    while not Form7.ibDataSet7.Eof do
    begin
      //
      if Form7.ibDataSet7ATIVO.AsFloat >= 5 then
      begin
        Form7.ibDataSet7.Edit;
        Form7.ibDataSet7VALOR_RECE.AsFloat := 0;
        Form7.ibDataSet7.Post;
      end;
      //
      Form7.ibDataSet7.Next;
      //
    end;
    //
    Label49.CAption := 'R$ 0,00';
    //
    Form7.ibQuery1.Close;
    Form7.IBQuery1.SQL.Clear;
    Form7.IBQuery1.SQL.Add('update RECEBER set ATIVO = ATIVO-5 where ATIVO >= 5');
    Form7.IBQuery1.Open;
    //
  end;
  //
  Form7.ibDataSet25.Edit;
  Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
  Form7.ibDataSet25.Post;
  Form7.ibDataSet25.Edit;
  //
  Form7.Close;
  Form7.Show;
  Form7.DBGrid1.SetFocus;
  //

end;

procedure TForm7.RelatriodeIPI1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de IPI';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.RelatriodePISCOFINS1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de PIS/COFINS (NF-e)';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Cardpio1Click(Sender: TObject);
begin
  if Form7.sModulo = 'ESTOQUE' then
  begin
    //
    Form7.Caption := 'Cardpio';
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    //
    Form39.Height := 80;
    //
  end;
  //
  Form9.Show;
  Form14.Caption := 'Assistente para cardpio';
  Form14.Show;
  //
end;

procedure TForm7.Livrodereceitas1Click(Sender: TObject);
begin
  //
  if Form7.sModulo = 'ESTOQUE' then
  begin
    //
    Form7.Caption := 'Receitas';
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    //
    Form39.Height := 80;
    //
  end;
  //
  Form9.Show;
  //
  if Form7.Livrodereceitas1.Caption = 'Relatrio de composio...' then
  begin
    Form14.Caption := 'Relatrio de composio';
  end else
  begin
    Form14.Caption := 'Livro de receitas';
  end;
  //
  Form14.Show;
  //
end;

procedure TForm7.ibDataSet4ALIQ_PIS_ENTRADAChange(Sender: TField);
var
  I : Integer;
begin
  //
//  I := Application.MessageBox(Pchar('Atribuir o novo valor para todas as compras do ms '+MesExtenso(Month(Date))+'/'+IntToStr(Year(Date))+' '
//                          + chr(10)+'deste produto?'+ Chr(10)
//                    + Chr(10))
//                    ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);
  I := Application.MessageBox(Pchar('Atribuir o novo valor para todas as compras deste produto?'+ Chr(10)
                    + Chr(10))
                    ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);
  //
  if I = IDYES then
  begin
    //
//    if (Form7.ibDataSet4ALIQ_PIS_ENTRADA.AsFloat <> 0) and (Form7.ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat <> 0) then
    begin
      //
      try
        Screen.Cursor            := crHourGlass;
        Form7.IBQuery99.Close;
        Form7.IBQuery99.SQL.Clear;
        Form7.IBQuery99.SQL.Add('update ITENS002 set ALIQ_PIS='+QuotedStr(StrTran(Form7.ibDataSet4ALIQ_PIS_ENTRADA.AsString,',','.'))+', ALIQ_COFINS='+QuotedStr(StrTran(Form7.ibDataSet4ALIQ_COFINS_ENTRADA.AsString,',','.'))+', CST_PIS_COFINS='+QuotedStr(Form7.ibDataSet4CST_PIS_COFINS_ENTRADA.AsString)+' where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString)+' ');
        Form7.IBQuery99.Open;
      except

      end;
      //
      Screen.Cursor            := crDefault;
      //
      //    ShowMessage(Form7.IBQuery99.SQL.Text);
      //
    end;
    //
    //
  end;
end;

procedure TForm7.SPEDPISCOFINS1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\spedpiscofins.exe') then
    ShellExecute( 0, 'Open', 'spedpiscofins.exe', '', '', SW_SHOW) else
      ShowMessage('O executvel spedpiscofins.exe no foi encontrado na pasta de instalao do programa.');

end;

procedure TForm7.WebBrowser1NavigateComplete2(Sender: TObject;
  const pDisp: IDispatch; var URL: OleVariant);
begin
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
end;

procedure TForm7.WebBrowser1DownloadComplete(Sender: TObject);
begin
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
end;

procedure TForm7.WebBrowser1DocumentComplete(Sender: TObject;
  const pDisp: IDispatch; var URL: OleVariant);
begin
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
end;

procedure TForm7.CCartadeCorreoEletronicaCCe1Click(Sender: TObject);
var
  sCartaCorrecao, sRetorno, sMotivo, sIDLote, sEmail : String;
  vXMLProt: TXMLDocument;
begin
  //
  try
    //
    if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
    begin
      //
      Screen.Cursor            := crHourGlass;
      Form7.Panel7.Caption          := 'Carta de correo de NF-e...'+replicate(' ',100);
      Form7.Panel7.Repaint;
      //
      vXMLProt        := TXMLDocument.Create(Form7.XMLDocument1);
      //
      ConfiguraNFE(True);
      //
      try
        //
        Form36.Top := Form7.Top;
        Form36.Left := Form7.Left;
        Form36.Width  := Form7.Width;
        Form36.Height  := Form7.Height;
        //
        Form36.Label1.Caption := chr(10)+
        'Para enviar uma carta de correo para a NF-e: '+Form7.ibDataSet15NUMERONF.AsString+' insira um texto livre (min. 30 caracteres).'+chr(10)+
        chr(10)+
        'O Ajuste SINIEF 01/07 veda a correo das seguintes informaes relacionadas com o Fato Gerador do ICMS da NF-e:'+chr(10)+chr(10)+
        'I - as variveis que determinam o valor do imposto tais como: base de clculo, alquota, diferena de preo, quantidade, valor da operao ou da prestao;'+chr(10)+
        'II - a correo de dados cadastrais que implique mudana do remetente ou do destinatrio;'+chr(10)+
        'III - a data de emisso ou de sada.'+chr(10)+
        chr(10)+
        'Uma NF-e pode ter at 20 cartas de correo e a ltima carta substitui as anteriores, assim o emissor deve consolidar o texto na nova carta de correo.'+chr(10)+
        chr(10)+
        'O texto da correo  um texto livre com tamanho limitado a 1000 caracteres e inexiste modelo ou padro do texto, assim o emissor deve descrever de'+chr(10)+
        'forma clara e objetiva a correo que deve ser considerada.';
        //
        Form36.ShowModal;
        sCartaCorrecao := ConverteAcentos2(Form36.Memo1.Text);
        //
{
        sCartaCorrecao := ConverteAcentos2(Form1.Small_InputForm('Ateno',
        chr(10)+
        'Para enviar uma carta de correo para a NF-e: '+Form7.ibDataSet15NUMERONF.AsString+' insira um texto livre (min. 30 caracteres).'+chr(10)+
        chr(10)+
        'O Ajuste SINIEF 01/07 veda a correo das seguintes informaes relacionadas com o Fato Gerador do ICMS da NF-e:'+chr(10)+
        'I - as variveis que determinam o valor do imposto tais como: base de clculo, alquota, diferena de preo, quantidade, valor da operao ou da prestao;'+chr(10)+
        'II - a correo de dados cadastrais que implique mudana do remetente ou do destinatrio;'+chr(10)+
        'III - a data de emisso ou de sada.'+chr(10)+
        chr(10)+
        'Uma NF-e pode ter at 20 cartas de correo e a ltima carta substitui as anteriores, assim o emissor deve consolidar o texto na nova carta de correo.'+chr(10)+
        chr(10)+
        'O texto da correo  um texto livre com tamanho limitado a 1000 caracteres e inexiste modelo ou padro do texto, assim o emissor deve descrever de forma'+chr(10)+
        'clara e objetiva a correo que deve ser considerada.'+chr(10)+
        chr(10)+
        chr(10), ''));
}
        //
        if Length(sCartaCorrecao) >= 30 then
        begin
          //
          Screen.Cursor            := crHourGlass;
          //
          Form7.ibDataset99.Close;
          Form7.ibDataset99.SelectSql.Clear;
          Form7.ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
          Form7.ibDataset99.Open;
          //
          // ddmmyyyyhhnnss
          //
          Form7.ibDataSet15.Edit;
          Form7.ibDataSet15ICCE.AsInteger := Form7.ibDataSet15ICCE.AsInteger + 1;
          Form7.ibDataSet15.Post;
          //
          sIDLote := ibDataSet15.FieldByname('NUMERONF').AsString;
          //
          sCartaCorrecao := StringReplace (sCartaCorrecao, #13#10, ' ', [rfReplaceAll]);
          sRetorno := spdNFe.EnviarCCe(Alltrim(Form7.ibDataSet15NFEID.AsString),AllTrim(sCartaCorrecao),FormatDateTime('yyyy-mm-dd"T"hh:nn:"00"',Now),Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,2),sIDLote,Form7.ibDataSet15ICCE.AsInteger,Form7.sFuso);
          sleep(3000);
          //
          // ShowMessage(sRetorno);
          //
          if FileExists( pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.xml')) then
          begin
            //
            Form7.ibDataSet2.Close;
            Form7.ibDataSet2.Selectsql.Clear;
            Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
            Form7.ibDataSet2.Open;
            //
            sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
            //
            if sZiparXML = 'S' then
            begin
              //
              ShellExecute( 0, 'Open','szip.exe', pChar('backup "'+Alltrim(pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.xml'))+'" "'+
              Alltrim(pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.zip'))+'"'),'', SW_SHOWMAXIMIZED);
              //
              while ConsultaProcesso('szip.exe') do
              begin
                Application.ProcessMessages;
                sleep(100);
              end;
              //
              while not FileExists( pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.zip')) do
              begin
                sleep(100);
              end;
              //
              Unit7.EnviarEMail('',sEmail,'','Carta de correo Eletrnica (Cc-e)',pchar('Segue em anexo Carta de correo Eletrnica (Cc-e) em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),
                pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.zip')
                ,False);
              //
            end else
            begin
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','Carta de correo Eletrnica (Cc-e)',pchar('Segue em anexo Carta de correo Eletrnica (Cc-e) em arquivo XML.'+chr(10)+Form1.sPropaganda+
                  chr(10)),
                  pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.xml')
                  ,False);
              end;
            end;
            //
            vXMLProt.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.xml'));
            //
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15CCEXML.AsString := vXMLProt.XML.Text;;
            Form7.ibDataSet15.Post;
            //
            // spdCCe.EnviarXMLCCeDestinatario(edArquivoXmlDest.Text);
            //
            sRetorno := 'Carta de correo Eletrnica (Cc-e) vinculada a NF-e.';
            //
            ShowMessage(sRetorno);
            //
          end else
          begin
            //
            sMotivo :=  Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
            sRetorno := StrTran(sRetorno,'<xMotivo>'+sMotivo+'</xMotivo>','');
            //
            if Pos('<xMotivo>',sRetorno) <> 0 then
            begin
              sMotivo := Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
            end;
            //
            ShowMessage(sMotivo);
            //
            sRetorno := 'Erro ao gerar Cc-e para NF-e '+Form7.ibDataSet15NUMERONF.AsString;
            //
          end;
          //
          //
        end else
        begin
          //
          if AllTrim(sCartaCorrecao) <> '' then
          begin
            ShowMessage('O texto livre da Carta de Correo Eletrnica (Cc-e) tem que ter no minimo 30 caracteres.');
          end;
          //
        end;
        //
      except end;
      //
    end;
    //
  except end;
  //
  DecimalSeparator := ',';
  DateSeparator    := '/';
  Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
  Form7.Panel7.Repaint;
  Screen.Cursor            := crDefault;
  //
  Form7.Close;
  Form7.Show;
  //
end;

procedure TForm7.IBDataSet128BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_PAGAMENT,1) from rdb$database');
    ibDataset99.Open;
    sProximo := StrZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
    //
    try
      ibDataSet99.Close;
      ibDataSet99.SelectSql.Clear;
      ibDataset99.SelectSql.Add('select gen_id(G_HASH_PAGAMENT,1) from rdb$database');
      ibDataset99.Open;
    except end;
    //
  except end;
  //
end;

procedure TForm7.IBDataSet128BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('PAGAMENT', DataSet, True);
end;

procedure TForm7.IBDataSet128NewRecord(DataSet: TDataSet);
begin
  ibDataSet128.FieldByName('REGISTRO').AsString := sProximo;
end;

procedure TForm7.Exibir1Click(Sender: TObject);
var
  I, J : Integer;
  bI : Boolean;
  NewItem: TMenuItem;
begin
  //
  if ibDataSet2ATIVO.AsString='1' then Ativo2.Checked := False else Ativo2.Checked := True;
  //
  for I := 0 to Form10.ComboBox8.Items.Count -1 do
  begin
    if Form10.ComboBox8.Items[I] = Form7.ArquivoAberto.FieldByName('CLIFOR').AsString then
    begin
      Form10.ComboBox8.ItemIndex := I;
    end;
  end;
  //
  for J := 0 to Form10.ComboBox8.Items.Count -1 do
  begin
    //
    bI := True;
    //
    for I := 0 to Exibir1.Count -1 do
      if Exibir1.Items[I].Caption = 'S '+Form10.ComboBox8.Items[J] then
        bI := False;
    //
    if bI then
    begin
      if AllTrim(Form10.ComboBox8.Items[J]) <> '' then
      begin
        NewItem         := TMenuItem.Create(Exibir1);
        NewItem.Caption := 'S '+Form10.ComboBox8.Items[J];
        Exibir1.Add(NewItem);
        NewItem.OnClick := Form1.EscolheOclifor;
      end;
    end;
    //
  end;
  //
end;

procedure TForm7.ibDataSet4PROMOINISetText(Sender: TField;
  const Text: String);
begin
  { ------------------------------------------------------------------ }
  { Cuidado: Esta rotina est associada a todos os campos do tipo data }
  { ------------------------------------------------------------------ }
  if Text = '  /  /    ' then
  begin
    Sender.AsString := '';
  end else
  begin
    try
      if (StrToDate(Text) <= (Date-(360*90))) or (StrToDate(Text) >= (Date+(360*90))) then
      begin
        if Application.MessageBox(Pchar('Esta data no parece ser a correta. Voc confirma '+text+ Chr(10) +
                                        'como a data vlida?' + Chr(10))
                                         ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION) <> IDYES then
        begin
          bFlag := False;
        end else
        begin
          try
            Sender.AsString := Text;
          except
            begin
              bFlag := False;
              ShowMessage('Esta data no  vlida, digite-a novamente.');
            end;
          end;
        end;
      end else
      begin
        try
          Sender.AsString := Text;
        except
          begin
            bFlag := False;
            ShowMessage('Esta data no  vlida, digite-a novamente.');
          end;
        end;
      end;
    except
      bFlag := False;
      ShowMessage('Esta data no  vlida, digite-a novamente.');
    end;
  end;
end;

procedure TForm7.Resumodainadimplncia1Click(Sender: TObject);
var
  I : Integer;
  F: TextFile;
  Mais1Ini : tInifile;
begin
  //
  ShortDateFormat := 'dd/mm/yyyy';
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - INADIMPLNCIA')+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  //
  // Tabela de inadimplncia
  //
  WriteLn(F,'<br><br>');              // Linha em branco
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>Resumo da inadimplncia</b></font>');
  WriteLn(F,'<center><br><br>');
  WriteLn(F,'<a href="inadimplencia_mes.png"><img src="inadimplencia_mes.png" border="0" width=200 height=200></a>');
  WriteLn(F,'<a href="inadimplencia_ano.png"><img src="inadimplencia_ano.png" border="0" width=200 height=200></a>');
  WriteLn(F,'<a href="inadimplencia_tot.png"><img src="inadimplencia_tot.png" border="0" width=200 height=200></a>');
  WriteLn(F,'</enter>');
  //
  WriteLn(F,' <table  border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=600>');
  WriteLn(F,'  <tr>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000"></th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">% de<br>inadimplncia</th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Valor em R$</th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Mdia de dias<br>em atraso</th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Clientes<br>em atraso</th>');
  WriteLn(F,'  </tr>');
  WriteLn(F,'  <tr>');
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">ltimos trs meses</td>');
  //
  // ltimos trs meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select cast(sum(VALOR_DUPL)as numeric(18,2))as VALOR, cast(sum(VALOR_RECE)as numeric(18,2))as RECE from RECEBER where (VENCIMENTO>=(CURRENT_DATE-90)) and VENCIMENTO<CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)])+'</td>'); // Percentual de inadimplncia
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[Form7.ibDataSet99.FieldByname('VALOR').AsFloat-Form7.ibDataSet99.FieldByname('RECE').AsFloat])+'</td>'); // Valor atrasado  //
  //                                          //
  // Grfico de fluxo de caixa inadimplencia //
  //                                        //
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_mes.gra'));
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_mes.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\inadimplencia_mes.gra');
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','0');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','AlturaBmp','200');
  Mais1Ini.WriteString('DADOS','LarguraBmp','200');
  Mais1Ini.WriteString('DADOS','Titulo','Inadimplncia');
  Mais1Ini.WriteString('DADOS','SubTitulo','Trs meses: '+AllTrim(Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]))+'%');
  Mais1Ini.WriteString('DADOS','NomeBmp','inadimplencia_mes.png');
  Mais1Ini.WriteString('DADOS','FontSize','8'); //'11577023' // '15381040'
  Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
  //
  // Acumula os valores
  //
  I := 1;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Inadimplncia>');

  I := 2;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[100-(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Adimplncia>');


  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'graficos.exe', 'inadimplencia_mes.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  while not FileExists(Form1.sAtual+'\inadimplencia_mes.png') do
    Sleep(100);
  //
  // Mdia de dias de atraso ltimos trs meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select avg(coalesce(RECEBIMENT,CURRENT_DATE)-coalesce(VENCIMENTO,CURRENT_DATE)) as DIAS from RECEBER where (VENCIMENTO>=(CURRENT_DATE-90)) and VENCIMENTO<CURRENT_DATE and coalesce(RECEBIMENT,CURRENT_DATE)<>CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('DIAS').AsFloat])+'</td>');
  //
  // Clientes em atraso  trs meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select count(distinct(NOME))as CLIENTES from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(VALOR_RECE,0)=0 and (VENCIMENTO>=(CURRENT_DATE-90)) and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('CLIENTES').AsFloat])+'</td>');
  WriteLn(F,' </tr>');
  //
  // ltimos doze meses
  //
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">ltimos doze meses</td>');
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select cast(sum(VALOR_DUPL)as numeric(18,2))as VALOR, cast(sum(VALOR_RECE)as numeric(18,2))as RECE from RECEBER where (VENCIMENTO>=(CURRENT_DATE-360)) and VENCIMENTO<CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  //                                          //
  // Grfico de fluxo de caixa inadimplencia //
  //                                        //
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_ano.gra'));
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_ano.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\inadimplencia_ano.gra');
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','0');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','AlturaBmp','200');
  Mais1Ini.WriteString('DADOS','LarguraBmp','200');
  Mais1Ini.WriteString('DADOS','Titulo','Inadimplncia');
  Mais1Ini.WriteString('DADOS','SubTitulo','Doze meses: '+AllTrim(Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]))+'%');
  Mais1Ini.WriteString('DADOS','NomeBmp','inadimplencia_ano.png');
  Mais1Ini.WriteString('DADOS','FontSize','8'); //'11577023' // '15381040'
  Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
  //
  // Acumula os valores
  //
  I := 1;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Inadimplncia>');

  I := 2;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[100-(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Adimplncia>');


  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'graficos.exe', 'inadimplencia_ano.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  while not FileExists(Form1.sAtual+'\inadimplencia_ano.png') do
    Sleep(100);
  //
  // Fim grafico
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)])+'</td>'); // Percentual de inadimplncia
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[Form7.ibDataSet99.FieldByname('VALOR').AsFloat-Form7.ibDataSet99.FieldByname('RECE').AsFloat])+'</td>'); // Valor atrasado
  //
  // Mdia de dias de atraso ltimos doze meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select avg(coalesce(RECEBIMENT,CURRENT_DATE)-coalesce(VENCIMENTO,CURRENT_DATE)) as DIAS from RECEBER where (VENCIMENTO>=(CURRENT_DATE-360)) and VENCIMENTO<CURRENT_DATE and coalesce(RECEBIMENT,CURRENT_DATE)<>CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('DIAS').AsFloat])+'</td>');
  //
  // Clientes em atraso doze meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select count(distinct(NOME))as CLIENTES from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(VALOR_RECE,0)=0 and (VENCIMENTO>=(CURRENT_DATE-360)) and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('CLIENTES').AsFloat])+'</td>');
  WriteLn(F,' </tr>');
  //
  // Total
  //
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Total registrado</td>');
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select  cast(sum(VALOR_DUPL)as numeric(18,2))as VALOR, cast(sum(VALOR_RECE)as numeric(18,2))as RECE  from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  //                                          //
  // Grfico de fluxo de caixa inadimplencia //
  //                                        //
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_tot.gra'));
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_tot.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\inadimplencia_tot.gra');
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','0');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','AlturaBmp','200');
  Mais1Ini.WriteString('DADOS','LarguraBmp','200');
  Mais1Ini.WriteString('DADOS','Titulo','Inadimplncia');
  Mais1Ini.WriteString('DADOS','SubTitulo','Total: '+AllTrim(Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]))+'%');
  Mais1Ini.WriteString('DADOS','NomeBmp','inadimplencia_tot.png');
  Mais1Ini.WriteString('DADOS','FontSize','8'); //'11577023' // '15381040'
  Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
  //
  // Acumula os valores
  //
  I := 1;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Inadimplncia>');

  I := 2;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[100-(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Adimplncia>');


  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'graficos.exe', 'inadimplencia_tot.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  while not FileExists(Form1.sAtual+'\inadimplencia_tot.png') do
    Sleep(100);
  //
  // Fim grafico
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)])+'</td>'); // Percentual de inadimplncia
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[Form7.ibDataSet99.FieldByname('VALOR').AsFloat-Form7.ibDataSet99.FieldByname('RECE').AsFloat])+'</td>'); // Valor atrasado
  //
  // Mdia de dias de atraso TOTAL
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select avg(coalesce(RECEBIMENT,CURRENT_DATE)-coalesce(VENCIMENTO,CURRENT_DATE)) as DIAS from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(RECEBIMENT,CURRENT_DATE)<>CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('DIAS').AsFloat])+'</td>');
  //
  // Clientes em atraso TOTAL
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select count(distinct(NOME))as CLIENTES from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(VALOR_RECE,0)=0 and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('CLIENTES').AsFloat])+'</td>');
  WriteLn(F,' </tr>');
  //
  WriteLn(F,'</table>');
  WriteLn(F,'</center>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  WriteLn(F,'<center><br><font face="verdana" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
  + Copy(DateTimeToStr(Date),7,4) +', '+ LowerCase(DiaDaSemana(Date)) + ' s ' + TimeToStr(Time)+'</font></center>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);                                    // Fecha o arquivo
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;

procedure TForm7.Manifestaododestinatrio1Click(Sender: TObject);
var
  sRetorno : String;
begin
  //
  try
    //
    ConfiguraNFE(True);
    //
    // Cdigo do evento:
    // 210200  Confirmao da Operao
    // 210210  Cincia da Operao
    // 210220  Desconhecimento da Operao
    // 210240  Operao no Realizada
    //
    if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)=0) then
    begin
      //
      Manifesto(2); // 2: Cincia da operao
      //
    end else
    begin
      //
      if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString)=0) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)<>0) then
      begin
        if Form7.ibDataSet24MERCADORIA.Asfloat = 0 then
        begin
          sRetorno := spdNFe.ConsultarDistribuicaoDFeChave(pChar(Copy(Form7.ibDataSet24NFEID.AsString,1,2)), pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)),pChar(Form7.ibDataSet24NFEID.AsString));
          DownloadNFeEmitida(sRetorno); // Baixa o XML de uma NF-e especifica
        end;
      end;
    end;
    //
    if Form7.ibDataSet24MERCADORIA.AsFloat = 0 then
    begin
      if Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString)<>0 then
      begin
        //
        Form7.ImportaNF(True,Form7.ibDataset24NFEXML.AsString);
        Form7.ibDataSet23AfterPost(Form7.ibDataSet23);
        //
      end;
    end;
    //
    if Form7.ibDataSet24MERCADORIA.AsFloat <> 0 then
    begin
      //
      Manifesto(1); // 1: Confirmao da operao.
      //
    end;
    //
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING);
    end;
  end;
  //
  Screen.Cursor := crDefault;
  //
end;

procedure TForm7.ibDataSet4CFChange(Sender: TField);
begin
  //
  Form7.ibQuery3.Close;
  Form7.ibQuery3.SQL.Clear;
//  Form7.ibQuery3.SQL.Add('select * from IBPT_ where CODIGO like '+QuotedStr(Form7.ibDataSet4CF.AsString+'%'));
//
//  Form7.ibQuery3.SQL.Add('select * from IBPT_ where '+QuotedStr(Form7.ibDataSet4CF.AsString)+' like CODIGO||''%''');
//  Form7.ibQuery3.SQL.Add('select * from IBPT_ where char_length(CODIGO) >= 8 and '+QuotedStr(Form7.ibDataSet4CF.AsString)+' like CODIGO||''%''');
  Form7.ibQuery3.SQL.Add('select * from IBPT_ where char_length(CODIGO) >= 8 and CODIGO='+QuotedStr(Form7.ibDataSet4CF.AsString));
  Form7.ibQuery3.Open;
  //
  if Form7.ibDataSet4CF.AsString <> '' then
  begin
    //
    Form7.ibDataSet4.Edit;
    //
    // INDICE DE IMPOSTO APROXIMADO - IIA - ESTADUAL
    //
    Form7.ibDataSet4IIA_UF.ReadOnly := False;
    Form7.ibDataSet4IIA_UF.AsFloat := Form7.ibQuery3.FieldByname('ESTADUAL').AsFloat;
    Form7.ibDataSet4IIA_UF.ReadOnly := True;
    //
    // INDICE DE IMPOSTO APROXIMADO - IIA - MUNICIPAL
    //
    //
    Form7.ibDataSet4IIA_MUNI.ReadOnly := False;
    Form7.ibDataSet4IIA_MUNI.AsFloat := Form7.ibQuery3.FieldByname('MUNICIPAL').AsFloat;
    Form7.ibDataSet4IIA_MUNI.ReadOnly := True;
    //
    if (Copy(Form7.ibDataSet4CST.AsString,1,1) = '1') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '2') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '6') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '7') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '8') then

    begin
      //
      // 1 - Estrangeira - Importao direta, exceto a indicada no cdigo 6
      // 2 - Estrangeira - Adquirida no mercado interno, exceto a indicada no cdigo 7
      // 6 - Estrangeira - Importao direta, sem similar nacional, constante em lista de Resoluo CAMEX;
      // 7 - Estrangeira - Adquirida no mercado interno, sem similar nacional, constante em lista de Resoluo CAMEX.
      // 8 - Nacional, mercadoria ou bem com Contedo de Importao sup. a 70%
      //
      Form7.ibDataSet4IIA.ReadOnly := False;
      Form7.ibDataSet4IIA.AsFloat  := Form7.ibQuery3.FieldByname('IMPORTADOFEDERAL').AsFloat;
      Form7.ibDataSet4IIA.ReadOnly := True;
      //
    end else
    begin
      //
      // 0 - Nacional, exceto as indicadas nos cdigos 3 a 5
      // 3 - Nacional, mercadoria ou bem com Contedo de Importao superior a 40% (quarenta por cento)
      // 4 - Nacional, cuja produo tenha sido feita em conformidade com os processos produtivos bsicos de que tratam o Decreto-Lei n 288/1967, e as Leis ns 8.248/1991, 8.387/1991, 10.176/2001 e 11.484/2007;
      // 5 - Nacional, mercadoria ou bem com Contedo de Importao inferior ou igual a 40% (quarenta por cento)
      //
      Form7.ibDataSet4IIA.ReadOnly := False;
      Form7.ibDataSet4IIA.AsFloat  := Form7.ibQuery3.FieldByname('NACIONALFEDERAL').AsFloat;
      Form7.ibDataSet4IIA.ReadOnly := True;
      //
    end;
    //
    Form7.ibDataSet4.Post;
    Form7.ibDataSet4.Edit;
    Form7.ibQuery3.Close;
    //
  end;
  //
end;

procedure TForm7.IImprimirCartadeCorreoEletronicaCCe1Click(
  Sender: TObject);
begin
  //
  ConfiguraNFE(True);
  //
  // Recupera na tabela VENDAS o XML
  //
  fNFE :=  Form7.ibDataSet15CCEXML.AsString;
  //
  spdNFe.ImprimirCCe(fNFE);
  //
end;

procedure TForm7.EtiquetasZebraArgoxElgin1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\etiquetas.exe') then
  ShellExecute( 0, 'Open', 'etiquetas.exe', '', '', SW_SHOW) else
  ShowMessage('O executvel etiquetas.exe no foi encontrado na pasta de instalao do programa.');
end;

procedure TForm7.Panel1Click(Sender: TObject);
begin
  Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
end;

procedure TForm7.ImprimiraNFemformulrionumerado1Click(Sender: TObject);
begin
  try
    Unit7.ImprimeOuNaoANota(True);
  except end;
end;

procedure TForm7.ImprimirtodasasNFfiltradas1Click(Sender: TObject);
var
  I : Integer;
begin
  //
  I := Application.MessageBox(pChar(
                            chr(10) +'Quer realmente imprimir todas as Notas Fiscais filtradas?'
                            +chr(10)+
                            chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                            'posicionado.'+Chr(10)+
                            chr(10)+
                            'Imprimir agora?'),
                            'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);



  if I = 6 then
  begin
    ibDataSet15.First;
    while (not ibDataSet15.Eof) do
    begin
      Application.ProcessMessages;
      Unit7.ImprimeOuNaoANota(True);
      ibDataSet15.Next;
    end;
  end;
  //
end;

procedure TForm7.Button3Click(Sender: TObject);
begin
  Form20.ShowModal;
  dbGrid1.SetFocus;
end;

procedure TForm7.Button4Click(Sender: TObject);
var
  F: TextFile;
  Mais2Ini: TIniFile;
  iPagina, I, JI : Integer;
  vLinha: array [0..200]  of String;  // Cria uma matriz com 100 elementos
begin
  //
  for I := 1 to 200  do vLinha[I] := '';
  //
  JI      := 136;
  iPagina := 66;
  //
  ibDataSet19.DisableControls;
  ibDataSet19.First;
  while not ibDataSet19.Eof do
  begin
    if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17))) = 'CHR(27)+[C]+CHR(' then iPagina := StrToInt('0'+Limpanumero((Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-3,3))));
    ibDataSet19.Next;
  end;
  //
  // Imprime todas as Linhas
  //
  for I := 0 to iPagina -1 do
  begin
    //
    if (I=0)
    or (I=10)
    or (I=20)
    or (I=30)
    or (I=40)
    or (I=50)
    or (I=60)
    or (I=70)
    or (I=80)
    or (I=90)
    or (I=100)
    or (I=120) then vLinha[I] := Copy('0........1.........2.........3.........4.........5.........6.........7.........8.........9.........0.........1.........2.........3.........4',1,JI) else
                      vLinha[I] := Copy(Copy(IntToStr(I)+'   ',1,3)+'      .         .         .         .         .         .         .         .         .         .         .         .         .         .',1,JI);
    ibDataSet19.First;
    //
    while not ibDataSet19.Eof do
    begin
      //
      try
        if (ibDataSet19LINHA.AsFloat = I) and ((ibDataSet19COLUNA.AsFloat <> 0)) then
        begin
          if Copy(ibDataSet19TIPO.AsString,1,2) = '@&' then
          begin
            //
            if UpperCase(AllTrim(Copy(ibDataSet19TIPO.AsString,3,Length(ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then JI := 136;
            if UpperCase(AllTrim(Copy(ibDataSet19TIPO.AsString,3,Length(ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then JI := 80;
            //
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(15) + Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(18) + Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[0]' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(27)+'0'+Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[1]' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(27)+'1'+Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[2]' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(27)+'2'+Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
          end;
        end;
        //
      except end;
      //
      ibDataSet19.Next;
    end;
    //
    // Arquivo de nota fiscal NOTA.DBF
    //
  end;
  //
  // Inco da impressao da regua
  //
  if Form7.sModulo = 'NOTA' then
  begin
    if Button2.Caption = 'Srie 2' then
    begin
      Mais2ini := TIniFile.Create('retaguarda.ini');
      AssignFile(F,Mais2Ini.ReadString('Nota Fiscal','Porta','LPT1'));
      Mais2ini.Free;
    end else
    begin
      Mais2ini := TIniFile.Create('retaguarda.ini');
      AssignFile(F,Mais2Ini.ReadString('Nota Fiscal 2','Porta','LPT1'));
      Mais2ini.Free;
    end;
  end;
  //
  if Form7.sModulo = 'CONFOS' then
  begin
    Mais2ini := TIniFile.Create('retaguarda.ini');
    AssignFile(F,Mais2Ini.ReadString('OS','Porta','LPT1'));
    Mais2ini.Free;
  end;
  //
  if Form7.sModulo = 'CONFRECIBO' then
  begin
    Mais2ini := TIniFile.Create('retaguarda.ini');
    AssignFile(F,Mais2Ini.ReadString('RECIBOOS','Porta','LPT1'));
    Mais2ini.Free;
  end;
  //
  // MOTOR DA NOTA FISCAL
  //
  try
    Rewrite(F);
  except ShowMessage('Verifique a impressora.') end;
  //
  try
    Writeln(F,chr(27)+'@');
    for I := 0 to iPagina -1 do
    begin
      try
        Writeln(F,vLinha[I]);
      except
        ShowMessage('Verifique a impressora.');
        Abort;
      end;
    end;
    CloseFile(F);
  except
    ShowMessage('Verifique a impressora.');
    Abort;
  end;
  //
  ibDataSet19.First;
  ibDataSet19.EnableControls;
  //
end;

procedure TForm7.Button2Click(Sender: TObject);
begin
  //
  if Button2.Caption = 'Srie 1' then
  begin
    sWhere := 'where SERIE=1';
  end else
  begin
    sWhere := 'where SERIE=2';
  end;
  //
  Form7.Close;
  //
  Form7.sModulo         := 'NOTA';
  Form7.Show;
  //
end;

procedure TForm7.FCIFichadeContedodeImportao1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open', 'fci.exe', '', '', SW_SHOW);
end;

procedure TForm7.Produtividadedecontatos1Click(Sender: TObject);
var
  F: TextFile;
  MesInicial, I : Integer;
  fContatos, fTotal1, fTotal2 : Real;
  dContador, dInicio, dFinal : TdateTime;
  //
begin
  //
  Form7.sModulo := 'CONTATOS';
  Form38.Panel5.Visible := True;
  Form38.Button2.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Panel5.Visible := False;
  Form38.Button2.Visible := True;
  //
  Form7.sModulo := 'CLIENTES';
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //
  if Form38.Caption <> 'Cancelar' then
  begin
    //
    ShortDateFormat := 'dd/mm/yyyy';
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CONTATOS DE HORA EM HORA')+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CONTATOS DE HORA EM HORA</b></font>');
    WriteLn(F,'<br>');

  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
      //
      dInicio :=  StrToDate('01'+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      dFinal  :=  StrToDate(StrZero(DiasPorMes(Year(Form38.MonthCalendar1.Date),Month(Form38.MonthCalendar1.Date)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      //
      WriteLn(F,'<font face="verdana" size=2><b>'+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+'</b><br><br>');              // Ms e ano
      WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
      WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Dom</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Seg</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Ter</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qua</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qui</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Sex</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Sab</font></th>');
      WriteLn(F,' </tr>');
      //
      WriteLn(F,' <tr  bgcolor=#FFFFFF>');
      //
      dContador  := DInicio - Day(dInicio) +1;
      MesInicial := Month(dInicio);
      //
      fTotal2 := 0;
      //
      for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
      while dContador <= dFinal + DiasPorMes(Year(dFinal),Month(dFinal)) - Day(dFinal) do
      begin
        //
        if Month(dContador) = MesInicial then
        begin
          if DayOfWeek(dContador) = 1 then WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          if (dContador < dInicio) or (dContador > dFinal) then WriteLn(F,'   <td   nowrap   align=left valign=top width=100><font face="verdana" size=1 color=c0c0c0>'+IntToStr(Day(dContador))+'</td>') else WriteLn(F,'   <td   nowrap   align=left valign=top width=100><font face="verdana" size=1>'+IntToStr(Day(dContador)));
          //
          Form7.Panel7.Caption := 'Analizando dia '+DateToStr(dContador)+'...';
          Form7.Panel7.Repaint;
          //
          Form7.IBDataSet99.Close;
          Form7.IBDataSet99.SelectSQL.Clear;
          Form7.IBDataSet99.SelectSQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%'+StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0)+'%''');
          Form7.IBDataSet99.Open;
          //
          if Form7.IBDataSet99.FieldByname('COUNT').AsFloat <> 0 then
          begin
            //
            // Tabela do dia
            //
            WriteLn(F,' <table  border=1  style="border-collapse:Collapse"  cellspacing=0 cellpadding=3 width=100>');
    //        WriteLn(F,'  <tr>');
    //        WriteLn(F,'   <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Hora</th>');
    //        WriteLn(F,'   <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Contatos</th>');
    //        WriteLn(F,'  </tr>');
            //
            fTotal1 := 0;
            //
            for I := 1 to 24 do
            begin
              //
              Form7.Panel7.Caption := 'Analizando dia '+DateToStr(dContador)+' '+StrZero(I,2,0)+':00:00 ...';
              Form7.Panel7.Repaint;
              //
              Form7.IBDataSet99.Close;
              Form7.IBDataSet99.SelectSQL.Clear;
              Form7.IBDataSet99.SelectSQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%'+ StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0) +' '+StrZero(I,2,0)+':%''');
              Form7.IBDataSet99.Open;
              //
              fContatos := Form7.IBDataSet99.FieldByname('COUNT').AsFloat;
              //
              if (fContatos <> 0) then
              begin
                //
                WriteLn(F,'  <tr>');
                WriteLn(F,'   <td   width=30 align=Left><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+StrZero(I,2,0)+'</td>');
                WriteLn(F,'   <td   width=70 align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%7.0n',[fContatos])+'</td>');
                WriteLn(F,'  </tr>');
                //
                fTotal1 := fTotal1 + fContatos;
                fTotal2 := fTotal2 + fContatos;
                //
              end;
              //
            end;
            //
            WriteLn(F,'  <tr>');
            WriteLn(F,'   <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000"></th>');
            WriteLn(F,'   <th   align=Right bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+FloatToStr(fTotal1)+'</th>');
            WriteLn(F,'  </tr>');
            //
            WriteLn(F,' </table>');
            //
            // Tabela do dia
            //
          end;
          //
          WriteLn(F,' </td>');
          if DayOfWeek(dContador) = 7 then WriteLn(F,' </tr>');
          dContador := SomaDias(dContador, 1);                // Incrementa o contador
          //
        end else
        begin
          MesInicial := Month(dContador);
          for I := DayOfWeek(dContador) to 7 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
          WriteLn(F,' </tr>');
          WriteLn(F,'</table>');
          WriteLn(F,'<br>');
          WriteLn(F,'<br><font face="verdana" size=1><b>'+MesExtenso(Month(dContador))+' de '+IntToStr(Year(dInicio))+'</b>');              // Ms e ano
          WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
          WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Dom</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Seg</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Ter</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qua</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qui</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Sex</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Sab</font></th>');
          WriteLn(F,' </tr>');
          //
          WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
        end;
      end;
      //
      WriteLn(F,' </tr>');
      WriteLn(F,'</table>');
      WriteLn(F,'<br>');
      //
      WriteLn(F,'<font face="verdana" size=2><b>Contatos no ms de '+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+': '+FloatToStr(fTotal2)+'</b><br><br>'); // Ms e ano
      //
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);                                    // Fecha o arquivo
    //
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.IBDataSet2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.Clientescontactadospordia1Click(Sender: TObject);
var
  F: TextFile;
  MesInicial, I : Integer;
  fTotal1, fTotal2 : Real;
  dContador, dInicio, dFinal : TdateTime;
  //
begin
  //
  Form7.sModulo := 'CONTATOS';
  Form38.Panel5.Visible := True;
  Form38.Button2.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Panel5.Visible := False;
  Form38.Button2.Visible := True;
  //
  Form7.sModulo := 'CLIENTES';
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //
  if Form38.Caption <> 'Cancelar' then
  begin
    //
    ShortDateFormat := 'dd/mm/yyyy';
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CLIENTES CONTACTADOS POR DIA')+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CLIENTES CONTACTADOS POR DIA</b></font>');
    WriteLn(F,'<br>');
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
      //
      dInicio :=  StrToDate('01'+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      dFinal  :=  StrToDate(StrZero(DiasPorMes(Year(Form38.MonthCalendar1.Date),Month(Form38.MonthCalendar1.Date)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      //
      WriteLn(F,'<font face="verdana" size=2><b>'+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+'</b><br><br>');              // Ms e ano
      WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
      WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Dom</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Seg</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Ter</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qua</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qui</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Sex</font></th>');
      WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Sab</font></th>');
      WriteLn(F,' </tr>');
      //
      WriteLn(F,' <tr  bgcolor=#FFFFFF>');
      //
      dContador  := DInicio - Day(dInicio) +1;
      MesInicial := Month(dInicio);
      //
      fTotal1 := 0;
      fTotal2 := 0;
      //
      for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
      while dContador <= dFinal + DiasPorMes(Year(dFinal),Month(dFinal)) - Day(dFinal) do
      begin
        //
        if Month(dContador) = MesInicial then
        begin
          if DayOfWeek(dContador) = 1 then WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          if (dContador < dInicio) or (dContador > dFinal) then WriteLn(F,'   <td   nowrap   align=left valign=top width=100><font face="verdana" size=1 color=c0c0c0>'+IntToStr(Day(dContador))+'</td>') else WriteLn(F,'   <td   nowrap   align=left valign=top width=100><font face="verdana" size=1>'+IntToStr(Day(dContador)));
          //
          Form7.Panel7.Caption := 'Analizando dia '+DateToStr(dContador)+'...';
          Form7.Panel7.Repaint;
          //
          Form7.IBDataSet99.Close;
          Form7.IBDataSet99.SelectSQL.Clear;
          Form7.IBDataSet99.SelectSQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%'+StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0)+'%''');
          Form7.IBDataSet99.Open;
          //
          Form7.IBDataSet100.Close;
          Form7.IBDataSet100.SelectSQL.Clear;
          Form7.IBDataSet100.SelectSQL.Add('select sum(TOTAL) from VENDAS, ICM where EMITIDA=''S'' and EMISSAO='+QuotedStr(DateToStrInvertida(dContador))+' and ICM.NOME=VENDAS.OPERACAO and ICM.INTEGRACAO<>''''');
          Form7.IBDataSet100.Open;
          //
          if (Form7.IBDataSet99.FieldByname('COUNT').AsFloat <> 0) or (Form7.IBDataSet100.FieldByname('SUM').AsFloat <> 0) then
          begin
            //
            WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#32CD32">'+FloatToStr(Form7.IBDataSet99.FieldByname('COUNT').AsFloat)+'</center>');
            WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#FF0000">R$ '+Format('%14.2n',[Form7.IBDataSet100.FieldByName('SUM').AsFloat])+'</center>');
            WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#1E90FF">&Sigma; '+Format('%14.2n',[Form7.IBDataSet100.FieldByname('SUM').AsFloat/Form7.IBDataSet99.FieldByname('COUNT').AsFloat])+'</center>');
            //
            fTotal2 := fTotal2 + Form7.IBDataSet99.FieldByname('COUNT').AsFloat;
            fTotal1 := fTotal1 + Form7.IBDataSet100.FieldByname('SUM').AsFloat;
            //
          end;
          //
          WriteLn(F,' </td>');
          if DayOfWeek(dContador) = 7 then WriteLn(F,' </tr>');
          dContador := SomaDias(dContador, 1);                // Incrementa o contador
          //
        end else
        begin
          MesInicial := Month(dContador);
          for I := DayOfWeek(dContador) to 7 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
          WriteLn(F,' </tr>');
          WriteLn(F,'</table>');
          WriteLn(F,'<br>');
          WriteLn(F,'<br><font face="verdana" size=1><b>'+MesExtenso(Month(dContador))+' de '+IntToStr(Year(dInicio))+'</b>');              // Ms e ano
          WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
          WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Dom</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Seg</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Ter</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qua</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qui</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Sex</font></th>');
          WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Sab</font></th>');
          WriteLn(F,' </tr>');
          //
          WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
        end;
      end;
      //
      WriteLn(F,' </tr>');
      WriteLn(F,'</table>');
      WriteLn(F,'<br>');
      //
      WriteLn(F,'<font face="verdana" size=1><b>Contatos no ms de '+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+': '+FloatToStr(fTotal2)+'</b><br><br>'); // Ms e ano
      WriteLn(F,'<font face="verdana" size=1><b>Vendas no ms de '+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+': '+FloatToStr(fTotal1)+'</b><br><br>'); // Ms e ano
      //
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);                                    // Fecha o arquivo
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.ibDataset2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.Clientescontactadospordiaeporvendedor1Click(
  Sender: TObject);
var
  F: TextFile;
  MesInicial, I : Integer;
  fTotal1, fTotal2 : Real;
  dContador, dInicio, dFinal : TdateTime;
  //
  BlobStream : TStream;
  JP2    : TJPEGImage;
  //
  tInicio : tTime;
  //
begin
  //
  Form7.sModulo := 'CONTATOS';
  Form38.Panel5.Visible := True;
  Form38.Button2.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Panel5.Visible := False;
  Form38.Button2.Visible := True;
  //
  Form7.sModulo := 'CLIENTES';
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  tInicio := Time;
  //
  if Form38.Caption <> 'Cancelar' then
  begin
    //
    ShortDateFormat := 'dd/mm/yyyy';
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CLIENTES CONTACTADOS POR DIA')+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CLIENTES CONTACTADOS POR DIA</b></font>');
    WriteLn(F,'<br>');
    //
    Form7.IBDataSet2.DisableControls;
    Form7.ibDataSet3.DisableControls;
    //
    Form7.ibQuery3.Close;
    Form7.ibQuery3.SQL.Clear;
    Form7.ibQuery3.SQL.Add('select NOME from VENDEDOR order by NOME');
    Form7.ibQuery3.Open;
    //
    while not Form7.ibQuery3.Eof do
    begin
      //
      Form7.ibQuery2.Close;
      Form7.ibQuery2.SQL.Clear;
      Form7.ibQuery2.SQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%('+Form7.ibQuery3.FieldByname('NOME').AsString+')%''');
      Form7.ibQuery2.Open;
      //
      if Form7.ibQuery2.FieldByname('COUNT').AsFloat <> 0 then
      begin
        //
        Form7.Panel7.Caption := 'Analizando contatos do vendedor '+Form7.ibQuery3.FieldByname('NOME').AsString+'...';
        Form7.Panel7.Repaint;
        //
        WriteLn(F,'<table  border=0 style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        WriteLn(F,' <tr   align=left>');
        WriteLn(F,'  <td  >');
        /////////////////////////
        // C A L E N D A R I O //
        /////////////////////////
        dInicio :=  StrToDate('01'+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
        dFinal  :=  StrToDate(StrZero(DiasPorMes(Year(Form38.MonthCalendar1.Date),Month(Form38.MonthCalendar1.Date)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
        //
        WriteLn(F,'<font face="verdana" size=2><b>'+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+'</b><br><br>');              // Ms e ano
        WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Dom</font></th>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Seg</font></th>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Ter</font></th>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qua</font></th>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qui</font></th>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Sex</font></th>');
        WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Sab</font></th>');
        WriteLn(F,' </tr>');
        //
        WriteLn(F,' <tr  bgcolor=#FFFFFF>');
        //
        dContador  := DInicio - Day(dInicio) +1;
        MesInicial := Month(dInicio);
        //
        fTotal1 := 0;
        fTotal2 := 0;
        //
        for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
        while dContador <= dFinal + DiasPorMes(Year(dFinal),Month(dFinal)) - Day(dFinal) do
        begin
          //
          if Month(dContador) = MesInicial then
          begin
            if DayOfWeek(dContador) = 1 then WriteLn(F,' <tr  bgcolor=#FFFFFF>');
            if (dContador < dInicio) or (dContador > dFinal) then WriteLn(F,'   <td   nowrap   align=left valign=top width=70><font face="verdana" size=1 color=c0c0c0>'+IntToStr(Day(dContador))+'</td>') else WriteLn(F,'   <td   nowrap   align=left valign=top width=70><font face="verdana" size=1>'+IntToStr(Day(dContador)));
            //
            Form7.Panel7.Caption := 'Analizando contatos do vendedor '+Form7.ibQuery3.FieldByname('NOME').AsString+' do dia '+DateToStr(dContador)+'...';
            Form7.Panel7.Repaint;
            //
            Form7.ibQuery2.Close;
            Form7.ibQuery2.SQL.Clear;
            Form7.ibQuery2.SQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%('+Form7.ibQuery3.FieldByname('NOME').AsString+') '+StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0)+'%''');
            Form7.ibQuery2.Open;
            //
            Form7.ibQuery1.Close;
            Form7.ibQuery1.SQL.Clear;
            Form7.ibQuery1.SQL.Add('select sum(TOTAL) from VENDAS, ICM where EMITIDA=''S'' and EMISSAO='+QuotedStr(DateToStrInvertida(dContador))+' and VENDEDOR='+QuotedStr(Form7.ibQuery3.FieldByname('NOME').AsString)+' and ICM.NOME=VENDAS.OPERACAO and ICM.INTEGRACAO<>''''');
            Form7.ibQuery1.Open;
            //
            if (Form7.ibQuery2.FieldByname('COUNT').AsFloat <> 0) or (Form7.ibQuery1.FieldByname('SUM').AsFloat <> 0) then
            begin
              //
              WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#32CD32">'+FloatToStr(Form7.ibQuery2.FieldByname('COUNT').AsFloat)+'</center>');
              WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#FF0000">R$ '+Format('%14.2n',[Form7.ibQuery1.FieldByName('SUM').AsFloat])+'</center>');
              WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#1E90FF">&Sigma; '+Format('%14.2n',[Form7.ibQuery1.FieldByname('SUM').AsFloat/Form7.ibQuery2.FieldByname('COUNT').AsFloat])+'</center>');
              //
              fTotal2 := fTotal2 + Form7.ibQuery2.FieldByname('COUNT').AsFloat;
              fTotal1 := fTotal1 + Form7.ibQuery1.FieldByname('SUM').AsFloat;
              //
            end;
            //
            WriteLn(F,' </td>');
            if DayOfWeek(dContador) = 7 then WriteLn(F,' </tr>');
            dContador := SomaDias(dContador, 1);                // Incrementa o contador
            //
          end else
          begin
            MesInicial := Month(dContador);
            for I := DayOfWeek(dContador) to 7 do WriteLn(F,'   <td   nowrap   align=left><font face="verdana" size=1> </td>');
            WriteLn(F,' </tr>');
            WriteLn(F,'</table>');
            WriteLn(F,'<br>');
            WriteLn(F,'<br><font face="verdana" size=1><b>'+MesExtenso(Month(dContador))+' de '+IntToStr(Year(dInicio))+'</b>');              // Ms e ano
            WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
            WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Dom</font></th>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Seg</font></th>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Ter</font></th>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qua</font></th>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Qui</font></th>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1>Sex</font></th>');
            WriteLn(F,'  <th  nowrap><font face="verdana" size=1 color=FF0000>Sab</font></th>');
            WriteLn(F,' </tr>');
            //
            WriteLn(F,' <tr  bgcolor=#FFFFFF>');
            for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   nowrap  align=left><font face="verdana" size=1> </td>');
          end;
        end;
        //
        WriteLn(F,' </tr>');
        WriteLn(F,'</table>');
        WriteLn(F,' </td>');
        WriteLn(F,' <td  ><br><br>');
        //
        // Foto
        //
        Form7.ibDataSet2.Close;
        Form7.ibDataSet2.SelectSQL.Clear;
        Form7.ibDataSet2.SelectSQL.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibQuery3.FieldByname('NOME').AsString));
        Form7.ibDataSet2.Open;
        //
        if Form7.ibDataSet2FOTO.BlobSize <> 0 then
        begin
          BlobStream:= Form7.ibDataSet2.CreateBlobStream(Form7.ibDataSet2FOTO,bmRead);
          jp2 := TJPEGImage.Create;
          try
            jp2.LoadFromStream(BlobStream);
            Form10.Image5.Picture.Assign(jp2);
          finally
            BlobStream.Free;
            jp2.Free;
          end;
          //
        end
        else
          Form10.Image5.Picture := Form10.Image3.Picture;
        //
        Form10.Image5.Picture.SaveToFile('_t_'+Form7.ibDataSet2.FieldByName('REGISTRO').AsString+'.jpg');
        //
        if Form10.Image5.Picture.Width > Form10.Image5.Picture.Height then
        begin
          WriteLn(F,'<img src="'+'_t_'+Form7.ibDataSet2.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet2.FieldByName('NOME').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (200 / Form10.Image5.Picture.Width)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (200 / Form10.Image5.Picture.Width)),10,0)+'>');
        end else
        begin
          WriteLn(F,'<img src="'+'_t_'+Form7.ibDataSet2.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet2.FieldByName('REGISTRO').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (200 / Form10.Image5.Picture.Height)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (200 / Form10.Image5.Picture.Height)),10,0)+'>');
        end;
        //
        WriteLn(F,'   <br><font face="verdana" size=1>'+Form7.ibQuery3.FieldByname('NOME').AsString);              // Ms e ano
        WriteLn(F,'   <br><font face="verdana" size=1>Contatos: '+FloatToStr(fTotal2));
        WriteLn(F,'   <br><font face="verdana" size=1>Vendas: '+FloatToStr(fTotal1)); // Ms e ano
        WriteLn(F,'  </td>');
        WriteLn(F,' </tr>');
        WriteLn(F,'</table>');
        WriteLn(F,'<br>');
        //
      end;
      //
      Form7.ibQuery3.Next;
      //
    end;
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center>Tempo para gerar este relatrio: '+TimeToStr(Time - tInicio)+'</center>');
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);                                    // Fecha o arquivo
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.ibDataset2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.IBDataSet2BeforePost(DataSet: TDataSet);
begin
  //
  if Form7.sWhere  = 'where CLIFOR='+QuotedStr('Vendedor') then
  begin
    if AllTrim(Form7.IBDataSet2CLIFOR.AsString) = '' then Form7.IBDataSet2CLIFOR.AsString := 'Vendedor';
  end;
  //
  if Form7.IBDataSet2CLIFOR.AsString = 'Vendedor' then
  begin
    //
    Form7.ibDataSet9.Close;                                                    //
    Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
    Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME=:NOME'); //
    Form7.ibDataSet9.DataSource := DataSource2;
    Form7.ibDataSet9.Open;
    //
    if AllTrim(Form7.ibDataSet9NOME.AsString) <> AllTrim(Form7.IBDataSet2NOME.AsString) then
    begin
      try
        Form7.ibDataSet9.Append;
        Form7.IBDataSet9NOME.AsString   := Form7.IBDataSet2NOME.AsString;
        Form7.IBDataSet9FUNCAO.AsString := 'VENDEDOR';
        Form7.ibDataSet9.Post;
      except end;
    end else
    begin
      try
        Form7.ibDataSet9.Edit;
        Form7.IBDataSet9FUNCAO.AsString := 'VENDEDOR';
        Form7.ibDataSet9.Post;
      except end;
    end;
  end;
  //
end;

procedure TForm7.Button10Click(Sender: TObject);
var
  I : Integer;
  f: TextFile;
  sMensagem, sLinha : String;
begin
  //
  if not Form7.OpenDialog4.Execute then Exit;
  //
  if FileExists(Form7.OpenDialog4.FileName) then
  begin
    //
    AssignFile(f,Form7.OpenDialog4.FileName);
    Reset(f);
    //
    Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
    sMensagem := '';
    I := 0;
    //
    while not eof(f) Do
    begin
      //
      ReadLn(f,sLinha);
      //
      if (Copy(sLinha,001,001) = '0') and (Copy(sLinha,003,007) = 'RETORNO') then // 03 Identificao Tipo de Operao RETORNO
      begin
        //
        // HEADER
        //
        //   Copy(sLinha,001,001); // 01 Identificao do Registro Header: 0
        //   Copy(sLinha,002,001); // 02 Tipo de Operao: 2
        //   Copy(sLinha,003,007); // 03 Identificao Tipo de Operao RETORNO
        //   Copy(sLinha,010,002); // 04 Identificao do Tipo de Servio: 01
        //   Copy(sLinha,012,008); // 05 Identificao por Extenso do Tipo de Servio:COBRANA
        //   Copy(sLinha,020,007); // 06 Complemento do Registro: Brancos
        //   Copy(sLinha,027,004); // 07 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,031,001); // 08 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,032,008); // 09 Cdigo do Cliente/Beneficirio: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,040,001); // 10 Dgito Verificador do Cdigo: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,041,006); // 11 Nmero do convnio lder: Brancos
        //   Copy(sLinha,047,030); // 12 Nome do Beneficirio
        //   Copy(sLinha,077,018); // 13 Identificao do Banco: "756BANCOOBCED"
        //   Copy(sLinha,095,006); // 14 Data da Gravao do Retorno: formato ddmmaa
        //   Copy(sLinha,101,007); // 15 Seqencial do Retorno: nmero seqencial atribudo pelo Sicoob, acrescido de 1 a cada retorno. Inicia com "0000001"
        //   Copy(sLinha,108,287); // 16 Complemento do Registro: Brancos
        //   Copy(sLinha,395,006); // 17 Seqencial do Registro:000001
        //
        sMensagem := sMensagem + 'Arquivo processado com sucesso.' + chr(10)+chr(10);
        //
      end;
      //
      if (Copy(sLinha,001,001) = '1') then // and (Copy(sLinha,004,014) = cnpj do emitente) then // 03 Nmero do CPF/CNPJ do Beneficirio
      begin
        //
        // Copy(sLinha,001,001); // 01 Identificao do Registro Detalhe: 1 (um)
        // Copy(sLinha,002,002); // 02 "Tipo de Inscrio do Beneficirio: ""01"" = CPF ""02"" = CNPJ  "
        // Copy(sLinha,004,014); // 03 Nmero do CPF/CNPJ do Beneficirio
        // Copy(sLinha,018,004); // 04 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
        // Copy(sLinha,022,001); // 05 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
        // Copy(sLinha,023,008); // 06 Conta Corrente: vide planilha "Capa" deste arquivo
        // Copy(sLinha,031,001); // 07 Dgito Verificador da Conta: vide planilha "Capa" deste arquivo
        // Copy(sLinha,032,006); // 08 Nmero do Convnio de Cobrana do Beneficirio: "000000"
        // Copy(sLinha,038,025); // 09 Nmero de Controle do Participante: Brancos
        // Copy(sLinha,063,011); // 10 Nosso Nmero
        // Copy(sLinha,074,001); // 11 DV Nosso Nmero
        // Copy(sLinha,075,002); // 12 Nmero da Parcela
        // Copy(sLinha,077,004); // 13 Grupo de Valor: "00"
        // Copy(sLinha,081,002); // 14 Cdigo de Baixa/Recusa
        // Copy(sLinha,083,003); // 15 "Prefixo do Ttulo: Informa Espcie do Ttulo DM = Duplicata Mercantil CH = Cheque DS = Duplicata de Servio PC  = Parcela de Consrcio OU = Outros"
        // Copy(sLinha,086,003); // 16 Variao da Carteira: "000"
        // Copy(sLinha,089,001); // 17 Conta Cauo: "0"
        // Copy(sLinha,090,005); // 18 Cdigo de responsabilidade: "00000"
        // Copy(sLinha,095,001); // 19 DV do cdigo de responsabilidade: "0"
        // Copy(sLinha,096,005); // 20 Taxa de desconto
        // Copy(sLinha,101,005); // 21 Taxa de IOF
        // Copy(sLinha,106,001); // 22 Complemento do Registro: Brancos
        // Copy(sLinha,107,002); // 23 "Carteira/Modalidade: 01 = Simples Com Registro 02 = Simples Sem Registro 03 = Garantida Caucionada
        // Copy(sLinha,109,002); // 24 Comando/Movimento: 02 = Confirmao Entrada Ttulo;
        // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
        // Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
        // Copy(sLinha,127,020); // 27 Complemento do Registro: Brancos
        // Copy(sLinha,147,006); // 28 Data Vencimento Ttulo: formato ddmmaa
        // Copy(sLinha,153,013); // 29 Valor Titulo
        // Copy(sLinha,166,003); // 30 Cdigo do banco recebedor: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
        // Copy(sLinha,169,004); // 31 Prefixo da agncia recebedora: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
        // Copy(sLinha,173,001); // 32 DV prefixo recebedora
        // Copy(sLinha,174,002); // 33 "Espcie do Ttulo : 01 = Duplicata Mercantil
        // Copy(sLinha,176,006); // 34 Data do crdito: formato ddmmaa
        // Copy(sLinha,182,007); // 35 Valor da Tarifa
        // Copy(sLinha,189,013); // 36 Outras despesas
        // Copy(sLinha,202,013); // 37 Juros do desconto
        // Copy(sLinha,215,013); // 38 IOF do desconto
        // Copy(sLinha,228,013); // 39 Valor do abatimento
        // Copy(sLinha,241,013); // 40 Desconto concedido (diferena entre valor do ttulo e valor recebido)
        // Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
        // Copy(sLinha,267,013); // 42 Juros de Mora
        // Copy(sLinha,280,013); // 43 Outros recebimentos
        // Copy(sLinha,293,013); // 44 Abatimento no aproveitado pelo Pagador
        // Copy(sLinha,306,013); // 45 Valor do Lanamento
        // Copy(sLinha,319,001); // 46 Indicativo dbito/crdito
        // Copy(sLinha,320,001); // 47 Indicativo valor
        // Copy(sLinha,321,012); // 48 Valor do Ajuste
        // Copy(sLinha,333,010); // 49 Complemento do Registro: Brancos
        // Copy(sLinha,343,014); // 50 CPF/CNPJ do Pagador
        // Copy(sLinha,358,038); // 51 Complemento do Registro: Brancos
        // Copy(sLinha,395,006); // 52 Seqencial do Registro: Incrementado em 1 a cada registro
        //
        // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
        //
        if Copy(sLinha,109,002) = '06' then // 24 Comando/Movimento: 06 = Liquidao Normal
        begin
          //
          if Copy(sLinha,254,013) <> '0000000000000' then // 41 Valor recebido (valor recebido parcial)
          begin
  //        Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
  //        Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
  //
  //Form7.ibDataset7NOSSONUM.AsString
  //           Copy(sLinha,117,009)+asdfasdf
            sMensagem := sMensagem + 'Nmero documento: ' + Copy(sLinha,117,010) + ' Valor: R$ '+  FloatToStr(StrToFloat(Copy(sLinha,254,013))/100);
            if Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Copy(sLinha,117,010)),[]) then
            begin
              //
              if Form7.ibDataSet7ATIVO.AsFloat < 5 then
              begin
                //
                //
                if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                begin
                  //
                  Form7.SMALL_DBEdit1.Visible := True;
                  Form7.Edit2.Text            := Form7.SMALL_DBEdit2.Text;
                  //
                  Form7.ibDataSet7.Edit;
                  Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
  //                Form7.ibDataSet7VALOR_RECE.AsFloat := Form7.ibDataSet7VALOR_DUPL.AsFloat;
                  Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,254,013))/100;
                  //
                  Form7.ibDataSet7.Post;
                  //
                  Form1.IBDataSet200.Close;
                  Form1.IBDataSet200.Open;
                  //
                  Form7.ibQuery1.Close;
                  Form7.IBQuery1.SQL.Clear;
                  Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
                  Form7.IBQuery1.Open;
                  //
                  Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
                  Form7.Panel10.Repaint;
                  //
                  Form7.ibDataSet25DIFERENCA_.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat +  StrToFloat(Copy(sLinha,254,013))/100;
                  //
                  SMALL_DBEdit1.SetFocus;
                  I := I + 1;
                  //
                end else
                begin
                  sMensagem := sMensagem + ' documento j estava quitado. ';
                end;
              end else
              begin
                sMensagem := sMensagem + ' documento j estava marcado. ';
              end;
              //
              sMensagem := sMensagem + chr(10);
              //
            end else
            begin
              //
              sMensagem := sMensagem + ' documento no encontrado '+chr(10);
              //
            end;
          end;
        end;
      end;
      //
      // Fim
      //
    end;
    //
    CloseFile(F);
    //
//    if Form7.ibDataSet25DIFERENCA_.AsFloat <> 0 then
    begin
      //
      sMensagem := sMensagem + chr(10) + chr(10) +
      'Duplicatas recebidos: '+ IntToStr(I )+chr(10)+chr(10) +
      'Total recebido R$: '+Form7.ibDataSet25DIFERENCA_.AsString+chr(10)+chr(10);
      //
      ShowMessage(sMensagem);
    end;
    //
    Form7.SMALL_DBEdit6.SetFocus;
    //
  end;
  //
end;

procedure TForm7.Label202MouseLeave(Sender: TObject);
begin
  if Form7.Label202.Font.Style <> [] then
  begin
    Form7.Image202.Picture    := Form7.Image202_R.Picture;
    Form7.Label202.Font.Style := [];
  end;
end;

procedure TForm7.Label203MouseLeave(Sender: TObject);
begin
  if Form7.Label203.Font.Style <> [] then
  begin
    Form7.Image203.Picture    := Form7.Image203_R.Picture;
    Form7.Label203.Font.Style := [];
  end;
end;

procedure TForm7.Label205MouseLeave(Sender: TObject);
begin
  if Form7.Label205.Font.Style <> [] then
  begin
    Form7.Image205.Picture    := Form7.Image205_R.Picture;
    Form7.Label205.Font.Style := [];
  end;
end;

procedure TForm7.Label204MouseLeave(Sender: TObject);
begin
  if Form7.Label204.Font.Style <> [] then
  begin
    Form7.Image204.Picture    := Form7.Image204_R.Picture;
    Form7.Label204.Font.Style := [];
  end;
end;

procedure TForm7.Label206MouseLeave(Sender: TObject);
begin
  if Form7.Label206.Font.Style <> [] then
  begin
    Form7.Image206.Picture    := Form7.Image206_R.Picture;
    Form7.Label206.Font.Style := [];
  end;
end;

procedure TForm7.Label208MouseLeave(Sender: TObject);
begin
  if Form7.Label208.Font.Style <> [] then
  begin
    Form7.Image208.Picture    := Form7.Image208_R.Picture;
    Form7.Image308.Picture    := Form7.Image308_R.Picture;
    Form7.Label208.Font.Style := [];
  end;
end;

procedure TForm7.Label209MouseLeave(Sender: TObject);
begin
  if Form7.Label209.Font.Style <> [] then
  begin
    Form7.Image209.Picture    := Form7.Image209_R.Picture;
    Form7.Label209.Font.Style := [];
  end;
end;

procedure TForm7.Label202MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label202.Font.Style <> [fsBold] then
  begin
    Form7.Image202.Picture    := Form7.Image202_X.Picture;
    Form7.Label202.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label203MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label203.Font.Style <> [fsBold] then
  begin
    Form7.Image203.Picture    := Form7.Image203_X.Picture;
    Form7.Label203.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label205MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label205.Font.Style <> [fsBold] then
  begin
    Form7.Image205.Picture    := Form7.Image205_X.Picture;
    Form7.Label205.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label204MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label204.Font.Style <> [fsBold] then
  begin
    Form7.Image204.Picture    := Form7.Image204_X.Picture;
    Form7.Label204.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label206MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label206.Font.Style <> [fsBold] then
  begin
    Form7.Image206.Picture    := Form7.Image206_X.Picture;
    Form7.Label206.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label208MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label208.Font.Style <> [fsBold] then
  begin
    Form7.Image208.Picture    := Form7.Image208_X.Picture;
    Form7.Image308.Picture    := Form7.Image308_X.Picture;
    Form7.Label208.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label209MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label209.Font.Style <> [fsBold] then
  begin
    Form7.Image209.Picture    := Form7.Image209_X.Picture;
    Form7.Label209.Font.Style := [fsBold];
  end;
end;

procedure TForm7.ibDataSet23QTD_ORIGINALChange(Sender: TField);
begin
  //
  // converter unidades de medida na nota de compra
  //
  try
    if (Form7.ProdutoOld.sDescricao  <> Form7.ibDataSet23DESCRICAO.AsString) or
       (Form7.ProdutoOld.sQuantidade <> Form7.ibDataSet23QTD_ORIGINAL.AsString) or
       (Form7.ProdutoOld.sUnitario   <> Form7.ibDataSet23UNITARIO_O.AsString) or
       bMudei then
    begin
      bMudei := False;
      //
      if not (Form7.ibDataset23.State in ([dsEdit, dsInsert])) then Form7.ibDataset23.Edit;
      //
      if (Form7.ibDataSet4FATORC.AsFloat = 0) or (Form7.ibDataSet4FATORC.AsFloat = 1) then
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := Form7.ibDataSet23QTD_ORIGINAL.AsFloat;
        Form7.ibDataSet23UNITARIO.AsFloat   := Form7.ibDataSet23UNITARIO_O.AsFloat;
      end else
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := (Form7.ibDataSet23QTD_ORIGINAL.AsFloat * Form7.ibDataSet4FATORC.AsFloat);
        Form7.ibDataSet23UNITARIO.AsFloat   := (Form7.ibDataSet23UNITARIO_O.AsFloat / Form7.ibDataSet4FATORC.AsFloat);
      end;
      //
      Form7.ProdutoOld.sDescricao  := Form7.ibDataSet23DESCRICAO.AsString;
      Form7.ProdutoOld.sQuantidade := Form7.ibDataSet23QTD_ORIGINAL.AsString;
      Form7.ProdutoOld.sUnitario   := Form7.ibDataSet23UNITARIO_O.AsString;
    end;
  except end;  
end;

procedure TForm7.ibDataSet23UNITARIO_OChange(Sender: TField);
begin
  //
  // converter unidades de medida na nota de compra
  //
  try
    if (Form7.ProdutoOld.sDescricao  <> Form7.ibDataSet23DESCRICAO.AsString) or
       (Form7.ProdutoOld.sQuantidade <> Form7.ibDataSet23QTD_ORIGINAL.AsString) or
       (Form7.ProdutoOld.sUnitario   <> Form7.ibDataSet23UNITARIO_O.AsString) or
       bMudei then
    begin
      bMudei := False;
      if (Form7.ibDataSet4FATORC.AsFloat = 0) or (Form7.ibDataSet4FATORC.AsFloat = 1) then
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := Form7.ibDataSet23QTD_ORIGINAL.AsFloat;
        Form7.ibDataSet23UNITARIO.AsFloat   := Form7.ibDataSet23UNITARIO_O.AsFloat;
      end else
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := (Form7.ibDataSet23QTD_ORIGINAL.AsFloat * Form7.ibDataSet4FATORC.AsFloat);
        Form7.ibDataSet23UNITARIO.AsFloat   := (Form7.ibDataSet23UNITARIO_O.AsFloat / Form7.ibDataSet4FATORC.AsFloat);
      end;
      Form7.ProdutoOld.sDescricao  := Form7.ibDataSet23DESCRICAO.AsString;
      Form7.ProdutoOld.sQuantidade := Form7.ibDataSet23QTD_ORIGINAL.AsString;
      Form7.ProdutoOld.sUnitario   := Form7.ibDataSet23UNITARIO_O.AsString;
      //
    end;
  except end;
  //
end;

procedure TForm7.ibDataSet23AfterScroll(DataSet: TDataSet);
begin
  Form7.ProdutoOld.sDescricao  := Form7.ibDataSet23DESCRICAO.AsString;
  Form7.ProdutoOld.sQuantidade := Form7.ibDataSet23QTD_ORIGINAL.AsString;
  Form7.ProdutoOld.sUnitario   := Form7.ibDataSet23UNITARIO_O.AsString;
end;

procedure TForm7.Emaildecobrana2Click(Sender: TObject);
var
  sSecoes :  TStrings;
  sParcelas, sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, II, YY, J : Integer;
  sMandados : String;
  MyBookMark1 : TBookMark;
  PDF: TPrintPDF;
  sArquivoPDF: String; // Sandro Silva 2022-12-22

begin
  //
  Form40.Tag := 9;
  Form40.CheckBox1.Visible := True;
  Form40.ShowModal;
  //
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail de cobrana para os clientes' + chr(10) +
              Chr(10) + 'filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    try
      //
      if bButton = IDYES then
      begin
        //
        I := 0;
        Form7.ibDataSet7.First;
        //
        // Retorna onde parou
        //
        Mais1ini := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;
        //
        if sRegistro <> 'FIM' then
        begin
          //
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          //
          if bButton = IDYES then
          begin
            //
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
          end else
          begin
            sMandados := '';
          end;
          //
        end;
        //
        Mais1ini.Free;
        Screen.Cursor            := crHourGlass;
        //
        YY := 0;
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          if (Pos(Form7.ibDataSet7NOME.AsString,sMandados)=0) and (Form7.ibDataSet7ATIVO.AsFloat=0) then
          begin
            try
              //
              //                                                                    //
              // Relaciona os clientes com o arquivo de vendas                     //
              //                                                                  //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                //
                sArquivo := '';
                sArquivoPDF := Form1.sAtual+'\boletos_' + LimpaNumero(Form7.IBDataSet2CGC.AsString) + '.pdf'; // Sandro Silva 2022-12-22
                //
                if Form7.sModulo = 'RECEBER' then
                begin
                  //
                  if Form40.CheckBox1.Checked then
                  begin
                    //
                    while FileExists(sArquivoPDF) do  // Sandro Silva 2022-12-22 while FileExists(Form1.sAtual+'\boletos.pdf') do
                    begin
                      DeleteFile(pChar(sArquivoPDF)); // Sandro Silva 2022-12-22 DeleteFile(pChar(Form1.sAtual+'\boletos.pdf'));
                      Sleep(1000);
                    end;
                    //
                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;
                    //
                    try
                      //
                      // Grava o local para voltar
                      //
                      MyBookMark1 := Form7.ibDataSet7.GetBookMark();
                      //
                      // Cria o PDF
                      //
                      // Sandro Silva 2022-12-22 sDocParaGerarPDF := Copy(AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'XXXXXXXXX',1,9);
                      PDF := TPrintPDF.Create(Self);
                      //
                      // Configuraes do documento
                      //
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;
                      //
                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := sArquivoPDF;// sFileCFeSAT; // Sandro Silva 2022-12-22 PDF.FileName    := Form1.sAtual+'\boletos.pdf';// sFileCFeSAT;
                      {Start Printing...}
                      PDF.BeginDoc;
                      //
                      Form7.ibDataSet7.First;
                      while not Form7.ibDataSet7.Eof do
                      begin

                        if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                        begin
                          if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                          begin
                            if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                            begin
                              //
                              while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                              begin
                                DeleteFile(pChar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg'));
                                Sleep(1000);
                              end;
                              //
                              Form1.sEscolhido := '';
                              //
                              try
                                //
                                sSecoes := TStringList.Create;
                                Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                Mais1Ini.ReadSections(sSecoes);
                                //
                                for J := 0 to (sSecoes.Count - 1) do
                                begin
                                  if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                   or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                  and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                    or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                  begin
                                    Form1.sEscolhido := sSecoes[J];
                                  end;
                                end;
                                //
                                Mais1Ini.Free;
                                //
                              except
                              end;
                              //
                              if (AllTrim(Form1.sEscolhido) <> '') or (Form1.DisponivelSomenteParaNos) then // Sandro Silva 2022-12-22 if AllTrim(Form1.sEscolhido) <> '' then
                              begin
                                //
                                Form25.Show; // Em Form7.Emaildecobrana2Click()

                                {Sandro Silva 2022-12-23 inicio}
                                if Form1.DisponivelSomenteParaNos then
                                begin
                                  //GeraImagemDoBoletoComOCodigoDeBarras(False); // Para calcular cdigo de barras, nosso numero
                                  {Sandro Silva 2023-01-24 inicio 
                                  Form25.GravaPortadorNossoNumCodeBar;
                                  }
                                  if UpperCase(Copy(AllTrim(Form7.ibDataSet7PORTADOR.AsString),1,7)) <> 'BANCO (' then
                                  begin
                                    Form25.GravaPortadorNossoNumCodeBar;
                                  end;
                                  {Sandro Silva 2023-01-24 fim}
                                end;
                                {Sandro Silva 2022-12-23 fim}

                                Form7.Repaint;
                                //
                                while not FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                begin
                                  Sleep(1000);
                                end;
                                //
                                // Print Image
                                //
                                YY := YY + 1;
                                if YY >= 2 then
                                  PDF.NewPage; // Add New Page
                                //
                                PDF.DrawJPEG(0, 0, Form25.Image2.Picture.Bitmap);
                                //
                                // PDF.DrawBitmap(0,0, Form25.Image2.Picture.Bitmap);
                                //
                              end;
                            end;
                          end;
                        end;
                        //
                        Screen.Cursor            := crHourGlass;
                        Form7.ibDataSet7.Next;
                        Form25.Close;
                        Form7.Repaint;
                        //
                      end;
                      //
                      Form7.ibDataSet7.GotoBookmark(MyBookMark1);
                      //
                      PDF.EndDoc;
                      if FileExists(sArquivoPDF) then // Sandro Silva 2022-12-22 if FileExists(Form1.sAtual+'\boletos.pdf') then
                        sArquivo := sArquivoPDF // Sandro Silva 2022-12-22 sArquivo := Form1.sAtual + '\boletos.pdf'
                      else
                        sArquivo := '';
                      //
                    except
                    end;
                    //
                    Form25.Close;
                    Form7.Repaint;
                    //
                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                    //
                    // Fecha o pdf
                    //
                  end;
                end;
                //
                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                //
                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
                //
                sMsg := Form40.Memo1.Lines.Text;
                //
                // CLIENTES
                //
                if I <> 0 then
                begin
                  for II := 1 to 700 do
                  begin
                    //
                    try
                      Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
                    except end;
                    //
                    Application.ProcessMessages;
                    //
                  end;
                end;
                //
                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                //
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));
                //
                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<PARCELAS_VENCIDAS>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select * from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' order by VENCIMENTO');
                  Form7.ibQuery1.Open;
                  //
                  sParcelas := '';
                  //
                  while not Form7.ibQuery1.eof do
                  begin
                    sParcelas := sParcelas +
                                'Documento: '+Copy(Form7.ibQuery1.fieldByname('DOCUMENTO').AsString   +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Emisso: '+Copy(Form7.ibQuery1.fieldByname('EMISSAO').AsString     +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Vencimento: '+Copy(Form7.ibQuery1.fieldByname('VENCIMENTO').AsString  +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Valor: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_DUPL').AsFloat])+Replicate(' ',10),1,10)+' '+chr(10)+
                                'Atualizado: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_JURO').AsFloat])+Replicate(' ',10),1,10)+chr(10)+
                                IfThen(Trim(Form7.ibQuery1.fieldByname('CODEBAR').AsString) <> '', 'Cdigo de barras: '+Form7.ibQuery1.fieldByname('CODEBAR').AsString, '')+chr(10)+chr(10)// Sandro Silva 2023-02-10
                                ;
                    //
                    Form7.ibQuery1.Next;
                  end;
                  //
                  sMsg := StrTran(sMsg,'<PARCELAS_VENCIDAS>'    ,sParcelas);
                  //
                end;
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<TOTAL_ATRASADO>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_DUPL) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATRASADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                if Pos('<TOTAL_ATUALIZADO>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_JURO) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATUALIZADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                EnviarEMail('',sEmail,'',sAssunto,sMSG,sArquivo, False);
                //
                I := I + 1;
                //
                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;
                //
                //
                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;
                //
                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
                Form7.Panel1.Repaint;
                //
              end;
              //
              sMandados := sMandados + Form7.ibDataSet7NOME.AsString;
              //
            except end;
            //
         end;
         //
         Form7.ibDataSet7.Next;
         //
        end;
      end;
      //
    except end;
    //
    Screen.Cursor            := crDefault;
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
  end;
  //
end;

procedure TForm7.FormMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.Panel4MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.Panel_0MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.DBGrid1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.IBDataSet6AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet6AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet6BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CODEBAR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.IBDataSet6NewRecord(DataSet: TDataSet);
begin
  ibDataSet6REGISTRO.AsString := sProximo;
end;

procedure TForm7.AnliseAnualdascontas1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  I : Integer;
  F: TextFile;
begin
  //
  Form7.ibDataSet1.DisableControls;
  //
  try
    //
    CriaJpg('logotip.jpg');
    //
    ShortDateFormat := 'dd/mm/yyyy';
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE ANUAL</b></font>');
    WriteLn(F,'<br><center>');   // Linha em branco
    WriteLn(F,'<br>');           // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo

    //
    // Faturamento
    //
    DeleteFile(pChar(Form1.sAtual+'\faturamento.gra'));
    DeleteFile(pChar(Form1.sAtual+'\faturamento.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //

    Mais1ini := TIniFile.Create(Form1.sAtual+'\faturamento.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','faturamento.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Receita');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    Form1.ibQuery1.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as FATURAMENTO, extract(year from CAIXA.DATA) as ANO from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=1 and CAIXA.NOME=CONTAS.NOME group by extract(year from CAIXA.DATA) order by extract(year from CAIXA.DATA)');
    Form1.ibQuery1.Open;
    //
    I := 0;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+Form1.ibQuery1.FieldByName('ANO').AsString+'>');
      Form1.ibQuery1.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','faturamento.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\faturamento.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\faturamento.png"><img src="faturamento.png" border="0" width=500 height=250></a>');
    //

    //
    // Despesas
    //
    DeleteFile(pChar(Form1.sAtual+'\despesas.gra'));
    DeleteFile(pChar(Form1.sAtual+'\despesas.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\despesas.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','despesas.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Despesa');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery2.Close;
    Form1.ibQuery2.SQL.Clear;
    Form1.ibQuery2.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as despesas, extract(year from CAIXA.DATA) as ANO from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=3 and CAIXA.NOME=CONTAS.NOME group by extract(year from CAIXA.DATA) order by extract(year from CAIXA.DATA)');
    Form1.ibQuery2.Open;
    //
    I := 0;
    //
    while not Form1.ibQuery2.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+Form1.ibQuery2.FieldByName('ANO').AsString+'>');
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','despesas.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\despesas.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\despesas.png"><img src="despesas.png" border="0" width=500 height=250></a>');
    //
    // Lucro
    //
    DeleteFile(pChar(Form1.sAtual+'\lucro.gra'));
    DeleteFile(pChar(Form1.sAtual+'\lucro.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\lucro.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','lucro.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Lucro');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','Anos');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    I := 0;
    //
    Form1.ibQuery1.First;
    Form1.ibQuery2.First;
    //
    while not Form1.ibQuery1.Eof do
    begin
      //
      I := I + 1;
      //
      if Form1.ibQuery2.FieldByName('ANO').AsString = Form1.ibQuery1.FieldByName('ANO').AsString then
      begin
        Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                     'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'VX<'+StrZero(I,2,0)+'>LX<'+Form1.ibQuery1.FieldByName('ANO').AsString+'>');
      end;
      //
      Form1.ibQuery1.Next;
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','lucro.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\lucro.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\lucro.png"><img src="lucro.png" border="0" width=500 height=250></a>');
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
    //
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  //
end;

procedure TForm7.Clientescontactadospormsporvendedor1Click(
  Sender: TObject);
var
  //
  F: TextFile;
  III : Integer;
  ftotalContatos, fTotal, fTotal1, fTotal2, fTotal3 : Real;
  dInicio, dFinal : TdateTime;
  //
  BlobStream : TStream;
  JP2    : TJPEGImage;
  //
  tInicio : tTime;
  mais2ini, Mais1ini : tIniFile;
  //
begin
  //
  Form7.IBDataSet2.DisableControls;
  //
  try
    //
    Form7.sModulo := 'CONTATOS';
    Form38.Panel5.Visible := True;
    Form38.Button2.Visible := True;
    Form38.ShowModal; // Ok
    Form38.Panel5.Visible := False;
    Form38.Button2.Visible := True;
    //
    Form7.sModulo := 'CLIENTES';
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    tInicio := Time;
    //
    if Form38.Caption <> 'Cancelar' then
    begin
      //
      ShortDateFormat := 'dd/mm/yyyy';
      //
      AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
      Rewrite(F);                           // Abre para gravao
      Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CLIENTES CONTACTADOS POR MS')+'</title></head>');
      WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
      WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
      WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
      //
      WriteLn(F,'<br>');              // Linha em branco
      WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CLIENTES CONTACTADOS POR MS</b></font>');
      WriteLn(F,'<br>');
      //
      try
        //
//        dInicio := StrToDate('01/'+StrZero( Month( Form38.MonthCalendar1.Date - DiasDesteMes ),2,0)+'/'+StrZero(Year(Form38.MonthCalendar1.Date-DiasDesteMes),4,0));
//        dFinal  := StrToDate(StrZero(DiasPorMes(Year( Form38.MonthCalendar1.Date -DiasDesteMes),Month(Form38.MonthCalendar1.Date-DiasDesteMes)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date-DiasDesteMes),3,8));
        //
        dInicio := StrToDate('01/'+StrZero(Month(Form38.MonthCalendar1.Date),2,0)+'/'+StrZero(Year(Form38.MonthCalendar1.Date),4,0));
        dFinal  := StrToDate(StrZero(DiasDesteMes,2,0)+'/'+StrZero(Month(Form38.MonthCalendar1.Date),2,0)+'/'+StrZero(Year(Form38.MonthCalendar1.Date),4,0));
        //
        fTotal  := 0;
        ftotalContatos := 0;
        //
        // GRAFICO
        //
        DeleteFile(pChar(Form1.sAtual+'\vendedores.png'));
        DeleteFile(pChar(Form1.sAtual+'\vendedores.gra'));
        DeleteFile(pChar(Form1.sAtual+'\contatos.png'));
        DeleteFile(pChar(Form1.sAtual+'\contatos.gra'));
        //                            //
        // cria o grfico vendedores //
        //                          //
        Mais1ini := TIniFile.Create(Form1.sAtual+'\vendedores.gra');
        //
        // Titulo
        //
        Mais1Ini.WriteString('DADOS','3D','1');
        Mais1Ini.WriteString('DADOS','MarcasS1','1');
        Mais1Ini.WriteString('DADOS','Legenda','0');
        Mais1Ini.WriteString('DADOS','TipoS1','4');
        Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
        Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
        //
        Mais1Ini.WriteString('DADOS','Titulo','');
        Mais1Ini.WriteString('DADOS','NomeBmp','vendedores.png');
        //
        // GRAFICO
        //
        DeleteFile(pChar(Form1.sAtual+'\contatos.png'));
        DeleteFile(pChar(Form1.sAtual+'\contatos.gra'));
        //                                                //
        // cria o grfico de fluxo de caixa contatos.png //
        //                                              //
        mais2ini := TIniFile.Create(Form1.sAtual+'\contatos.gra');
        //
        // Titulo
        //
        mais2Ini.WriteString('DADOS','3D','1');
        mais2Ini.WriteString('DADOS','MarcasS1','1');
        mais2Ini.WriteString('DADOS','Legenda','0');
        mais2Ini.WriteString('DADOS','TipoS1','4');
        mais2Ini.WriteString('DADOS','AlturaBmp','1000');
        mais2Ini.WriteString('DADOS','LarguraBmp','2000');
        //
        mais2Ini.WriteString('DADOS','Titulo','');
        mais2Ini.WriteString('DADOS','NomeBmp','contatos.png');
        //
        WriteLn(F,'<center>');
        WriteLn(F,'<table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        WriteLn(F,' <tr  bgcolor=#'+Form1.sHtmlCor+'   align=left>');
        WriteLn(F,'  <th nowrap><font face="Microsoft Sans Serif" size=1>Foto</font></th>');
        WriteLn(F,'  <th nowrap><font face="Microsoft Sans Serif" size=1>Vendedor</font></th>');
        WriteLn(F,'  <th nowrap><font face="Microsoft Sans Serif" size=1>Valor</font></th>');
        WriteLn(F,'  <th nowrap><font face="Microsoft Sans Serif" size=1>Contatos</font></th>');
        WriteLn(F,' </tr>');
        //
        Form7.IBDataSet99.Close;
        Form7.IBDataSet99.SelectSQL.Clear;
        Form7.IBDataSet99.SelectSQL.Add('select VENDEDOR, sum(MERCADORIA+SERVICOS-DESCONTO) from VENDAS, ICM where EMITIDA=''S'' and EMISSAO<='+QuotedStr(DateToStrInvertida(dFinal))+' and EMISSAO>='+QuotedStr(DateToStrInvertida(dInicio))+' and ICM.NOME=VENDAS.OPERACAO and ICM.INTEGRACAO<>'''' group by VENDEDOR');
        Form7.IBDataSet99.Open;
        Form7.IBDataSet99.First;
        //
        Form7.ibDataSet99.First;
        //
        Form7.IBDataSet100.Close;
        Form7.IBDataSet100.SelectSQL.Clear;
        Form7.IBDataSet100.SelectSQL.Add('select VENDEDOR, sum(TOTAL) from ALTERACA where DATA<='+QuotedStr(DateToStrInvertida(dFinal))+' and DATA>='+QuotedStr(DateToStrInvertida(dInicio))+' and (TIPO='+QuotedStr('BALCAO')+' or TIPO='+QuotedStr('VENDA')+') group by VENDEDOR');
        Form7.IBDataSet100.Open;
        Form7.IBDataSet100.First;
        //
        III := 0;
        //
        Form7.ibDataSet99999.Close;
        Form7.ibDataSet99999.SelectSQL.Clear;
        Form7.ibDataSet99999.SelectSQL.Add('select NOME, FOTO, REGISTRO from CLIFOR where Upper(CLIFOR)='+QuotedStr('VENDEDOR')+' order by upper(NOME)');
        Form7.ibDataSet99999.Open;
        Form7.ibDataSet99999.First;
        //
        Form7.ibDataSet99999.First;
        //
        while not Form7.ibDataSet99999.EOF do
        begin
          //
          Application.ProcessMessages;
          //
          //
          Form7.IBDataSet99.Locate('VENDEDOR',Form7.ibDataSet99999.FieldByname('NOME').AsString,[]);
          Form7.IBDataSet100.Locate('VENDEDOR',Form7.ibDataSet99999.FieldByname('NOME').AsString,[]);
          //
          if AllTrim(Form7.ibDataSet99999.FieldByName('NOME').AsString) = AllTrim(Form7.ibDataSet99.FieldByName('VENDEDOR').AsString) then fTotal1 := Form7.ibDataSet99.FieldByname('SUM').AsFloat else  fTotal1 := 0;
          if AllTrim(Form7.ibDataSet99999.FieldByName('NOME').AsString) = AllTrim(Form7.ibDataSet100.FieldByName('VENDEDOR').AsString) then fTotal2 := Form7.ibDataSet100.FieldByname('SUM').AsFloat else fTotal2 := 0;
          //
          if fTotal1 + fTotal2 <> 0 then
          begin
            //
            Form7.ibQuery2.Close;
            Form7.ibQuery2.SQL.Clear;
            Form7.ibQuery2.SQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%('+ Form7.ibDataSet99999.FieldByname('NOME').AsString + ') '+StrZero(Year(dInicio),4,0)+'-'+StrZero(Month(dInicio),2,0)+'%''');
            Form7.ibQuery2.Open;
            //
            fTotal3 := Form7.ibQuery2.FieldByname('COUNT').AsFloat;
            //
            // Foto
            //
            if Form7.ibDataSet99999FOTO.BlobSize <> 0 then
            begin
              //
              BlobStream:= Form7.ibDataSet99999.CreateBlobStream(Form7.ibDataSet99999FOTO,bmRead);
              jp2 := TJPEGImage.Create;
              jp2.LoadFromStream(BlobStream);
              Form10.Image5.Picture.Assign(jp2);
              Form10.Image5.Picture.SaveToFile('_t_'+Form7.ibDataSet99999REGISTRO.AsString+'.jpg');
              //
            end
            else
              Form10.Image5.Picture := Form10.Image3.Picture;
            //
            Form10.Image5.Picture.SaveToFile('_t_'+Form7.ibDataSet99999REGISTRO.AsString+'.jpg');
            //
            if Form10.Image5.Picture.Width > Form10.Image5.Picture.Height then
            begin
              WriteLn(F,'<td nowrap valign=top bgcolor=#FFFFFF align=right><img src="'+'_t_'+Form7.ibDataSet99999.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet99999.FieldByName('NOME').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (100 / Form10.Image5.Picture.Width)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (100 / Form10.Image5.Picture.Width)),10,0)+'></td>');
            end
            else
            begin
              WriteLn(F,'<td nowrap valign=top bgcolor=#FFFFFF align=right><img src="'+'_t_'+Form7.ibDataSet99999.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet99999.FieldByName('REGISTRO').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (100 / Form10.Image5.Picture.Height)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (100 / Form10.Image5.Picture.Height)),10,0)+'></td>');
            end;
            //
            WriteLn(F,'    <td nowrap valign=top bgcolor=#FFFFFF align=right><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet99999.FieldByname('NOME').AsString+'</font></td>');
            WriteLn(F,'    <td nowrap valign=top bgcolor=#FFFFFF align=right><font face="Microsoft Sans Serif" size=1>'+Format('%7.'+Form1.ConfCasas+'n',[fTotal1+fTotal2])+'<br></font></td>');
            WriteLn(F,'    <td nowrap valign=top bgcolor=#FFFFFF align=right><font face="Microsoft Sans Serif" size=1>'+FloatToStr(fTotal3)+'<br></font></td>');
            WriteLn(F,'   </tr>');
            //
            III := III + 1;
            Mais1Ini.WriteString('DADOS','XY'+StrZero(III,2,0),'S1<'+
            StrTran(Format('%15.2n',[fTotal1+fTotal2]),'.','')
              +'>S2<'+'0,00'
                              +'>VX<'+StrZero(III,2,0)+'>LX<'+AllTrim(Copy(Form7.ibDataSet99999.FieldByname('NOME').AsString+Replicate(' ',20),1,20))+'>');
            //
            mais2Ini.WriteString('DADOS','XY'+StrZero(III,2,0),'S1<'+
            StrTran(Format('%15.2n',[fTotal3]),'.','')
              +'>S2<'+'0,00'
                              +'>VX<'+StrZero(III,2,0)+'>LX<'+AllTrim(Copy(Form7.ibDataSet99999.FieldByname('NOME').AsString+Replicate(' ',20),1,20))+'>');
            //
            fTotal  := fTotal + fTotal1+fTotal2;
            fTotalContatos := ftotalContatos + fTotal3;
            //
          end;
          //
          Form7.ibDataSet99999.Next;
          //
        end;
        //
        WriteLn(F,'<br>');              // Linha em branco
        WriteLn(F,'<br><font face="Microsoft Sans Serif" size=2 color=#000000><b>VENDAS</b></font>');
        WriteLn(F,'<center><a href="'+Form1.sAtual+'\vendedores.png"><img src="vendedores.png" border="0" width=800 height=400></a>');
        WriteLn(F,'<br><font face="Microsoft Sans Serif" size=2 color=#000000><b>CONTATOS</b></font>');
        WriteLn(F,'<center><a href="'+Form1.sAtual+'\contatos.png"><img src="contatos.png" border="0" width=800 height=400></a>');
        WriteLn(F,'<br>');              // Linha em branco
        //
        Mais1Ini.Free;
        Mais2Ini.Free;
        //
        ShellExecute( 0, 'Open', 'graficos.exe', 'vendedores.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
        while not FileExists(Form1.sAtual+'\vendedores.png') do
          Sleep(100);
        ShellExecute( 0, 'Open', 'graficos.exe', 'contatos.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
        while not FileExists(Form1.sAtual+'\contatos.png') do
          Sleep(100);
        //
        WriteLn(F,'  <tr bgcolor=#'+Form1.sHtmlCor+'   FF7F00>');
        WriteLn(F,'   <td nowrap valign=top align=left><font face="Microsoft Sans Serif" size=1><br></font></td>');
        WriteLn(F,'   <td nowrap valign=top align=left><font face="Microsoft Sans Serif" size=1><br></font></td>');
        WriteLn(F,'   <td nowrap valign=top align=right><font face="Microsoft Sans Serif" size=1><b>'+ Format('%11.'+Form1.ConfPreco+'n',[fTotal])+'<br></font></td>');
        WriteLn(F,'   <td nowrap valign=top align=right><font face="Microsoft Sans Serif" size=1><b>'+ FloatToStr(fTotalContatos)+'<br></font></td>');
        WriteLn(F,'  </tr>');
        WriteLn(F,' </table>');
        //
        Writeln(F,'<font face="Microsoft Sans Serif" size=1><br>Perodo analisado, de ' + DateTimeToStr(dInicio) + ' at ' + DateTimeToStr(dFinal)+'<br>');
        WriteLn(F,'</center>');
        //
      except
        on E: Exception do
        begin
          WriteLn(F,'  <br>Erro: '+E.Message);
        end;
      end;
      //
      Form7.IBDataSet2.DisableControls;
      Form7.ibDataSet3.DisableControls;
      //
      // WWW
      //
      if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
      begin
        WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
      end else
      begin
        WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
      end;
      //
      WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center>Tempo para gerar este relatrio: '+TimeToStr(Time - tInicio)+'</center>');
      if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
      WriteLn(F,'</html>');
      //
      CloseFile(F);                                    // Fecha o arquivo
      //
      Screen.Cursor := crDefault; // Cursor de Aguardo
      //
    end;
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.ibDataset2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  except
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.ibDataSet4CESTSetText(Sender: TField; const Text: String);
var
  bButton : Integer;
  bForm10 : Integer;
begin
  //
  try
    //
    bButton := Application.MessageBox(pChar('Preencher automaticamente o CEST:'+TExt+' com NCM: '+ibDataSet4CF.AsString+Chr(10)),'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    if bButton = IDYES  then
    begin
      Form7.IBQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update ESTOQUE set CEST='+QuotedStr(Text)+' where CF='+QuotedStr(ibDataSet4CF.AsString)+' ');
      Form7.IBQuery1.Open;
      //
      if Form10.Active then
        bForm10 := 1
      else
        bForm10 := 0;
      //
      Screen.Cursor            := crHourGlass;
      AgendaCommit(True);
      if bForm10 = 1 then
        Form10.Close;
      Form7.Close;
      Form7.Show;
      Form7.ibDataSet13.Edit;
      Screen.Cursor            := crDefault;
      //
      if bForm10 = 1 then
      begin
        Form10.Show;
        Form10.Orelhas.ActivePage := Form10.orelha_ICMS;
        Form10.ComboBox5.SetFocus;
      end;
      //
    end
    else
    begin
      ibDataSet4CEST.AsString := Text;
    end;
    //
  except

  end;
  //
end;

procedure TForm7.btnRetornoCNAB400Click(Sender: TObject);
var
  I: Integer;
  f: TextFile;
  sBanco, sMensagem, sLinha: String;
  sDocumento: String;
  sDataDoCredito: String;
begin
  //
  sBanco := '000';
  //
  if not Form7.OpenDialog4.Execute then
    Exit;
  //
  if FileExists(Form7.OpenDialog4.FileName) then
  begin
    //
    AssignFile(f,Form7.OpenDialog4.FileName);
    Reset(f);
    //
    Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
    sMensagem := '';
    I := 0;
    //
    while not eof(f) Do
    begin
      //
      ReadLn(f,sLinha);
      //
      if Length(sLinha) = 400 then
      begin
        //
        if (Copy(sLinha,001,001) = '0') and (Copy(sLinha,003,007) = 'RETORNO') then // 03 Identificao Tipo de Operao RETORNO
        begin
          //
          // HEADER
          //
          //   Copy(sLinha,001,001); // 01 Identificao do Registro Header: 0
          //   Copy(sLinha,002,001); // 02 Tipo de Operao: 2
          //   Copy(sLinha,003,007); // 03 Identificao Tipo de Operao RETORNO
          //   Copy(sLinha,010,002); // 04 Identificao do Tipo de Servio: 01
          //   Copy(sLinha,012,008); // 05 Identificao por Extenso do Tipo de Servio:COBRANA
          //   Copy(sLinha,020,007); // 06 Complemento do Registro: Brancos
          //   Copy(sLinha,027,004); // 07 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,031,001); // 08 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,032,008); // 09 Cdigo do Cliente/Beneficirio: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,040,001); // 10 Dgito Verificador do Cdigo: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,041,006); // 11 Nmero do convnio lder: Brancos
          //   Copy(sLinha,047,030); // 12 Nome do Beneficirio
          //   Copy(sLinha,077,018); // 13 Identificao do Banco: "756BANCOOBCED"
          //   Copy(sLinha,095,006); // 14 Data da Gravao do Retorno: formato ddmmaa
          //   Copy(sLinha,101,007); // 15 Seqencial do Retorno: nmero seqencial atribudo pelo Sicoob, acrescido de 1 a cada retorno. Inicia com "0000001"
          //   Copy(sLinha,108,287); // 16 Complemento do Registro: Brancos
          //   Copy(sLinha,395,006); // 17 Seqencial do Registro:000001
          //
          sBanco := Copy(sLinha,77,3);
          //
          sMensagem := sMensagem + 'Arquivo processado com sucesso.' + chr(10)+chr(10);
          //
        end;
        //
        if (Copy(sLinha,001,001) = '1') or (Copy(sLinha,001,001) = '7') then // and (Copy(sLinha,004,014) = cnpj do emitente) then // 03 Nmero do CPF/CNPJ do Beneficirio
        begin
          //
          // Copy(sLinha,001,001); // 01 Identificao do Registro Detalhe: 1 (um)
          // Copy(sLinha,002,002); // 02 "Tipo de Inscrio do Beneficirio: ""01"" = CPF ""02"" = CNPJ  "
          // Copy(sLinha,004,014); // 03 Nmero do CPF/CNPJ do Beneficirio
          // Copy(sLinha,018,004); // 04 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
          // Copy(sLinha,022,001); // 05 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
          // Copy(sLinha,023,008); // 06 Conta Corrente: vide planilha "Capa" deste arquivo
          // Copy(sLinha,031,001); // 07 Dgito Verificador da Conta: vide planilha "Capa" deste arquivo
          // Copy(sLinha,032,006); // 08 Nmero do Convnio de Cobrana do Beneficirio: "000000"
          // Copy(sLinha,038,025); // 09 Nmero de Controle do Participante: Brancos
          // Copy(sLinha,063,011); // 10 Nosso Nmero
          // Copy(sLinha,074,001); // 11 DV Nosso Nmero
          // Copy(sLinha,075,002); // 12 Nmero da Parcela
          // Copy(sLinha,077,004); // 13 Grupo de Valor: "00"
          // Copy(sLinha,081,002); // 14 Cdigo de Baixa/Recusa
          // Copy(sLinha,083,003); // 15 "Prefixo do Ttulo: Informa Espcie do Ttulo DM = Duplicata Mercantil CH = Cheque DS = Duplicata de Servio PC  = Parcela de Consrcio OU = Outros"
          // Copy(sLinha,086,003); // 16 Variao da Carteira: "000"
          // Copy(sLinha,089,001); // 17 Conta Cauo: "0"
          // Copy(sLinha,090,005); // 18 Cdigo de responsabilidade: "00000"
          // Copy(sLinha,095,001); // 19 DV do cdigo de responsabilidade: "0"
          // Copy(sLinha,096,005); // 20 Taxa de desconto
          // Copy(sLinha,101,005); // 21 Taxa de IOF
          // Copy(sLinha,106,001); // 22 Complemento do Registro: Brancos
          // Copy(sLinha,107,002); // 23 "Carteira/Modalidade: 01 = Simples Com Registro 02 = Simples Sem Registro 03 = Garantida Caucionada
          // Copy(sLinha,109,002); // 24 Comando/Movimento: 02 = Confirmao Entrada Ttulo;
          // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
          // Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
          // Copy(sLinha,127,020); // 27 Complemento do Registro: Brancos
          // Copy(sLinha,147,006); // 28 Data Vencimento Ttulo: formato ddmmaa
          // Copy(sLinha,153,013); // 29 Valor Titulo
          // Copy(sLinha,166,003); // 30 Cdigo do banco recebedor: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
          // Copy(sLinha,169,004); // 31 Prefixo da agncia recebedora: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
          // Copy(sLinha,173,001); // 32 DV prefixo recebedora
          // Copy(sLinha,174,002); // 33 "Espcie do Ttulo : 01 = Duplicata Mercantil
          // Copy(sLinha,176,006); // 34 Data do crdito: formato ddmmaa
          // Copy(sLinha,182,007); // 35 Valor da Tarifa
          // Copy(sLinha,189,013); // 36 Outras despesas
          // Copy(sLinha,202,013); // 37 Juros do desconto
          // Copy(sLinha,215,013); // 38 IOF do desconto
          // Copy(sLinha,228,013); // 39 Valor do abatimento
          // Copy(sLinha,241,013); // 40 Desconto concedido (diferena entre valor do ttulo e valor recebido)
          // Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
          // Copy(sLinha,267,013); // 42 Juros de Mora
          // Copy(sLinha,280,013); // 43 Outros recebimentos
          // Copy(sLinha,293,013); // 44 Abatimento no aproveitado pelo Pagador
          // Copy(sLinha,306,013); // 45 Valor do Lanamento
          // Copy(sLinha,319,001); // 46 Indicativo dbito/crdito
          // Copy(sLinha,320,001); // 47 Indicativo valor
          // Copy(sLinha,321,012); // 48 Valor do Ajuste
          // Copy(sLinha,333,010); // 49 Complemento do Registro: Brancos
          // Copy(sLinha,343,014); // 50 CPF/CNPJ do Pagador
          // Copy(sLinha,358,038); // 51 Complemento do Registro: Brancos
          // Copy(sLinha,395,006); // 52 Seqencial do Registro: Incrementado em 1 a cada registro
          //
          // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
          //
          if (Copy(sLinha,109,002) = '06') or (Copy(sLinha,109,002) = '21') then // 24 Comando/Movimento: 06 = Liquidao Normal
          begin
            //
            if Copy(sLinha,254,013) <> '0000000000000' then // 41 Valor recebido (valor recebido parcial)
            begin
    //        Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
    //        Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
    //
    //Form7.ibDataset7NOSSONUM.AsString
    //           Copy(sLinha,117,009)+asdfasdf
              sMensagem := sMensagem + 'Nmero documento: ' + Copy(sLinha,117,010) + ' Valor: R$ '+  FloatToStr(StrToFloat(Copy(sLinha,254,013))/100);
  // ShowMessage(sMensagem);

              sDocumento := AllTrim(Copy(sLinha,117,010)); // Sandro Silva 2022-12-21 Nmero do documento
              //
              Form7.ibDataSet7.Close;
              Form7.ibDataSet7.Selectsql.Clear;
              Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where DOCUMENTO='+QuotedStr(sDocumento)+' '); // Sandro Silva 2022-12-21 Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where DOCUMENTO='+QuotedStr(AllTrim(Copy(sLinha,117,010)))+' ');
              Form7.ibDataSet7.Open;
              //
              if Form7.ibDataSet7DOCUMENTO.AsString = sDocumento then // Sandro Silva 2022-12-21if Form7.ibDataSet7DOCUMENTO.AsString = AllTrim(Copy(sLinha,117,010)) then
              begin
                //
  //            if Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Copy(sLinha,117,010)),[]) then
  //            begin
                //
                if Form7.ibDataSet7ATIVO.AsFloat < 5 then
                begin
                  //
                  //
                  if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                  begin
                    //
                    Form7.SMALL_DBEdit1.Visible := True;
                    Form7.Edit2.Text            := Form7.SMALL_DBEdit2.Text;
                    //
                    Form7.ibDataSet7.Edit;
                    Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat + 5;
                    //
                    if (sBanco = '033') or (sBanco = '353') then // Santander so 11 posicoes
                    begin
                      Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,254,011))/100;
                    end else
                    begin
                      Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,254,013))/100;
                    end;
                    //
                    Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'RECEBIDO';
                    {Sandro Silva 2022-12-21 inicio}
                    sDataDoCredito := Copy(sLinha, 176, 6); // Data do crdito: formato ddmmaa
                    sDataDoCredito := Copy(sDataDoCredito, 1, 2) + '/' + Copy(sDataDoCredito, 3, 2) + '/' + Copy(sDataDoCredito, 5, 2);
                    if StrToDateDef(sDataDoCredito, StrToDate('30/12/1899')) <> StrToDate('30/12/1899') then
                    begin
                      Form7.ibDataSet7MOVIMENTO.AsDateTime := StrToDate(sDataDoCredito);
                    end;
                    {Sandro Silva 2022-12-21 fim}
                    //
                    Form7.ibDataSet7.Post;
                    //
                    Form1.IBDataSet200.Close;
                    Form1.IBDataSet200.Open;
                    //
                    Form7.ibQuery1.Close;
                    Form7.IBQuery1.SQL.Clear;
                    Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
                    Form7.IBQuery1.Open;
                    //
                    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
                    Form7.Panel10.Repaint;
                    //
                    Form7.ibDataSet25DIFERENCA_.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat +  StrToFloat(Copy(sLinha,254,013))/100;
                    //
                    SMALL_DBEdit1.SetFocus;
                    I := I + 1;
                    //
                  end else
                  begin
                    sMensagem := sMensagem + ' documento j estava quitado. ';
                  end;
                end else
                begin
                  sMensagem := sMensagem + ' documento j estava marcado. ';
                end;
                //
                sMensagem := sMensagem + chr(10);
                //
              end else
              begin
                //
                sMensagem := sMensagem + ' documento no encontrado '+chr(10);
                //
              end;
            end;
          end;
        end;
      end else
      begin
        ShowMessage('Aquivo fora do padro CNAB 400');
        Exit;
      end;
      //
      // Fim
      //
    end;
    //
    CloseFile(F);
    //
//    if Form7.ibDataSet25DIFERENCA_.AsFloat <> 0 then
    begin
      //
      sMensagem := sMensagem + chr(10) + chr(10) +
      'Duplicatas recebidos: '+ IntToStr(I )+chr(10)+chr(10) +
      'Total recebido R$: '+Form7.ibDataSet25DIFERENCA_.AsString+chr(10)+chr(10);
      //
      ShowMessage(sMensagem);
    end;
    //
    Form7.SMALL_DBEdit6.SetFocus;
    //
  end;
  //
end;

procedure TForm7.Baixaestacontanobanco1Click(Sender: TObject);
begin
  if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
  begin
    if Pos(Form7.ibDataSet7PORTADOR.AsString,'RECEBIDO') = 0 then
    begin
      Form7.ibDataSet7.Edit;
      Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
      Form7.ibDataSet7.Post;
    end;
  end;
end;

procedure TForm7.IBDataSet2CREDITOSetText(Sender: TField;
  const Text: String);
begin
  //
  if (Form1.iReduzida = 1) then
  begin
    ShowMessage('Este campo no pode ser alterado na verso START. Para controlar o limite de crdito  necessrio liberar a verso COMMERCE.');
    IBDataSet2CREDITO.AsString := '';
  end else
  begin
    IBDataSet2CREDITO.AsString := Text;
  end;
  //

end;

procedure TForm7.Vendas_XXXClick(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie '+Form1.sSerieEspecial;
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE XXX');
  Mais1Ini.Free;
  //
end;

procedure TForm7.NotasfiscaisdesadavendassrieXXX1Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie '+Form1.sSerieEspecial;
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE XXX');
  Mais1Ini.Free;
  //
end;

procedure TForm7.Relatriodeprodutosmonofsico1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Relatrio de produtos monofsicos (Cupom Fiscal)';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet4CFSetText(Sender: TField; const Text: String);
begin
  Form7.ibDataSet4CF.AsString := AllTrim(Copy(Text + '        ',1,8));
end;

procedure TForm7.AnliseMensal1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  I : Integer;
  F: TextFile;
begin
  //
  Form7.ibDataSet1.DisableControls;
  //
  try
    //
    CriaJpg('logotip.jpg');
    //
    ShortDateFormat := 'dd/mm/yyyy';
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE MENSAL DE '+IntToStr(Year(DATE))+'</b></font>');
    WriteLn(F,'<center>');   // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    // Faturamento
    //
    DeleteFile(pChar(Form1.sAtual+'\faturamento.gra'));
    DeleteFile(pChar(Form1.sAtual+'\faturamento.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\faturamento.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','faturamento.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Receita');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    Form1.ibQuery1.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as FATURAMENTO, extract(month from CAIXA.DATA) as MES from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=1 and CAIXA.NOME=CONTAS.NOME and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' group by extract(month from CAIXA.DATA) order by extract(month from CAIXA.DATA)');
    Form1.ibQuery1.Open;
    //
    for I := 1 to 12 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(I),1,3)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(StrToInt(Form1.ibQuery1.FieldByName('MES').AsString)),1,3) +'>');
      Form1.ibQuery1.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','faturamento.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\faturamento.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\faturamento.png"><img src="faturamento.png" border="0" width=500 height=250></a>');
    //
    // Despesas
    //
    DeleteFile(pChar(Form1.sAtual+'\despesas.gra'));
    DeleteFile(pChar(Form1.sAtual+'\despesas.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\despesas.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','despesas.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Despesa');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery2.Close;
    Form1.ibQuery2.SQL.Clear;
    Form1.ibQuery2.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as despesas, extract(month from CAIXA.DATA) as MES from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=3 and CAIXA.NOME=CONTAS.NOME and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' group by extract(month from CAIXA.DATA) order by extract(month from CAIXA.DATA)');
    Form1.ibQuery2.Open;
    //
    for I := 1 to 12 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(I),1,3)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery2.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(StrToInt(Form1.ibQuery2.FieldByName('MES').AsString)),1,3) +'>');
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','despesas.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\despesas.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\despesas.png"><img src="despesas.png" border="0" width=500 height=250></a>');
    //
    // Lucro
    //
    DeleteFile(pChar(Form1.sAtual+'\lucro.gra'));
    DeleteFile(pChar(Form1.sAtual+'\lucro.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\lucro.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','lucro.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Lucro');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); 
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    for I := 1 to 12 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(I),1,3)+'>');
    end;
    //
    I := 0;
    //
    Form1.ibQuery1.First;
    Form1.ibQuery2.First;
    //
    while not Form1.ibQuery1.Eof do
    begin
      //
      I := I + 1;
      //
      if Form1.ibQuery2.FieldByName('MES').AsString = Form1.ibQuery1.FieldByName('MES').AsString then
      begin
        Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                     'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(StrToInt(Form1.ibQuery1.FieldByName('MES').AsString)),1,3) +'>');
      end;
      //
      Form1.ibQuery1.Next;
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','lucro.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\lucro.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\lucro.png"><img src="lucro.png" border="0" width=500 height=250></a>');
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
  //
end;

procedure TForm7.ibDataSet15BeforePost(DataSet: TDataSet);
begin
  //
  AssinaRegistro('VENDAS',DataSet, True);
  //
end;

procedure TForm7.ibDataSet13BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('EMITENTE',DataSet, True);
end;

procedure TForm7.ibDataSet7PORTADORSetText(Sender: TField;
  const Text: String);
var
  MyBookmark: TBookmark;
//  bButton : Integer;
begin
  //
  if Form7.sModulo = 'VENDA' then // Ok
  begin
    try
      //
//    bButton := Application.MessageBox(Pchar('Alterar o portador para todas as duplicatas? '),'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
//    if bButton = IDYes then
      begin
        //
        MyBookmark    := Form7.ibDataSet7.GetBookmark;
        //
        Form7.ibDataSet7.DisableControls;
        Form7.ibDataSet7.First;
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          if Text <> Form7.ibDataSet7PORTADOR.AsString then
          begin
            Form7.ibDataSet7.Edit;
            Form7.ibDataSet7PORTADOR.AsString := Text;
          end;
          //
          Form7.ibDataSet7.Next;
          //
        end;
        //
        Form7.ibDataSet7.Edit;
        //
        Form7.ibDataSet7.GotoBookmark(MyBookmark);
        Form7.ibDataSet7.FreeBookmark(MyBookmark);
        Form7.ibDataSet7.EnableControls;
        //
      end;
      //
    except end;
  end else
  begin
    Form7.ibDataSet7PORTADOR.AsString := Text;
  end;
  //
end;

procedure TForm7.Anlisediaria1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  I : Integer;
  F: TextFile;
begin
  //
  Form7.ibDataSet1.DisableControls;
  //
  try
    //
    CriaJpg('logotip.jpg');
    //
    ShortDateFormat := 'dd/mm/yyyy';
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE DIRIA DO MS DE ' + UpperCase(Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2))))) + ' DE ' + Copy(DateTimeToStr(Date),7,4) + '</b></font>');
    WriteLn(F,'<center>');   // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    // Faturamento
    //
    DeleteFile(pChar(Form1.sAtual+'\faturamento.gra'));
    DeleteFile(pChar(Form1.sAtual+'\faturamento.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\faturamento.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','faturamento.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Receita');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','300');
    Mais1Ini.WriteString('DADOS','LarguraBmp','600');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    Form1.ibQuery1.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as FATURAMENTO, CAIXA.DATA as DIA from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=1 and CAIXA.NOME=CONTAS.NOME and extract(month from CAIXA.DATA)='+QuotedStr(IntToStr(Month(DATE)))
    +' and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' '
    +' group by CAIXA.DATA order by CAIXA.DATA');
    Form1.ibQuery1.Open;
    //
    for I := 1 to 30 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ StrZero(I,2,0)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(Form1.ibQuery1.FieldByName('DIA').AsString,1,2) +'>');
      Form1.ibQuery1.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','faturamento.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\faturamento.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\faturamento.png"><img src="faturamento.png" border="0" width=500 height=250></a>');
    //
    // Despesas
    //
    DeleteFile(pChar(Form1.sAtual+'\despesas.gra'));
    DeleteFile(pChar(Form1.sAtual+'\despesas.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\despesas.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','despesas.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Despesa');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','300');
    Mais1Ini.WriteString('DADOS','LarguraBmp','600');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery2.Close;
    Form1.ibQuery2.SQL.Clear;

    Form1.ibQuery2.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as DESPESAS, CAIXA.DATA as DIA from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=3 and CAIXA.NOME=CONTAS.NOME and extract(month from CAIXA.DATA)='+QuotedStr(IntToStr(Month(DATE)))
    +' and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' '
    +' group by CAIXA.DATA order by CAIXA.DATA');
    Form1.ibQuery2.Open;
    //
    for I := 1 to 30 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ StrZero(I,2,0)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery2.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(Form1.ibQuery2.FieldByName('DIA').AsString,1,2) +'>');
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','despesas.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\despesas.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\despesas.png"><img src="despesas.png" border="0" width=500 height=250></a>');
    //
    // Lucro
    //
    DeleteFile(pChar(Form1.sAtual+'\lucro.gra'));
    DeleteFile(pChar(Form1.sAtual+'\lucro.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\lucro.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','lucro.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Lucro');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','300');
    Mais1Ini.WriteString('DADOS','LarguraBmp','600');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    for I := 1 to 30 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ StrZero(I,2,0)+'>');
    end;
    //
    I := 0;
    //
    Form1.ibQuery1.First;
    Form1.ibQuery2.First;
    //
    while not Form1.ibQuery1.Eof do
    begin
      //
      I := I + 1;
      //
      if Form1.ibQuery2.FieldByName('DIA').AsString = Form1.ibQuery1.FieldByName('DIA').AsString then
      begin
        Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                     'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(Form1.ibQuery1.FieldByName('DIA').AsString,1,2) +'>');
      end;
      //
      Form1.ibQuery1.Next;
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','lucro.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\lucro.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\lucro.png"><img src="lucro.png" border="0" width=500 height=250></a>');
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
  //
end;

procedure TForm7.btnRetornoCNAB240Click(Sender: TObject);
var
  I: Integer;
  f: TextFile;
  sDocumento, sBanco, sMensagem, sLinha: String;
  sDataDoCredito: String; // Sandro Silva 2022-12-21
begin
  //
  sBanco := '000';
  //
  if not Form7.OpenDialog4.Execute then
    Exit;
  //
  if FileExists(Form7.OpenDialog4.FileName) then
  begin
    //
    Form7.ibDataSet7.DisableControls;
    //
    AssignFile(f, Form7.OpenDialog4.FileName);
    Reset(f);
    //
    Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
    sMensagem := '';
    I := 0;
    //
    while not Eof(f) Do
    begin
      //
      ReadLn(f,sLinha);  // Lendo a primeira linha do documento retornado. Obtem o cdigo do banco, nmero do documento e o cdigo de movimento de retorno
      //
      if Length(sLinha) = 240 then //  CNAB 240
      begin
        //
        sBanco := Copy(sLinha,1,3);
        //
        if (Copy(sLinha,014,01) = 'T') then
        begin
          //
          sDocumento := AllTrim(Copy(sLinha,59,15));
          //
          if Copy(sLinha,016,02) = '06' then // Cdigo de movimento de retorno 06 - Liquidao
          begin
            //
            Form7.ibDataSet7.Close;
            Form7.ibDataSet7.Selectsql.Clear;
            Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where DOCUMENTO='+QuotedStr(sDocumento)+' ');
            Form7.ibDataSet7.Open;
            //
            if Form7.ibDataSet7DOCUMENTO.AsString = sDocumento then
            begin
              //
              ReadLn(f,sLinha); // Avana alinha para ler os detalhes do documento
              //
              if (Copy(sLinha,014,01) = 'U') then  // U Registro detalhe
              begin
                //
                if Form7.ibDataSet7ATIVO.AsFloat < 5 then
                begin
                  //
                  sMensagem := sMensagem + 'Nmero documento: ' + sdocumento + ' Valor: R$ '+  FloatToStr(StrToFloat(Copy(sLinha,78,015))/100);
                  //
                  if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                  begin
                    //
                    Form7.SMALL_DBEdit1.Visible := True;
                    Form7.Edit2.Text            := Form7.SMALL_DBEdit2.Text;
                    //
                    Form7.ibDataSet7.Edit;
                    Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
                    //
                    Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,78,015))/100;
                    Form7.ibDataSet7PORTADOR.AsString  := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'RECEBIDO';
                    {Sandro Silva 2022-12-21 inicio}
                    sDataDoCredito := Copy(sLinha, 146, 8);
                    sDataDoCredito := Copy(sDataDoCredito, 1, 2) + '/' + Copy(sDataDoCredito, 3, 2) + '/' + Copy(sDataDoCredito, 5, 4);
                    if StrToDateDef(sDataDoCredito, StrToDate('30/12/1899')) <> StrToDate('30/12/1899') then
                    begin
                      Form7.ibDataSet7MOVIMENTO.AsDateTime := StrToDate(sDataDoCredito);
                    end;
                    {Sandro Silva 2022-12-21 fim}
                    //
                    Form7.ibDataSet7.Post;
                    //
                    Form1.IBDataSet200.Close;
                    Form1.IBDataSet200.Open;
                    //
                    Form7.ibQuery1.Close;
                    Form7.IBQuery1.SQL.Clear;
                    Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
                    Form7.IBQuery1.Open;
                    //
                    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
                    Form7.Panel10.Repaint;
                    //
                    Form7.ibDataSet25DIFERENCA_.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat +  Form7.ibDataSet7VALOR_RECE.AsFloat;
                    //
                    SMALL_DBEdit1.SetFocus;
                    I := I + 1;
                    //
                  end else
                  begin
                    sMensagem := sMensagem + ' documento j estava quitado. ';
                  end;
                end else
                begin
                  sMensagem := sMensagem + ' documento j estava marcado. ';
                end;
              end;
              //
              sMensagem := sMensagem + chr(10);
              //
              //
            end else
            begin
              //
              sMensagem := sMensagem + ' documento no encontrado '+chr(10);
              ReadLn(f,sLinha);
              //
            end;
          end else
          begin
            //  sMensagem := sMensagem +
          end;
        end;
      end else
      begin
        ShowMessage('Aquivo fora do padro CNAB 240');
        Exit;
      end;
      //
      // Fim
      //
    end;
    //
    CloseFile(F);
    //
    Form7.ibDataSet7.Close;
    Form7.ibDataSet7.Selectsql.Clear;
    Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where ATIVO>=5');
    Form7.ibDataSet7.Open;
    //
    Form7.ibDataSet7.Enablecontrols;
    //
    sMensagem := sMensagem + chr(10) + chr(10) +
      'Duplicatas recebidos: '+ IntToStr(I )+chr(10)+chr(10) +
      'Total recebido R$: '+Form7.ibDataSet25DIFERENCA_.AsString+chr(10)+chr(10);
    //
    ShowMessage(sMensagem);
    //
    Form7.SMALL_DBEdit6.SetFocus;
    //
  end;
  //
end;

procedure TForm7.ConsultarNFesemitidasparameuCNPJ1Click(Sender: TObject);
var
  sHora, sData, sRetorno : String;
  Mais1Ini : tIniFile;
begin
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
  sHora    := Mais1Ini.ReadString('Outros','HoraConsultarDistribuicao','00:00:00');
  sData    := Mais1Ini.ReadString('Outros','DataConsultarDistribuicao','26/09/1967');
  Mais1Ini.Free;
  //
  // Bloquear por uma hora
  //
  // ShowMessage('Teste: '+TimeToStr(StrToTime(sHora) + StrToTime('01:00:00')));
  //
  if (( StrToTime(sHora) + StrToTime('01:00:00')  )  < Time) or (sData <> DateToStr(Date)) then
  begin
    //
    ConfiguraNFE(True);
    //
    if Form7.spdNFe.Ambiente = spdNFeType.akProducao then
    begin
      //
      // Bloquear por uma hora
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
      Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao',TimeToStr(Time));
      Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
      Mais1Ini.Free;
      //
      // Alterado para permitir matriz e filial com o mesmo certificado
      // CNPJ raz do certificado  igual ao CNPJ raz do emitente
      if (Copy(FormataCpfCgc(Form1.GetCNPJCertificado(Form7.spdNFe.NomeCertificado.Text)),1,10)= Copy(Form7.ibDataset13CGC.AsString,1,10)) or (Form1.GetCNPJCertificado(Form7.spdNFe.NomeCertificado.Text)='')  then
      begin
        //
        Screen.Cursor            := crHourGlass;
        //
        try
          //
          // Cdigo da UF
          //
          ibDataset99.Close;
          ibDataset99.SelectSql.Clear;
          ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
          ibDataset99.Open;
          //
          Form1.ibQuery2.Close;
          Form1.ibQuery2.SQL.Clear;
          Form1.ibQuery2.SQL.Add('select gen_id(G_NSU_DOWNLOAD_XML,0) from rdb$database');
          Form1.ibQuery2.Open;
          //
          sRetorno := spdNFe.ConsultarDistribuicaoDFe(
                             pChar(Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,2)),
                             pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)),
                             StrTran(StrZero(StrToInt(Form1.ibQuery2.FieldByname('GEN_ID').AsString),15,0),'-','0'),
                             nkUltimo
                             ); 

          {Sandro Silva 2023-01-04 inicio
          if Form1.DisponivelSomenteParaNos then
          begin
            ShowMessage('teste 40538 ' + Form1.sAtual + #13 + 'Pasta log ' + spdNFe.DiretorioLog);

            ShowMessage('teste 40544 ' + sRetorno);

            //Audita('DFE','SMALL', Senhas.UsuarioPub,'chNFE ' + xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe'),0,0); // Ato, Modulo, Usurio, Histrico, Valor
          end;
          {Sandro Silva 2023-01-04 fim}

          //
          // Erro do vdeo
          //
          Form7.ibDataSet23.DisableControls;
          Form7.ibDataSet4.DisableControls;
          //
          // Erro do vdeo
          //
          DownloadListaDeNFesEmitidas(sRetorno); // Baixa uma lista de nf-es que foram emitidas para o CNPJ
          //
          Form7.ibDataSet23.EnableControls;
          Form7.ibDataSet4.EnableControls;
          //
        except
          on E: Exception do
          begin
            ShowMessage('Erro 38778 ao baixar lista de NF-es emitidas: '+E.Message);
          end
        end;
        //
        Screen.Cursor            := crDefault;
        //
      end;
    end;
    //
    Form7.ibDataSet24.DisableControls;
    //
    try
      Form7.ibDataSet24.Close;
      Form7.ibDataSet24.SelectSQL.Clear;
      Form7.ibDataSet24.SelectSQL.Add('select * from COMPRAS where coalesce(NFEID,''0000000000000000000000000000000000000000000'')<>''0000000000000000000000000000000000000000000'' and coalesce(NFEXML,''X.X'')=''X.X'' and MERCADORIA=0 and EMISSAO >= (current_date - 11) ');
      Form7.ibDataSet24.Open;
    except end;
    //
    // Faz a cincia da operao automaticamente
    //
    try
      //
      Form7.ibDataSet24.First;
      //
      while not Form7.ibDataSet24.Eof do
      begin
        Manifesto(2); // 2: Cincia da operao
        Form7.ibDataSet24.Next;
      end;
      //
    except end;
    //
    Form7.ibDataSet24.EnableControls;
    //
  end else
  begin
    //
    Form22.Label6.Caption := 'ltima consulta de NF-es emitidas para o CNPJ: '+Form7.ibDataSet13CGC.AsString+' foi as '+sHora;
    Form22.Label6.Width   := Screen.Width;
    Form22.Label6.Repaint;
    //
  end;
  //
end;

procedure TForm7.VisualizarXMLdamanifestaododestinatrio1Click(
  Sender: TObject);
var
  F : TextFile;
begin
  if (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)<>0) and (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) then
  begin
    AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                  // Abre para gravao
    WriteLn(F,Form7.ibDataSet24MDESTINXML.AsString);
    CloseFile(F); // Fecha o arquivo
    ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
    Screen.Cursor            := crDefault;
  end;
end;

procedure TForm7.DBGrid1CellClick(Column: TColumn);
begin
  Screen.Cursor            := CrDefault;
end;

procedure TForm7.EnviarmensagemWhatsAppparatodos1Click(Sender: TObject);
var
  sSecoes :  TStrings;
  sParcelas, sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, YY, J : Integer;
  sMandados : String;
  MyBookMark1 : TBookMark;
  PDF: TPrintPDF;
  sArquivoPDF: String; // Sandro Silva 2022-12-22
begin
  //
  Form40.MaskEdit1.Visible := False;
  Form40.Edit1.Visible     := False;
  Form40.Label1.Visible    := False;
  Form40.Label3.Visible    := False;
  Form40.Label4.Visible    := False;
  Form40.Caption           := 'Enviar WhatsApp';
  Form40.CheckBox1.Visible := False;
  Form40.OpenDialog1.FileName := '';
  Form40.Tag := 9;
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>,');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>,');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>,');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>,');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>,');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>,');
  Form40.Memo2.Lines.Add('<PARCELAS_VENCIDAS>');
  Form40.Memo2.Lines.Add('<TOTAL_ATRASADO>');
  Form40.Memo2.Lines.Add('<TOTAL_ATUALIZADO>');
  //
  Form40.ShowModal;
  //
  Form40.MaskEdit1.Visible := True;
  Form40.Edit1.Visible     := True;
  Form40.Label1.Visible    := True;
  Form40.Label4.Visible    := True;
  Form40.Label3.Visible    := True;
  Form40.Caption           := 'Enviar e-mail texto';
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este WhatsApp de cobrana para os clientes' + chr(10) +
              Chr(10) + 'filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    try
      //
      if bButton = IDYES then
      begin
        //
        I := 0;
        Form7.ibDataSet7.First;
        //
        // Retorna onde parou
        //
        Mais1ini := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('whats','registro','FIM') ;
        //
        if sRegistro <> 'FIM' then
        begin
          //
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          //
          if bButton = IDYES then
          begin
            //
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              //
              if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
          end else
          begin
            sMandados := '';
          end;
          //
        end;
        //
        Mais1ini.Free;
        Screen.Cursor            := crHourGlass;
        //
        YY := 0;
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          if (Pos(Form7.ibDataSet7NOME.AsString,sMandados)=0) and (Form7.ibDataSet7ATIVO.AsFloat=0) then
          begin
            try
              //
              //                                                                    //
              // Relaciona os clientes com o arquivo de vendas                     //
              //                                                                  //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
              begin
                //
                sArquivo := '';
                sArquivoPDF := Form1.sAtual+'\boletos_' + LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) + '.pdf'; // Sandro Silva 2022-12-22
                //
                if Form7.sModulo = 'RECEBER' then
                begin
                  //
                  if Form40.CheckBox1.Checked then
                  begin
                    //
                    while FileExists(sArquivoPDF) do // Sandro Silva 2022-12-22 while FileExists(Form1.sAtual+'\boletos.pdf') do
                    begin
                      DeleteFile(pChar(sArquivoPDF)); // Sandro Silva 2022-12-22 DeleteFile(pChar(Form1.sAtual+'\boletos.pdf'));
                      sleep(1000);
                    end;
                    //
                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;
                    //
                    try
                      //
                      // Grava o local para voltar
                      //
                      MyBookMark1 := Form7.ibDataSet7.GetBookMark();
                      //
                      // Cria o PDF
                      //
                      // Sandro Silva 2022-12-22 sDocParaGerarPDF := Copy(AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'XXXXXXXXX',1,9);
                      PDF := TPrintPDF.Create(Self);
                      //
                      // Configuraes do documento
                      //
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;
                      //
                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := sArquivoPDF;// sFileCFeSAT; // Sandro Silva 2022-12-11 PDF.FileName    := Form1.sAtual+'\boletos.pdf';// sFileCFeSAT;
                      {Start Printing...}
                      PDF.BeginDoc;
                      //
                      Form7.ibDataSet7.First;
                      while not Form7.ibDataSet7.Eof do
                      begin
                        if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                        begin
                          if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                          begin
                            if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                            begin
                              //
                              while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                              begin
                                DeleteFile(pChar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg'));
                                sleep(1000);
                              end;
                              //
                              Form1.sEscolhido := '';
                              //
                              try
                                //
                                sSecoes := TStringList.Create;
                                Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                Mais1Ini.ReadSections(sSecoes);
                                //
                                for J := 0 to (sSecoes.Count - 1) do
                                begin
                                  if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                   or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                  and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                  or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                  begin
                                    Form1.sEscolhido := sSecoes[J];
                                  end;
                                end;
                                //
                                Mais1Ini.Free;
                                //
                              except end;
                              //
                              if AllTrim(Form1.sEscolhido) <> '' then
                              begin
                                //
                                Form25.Show;
                                Form7.Repaint;
                                //
                                while not FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                begin
                                  Sleep(1000);
                                end;
                                //
                                // Print Image
                                //
                                YY := YY + 1;
                                if YY >= 2 then PDF.NewPage; // Add New Page
                                //
                                PDF.DrawJPEG(0, 0, Form25.Image2.Picture.Bitmap);
                                //
                                // PDF.DrawBitmap(0,0, Form25.Image2.Picture.Bitmap);
                                //
                              end;
                            end;
                          end;
                        end;
                        //
                        Screen.Cursor            := crHourGlass;
                        Form7.ibDataSet7.Next;
                        Form25.Close;
                        Form7.Repaint;
                        //
                      end;
                      //
                      Form7.ibDataSet7.GotoBookmark(MyBookMark1);
                      //
                      PDF.EndDoc;
                      if FileExists(sArquivoPDF) then // Sandro Silva 2022-12-22 if FileExists(Form1.sAtual+'\boletos.pdf') then
                        sArquivo := sArquivoPDF // Sandro Silva 2022-12-22 sArquivo := Form1.sAtual + '\boletos.pdf'
                      else
                        sArquivo := '';
                      //
                    except end;
                    //
                    Form25.Close;
                    Form7.Repaint;
                    //
                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                    //
                    // Fecha o pdf
                    //
                  end;
                end;
                //
                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                //
                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
                //
                sMsg := Form40.Memo1.Lines.Text;
                //
                // CLIENTES
                //
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                //
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));
                //
                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<PARCELAS_VENCIDAS>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select * from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' order by VENCIMENTO');
                  Form7.ibQuery1.Open;
                  //
                  sParcelas := '';
                  //
                  while not Form7.ibQuery1.eof do
                  begin
                    sParcelas := sParcelas +
                                'Documento: '+Copy(Form7.ibQuery1.fieldByname('DOCUMENTO').AsString   +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Emisso: '+Copy(Form7.ibQuery1.fieldByname('EMISSAO').AsString     +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Vencimento: '+Copy(Form7.ibQuery1.fieldByname('VENCIMENTO').AsString  +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Valor: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_DUPL').AsFloat])+Replicate(' ',10),1,10)+' '+chr(10)+
                                'Atualizado: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_JURO').AsFloat])+Replicate(' ',10),1,10)+chr(10)+
                                IfThen(Trim(Form7.ibQuery1.fieldByname('CODEBAR').AsString) <> '', 'Cdigo de barras: '+Form7.ibQuery1.fieldByname('CODEBAR').AsString, '')+chr(10)+chr(10)// Sandro Silva 2023-02-10ng, '')// Sandro Silva 2023-02-10
                                ;
                    //
                    Form7.ibQuery1.Next;
                  end;
                  //
                  sMsg := StrTran(sMsg,'<PARCELAS_VENCIDAS>'    ,sParcelas);
                  //
                end;
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<TOTAL_ATRASADO>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_DUPL) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATRASADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                if Pos('<TOTAL_ATUALIZADO>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_JURO) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATUALIZADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                sMsg := StrTran(sMsg,' ','%20');
                sMsg := StrTran(sMsg,chr(10),'%0A');
                sMsg := StrTran(sMsg,chr(13),'');
                //
                ShellExecute( 0, 'Open', pChar('https://api.whatsapp.com/send?phone=55'+LimpaNumero(StrTran(ibDataSet2WHATSAPP.AsString,'0xx',''))+'&text='+sMSG),'','', SW_SHOW);
                //
                I := I + 1;
                //
                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('whats','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;
                //
                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;
                //
                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' WhatsApps enviados.';
                Form7.Panel1.Repaint;
                //
              end;
              //
              sMandados := sMandados + Form7.ibDataSet7NOME.AsString;
              //
            except end;
            //
          end;
          //
          Form7.ibDataSet7.Next;
          //
        end;
      end;
      //
    except end;
    //
    Screen.Cursor            := crDefault;
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
  end;
  //
end;

procedure TForm7.ibDataSet4OBSValidate(Sender: TField);
begin
  if Form10.Visible then
  begin
    if (pos('<',Sender.Text)<>0) and (pos('>',Sender.Text)<>0) then
    begin
      ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.');
    end;
    if (pos('VAL0',Sender.AsString)<>0) then
    begin
      ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.');
    end;
  end;
end;

procedure TForm7.Notasfiscaisdesadavendassrie9201Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) com CPF srie 920';
  Form7.Show;
  Form7.sRPS := 'N';
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE 920');
  Mais1Ini.Free;
  //
end;

procedure TForm7.Re1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Complemento/Restituio por ICMS ST...';
  //
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ClculodoCustodaltimaNota1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\Clculos de Custos da ltima Nota.txt') then ShellExecute( 0, 'Open','notepad.exe',PChar('Clculos de Custos da ltima Nota.txt'), '', SW_SHOW);
end;

procedure TForm7.Manifesto1Click(Sender: TObject);
begin
  Form7.Manifestaododestinatrio1Click(Sender);
end;

procedure TForm7.EnvioaoFISCOREDUOZ1Click(Sender: TObject);
var
  bBlocoX : Boolean;
begin
  //
  {Sandro Silva 2023-02-14 inicio
  if (Form7.ibDataSet13ESTADO.AsString = 'SC') or (Form7.ibDataSet13ESTADO.AsString = 'MS') or (Form7.ibDataSet13ESTADO.AsString = 'PI') or (Form7.ibDataSet13ESTADO.AsString = 'TO') then
  begin
    //
    if FileExists(Form1.sAtual+'\blocox.exe') then
    begin
      //
      // (chamar este executvel quando abre o small e tem o paf instalado, SC, MS, PI, TO )....... sandro vai passar os parametros.....
      // Tambem um item no menu estoque para chamar este executvel:
      //
      if ParamCount = 0 then
      begin
        //
        try
          //
          Form7.IBQuery1.Close;
          Form7.IBQuery1.SQL.Text := 'select first 1 * from BLOCOX where TIPO = ''REDUCAO'' and (coalesce(XMLRESPOSTA, '''') not containing ''<SituacaoProcessamentoCodigo>1'') ';
          Form7.IBQuery1.Open;
          //
          if Form7.IBQuery1.FieldByName('REGISTRO').AsString = '' then
          begin
            bBlocox := False;
          end else
          begin
            bBlocox := True;
          end;
          //
        except
          bBlocoX := False;
        end;
        //
        if bBlocoX then
        begin
          //
          ShellExecute( 0, 'Open', 'blocox.exe', pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)+' '+Form7.ibDataSet13ESTADO.AsString+' '+'REDUCAO') , '', SW_SHOW);
          //
          while ConsultaProcesso('blocox.exe') do
          begin
            sleep(1000);
          end;
          //
        end;
      end;
      //
    end;
    //
  end;
  }
  //
end;

procedure TForm7.ExportarNfesdeentrdaparacontabilidade1Click(
  Sender: TObject);
var
  bTem   : Boolean;
  sEmail : string;
  Mais1Ini : tIniFile;
  SearchRec: tSearchREC;
  Encontrou : Integer;
begin
  //
  // Form s para pedir o perodo e o e-mail do contador.
  //
  Form28.ShowModal;
  //
  if Form28.DateTimePicker1.Date <> StrToDate('01/01/1998') then
  begin
    //
    if ValidaEmail(Form28.Edit1.Text) then
    begin
      //
      Form7.Close;
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
      Mais1Ini.WriteString('XML','e-mail contabilidade',AllTrim(Form28.Edit1.Text));
      Mais1Ini.WriteString('XML','Periodo Inicial',DateToStr(Form28.DateTimePicker1.Date));
      Mais1Ini.WriteString('XML','Periodo Final',DateToStr(Form28.DateTimePicker2.Date));
      Mais1ini.Free;
      //
      Form7.ibDataSet24.Close;
      Form7.ibDataSet24.SelectSql.Clear;
      //
      Form7.ibDataSet24.Selectsql.Add('select * from COMPRAS where EMISSAO<='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker2.Date))+
      ' and EMISSAO>='+QuotedStr(DateToStrInvertida(Form28.DateTimePicker1.Date))+' order by EMISSAO, NUMERONF');
      //
      Form7.ibDataSet24.Open;
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
      sEmail := Alltrim(Mais1Ini.ReadString('XML','e-mail contabilidade',''));
      Mais1ini.Free;
      //
      // Apaga todos os arquivos .XML da pasta CONTABIL
      //
      FindFirst(Form1.sAtual+'\CONTABIL\*.xml', faAnyFile, SearchRec);
      Encontrou :=0;
      while Encontrou = 0 do
      begin
        DeleteFile(pChar(Form1.sAtual+'\CONTABIL\'+Searchrec.Name));
        Encontrou := FindNext(SearchRec);
      end;
      //
      bTem   := False;
      //
      Form7.ibDataSet24.First;
      while not Form7.ibDataSet24.Eof do
      begin
        if DistribuicaoNFeCompra('CONTABIL') then bTem   := True;
        Form7.ibDataSet24.Next;
      end;
      //
      if bTem then
      begin
        //
        while FileExists(pChar(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'_entrada.zip')) do
        begin
          DeleteFile(pChar(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'_entrada.zip'));
          Sleep(1000);
        end;
        //
        ShellExecute( 0, 'Open','szip.exe',pChar('backup "'+Alltrim(Form1.sAtual + '\CONTABIL\*.xml')+'" "'+Alltrim(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'_entrada.zip')+'"'), '', SW_SHOWMAXIMIZED);
        //
        while ConsultaProcesso('szip.exe') do
        begin
          Application.ProcessMessages;
          sleep(100);
        end;
        //
        while not FileExists(pChar(Form1.sAtual+'\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'_entrada.zip')) do
        begin
          sleep(100);
        end;
        //
        // Apaga todos os arquivos .XML da pasta CONTABIL
        //
        FindFirst(Form1.sAtual+'\CONTABIL\*.xml', faAnyFile, SearchRec);
        Encontrou :=0;
        while Encontrou = 0 do
        begin
          DeleteFile(pChar(Form1.sAtual+'\CONTABIL\'+Searchrec.Name));
          Encontrou := FindNext(SearchRec);
        end;
        //
        Unit7.EnviarEMail('',Form28.Edit1.Text,'','NF-es (Notas Fiscais Eletrnicas)',
          pchar('Segue em anexo arquivo zipado com as NF-es de entrada da empresa '+AllTrim(Form7.ibDataSet13NOME.AsString)+'.'
          +' Perodo de '+DateToStr(Form28.DateTimePicker1.Date)+' at '+DateToStr(Form28.DateTimePicker2.Date)+'.'
          +chr(10)
          +Form1.sPropaganda)
          ,pChar(Form1.sAtual + '\CONTABIL\'+ LimpaNumero(Form7.ibDataSet13CGC.AsString) + '_'+StrTRan(DateToStr(date),'/','_')+'_entrada.zip'),False);
      end else
      begin
        ShowMessage('No encontrado XML para contabilidade neste perodo.');
      end;
      //
    end;
  end;
  //
  try
    Form7.Close;
    Form7.ShowModal;
  except end;  
  //
end;

procedure TForm7.ManifestaododestinatrioDesc1Click(Sender: TObject);
begin
  //
  try
    //
    ConfiguraNFE(True);
    //
    // Tipo do evento que deseja enviar:
    // 1: Confirmao da operao.
    // 2: Cincia da operao.
    // 3: Desconhecimento da operao.
    // 4: Operao no Realizada.
    //
//    if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)=0) then
    begin
      //
      Manifesto(3); // 3: Desconhecimento da operao.
      //
    end;
    //
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING);
    end;
  end;
  //
  Screen.Cursor := crDefault;
  //
end;

procedure TForm7.Manifestaaododestinatrio1Click(Sender: TObject);
begin
  //
  try
    //
    ConfiguraNFE(True);
    //
    // Tipo do evento que deseja enviar:
    // 1: Confirmao da operao.
    // 2: Cincia da operao.
    // 3: Desconhecimento da operao.
    // 4: Operao no Realizada.
    //
//    if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)=0) then
    begin
      //
      Manifesto(4); // 4: Operao no Realizada.
      //
    end;
    //
  except
    on E: Exception do
    begin
      Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING);
    end;
  end;
  //
  Screen.Cursor := crDefault;
  //
end;

procedure TForm7.ransmitirNotaFiscaldeServioNFSe1Click(Sender: TObject);
var
  //
  bMultiplosServicos : Boolean;
  sDescricaoDosServicos, sPadraoCidade, sCodigoCnae, sCodigoLocalPrestacao, sRetornoNFse, sArquivoXML : String;
  sCodigoCnaePrestador: String; // Sandro Silva 2023-02-28 
  _file1, _file, _XML : TStringList;
  F: TextFile;
  I, J: Integer;
  Mais1Ini : tIniFile;
  fValorISSRetido, fValorImpostosFederaisRetidos : Real;
  sPadraoSistema, sTipoPagamentoAPrazo: String;
  sResponsavelRetencao: String; // Sandro Silva 2023-01-19
  //
  procedure InformaCodVerificadorAutenticidadeParaIPM;
  begin
    if Pos('Codigo de autenticacao da NFSe',Form7.ibDAtaSet15RECIBOXML.AsString) <> 0 then
    begin
      Writeln(F,'<NumeroDaNFSe>'+LimpaNumero(Copy(Form7.ibDAtaSet15RECIBOXML.AsString,Pos('Codigo de autenticacao da NFSe',Form7.ibDAtaSet15RECIBOXML.AsString)+32,16))+'</NumeroDaNFSe>');
    end else
    begin
      if RetornaValorDaTagNoCampo('cod_verificador_autenticidade',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
        Writeln(F,'<NumeroDaNFSe>'  + RetornaValorDaTagNoCampo('cod_verificador_autenticidade',Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDaNFSe>')
      else
        Writeln(F,'<NumeroDaNFSe>'+AllTrim(StrTran(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,'/001',''))+'</NumeroDaNFSe>');
    end;
  end;
begin
  //
  Screen.Cursor            := crHourGlass;
  //
  // Zerezima
  //
  fValorImpostosFederaisRetidos := 0;
  //
  // Antes de tudo atualiza a data
  //
  try
    if Form7.ibDataSet15EMITIDA.AsString <> 'S' then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
        Form7.ibDataset15.Edit;
      Form7.ibDataSet15EMISSAO.Value       := Date;
      Form7.ibDataset15.Post;
      Form7.ibDataset15.Edit;
    end;
  except
  end;
  //
  // Multiplos Servios
  //
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfseConfig.ini');
  //
  if (Mais1Ini.ReadString('Informacoes obtidas na prefeitura','MultiplosServicos','?') = '?') or (Mais1Ini.ReadString('Informacoes obtidas na prefeitura','Padrao','?') = '?') then
  begin
    //
    try
      //
      _file := TStringList.Create;
      _file.LoadFromFile(pChar(Form1.sAtual+'\NFSE\CidadesHomologadas.XML'));
      //
      sPadraoCidade        := RetornaValorDaTagNoCampo(UpperCase(StrTran(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString),' ',''))+UpperCase(Form7.ibDAtaset13ESTADO.AsString),_File.Text);
      //
      if pos('<Multiservicos>False</Multiservicos>',sPadraoCidade) <> 0 then
      begin
        Mais1Ini.WriteString('Informacoes obtidas na prefeitura','MultiplosServicos','NAO');
        bMultiplosServicos := False;
      end else
      begin
        Mais1Ini.WriteString('Informacoes obtidas na prefeitura','MultiplosServicos','SIM');
        bMultiplosServicos := True;
      end;
      //
      Mais1Ini.WriteString('Informacoes obtidas na prefeitura','Padrao',RetornaValorDaTagNoCampo('Padrao',sPadraoCidade));
      //
    except
      Mais1Ini.WriteString('Informacoes obtidas na prefeitura','MultiplosServicos','NAO');
      bMultiplosServicos := True;
    end;
    //
  end else
  begin
    if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','MultiplosServicos','?') = 'SIM' then
    begin
      bMultiplosServicos := True;
    end else
    begin
      bMultiplosServicos := False;
    end;
  end;
  //
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','IncentivadorCultural'     ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','IncentivadorCultural'     ,'2');
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','RegimeEspecialTributacao' ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','RegimeEspecialTributacao' ,'1');
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','NaturezaTributacao'       ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','NaturezaTributacao'       ,'1');
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','IncentivoFiscal'          ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','IncentivoFiscal'          ,'1');
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','TipoTributacao'           ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','TipoTributacao'           ,'6');
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','ExigibilidadeISS'         ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','ExigibilidadeISS'         ,'1');
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','Operacao'                 ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','Operacao'                 ,'A');
  {Sandro Silva 2023-03-22 inicio
  Ficha 6611 - no usar o CNAE da tabela emitente (CNAE para produtos) para os servios
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','CodigoCnae'               ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','CodigoCnae'               ,pchar(Form7.ibDataSet13CNAE.AsString) );
  }
  if Mais1Ini.ReadString('Informacoes obtidas na prefeitura','TipoPagamentoPrazo'       ,'') = '' then
    Mais1Ini.WriteString('Informacoes obtidas na prefeitura','TipoPagamentoPrazo'       ,'3');
  //
  sPadraoSistema       := UpperCase(Mais1Ini.ReadString('Informacoes obtidas na prefeitura','Padrao','?'));
  sTipoPagamentoAPrazo := Mais1Ini.ReadString('Informacoes obtidas na prefeitura','TipoPagamentoPrazo'       ,'3');

  sResponsavelRetencao := Mais1Ini.ReadString('NFSE', 'ResponsavelRetencao', ''); // Sandro Silva 2023-01-24

  //
  if (Mais1Ini.ReadString('NFSE','CNPJ','')<>LimpaNumero(Form7.ibDAtaset13CGC.AsString)) or
     (Mais1Ini.ReadString('NFSE','CIDADE','')<>UpperCase(StrTran(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString),' ',''))+UpperCase(Form7.ibDAtaset13ESTADO.AsString)) or
     (Mais1Ini.ReadString('NFSE','InscricaoMunicipal','')<>LimpaNumero(Form7.ibDAtaset13IM.AsString)) then
  begin
    Mais1ini.Free;
    Form1.ConfiguraesdaNFSe2Click(Sender);
  end else
  begin
    Mais1ini.Free;
  end;
  //
  try
    //
    // NFSE.EXE no instalado
    //
    {Sandro Silva 2023-01-11 inicio
    if not FileExists(pChar(Form1.sAtual+'\NFSE.EXE')) then
    begin
      ShowMessage('Mdulo de transmisso de NFS-e no instalado');
    end else
    }
    if Form1.ExisteNfseExe(Form1.sAtual) then
    begin
      //
      // J foi autorizada
      //
      if (Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) = 0) or (Form1.sConsultaNfse = 'SIM') then
      begin
        //
        // Servios Zerado
        //
        if ibDataSet15.FieldByname('SERVICOS').AsFloat > 0 then
        begin
          //
          // Em Processamento
          //
          if (RetornaValorDaTagNoCampo('Status',Form7.ibDAtaSet15RECIBOXML.AsString) = 'EM PROCESSAMENTO') or (Form1.sConsultaNfse = 'SIM') then
          begin
            //
            AssignFile(F,pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));  // Direciona o arquivo F para EXPORTA.TXT
            Rewrite(F);
            //
            Writeln(F,'<Status>EM PROCESSAMENTO</Status>');
            Writeln(F,'<tx2>'+AllTrim(RetornaValorDaTagNoCampoCRLF('tx2',Form7.ibDAtaSet15RECIBOXML.AsString))+'</tx2>');
            Writeln(F,'<XMLdeEvio>'+AllTrim(Form7.ibDAtaSet15NFEXML.AsString)+'</XMLdeEvio>');
            if RetornaValorDaTagNoCampo('Motivo'      ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
              Writeln(F,'<Motivo>'        + RetornaValorDaTagNoCampo('Motivo'      ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Motivo>')
            else
              Writeln(F,'<Motivo></Motivo>');
            //
//            if (sPadraoSistema = 'JOINVILLESC') then
//            begin
//            end else
            begin
              //
              if (sPadraoSistema = 'MEMORY') then
              begin
                //
                Writeln(F,'<NumeroDaNFSe></NumeroDaNFSe>');
                // 2022-07-14 Writeln(F,'<NumeroDoRPS>'+IntToStr(StrToInt(Form7.ibDataSet15NUMERONF.AsString))+'</NumeroDoRPS>'); // Tirar os Zeros a esquerda do numero do rps
                Writeln(F,'<NumeroDoRPS>'+IntToStr(StrToInt(LimpaNumero(Form7.ibDataSet15NUMERONF.AsString)))+'</NumeroDoRPS>'); // Tirar os Zeros a esquerda do numero do rps
                Writeln(F,'<SerieDoRPS>001</SerieDoRPS>');
                Writeln(F,'<Tipo>1</Tipo>');
                Writeln(F,'<Protocolo></Protocolo>');
                //
              end else
              begin
                //
                if (sPadraoSistema = 'ABASE') then
                begin
                  //
                  Writeln(F,'<NumeroDaNFSe></NumeroDaNFSe>');
                  Writeln(F,'<NumeroDoRPS>'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'</NumeroDoRPS>');
                  Writeln(F,'<SerieDoRPS>001</SerieDoRPS>');
                  Writeln(F,'<Tipo>1</Tipo>');
                  Writeln(F,'<Protocolo></Protocolo>');
                  //
                end else
                begin
                  //
                  if (sPadraoSistema = 'SIL20') then
                  begin
                    Writeln(F,'<NumeroDoRPS>'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'</NumeroDoRPS>');
                    Writeln(F,'<SerieDoRPS>001</SerieDoRPS>');
                    Writeln(F,'<Tipo>1</Tipo>');
                    Writeln(F,'<Protocolo></Protocolo>');
                    //
                  end else
                  begin
                    //
                    if (sPadraoSistema = 'IPM') then
                    begin
                      {Sandro Silva 2022-10-10 inicio
                      if Pos('Codigo de autenticacao da NFSe',Form7.ibDAtaSet15RECIBOXML.AsString) <> 0 then
                      begin
                        Writeln(F,'<NumeroDaNFSe>'+LimpaNumero(Copy(Form7.ibDAtaSet15RECIBOXML.AsString,Pos('Codigo de autenticacao da NFSe',Form7.ibDAtaSet15RECIBOXML.AsString)+32,16))+'</NumeroDaNFSe>');
                      end else
                      begin
                        if RetornaValorDaTagNoCampo('cod_verificador_autenticidade',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<NumeroDaNFSe>'  + RetornaValorDaTagNoCampo('cod_verificador_autenticidade',Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDaNFSe>')
                        else
                          Writeln(F,'<NumeroDaNFSe>'+AllTrim(StrTran(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,'/001',''))+'</NumeroDaNFSe>');
                      end;
                      }
                      InformaCodVerificadorAutenticidadeParaIPM;
                      {Sandro Silva 2022-10-10 fim}
                    end else
                    begin
                      {Sandro Silva 2022-10-18 inicio
                      if RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                        Writeln(F,'<NumeroDaNFSe>'  + RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDaNFSe>')
                      else
                        Writeln(F,'<NumeroDaNFSe>'+AllTrim(StrTran(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,'/001',''))+'</NumeroDaNFSe>');
                      if RetornaValorDaTagNoCampo('NumeroDoRPS' ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                        Writeln(F,'<NumeroDoRPS>'   + RetornaValorDaTagNoCampo('NumeroDoRPS' ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDoRPS>')
                      else
                        Writeln(F,'<NumeroDoRPS>'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'</NumeroDoRPS>');
                      if RetornaValorDaTagNoCampo('Tipo'        ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                        Writeln(F,'<Tipo>'          + RetornaValorDaTagNoCampo('Tipo'        ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Tipo>')
                      else
                        Writeln(F,'<Tipo>1</Tipo>');
                      if RetornaValorDaTagNoCampo('Protocolo'   ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                        Writeln(F,'<Protocolo>'     + RetornaValorDaTagNoCampo('Protocolo'   ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Protocolo>')
                      else
                        Writeln(F,'<Protocolo></Protocolo>');
                      //
                      if (sPadraoSistema = 'IPM20') then
                      begin
                        InformaCodVerificadorAutenticidadeParaIPM; // Sandro Silva 2022-10-10
                        Writeln(F,'<SerieDoRPS>01</SerieDoRPS>');
                      end else
                      begin
                        if RetornaValorDaTagNoCampo('SerieDoRPS'  ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then Writeln(F,'<SerieDoRPS>'    + RetornaValorDaTagNoCampo('SerieDoRPS'  ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</SerieDoRPS>')   else Writeln(F,'<SerieDoRPS>001</SerieDoRPS>');
                      end;
                      }
                      //
                      if (sPadraoSistema = 'IPM20') then
                      begin
                        InformaCodVerificadorAutenticidadeParaIPM; // Sandro Silva 2022-10-10
                        Writeln(F,'<SerieDoRPS>01</SerieDoRPS>');
                      end else
                      {Sandro Silva 2023-01-25 inicio}
                      if (sPadraoSistema = 'ISSNETONLINE20') and (AnsiUpperCase(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString) + Form7.ibDataSet13ESTADO.AsString) = 'BRASILIADF') then
                      begin
                        if RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<NumeroDaNFSe>' + RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDaNFSe>')
                        else
                          Writeln(F,'<NumeroDaNFSe>'+AllTrim(StrTran(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,'/001',''))+'</NumeroDaNFSe>');
                        if StrToIntDef(LimpaNumero(RetornaValorDaTagNoCampo('NumeroDoRPS' ,Form7.ibDAtaSet15RECIBOXML.AsString)), 0) <> 0 then
                          Writeln(F,'<NumeroDoRPS>' + InttoStr(StrToIntDef(LimpaNumero(RetornaValorDaTagNoCampo('NumeroDoRPS' ,Form7.ibDAtaSet15RECIBOXML.AsString)), 0)) + '</NumeroDoRPS>') // ISSNETONLINE20 - Braslia aceita o RPS utilizando no mximo 5 dgitos
                        else
                          Writeln(F,'<NumeroDoRPS>'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'</NumeroDoRPS>');
                        if RetornaValorDaTagNoCampo('Tipo'        ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<Tipo>'          + RetornaValorDaTagNoCampo('Tipo'        ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Tipo>')
                        else
                          Writeln(F,'<Tipo>1</Tipo>');
                        if RetornaValorDaTagNoCampo('Protocolo'   ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<Protocolo>'     + RetornaValorDaTagNoCampo('Protocolo'   ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Protocolo>')
                        else
                          Writeln(F,'<Protocolo></Protocolo>');

                        if RetornaValorDaTagNoCampo('SerieDoRPS'  ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<SerieDoRPS>'    + RetornaValorDaTagNoCampo('SerieDoRPS'  ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</SerieDoRPS>')
                        else
                          Writeln(F,'<SerieDoRPS>3</SerieDoRPS>');
                      end
                      else
                      {Sandro Silva 2023-01-25 fim}
                      begin
                        if RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<NumeroDaNFSe>'  + RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDaNFSe>')
                        else
                          Writeln(F,'<NumeroDaNFSe>'+AllTrim(StrTran(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,'/001',''))+'</NumeroDaNFSe>');
                        if RetornaValorDaTagNoCampo('NumeroDoRPS' ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<NumeroDoRPS>'   + RetornaValorDaTagNoCampo('NumeroDoRPS' ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</NumeroDoRPS>')
                        else
                          Writeln(F,'<NumeroDoRPS>'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'</NumeroDoRPS>');
                        if RetornaValorDaTagNoCampo('Tipo'        ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<Tipo>'          + RetornaValorDaTagNoCampo('Tipo'        ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Tipo>')
                        else
                          Writeln(F,'<Tipo>1</Tipo>');
                        if RetornaValorDaTagNoCampo('Protocolo'   ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<Protocolo>'     + RetornaValorDaTagNoCampo('Protocolo'   ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</Protocolo>')
                        else
                          Writeln(F,'<Protocolo></Protocolo>');

                        if RetornaValorDaTagNoCampo('SerieDoRPS'  ,Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
                          Writeln(F,'<SerieDoRPS>'    + RetornaValorDaTagNoCampo('SerieDoRPS'  ,Form7.ibDAtaSet15RECIBOXML.AsString) + '</SerieDoRPS>')
                        else
                          Writeln(F,'<SerieDoRPS>001</SerieDoRPS>');
                      end;
                      {Sandro Silva 2022-10-18 fim}
                      //
                    end;
                  end;
                end;
                //
              end;
            end;
            //
            // teste enviando o xml de envio para resolver o problema de no imprimir todos os dados no .PDF
            //
          end else
          begin
            //
            // Gera e envia o arquivo da NFSE
            //
            Form7.ibDataSet14.Close;
            Form7.ibDataSet14.SelectSQL.Clear;
            Form7.ibDataSet14.SelectSQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
            Form7.ibDataSet14.Open;
            //
            Form7.ibDataSet2.Close;
            Form7.ibDataSet2.Selectsql.Clear;
            Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
            Form7.ibDataSet2.Open;
            //
            ibDataset99.Close;
            ibDataset99.SelectSql.Clear;
            ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
            ibDataset99.Open;
            //
            sCodigoLocalPrestacao := Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7);
            //
            while FileExists(Pchar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
            begin
              DeleteFile(Pchar(Form1.sAtual+'\NFSE\smallnfse.tx2'));
              Sleep(100);
            end;
            //
            AssignFile(F,pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));  // Direciona o arquivo F para EXPORTA.TXT
            Rewrite(F);
            //
            Writeln(F,'formato=tx2');
            Writeln(F,'padrao=TecnoNFSe');
            Writeln(F,'');
            Writeln(F,'INCLUIR');
            Writeln(F,'');
            //
            if (sPadraoSistema = 'ABASE') or (sPadraoSistema = 'JOINVILLESC') then
            begin
              Writeln(F,'NumeroLote='+ IntToStr(StrToInt(Copy(Form7.ibDataSet15NUMERONF.AsString,3,7))) );
            end else
            {Sandro Silva 2023-01-09 inicio}
            if (sPadraoSistema = 'ISSNETONLINE20') and (AnsiUpperCase(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString) + Form7.ibDataSet13ESTADO.AsString) = 'BRASILIADF') then
            begin
              Writeln(F,'NumeroLote=' + IntToStr(StrToIntDef(Copy(Form7.ibDataSet15NUMERONF.AsString,1,9), 0)) );
            end else
            {Sandro Silva 2023-01-09 fim}
            begin
              Writeln(F,'NumeroLote='+ IntToStr(Trunc(Now*1000000)) );
            end;
            //
            Writeln(F,'CPFCNPJRemetente='+LimpaNumero(Form7.ibDAtaSet13CGC.AsString));             // CNPJ do Emitente
            Writeln(F,'InscricaoMunicipalRemetente='+LimpaNumero(Form7.ibDAtaSet13IM.AsString));   // IM do Emitente
            Writeln(F,'ValorTotalServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.')); // Valor Total de servios
            Writeln(F,'ValorTotalDeducoes=0.00');
            Writeln(F,'ValorTotalBaseCalculo='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.')); // Valor Total de servios
            //
            Writeln(F,'SALVAR');
            Writeln(F,'');
            Writeln(F,'INCLUIRRPS');
            Writeln(F,'');
            //
            {Sandro Silva 2023-01-09 inicio}
            if (sPadraoSistema = 'ISSNETONLINE20') and (AnsiUpperCase(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString) + Form7.ibDataSet13ESTADO.AsString) = 'BRASILIADF') then
            begin
              Writeln(F,'NumeroRps=' + IntToStr(StrToIntDef(Copy(Form7.ibDataSet15NUMERONF.AsString,1,9), 0)));  // Nmero sequencial do RPS
            end else
            {Sandro Silva 2023-01-09 fim}
            begin
              Writeln(F,'NumeroRps='+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9));  // Nmero sequencial do RPS
            end;
            //
            if (sPadraoSistema = 'IPM20') then
            begin
              Writeln(F,'SerieRps=01');    // Srie
            end else
            {Sandro Silva 2023-01-09 inicio}
            if (sPadraoSistema = 'ISSNETONLINE20') and (AnsiUpperCase(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString) + Form7.ibDataSet13ESTADO.AsString) = 'BRASILIADF') then
            begin
              Writeln(F,'SerieRps=3');    // Srie   Braslia fixo 3
            end else
            {Sandro Silva 2023-01-09 fim}
            begin
              Writeln(F,'SerieRps=001');    // Srie
            end;
            //
            Writeln(F,'TipoRps=1');      // Informar sempre 1
            Writeln(F,'SituacaoNota=1'); // Situao da nota: 1 - Normal. 2 - Cancelada.
            //
            Writeln(F,'DataEmissao='+StrTran(DateToStrInvertida(ibDataSet15.FieldByname('EMISSAO').AsDateTime),'/','-')+'T'+TimeToStr(Time)); // Data de Emisso da Nota Fiscal
            Writeln(F,'Competencia='+StrTran(DateToStrInvertida(ibDataSet15.FieldByname('EMISSAO').AsDateTime),'/','-')); // Data da competncia do RPS
            //
            Writeln(F,'CpfCnpjPrestador='+LimpaNumero(Form7.ibDAtaSet13CGC.AsString)); // CPF / CNPJ do prestador do servio
            Writeln(F,'InscricaoMunicipalPrestador='+LimpaNumero(Form7.ibDAtaSet13IM.AsString));  // Inscrio municipal do prestador do servio
            Writeln(F,'RazaoSocialPrestador='+ConverteAcentos2(Form7.ibDAtaSet13NOME.AsString));  // Razo Social do prestador do servio
            Writeln(F,'InscricaoEstadualPrestador='+LimpaNumero(Form7.ibDAtaSet13IE.AsString));   // Inscrio Estadual do prestador do servio
            //
            Writeln(F,'TipoLogradouroPrestador=Rua');
            {Sandro Silva 2022-10-04 inicio
            Writeln(F,'EnderecoPrestador='+ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset13.FieldByname('ENDERECO').AsString))); // Logradouro do Emitente
            }
            if (sPadraoSistema = 'JOINVILLESC') then
              Writeln(F,'EnderecoPrestador='+ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset13.FieldByname('ENDERECO').AsString) + ', ' + Numero_Sem_Endereco(ibDAtaset13.FieldByname('ENDERECO').AsString) + ' - ' + Form7.ibDAtaSet13COMPLE.AsString)) // Logradouro do Emitente
            else
              Writeln(F,'EnderecoPrestador='+ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset13.FieldByname('ENDERECO').AsString))); // Logradouro do Emitente
            {Sandro Silva 2022-10-04 fim}
            Writeln(F,'NumeroPrestador='+Numero_Sem_Endereco(ibDAtaset13.FieldByname('ENDERECO').AsString)); // Numero do Logradouro do Emitente
            //
            Writeln(F,'ComplementoPrestador='+ConverteAcentos2(Form7.ibDAtaSet13NOME.AsString)); // Complemento
            Writeln(F,'TipoBairroPrestador=');
            Writeln(F,'BairroPrestador='+ConverteAcentos2(Form7.ibDAtaSet13COMPLE.AsString)); // Bairro
            Writeln(F,'CodigoCidadePrestador='+Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7)); // Cdigo da Cidade do Emitente (Tabela do IBGE)
            //
            Writeln(F,'DescricaoCidadePrestador='+ConverteAcentos2(Form7.ibDAtaSet13MUNICIPIO.AsString)); // Municipio
            Writeln(F,'TelefonePrestador='+LimpaNumero(Form7.ibDAtaSet13TELEFO.AsString)); // Telefone
            Writeln(F,'EmailPrestador='+ConverteAcentos2(Form7.ibDAtaSet13EMAIL.AsString)); // E-mail
            Writeln(F,'CepPrestador='+LimpaNumero(Form7.ibDAtaSet13CEP.AsString));
            Writeln(F,'');
            //
            if Form7.ibDataSet13CRT.AsString = '1' then
            begin
              Writeln(F,'OptanteSimplesNacional=1');  // Indica se o prestador  optante do regime Simples Nacional	1 - SIM/ 2 -NO
            end else
            begin
              Writeln(F,'OptanteSimplesNacional=2');  // Indica se o prestador  optante do regime Simples Nacional	1 - SIM/ 2 -NO
            end;
            //
            Mais1ini := TIniFile.Create(Form1.sAtual+'\nfseConfig.ini');
            Writeln(F,'IncentivadorCultural='     +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','IncentivadorCultural'     ,'2')); //
            Writeln(F,'RegimeEspecialTributacao=' +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','RegimeEspecialTributacao' ,'1')); //
            Writeln(F,'NaturezaTributacao='       +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','NaturezaTributacao'       ,'1')); //
            Writeln(F,'IncentivoFiscal='          +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','IncentivoFiscal'          ,'1')); // Campo que indica se h ou no incentivo fiscal	1 - SIM/ 2 - NO
            //
            // Padrao BAURU
            //
            if (sPadraoSistema = 'BAURU') then
            begin
              if (AnsiUpperCase(Form7.ibDAtaset2CIDADE.AsString)=AnsiUpperCase(Form7.ibDAtaset13MUNICIPIO.AsString)) and (Length(LimpaNumero(Form7.ibDataSet2CGC.AsString)) = 14) then
              begin
                Writeln(F,'TipoTributacao=5'); // Tipo da tributao do RPS  '1' - Isenta de ISS '2' - Imune '3' - No Incidncia no Municpio '4' - No Tributvel '5' - Retida '6' - Tributvel dentro do municpio '7' - Tributvel fora do municpio '8'  Tributvel dentro do municpio pelo tomador
              end else
              begin
                Writeln(F,'TipoTributacao='           +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','TipoTributacao'           ,'6')); // Tipo da tributao do RPS  '1' - Isenta de ISS '2' - Imune '3' - No Incidncia no Municpio '4' - No Tributvel '5' - Retida '6' - Tributvel dentro do municpio '7' - Tributvel fora do municpio '8'  Tributvel dentro do municpio pelo tomador
              end;
            end else
            begin
              Writeln(F,'TipoTributacao='           +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','TipoTributacao'           ,'6')); // Tipo da tributao do RPS  '1' - Isenta de ISS '2' - Imune '3' - No Incidncia no Municpio '4' - No Tributvel '5' - Retida '6' - Tributvel dentro do municpio '7' - Tributvel fora do municpio '8'  Tributvel dentro do municpio pelo tomador
            end;
            //
            Writeln(F,'ExigibilidadeISS='         +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','ExigibilidadeISS'         ,'1')); // 1  - Exigvel,  2  - No incidncia,  3  - Iseno,  4  - Exportao,   5  - Imunidade,  6  - Exigibilidade Suspensa por Deciso Judicial,  7  - Exigibilidade Suspensa por Processo Administrativo.
            Writeln(F,'Operacao='                 +Mais1Ini.ReadString('Informacoes obtidas na prefeitura','Operacao'                 ,'A')); //
            //
            sCodigoCnae := Mais1Ini.ReadString('Informacoes obtidas na prefeitura','CodigoCnae'               ,''); // // CodigoCnae	Cdigo do CNAE	T	 Obtido na prefeitura
            sCodigoCnaePrestador := sCodigoCnae; // CNAE do prestador Sandro Silva 2023-02-28
            //
            Writeln(F,'');
            Mais1ini.Free;
            //
            ibDataSet35.First;
            //
            Form7.ibDataSet4.Close;
            Form7.ibDataSet4.Selectsql.Clear;
            Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet35DESCRICAO.AsString)+' ');  //
            Form7.ibDataSet4.Open;

            {Sandro Silva 2023-02-28 inicio}
            // Se tiver a tag <CNAEISSQN> preenchida na aba tags do estoque, dever us-la
            if Trim(RetornaValorDaTagNoCampo('CNAEISSQN', Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
              sCodigoCnae := Trim(RetornaValorDaTagNoCampo('CNAEISSQN', Form7.ibDataSet4.FieldByname('TAGS_').AsString));
            {Sandro Silva 2023-02-28 fim}
            //
            if AllTrim(RetornaValorDaTagNoCampo('CodigoTributacaoMunicipio',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
            begin
              Writeln(F,'CodigoTributacaoMunicipio='+AllTrim(RetornaValorDaTagNoCampo('CodigoTributacaoMunicipio',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Cdigo do item da lista de servio.	T	 Obtido na prefeitura
            end else
            begin
//              ShowMessage('Entre no cadastro de produtos e servios na aba tags e informe o cdigo (CodigoTributacaoMunicipio)(Obtido na prefeitura)');
//              Writeln(F,'CodigoTributacaoMunicipio='+ StrZero(Form7.ibDataSet14ISS.AsFloat,1,0) +'%');  // Perigo pode no ser assim em outras prefeituras     // CodigoTributacaoMunicipio	Cdigo tributao do municpio	T	 Obtido na prefeitura
            end;
            //
            Writeln(F,'MunicipioIncidencia='+Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7)); // Cdigo IBGE do municpio onde ocorrer a aplicao do imposto.	T	Usado quando o servio for retido.
            Writeln(F,'DescricaoCidadePrestacao='+ConverteAcentos2(Form7.ibDAtaSet13MUNICIPIO.AsString)); // Municpio onde o servio foi prestado
            Writeln(F,'');
            //
            Writeln(F,'CpfCnpjTomador='+LimpaNumero(Form7.ibDAtaSet2CGC.AsString));           // CPF / CNPJ do tomador do servio
            Writeln(F,'RazaoSocialTomador='+ConverteAcentos2(Form7.ibDAtaSet2NOME.AsString)); // Razo Social do tomador do servio
            Writeln(F,'InscricaoEstadualTomador='+LimpaNumero(Form7.ibDAtaSet2IE.AsString)); //
            Writeln(F,'InscricaoMunicipalTomador=');
            Writeln(F,'TipoLogradouroTomador=');
            Writeln(F,'EnderecoTomador='+ConverteAcentos2(Endereco_Sem_Numero(ibDAtaset2.FieldByname('ENDERE').AsString))); // Logradouro do Emitente
            Writeln(F,'NumeroTomador='+Numero_Sem_Endereco(ibDAtaset2.FieldByname('ENDERE').AsString)); // Numero do Logradouro do Emitente
            Writeln(F,'ComplementoTomador=');
            Writeln(F,'BairroTomador='+ConverteAcentos2(Form7.ibDAtaSet2COMPLE.AsString));
            //
            ibDataset99.Close;
            ibDataset99.SelectSql.Clear;
            ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet2CIDADE.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet2ESTADO.AsString))+' ');
            ibDataset99.Open;
            //
            Writeln(F,'CodigoCidadeTomador='+Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,7)); // Cdigo da Cidade do Emitente (Tabela do IBGE)
            Writeln(F,'DescricaoCidadeTomador='+ConverteAcentos2(Form7.ibDAtaSet2CIDADE.AsString)); // Municpio do tomador do servio
            Writeln(F,'UfTomador='+UpperCase(ibDataSet2ESTADO.AsString));                               // UF do tomador do servio
            Writeln(F,'CepTomador='+LimpaNumero(Form7.ibDAtaSet2CEP.AsString));                     // CEP do tomador do servio
            Writeln(F,'PaisTomador=1058');
            {Sandro Silva 2023-01-09 inicio}
            if (sPadraoSistema = 'ISSNETONLINE20') and (AnsiUpperCase(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString) + Form7.ibDataSet13ESTADO.AsString) = 'BRASILIADF') then
            begin
              Writeln(F,'DDDTomador=' + IntToStr(StrToIntDef(Copy(LimpaNumero(Form7.ibDataSet2FONE.AsString) + '000', 1, 3), 0)));
            end else
            {Sandro Silva 2023-01-09 fim}
            begin
              Writeln(F,'DDDTomador='+ Copy(LimpaNumero(Form7.ibDAtaSet2FONE.AsString)+'000',1,3) );
            end;
            Writeln(F,'TelefoneTomador='+AllTrim(Copy(LimpaNumero(Form7.ibDataSet2FONE.AsString)+'             ',4,9)));
            Writeln(F,'EmailTomador='+  Copy(Form7.ibDAtaSet2EMAIL.AsString,1,Pos(';',Form7.ibDAtaSet2EMAIL.AsString+';')-1)); // somente o primeiro e-mail cadastrado
            Writeln(F,'');
            //
            // Pis
            // Cofins
            // Inss
            // Ir
            // Csll
            //
            if Pos('(F)',Form7.ibDataset15MARCA.AsString) <> 0 then
            begin
              //
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString))    <> '' then Writeln(F,'AliquotaPIS='   +AllTrim(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    else Writeln(F,'AliquotaPIS=0.00');    except end; // Pis
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then Writeln(F,'AliquotaCOFINS='+AllTrim(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) else Writeln(F,'AliquotaCOFINS=0.00'); except end; /// Cofins
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then Writeln(F,'AliquotaINSS='  +AllTrim(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   else Writeln(F,'AliquotaINSS=0.00');   except end; /// Inss
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString))     <> '' then Writeln(F,'AliquotaIR='    +AllTrim(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     else Writeln(F,'AliquotaIR=0.00');     except end; /// Ir
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then Writeln(F,'AliquotaCSLL='  +AllTrim(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   else Writeln(F,'AliquotaCSLL=0.00');   except end; /// Csll
              //
              // Valor
              //
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString))    <> '' then Writeln(F,'ValorPIS='   +StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat) )),',','.')) else Writeln(F,'ValorPIS=0.00');    except end; /// Pis
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then Writeln(F,'ValorCOFINS='+StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat) )),',','.')) else Writeln(F,'ValorCOFINS=0.00'); except end; /// Cofins
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then Writeln(F,'ValorINSS='  +StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat) )),',','.')) else Writeln(F,'ValorINSS=0.00');   except end; /// Inss
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString))     <> '' then Writeln(F,'ValorIR='    +StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat) )),',','.')) else Writeln(F,'ValorIR=0.00');     except end; /// Ir
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then Writeln(F,'ValorCSLL='  +StrTran(Alltrim(FormatFloat('##0.00',StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat) )),',','.')) else Writeln(F,'ValorCSLL=0.00');   except end; /// Csll
              //
              // acumula a variavel fValorImpostosFederaisRetidos para descontar no valor lquido
              //
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString))    <> '' then fValorImpostosFederaisRetidos := fValorImpostosFederaisRetidos + Arredonda(StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat),2); except end; // Pis
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then fValorImpostosFederaisRetidos := fValorImpostosFederaisRetidos + Arredonda(StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat),2); except end; // Cofins
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then fValorImpostosFederaisRetidos := fValorImpostosFederaisRetidos + Arredonda(StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat),2); except end; // Inss
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString))     <> '' then fValorImpostosFederaisRetidos := fValorImpostosFederaisRetidos + Arredonda(StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat),2); except end; // Ir
              try if AllTrim(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then fValorImpostosFederaisRetidos := fValorImpostosFederaisRetidos + Arredonda(StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 *(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat),2); except end; // Csll
              //
            end;
            //
            Writeln(F,'OutrasRetencoes=0.00');
            Writeln(F,'DescontoIncondicionado='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.'));  //
            Writeln(F,'DescontoCondicionado=0.00');
            Writeln(F,'ValorDeducoes=0.00');
            Writeln(F,'');
            //
            Writeln(F,'AliquotaISS='+StrTran(StrZero(Form7.ibDataSet14ISS.AsFloat,1,5),',','.'));
            //
            // ISS Retido
            //
            if Pos('(I)',Form7.ibDataset15MARCA.AsString) <> 0 then
            begin
              Writeln(F,'IssRetido=1');
              fValorISSRetido := (ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)*Form7.ibDataSet14ISS.AsFloat/100;

              {Sandro Silva 2023-01-19 inicio}
              if (sPadraoSistema = 'ISSNETONLINE20') and (AnsiUpperCase(ConverteAcentos(Form7.ibDAtaset13MUNICIPIO.AsString) + Form7.ibDataSet13ESTADO.AsString) = 'BRASILIADF') then
              begin
                if Trim(sResponsavelRetencao) <> '' then
                  Writeln(F,'ResponsavelRetencao=' + sResponsavelRetencao);
              end;
              {Sandro Silva 2023-01-19 fim}

            end else
            begin
              Writeln(F,'IssRetido=2');
              fValorISSRetido := 0;
            end;
            //
            Writeln(F,'ValorLiquidoNfse='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat-fValorISSRetido-fValorImpostosFederaisRetidos)),',','.'));   //
            Writeln(F,'OutrasInformacoes='+ConverteAcentos2(Form7.ibDAtaSet15COMPLEMENTO.AsString));
            Writeln(F,'CodigoCidadePrestacao='+sCodigoLocalPrestacao); // Cdigo IBGE do municpio onde o servio foi prestado
            //
            Writeln(F,'');
            //
            // A prazo
            //
            if Form7.ibDataSet15DUPLICATAS.AsFloat >=1 then
            begin
              //
              // 1 ->  vista
              // 2 -> Na apresentao
              // 3 ->  prazo
              // 4 -> Carto dbito
              // 5 -> Carto crdito
              //
              J := 0;
              //
              Form7.ibDataSet7.First;
              while not Form7.ibDataSet7.Eof do
              begin
                //
                // Duplicatas
                //
                J := J + 1;
                //
                Writeln(F,'INCLUIRFORMAPAGAMENTO');
                Writeln(F,'TipoPagamento='+sTipoPagamentoAPrazo);
                Writeln(F,'Parcela='+IntToStr(J));
                Writeln(F,'DataVencimentoParcela='+StrTran(DateToStrInvertida(Form7.ibDataSet7VENCIMENTO.AsDateTime),'/','-')); // DAta de vencimento formato YYYY-MM-DD 1967-09-26
                Writeln(F,'ValorParcela='+StrTran(Alltrim(FormatFloat('##0.00',Form7.ibDataSet7VALOR_DUPL.AsFloat)),',','.'));  // Valor da duplicata
                Writeln(F,'QuantidadeParcelas='+StrTran(Alltrim(FormatFloat('##0',Form7.ibDataSet15DUPLICATAS.AsFloat)),',','.'));
                Writeln(F,'SALVARFORMAPAGAMENTO');
                Writeln(F,'');
                //
                Form7.ibDataSet7.Next;
                //                                                                        IntToStr
              end;
              //
            end else
            begin
              //
              // A vista no estou informando
              //
            end;
            //
            // Servios
            //
            ibDataSet35.First;
            //
            I := 1;
            //
            if not bMultiplosServicos then
            begin
              //
              sDescricaoDosServicos := '';
              //
              while not ibDataSet35.Eof do
              begin
                //
                try
                  sDescricaoDosServicos := sDescricaoDosServicos + ibDataSet35.FieldByname('QUANTIDADE').AsString +
                                           ' - ' +
                                           Alltrim(ConverteAcentos2(ibDataSet35.FieldByname('DESCRICAO').AsString)) +
                                           ' -         R$ ' +
                                           StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.')+'|';
                except end;
                //
                ibDataset35.Next;
                //
              end;
              //
              if (sPadraoSistema = 'GINFES') or (sPadraoSistema = 'FINTEL') then
              begin
                sDescricaoDosServicos := sDescricaoDosServicos + '|' + ConverteAcentos2(Form7.ibDAtaSet15COMPLEMENTO.AsString);
              end;
              //
              if sPadraoSistema = 'COPLAN' then
              begin
                sDescricaoDosServicos := StrTran(sDescricaoDosServicos,'|','   -   ');
              end;
              //
              Writeln(F,'');
              Writeln(F,'DiscriminacaoServico='+sDescricaoDosServicos);
              Writeln(F,'QuantidadeServicos=1'); //
              Writeln(F,'ValorUnitarioServico='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.'));
              Writeln(F,'UnidadeServico='+Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)));
              Writeln(F,'ValorServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.'));
              //
              // Situaes tributrias obtidas na prefeitura
              //
              if AllTrim(RetornaValorDaTagNoCampo('Tributavel',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
              begin
                Writeln(F,'Tributavel='+AllTrim(RetornaValorDaTagNoCampo('Tributavel',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Situaes tributrias obtidas na prefeitura
              end else
              begin
                if (sPadraoSistema = 'MAISISS20') then
                begin
                  Writeln(F,'Tributavel=1');
                end else
                begin
                  Writeln(F,'Tributavel=SIM');
                end;
              end;
              //
              // Dados do 1 Servio Vendido
              //
              if AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
              begin
                Writeln(F,'CodigoItemListaServico='+AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Cdigo do item da lista de servio.	T	 Obtido na prefeitura
              end else
              begin
                ShowMessage('Entre no cadastro de produtos e servios na aba tags e informe o cdigo (cServico)(Obtido na prefeitura)');
                Abort;
              end;
              //
              Writeln(F,'TipoDeducao=');
              Writeln(F,'CodigoCnae='+sCodigoCnae);                 // CodigoCnae	Cdigo do CNAE	T	 Obtido na prefeitura
              //
              if (sPadraoSistema = 'MAISISS20') then
              begin
                Writeln(F,'ValorIss=0.00');
              end else
              begin
                Writeln(F,'ValorIss='+StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)*Form7.ibDataSet14ISS.AsFloat/100)),',','.'));
              end;
              //
              Writeln(F,'ValorISSRetido='+StrTran(Alltrim(FormatFloat('##0.00',fValorISSRetido)),',','.')); // ISS Retido
              Writeln(F,'BaseCalculo='+StrTran(Alltrim(FormatFloat('##0.00',(ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat))),',','.'));   //
              Writeln(F,'CodigoCidadePrestacao='+sCodigoLocalPrestacao); // Cdigo IBGE do municpio onde o servio foi prestado
              Writeln(F,'');
              //
            end else
            begin
              //
              // Mltiplos servios 
              //
              while not ibDataSet35.Eof do
              begin
                //
                Form7.ibDataSet4.Close;
                Form7.ibDataSet4.Selectsql.Clear;
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet35DESCRICAO.AsString)+' ');  //
                Form7.ibDataSet4.Open;

                {Sandro Silva 2023-02-28 inicio}
                // Se tiver a tag <CNAEISSQN> preenchida na aba tags do estoque, dever us-la
                sCodigoCnae := sCodigoCnaePrestador; // Por padro usa o CNAE do prestador ([Informacoes obtidas na prefeitura] CodigoCnae=)
                if Trim(RetornaValorDaTagNoCampo('CNAEISSQN', Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                  sCodigoCnae := Trim(RetornaValorDaTagNoCampo('CNAEISSQN', Form7.ibDataSet4.FieldByname('TAGS_').AsString));
                {Sandro Silva 2023-02-28 fim}

                //
                if I = 1 then
                begin
                  //
                  // Dados do 1 Servio Vendido
                  //
                  Writeln(F,'');
                  Writeln(F,'DiscriminacaoServico='+Alltrim(ConverteAcentos2(ibDataSet35.FieldByname('DESCRICAO').AsString)));
                  if sPadraoSistema = 'SIL' then // Sandro Silva 2022-10-24
                    Writeln(F,'QuantidadeServicos='+StrTran(Alltrim(FormatFloat('##0.' + DupeString('0', StrToIntDef(Form1.ConfCasasServ, 0)) , ibDataSet35.FieldByname('QUANTIDADE').AsFloat)),',','.')) //
                  else
                    Writeln(F,'QuantidadeServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('QUANTIDADE').AsFloat)),',','.')); //
                  Writeln(F,'ValorUnitarioServico='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('UNITARIO').AsFloat)),',','.')); //
                  Writeln(F,'UnidadeServico='+Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)));
                  Writeln(F,'ValorServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat)),',','.'));
                  //
                  // Situaes tributrias obtidas na prefeitura
                  //
                  if AllTrim(RetornaValorDaTagNoCampo('Tributavel',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                  begin
                    Writeln(F,'Tributavel='+AllTrim(RetornaValorDaTagNoCampo('Tributavel',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Situaes tributrias obtidas na prefeitura
                  end else
                  begin
                    if (sPadraoSistema = 'MAISISS20') then
                    begin
                      Writeln(F,'Tributavel=1');
                    end else
                    begin
                      Writeln(F,'Tributavel=SIM');
                    end;
                  end;
                  //
                  // Dados do 1 Servio Vendido
                  //
                  if AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                  begin
                    Writeln(F,'CodigoItemListaServico='+AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Cdigo do item da lista de servio.	T	 Obtido na prefeitura
                  end else
                  begin
                    ShowMessage('Entre no cadastro de produtos e servios na aba tags e informe o cdigo (cServico)(Obtido na prefeitura)');
                    Abort;
                  end;
                  //
                  Writeln(F,'TipoDeducao=');
                  Writeln(F,'CodigoCnae='+sCodigoCnae);                 // CodigoCnae	Cdigo do CNAE	T	 Obtido na prefeitura
                  //
                  if (sPadraoSistema = 'MAISISS20') then
                  begin
                    Writeln(F,'ValorIss=0.00');
                  end else
                  begin
                    Writeln(F,'ValorIss='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat*Form7.ibDataSet14ISS.AsFloat/100)),',','.'));
                  end;
                  //
                  Writeln(F,'ValorISSRetido='+StrTran(Alltrim(FormatFloat('##0.00',fValorISSRetido)),',','.')); // ISS Retido
                  Writeln(F,'BaseCalculo='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.'));   //
                  Writeln(F,'CodigoCidadePrestacao='+sCodigoLocalPrestacao); // Cdigo IBGE do municpio onde o servio foi prestado
                  Writeln(F,'');
                  //
                end else
                begin
                  //
                  Writeln(F,'');
                  Writeln(F,'INCLUIRSERVICO');
                  Writeln(F,'');
                  //
                  Writeln(F,'DiscriminacaoServico='+Alltrim(ConverteAcentos2(ibDataSet35.FieldByname('DESCRICAO').AsString)));
                  if sPadraoSistema = 'SIL' then // Sandro Silva 2022-10-24
                    Writeln(F,'QuantidadeServicos='+StrTran(Alltrim(FormatFloat('##0.' + DupeString('0', StrToIntDef(Form1.ConfCasasServ, 0)) , ibDataSet35.FieldByname('QUANTIDADE').AsFloat)),',','.')) //
                  else
                    Writeln(F,'QuantidadeServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('QUANTIDADE').AsFloat)),',','.')); //
                  Writeln(F,'ValorUnitarioServico='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('UNITARIO').AsFloat)),',','.')); //
                  Writeln(F,'UnidadeServico='+Alltrim(ConverteAcentos2(ibDataSet4.FieldByname('MEDIDA').AsString)));
                  Writeln(F,'ValorServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.')); //
                  Writeln(F,'ValorLiquidoServico='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.')); //
                  //
                  // Situaes tributrias obtidas na prefeitura
                  //
                  if AllTrim(RetornaValorDaTagNoCampo('Tributavel',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                  begin
                    Writeln(F,'Tributavel='+AllTrim(RetornaValorDaTagNoCampo('Tributavel',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Situaes tributrias obtidas na prefeitura
                  end else
                  begin
                    if (sPadraoSistema = 'MAISISS20') then
                    begin
                      Writeln(F,'Tributavel=1');
                    end else
                    begin
                      Writeln(F,'Tributavel=SIM');
                    end;
                  end;
                  //
                  // Dados do 1 Servio Vendido
                  //
                  if AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
                  begin
                    Writeln(F,'CodigoItemListaServico='+AllTrim(RetornaValorDaTagNoCampo('cServico',form7.ibDataSet4.FieldByname('TAGS_').AsString))); // Cdigo do item da lista de servio.	T	 Obtido na prefeitura
                  end else
                  begin
                    Writeln(F,'CodigoItemListaServico='); // Cdigo do item da lista de servio.	T	 Obtido na prefeitura
                  end;
                  //
                  Writeln(F,'TipoDeducao=');
                  Writeln(F,'CodigoCnae='+sCodigoCnae);                 // CodigoCnae	Cdigo do CNAE	T	 Obtido na prefeitura
                  Writeln(F,'ValorIss='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat*Form7.ibDataSet14ISS.AsFloat/100)),',','.'));
                  Writeln(F,'ValorISSRetido='+StrTran(Alltrim(FormatFloat('##0.00',fValorISSRetido)),',','.')); // ISS Retido
                  Writeln(F,'BaseCalculo='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.'));   //
                  Writeln(F,'CodigoCidadePrestacao='+sCodigoLocalPrestacao); // Cdigo IBGE do municpio onde o servio foi prestado
                  Writeln(F,'ValorServicos='+StrTran(Alltrim(FormatFloat('##0.00',ibDataSet35.FieldByname('TOTAL').AsFloat)),',','.')); //
                  Writeln(F,'AliquotaServico='+StrTran(StrZero(Form7.ibDataSet14ISS.AsFloat,1,2),',','.'));
                  //
                  Writeln(F,'');
                  Writeln(F,'SALVARSERVICO');
                  Writeln(F,'');
                  //
                end;
                //
                I := I + 1;
                //
                ibDataset35.Next;
                //
              end;
            end;
            //
            Writeln(F,'');
            Writeln(F,'SALVARRPS');
            //
          end;
          //
          CloseFile(F);
          //
          // Aguarda at criar o arquivo
          //
          while not FileExists(pChar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
          begin
            Sleep(100);
          end;
          //
          if (Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) = 0) or (Limpanumero(Form7.ibDAtaSet15NFEPROTOCOLO.AsString) = '1') or (Limpanumero(Form7.ibDAtaSet15NFEPROTOCOLO.AsString) = '') then
          begin
            //
            try
              //
              //  J grava o arquivo de envio para no perder no caso de joinvile
              //
              _file1 := TStringList.Create;
              _file1.LoadFromFile(pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));
              //
              if (RetornaValorDaTagNoCampo('Status',_file1.Text) <> 'EM PROCESSAMENTO') or (Form1.sConsultaNfse <> 'SIM') then
              begin
                //
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
                //
                // Para resolver o problema de Joinvile
                //
                if AllTrim(RetornaValorDaTagNoCampoCRLF('XMLdeEvio',Form7.ibDAtaSet15RECIBOXML.AsString)) <> '' then
                begin
                  _File1.Text :=  '<XMLdeEvio>'+AllTrim(Form7.ibDAtaSet15NFEXML.AsString)+'</XMLdeEvio>' + _File1.Text;
                end;
                //
                if AllTrim(RetornaValorDaTagNoCampoCRLF('tx2',Form7.ibDAtaSet15RECIBOXML.AsString)) <> '' then
                begin
                  _File1.Text :=  '<tx2>'+AllTrim(RetornaValorDaTagNoCampoCRLF('tx2',Form7.ibDAtaSet15RECIBOXML.AsString))+'</tx2>' + _File1.Text;
                end else
                begin
                  _File1.Text :=  '<tx2>'+AllTrim(_file1.Text)+'</tx2>';
                end;
                //
                // End
                //
                Form7.ibDAtaSet15RECIBOXML.AsString := _file1.Text; // Logo que o arquivo .tx2 e criado j grava no RECIBOXML
                Form7.ibDAtaSet15.Post;
                Form7.ibDAtaSet15.Edit;
                //
              end;
              //
            except
            end;
          end;
          //
          Form7.ibDataSet15.DisableControls;
          //
          while FileExists(Pchar(Form1.sAtual+'\NFSE\ret.txt')) do
          begin
            DeleteFile(Pchar(Form1.sAtual+'\NFSE\ret.txt'));
            Sleep(100);
          end;
          //
          if Form1.Debug1.Checked then
          begin
            ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'),'','', SW_SHOWMAXIMIZED);
            ShowMessage('Tecle Ok para continuar');
          end;
          //
          ShellExecute( 0, 'Open',pChar('NFSE.EXE'),'', '', SW_SHOW);
          //
          // Aguarda fechar o NFSE.EXE
          //
          while ConsultaProcesso('NFSE.EXE') or ConsultaProcesso('NFSE.exe') or ConsultaProcesso('nfse.exe') do
          begin
            sleep(100);
          end;
          //
          // Verifica o retorno
          //
          while not FileExists(Pchar(Form1.sAtual+'\NFSE\ret.txt')) do
          begin
            Sleep(100);
          end;
          //
          if Form1.Debug1.Checked then
          begin
            ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\NFSE\ret.txt'),'','', SW_SHOWMAXIMIZED);
            ShowMessage('Tecle Ok para continuar');
          end;
          //
          if Form1.sConsultaNfse = 'SIM' then
          begin
            //
            _file := TStringList.Create;
            _file.LoadFromFile(pChar(Form1.sAtual+'\NFSE\ret.txt'));
            //
//            _File.Text := StrTran(_File.Text,'Elt;brEgt;','|');
//            _File.Text := StrTran(_File.Text,#9,'');

            sRetornoNFse := _File.Text;
            //
            // Quando no volta o Numero da NFE
            //
            if (Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) = 0) or (Limpanumero(Form7.ibDAtaSet15NFEPROTOCOLO.AsString) = '1') or (Limpanumero(Form7.ibDAtaSet15NFEPROTOCOLO.AsString) = '') then
            begin
              Form1.sConsultaNfse := 'NAO';
            end else
            begin
              //
              if RetornaValorDaTagNoCampo('Status',sRetornoNFse) <> '' then
              begin
                ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\NFSE\ret.txt'),'','', SW_SHOWMAXIMIZED);
                ShowMessage('Tecle Ok para continuar');
              end;
              //
              if Application.MessageBox(Pchar('Gravar estas informaes no recibo da NFS-e?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION) = IDYES then
              begin
                Form1.sConsultaNfse := 'NAO';
              end;
              //
            end;
          end;
          //
          if Form1.sConsultaNfse = 'SIM' then
          begin
            //
            Form1.sConsultaNfse := 'NAO';
            //
          end else
          begin
            //
            if FileExists(pChar(Form1.sAtual+'\NFSE\ret.txt')) then
            begin
              //
              _file := TStringList.Create;
              _file.LoadFromFile(pChar(Form1.sAtual+'\NFSE\ret.txt'));
              //

//              _File.Text := StrTran(_File.Text,'Elt;brEgt;','|');
//              _File.Text := StrTran(_File.Text,#9,'');

              sRetornoNFse := _File.Text;
              //
              Form7.ibDAtaSet15.Edit;
              //
              try
                //
                // Quando no volta o Numero da NFE
                //
                if (Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) = 0) or (Limpanumero(Form7.ibDAtaSet15NFEPROTOCOLO.AsString) = '1') or (Limpanumero(Form7.ibDAtaSet15NFEPROTOCOLO.AsString) = '') then
                begin
                  //
                  if (AllTrim(RetornaValorDaTagNoCampoCRLF('XMLdeEvio',_File.Text)) = '') then
                  begin
                    if AllTrim(RetornaValorDaTagNoCampoCRLF('XMLdeEvio',Form7.ibDAtaSet15RECIBOXML.AsString)) <> '' then
                    begin
                      _File.Text := '<XMLdeEvio>'+AllTrim(Form7.ibDAtaSet15NFEXML.AsString)+'</XMLdeEvio>' + chr(10) + _File.Text;
                    end;
                  end;
                  //
                  if (AllTrim(RetornaValorDaTagNoCampoCRLF('tx2',_File.Text)) = '') then
                  begin
                    if AllTrim(RetornaValorDaTagNoCampoCRLF('tx2',Form7.ibDAtaSet15RECIBOXML.AsString)) <> '' then
                    begin
                      _File.Text := '<tx2>'+AllTrim(RetornaValorDaTagNoCampoCRLF('tx2',Form7.ibDAtaSet15RECIBOXML.AsString))+'</tx2>'+ chr(10) + chr(10) + _File.Text;
                    end;
                  end;
                  //
                  Form7.ibDAtaSet15RECIBOXML.AsString := StrTran(StrTran(_File.Text,'<tx2></tx2>',''),'<XMLdeEvio></XMLdeEvio>',''); // Retorno da Prefeitura
                  //
                  Form7.ibDataSet15.Post;
                  Form7.ibDataSet15.Edit;
                  //
                  if RetornaValorDaTagNoCampo('Status',Form7.ibDAtaSet15RECIBOXML.AsString)       <> '' then
                    Form7.ibDAtaSet15STATUS.AsString        := AllTrim(RetornaValorDaTagNoCampo('Status',Form7.ibDAtaSet15RECIBOXML.AsString));
                  if RetornaValorDaTagNoCampo('Situacao',Form7.ibDAtaSet15RECIBOXML.AsString)     <> '' then
                    Form7.ibDAtaSet15STATUS.AsString        := AllTrim(RetornaValorDaTagNoCampo('Situacao',Form7.ibDAtaSet15RECIBOXML.AsString));
                  if RetornaValorDaTagNoCampo('numero_nfse',Form7.ibDAtaSet15RECIBOXML.AsString)  <> '' then
                    Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('numero_nfse',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('serie_nfse',Form7.ibDAtaSet15RECIBOXML.AsString));
                  //
                  BuscaNumeroNFSe(True);
                  //
                  if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) <> 0 then
                  begin
                    //
                    Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
                    Form7.ibDataSet15.Post;
                    Form7.ibDataSet15.Edit;
                    //
                    // Data da ltima venda para o cliente
                    //
                    try
                      if  Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime then
                      begin
                        Form7.ibDataSet2.Edit;
                        Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
                        Form7.ibDataSet2.Post;
                      end;
                    except end;
                    //
                  end;
                  //
                  sArquivoXML := RetornaValorDaTagNoCampo('ArquivoGeradorNfse',sRetornoNFse);
                  //
                  if AllTrim(sArquivoXML) <> '' then
                  begin
                    //
                    if Pos('\NFSE\',UpperCase(sArquivoXML)) = 0 then
                    begin
                      sArquivoXML := Form1.sAtual+'\NFSE\Log\'+sArquivoXML;
                    end else
                    begin
                      sArquivoXML := sArquivoXML;
                    end;
                    //
                    if FileExists(sArquivoXML) then
                    begin
                      _XML := TStringList.Create;
                      _XML.LoadFromFile(sArquivoXML);
                      //
                      Form7.ibDAtaSet15NFEXML.AsString    := pChar(_XML.Text);
                      Form7.ibDataSet15MODELO.AsString    := 'SV';
                      //
                    end;
                  end;
                end;
                //
              except
                on E: Exception do
                begin
                  Application.MessageBox(pChar(E.Message),'Erro no retorno da NFS-e: ',mb_Ok + MB_ICONWARNING);
                end;
              end;
              //
              Form7.ibDAtaSet15.Post;
              Form7.ibDAtaSet15.Edit;
              //
            end;
            //
            //
            while FileExists(Pchar(Form1.sAtual+'\NFSE\ret.txt')) do
            begin
              DeleteFile(Pchar(Form1.sAtual+'\NFSE\ret.txt'));
              Sleep(100);
            end;
            //
          end;
          //
        end else
        begin
          Screen.Cursor            := crDefault;
          ShowMessage('No  possvel emitir a nota de servio com valor 0 (Zero).'); // Servios Zerado
        end;
        //
      end else
      begin
        Screen.Cursor            := crDefault;
        ShowMessage('NFS-e j emitida e autorizada.'); // J foi autorizada
      end;
    end; // NFSE.EXE nao instalado
  except end;
  //
  Form7.ibDataSet15.EnableControls;
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.Visu1Click(Sender: TObject);
var
  F : TextFile;
  sPDF : String;
begin
  //
  BuscaNumeroNFSe(True);
  //
  fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
  //
  try
    sPDF := pChar(Form1.sAtual+'\NFSE\LOG\'+Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)+'.pdf');
  except
  end;
  //
  if not (FileExists(pChar(sPDF))) and (Form7.ibDataSet15EMITIDA.AsString = 'S') then
  begin
    try
      AssignFile(F,pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);
      //
      Writeln(F,'<Small>GerarPDF=Sim</Small>');
      Writeln(F,'<sNumeroDaNFSE>'+Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)+'<sNumeroDaNFSE>');
      //
      {Sandro Silva 2023-01-26 inicio
      Writeln(F,'<XMLdeEvio>'+Form7.ibDAtaSet15NFEXML.AsString+'</XMLdeEvio>');
      }
      if (RetornaValorDaTagNoCampo('nfseCabecMsg', Form7.ibDAtaSet15NFEXML.AsString) <> '') and (RetornaValorDaTagNoCampo('nfseDadosMsg', Form7.ibDAtaSet15NFEXML.AsString) <> '') and (AnsiUpperCase(Form7.ibDataSet13MUNICIPIO.AsString) = 'BRASLIA') then
        Writeln(F,'<XMLdeEvio>' + '<Nfse><nfseCabecMsg>' + RetornaValorDaTagNoCampo('nfseCabecMsg', Form7.ibDAtaSet15NFEXML.AsString) + '</nfseCabecMsg><nfseDadosMsg>' + RetornaValorDaTagNoCampo('nfseDadosMsg', Form7.ibDAtaSet15NFEXML.AsString) + '</nfseDadosMsg></Nfse>' + '</XMLdeEvio>')
      else
        Writeln(F,'<XMLdeEvio>'+Form7.ibDAtaSet15NFEXML.AsString+'</XMLdeEvio>');
      {Sandro Silva 2023-01-26 fim}
      //
      if Pos('CompNfse',Form7.ibDAtaSet15RECIBOXML.AsString) <> 0 then
      begin
        Writeln(F,'<XMLImpressao>'+ExtraiNodeXml(Form7.ibDAtaSet15RECIBOXML.AsString,'CompNfse')+'</XMLImpressao>');
      end else
      begin
        {Sandro Silva 2023-01-26 inicio
        Writeln(F,'<XMLImpressao>'+Form7.ibDAtaSet15RECIBOXML.AsString+'</XMLImpressao>');
        }
        if (RetornaValorDaTagNoCampo('Nfse', Form7.ibDAtaSet15RECIBOXML.AsString) <> '') and (AnsiUpperCase(Form7.ibDataSet13MUNICIPIO.AsString) = 'BRASLIA') then
          Writeln(F,'<XMLImpressao>' + RetornaValorDaTagNoCampo('Nfse', Form7.ibDAtaSet15RECIBOXML.AsString) + '</XMLImpressao>')
        else
          Writeln(F,'<XMLImpressao>'+Form7.ibDAtaSet15RECIBOXML.AsString+'</XMLImpressao>');
        {Sandro Silva 2023-01-26 fim}
      end;
      //
      CloseFile(F);
      //
      // Aguarda at criar o arquivo
      //
      while not FileExists(pChar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
      begin
        Sleep(100);
      end;
      //
      ShellExecute( 0, 'Open',pChar('NFSE.EXE'),'', '', SW_SHOW);
      //
      while ConsultaProcesso('NFSE.EXE') or ConsultaProcesso('NFSE.exe') or ConsultaProcesso('nfe.exe') do
      begin
        Application.ProcessMessages;
        sleep(100);
      end;
      //
    except end;
  end;
  //
  //  ShowMessage(sPDF);
  //
  if (FileExists(pChar(sPDF))) and (Form7.ibDataSet15EMITIDA.AsString = 'S') then
  begin
    ShellExecute( 0, 'Open',pChar(sPDF),'', '', SW_SHOWMAXIMIZED);
  end else
  begin
    //
    if RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe) <> '' then
    begin
      ShellExecute( 0, 'Open',pChar(RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe)),'', '', SW_SHOWMAXIMIZED);
    end else
    begin
      if RetornaValorDaTagNoCampo('link',fNFe) <> '' then
      begin
        ShellExecute( 0, 'Open',pChar(RetornaValorDaTagNoCampo('link',fNFe)),'', '', SW_SHOWMAXIMIZED);
      end else
      begin
        //
        fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
        //
        if RetornaValorDaTagNoCampo('codigo_html',fNFe) <> '' then
        begin
          //
          Screen.Cursor            := crHourGlass;
          //
          fNFe := RetornaValorDaTagNoCampo('codigo_html',fNFe);
          fNFe := StrTran(StrTran(StrTran(StrTran( FNfe,'&lt;','<'),'&gt;','>'),'&amp;nbsp;',' '),'&quot;','"');
          fNFe := StrTran( FNfe,'Software FiscalWeb- IPM Sistemas - Protegido por Lei.','<a href="https://www.smallsoft.com.br">www.smallsoft.com.br</a>');
          //
          fNFe := '<codigo_html>'+fNFe+'</codigo_html>';
          AssignFile(F,pchar(Form1.sAtual+'\tempo.html'));  // Direciona o arquivo F para EXPORTA.TXT
          Rewrite(F);                  // Abre para gravao
          Write(F,fNFe);
          CloseFile(F); // Fecha o arquivo
          //
          //    HtmlParaPdf(pchar(Form1.sAtual+'\tempo.htm'));
          //    ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\tempo.pdf'),'', '', SW_SHOWMAXIMIZED);
          //
          ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\tempo.html'),'', '', SW_SHOWMAXIMIZED);
          //
          Screen.Cursor            := crDefault;
          //
        end else
        begin
          ShowMessage('No foi possvel visualizar o NFS-e.');
        end;
      end;
    end;
  end;
  //
end;

procedure TForm7.EnviarNFSeporemail1Click(Sender: TObject);
var
  F : TextFile;
  sPDF : String;
begin
  //
  if (validaEmail(Form7.ibDAtaSet2eMail.Asstring)) then
  begin
    //
    BuscaNumeroNFSe(True);
    //
    fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
    //
    try
      sPDF := pChar(Form1.sAtual+'\NFSE\LOG\'+Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)+'.pdf');
    except end;
    //
    //
    if (FileExists(pChar(sPDF))) and (Form7.ibDataSet15EMITIDA.AsString = 'S') then
    begin
      Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue em anexo sua NFS-e em arquivo PDF.'+chr(10)+Form1.sPropaganda),pChar(sPDF),False);
    end else
    begin
      //
      if RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe) <> '' then
      begin
        Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue link da sua NFS-e:'+chr(10)+chr(10)+pChar(RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe))+chr(10)+Form1.sPropaganda),'',False);
      end else
      begin
        if RetornaValorDaTagNoCampo('link',fNFe) <> '' then
        begin
          Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue link da sua NFS-e:'+chr(10)+chr(10)+pChar(RetornaValorDaTagNoCampo('link',fNFe))+chr(10)+Form1.sPropaganda),'',False);
        end else
        begin
          //
          fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
          //
          if RetornaValorDaTagNoCampo('codigo_html',fNFe) <> '' then
          begin
            //
            Screen.Cursor            := crHourGlass;
            //
            fNFe := RetornaValorDaTagNoCampo('codigo_html',fNFe);
            fNFe := StrTran(StrTran(StrTran(StrTran( FNfe,'&lt;','<'),'&gt;','>'),'&amp;nbsp;',' '),'&quot;','"');
            fNFe := StrTran( FNfe,'Software FiscalWeb- IPM Sistemas - Protegido por Lei.','<a href="https://www.smallsoft.com.br">www.smallsoft.com.br</a>');
            //
            fNFe := '<codigo_html>'+fNFe+'</codigo_html>';
            AssignFile(F,pchar(Form1.sAtual+'\tempo.html'));  // Direciona o arquivo F para EXPORTA.TXT
            Rewrite(F);                  // Abre para gravao
            Write(F,fNFe);
            CloseFile(F); // Fecha o arquivo
            //
            //    HtmlParaPdf(pchar(Form1.sAtual+'\tempo.htm'));
            //    ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\tempo.pdf'),'', '', SW_SHOWMAXIMIZED);
            //
            Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue em anexo sua NFS-e em arquivo HTML.'+chr(10)+Form1.sPropaganda),pChar(Form1.sAtual+'\tempo.html'),False);
            //
            Screen.Cursor            := crDefault;
            //
          end else
          begin
//            ShowMessage('No foi possvel enviar o E-Mail da NFS-e.');
          end;
        end;
      end;
    end;
  end;
  //
end;

procedure TForm7.CancelarNFSe1Click(Sender: TObject);
var
  bButton : Integer;
  sRetornoNFse : String;
  _file : TStringList;
  F: TextFile;
  Mais1Ini : tIniFile; // 2022-07-14
  sPadraoSistema: String; //2022-07-14
begin
  //
  // <ChaveDeCancelamento>33|0180830053723381___</ChaveDeCancelamento>
  //
  try
    //2022-07-14 Identificar o padro da prefeitura
    Mais1ini := TIniFile.Create(Form1.sAtual+'\nfseConfig.ini');
    sPadraoSistema := UpperCase(Mais1Ini.ReadString('Informacoes obtidas na prefeitura','Padrao','?'));
    Mais1Ini.Free;
    //
    if RetornaValorDaTagNoCampo('ChaveDeCancelamento',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
    begin
      //
      Screen.Cursor            := crHourGlass;
      //
      {Sandro Silva 2023-01-11 inicio
      if not FileExists(pChar(Form1.sAtual+'\NFSE.EXE')) then
      begin
        ShowMessage('Mdulo de transmisso de NFS-e no instalado');
      end else
      }
      if Form1.ExisteNfseExe(Form1.sAtual) then
      begin
        //
        //
        while FileExists(Pchar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
        begin
          DeleteFile(Pchar(Form1.sAtual+'\NFSE\smallnfse.tx2'));
          Sleep(100);
        end;
        //
        AssignFile(F,pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));  // Direciona o arquivo F para EXPORTA.TXT
        Rewrite(F);
        //
//        Writeln(F,'ChaveDeCancelamento='+RetornaValorDaTagNoCampo('numero_nfse',Form7.ibDAtaSet15RECIBOXML.AsString)+'|'+RetornaValorDaTagNoCampo('cod_verificador_autenticidade',Form7.ibDAtaSet15RECIBOXML.AsString)+'___');
        Writeln(F,'ChaveDeCancelamento='+RetornaValorDaTagNoCampo('ChaveDeCancelamento',Form7.ibDAtaSet15RECIBOXML.AsString));
        Writeln(F,'');
        //
        CloseFile(F);
        //
        // Aguarda at criar o arquivo
        //
        while not FileExists(pChar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
        begin
          Sleep(100);
        end;
        //
        ShellExecute( 0, 'Open',pChar('NFSE.EXE'),'', '', SW_SHOW);
        //
        // Aguarda fechar o NFSE.EXE
        //
        while ConsultaProcesso('NFSE.EXE') or ConsultaProcesso('NFSE.exe') or ConsultaProcesso('nfe.exe') do
        begin
          Application.ProcessMessages;
          sleep(100);
        end;
        //
        // Verifica o retorno
        //
        if FileExists(pChar(Form1.sAtual+'\NFSE\ret.txt')) then
        begin
          //
          _file := TStringList.Create;
          _file.LoadFromFile(pChar(Form1.sAtual+'\NFSE\ret.txt'));
          //
//          _File.Text := StrTran(_File.Text,'Elt;brEgt;','|');
//          _File.Text := StrTran(_File.Text,#9,'');

          sRetornoNFse := _File.Text;
          //
          if Pos('CANCELADA',_File.Text)<>0 then
          begin
            //
            CancelarNFSe(_File.Text);
            //
          end else
          begin
            //
            if RetornaValorDaTagNoCampo('Motivo',_File.Text) <> '' then
            begin
              sRetornoNFse := RetornaValorDaTagNoCampo('Motivo',_File.Text);
            end;
            //

            if (sPadraoSistema = 'MEMORY') then //2022-07-14 eliminado sRetornoNFSe, deixa muito grande a mensagem e esconde os botes Sim e No
              bButton := Application.MessageBox(pChar(
                        chr(10) +'No foi possvel identificar se a NFS-e foi cancelada'+
                        chr(10) +'com base no retorno do sistema da prefeitura.'+Chr(10)+
                        chr(10) +'Verifique no sistema de prefeitura se a nota foi cancelada'+Chr(10)+
                        chr(10) +'e clique em Sim para cancelar no Small'+
                        chr(10)+
                        'Considerar esta NFS-e como cancelada?'),
                        'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION)
            else
              bButton := Application.MessageBox(pChar(
                        sRetornoNFse+
                        chr(10)+
                        chr(10) +'No foi possvel identificar se a NFS-e foi cancelada'+
                        chr(10) +'com base no retorno do sistema da prefeitura.'+Chr(10)+
                        chr(10)+
                        'Considerar esta NFS-e como cancelada?'),
                        'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION);
            //
            if bButton = IDYES  then
            begin
              CancelarNFSe('<RETORNO>'+_File.Text+'<SITUACAO>CANCELADA</SITUACAO><STATUS>CANCELADA</STATUS>'+'</RETORNO>');
            end;
            //
          end;
          //
        end;
        //
        while FileExists(Pchar(Form1.sAtual+'\NFSE\ret.txt')) do
        begin
          DeleteFile(Pchar(Form1.sAtual+'\NFSE\ret.txt'));
          Sleep(100);
        end;
        //
      end;
    end else
    begin
      //
      bButton := Application.MessageBox(pChar(
                chr(10) +'No foi possvel cancelar a NFS-e no temos a chave de cancelamento.'+Chr(10)+
                chr(10) +'Esta NFS-e poder ser cancelada manualmente no site da prefeitura.'+Chr(10)+
                chr(10)+
                'Considerar esta NFS-e como cancelada?'),
                'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION);
      //
      if bButton = IDYES  then
      begin
        CancelarNFSe('<RETORNO><SITUACAO>CANCELADA</SITUACAO><STATUS>CANCELADA</STATUS></RETORNO>');
      end;
    end;
    //
  except end;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.SMALL_DBEdit3Change(Sender: TObject);
begin
//  MostraNFSe(True);
end;

procedure TForm7.ibDataSet35DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  //
  ibDataSet35DESCRICAO.AsString := Text;
  //
  if Form48.Visible then
  begin
    //
    // Procura por descrio
    //
    Form7.ibDataSet99.DisableControls;
    Form7.ibDataSet99.Close;
    Form7.ibDataSet99.SelectSQL.Clear;
    Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where TIPO_ITEM='+QuotedStr('09')+' and Coalesce(Ativo,0)=0 and Upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(Form7.ibDataSet35DESCRICAO.AsString)+'%')+' order by DESCRICAO');
    Form7.ibDataSet99.Open;
    Form7.ibDataSet99.First;
    Form7.IBDataSet99.EnableControls;
    //
    Form7.ibDataSet4.Locate('DESCRICAO',AllTrim( Form7.ibDataSet99.FieldByname('DESCRICAO').AsString  ),[loCaseInsensitive, loPartialKey]);
    Form7.ibDataSet4.EnableControls;
    //
  end;
  //
end;

procedure TForm7.GerarNotaFiscaldeServio1Click(Sender: TObject);
begin
  //
  // Gera a nota fiscal de Servico
  //
  if Form1.bNotaVendaLiberada then
  begin
    //
    if Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString = '' then
    begin
      //
      Form41.MaskEdit1.Text := Form7.ibDataSet97.FieldByname('Oramento').AsString;
      Form7.Close;
      Form1.Image201SClick(Sender);                       // Nota Fiscal de Servico
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.Importaroramentos1Click(Sender);             // Importa OS
      //
    end;
  end else
  begin
    ShowMessage('Emisso de NFS-e no liberada para este usurio.');
  end;
  //
end;

procedure TForm7.GerarNotaFiscaldeServio2Click(Sender: TObject);
begin
  //
  // Gera a nota fiscal
  //
  if Form1.bNotaVendaLiberada then
  begin
    //
    if Form7.ibDataSet3SITUACAO.AsString <> 'Fechada' then
    begin
      //
      Form41.MaskEdit1.Text := Form7.ibDataSet3NUMERO.AsString;
      Form7.Close;
      //
      Form1.Image201SClick(Sender);                       // Nota fiscal Nota Fiscal de Servico
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.ImportarOS2Click(Sender);                    // Importa OS
      //
    end;
  end else
  begin
    ShowMessage('Emisso de NF no liberada para este usurio.');
  end;
  //
end;

procedure TForm7.ConsultarNFSe1Click(Sender: TObject);
begin
  //
  Form1.sConsultaNfse := 'SIM';
  N6EnviarNFeConsultareImprimirDANFE1Click(Sender);
  //
  Form1.sConsultaNfse := 'NAO';
  //
end;

procedure TForm7.ConfiguraesdaNFSe1Click(Sender: TObject);
begin
  Form1.ConfiguraesdaNFSe2Click(Sender);
end;

procedure TForm7.NFeTransmitirasprximas1Click(Sender: TObject);
begin
  //
  bProximas := True;
  while not Form7.ibDataSet15.Eof do
  begin
    ransmitirNotaFiscaldeServioNFSe1Click(Sender);
    EnviarNFSeporemail1Click(Sender);
    Form7.ibDataSet15.Next;
  end;
  //
  bProximas := False;
  //
  try
    try
      Form7.ibDAtaSet15.Post;
    except end;
    //
    Screen.Cursor            := crHourGlass;
    AgendaCommit(True);
    //
    Form7.Close;
    Form7.Show;
    //
    Screen.Cursor            := crDefault;
    Form7.ibDAtaSet15.Edit;
    //
  except end;
  //
  Screen.Cursor            := crDefault;
  //
end;

procedure TForm7.DevolverNF1Click(Sender: TObject);
begin
  //
  Form1.Image201Click(Form1.Image201);
  Form7.Image101Click(Form7.Image201);
  //
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet24FORNECEDOR.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  Form7.ibDataSet15CLIENTE.AsString     := Form7.ibDataSet2NOME.AsString;
  Form7.ibDataSet15DESCONTO.AsFloat     := Form7.ibDataSet24DESCONTO.AsFloat;
  Form7.ibDataSet15COMPLEMENTO.AsString := 'ID da NF-e referenciada:' + Form7.ibDataSet24NFEID.AsString;
  //
//  Form7.ibDataSet14.DisableControls;
  Form7.ibDataSet14.Close;
  Form7.ibDataSet14.SelectSQL.Clear;
  Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or SubString(CFOP from 1 for 1) = ''7'' order by upper(NOME)');
  Form7.ibDataSet14.Open;
//  Form7.ibDataSet14.EnableControls;
  //
  Form7.ibDataSet14.Locate('NOME','DEVOLU',[loCaseInsensitive, loPartialKey]);
  //
  if pos('DEVOLU',UpperCase(Form7.ibDataSet14NOME.AsString)) = 0  then
  begin
    Form7.ibDataSet14.Append;
    Form7.ibDataSet14CFOP.AsString := '6202';
    Form7.ibDataSet14NOME.AsString := 'Devoluo';
    Form7.ibDataSet14.Post;
  end;
  //
  Form12.Edit2.Text := '4-Devoluo de mercadoria';
  Form7.ibDataSet15OPERACAO.AsString    := Form7.ibDataSet14NOME.AsString;
  Form7.ibDataSet15FINNFE.AsString      := '4';
  //
  Form7.Tag := 999;
  //
  //
  try
    Form7.ibDataSet15.Post;
    Form7.ibDataSet15.Edit;
    //
    Form7.ibDataSet23.First;
    //
    while not Form7.ibDataSet23.Eof do
    begin
      //
      if AllTrim(Form7.ibDataSet23CODIGO.AsString) <> '' then
      begin
        //
        Form7.ibDataSet4.Close;
        Form7.ibDataSet4.Selectsql.Clear;
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');
        Form7.ibDataSet4.Open;
        //
        if Form7.ibDataSet23CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString then
        begin
          //
          Form7.ibDataSet16.Append;
          Form7.ibDataSet16CODIGO.AsString    := Form7.ibDataSet4CODIGO.AsString;
          Form7.ibDataSet16ST.AsString        := Form7.ibDataSet4ST.AsString;
          Form7.ibDataSet16PESO.AsFloat       := Form7.ibDataSet4PESO.AsFloat;
          Form7.ibDataSet16CUSTO.AsFloat      := Form7.ibDataSet4CUSTOCOMPR.AsFloat;
          Form7.ibDataSet16LISTA.AsFloat      := Form7.ibDataSet4PRECO.AsFloat;
          Form7.ibDataSet16MEDIDA.AsString    := Form7.ibDataSet4MEDIDA.AsString;
          //
          // Acerta os tributos e o CFOP
          //
          Form1.bFlag                         := True;
          Form7.sModulo                       := 'VENDA';
          Form7.ibDataSet16DESCRICAO.AsString := Form7.IbDataSet23DESCRICAO.AsString;
          Form1.bFlag                         := False;
          //
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16QUANTIDADE.AsFloat := Form7.IbDataSet23QUANTIDADE.AsFloat;
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16UNITARIO.AsFloat   := Form7.IbDataSet23UNITARIO.AsFloat;
          Form7.ibDataSet16IPI.AsFloat        := Form7.ibDataSet23IPI.AsFloat;
          //
          Form7.ibDataSet16VIPI.AsFloat       := Arredonda2(Form7.ibDataSet23VIPI.AsFloat,2);
          Form7.ibDataSet16ICM.Asfloat        := Form7.ibDataSet23ICM.Asfloat;
          Form7.ibDataSet16CST_ICMS.AsString  := Form7.ibDataSet23CST_ICMS.AsString;
          Form7.ibDataSet16CFOP.AsString      := Form7.ibDataSet14CFOP.AsString;
          Form7.ibDataSet16VICMS.AsFloat      := Form7.ibDataSet23VICMS.AsFloat;
          Form7.ibDataSet16VBC.AsFloat        := Form7.ibDataSet23VBC.AsFloat;
          Form7.ibDataSet16VBCST.AsFloat      := Form7.ibDataSet23VBCST.AsFloat;
          Form7.ibDataSet16VICMSST.AsFloat    := Form7.ibDataSet23VICMSST.AsFloat;
          //
        end;
        //
      end;
      //
      Form7.ibDataSet23.Next;
      //
    end;
  except end;
  //
  Form7.Tag := 0;
  //
  Form7.sModulo := 'VENDA';
  Form7.ibDataSet16.Edit;
  Form7.ibDataSet16.Post;
  Form7.sModulo := 'OS';
  Form7.ibDataSet16.Edit;
  //
  Form7.ibDataSet16.EnableControls;
  Form7.ibDataSet16.MoveBy(-1);
  Form7.ibDataSet16.MoveBy(1);
  Form12.DBGrid1.Update;
  Form7.ibDataSet15MERCADORIAChange(Form7.ibDataSet15MERCADORIA);
  //
  Form12.dbGrid1.SetFocus;
  //
end;

procedure TForm7.RelatriodeprodutosmonofsicosNFe1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Relatrio de produtos monofsicos (NF-e)';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.DuplicatestaNFe1Click(Sender: TObject);
var
  //
  sDesVetor : array[0..999] of String;
//  sCodVetor : array[0..999] of String;
  fValVetor : array[0..999] of real;
  fQtdVetor : array[0..999] of real;
  //
  vCli, vOpe : String;
  I, J : Integer;
  //
begin
  //
  vCli := Form7.ibDataSet15CLIENTE.AsString;
  vOpe := Form7.ibDataSet15OPERACAO.AsString;
  //
  I := 0;
  //
  Form7.ibDataSet16.First;
  while not Form7.ibDataSet16.Eof do // disable
  begin
    //
    sDesVetor[I] := Form7.ibDataSet16DESCRICAO.AsString;
//    sCodVetor[I] := Form7.ibDataSet16CODIGO.AsString;
    fValVetor[I] := Form7.ibDataSet16UNITARIO.Asfloat;
    fQtdVetor[I] := Form7.ibDataSet16QUANTIDADE.AsFloat;
    I := I + 1;
    Form7.ibDataSet16.Next;
  end;
  //
  Form7.ibDataSet15.Append;
  if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
  Form7.ibDataSet15CLIENTE.AsString  :=  vCli;
  Form7.ibDataSet15OPERACAO.AsString :=  vOpe;
  Form7.ibDataSet15.Post;
  //
  J := I-1;
  //
  for I := 0 to J do
  begin
    Form7.ibDataSet16.Append;
    Form7.ibDataSet16DESCRICAO.AsString := sDesVetor[I];
    Form7.ibDataSet16UNITARIO.AsFloat   := fValVetor[I];
    Form7.ibDataSet16QUANTIDADE.AsFloat := fQtdVetor[I];
    Form7.ibDataSet16.Post;
    Form7.sModulo := 'VENDA';
  end;
  //
  Form7.sModulo := 'VENDA';
  Image106Click(Sender);
  //
end;

function TForm7._ecf65_ValidaGtinNFCe(sEan: String): Boolean;
// Sandro Silva 2019-06-11
// Valida se o Gtin informado  vlido, usando ValidaEAN() e comparando o prefixo
// Prefixo 781 e 792 indicam EAN de uso interno no registrado no GS1
begin
  Result := ValidaEAN13(LimpaNumero(sEan));
  if Result then
  begin
    if (Copy(LimpaNumero(sEan), 1, 3) = '781') or (Copy(LimpaNumero(sEan), 1, 3) = '792') then
      Result := False;
  end;
end;

function TForm7.FormatFloatXML(dValor: Double; iPrecisao: Integer): String;
// Sandro Silva 2015-12-10 Formata valor float com as casas decimais para usar nos elementos do xml da nfce
// Parmetros:
// dValor: Valor a ser formatado
// iPrecisao: Quantidade de casas decimais resultante no valor formatado. Por default formata com 2 casas. Ex.: 2 casas = 0,00; 3 casas = 0,000
var
  sMascara: String;
begin
  sMascara := '##0.' + DupeString('0', iPrecisao);
  Result := StrTran(Alltrim(FormatFloat(sMascara, dValor)), ',', '.');
end;

// A PEDIDO DO
// VANDERLEI PERETI
// FONES: 49 35664136 / 91427178
// EMAIL: comercial@vpinformatica.com.br
function TForm7.AliqICMdoCliente16: double;
begin
  if Form1.fAliqICMdoCliente <> 0 then
  begin
    if Form7.ibDataSet13ESTADO.AsString =  Form7.ibDataSet2ESTADO.AsString then
    begin
      Result :=  Form1.fAliqICMdoCliente;
    end else
    begin
      Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
    end;
  end else
  begin
    Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
  end;
end;

procedure TForm7.PrvisualizarDANFE1Click(Sender: TObject);
var
  sFormato, sLote: String;
begin
  {Sandro Silva 2022-09-12 inicio}
  //Ficha 4128

  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  //
  ConfiguraNFE(True);

  sLote := Form7.ibDataSet15.FieldByName('NUMERONF').AsString;

  fNFE := GeraXmlNFe;//(True);
  if Trim(fNFE) <> '' then
  begin
    //
    try
      spdNFe.PreverDanfe(fNFE, '');
    except
      //Screen.Cursor            := crDefault;
    end;
  end;
  //
  DecimalSeparator := ',';
  DateSeparator    := '/';
  //
  Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
  Form7.Panel7.Repaint;
  Screen.Cursor            := crDefault;
  //
  {Sandro Silva 2022-09-12 fim}
end;

function TForm7.Formata2CasasDecimais(Valor: Double): Currency;
begin
  Result := StrToFloat(FormatFloat('0.00', Valor));
end;

procedure TForm7.SelecionaAliquotaIss(var IBQuery: TIBQuery; Operacao: String = '');
begin
  // Seleciona a alquota de ISS configurada para o Emitente
  IBQuery.Close;
  IBQuery.SQL.Text :=
    'select first 1 ISS, BASEISS ' +
    'from ICM ';
  if Trim(Operacao) = '' then
    IBQuery.SQL.Add('where coalesce(ISS, 0) <> 0 and coalesce(BASEISS, 0) <> 0')
  else
    IBQuery.SQL.Add('where NOME = ' + QuotedStr(Operacao));

  IBQuery.Open;
end;

procedure TForm7.ibDataSet35DESCRICAOChange(Sender: TField);
begin
////
end;

function TForm7.PermiteValidarSchema(DataSet: TDataSet): Boolean;
begin
  Result := (DataSet.FieldByName('NFEXML').AsString <> '') and (DataSet.FieldByName('MODELO').AsString = '55');
end;

procedure TForm7.ValidarSchemaSefaz(NFeXml: String);
begin
  Clipboard.SetTextBuf(pchar(NFEXml));
  ShellExecute( 0, 'Open',pChar('http://www.sefaz.rs.gov.br/NFE/NFE-VAL.aspx'),'','', SW_SHOWMAXIMIZED);
end;

procedure TForm7.VerificarShemaXsd(NFeXml: String;
  bValidarNaSefaz: Boolean);
var
  DOMDocument : IXMLDOMDocument3;
  ParseError  : IXMLDOMParseError;
  Schema      : XMLSchemaCache;
  sErro, sMErro, sVersaoManual : String;
  rcpNFExml   : tStringList;
  DOMDocumentNFe: IXMLDOMDocument;
  xNodeNFe: IXMLDOMNodeList;
begin
  //
  Screen.Cursor := crHourGlass;
  //
  // Protocolo
  //

  //
  // Validar Shema
  //
  try
    //
    DOMDocument := CoDOMDocument50.Create;
    //
    DOMdocument.Async := False;
    DOMdocument.ResolveExternals := False;
    DOMdocument.ValidateOnParse  := True;
    //
    // Carrega s uma parte do XML
    //
    XMLDocument1.Active := false;
    XMLDocument1.XML.Text := Form7.IbDAtaSet15NFEXML.AsString;
    XMLDocument1.Active := True;
    rcpNFExml := TStringList.Create;
    DOMDocumentNFe := CoDOMDocument.Create; // Precisa ser criado com est herana para no ocorrer erro na linha DOMDocumentNFe.selectNodes('//NFe');
    DOMDocumentNFe.loadXML(Form7.IbDAtaSet15NFEXML.AsString);

    xNodeNFe := DOMDocumentNFe.selectNodes('//NFe');
    if xNodeNFe.length > 0 then
    begin
      rcpNFExml.Text := xNodeNFe.item[0].xml;

      DOMdocument.LoadXML(rcpNFExml.Text); //XML COM ERRO
      rcpNFExml.Free;
      //
      Schema := CoXMLSchemaCache50.Create;
      //
      // Verso 2.0 da NFE 4.0 do manual
      //
      spdNFe.VersaoManual := vm60;
      sVersaoManual := 'vm60\nfe_v4.00.xsd';
      //
      Schema.add('http://www.portalfiscal.inf.br/nfe', Form1.sAtual+'\Nfe\Esquemas\'+sVersaoManual);
      //
      DOMdocument.Schemas := Schema;
      ParseError          := DOMdocument.validate;
      sErro := '';
      sMErro := '';
      sErro := ParseError.reason; /// retorno da validao
    end;
    DOMDocument         := Nil;
    ParseError          := Nil;
    Schema              := Nil;
    DOMDocumentNFe      := nil;
    xNodeNFe            := nil;
    //
    // Fim valida schema
    //
  except
  end;
  //
  Screen.Cursor := crDefault;
  try
    if sErro <> '' then
      ShowMessage('Mensagem de erro retornada: '+chr(10)+chr(10)+strTran(sErro, '{http://www.portalfiscal.inf.br/nfe}',''))
    else
      if bValidarNaSefaz then
        ValidarSchemaSefaz(Form7.ibDataSet15NFEXML.AsString);
  except
  end;
  //
end;

procedure TForm7.RelatriodePISCOFINSCupomFiscal1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de PIS/COFINS (Cupom Fiscal)';
  Form38.ShowModal; // Ok
end;

procedure TForm7.ibDataSet13MUNICIPIOSetText(Sender: TField;
  const Text: String);
begin
  {Sandro Silva 2022-10-24 inicio}
  if Screen.ActiveForm = Form17 then
  begin
    //
    if (Form7.ibDataSet39NOME.AsString <> '') or (Trim(Text) <> '') then
    begin
      //
      if Length(AllTrim(Form7.ibDataSet13ESTADO.AsString)) <> 2 then
      begin
        Form7.IBDataSet39.Close;
        Form7.IBDataSet39.SelectSQL.Clear;
        Form7.IBDataSet39.SelectSQL.Add('select * from MUNICIPIOS order by NOME'); // Procura em todo o Pais o estado est em branco
        Form7.IBDataSet39.Open;
      end else
      begin
        Form7.IBDataSet39.Close;
        Form7.IBDataSet39.SelectSQL.Clear;
        Form7.IBDataSet39.SelectSQL.Add('select * from MUNICIPIOS where UF='+QuotedStr(Form7.IBDataSet13ESTADO.AsString)+ ' order by NOME'); // Procura dentro do estado
        Form7.IBDataSet39.Open;
      end;
      //
      Form7.ibDataSet39.Locate('NOME',AllTrim(Text),[loCaseInsensitive, loPartialKey]);
      //
      if AllTrim(Text) = '' then
        Form7.ibDataSet13MUNICIPIO.AsString := Text
      else if Pos(AnsiUpperCase(AllTrim(Text)), AnsiUpperCase(ibDataSet39NOME.AsString)) <> 0 then
      begin
        Form7.ibDataSet13MUNICIPIO.AsString := Form7.ibDataSet39NOME.AsString;
        if Form7.ibDataSet13ESTADO.AsString = '' then
          Form7.ibDataSet13ESTADO.AsString := Form7.IBDataSet39UF.AsString;
      end
      else
      begin
        //ShowMessage('Municpio invlido.');
        //Form17.SMALL_DBEdit4.SetFocus;
        //Abort;
      end;
    end
    else
      Form7.ibDataSet13MUNICIPIO.AsString := Text;
    //
  end;
  {Sandro Silva 2022-10-24 fim}
end;

procedure TForm7.EscolheOBancoParaGerarBoletoEEnviarEmail(Sender: TObject);
begin
  {Sandro Silva 2022-12-26 inicio}
  // Para envio de boletos referente a incorporao da Zucchetti
  Form1.sEscolhido := 'Boleto de cobrana do ' + TMenuItem(Sender).Caption;
  Form25.Show; // Para carregar parmetros e gerar corretamente o cdigo de barras/nosso nmero
  Form25.Close;
  // Sandro Silva 2022-12-28 Emaildecobrana2Click(Sender); // Executando o click de modo provisrio devido a pouco tempo para atender a incorporao da Zucchetti, analisar para evitar uso de eventos em cascata.
  Form7.EmailAtualizaBoletoscobranaClick(Sender);// Executando o click de modo provisrio devido a pouco tempo para atender a incorporao da Zucchetti, analisar para evitar uso de eventos em cascata.
  {Sandro Silva 2022-12-26 fim}
end;

procedure TForm7.EmailAtualizaBoletoscobranaClick(Sender: TObject);
var
  sSecoes :  TStrings;
  sParcelas, sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, II, YY, J : Integer;
  sMandados : String;
  MyBookMark1 : TBookMark;
  PDF: TPrintPDF;
  sArquivoPDF: String; // Sandro Silva 2022-12-22 
begin
  //
  Form40.Tag := ID_TIPO_COBRANCA_ATUALIZA_BOLETOS;
  Form40.CheckBox1.Visible := True;
  Form40.ShowModal;
  //
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail de cobrana para os clientes' + chr(10) +
                 Chr(10) + 'filtrados?' +
                 Chr(10) +
                 Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        //
    try
      //
      if bButton = IDYES then
      begin
        //
        I := 0;
        Form7.ibDataSet7.First;
        //
        // Retorna onde parou
        //
        Mais1ini  := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;
        //
        if sRegistro <> 'FIM' then
        begin
          //
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          //
          if bButton = IDYES then
          begin
            //
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
              //
            end;
            //
          end else
          begin
            sMandados := '';
          end;
          //
        end;
        //
        Mais1ini.Free;
        Screen.Cursor            := crHourGlass;
        //
        YY := 0;
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          if (Pos(Form7.ibDataSet7NOME.AsString,sMandados)=0) and (Form7.ibDataSet7ATIVO.AsFloat=0) then
          begin
            try
              //
              //                                                                    //
              // Relaciona os clientes com o arquivo de vendas                     //
              //                                                                  //
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                //
                sArquivo := '';
                sArquivoPDF := Form1.sAtual+'\boletos_' + LimpaNumero(Form7.IBDataSet2CGC.AsString) + '.pdf'; // Sandro Silva 2022-12-22
                //
                if Form7.sModulo = 'RECEBER' then
                begin
                  //
                  if Form40.CheckBox1.Checked then
                  begin
                    //
                    while FileExists(sArquivoPDF) do  // Sandro Silva 2022-12-22 while FileExists(Form1.sAtual+'\boletos.pdf') do
                    begin
                      DeleteFile(pChar(sArquivoPDF)); // Sandro Silva 2022-12-22 DeleteFile(pChar(Form1.sAtual+'\boletos.pdf'));
                      Sleep(1000);
                    end;
                    //
                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;
                    //
                    try
                      //
                      // Grava o local para voltar
                      //
                      MyBookMark1 := Form7.ibDataSet7.GetBookMark();
                      //
                      // Cria o PDF
                      //
                      // Sandro Silva 2022-12-22 sDocParaGerarPDF := Copy(AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'XXXXXXXXX',1,9);
                      PDF := TPrintPDF.Create(Self);
                      //
                      // Configuraes do documento
                      //
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;
                      //
                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := sArquivoPDF;// sFileCFeSAT; // Sandro Silva 2022-12-22 PDF.FileName    := Form1.sAtual+'\boletos.pdf';// sFileCFeSAT;
                      {Start Printing...}
                      PDF.BeginDoc;
                      //
                      Form7.ibDataSet7.First;
                      while not Form7.ibDataSet7.Eof do
                      begin

                        if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                        begin
                          if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                          begin
                            if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                            begin
                              //
                              while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                              begin
                                DeleteFile(pChar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg'));
                                Sleep(1000);
                              end;
                              //
                              Form1.sEscolhido := '';
                              //
                              try
                                //
                                sSecoes := TStringList.Create;
                                Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                Mais1Ini.ReadSections(sSecoes);
                                //
                                for J := 0 to (sSecoes.Count - 1) do
                                begin
                                  if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                   or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                  and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                    or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                  begin
                                    Form1.sEscolhido := sSecoes[J];
                                  end;
                                end;
                                //
                                Mais1Ini.Free;
                                //
                              except
                              end;
                              //
                              if (AllTrim(Form1.sEscolhido) <> '') or (Form1.DisponivelSomenteParaNos) then // Sandro Silva 2022-12-22 if AllTrim(Form1.sEscolhido) <> '' then
                              begin
                                //
                                Form25.Show; // Em Form7.Emaildecobrana2Click()

                                {Sandro Silva 2022-12-23 inicio}
                                if Form1.DisponivelSomenteParaNos then
                                begin
                                  //GeraImagemDoBoletoComOCodigoDeBarras(False); // Para calcular cdigo de barras, nosso numero
                                  {Sandro Silva 2023-01-24 inicio
                                  Form25.GravaPortadorNossoNumCodeBar;
                                  }
                                  if UpperCase(Copy(AllTrim(Form7.ibDataSet7PORTADOR.AsString),1,7)) <> 'BANCO (' then
                                  begin
                                    Form25.GravaPortadorNossoNumCodeBar;
                                  end;
                                  {Sandro Silva 2023-01-24 fim}
                                end;
                                {Sandro Silva 2022-12-23 fim}

                                Form7.Repaint;
                                //
                                while not FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                begin
                                  Sleep(1000);
                                end;
                                //
                                // Print Image
                                //
                                YY := YY + 1;
                                if YY >= 2 then
                                  PDF.NewPage; // Add New Page
                                //
                                PDF.DrawJPEG(0, 0, Form25.Image2.Picture.Bitmap);
                                //
                                // PDF.DrawBitmap(0,0, Form25.Image2.Picture.Bitmap);
                                //
                              end;
                            end;
                          end;
                        end;
                        //
                        Screen.Cursor            := crHourGlass;
                        Form7.ibDataSet7.Next;
                        Form25.Close;
                        Form7.Repaint;
                        //
                      end;
                      //
                      Form7.ibDataSet7.GotoBookmark(MyBookMark1);
                      //
                      PDF.EndDoc;
                      if FileExists(sArquivoPDF) then // Sandro Silva 2022-12-22 if FileExists(Form1.sAtual+'\boletos.pdf') then
                        sArquivo := sArquivoPDF // Sandro Silva 2022-12-22 sArquivo := Form1.sAtual + '\boletos.pdf'
                      else
                        sArquivo := '';
                      //
                    except
                    end;
                    //
                    Form25.Close;
                    Form7.Repaint;
                    //
                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                    //
                    // Fecha o pdf
                    //
                  end;
                end;
                //
                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                //
                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
                //
                sMsg := Form40.Memo1.Lines.Text;
                //
                // CLIENTES
                //
                if I <> 0 then
                begin
                  for II := 1 to 700 do
                  begin
                    //
                    try
                      Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
                    except
                    end;
                    //
                    Application.ProcessMessages;
                    //
                  end;
                end;
                //
                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                //
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));
                //
                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<PARCELAS_VENCIDAS>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select * from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' order by VENCIMENTO');
                  Form7.ibQuery1.Open;
                  //
                  sParcelas := '';
                  //
                  while not Form7.ibQuery1.eof do
                  begin
                    sParcelas := sParcelas +
                                'Documento: '+Copy(Form7.ibQuery1.fieldByname('DOCUMENTO').AsString   +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Emisso: '+Copy(Form7.ibQuery1.fieldByname('EMISSAO').AsString     +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Vencimento: '+Copy(Form7.ibQuery1.fieldByname('VENCIMENTO').AsString  +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Valor: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_DUPL').AsFloat])+Replicate(' ',10),1,10)+' '+chr(10)+
                                'Atualizado: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_JURO').AsFloat])+Replicate(' ',10),1,10)+chr(10)+
                                IfThen(Trim(Form7.ibQuery1.fieldByname('CODEBAR').AsString) <> '', 'Cdigo de barras: '+Form7.ibQuery1.fieldByname('CODEBAR').AsString, '')+chr(10)+chr(10)// Sandro Silva 2023-02-10
                                ;
                    //
                    Form7.ibQuery1.Next;
                  end;
                  //
                  sMsg := StrTran(sMsg,'<PARCELAS_VENCIDAS>'    ,sParcelas);
                  //
                end;
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<TOTAL_ATRASADO>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_DUPL) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATRASADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                if Pos('<TOTAL_ATUALIZADO>',sMsg) <> 0 then
                begin
                  //
                  // sql para somar o total atrasado deste cliente
                  //
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_JURO) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATUALIZADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                EnviarEMail('',sEmail,'',sAssunto,sMSG,sArquivo, False);
                //
                I := I + 1;
                //
                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;
                //
                //
                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;
                //
                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
                Form7.Panel1.Repaint;
                //
              end;
              //
              sMandados := sMandados + Form7.ibDataSet7NOME.AsString;
              //
            except
            end;
            //
         end;
         //
         Form7.ibDataSet7.Next;
         //
        end;
      end;
      //
    except
    end;
    //
    Screen.Cursor        := crDefault;
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
  end;
  //
end;

function TForm7.CaracteresParaSequencialDocumentos: String;
begin
  // Gera lista com os caracteres que podem ser usados para identificar parcelas de contas a receber ou pagar
  Result := 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890' + DupeString('_',1000);
end;

function TForm7.ObtemNumeroDocumentoReceber(sNumeroNF: String; TipoRPS: String;
  iSequencialParcela: Integer): String;
// Gera o nmero do documento para o contas a receber
begin
  if TipoRPS <> 'S' then
  begin
    if Copy(sNumeroNF,10,3) = '002' then
    begin
      Result := 'S'+Copy(sNumeroNF,2,8) + Copy(CaracteresParaSequencialDocumentos,iSequencialParcela,1);
    end else
    begin
      Result := Copy(sNumeroNF,1,9) + Copy(CaracteresParaSequencialDocumentos,iSequencialParcela,1);
    end;
  end else
  begin
    Result := Copy(sNumeroNF,1,1)+'S'+Copy(sNumeroNF,3,7) + Copy(CaracteresParaSequencialDocumentos,iSequencialParcela,1);
  end;
end;

function TForm7.UltimaParcelaReceberDaNF(sNumeroNF: String): String;
var
  IBQPARCELA: TIBQuery;
begin
  // Retorna a ltima parcela da nota fiscal
  IBQPARCELA := CriaIBQuery(Form7.ibDataSet7.Transaction);
  try
    IBQPARCELA.Close;
    IBQPARCELA.SQL.Text :=
      'select first 1 ' +
      'DOCUMENTO as ULTIMAPARCELA ' +
      'from RECEBER ' +
      'where NUMERONF = :NUMERONF ' +
      'order by REGISTRO desc';
    IBQPARCELA.ParamByName('NUMERONF').AsString := sNumeroNF;
    IBQPARCELA.Open;
    Result := IBQPARCELA.FieldByName('ULTIMAPARCELA').AsString;
  except
  end;
  FreeAndNil(IBQPARCELA);

end;

end.
