unit Unit7;

interface

uses
  SysUtils, WinTypes, WinProcs, Messages, Classes, Graphics, Controls,
  Forms, Dialogs, Grids, DBGrids, DB, ExtCtrls, Menus, Unit9, IniFiles,
  StdCtrls, Unit10, Unit11, Unit14, Unit16, Mask, DBCtrls, smallfunc_xe,
  SMALL_DBEdit, shellapi, Printers, ToolWin, ComCtrls, clipbrd,
  jpeg, MAPI, Variants,
  IBDatabase, IBCustomDataSet, IBTable, IBQuery, IBDatabaseInfo, IBServices,
  DBClient, LbAsym, LbRSA, LbCipher, LbClass, xmldom, XMLIntf,
  msxmldom, XMLDoc,
  {$IFDEF VER150}
  SmallFunc,
  oxmldom, spdXMLUtils, spdType, CAPICOM_TLB,
  {$ELSE}
  {$ENDIF}
  //xercesxmldom,
  Windows, OleCtrls,
  SHDocVw, FileCtrl,
  SpdNFeDataSets, MSXML5_TLB,
  spdNFeType,
  spdNFe,
  DdeMan,
  Gauges,
  LzExpand,
  Registry,
  TLHelp32,
  PsAPI, ComObj, ActiveX, Math, pngimage, strUtils, Buttons,
  spdNFeDPEC, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
  IdHTTP
  , uFuncoesRetaguarda
  , uSmallConsts
  , uLogSistema
  , uArquivosDAT // Sandro Silva 2023-10-02
  , System.Contnrs
  , TypInfo
  , uSmallEnumerados
  , synPDF
  ;

const SIMPLES_NACIONAL = '1';
const SIMPLES_NACIONAL_EXCESSO_SUBLIMITE_DE_RECEITA_BRUTA = '2';
const REGIME_NORMAL    = '3';
const CAMPO_SOMENTE_LEITURA_NO_GRID = 10;
const ID_FILTRAR_FORMAS_GERAM_BOLETO = 15;
const ID_FILTRAR_FORMAS_GERAM_CARNE_DUPLICATA = 05;
const ID_BLOQUEAR_APPEND_NO_GRID_DESDOBRAMENTO_PARCELAS = 1;

//function EnviarEMail(sDe, sPara, sCC, sAssunto, sTexto, cAnexo: string; bConfirma: Boolean): Integer;

function Commitatudo(RefazSelect:Boolean): Boolean;
function AbreArquivos(P1:Boolean): Boolean;
function AgendaCommit(P1:Boolean): Boolean;
function DefineJanela(bP1 : Boolean) : Boolean;
function Audita(pP1, pP2, pP3, pP4 : String; pP5, pP6: Double) : Boolean;
function AssinaturaDigital(sP1:String): String;
//function ConsisteInscricaoEstadual(sIE, sUF: String): Boolean; StdCall; External 'DllInscE32.Dll';
function ConsisteInscricaoEstadual(sIE, sUF: AnsiString): Boolean; StdCall; External 'DllInscE32.Dll';
function DistribuicaoNFe(sP1:String) : Boolean;
function DistribuicaoNFEInutilizada(sP1:String) : Boolean;
function DistribuicaoNFe2(sP1: String) : Boolean;
function AbreArquivoNoFormatoCerto(sP1:String): boolean;
function HtmlParaPdf(sP1:String): boolean;
procedure ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos( XmlEnviado: String; sRetorno: String);
function BuscaNumeroNFSe(bP1: Boolean) : Boolean;

function ConsultaCadastro(sP1: String) : String;
function AssinaRegistro(pNome: String; DataSet: TDataSet; bAssina: Boolean): Boolean;


type

//    TValidaIE  = function (const IE, UF: String): Integer; stdcall;
    TProdutoOld = Record
      sDescricao: String;
      sQuantidade: String;
      sUnitario: String;
    end;

    TForm7 = class(TForm)
    DBGrid1: TDBGrid;
    mmCaixa: TMainMenu;
    Arquivos1: TMenuItem;
    FluxodeCaixa1: TMenuItem;
    N1: TMenuItem;
    Sair1: TMenuItem;
    Edita1: TMenuItem;
    Procura1: TMenuItem;
    Caractere1: TMenuItem;
    miAjudaCaixa: TMenuItem;
    DataSource1: TDataSource;
    ibDataSet1: TibDataSet;
    FontDialog1: TFontDialog;
    DataSource2: TDataSource;
    ibDataSet4: TibDataSet;
    DataSource4: TDataSource;
    ibDataSet4CODIGO: TIBStringField;
    ibDataSet4REFERENCIA: TIBStringField;
    ibDataSet4DESCRICAO: TIBStringField;
    ibDataSet4NOME: TIBStringField;
    ibDataSet4FORNECEDOR: TIBStringField;
    ibDataSet4MEDIDA: TIBStringField;
    ibDataSet4CUSTOCOMPR: TFloatField;
    ibDataSet4CUSTOMEDIO: TFloatField;
    ibDataSet4QTD_ATUAL: TFloatField;
    ibDataSet4QTD_MINIM: TFloatField;
    ibDataSet4QTD_INICIO: TFloatField;
    ibDataSet4DAT_INICIO: TDateField;
    ibDataSet4ULT_COMPRA: TDateField;
    ibDataSet4ULT_VENDA: TDateField;
    ibDataSet4PESO: TFloatField;
    ibDataSet4IPI: TFloatField;
    ibDataSet5: TibDataSet;
    DataSource5: TDataSource;
    ibDataSet5DOCUMENTO: TIBStringField;
    ibDataSet5SAIDA_: TFloatField;
    ibDataSet5ENTRADA_: TFloatField;
    ibDataSet5EMISSAO: TDateField;
    ibDataSet5PREDATA: TDateField;
    ibDataSet5COMPENS: TDateField;
    ibDataSet7: TibDataSet;
    DataSource7: TDataSource;
    ibDataSet7HISTORICO: TIBStringField;
    ibDataSet7DOCUMENTO: TIBStringField;
    ibDataSet7NOME: TIBStringField;
    ibDataSet7EMISSAO: TDateField;
    ibDataSet7VENCIMENTO: TDateField;
    ibDataSet7VALOR_DUPL: TFloatField;
    ibDataSet7MOVIMENTO: TDateField;
    ibDataSet7RECEBIMENT: TDateField;
    ibDataSet7VALOR_RECE: TFloatField;
    ibDataSet7VALOR_JURO: TFloatField;
    ibDataSet9: TibDataSet;
    DataSource9: TDataSource;
    ibDataSet9COMISSA1: TFloatField;
    ibDataSet9COMISSA2: TFloatField;

    Novo1: TMenuItem;
    Alterar1: TMenuItem;
    Apagar1: TMenuItem;
    mmCLifor: TMainMenu;
    MenuItem1: TMenuItem;
    MenuItem2: TMenuItem;
    MenuItem3: TMenuItem;
    MenuItem4: TMenuItem;
    MenuItem5: TMenuItem;
    MenuItem6: TMenuItem;
    MenuItem7: TMenuItem;
    MenuItem8: TMenuItem;
    MenuItem9: TMenuItem;
    MenuItem10: TMenuItem;
    miAjudaClifor: TMenuItem;
    mmEstoque: TMainMenu;
    MenuItem23: TMenuItem;
    MenuItem24: TMenuItem;
    MenuItem25: TMenuItem;
    MenuItem26: TMenuItem;
    MenuItem27: TMenuItem;
    MenuItem28: TMenuItem;
    MenuItem29: TMenuItem;
    MenuItem30: TMenuItem;
    MenuItem31: TMenuItem;
    MenuItem32: TMenuItem;
    miAjudaEstoque: TMenuItem;
    mmMovBancos: TMainMenu;
    MenuItem34: TMenuItem;
    MenuItem35: TMenuItem;
    MenuItem36: TMenuItem;
    MenuItem37: TMenuItem;
    MenuItem38: TMenuItem;
    MenuItem39: TMenuItem;
    MenuItem40: TMenuItem;
    MenuItem41: TMenuItem;
    MenuItem42: TMenuItem;
    MenuItem43: TMenuItem;
    miAjudaBanco: TMenuItem;
    mmReceber: TMainMenu;
    MenuItem56: TMenuItem;
    MenuItem57: TMenuItem;
    MenuItem59: TMenuItem;
    MenuItem60: TMenuItem;
    MenuItem61: TMenuItem;
    MenuItem62: TMenuItem;
    MenuItem63: TMenuItem;
    MenuItem64: TMenuItem;
    MenuItem65: TMenuItem;
    miAjudaReceber: TMenuItem;
    mmVendedor: TMainMenu;
    MenuItem78: TMenuItem;
    MenuItem79: TMenuItem;
    MenuItem80: TMenuItem;
    MenuItem81: TMenuItem;
    MenuItem82: TMenuItem;
    MenuItem83: TMenuItem;
    MenuItem84: TMenuItem;
    MenuItem85: TMenuItem;
    MenuItem86: TMenuItem;
    MenuItem87: TMenuItem;
    miAjudaVendedor: TMenuItem;
    Fluxodecaixa2: TMenuItem;
    Cartaparamaladireta1: TMenuItem;
    N4: TMenuItem;
    Etiquetaparamaladireta1: TMenuItem;
    Imprimircarta1: TMenuItem;
    Oramento1: TMenuItem;
    N6: TMenuItem;
    Grupos1: TMenuItem;
    N7: TMenuItem;
    Inventrio1: TMenuItem;
    Relatriodeconpras1: TMenuItem;
    Relatriodevendas1: TMenuItem;
    N8: TMenuItem;
    Previsodecompra1: TMenuItem;
    Movimentaodoitem1: TMenuItem;
    Imprimirpedidosdevenda1: TMenuItem;
    Listadepreos1: TMenuItem;
    Etiquetas1: TMenuItem;
    N9: TMenuItem;
    Bloquetos1: TMenuItem;
    N11: TMenuItem;
    N14: TMenuItem;
    Imprimircheque1: TMenuItem;
    N15: TMenuItem;
    Mostrartodososlanamentos1: TMenuItem;
    Label1: TLabel;
    Label2: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    ibDataSet11: TibDataSet;
    DataSource11: TDataSource;
    Label11: TLabel;
    N16: TMenuItem;
    Contasbancrias1: TMenuItem;
    ibDataSet11NOME: TIBStringField;
    ibDataSet11AGENCIA: TIBStringField;
    ibDataSet11CONTA: TIBStringField;
    ibDataSet11PLANO: TIBStringField;
    ibDataSet11ARQUIVO: TIBStringField;
    ibDataSet12: TibDataSet;
    DataSource12: TDataSource;
    ibDataSet12CONTA: TIBStringField;
    ibDataSet12NOME: TIBStringField;
    ibDataSet12DIA: TFloatField;
    ibDataSet12MES: TFloatField;
    ibDataSet12ANO: TFloatField;
    ibDataSet12SALDO: TFloatField;
    ibDataSet12DESCRICAOCONTABIL: TIBStringField;
    ibDataSet12CONTACONTABILIDADE: TIBStringField;
    ibDataSet12IDENTIFICADOR: TIBStringField;
    Label12: TLabel;
    mmPlanoContas: TMainMenu;
    MenuItem45: TMenuItem;
    MenuItem46: TMenuItem;
    MenuItem47: TMenuItem;
    MenuItem48: TMenuItem;
    MenuItem49: TMenuItem;
    MenuItem50: TMenuItem;
    MenuItem51: TMenuItem;
    MenuItem52: TMenuItem;
    MenuItem53: TMenuItem;
    MenuItem54: TMenuItem;
    miAjudaPlanoContas: TMenuItem;
    ibDataSet13: TibDataSet;
    DataSource13: TDataSource;
    ibDataSet13NOME: TIBStringField;
    ibDataSet13CONTATO: TIBStringField;
    ibDataSet13ENDERECO: TIBStringField;
    ibDataSet13MUNICIPIO: TIBStringField;
    ibDataSet13CEP: TIBStringField;
    ibDataSet13ESTADO: TIBStringField;
    ibDataSet13CGC: TIBStringField;
    ibDataSet13TELEFO: TIBStringField;
    Label13: TLabel;
    miExibirAjudaCaixa: TMenuItem;
    miTermoUsoCaixa: TMenuItem;
    miSobreSistema: TMenuItem;
    miExibirAjudaClifor: TMenuItem;
    miTermoUsoClifor: TMenuItem;
    miSobreSistemaClifor: TMenuItem;
    miExibirAjudaEstoque: TMenuItem;
    miExibirAjudaBanco: TMenuItem;
    miExibirAjudaReceber: TMenuItem;
    miExibirAjudaVendedor: TMenuItem;
    miExibirAjudaPlanoContas: TMenuItem;
    miTermoUsoEstoque: TMenuItem;
    miSobreSistemaEstoque: TMenuItem;
    miTermoUsoBanco: TMenuItem;
    miSobreSistemaBanco: TMenuItem;
    miTermoUsoReceber: TMenuItem;
    miSobreSistemaReceber: TMenuItem;
    miTermoUsoVendedor: TMenuItem;
    miSobreSistemaVendedor: TMenuItem;
    miTermoUsoPlanoContas: TMenuItem;
    miSobreSistemaPlanoContas: TMenuItem;
    ibDataSet14: TibDataSet;
    DataSource14: TDataSource;
    Label14: TLabel;
    ibDataSet14BASE: TFloatField;
    mmICM: TMainMenu;
    MenuItem106: TMenuItem;
    MenuItem107: TMenuItem;
    MenuItem108: TMenuItem;
    MenuItem109: TMenuItem;
    MenuItem110: TMenuItem;
    MenuItem111: TMenuItem;
    MenuItem112: TMenuItem;
    MenuItem113: TMenuItem;
    MenuItem114: TMenuItem;
    MenuItem115: TMenuItem;
    miAjudaICM: TMenuItem;
    miExibirAjudaICM: TMenuItem;
    miTermoUsoICM: TMenuItem;
    miSobreSistemaICM: TMenuItem;
    ibDataSet15: TibDataSet;
    DataSource15: TDataSource;
    Label15: TLabel;
    ibDataSet15NUMERONF: TIBStringField;
    ibDataSet15VENDEDOR: TIBStringField;
    ibDataSet15CLIENTE: TIBStringField;
    ibDataSet15EMISSAO: TDateField;
    ibDataSet15FRETE: TFloatField;
    ibDataSet15SEGURO: TFloatField;
    ibDataSet15DESPESAS: TFloatField;
    ibDataSet15VOLUMES: TFloatField;
    ibDataSet15ESPECIE: TIBStringField;
    ibDataSet15MARCA: TIBStringField;
    ibDataSet15SAIDAH: TIBStringField;
    ibDataSet15SAIDAD: TDateField;
    ibDataSet15DUPLICATAS: TFloatField;
    ibDataSet15BASEICM: TFloatField;
    ibDataSet15ICMS: TFloatField;
    ibDataSet15ISS: TFloatField;
    ibDataSet15IPI: TFloatField;
    ibDataSet15TOTAL: TFloatField;
    ibDataSet15MERCADORIA: TFloatField;
    ibDataSet15EMITIDA: TIBStringField;
    ibDataSet15SERVICOS: TFloatField;
    ibDataSet16: TibDataSet;
    DataSource16: TDataSource;
    Label16: TLabel;
    ibDataSet18: TibDataSet;
    DataSource18: TDataSource;
    Label18: TLabel;
    ibDataSet18NOME: TIBStringField;
    ibDataSet18PLACA: TIBStringField;
    ibDataSet18ENDERECO: TIBStringField;
    ibDataSet18MUNICIPIO: TIBStringField;
    ibDataSet18ESTADO: TIBStringField;
    ibDataSet18CGC: TIBStringField;
    ibDataSet16NUMERONF: TIBStringField;
    ibDataSet16CODIGO: TIBStringField;
    ibDataSet16DESCRICAO: TIBStringField;
    ibDataSet16IPI: TFloatField;
    ibDataSet16ICM: TFloatField;
    ibDataSet16MEDIDA: TIBStringField;
    ibDataSet16QUANTIDADE: TFloatField;
    ibDataSet16UNITARIO: TFloatField;
    ibDataSet16LISTA: TFloatField;
    ibDataSet16CUSTO: TFloatField;
    ibDataSet15PESOBRUTO: TFloatField;
    ibDataSet15PESOLIQUI: TFloatField;
    ibDataSet16TOTAL: TFloatField;
    ibDataSet16PESO: TFloatField;
    ibDataSet15TRANSPORTA: TIBStringField;
    DataSource19: TDataSource;
    ibDataSet19: TibDataSet;
    Label19: TLabel;
    ibDataSet19DESCRICAO: TIBStringField;
    ibDataSet19TIPO: TIBStringField;
    ibDataSet19LINHA: TFloatField;
    ibDataSet19COLUNA: TFloatField;
    ibDataSet19ELEMENTO: TFloatField;
    MainMenu99: TMainMenu;
    ibDataSet14INTEGRACAO: TIBStringField;
    ibDataSet11SALDO3: TFloatField;
    ibDataSet14OBS: TIBStringField;
    ibDataSet21: TibDataSet;
    DataSource21: TDataSource;
    Label21: TLabel;
    ibDataSet21NOME: TIBStringField;
    ibDataSet5CONTA: TIBStringField;
    ibDataSet23: TibDataSet;
    DataSource23: TDataSource;
    Label31: TLabel;
    ibDataSet24: TibDataSet;
    DataSource24: TDataSource;
    Label32: TLabel;
    ibDataSet24VENDEDOR: TIBStringField;
    ibDataSet24FRETE: TFloatField;
    ibDataSet24SEGURO: TFloatField;
    ibDataSet24DESPESAS: TFloatField;
    ibDataSet24VOLUMES: TFloatField;
    ibDataSet24ESPECIE: TIBStringField;
    ibDataSet24MARCA: TIBStringField;
    ibDataSet24TRANSPORTA: TIBStringField;
    ibDataSet24SAIDAH: TIBStringField;
    ibDataSet24SAIDAD: TDateField;
    ibDataSet24DUPLICATAS: TFloatField;
    ibDataSet24BASEICM: TFloatField;
    ibDataSet24ICMS: TFloatField;
    ibDataSet24ISS: TFloatField;
    ibDataSet24IPI: TFloatField;
    ibDataSet24TOTAL: TFloatField;
    ibDataSet24MERCADORIA: TFloatField;
    ibDataSet24EMITIDA: TIBStringField;
    ibDataSet24SERVICOS: TFloatField;
    ibDataSet24DESCRICAO1: TIBStringField;
    ibDataSet24DESCRICAO2: TIBStringField;
    ibDataSet24DESCRICAO3: TIBStringField;
    ibDataSet24PESOBRUTO: TFloatField;
    ibDataSet24PESOLIQUI: TFloatField;
    ibDataSet23CODIGO: TIBStringField;
    ibDataSet23DESCRICAO: TIBStringField;
    ibDataSet23IPI: TFloatField;
    ibDataSet23ICM: TFloatField;
    ibDataSet23MEDIDA: TIBStringField;
    ibDataSet23QUANTIDADE: TFloatField;
    ibDataSet23UNITARIO: TFloatField;
    ibDataSet23TOTAL: TFloatField;
    ibDataSet23LISTA: TFloatField;
    ibDataSet23CUSTO: TFloatField;
    ibDataSet23PESO: TFloatField;
    ibDataSet24FORNECEDOR: TIBStringField;
    ibDataSet24OPERACAO: TIBStringField;
    ibDataSet15OPERACAO: TIBStringField;
    ibDataSet14NOME: TIBStringField;
    ibDataSet25: TibDataSet;
    DataSource25: TDataSource;
    Label33: TLabel;
    ibDataSet25DATA: TDateField;
    ibDataSet25PAGAR: TFloatField;
    ibDataSet25ACUMULADO1: TFloatField;
    ibDataSet25RECEBER: TFloatField;
    ibDataSet25ACUMULADO2: TFloatField;
    ibDataSet25ACUMULADO3: TFloatField;
    ibDataSet14ISS: TFloatField;
    ibDataSet16ISS: TFloatField;
    ibDataSet24FRETE12: TIBStringField;
    ibDataSet15FRETE12: TIBStringField;
    ibDataSet26: TibDataSet;
    DataSource26: TDataSource;
    Label34: TLabel;
    ibDataSet27: TibDataSet;
    DataSource27: TDataSource;
    Label35: TLabel;
    ibDataSet27CODIGO: TIBStringField;
    ibDataSet27DESCRICAO: TIBStringField;
    ibDataSet27QUANTIDADE: TFloatField;
    ibDataSet27UNITARIO: TFloatField;
    ibDataSet27DATA: TDateField;
    ibDataSet27TIPO: TIBStringField;
    ibDataSet27PEDIDO: TIBStringField;
    ibDataSet27CLIFOR: TIBStringField;
    ibDataSet27VENDEDOR: TIBStringField;
    ibDataSet16BASE: TFloatField;
    ibDataSet16BASEISS: TFloatField;
    ibDataSet14BASEISS: TFloatField;
    ibDataSet15BASEISS: TFloatField;
    PrinterSetupDialog1: TPrinterSetupDialog;
    PrintDialog1: TPrintDialog;
    RegistroFiscal1: TMenuItem;
    N37: TMenuItem;
    ibDataSet13COMPLE: TIBStringField;
    ibDataSet7PORTADOR: TIBStringField;
    ibDataSet16ALIQUOTA: TFloatField;
    ibDataSet15ALIQUOTA: TFloatField;
    N38: TMenuItem;
    Aumentodepreo1: TMenuItem;
    N39: TMenuItem;
    ibDataSet4QTD_COMPRA: TFloatField;
    ibDataSet4COMISSAO: TFloatField;
    ibDataSet4OBS: TIBStringField;
    Relatriodecomisses1: TMenuItem;
    ibDataSet15ICMSSUBSTI: TFloatField;
    ibDataSet15BASESUBSTI: TFloatField;
    Resumodasvendas1: TMenuItem;
    ibDataSet4QTD_VEND: TFloatField;
    ibDataSet4CUS_VEND: TFloatField;
    ibDataSet4VAL_VEND: TFloatField;
    ibDataSet4LUC_VEND: TFloatField;
    Histrico1: TMenuItem;
    ibDataSet27TOTAL: TFloatField;
    ibDataSet27CAIXA: TIBStringField;
    ibDataSet13IE: TIBStringField;
    ibDataSet18IE: TIBStringField;
    Caixa1: TMenuItem;
    ibDataSet4SERIE: TSmallintField;
    ibDataSet4ALTERADO: TSmallintField;
    PopupMenu1: TPopupMenu;
    Ativo1: TMenuItem;
    Apagar2: TMenuItem;
    Editar1: TMenuItem;
    N2: TMenuItem;
    ibDataSet4ATIVO: TSmallintField;
    ibDataSet23FORNECEDOR: TIBStringField;
    Emailpara1: TMenuItem;
    N40: TMenuItem;
    Ativo2: TMenuItem;
    N42: TMenuItem;
    Ativo4: TMenuItem;
    Relatriodeservios1: TMenuItem;
    Relatriodeoramentospendentes1: TMenuItem;
    ibDataSet4MARGEMLB: TFloatField;
    ibDataSet18FONE: TIBStringField;
    ibDataSet18UF: TIBStringField;
    ibDataSet5HISTORICO: TIBStringField;
    ibDataSet5NOMINAL: TIBStringField;
    Balancetegerencial1: TMenuItem;
    Balancetegerencialanual1: TMenuItem;
    Ranquingdeclientes1: TMenuItem;
    N44: TMenuItem;
    ibDataSet19LAYOUT: TIBStringField;
    ibDataSet24ICMSSUBSTI: TFloatField;
    ibDataSet24BASESUBSTI: TFloatField;
    ibDataSet24ALIQUOTA: TFloatField;
    ibDataSet14CFOP: TIBStringField;
    ibDataSet14ST: TIBStringField;
    ibDataSet4ST: TIBStringField;
    ibDataSet16ST: TIBStringField;
    ibDataSet23ST: TIBStringField;
    ibDataSet10: TibDataSet;
    DataSource10: TDataSource;
    Label10: TLabel;
    ibDataSet10CODIGO: TIBStringField;
    ibDataSet10COR: TIBStringField;
    ibDataSet10TAMANHO: TIBStringField;
    ibDataSet10QTD: TIBStringField;
    N46: TMenuItem;
    Ativo5: TMenuItem;
    ibDataSet10ENTRADAS: TIBStringField;
    Balancetegerancialmensal1: TMenuItem;
    Balancetegerencialanual2: TMenuItem;
    N47: TMenuItem;
    ibDataSet25DIFERENCA_: TFloatField;
    N48: TMenuItem;
    Inadimlencia1: TMenuItem;
    ibDataSet4CST: TIBStringField;
    CurvaABC1: TMenuItem;
    CurvaABCdoestoque1: TMenuItem;
    ibDataSet4INDEXADOR: TFloatField;
    Carn1: TMenuItem;
    Duplicata1: TMenuItem;
    ibDataSet19SERIE: TIBStringField;
    ibDataSet9NOME: TIBStringField;
    ibDataSet7CONTA: TIBStringField;
    Analisegrafica1: TMenuItem;
    N61: TMenuItem;
    Analisegrficadascontas1: TMenuItem;
    ibDataSet28: TibDataSet;
    DataSource28: TDataSource;
    Label36: TLabel;
    ibDataSet28CODIGO: TIBStringField;
    ibDataSet28DESCRICAO: TIBStringField;
    ibDataSet28QUANTIDADE: TFloatField;
    mmTransport: TMainMenu;
    MenuItem15: TMenuItem;
    MenuItem58: TMenuItem;
    MenuItem69: TMenuItem;
    MenuItem89: TMenuItem;
    MenuItem90: TMenuItem;
    MenuItem91: TMenuItem;
    MenuItem92: TMenuItem;
    MenuItem93: TMenuItem;
    MenuItem94: TMenuItem;
    MenuItem97: TMenuItem;
    MenuItem98: TMenuItem;
    miAjudaTransport: TMenuItem;
    miExibirAjudaTransport: TMenuItem;
    miTermoUsoTransport: TMenuItem;
    miSobreSistemaTransport: TMenuItem;
    Image24: TImage;
    ibDataSet18EMAIL: TIBStringField;
    ibDataSet13EMAIL: TIBStringField;
    ibDataSet7NOSSONUM: TIBStringField;
    Pagarestaconta1: TMenuItem;
    Receberestaconta1: TMenuItem;
    ibDataSet27VALORICM: TFloatField;
    ibDataSet23CFOP: TIBStringField;
    DataSource29: TDataSource;
    Label37: TLabel;
    ibDataSet29: TibDataSet;
    ibDataSet29DESCONTO: TFloatField;
    mmConvenio: TMainMenu;
    MenuItem118: TMenuItem;
    MenuItem119: TMenuItem;
    MenuItem123: TMenuItem;
    MenuItem128: TMenuItem;
    MenuItem135: TMenuItem;
    MenuItem136: TMenuItem;
    miAjudaConvenio: TMenuItem;
    miExibirAjudaConvenio: TMenuItem;
    miTermoUsoConvenio: TMenuItem;
    miSobreSistemaConvenio: TMenuItem;
    Relatriodetodososconvnios1: TMenuItem;
    ibDataSet13COPE: TFloatField;
    ibDataSet13RESE: TFloatField;
    ibDataSet13CVEN: TFloatField;
    ibDataSet13IMPO: TFloatField;
    ibDataSet13LUCR: TFloatField;
    ibDataSet13ICME: TFloatField;
    ibDataSet13ICMS: TFloatField;
    ibDataSet29NOME: TIBStringField;
    ibDataSet30: TibDataSet;
    DataSource30: TDataSource;
    ibDataSet30CODIGO: TIBStringField;
    ibDataSet30SERIAL: TIBStringField;
    ibDataSet30NFCOMPRA: TIBStringField;
    ibDataSet30NFVENDA: TIBStringField;
    ibDataSet16CFOP: TIBStringField;
    N17: TMenuItem;
    ibDataSet29RAZAO: TIBStringField;
    ibDataSet29FONE: TIBStringField;
    ibDataSet29EMAIL: TIBStringField;
    Receberconvnio1: TMenuItem;
    Acertodecontasde1: TMenuItem;
    RECIBO: TButton;
    ibDataSet15MODELO: TIBStringField;
    Colunas1: TMenuItem;
    LimparRetornosda1: TMenuItem;
    mmPagar: TMainMenu;
    MenuItem67: TMenuItem;
    MenuItem68: TMenuItem;
    N13: TMenuItem;
    MenuItem70: TMenuItem;
    MenuItem71: TMenuItem;
    MenuItem72: TMenuItem;
    MenuItem73: TMenuItem;
    MenuItem74: TMenuItem;
    N45: TMenuItem;
    Acertodecontasde2: TMenuItem;
    MenuItem75: TMenuItem;
    MenuItem76: TMenuItem;
    miAjudaPagar: TMenuItem;
    miExibirAjudaPagar: TMenuItem;
    miTermoUsoPagar: TMenuItem;
    miSobreSistemaPagar: TMenuItem;
    ibDataSet8: TibDataSet;
    ibDataSet8HISTORICO: TIBStringField;
    ibDataSet8DOCUMENTO: TIBStringField;
    ibDataSet8NOME: TIBStringField;
    ibDataSet8EMISSAO: TDateField;
    ibDataSet8VENCIMENTO: TDateField;
    ibDataSet8VALOR_DUPL: TFloatField;
    ibDataSet8PAGAMENTO: TDateField;
    ibDataSet8VALOR_PAGO: TFloatField;
    ibDataSet8PORTADOR: TIBStringField;
    ibDataSet8CONTA: TIBStringField;
    DataSource8: TDataSource;
    N21: TMenuItem;
    ibDataSet4LOCAL: TIBStringField;
    N24: TMenuItem;
    Exibir1: TMenuItem;
    Mostrartodososclientesefornecedores1: TMenuItem;
    Exibir2: TMenuItem;
    odas1: TMenuItem;
    Receber2: TMenuItem;
    Jrecebidas2: TMenuItem;
    Atrasadas3: TMenuItem;
    Avencer3: TMenuItem;
    Vencendohoje2: TMenuItem;
    Exibir3: TMenuItem;
    odas2: TMenuItem;
    Pagar2: TMenuItem;
    Jpagas2: TMenuItem;
    Atrasadas1: TMenuItem;
    Avencer1: TMenuItem;
    Vencendohoje3: TMenuItem;
    Exibir4: TMenuItem;
    odas3: TMenuItem;
    Lanamentoscompensados1: TMenuItem;
    Lanamentosnocompensados1: TMenuItem;
    ibDataSet30VALCOMPRA: TFloatField;
    ibDataSet30VALVENDA: TFloatField;
    ibDataSet30DATCOMPRA: TDateField;
    ibDataSet30DATVENDA: TDateField;
    Balanas1: TMenuItem;
    ibDataSet7CODEBAR: TIBStringField;
    ibDataSet3: TibDataSet;
    DataSource3: TDataSource;
    Label22: TLabel;
    mmOS: TMainMenu;
    MenuItem12: TMenuItem;
    MenuItem20: TMenuItem;
    MenuItem21: TMenuItem;
    MenuItem22: TMenuItem;
    MenuItem100: TMenuItem;
    MenuItem101: TMenuItem;
    MenuItem102: TMenuItem;
    MenuItem146: TMenuItem;
    MenuItem147: TMenuItem;
    MenuItem153: TMenuItem;
    MenuItem154: TMenuItem;
    miAjudaOS: TMenuItem;
    miExibirAjudaOS: TMenuItem;
    miSobreSistemaOS: TMenuItem;
    Abertas1: TMenuItem;
    Fechadas1: TMenuItem;
    ibDataSet3NUMERO: TIBStringField;
    ibDataSet3DATA: TDateField;
    ibDataSet3HORA: TIBStringField;
    ibDataSet3CLIENTE: TIBStringField;
    ibDataSet3DATA_PRO: TDateField;
    ibDataSet3HORA_PRO: TIBStringField;
    ibDataSet3TEMPO: TIBStringField;
    ibDataSet3SITUACAO: TIBStringField;
    ibDataSet3DATA_ENT: TDateField;
    ibDataSet3HORA_ENT: TIBStringField;
    ibDataSet3OBSERVACAO: TIBStringField;
    ibDataSet3TOTAL_SERV: TFloatField;
    ibDataSet3TOTAL_PECA: TFloatField;
    ibDataSet3TOTAL_FRET: TFloatField;
    ibDataSet3TOTAL_OS: TFloatField;
    ibDataSet4LIVRE1: TIBStringField;
    ibDataSet4LIVRE2: TIBStringField;
    ibDataSet4LIVRE3: TIBStringField;
    ibDataSet4LIVRE4: TIBStringField;
    ibDataSet3TECNICO: TIBStringField;
    ibDataSet9HORASTRAB: TIBStringField;
    ibDataSet9FUNCAO: TIBStringField;
    ibDataSet9ATIVO: TSmallintField;
    Agendada1: TMenuItem;
    Cadastrodetcnicos1: TMenuItem;
    RelatriodepeasemOSabertas1: TMenuItem;
    Imprimirrecibo1: TMenuItem;
    N27: TMenuItem;
    ImprimirOrdemdeServio1: TMenuItem;
    ibDataSet3DESCRICAO: TIBStringField;
    ibDataSet3PROBLEMA: TIBStringField;
    ibDataSet3IDENTIFI1: TIBStringField;
    ibDataSet3IDENTIFI2: TIBStringField;
    ibDataSet3IDENTIFI3: TIBStringField;
    ibDataSet3IDENTIFI4: TIBStringField;
    ibDataSet3NF: TIBStringField;
    ibDataSet3GARANTIA: TDateField;
    Grade1: TMenuItem;
    Cartadecobrana1: TMenuItem;
    Imprimiretiquetaparacobrana1: TMenuItem;
    Imprimircartadecobrana1: TMenuItem;
    ibDataSet23BASE: TFloatField;
    Resumodevendas1: TMenuItem;
    DBGrid2: TDBGrid;
    DBGrid3: TDBGrid;
    Label44: TLabel;
    mmVendas: TMainMenu;
    MenuItem13: TMenuItem;
    miRelVendasNotaFiscal: TMenuItem;
    miRelVendasServico: TMenuItem;
    miRelVendasCupomFiscal: TMenuItem;
    miRelResumoVendasVendas: TMenuItem;
    MenuItem164: TMenuItem;
    MenuItem165: TMenuItem;
    MenuItem166: TMenuItem;
    MenuItem167: TMenuItem;
    MenuItem168: TMenuItem;
    MenuItem169: TMenuItem;
    MenuItem170: TMenuItem;
    MenuItem177: TMenuItem;
    MenuItem178: TMenuItem;
    miAjudaVendas: TMenuItem;
    miExibirAjudaVendas: TMenuItem;
    miSobreSistemaVendas: TMenuItem;
    mmCompras: TMainMenu;
    MenuItem183: TMenuItem;
    MenuItem196: TMenuItem;
    PrevCompra: TMenuItem;
    MenuItem205: TMenuItem;
    MenuItem206: TMenuItem;
    MenuItem207: TMenuItem;
    MenuItem208: TMenuItem;
    MenuItem209: TMenuItem;
    MenuItem210: TMenuItem;
    MenuItem211: TMenuItem;
    MenuItem212: TMenuItem;
    MenuItem219: TMenuItem;
    MenuItem220: TMenuItem;
    miAjudaCompras: TMenuItem;
    miExibirAjudaCompras: TMenuItem;
    miSobreSistemaCompras: TMenuItem;
    Exibir5: TMenuItem;
    Vendas_1: TMenuItem;
    Compras_1: TMenuItem;
    Exibir6: TMenuItem;
    Vendas2: TMenuItem;
    Compras2: TMenuItem;
    Panel9: TPanel;
    Panel10: TPanel;
    ibDataSet14CONTA: TIBStringField;
    Enviartorpedo1: TMenuItem;
    ibDataSet16NUMEROOS: TIBStringField;
    DBGrid4: TDBGrid;
    ibDataSet7NUMERONF: TIBStringField;
    ibDataSet35: TibDataSet;
    DataSource35: TDataSource;
    Label17: TLabel;
    ibDataSet35NUMERONF: TIBStringField;
    ibDataSet35CODIGO: TIBStringField;
    ibDataSet35DESCRICAO: TIBStringField;
    ibDataSet35MEDIDA: TIBStringField;
    ibDataSet35QUANTIDADE: TFloatField;
    ibDataSet35UNITARIO: TFloatField;
    ibDataSet35TOTAL: TFloatField;
    ibDataSet35CFOP: TIBStringField;
    ibDataSet35TECNICO: TIBStringField;
    ibDataSet35ISS: TFloatField;
    ibDataSet35BASEISS: TFloatField;
    ibDataSet35NUMEROOS: TIBStringField;
    ibDataSet16SINCRONIA: TFloatField;
    ibDataSet23SINCRONIA: TFloatField;
    ibDataSet15DESCONTO: TFloatField;
    ibDataSet24DESCONTO: TFloatField;
    N5: TMenuItem;
    N30: TMenuItem;
    N35: TMenuItem;
    ImprimirtodasasOSfiltradas1: TMenuItem;
    N41: TMenuItem;
    ImprimirNF3: TMenuItem;
    N43: TMenuItem;
    Enviaremailparatodos1: TMenuItem;
    N51: TMenuItem;
    Emaildecobrana1: TMenuItem;
    este1: TMenuItem;
    NotasfiscaisdesadavendasSrie11: TMenuItem;
    Notasfiscaisdesadavendassrie21: TMenuItem;
    ibDataSet13HP: TIBStringField;
    Rankingdedevedores1: TMenuItem;
    Rankingdedevedores2: TMenuItem;
    IBDatabase1: TIBDatabase;
    ibDataSet7ATIVO: TSmallintField;
    ibDataSet1DATA: TDateField;
    ibDataSet1NOME: TIBStringField;
    ibDataSet1HISTORICO: TIBStringField;
    ibDataSet1ENTRADA: TFloatField;
    ibDataSet1SAIDA: TFloatField;
    ibDataSet1CONTA: TIBStringField;
    ibDataSet1REGISTRO: TIBStringField;
    IBDataSet2: TIBDataSet;
    IBDataSet2NOME: TIBStringField;
    IBDataSet2CONTATO: TIBStringField;
    IBDataSet2IE: TIBStringField;
    IBDataSet2CGC: TIBStringField;
    IBDataSet2ENDERE: TIBStringField;
    IBDataSet2COMPLE: TIBStringField;
    IBDataSet2CIDADE: TIBStringField;
    IBDataSet2ESTADO: TIBStringField;
    IBDataSet2CEP: TIBStringField;
    IBDataSet2FONE: TIBStringField;
    IBDataSet2FAX: TIBStringField;
    IBDataSet2EMAIL: TIBStringField;
    IBDataSet2OBS: TIBStringField;
    IBDataSet2CELULAR: TIBStringField;
    IBDataSet2CREDITO: TFloatField;
    IBDataSet2CONVENIO: TIBStringField;
    IBDataSet2DATANAS: TDateField;
    IBDataSet2CADASTRO: TDateField;
    IBDataSet2ULTIMACO: TDateField;
    IBDataSet2PROXDATA: TDateField;
    IBDataSet2CUSTO: TFloatField;
    IBDataSet2COMPRA: TFloatField;
    IBDataSet2ATIVO: TSmallintField;
    IBDataSet2CLIFOR: TIBStringField;
    IBDataSet2REGISTRO: TIBStringField;
    IBDataSet2IDENTIFICADOR1: TIBStringField;
    IBDataSet2IDENTIFICADOR2: TIBStringField;
    IBDataSet2IDENTIFICADOR3: TIBStringField;
    IBDataSet2IDENTIFICADOR4: TIBStringField;
    IBDataSet2IDENTIFICADOR5: TIBStringField;
    ibDataSet7REGISTRO: TIBStringField;
    IBDataSet99: TIBDataSet;
    ibDataSet4REGISTRO: TIBStringField;
    ibDataSet27MEDIDA: TIBStringField;
    ibDataSet27ALIQUICM: TIBStringField;
    ibDataSet27REGISTRO: TIBStringField;
    ibDataSet15REGISTRO: TIBStringField;
    ibDataSet16REGISTRO: TIBStringField;
    ibDataSet35REGISTRO: TIBStringField;
    ibDataSet18REGISTRO: TIBStringField;
    ibDataSet14REGISTRO: TIBStringField;
    ibDataSet12REGISTRO: TIBStringField;
    ibDataSet19REGISTRO: TIBStringField;
    ibDataSet3REGISTRO: TIBStringField;
    ibDataSet24MODELO: TIBStringField;
    ibDataSet24REGISTRO: TIBStringField;
    ibDataSet23REGISTRO: TIBStringField;
    ibDataSet13REGISTRO: TIBStringField;
    ibDataSet28REGISTRO: TIBStringField;
    ibDataSet30REGISTRO: TIBStringField;
    ibDataSet8REGISTRO: TIBStringField;
    ibDataSet9REGISTRO: TIBStringField;
    ibDataSet29REGISTRO: TIBStringField;
    ibDataSet25VALOR01: TFloatField;
    ibDataSet25VALOR02: TFloatField;
    ibDataSet25VALOR03: TFloatField;
    ibDataSet25VALOR04: TFloatField;
    ibDataSet25VALOR05: TFloatField;
    ibDataSet25VALOR06: TFloatField;
    ibDataSet25VALOR07: TFloatField;
    ibDataSet25VALOR08: TFloatField;
    ibDataSet25VALOR09: TFloatField;
    ibDataSet25VALOR10: TFloatField;
    ibDataSet25VALOR_1: TFloatField;
    ibDataSet25VALOR_2: TFloatField;
    ibDataSet25VALOR_3: TFloatField;
    ibDataSet25VALOR_4: TFloatField;
    ibDataSet25REGISTRO: TIBStringField;
    ibDataSet10REGISTRO: TIBStringField;
    IBDataSet100: TIBDataSet;
    ibDataSet3DESCONTO: TFloatField;
    ibDataSet21REGISTRO: TIBStringField;
    ibDataSet5REGISTRO: TIBStringField;
    ibDataSet5NOME: TIBStringField;
    ibDataSet11REGISTRO: TIBStringField;
    ibDataset40: TIBDataSet;
    ibDataset40CODIGO: TIBStringField;
    ibDataset40DESCRICAO: TIBStringField;
    ibDataset40QTD: TFloatField;
    DataSource40: TDataSource;
    Label3: TLabel;
    ibDataset40REGISTRO: TIBStringField;
    ibDataSet14AM_: TFloatField;
    ibDataSet14AC_: TFloatField;
    ibDataSet14AL_: TFloatField;
    ibDataSet14AP_: TFloatField;
    ibDataSet14BA_: TFloatField;
    ibDataSet14CE_: TFloatField;
    ibDataSet14DF_: TFloatField;
    ibDataSet14ES_: TFloatField;
    ibDataSet14GO_: TFloatField;
    ibDataSet14MA_: TFloatField;
    ibDataSet14MG_: TFloatField;
    ibDataSet14MT_: TFloatField;
    ibDataSet14MS_: TFloatField;
    ibDataSet14PA_: TFloatField;
    ibDataSet14PB_: TFloatField;
    ibDataSet14PE_: TFloatField;
    ibDataSet14PI_: TFloatField;
    ibDataSet14PR_: TFloatField;
    ibDataSet14RJ_: TFloatField;
    ibDataSet14RN_: TFloatField;
    ibDataSet14RO_: TFloatField;
    ibDataSet14RR_: TFloatField;
    ibDataSet14RS_: TFloatField;
    ibDataSet14SC_: TFloatField;
    ibDataSet14SE_: TFloatField;
    ibDataSet14SP_: TFloatField;
    ibDataSet14TO_: TFloatField;
    ibDataSet14EX_: TFloatField;
    IBDataSet2CONTATOS: TMemoField;
    ibDataSet1SALDO: TFloatField;
    ibDataSet5SALDO_BANC: TFloatField;
    ibDataSet11SALDO1: TFloatField;
    ibDataSet11SALDO2: TFloatField;
    ibDataSet15NSU: TIBStringField;
    ibDataSet15NSUH: TIBStringField;
    ibDataSet15NSUD: TDateField;
    ibDataSet4FOTO: TMemoField;
    ibDataSet21FOTO: TMemoField;
    IBDatabaseInfo1: TIBDatabaseInfo;
    ibDataSet37: TIBDataSet;
    ibDataSet37CODIGO: TIBStringField;
    ibDataSet37DESCRICAO: TIBStringField;
    ibDataSet37QUANTIDADE: TFloatField;
    ibDataSet37UNITARIO: TFloatField;
    ibDataSet37TOTAL: TFloatField;
    ibDataSet37DATA: TDateField;
    ibDataSet37TIPO: TIBStringField;
    ibDataSet37PEDIDO: TIBStringField;
    ibDataSet37CLIFOR: TIBStringField;
    ibDataSet37VENDEDOR: TIBStringField;
    ibDataSet37CAIXA: TIBStringField;
    ibDataSet37MEDIDA: TIBStringField;
    ibDataSet37ITEM: TIBStringField;
    ibDataSet37VALORICM: TFloatField;
    ibDataSet37ALIQUICM: TIBStringField;
    ibDataSet37REGISTRO: TIBStringField;
    DataSource37: TDataSource;
    Label9: TLabel;
    Gerarnotafiscalsrie11: TMenuItem;
    Gerarnotafiscalsrie21: TMenuItem;
    ibDataSet15IDENTIFICADOR1: TIBStringField;
    IBBackupService1: TIBBackupService;
    IBRestoreService1: TIBRestoreService;
    IBTransaction1: TIBTransaction;
    miRelCorrelacao: TMenuItem;
    Sosclientescomcontasatrasadas1: TMenuItem;
    Sosclientescomsuascontasemdia1: TMenuItem;
    Sosclientescomcontasareceber1: TMenuItem;
    IBDataSet119: TIBDataSet;
    DataSource119: TDataSource;
    Label20: TLabel;
    IBDataSet119DESCRICAO: TIBStringField;
    IBDataSet119TIPO: TIBStringField;
    IBDataSet119LINHA: TFloatField;
    IBDataSet119COLUNA: TFloatField;
    IBDataSet119ELEMENTO: TFloatField;
    IBDataSet119LAYOUT: TIBStringField;
    IBDataSet119SERIE: TIBStringField;
    IBDataSet119REGISTRO: TIBStringField;
    ArquivotextoNotaFiscalPaulista1: TMenuItem;
    N19: TMenuItem;
    Notasfiscaiscanceladas1: TMenuItem;
    Notasfiscaisabertas1: TMenuItem;
    odas4: TMenuItem;
    IBQuery1: TIBQuery;
    SaveDialog1: TSaveDialog;
    Exportar1: TMenuItem;
    N49: TMenuItem;
    ImportarOS1: TMenuItem;
    ImportarCupomFiscal1: TMenuItem;
    ImportarOramento1: TMenuItem;
    ImportarNotaFiscal1: TMenuItem;
    OpenDialog1: TOpenDialog;
    IBDataSet39: TIBDataSet;
    DataSource39: TDataSource;
    IBDataSet39CODIGO: TIBStringField;
    IBDataSet39NOME: TIBStringField;
    IBDataSet39UF: TIBStringField;
    IBDataSet39REGISTRO: TIBStringField;
    Movimentaodositemskardex1: TMenuItem;
    miRelVendasVendedor: TMenuItem;
    ibDataSet37NUMERONF: TIBStringField;
    Relatriodetotaldeserviosporvendedor1: TMenuItem;
    IBDataSet101: TIBDataSet;
    ibDataSet13IM: TIBStringField;
    N52: TMenuItem;
    IBDataSet2MOSTRAR: TIBStringField;
    Relatriodetotaldeserviosportcnico1: TMenuItem;
    Resumodascompras1: TMenuItem;
    Resumodascomrpas1: TMenuItem;
    ibDataSet4IAT: TIBStringField;
    ibDataSet4IPPT: TIBStringField;
    LbBlowfish1: TLbBlowfish;
    LbRSASSA1: TLbRSASSA;
    XMLDocument: TXMLDocument;
    N53: TMenuItem;
    N1EnviarNFe1: TMenuItem;
    N2ConsultarrecibodaNFe1: TMenuItem;
    N3ConsultarNFe1: TMenuItem;
    N4ImprimirDANFE1: TMenuItem;
    CancelarNFe1: TMenuItem;
    ibDataSet15STATUS: TIBStringField;
    ibDataSet15NFEID: TIBStringField;
    ibDataSet15NFERECIBO: TIBStringField;
    ibDataSet15NFEXML: TMemoField;
    ibDataSet15NFEPROTOCOLO: TIBStringField;
    N6EnviarNFeConsultareImprimirDANFE1: TMenuItem;
    N0TestarservidorNFe1: TMenuItem;
    ransmitirNFe1: TMenuItem;
    N5EnviarDANFEporemail1: TMenuItem;
    N6VisualizarDANFE1: TMenuItem;
    GerarNFedeentrada1: TMenuItem;
    N9ImprimirDANFEemformulriodecontingncia1: TMenuItem;
    Image8: TImage;
    Agrupar1: TMenuItem;
    Image9: TImage;
    Importarretornodevendaambulante1: TMenuItem;
    ibDataSet15RECIBOXML: TMemoField;
    ExportarNFesemarquivoXML1: TMenuItem;
    ibDataSet14SOBREIPI: TIBStringField;
    ibDataSet14SOBREFRETE: TIBStringField;
    ibDataSet14SOBRESEGURO: TIBStringField;
    ibDataSet14SOBREOUTRAS: TIBStringField;
    ibDataSet14FRETESOBREIPI: TIBStringField;
    Image10: TImage;
    Image11: TImage;
    ibDataSet15LOKED: TIBStringField;
    IBQuery2: TIBQuery;
    XMLDocument1: TXMLDocument;
    ibDataSet26DATA: TDateField;
    ibDataSet26DOCUMENTO: TIBStringField;
    ibDataSet26HISTORICO: TIBStringField;
    ibDataSet26QUANTIDADE: TFloatField;
    ibDataSet26REGISTRO: TIBStringField;
    ibDataSet26VALOR: TIBBCDField;
    ibDataSet14CST: TIBStringField;
    ibDataSet14PPIS: TIBBCDField;
    ibDataSet14PCOFINS: TIBBCDField;
    XConsultarcadastro1: TMenuItem;
    Image12: TImage;
    vendaspara: TMenuItem;
    Ca1: TMenuItem;
    SaveDialog2: TSaveDialog;
    IBDataSet2FOTO: TBlobField;
    ibDataSet24NFEXML: TMemoField;
    lbumdefotografias1: TMenuItem;
    SPEDFiscal1: TMenuItem;
    Image13: TImage;
    Image14: TImage;
    OpenDialog2: TOpenDialog;
    OpenDialog3: TOpenDialog;
    Panel2: TPanel;
    Label23: TLabel;
    lblRecebPagto: TLabel;
    Label25: TLabel;
    Label26: TLabel;
    SMALL_DBEdit6: TSMALL_DBEdit;
    ComboBox1: TComboBox;
    Edit1: TEdit;
    ComboBox2: TComboBox;
    Label47: TLabel;
    SMALL_DBEdit1: TSMALL_DBEdit;
    Label48: TLabel;
    Edit2: TEdit;
    Label49: TLabel;
    SMALL_DBEdit2: TSMALL_DBEdit;
    Image18: TImage;
    Edit3: TEdit;
    ibDataSet8ATIVO: TIntegerField;
    Romaneiodecarga1: TMenuItem;
    ConsultarvalidadedaNFe1: TMenuItem;
    IBQuery3: TIBQuery;
    ibDataSet13CRT: TIBStringField;
    ibDataSet13CNAE: TIBStringField;
    ibDataSet14CSOSN: TIBStringField;
    IBDataSet97: TIBDataSet;
    DataSource97: TDataSource;
    mmOrcamento: TMainMenu;
    MenuItem14: TMenuItem;
    MenuItem16: TMenuItem;
    MenuItem17: TMenuItem;
    MenuItem18: TMenuItem;
    MenuItem104: TMenuItem;
    MenuItem105: TMenuItem;
    miAjudaOrcamento: TMenuItem;
    miExibirAjudaOrcamento: TMenuItem;
    miTermoUsoOrcamento: TMenuItem;
    miSobreSistemaOrcamento: TMenuItem;
    GerarNotaFiscalSrie12: TMenuItem;
    N54: TMenuItem;
    GerarNotaFiscalSrie22: TMenuItem;
    Relatriodeoramentospendentes2: TMenuItem;
    ibDataSet4ENCRYPTHASH: TIBStringField;
    ibDataSet27ITEM: TIBStringField;
    ibDataSet27HORA: TIBStringField;
    ibDataSet27DAV: TIBStringField;
    ibDataSet27TIPODAV: TIBStringField;
    ibDataSet27CNPJ: TIBStringField;
    ibDataSet27REFERENCIA: TIBStringField;
    ibDataSet27ENCRYPTHASH: TIBStringField;
    ibDataSet27COO: TIBStringField;
    ibDataSet27CCF: TIBStringField;
    ibDataSet37COO: TIBStringField;
    ibDataSet37ENCRYPTHASH: TIBStringField;
    VVerificaresquemashema1: TMenuItem;
    ibDataSet4CSOSN: TIBStringField;
    DataSource49: TDataSource;
    IBDataSet49: TIBDataSet;
    IBDataSet49REGISTRO: TIBStringField;
    IBDataSet49SIGLA: TIBStringField;
    IBDataSet49DESCRICAO: TIBStringField;
    IBDataSet49OBS: TIBStringField;
    RRecuperaroXMLdestaNFe1: TMenuItem;
    ExportarNFesfiltradasemarquivoXML1: TMenuItem;
    IBQuery99: TIBQuery;
    ibDataSet23VICMS: TIBBCDField;
    ibDataSet23VBC: TIBBCDField;
    ibDataSet23VBCST: TIBBCDField;
    ibDataSet23VICMSST: TIBBCDField;
    ibDataSet23VIPI: TIBBCDField;
    ibDataSet23VPRECO: TIBBCDField;
    ibDataSet15COMPLEMENTO: TMemoField;
    ibDataSet24COMPLEMENTO: TMemoField;
    Imprimirrecibo2: TMenuItem;
    Imprimirrecibo3: TMenuItem;
    LLeosimpostosdoXML1: TMenuItem;
    ibDataSet4PRECO: TFloatField;
    ibDataSet4PIVA: TFloatField;
    ibDataSet24NFEID: TIBStringField;
    ibDataSet4CST_IPI: TIBStringField;
    ibDataSet4TIPO_ITEM: TIBStringField;
    IBQuery4: TIBQuery;
    IBQuery5: TIBQuery;
    Button6: TButton;
    Button7: TButton;
    Button8: TButton;
    IBQuery14: TIBQuery;
    ibDataSet16VICMS: TIBBCDField;
    ibDataSet16VBC: TIBBCDField;
    ibDataSet16VBCST: TIBBCDField;
    ibDataSet16VBC_PIS_COFINS: TIBBCDField;
    ibDataSet16VICMSST: TIBBCDField;
    ibDataSet16VIPI: TIBBCDField;
    ibDataSet16CST_IPI: TIBStringField;
    ibDataSet16CST_ICMS: TIBStringField;
    ibDataSet16ALIQ_PIS: TIBBCDField;
    ibDataSet16ALIQ_COFINS: TIBBCDField;
    ibDataSet4CST_PIS_COFINS_ENTRADA: TIBStringField;
    ibDataSet4ALIQ_PIS_ENTRADA: TIBBCDField;
    ibDataSet4ALIQ_COFINS_ENTRADA: TIBBCDField;
    ibDataSet4CST_PIS_COFINS_SAIDA: TIBStringField;
    ibDataSet4ALIQ_PIS_SAIDA: TIBBCDField;
    ibDataSet4ALIQ_COFINS_SAIDA: TIBBCDField;
    ibDataSet16CST_PIS_COFINS: TIBStringField;
    ibDataSet23CST_IPI: TIBStringField;
    Livrodereceitas1: TMenuItem;
    Cardpio1: TMenuItem;
    RelatriodeIPI1: TMenuItem;
    RelatriodePISCOFINS1: TMenuItem;
    ibDataSet14CSTPISCOFINS: TIBStringField;
    ibDataSet23CST_PIS_COFINS: TIBStringField;
    ibDataSet23ALIQ_PIS: TIBBCDField;
    ibDataSet23ALIQ_COFINS: TIBBCDField;
    SPEDPISCOFINS1: TMenuItem;
    WebBrowser1: TWebBrowser;
    CCartadeCorreoEletronicaCCe1: TMenuItem;
    ibDataSet15ICCE: TIntegerField;
    ibDataSet15CCEXML: TMemoField;
    ibDataSet16XPED: TIBStringField;
    ibDataSet16NITEMPED: TIBStringField;
    ibDataSet15NVOL: TIBStringField;
    ibDataSet24NVOL: TIBStringField;
    ibDataSet27CST_PIS_COFINS: TIBStringField;
    ibDataSet27DESCONTO: TIBBCDField;
    ibDataSet27ANVISA: TIntegerField;
    ibDataSet27CST_ICMS: TIBStringField;
    ibDataSet27ALIQ_PIS: TIBBCDField;
    ibDataSet27ALIQ_COFINS: TIBBCDField;
    ibDataSet27OBS: TIBStringField;
    ibDataSet27STATUS: TIBStringField;
    ibDataSet27SERIE: TIBStringField;
    ibDataSet27SUBSERIE: TIBStringField;
    ibDataSet27CFOP: TIBStringField;
    ibDataSet4ONPROMO: TIBBCDField;
    ibDataSet4OFFPROMO: TIBBCDField;
    ibDataSet4PROMOINI: TDateField;
    ibDataSet4PROMOFIM: TDateField;
    IBDataSet128: TIBDataSet;
    ibDataSet15PLACA: TIBStringField;
    N10: TMenuItem;
    Resumodainadimplncia1: TMenuItem;
    Image1: TImage;
    Manifestaododestinatrio1: TMenuItem;
    ibDataSet24MDESTINXML: TMemoField;
    positivo: TImage;
    Positivovermelho: TImage;
    ibDataSet4IIA: TFloatField;
    IImprimirCartadeCorreoEletronicaCCe1: TMenuItem;
    ibDataSet15ANVISA: TIntegerField;
    ibDataSet15DATA_CANCEL: TDateField;
    ibDataSet15HORA_CANCEL: TIBStringField;
    ibDataSet15COD_SIT: TIBStringField;
    ibDataSet24EMISSAO: TDateField;
    ibDataSet23NUMERONF: TIBStringField;
    ibDataSet8NUMERONF: TIBStringField;
    ibDataSet24NUMERONF: TIBStringField;
    ibDataSet24ANVISA: TIntegerField;
    EtiquetasZebraArgoxElgin1: TMenuItem;
    Panel1: TPanel;
    spdNFeDataSets: TspdNFeDataSets;
    N57: TMenuItem;
    ImprimiraNFemformulrionumerado1: TMenuItem;
    ImprimirtodasasNFfiltradas1: TMenuItem;
    Panel3: TPanel;
    Button2: TButton;
    Button3: TButton;
    Button4: TButton;
    Button5: TButton;
    FCIFichadeContedodeImportao1: TMenuItem;
    ibDataSet4VALOR_PARCELA_IMPORTADA_EXTERIO: TIBBCDField;
    ibDataSet4CODIGO_FCI: TIBStringField;
    ibDataSet23CST_ICMS: TIBStringField;
    spdNFe: TspdNFe;
    ibDataSet18ANTT: TIBStringField;
    N58: TMenuItem;
    Produtividadedecontatos1: TMenuItem;
    Clientescontactadospordia1: TMenuItem;
    Clientescontactadospordiaeporvendedor1: TMenuItem;
    Relatriodevendasporvendedor1: TMenuItem;
    ibDataSet4CFOP: TIBStringField;
    PopupMenu2: TPopupMenu;
    MainMenu00: TMainMenu;
    Panel4: TPanel;
    Panel_0: TPanel;
    imgNovo: TImage;
    imgExcluir: TImage;
    imgProcurar: TImage;
    imgImprimir: TImage;
    imgVisualizar: TImage;
    imgEditar: TImage;
    Image308: TImage;
    imgFiltrar: TImage;
    lblNovo: TLabel;
    lblExcluir: TLabel;
    lblProcurar: TLabel;
    lblImprimir: TLabel;
    lblVisualizar: TLabel;
    lblEditar: TLabel;
    Label208: TLabel;
    lblFiltrar: TLabel;
    imgLibBloq: TImage;
    Panel5: TPanel;
    Image201_X: TImage;
    Image202_X: TImage;
    Image203_X: TImage;
    Image205_X: TImage;
    Image204_X: TImage;
    Image206_X: TImage;
    Image208_X: TImage;
    Image209_X: TImage;
    Panel6: TPanel;
    Image201_R: TImage;
    Image202_R: TImage;
    Image203_R: TImage;
    Image205_R: TImage;
    Image204_R: TImage;
    Image206_R: TImage;
    Image208_R: TImage;
    Image209_R: TImage;
    Image308_X: TImage;
    Image308_R: TImage;
    ibDataSet4MEDIDAE: TIBStringField;
    ibDataSet4FATORC: TIBBCDField;
    ibDataSet23QTD_ORIGINAL:  TFloatField;
    ibDataSet23UNITARIO_O:  TFloatField;
    Emaildecobrana2: TMenuItem;
    Image3: TImage;
    ibDataSet4IIA_UF: TFloatField;
    ibDataSet4IIA_MUNI: TFloatField;
    ibDataSet4CF: TIBStringField;
    ibDataSet16ANVISA: TIntegerField;
    ibDataSet23ANVISA: TIntegerField;
    ibDataSet15FINNFE: TIBStringField;
    ibDataSet15INDFINAL: TIBStringField;
    ibDataSet15INDPRES: TIBStringField;
    ibDataSet24FINNFE: TIBStringField;
    ibDataSet24INDFINAL: TIBStringField;
    ibDataSet24INDPRES: TIBStringField;
    IBDataSet6: TIBDataSet;
    DataSource6: TDataSource;
    IBDataSet6REGISTRO: TIBStringField;
    IBDataSet6FORNECEDOR: TIBStringField;
    ibDataSet23EAN_ORIGINAL: TIBStringField;
    IBDataSet6CODIGO: TIBStringField;
    IBDataSet6EAN: TIBStringField;
    ibDataSet4CSOSN_NFCE: TIBStringField;
    ibDataSet4CST_NFCE: TIBStringField;
    ibDataSet4ALIQUOTA_NFCE: TIBBCDField;
    ibDataSet4CEST: TIBStringField;
    ibDataSet4ENQ_IPI: TIBStringField;
    AnliseAnualdascontas1: TMenuItem;
    IBDataSet99999: TIBDataSet;
    DataSource17: TDataSource;
    IBDataSet99999NOME: TIBStringField;
    IBDataSet99999FOTO: TBlobField;
    IBDataSet99999REGISTRO: TIBStringField;
    Clientescontactadospormsporvendedor1: TMenuItem;
    ibDataSet16PFCPUFDEST: TFloatField;
    ibDataSet16PICMSUFDEST: TFloatField;
    IBDataSet88888: TIBDataSet;
    btnRetornoCNAB400: TButton;
    OpenDialog4: TOpenDialog;
    GerCNAB400: TMenuItem;
    ibDataSet7NN: TIBStringField;
    Baixaestacontanobanco1: TMenuItem;
    ibDataSet4QTD_PRO1: TFloatField;
    ibDataSet4QTD_PRO2: TFloatField;
    ibDataSet4DESCONT1: TFloatField;
    ibDataSet4DESCONT2: TFloatField;
    Vendas_XXX: TMenuItem;
    NotasfiscaisdesadavendassrieXXX1: TMenuItem;
    miRelProdMonofasicosCupom: TMenuItem;
    Relatriodeprodutosmonofsicos1: TMenuItem;
    Anlisedofaturamento1: TMenuItem;
    AnliseMensal1: TMenuItem;
    Analiseanual1: TMenuItem;
    ibDataSet15ENCRYPTHASH: TIBStringField;
    ibDataSet16ENCRYPTHASH: TIBStringField;
    ibDataSet13ENCRYPTHASH: TIBStringField;
    Anlisediaria1: TMenuItem;
    gerCNAB240: TMenuItem;
    btnRetornoCNAB240: TButton;
    spdNFeDPEC1: TspdNFeDPEC;
    ConsultarNFesemitidasparameuCNPJ1: TMenuItem;
    PositivoDownloadXML: TImage;
    VisualizarXMLdamanifestaododestinatrio1: TMenuItem;
    ibDataSet4TAGS_: TMemoField;
    N59: TMenuItem;
    ImageWhatsApp: TImage;
    IBDataSet2WHATSAPP: TIBStringField;
    N28: TMenuItem;
    EnviarmensagemWhatsAppparatodos1: TMenuItem;
    Notasfiscaisdesadavendassrie9201: TMenuItem;
    NotasfiscaisdesadavendascomCPFsrie9201: TMenuItem;
    miRelCompRestICMS: TMenuItem;
    ClculodoCustodaltimaNota1: TMenuItem;
    Manifesto1: TMenuItem;
    PositivoVerde: TImage;
    IdHTTP1: TIdHTTP;
    ibDataSet13LICENCA: TIBStringField;
    EnvioaoFISCOREDUOZ1: TMenuItem;
    N62: TMenuItem;
    ExportarNfesdeentrdaparacontabilidade1: TMenuItem;
    IBQueryCoringa: TIBQuery;
    ManifestaododestinatrioDesc1: TMenuItem;
    Manifestaaododestinatrio1: TMenuItem;
    ransmitirNotaFiscaldeServioNFSe1: TMenuItem;
    Visu1: TMenuItem;
    EnviarNFSeporemail1: TMenuItem;
    CancelarNFSe1: TMenuItem;
    SMALL_DBEdit3: TSMALL_DBEdit;
    GerarNotaFiscaldeServio1: TMenuItem;
    GerarNotaFiscaldeServio2: TMenuItem;
    ibDataSet4MARKETPLACE: TIBStringField;
    ConsultarNFSe1: TMenuItem;
    mmServicos: TMainMenu;
    MenuItem19: TMenuItem;
    MenuItem95: TMenuItem;
    MenuItem96: TMenuItem;
    MenuItem103: TMenuItem;
    miAjudaServico: TMenuItem;
    miExibirAjudaServico: TMenuItem;
    miTermoUsoServico: TMenuItem;
    miSobreSistemaServico: TMenuItem;
    Label27: TLabel;
    ImportarOrdemdeServio1: TMenuItem;
    ImportarOramento2: TMenuItem;
    N63: TMenuItem;
    N64: TMenuItem;
    ConfiguraesdaNFSe1: TMenuItem;
    N65: TMenuItem;
    NFeTransmitirasprximas1: TMenuItem;
    DevolverNF1: TMenuItem;
    ibDataSet15MARKETPLACE: TIBStringField;
    RelatriodeprodutosmonofsicosNFe1: TMenuItem;
    IBQuery6: TIBQuery;
    N66: TMenuItem;
    DuplicatestaNFe1: TMenuItem;
    PrvisualizarDANFE1: TMenuItem;
    IBQALIQUOTAISS: TIBQuery;
    ibDataSet27CSOSN: TIBStringField;
    RelatriodePISCOFINSCupomFiscal1: TMenuItem;
    ibDataSet16CSOSN: TIBStringField;
    ibDataSet24IDENTIFICADORPLANOCONTAS: TIBStringField;
    ibDataSet4IDENTIFICADORPLANOCONTAS: TIBStringField;
    ibDataSet4IDPERFILTRIBUTACAO: TIntegerField;
    ibDataSet16IDENTIFICADORPLANOCONTAS: TIBStringField;
    ibDataSet35IDENTIFICADORPLANOCONTAS: TIBStringField;
    Gerarboletoeenviodeemaildecobranatotalizadoporcliente1: TMenuItem;
    //ibDataSet14FRETESOBREIPI: TIBStringField;
    ibDataSet23VBCFCP: TIBBCDField;
    ibDataSet23PFCP: TIBBCDField;
    ibDataSet23VFCP: TIBBCDField;
    ibDataSet23VBCFCPST: TIBBCDField;
    ibDataSet23PFCPST: TIBBCDField;
    ibDataSet23VFCPST: TIBBCDField;
    ibDataSet24VFCPST: TIBBCDField;
    Exibir7: TMenuItem;
    odos1: TMenuItem;
    Sativos1: TMenuItem;
    Sinativos1: TMenuItem;
    EEnviarcartadecorreoporemail1: TMenuItem;
    N67: TMenuItem;
    N68: TMenuItem;
    ibDataSet16VBCFCP: TIBBCDField;
    ibDataSet16PFCP: TIBBCDField;
    ibDataSet16VFCP: TIBBCDField;
    ibDataSet16VBCFCPST: TIBBCDField;
    ibDataSet16PFCPST: TIBBCDField;
    ibDataSet16VFCPST: TIBBCDField;
    ibDataSet15VFCPST: TIBBCDField;
    ibDataSet7INSTITUICAOFINANCEIRA: TIBStringField;
    DSConsulta: TDataSource;
    ibqConsulta: TIBDataSet;
    ibDataSet11INSTITUICAOFINANCEIRA: TIBStringField;
    ibDataSet7FORMADEPAGAMENTO: TIBStringField;
    ibDataSet7AUTORIZACAOTRANSACAO: TIBStringField;
    ibDataSet7BANDEIRA: TIBStringField;
    CDSItensNotaAux: TClientDataSet;
    CDSItensNotaAuxDESCRICAO: TStringField;
    CDSItensNotaAuxQTDE: TCurrencyField;
    CDSItensNotaAuxINDICE: TIntegerField;
    CDSItensNotaAuxCODIGO: TStringField;
    RelatriodevendasporclienteNFeCupom1: TMenuItem;
    ibDataSet23ICMS_DESONERADO: TIBBCDField;
    ibDataSet23PICMSST: TIBBCDField;
    ibDataSet24ICMS_DESONERADO: TIBBCDField;
    pnlFiltro: TPanel;
    lblHomologacao: TLabel;
    Panel7: TPanel;
    Exibir8: TMenuItem;
    Oramentospendentes1: TMenuItem;
    Oramentosfinalizados1: TMenuItem;
    odos2: TMenuItem;
    ConversodeCFOP1: TMenuItem;
    Label24: TLabel;
    mmConvercaoCFOP: TMainMenu;
    MenuItem129: TMenuItem;
    MenuItem142: TMenuItem;
    MenuItem144: TMenuItem;
    MenuItem145: TMenuItem;
    MenuItem151: TMenuItem;
    MenuItem159: TMenuItem;
    MenuItem160: TMenuItem;
    MenuItem161: TMenuItem;
    MenuItem162: TMenuItem;
    MenuItem163: TMenuItem;
    miAjudaConvCFOP: TMenuItem;
    miExibirAjudaConvCFOP: TMenuItem;
    miTermoUsoConvCFOP: TMenuItem;
    miSobreSistemaConvCFOP: TMenuItem;
    DSConversaoCFOP: TDataSource;
    ibdConversaoCFOP: TIBDataSet;
    ibdConversaoCFOPCFOP_ORIGEM: TIBStringField;
    ibdConversaoCFOPCFOP_CONVERSAO: TIBStringField;
    ibdConversaoCFOPREGISTRO: TIBStringField;
    ConfiguraodeICMSeISS1: TMenuItem;
    Label29: TLabel;
    mmPerfilTributa: TMainMenu;
    MenuItem130: TMenuItem;
    MenuItem132: TMenuItem;
    MenuItem175: TMenuItem;
    MenuItem176: TMenuItem;
    MenuItem184: TMenuItem;
    MenuItem185: TMenuItem;
    MenuItem186: TMenuItem;
    MenuItem187: TMenuItem;
    MenuItem188: TMenuItem;
    MenuItem189: TMenuItem;
    miAjudaPerfilTrib: TMenuItem;
    miExibirAjudaPerfilTrib: TMenuItem;
    miTermoUsoPerfilTrib: TMenuItem;
    miSobreSistemaPerfilTrib: TMenuItem;
    DSPerfilTributa: TDataSource;
    ibdPerfilTributa: TIBDataSet;
    ibdPerfilTributaIDPERFILTRIBUTACAO: TIntegerField;
    ibdPerfilTributaDESCRICAO: TIBStringField;
    ibdPerfilTributaTIPO_ITEM: TIBStringField;
    ibdPerfilTributaIPPT: TIBStringField;
    ibdPerfilTributaIAT: TIBStringField;
    ibdPerfilTributaPIVA: TFloatField;
    ibdPerfilTributaCST: TIBStringField;
    ibdPerfilTributaCSOSN: TIBStringField;
    ibdPerfilTributaST: TIBStringField;
    ibdPerfilTributaCFOP: TIBStringField;
    ibdPerfilTributaCST_NFCE: TIBStringField;
    ibdPerfilTributaCSOSN_NFCE: TIBStringField;
    ibdPerfilTributaALIQUOTA_NFCE: TIBBCDField;
    ibdPerfilTributaCST_IPI: TIBStringField;
    ibdPerfilTributaIPI: TFloatField;
    ibdPerfilTributaENQ_IPI: TIBStringField;
    ibdPerfilTributaCST_PIS_COFINS_SAIDA: TIBStringField;
    ibdPerfilTributaALIQ_PIS_SAIDA: TIBBCDField;
    ibdPerfilTributaALIQ_COFINS_SAIDA: TIBBCDField;
    ibdPerfilTributaCST_PIS_COFINS_ENTRADA: TIBStringField;
    ibdPerfilTributaALIQ_COFINS_ENTRADA: TIBBCDField;
    ibdPerfilTributaREGISTRO: TIBStringField;
    ibdPerfilTributaALIQ_PIS_ENTRADA: TIBBCDField;
    IbdOrcamentObs: TIBDataSet;
    IbdOrcamentObsREGISTRO: TIBStringField;
    IbdOrcamentObsPEDIDO: TIBStringField;
    IbdOrcamentObsOBS: TMemoField;
    dsOrcamentObs: TDataSource;
    EnviarOrcamentoPorEmail1: TMenuItem;
    Label38: TLabel;
    Label39: TLabel;
    DSParametroTributa: TDataSource;
    mmParametroTributa: TMainMenu;
    MenuItem131: TMenuItem;
    MenuItem194: TMenuItem;
    MenuItem195: TMenuItem;
    MenuItem197: TMenuItem;
    MenuItem198: TMenuItem;
    MenuItem199: TMenuItem;
    MenuItem200: TMenuItem;
    MenuItem201: TMenuItem;
    MenuItem202: TMenuItem;
    MenuItem203: TMenuItem;
    miAjudaParamTributa: TMenuItem;
    miExibirAjudaParamTributa: TMenuItem;
    miTermoUsoParamTributa: TMenuItem;
    miSobreSistemaParamTributa: TMenuItem;
    ibdParametroTributa: TIBDataSet;
    ibdParametroTributaIDPARAMETROTRIBUTACAO: TIntegerField;
    ibdParametroTributaCFOP_ENTRADA: TIBStringField;
    ibdParametroTributaORIGEM_ENTRADA: TIBStringField;
    ibdParametroTributaCST_ENTRADA: TIBStringField;
    ibdParametroTributaCSOSN_ENTRADA: TIBStringField;
    ibdParametroTributaALIQ_ENTRADA: TIBBCDField;
    ibdParametroTributaNCM_ENTRADA: TIBStringField;
    ibdParametroTributaIDPERFILTRIBUTACAO: TIntegerField;
    ibdParametroTributaREGISTRO: TIBStringField;
    ibdParametroTributaDESCRICAO: TIBStringField;
    Perfildetributao1: TMenuItem;
    Parmetrosdetributao1: TMenuItem;
    ibDataSet7VALOR_MULTA: TIBBCDField;
    ibDataSet7PERCENTUAL_MULTA: TIBBCDField;
	Configurarobservaofixa1: TMenuItem;
    N69: TMenuItem;
    DuplicarProduto: TMenuItem;
    DuplicaOrcamento: TMenuItem;
    ImprimirOrcamento: TMenuItem;
    CartadeCorreoEletrnicaCCe1: TMenuItem;
    ExportarXML1: TMenuItem;
    N70: TMenuItem;
    InutilizaodeNFes1: TMenuItem;
    ImprimirOrdemdeServio2: TMenuItem;
    N71: TMenuItem;
    ConfigurarobservaoparaOS1: TMenuItem;
    ConfigurarobservaoparaRecibo1: TMenuItem;
    ibDataSet3IDOS: TIntegerField;
    ibdSituacaoOS: TIBDataSet;
    DSSitucaoOS: TDataSource;
    mmSituacaoOS: TMainMenu;
    MenuItem216: TMenuItem;
    MenuItem226: TMenuItem;
    MenuItem227: TMenuItem;
    MenuItem228: TMenuItem;
    MenuItem229: TMenuItem;
    MenuItem230: TMenuItem;
    MenuItem231: TMenuItem;
    MenuItem232: TMenuItem;
    MenuItem233: TMenuItem;
    MenuItem234: TMenuItem;
    miAjudaSituacaoOS: TMenuItem;
    miExibirAjudaSituacaoOS: TMenuItem;
    miTermoUsoSituacaoOS: TMenuItem;
    miSobreSistemaSituacaoOS: TMenuItem;
    Label40: TLabel;
    ibdSituacaoOSIDSITUACAO: TIntegerField;
    ibdSituacaoOSSITUACAO: TIBStringField;
    Cadastros1: TMenuItem;
    Cadastrodesituaes1: TMenuItem;
    ibDataSet14CBENEF: TIBStringField;
    otalizadorgeraldevenda1: TMenuItem;
    ibDataSet3NFSE: TIBStringField;
    miRelatoriosVendas: TMenuItem;
    miTermoUsoVendas: TMenuItem;
    miRelatorioCompras: TMenuItem;
    miTermoUsoCompras: TMenuItem;
    miTermoUsoOS: TMenuItem;
    miRelatoriosOS: TMenuItem;
    miRelatoriosCaixa: TMenuItem;
    miRelatoriosClifor: TMenuItem;
    miRelatoriosEstoque: TMenuItem;
    miExcluirOS: TMenuItem;
    Relatrios1: TMenuItem;
    Relatrios2: TMenuItem;
    Relatrios3: TMenuItem;
    RElatrios4: TMenuItem;
    miEditarConvenio: TMenuItem;
    Relatrios5: TMenuItem;
    miNovoConvenio: TMenuItem;
    miAlterarConvenio: TMenuItem;
    miExcluirConvenio: TMenuItem;
    Editar2: TMenuItem;
    Novo2: TMenuItem;
    Alterar2: TMenuItem;
    Fonte1: TMenuItem;
    Procu1: TMenuItem;
    miRelatoriosOrcamento: TMenuItem;
    miEditarOrcamento: TMenuItem;
    miNovoOrcamento: TMenuItem;
    miAlterarOrcamento: TMenuItem;
    miExcluirOrcamento: TMenuItem;
    mmGrupos: TMainMenu;
    MenuItem11: TMenuItem;
    MenuItem99: TMenuItem;
    MenuItem116: TMenuItem;
    MenuItem117: TMenuItem;
    MenuItem122: TMenuItem;
    MenuItem124: TMenuItem;
    MenuItem125: TMenuItem;
    MenuItem126: TMenuItem;
    MenuItem138: TMenuItem;
    MenuItem139: TMenuItem;
    miAjudaGrupo: TMenuItem;
    miExibirAjudaGrupo: TMenuItem;
    miTermoUsoGrupo: TMenuItem;
    miSobreSistemaGrupo: TMenuItem;
    mmContasBancarias: TMainMenu;
    MenuItem33: TMenuItem;
    MenuItem44: TMenuItem;
    MenuItem55: TMenuItem;
    MenuItem66: TMenuItem;
    MenuItem77: TMenuItem;
    MenuItem88: TMenuItem;
    MenuItem120: TMenuItem;
    MenuItem121: TMenuItem;
    MenuItem127: TMenuItem;
    MenuItem133: TMenuItem;
    MenuItem134: TMenuItem;
    MenuItem137: TMenuItem;
    MenuItem140: TMenuItem;
    MenuItem141: TMenuItem;
    procedure IntegraBanco(Sender: TField);
    procedure Sair1Click(Sender: TObject);
    procedure CalculaSaldo(Sender: BooLean);
    procedure SaldoBanco(Sender: BooLean);
    procedure Image102Click(Sender: TObject);
    procedure Image103Click(Sender: TObject);
    procedure Image106Click(Sender: TObject);
    procedure ibDataSet5NewRecord(DataSet: TDataset);
    procedure ibDataSet1NewRecord(DataSet: TDataset);
    procedure Image6Click(Sender: TObject);
    procedure Image101Click(Sender: TObject);
    procedure Image109Click(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
    procedure DBGrid1KeyPress(Sender: TObject; var Key: Char);
    procedure Cartaparamaladireta1Click(Sender: TObject);
    procedure Imprimircarta1Click(Sender: TObject);
    procedure Oramento1Click(Sender: TObject);
    procedure Grupos1Click(Sender: TObject);
    procedure Inventrio1Click(Sender: TObject);
    procedure Relatriodeconpras1Click(Sender: TObject);
    procedure Relatriodevendas1Click(Sender: TObject);
    procedure Previsodecompra1Click(Sender: TObject);
    procedure Movimentaodoitem1Click(Sender: TObject);
    procedure Imprimirpedidosdevenda1Click(Sender: TObject);
    procedure Listadepreos1Click(Sender: TObject);
    procedure Etiquetas1Click(Sender: TObject);
    procedure Contasbancrias1Click(Sender: TObject);
    procedure miSobreSistemaClick(Sender: TObject);
    procedure miExibirAjudaCaixaClick(Sender: TObject);
    procedure Sobreoprograma3Click(Sender: TObject);
    procedure miSobreSistemaEstoqueClick(Sender: TObject);
    procedure miSobreSistemaBancoClick(Sender: TObject);
    procedure miSobreSistemaReceberClick(Sender: TObject);
    procedure miSobreSistemaPagarClick(Sender: TObject);
    procedure miSobreSistemaVendedorClick(Sender: TObject);
    procedure Sobreoprograma9Click(Sender: TObject);
    procedure miSobreSistemaPlanoContasClick(Sender: TObject);
    procedure miSobreSistemaCliforClick(Sender: TObject);
    procedure ibDataSet15MERCADORIAChange(Sender: TField);
    procedure FormCreate(Sender: TObject);
    procedure ibDataSet14INTEGRACAOChange(Sender: TField);
    procedure DBGrid1TitleClick(Column: TColumn);
    procedure ibDataSet7VALOR_RECEValidate(Sender: TField);
    procedure ibDataSet5COMPENSSetText(Sender: TField; const Text: String);
    procedure FormShow(Sender: TObject);
    procedure DBGrid1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Imprimircheque1Click(Sender: TObject);
    procedure ibDataSet24MERCADORIAChange(Sender: TField);
    procedure ibDataSet2BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet5ENTRADA_Change(Sender: TField);
    procedure ibDataSet5SAIDA_Change(Sender: TField);
    procedure ibDataSet1ENTRADAChange(Sender: TField);
    procedure ibDataSet1SAIDAChange(Sender: TField);
    procedure ibDataSet2NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet4BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet4DESCRICAOSetText(Sender: TField; const Text: String);
    procedure ibDataSet4NewRecord(DataSet: TDataSet);
    procedure Fluxodecaixa2Click(Sender: TObject);
    procedure ibDataSet7NewRecord(DataSet: TDataSet);
    procedure ibDataSet4QTD_ATUALChange(Sender: TField);
    procedure ibDataSet1BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet5BeforeDelete(DataSet: TDataSet);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure RegistroFiscal1Click(Sender: TObject);
    procedure Aumentodepreo1Click(Sender: TObject);
    procedure ibDataSet2ESTADOSetText(Sender: TField; const Text: String);
    procedure ibDataSet13ESTADOSetText(Sender: TField; const Text: String);
    procedure ibDataSet15VOLUMESChange(Sender: TField);
    procedure ibDataSet12BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet12AfterPost(DataSet: TDataSet);
    procedure Relatriodecomisses1Click(Sender: TObject);
    procedure Resumodasvendas1Click(Sender: TObject);
    procedure Histrico1Click(Sender: TObject);
    procedure ibDataSet7AfterPost(DataSet: TDataSet);
    procedure ibDataSet7VALOR_RECEChange(Sender: TField);
    procedure ibDataSet4REFERENCIASetText(Sender: TField; const Text: String);
    procedure ibDataSet12NewRecord(DataSet: TDataSet);
    procedure ibDataSet3NewRecord(DataSet: TDataSet);
    procedure Caixa1Click(Sender: TObject);
    procedure FormKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure ibDataSet1NOMEChange(Sender: TField);
    procedure MenuItem34Click(Sender: TObject);
    procedure ibDataSet7VALOR_DUPLChange(Sender: TField);
    procedure PopupMenu1Popup(Sender: TObject);
    procedure Ativo1Click(Sender: TObject);
    procedure Emailpara1Click(Sender: TObject);
    procedure MenuItem1Click(Sender: TObject);
    procedure MenuItem27Click(Sender: TObject);
    procedure Ativo4Click(Sender: TObject);
    procedure Relatriodeservios1Click(Sender: TObject);
    procedure Relatriodeoramentospendentes1Click(Sender: TObject);
    procedure ibDataSet4MARGEMLBChange(Sender: TField);
    procedure ibDataSet4BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet18ESTADOSetText(Sender: TField; const Text: String);
    procedure ibDataSet15TOTALChange(Sender: TField);
    procedure ibDataSet18UFSetText(Sender: TField; const Text: String);
    procedure DBGrid1DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure Balancetegerencial1Click(Sender: TObject);
    procedure Balancetegerencialanual1Click(Sender: TObject);
    procedure ibDataSet1BeforeEdit(DataSet: TDataSet);
    procedure Ranquingdeclientes1Click(Sender: TObject);
    procedure MenuItem60Click(Sender: TObject);
    procedure ibDataSet19AfterPost(DataSet: TDataSet);
    procedure ibDataSet2CGCSetText(Sender: TField; const Text: String);
    procedure ibDataSet7DOCUMENTOSetText(Sender: TField; const Text: String);
    procedure ibDataSet5DOCUMENTOSetText(Sender: TField; const Text: String);
    procedure ibDataSet13CGCSetText(Sender: TField; const Text: String);
    procedure ibDataSet18CGCSetText(Sender: TField; const Text: String);
    procedure ibDataSet21NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet9NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet4PRECOChange(Sender: TField);
    procedure Balancetegerancialmensal1Click(Sender: TObject);
    procedure Balancetegerencialanual2Click(Sender: TObject);
    procedure ibDataSet9BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet9AfterPost(DataSet: TDataSet);
    procedure MenuItem23Click(Sender: TObject);
    procedure ibDataSet21AfterPost(DataSet: TDataSet);
    procedure ibDataSet21BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet3NOMEChange(Sender: TField);
    procedure ibDataSet4AfterPost(DataSet: TDataSet);
    procedure ibDataSet2AfterPost(DataSet: TDataSet);
    procedure Inadimlencia1Click(Sender: TObject);
    procedure CurvaABC1Click(Sender: TObject);
    procedure CurvaABCdoestoque1Click(Sender: TObject);
    procedure Duplicata1Click(Sender: TObject);
    procedure Carn1Click(Sender: TObject);
    procedure miExibirAjudaPlanoContasClick(Sender: TObject);
    procedure miExibirAjudaVendedorClick(Sender: TObject);
    procedure ibDataSet2OBSSetText(Sender: TField; const Text: String);
    procedure Analisegrafica1Click(Sender: TObject);
    procedure ibDataSet4BeforePost(DataSet: TDataSet);
    procedure ibDataSet28NewRecord(DataSet: TDataSet);
    procedure MenuItem58Click(Sender: TObject);
    procedure Label38Click(Sender: TObject);
    procedure ibDataSet14BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet14AfterPost(DataSet: TDataSet);
    procedure ibDataSet14BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet28AfterDelete(DataSet: TDataSet);
    procedure ibDataSet11PLANOSetText(Sender: TField; const Text: String);
    procedure ibDataSet2DATANASSetText(Sender: TField; const Text: String);
    procedure MenuItem119Click(Sender: TObject);
    procedure Relatriodetodososconvnios1Click(Sender: TObject);
    procedure ibDataSet29NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet2CONVENIOSetText(Sender: TField; const Text: String);
    procedure ibDataSet29BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet29AfterPost(DataSet: TDataSet);
    procedure ibDataSet29BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet29DESCONTOSetText(Sender: TField; const Text: String);
    procedure ibDataSet30NewRecord(DataSet: TDataSet);
    procedure ibDataSet30FilterRecord(DataSet: TDataSet; var Accept: Boolean);
    procedure Receberconvnio1Click(Sender: TObject);
    procedure Acertodecontasde1Click(Sender: TObject);
    procedure RECIBOClick(Sender: TObject);
    procedure ibDataSet12BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet14NOMESetText(Sender: TField; const Text: String);
    procedure ibDataSet1AfterDelete(DataSet: TDataSet);
    procedure Colunas1Click(Sender: TObject);
    procedure imgLibBloqClick(Sender: TObject);
    procedure ibDataSet8VALOR_DUPLChange(Sender: TField);
    procedure ibDataSet8VALOR_PAGOChange(Sender: TField);
    procedure ibDataSet8VALOR_PAGOValidate(Sender: TField);
    procedure ibDataSet8NewRecord(DataSet: TDataSet);
    procedure Sosclientes1Click(Sender: TObject);
    procedure Sosfornecedores1Click(Sender: TObject);
    procedure Acertodecontasde2Click(Sender: TObject);
    procedure MenuItem71Click(Sender: TObject);
    procedure odas1Click(Sender: TObject);
    procedure Receber2Click(Sender: TObject);
    procedure Jrecebidas2Click(Sender: TObject);
    procedure Atrasadas3Click(Sender: TObject);
    procedure Avencer3Click(Sender: TObject);
    procedure Vencendohoje2Click(Sender: TObject);
    procedure odas2Click(Sender: TObject);
    procedure Pagar2Click(Sender: TObject);
    procedure Jpagas2Click(Sender: TObject);
    procedure Avencer1Click(Sender: TObject);
    procedure Atrasadas1Click(Sender: TObject);
    procedure Vencendohoje3Click(Sender: TObject);
    procedure odas3Click(Sender: TObject);
    procedure Lanamentoscompensados1Click(Sender: TObject);
    procedure Lanamentosnocompensados1Click(Sender: TObject);
    procedure Label3MouseLeave(Sender: TObject);
    procedure Label3MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet2BeforeDelete(DataSet: TDataSet);
    procedure Image_FechaClick(Sender: TObject);
    procedure Balanas1Click(Sender: TObject);
    procedure Fechadas1Click(Sender: TObject);
    procedure Abertas1Click(Sender: TObject);
    procedure MenuItem147Click(Sender: TObject);
    procedure Image210Click(Sender: TObject);
    procedure ibDataSet3TOTAL_FRETChange(Sender: TField);
    procedure imgVisualizarClick(Sender: TObject);
    procedure ibDataSet9NewRecord(DataSet: TDataSet);
    procedure ibDataSet34AfterPost(DataSet: TDataSet);
    procedure ibDataSet3BeforeDelete(DataSet: TDataSet);
    procedure Agendada1Click(Sender: TObject);
    procedure Cadastrodetcnicos1Click(Sender: TObject);
    procedure RelatriodepeasemOSabertas1Click(Sender: TObject);
    procedure ibDataSet3SITUACAOChange(Sender: TField);
    procedure Imprimirrecibo1Click(Sender: TObject);
    procedure ImprimirOrdemdeServio1Click(Sender: TObject);
    procedure MenuItem12Click(Sender: TObject);
    procedure Agenda1Click(Sender: TObject);
    procedure ibDataSet19ELEMENTOSetText(Sender: TField; const Text: String);
    procedure Grade1Click(Sender: TObject);
    procedure Cartadecobrana1Click(Sender: TObject);
    procedure Imprimiretiquetaparacobrana1Click(Sender: TObject);
    procedure Imprimircartadecobrana1Click(Sender: TObject);
    procedure ibDataSet2CEPSetText(Sender: TField; const Text: String);
    procedure ibDataSet4QTD_ATUALSetText(Sender: TField; const Text: String);
    procedure Resumodevendas1Click(Sender: TObject);
    procedure DBGrid2DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure DBGrid3DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure Vendas_1Click(Sender: TObject);
    procedure Compras_1Click(Sender: TObject);
    procedure ibDataSet16AfterPost(DataSet: TDataSet);
    procedure ibDataSet16BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet16NewRecord(DataSet: TDataSet);
    procedure ibDataSet16CFOPSetText(Sender: TField; const Text: String);
    procedure ibDataSet16DESCRICAOChange(Sender: TField);
    procedure ibDataSet16DESCRICAOSetText(Sender: TField; const Text: String);
    procedure ibDataSet16QUANTIDADEChange(Sender: TField);
    procedure ibDataSet16QUANTIDADESetText(Sender: TField; const Text: String);
    procedure ibDataSet16UNITARIOChange(Sender: TField);
    procedure ibDataSet16UNITARIOSetText(Sender: TField; const Text: String);
    procedure ibDataSet16TOTALChange(Sender: TField);
    procedure ibDataSet16TOTALSetText(Sender: TField; const Text: String);
    procedure ibDataSet15NewRecord(DataSet: TDataSet);
    procedure ibDataSet2MAESetText(Sender: TField; const Text: String);
    procedure Imprimirdocumento1Click(Sender: TObject);
    procedure Enviartorpedo1Click(Sender: TObject);
    procedure ibDataSet16AfterDelete(DataSet: TDataSet);
    procedure DBGrid4DrawDataCell(Sender: TObject; const Rect: TRect;
      Field: TField; State: TGridDrawState);
    procedure DBGrid4ColEnter(Sender: TObject);
    procedure ibDataSet35AfterPost(DataSet: TDataSet);
    procedure ibDataSet35AfterDelete(DataSet: TDataSet);
    procedure ibDataSet35TOTALChange(Sender: TField);
    procedure ibDataSet23AfterPost(DataSet: TDataSet);
    procedure ibDataSet23BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet23BeforePost(DataSet: TDataSet);
    procedure ibDataSet23DESCRICAOChange(Sender: TField);
    procedure ibDataSet23DESCRICAOSetText(Sender: TField; const Text: String);
    procedure ibDataSet23QUANTIDADEChange(Sender: TField);
    procedure ibDataSet23QUANTIDADESetText(Sender: TField; const Text: String);
    procedure ibDataSet23TOTALChange(Sender: TField);
    procedure ibDataSet23IPIChange(Sender: TField);
    procedure ibDataSet23CFOPSetText(Sender: TField; const Text: String);
    procedure ibDataSet23NewRecord(DataSet: TDataSet);
    procedure ibDataSet24NewRecord(DataSet: TDataSet);
    procedure lblNovoMouseLeave(Sender: TObject);
    procedure lblNovoMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet3AfterDelete(DataSet: TDataSet);
    procedure ibDataSet35UNITARIOChange(Sender: TField);
    procedure ibDataSet15BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet24BeforeDelete(DataSet: TDataSet);
    procedure MenuItem183Click(Sender: TObject);
    procedure ImprimirNF3Click(Sender: TObject);
    procedure Enviaremailparatodos1Click(Sender: TObject);
    procedure Emaildecobrana1Click(Sender: TObject);
    procedure NotasfiscaisdesadavendasSrie11Click(Sender: TObject);
    procedure Rankingdedevedores1Click(Sender: TObject);
    procedure ibDataSet1BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet2NewRecord(DataSet: TDataSet);
    procedure DBGrid1ColEnter(Sender: TObject);
    procedure ibDataSet15BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet16BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet19BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet24BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet3BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet2BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet7BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet9BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet12BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet14BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet8BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet18BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet29BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet5BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet23BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet35BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet30BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet27BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet25BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet26BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet13BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet21BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet10BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet28BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet26NewRecord(DataSet: TDataSet);
    procedure ibDataSet27NewRecord(DataSet: TDataSet);
    procedure ibDataSet14NewRecord(DataSet: TDataSet);
    procedure ibDataSet18NewRecord(DataSet: TDataSet);
    procedure ibDataSet29NewRecord(DataSet: TDataSet);
    procedure ibDataSet35NewRecord(DataSet: TDataSet);
    procedure ibDataSet19NewRecord(DataSet: TDataSet);
    procedure ibDataSet25NewRecord(DataSet: TDataSet);
    procedure ibDataSet13NewRecord(DataSet: TDataSet);
    procedure ibDataSet10NewRecord(DataSet: TDataSet);
    procedure Panel7MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet23UNITARIOChange(Sender: TField);
    procedure ibDataSet3DESCONTOChange(Sender: TField);
    procedure ibDataSet21NewRecord(DataSet: TDataSet);
    procedure ibDataSet5BeforeEdit(DataSet: TDataSet);
    procedure Etiquetaparamaladireta1Click(Sender: TObject);
    procedure ibDataset40AfterPost(DataSet: TDataSet);
    procedure MenuItem56Click(Sender: TObject);
    procedure ibDataSet1CalcFields(DataSet: TDataSet);
    procedure ibDataSet5CalcFields(DataSet: TDataSet);
    procedure Rankingdedevedores2Click(Sender: TObject);
    procedure ibDataSet11BeforeInsert(DataSet: TDataSet);
    procedure ibDataSet11NewRecord(DataSet: TDataSet);
    procedure ibDataSet1DATAChange(Sender: TField);
    procedure ibDataSet5COMPENSChange(Sender: TField);
    procedure IBDataSet2EditError(DataSet: TDataSet; E: EDatabaseError;
      var Action: TDataAction);
    procedure IBDataSet2UpdateError(DataSet: TDataSet; E: EDatabaseError;
      UpdateKind: TUpdateKind; var UpdateAction: TIBUpdateAction);
    procedure IBDataSet2DeleteError(DataSet: TDataSet; E: EDatabaseError;
      var Action: TDataAction);
    procedure IBDataSet2PostError(DataSet: TDataSet; E: EDatabaseError;
      var Action: TDataAction);
    procedure MenuItem75Click(Sender: TObject);
    procedure este1Click(Sender: TObject);
    procedure ibDataSet11BeforePost(DataSet: TDataSet);
    procedure Gerarnotafiscalsrie11Click(Sender: TObject);
    procedure Gerarnotafiscalsrie21Click(Sender: TObject);
    procedure miRelCorrelacaoClick(Sender: TObject);
    procedure Sosclientescomcontasatrasadas1Click(Sender: TObject);
    procedure Sosclientescomsuascontasemdia1Click(Sender: TObject);
    procedure Sosclientescomcontasareceber1Click(Sender: TObject);
    procedure ibDataSet4INDEXADORChange(Sender: TField);
    procedure ibDataSet4CUSTOMEDIOChange(Sender: TField);
    procedure ibDataSet24DESCONTOChange(Sender: TField);
    procedure IBDataSet119BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet119NewRecord(DataSet: TDataSet);
    procedure FloatField3SetText(Sender: TField; const Text: String);
    procedure ArquivotextoNotaFiscalPaulista1Click(Sender: TObject);
    procedure ibDataSet4BeforeInsert(DataSet: TDataSet);
    procedure ImprimirtodasasOSfiltradas1Click(Sender: TObject);
    procedure ibDataSet3SITUACAOSetText(Sender: TField;
      const Text: String);
    procedure ibDataSet11AfterPost(DataSet: TDataSet);
    procedure ibDataSet11BeforeEdit(DataSet: TDataSet);
    procedure Notasfiscaiscanceladas1Click(Sender: TObject);
    procedure Notasfiscaisabertas1Click(Sender: TObject);
    procedure odas4Click(Sender: TObject);
    procedure Exportar1Click(Sender: TObject);
    procedure ImportarOS1Click(Sender: TObject);
    procedure ImportarCupomFiscal1Click(Sender: TObject);
    procedure ImportarOramento1Click(Sender: TObject);
    procedure ImportarNotaFiscal1Click(Sender: TObject);
    procedure IBDataSet2CIDADESetText(Sender: TField; const Text: String);
    procedure Movimentaodositemskardex1Click(Sender: TObject);
    procedure ibDataSet30SERIALSetText(Sender: TField; const Text: String);
    procedure miRelVendasVendedorClick(Sender: TObject);
    procedure ibDataSet15AfterPost(DataSet: TDataSet);
    procedure ibDataSet24AfterPost(DataSet: TDataSet);
    procedure ibDataSet3AfterPost(DataSet: TDataSet);
    procedure ibDataSet1AfterPost(DataSet: TDataSet);
    procedure ibDataSet8AfterPost(DataSet: TDataSet);
    procedure ibDataSet18AfterPost(DataSet: TDataSet);
    procedure ibDataSet5AfterPost(DataSet: TDataSet);
    procedure ibDataSet30AfterPost(DataSet: TDataSet);
    procedure ibDataSet27AfterPost(DataSet: TDataSet);
    procedure ibDataSet25AfterPost(DataSet: TDataSet);
    procedure ibDataSet26AfterPost(DataSet: TDataSet);
    procedure ibDataSet13AfterPost(DataSet: TDataSet);
    procedure ibDataSet10AfterPost(DataSet: TDataSet);
    procedure ibDataSet28AfterPost(DataSet: TDataSet);
    procedure ibDataSet37AfterPost(DataSet: TDataSet);
    procedure ibDataSet15AfterDelete(DataSet: TDataSet);
    procedure ibDataSet24AfterDelete(DataSet: TDataSet);
    procedure IBDataSet2AfterDelete(DataSet: TDataSet);
    procedure ibDataSet7AfterDelete(DataSet: TDataSet);
    procedure ibDataSet9AfterDelete(DataSet: TDataSet);
    procedure ibDataSet12AfterDelete(DataSet: TDataSet);
    procedure ibDataSet14AfterDelete(DataSet: TDataSet);
    procedure ibDataSet8AfterDelete(DataSet: TDataSet);
    procedure ibDataSet18AfterDelete(DataSet: TDataSet);
    procedure ibDataSet29AfterDelete(DataSet: TDataSet);
    procedure ibDataSet5AfterDelete(DataSet: TDataSet);
    procedure IBDataSet99AfterDelete(DataSet: TDataSet);
    procedure ibDataSet23AfterDelete(DataSet: TDataSet);
    procedure ibDataSet19AfterDelete(DataSet: TDataSet);
    procedure ibDataSet30AfterDelete(DataSet: TDataSet);
    procedure ibDataSet27AfterDelete(DataSet: TDataSet);
    procedure ibDataSet25AfterDelete(DataSet: TDataSet);
    procedure ibDataSet26AfterDelete(DataSet: TDataSet);
    procedure ibDataSet13AfterDelete(DataSet: TDataSet);
    procedure ibDataSet21AfterDelete(DataSet: TDataSet);
    procedure ibDataSet10AfterDelete(DataSet: TDataSet);
    procedure ibDataset40AfterDelete(DataSet: TDataSet);
    procedure ibDataSet11AfterDelete(DataSet: TDataSet);
    procedure ibDataSet37AfterDelete(DataSet: TDataSet);
    procedure IBDataSet119AfterDelete(DataSet: TDataSet);
    procedure Relatriodetotaldeserviosporvendedor1Click(Sender: TObject);
    procedure Resumodascompras1Click(Sender: TObject);
    procedure Resumodascomrpas1Click(Sender: TObject);
    procedure miExibirAjudaICMClick(Sender: TObject);
    procedure ibDataSet1BeforePost(DataSet: TDataSet);
    procedure ibDataSet5BeforePost(DataSet: TDataSet);
    procedure ibDataSet7BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet8BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet7BeforePost(DataSet: TDataSet);
    procedure ibDataSet7BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet8BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet8BeforePost(DataSet: TDataSet);
    procedure N4ImprimirDANFE1Click(Sender: TObject);
    procedure N1EnviarNFe1Click(Sender: TObject);
    procedure N2ConsultarrecibodaNFe1Click(Sender: TObject);
    procedure N3ConsultarNFe1Click(Sender: TObject);
    procedure CancelarNFe1Click(Sender: TObject);
    procedure N6EnviarNFeConsultareImprimirDANFE1Click(Sender: TObject);
    procedure N0TestarservidorNFe1Click(Sender: TObject);
    procedure ransmitirNFe1Click(Sender: TObject);
    procedure N5EnviarDANFEporemail1Click(Sender: TObject);
    procedure N6VisualizarDANFE1Click(Sender: TObject);
    procedure ibDataset40NewRecord(DataSet: TDataSet);
    procedure ibDataset40BeforeInsert(DataSet: TDataSet);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure GerarNFedeentrada1Click(Sender: TObject);
    procedure N9ImprimirDANFEemformulriodecontingncia1Click(
      Sender: TObject);
    procedure Agrupar1Click(Sender: TObject);
    procedure ExportarNFesemarquivoXML1Click(Sender: TObject);
    procedure ibDataSet4ULT_VENDASetText(Sender: TField;
      const Text: String);
    procedure XConsultarcadastro1Click(Sender: TObject);
    procedure vendasparaClick(Sender: TObject);
    procedure Ca1Click(Sender: TObject);
    procedure lbumdefotografias1Click(Sender: TObject);
    procedure SPEDFiscal1Click(Sender: TObject);
    procedure ibDataSet8DOCUMENTOSetText(Sender: TField;
      const Text: String);
    procedure SMALL_DBEdit2Change(Sender: TObject);
    procedure Edit2KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SMALL_DBEdit1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure DBGrid3KeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SMALL_DBEdit6Exit(Sender: TObject);
    procedure SMALL_DBEdit1Exit(Sender: TObject);
    procedure SMALL_DBEdit6KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Romaneiodecarga1Click(Sender: TObject);
    procedure ConsultarvalidadedaNFe1Click(Sender: TObject);
    procedure ibDataSet16BeforePost(DataSet: TDataSet);
    procedure GerarNotaFiscalSrie12Click(Sender: TObject);
    procedure GerarNotaFiscalSrie22Click(Sender: TObject);
    procedure Relatriodeoramentospendentes2Click(Sender: TObject);
    procedure ibDataSet27BeforePost(DataSet: TDataSet);
    procedure ibDataSet37BeforePost(DataSet: TDataSet);
    procedure VVerificaresquemashema1Click(Sender: TObject);
    procedure Importarretornodevendaambulante1Click(Sender: TObject);
    procedure ibDataSet24BeforeEdit(DataSet: TDataSet);
    procedure ibDataSet4MEDIDASetText(Sender: TField; const Text: String);
    procedure RRecuperaroXMLdestaNFe1Click(Sender: TObject);
    procedure ExportarNFesfiltradasemarquivoXML1Click(Sender: TObject);
    procedure ibDataSet23ICMChange(Sender: TField);
    procedure Imprimirrecibo2Click(Sender: TObject);
    procedure Imprimirrecibo3Click(Sender: TObject);
    procedure ibDataSet4LIVRE4Validate(Sender: TField);
    procedure imgImprimirClick(Sender: TObject);
    procedure ibDataSet27BeforeDelete(DataSet: TDataSet);
    procedure Button6Click(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure Button8Click(Sender: TObject);
    procedure RelatriodeIPI1Click(Sender: TObject);
    procedure RelatriodePISCOFINS1Click(Sender: TObject);
    procedure Cardpio1Click(Sender: TObject);
    procedure Livrodereceitas1Click(Sender: TObject);
    procedure ibDataSet4ALIQ_PIS_ENTRADAChange(Sender: TField);
    procedure SPEDPISCOFINS1Click(Sender: TObject);
    procedure WebBrowser1DownloadComplete(Sender: TObject);
    procedure CCartadeCorreoEletronicaCCe1Click(Sender: TObject);
    procedure IBDataSet128BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet128BeforePost(DataSet: TDataSet);
    procedure IBDataSet128NewRecord(DataSet: TDataSet);
    procedure Exibir1Click(Sender: TObject);
    procedure ibDataSet4PROMOINISetText(Sender: TField;
      const Text: String);
    procedure Resumodainadimplncia1Click(Sender: TObject);
    procedure Manifestaododestinatrio1Click(Sender: TObject);
    procedure ibDataSet4CFChange(Sender: TField);
    procedure IImprimirCartadeCorreoEletronicaCCe1Click(Sender: TObject);
    procedure EtiquetasZebraArgoxElgin1Click(Sender: TObject);
    procedure Panel1Click(Sender: TObject);
    procedure ImprimiraNFemformulrionumerado1Click(Sender: TObject);
    procedure ImprimirtodasasNFfiltradas1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure FCIFichadeContedodeImportao1Click(Sender: TObject);
    procedure Produtividadedecontatos1Click(Sender: TObject);
    procedure Clientescontactadospordia1Click(Sender: TObject);
    procedure Clientescontactadospordiaeporvendedor1Click(Sender: TObject);
    procedure IBDataSet2BeforePost(DataSet: TDataSet);
    procedure Button10Click(Sender: TObject);
    procedure lblExcluirMouseLeave(Sender: TObject);
    procedure lblProcurarMouseLeave(Sender: TObject);
    procedure lblImprimirMouseLeave(Sender: TObject);
    procedure lblVisualizarMouseLeave(Sender: TObject);
    procedure lblEditarMouseLeave(Sender: TObject);
    procedure Label208MouseLeave(Sender: TObject);
    procedure lblFiltrarMouseLeave(Sender: TObject);
    procedure lblExcluirMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure lblProcurarMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure lblImprimirMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure lblVisualizarMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure lblEditarMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Label208MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure lblFiltrarMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ibDataSet23QTD_ORIGINALChange(Sender: TField);
    procedure ibDataSet23UNITARIO_OChange(Sender: TField);
    procedure ibDataSet23AfterScroll(DataSet: TDataSet);
    procedure Emaildecobrana2Click(Sender: TObject);
    procedure EmailAtualizaBoletoscobranaClick(Sender: TObject);
    procedure FormMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Panel4MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Panel_0MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure DBGrid1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure IBDataSet6AfterDelete(DataSet: TDataSet);
    procedure IBDataSet6AfterPost(DataSet: TDataSet);
    procedure IBDataSet6BeforeInsert(DataSet: TDataSet);
    procedure IBDataSet6NewRecord(DataSet: TDataSet);
    procedure AnliseAnualdascontas1Click(Sender: TObject);
    procedure Clientescontactadospormsporvendedor1Click(Sender: TObject);
    procedure ibDataSet4CESTSetText(Sender: TField; const Text: String);
    procedure btnRetornoCNAB400Click(Sender: TObject);
    procedure Baixaestacontanobanco1Click(Sender: TObject);
    procedure IBDataSet2CREDITOSetText(Sender: TField; const Text: String);
    procedure Vendas_XXXClick(Sender: TObject);
    procedure NotasfiscaisdesadavendassrieXXX1Click(Sender: TObject);
    procedure miRelProdMonofasicosCupomClick(Sender: TObject);
    procedure ibDataSet4CFSetText(Sender: TField; const Text: String);
    procedure AnliseMensal1Click(Sender: TObject);
    procedure ibDataSet15BeforePost(DataSet: TDataSet);
    procedure ibDataSet13BeforePost(DataSet: TDataSet);
    procedure ibDataSet7PORTADORSetText(Sender: TField;
      const Text: String);
    procedure Anlisediaria1Click(Sender: TObject);
    procedure btnRetornoCNAB240Click(Sender: TObject);
    procedure ConsultarNFesemitidasparameuCNPJ1Click(Sender: TObject);
    procedure VisualizarXMLdamanifestaododestinatrio1Click(
      Sender: TObject);
    procedure DBGrid1CellClick(Column: TColumn);
    procedure EnviarmensagemWhatsAppparatodos1Click(Sender: TObject);
    procedure ibDataSet4OBSValidate(Sender: TField);
    procedure Notasfiscaisdesadavendassrie9201Click(Sender: TObject);
    procedure miRelCompRestICMSClick(Sender: TObject);
    procedure ClculodoCustodaltimaNota1Click(Sender: TObject);
    procedure Manifesto1Click(Sender: TObject);
    procedure EnvioaoFISCOREDUOZ1Click(Sender: TObject);
    procedure ExportarNfesdeentrdaparacontabilidade1Click(Sender: TObject);
    procedure ManifestaododestinatrioDesc1Click(Sender: TObject);
    procedure Manifestaaododestinatrio1Click(Sender: TObject);
    procedure ransmitirNotaFiscaldeServioNFSe1Click(Sender: TObject);
    procedure Visu1Click(Sender: TObject);
    procedure EnviarNFSeporemail1Click(Sender: TObject);
    procedure CancelarNFSe1Click(Sender: TObject);
    procedure ibDataSet35DESCRICAOSetText(Sender: TField;
      const Text: String);
    procedure GerarNotaFiscaldeServio1Click(Sender: TObject);
    procedure GerarNotaFiscaldeServio2Click(Sender: TObject);
    procedure ConsultarNFSe1Click(Sender: TObject);
    procedure ConfiguraesdaNFSe1Click(Sender: TObject);
    procedure NFeTransmitirasprximas1Click(Sender: TObject);
    procedure DevolverNF1Click(Sender: TObject);
    procedure RelatriodeprodutosmonofsicosNFe1Click(Sender: TObject);
    procedure DuplicatestaNFe1Click(Sender: TObject);
    procedure PrvisualizarDANFE1Click(Sender: TObject);
    procedure RelatriodePISCOFINSCupomFiscal1Click(Sender: TObject);
    procedure LimparRetornosda1Click(Sender: TObject);
    procedure ibDataSet16PFCPSTChange(Sender: TField);
    procedure ibDataSet16VBCFCPSTChange(Sender: TField);
    procedure odos1Click(Sender: TObject);
    procedure Sativos1Click(Sender: TObject);
    procedure Sinativos1Click(Sender: TObject);
    procedure ibDataSet18MUNICIPIOSetText(Sender: TField;
      const Text: String);
    procedure EEnviarcartadecorreoporemail1Click(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure ibDataSet7FilterRecord(DataSet: TDataSet;
      var Accept: Boolean);
    procedure ibDataSet7AfterScroll(DataSet: TDataSet);
    procedure FormDestroy(Sender: TObject);
    procedure ibDataSet15SAIDADChange(Sender: TField);
    procedure RelatriodevendasporclienteNFeCupom1Click(Sender: TObject);
    procedure ibDataSet16AfterOpen(DataSet: TDataSet);
    procedure IBDataSet2ENDERESetText(Sender: TField; const Text: String);
    procedure IBDataSet2COMPLESetText(Sender: TField; const Text: String);
    procedure IBDataSet2EMAILSetText(Sender: TField; const Text: String);
    procedure Oramentospendentes1Click(Sender: TObject);
    procedure Oramentosfinalizados1Click(Sender: TObject);
    procedure odos2Click(Sender: TObject);
    procedure ConversodeCFOP1Click(Sender: TObject);
    procedure ibdConversaoCFOPAfterDelete(DataSet: TDataSet);
    procedure ibdConversaoCFOPBeforeEdit(DataSet: TDataSet);
    procedure ibdConversaoCFOPBeforeInsert(DataSet: TDataSet);
    procedure ibdConversaoCFOPNewRecord(DataSet: TDataSet);
    procedure ibdConversaoCFOPCFOP_ORIGEMSetText(Sender: TField;
      const Text: String);
    procedure ConfiguraodeICMSeISS1Click(Sender: TObject);
    procedure ibdPerfilTributaAfterDelete(DataSet: TDataSet);
    procedure ibdPerfilTributaBeforeEdit(DataSet: TDataSet);
    procedure ibdPerfilTributaBeforeInsert(DataSet: TDataSet);
    procedure ibdPerfilTributaNewRecord(DataSet: TDataSet);
    procedure ibdPerfilTributaAfterPost(DataSet: TDataSet);
    procedure ibdPerfilTributaDESCRICAOSetText(Sender: TField;
      const Text: String);
    procedure ibdPerfilTributaBeforePost(DataSet: TDataSet);
    procedure ibdPerfilTributaBeforeDelete(DataSet: TDataSet);
    procedure ibDataSet4IDPERFILTRIBUTACAOChange(Sender: TField);
    procedure ibDataSet4TIPO_ITEMChange(Sender: TField);
    procedure EnviarOrcamentoPorEmail1Click(Sender: TObject);
    procedure ibDataSet37AfterOpen(DataSet: TDataSet);
    procedure IbdOrcamentObsAfterDelete(DataSet: TDataSet);
    procedure IbdOrcamentObsAfterPost(DataSet: TDataSet);
    procedure ibdParametroTributaAfterDelete(DataSet: TDataSet);
    procedure ibdParametroTributaBeforeEdit(DataSet: TDataSet);
    procedure ibdParametroTributaBeforeInsert(DataSet: TDataSet);
    procedure ibdParametroTributaNewRecord(DataSet: TDataSet);
    procedure Perfildetributao1Click(Sender: TObject);
    procedure Parmetrosdetributao1Click(Sender: TObject);
    procedure Configurarobservaofixa1Click(Sender: TObject);
    procedure DuplicarProdutoClick(Sender: TObject);
    procedure DuplicaOrcamentoClick(Sender: TObject);
    procedure ImprimirOrcamentoClick(Sender: TObject);
    procedure ExportarXML1Click(Sender: TObject);
    procedure InutilizaodeNFes1Click(Sender: TObject);
    procedure ImprimirOrdemdeServio2Click(Sender: TObject);
    procedure ConfigurarobservaoparaOS1Click(Sender: TObject);
    procedure ConfigurarobservaoparaRecibo1Click(Sender: TObject);
    procedure ibdSituacaoOSAfterDelete(DataSet: TDataSet);
    procedure ibdSituacaoOSAfterPost(DataSet: TDataSet);
    procedure ibdSituacaoOSBeforeInsert(DataSet: TDataSet);
    procedure ibdSituacaoOSNewRecord(DataSet: TDataSet);
    procedure ibdSituacaoOSBeforeEdit(DataSet: TDataSet);
    procedure Cadastrodesituaes1Click(Sender: TObject);
    procedure ibdSituacaoOSSITUACAOSetText(Sender: TField;
      const Text: String);
    procedure otalizadorgeraldevenda1Click(Sender: TObject);
    procedure DBGrid2KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure DBGrid3KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure DBGrid4KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure WebBrowser1DocumentComplete(ASender: TObject;
      const pDisp: IDispatch; const URL: OleVariant);
    procedure WebBrowser1NavigateComplete2(ASender: TObject;
      const pDisp: IDispatch; const URL: OleVariant);
    procedure DBGrid2DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGrid3DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGrid4DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure ibDataSet37BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet9BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet18BeforeDelete(DataSet: TDataSet);
    procedure ibDataSet21BeforeDelete(DataSet: TDataSet);
    procedure ibdParametroTributaBeforeDelete(DataSet: TDataSet);
    procedure ibdConversaoCFOPBeforeDelete(DataSet: TDataSet);
    procedure ibDataSet11BeforeDelete(DataSet: TDataSet);
    procedure miTermoUsoVendasClick(Sender: TObject);
    procedure miTermoUsoComprasClick(Sender: TObject);
    procedure miTermoUsoOSClick(Sender: TObject);
    procedure miTermoUsoCaixaClick(Sender: TObject);
    procedure miTermoUsoCliforClick(Sender: TObject);
    procedure miTermoUsoEstoqueClick(Sender: TObject);
    procedure miExcluirOSClick(Sender: TObject);
    procedure miTermoUsoReceberClick(Sender: TObject);
    procedure miTermoUsoVendedorClick(Sender: TObject);
    procedure miTermoUsoPlanoContasClick(Sender: TObject);
    procedure miTermoUsoICMClick(Sender: TObject);
    procedure miTermoUsoPagarClick(Sender: TObject);
    procedure miTermoUsoTransportClick(Sender: TObject);
    procedure miTermoUsoConvenioClick(Sender: TObject);
    procedure Relatrios5Click(Sender: TObject);
    procedure miTermoUsoBancoClick(Sender: TObject);
    procedure miTermoUsoConvCFOPClick(Sender: TObject);
    procedure miTermoUsoPerfilTribClick(Sender: TObject);
    procedure miTermoUsoParamTributaClick(Sender: TObject);
    procedure miTermoUsoSituacaoOSClick(Sender: TObject);
    procedure miTermoUsoServicoClick(Sender: TObject);
    procedure miTermoUsoOrcamentoClick(Sender: TObject);
    procedure miTermoUsoGrupoClick(Sender: TObject);
    procedure miRelatoriosCliforClick(Sender: TObject);
    procedure miRelatoriosCaixaClick(Sender: TObject);
    procedure MenuItem140Click(Sender: TObject);
    {    procedure EscondeBarra(Visivel: Boolean);}


  private
    FbDuplicandoProd: Boolean;
    FbImportandoXML: Boolean;
    { Private declarations }
    // cTotalvFCPST: Currency; // Sandro Silva 2023-04-11
    // function ImportaNF(pP1: boolean; sP1: String):Boolean;
    function PermiteValidarSchema(DataSet: TDataSet): Boolean;
    procedure ValidarSchemaSefaz(NFeXml: String);
    procedure VerificarShemaXsd(NFeXml: String; bValidarNaSefaz: Boolean);
    procedure EscolheOBancoParaGerarBoletoEEnviarEmail(Sender: TObject);
    procedure CalculaFCPSTAoIncluirProdutoDevolucao;
    procedure EnviarConsultaImprimirDANFE;
    function RetornarWhereAtivoEstoqueCompra: String;
    procedure LimparColunasItemCompra;
    procedure VerificaItensInativos;
    procedure SelecionaMunicipio(vEstado, vText: string; vCampoCidade: TIBStringField; Valida : Boolean = True);
    //function RetornarSQLEstoqueOrcamentos: String; Mauricio Parizotto 2023-10-16 movido para funcoes retaguarda
    procedure EnviarEmailCCe(AcXML: String);
    function getEnviarDanfePorEmail: String;
    function getZiparXML: String;
    function ValidaLimiteDeEmissaoDeVenda(dtBaseVerificar: TDate): Boolean;
    procedure HintTotalNotaVenda(fRetencao : Real);
    function TestarSaldoEstoqueDisponivelNota(AnQtdeInformada: Double; CodProd : string): Boolean;
    procedure VerificaSaldoEstoqueDispItemNota(AnQtdeInformada: Double);
    procedure DefineQuantidadeSaldoDisponivelNota;
    procedure DefinirCaptionHomologacaoPopUpMenuDocs;
    procedure DefineLayoutFiltro;
    function RetornarTotalQuantidadeItem(AcITem: String): Currency;
    function RetornarSaldoDisponivelItemNota(AcItem: String): Currency;
    procedure LimparLinhaItemSemItem;
    procedure LimpaCamposItensNota;
    procedure DefineCaptionReceberPagar;
    function TestarPodeExcluirOrcamento: Boolean;
    function TestarPodeExcluirOS: Boolean;
    procedure ExcluirOrcamento;
    procedure ExcluirOS;
    procedure VerificaAlteracaoPerfil;
    procedure ChamarTelaXMLContab;
    function MensagemPortalConsultaCNPJCPF: Integer;
    procedure ImprimeOrcamento;
    function getUsuarioLogado: String;
    procedure SalvaXMLNFSaida(AcCaminho: String = '');
    function TestaNFSaidaFaturada: Boolean;
    procedure FechaModulos;
    procedure EscolheOclifor(Sender: TObject);
    procedure FormShowModulos(Mais1Ini : tIniFile; var sSerieNFSelecionada : string);
    function SomenteLeitura: Boolean;
    procedure MarcaColunaOrderBy;
    procedure RegistraExclusaoRegistro(AoDataSet: TDataSet; AcModulo: String = ''; AcHistoricoExtra: String = '');
    function RetornarHistoricoPorModulo: String;
    function RetornaTipoModulo: tModulosCommerce;
    procedure AbreHelpTermoUso;
    function MovimentaEstoqueAlteracaBloqueados: Boolean;
    procedure ExportarXMLNF;
    procedure CarregarContasReceberMarcadas;
    procedure CarregarContasPagarMarcadas;
  public
    // Public declarations

    oArqConfiguracao: TArquivosDAT; // Sandro Silva 2023-10-02


    fSaldoVetorCaixa : array[0..9999999] of real;
    fSaldoVetorBanco : array[0..9999999] of real;

    StatusTrocaPerfil : String; // Mauricio Parizotto 2023-09-26

    //
    // NFe
    //
    fNFe : WideString;
    bProximas : Boolean;
    bContingencia : Boolean;
    bFirst : Boolean;
    sTextoDoAcordo, sFormatoDoDanfe, sCNPJContabilidade: String;
    //
    sFuso     : String;
    sSistema  : String;
    sAjuda    : String;
    sMostra   : String;
    sModulo   : String;
    sTitulo   : String;
    sRPS      : String;
    sProcura  : String;
    sPAgas    : String;
    TecAte    : String;
    sProximo  : String;
    sProximoID  : Integer; //Mauricio Parizotto 2023-08-30
    sNSU      : String;
    sRegistro : String;
    sMaxReg   : String;
    sColuna   : String;
    sLinha    : String;
    sOrderBy  : String;
    sWhere    : String;
    sSelect   : String;
    //
    // Variaveis usadas para saber se deve converter unidades de medida na nota de compra
    //
    ProdutoOld : TProdutoOld;
    bMudei : Boolean;
    //
    //  necessrio saber o Nome anterior no caso de
    // alterar o nome. Se o nome for alterado deve ser
    // atualizado o arquivo VENDAS e o arquivo RECEBER
    //
    sAproveitamento, sNumeroAnteriorGrupo, sNomeAnteriorDoGrupo, sNomeAnterior, sNomeAnterior14, sNumeroAnterior, sNumeroAnterior14, sFornecedorAntigo : String;
    //
    fFCPRetido, fMutado, fMutado2, fMutado3 : Real;
    //
    fQuantidadeAnterior : Real;
    fPrecoAnterior      : Real;
    fTotalDoRecibo      : Real;
    //
    sReciboProvenienteDe : String;
    sReciboRecebemosDe   : String;
    sModuloAnterior      : String;
    //
    ArquivoAberto: TDataSet;
    TabelaAberta: TibDataSet;
    DataSourceAtual : TDataSource;
    ItensdaNota : Integer;
    iCampos: Integer;
    iFoco  : Integer;
    iRegistros : Integer;
    bChave : Boolean;
    bChaveGrade : boolean;
    bFlag  : Boolean;
    bCalcula : Boolean;
    bSoLeitura : Boolean;
    bChaveRecalculaBase : Boolean;
    bFabrica : Boolean;
    iChave : Integer;
    bNaoCalculaSaldo : Boolean;
    bEstaSendoUsado : Boolean;
    //
    dBancoEmissaoAnterior : TDateTime;
    dBancoPredataAnterior : TDateTime;
    dBancoCompensAnterior : TDateTime;
    {  necessrio gravar esta varivel antes calcular o saldo  }
    { do caixa no caso de alterar a data para uma data anterior }
    fValorAnterior : Real;
    //
    iKey : Integer;

    {Sandro Silva 2023-07-05 inicio}
    slPickListBandeira: TStringList;
    slPickListFormaDePagamento: TStringList;
    slPickListBanco: TStringList;
    slPickListInstituicao: TStringList;
    {Sandro Silva 2023-07-05 fim}

    {Dailon 2023-08-22 inicio}
    bDescontaICMSDeso: Boolean;
    {Dailon 2023-08-22 fim}

    procedure RefreshDados;
    procedure TotalizaItensCompra;
    procedure CalculaTotalNota;
    function _ecf65_ValidaGtinNFCe(sEan: String): Boolean;
    // Sandro Silva 2023-05-04 function FormatFloatXML(dValor: Double; iPrecisao: Integer = 2): String;
    function AliqICMdoCliente16: double;
    function Formata2CasasDecimais(Valor: Double): Currency;
    procedure SelecionaAliquotaIss(var IBQuery: TIBQuery; Operacao: String = '');
    function CriaIBQuery(IBTRANSACTION: TIBTransaction): TIBQuery; // Sandro Silva 2022-11-10
    function CaracteresParaSequencialDocumentos: String;
    function ObtemNumeroDocumentoReceber(sNumeroNF: String; TipoRPS: String;
      iSequencialParcela: Integer): String;
    function UltimaParcelaReceberDaNF(sNumeroNF: String): String; // Sandro Silva 2023-01-06
    function CorrigeCustoCompraNaVenda(dCustoCompra: Double): Double; // Sandro Silva 2023-04-26
    property sEnviarDanfePorEmail: String read getEnviarDanfePorEmail;
    property sZiparXML: String read getZiparXML;
    procedure HintTotalNotaCompra;
    function TestarLimiteDisponivel(AbMostraMsg: Boolean = True): Boolean;
    function GetMensagemCertificado(vLocal:string=''): string;
    function TestarNFeHomologacao: Boolean;
    function TestarNFSeHomologacao: Boolean;
    function RetornarAliquotaICM(AcUF: String): Currency;
    procedure AtualizarListaItensAuxiliar;
    procedure AuditaAlteracaoEstoqueManual;
    function TestarClienteExiste(AcTexto: String): Boolean;    
    function TestarProdutoExiste(AcTexto: String): Boolean;
    property UsuarioLogado: String read getUsuarioLogado;
    procedure SetDataSetCadastros(CaminhoIni: String);
    function IniFileUsuarioLogado: String;
  end;

  function TestarNatOperacaoMovEstoque: Boolean;
  function VerificaSeEstaSendoUsado(bP1:Boolean): boolean;
//  Function Valida_Campo(ibDataSet_P:TibDataSet; Text:String; Indice,Mensagem:String):Boolean;
  function Valida_Campo(Arquivo: String; Text: String;
    Indice, Mensagem: String):Boolean;
  function ObservacaoProduto(pP1:Boolean):Boolean;
  function ObservacaoOperacao(pP1:Boolean):Boolean;
  function Observacao2(pP1:Boolean):Boolean;
  function JaTem(p1:tibDataSet; p2:tField; p3: boolean):Boolean;
  function CriaJpg(sP1: String) :Boolean;
  function MostraLabels(tSp1: tImage; tSp2: TLabel): Boolean;
  function TraduzSql(P1: String;P2 :Boolean; AoDataSet: TIBDataSet = nil): String;
  function ConfiguraNFE : Boolean;
//  function ConsultaProcesso(sP1:String): boolean;
  function BaixaEstoqueDaNFeAutorizada(sPp1: String): boolean;
  function LoadXmlDestinatarioSaida(aChaveNFe: String): WideString;
  function LoadXmlDestinatarioEntrada(aChaveNFe: String): WideString;
  function RetornaValorDaTagNoCampo(sTag: String; sObs: String): String;
  function RetornaValorDaTagNoCampoCRLF(sTag: String; sObs: String): String;
  function Manifesto(iP1: integer) : Boolean;
  function ProdutoValidoParaMarketplace(bP1 : Boolean): String;
  
var
  Form7: TForm7;
  
implementation

uses Unit17, Unit12, Unit20, Unit21, Unit22, Unit23, Unit25, Mais,
  Unit27, Mais3, Unit19, Unit4, Unit30, Unit13, Unit32, Unit33, Unit34,
  Unit37, Unit38, Unit39, Unit40, Unit41, Unit43, Unit2,
  unit24, uExportaXML, Unit15, SelecionaCertificado, Unit6, Unit36, Unit26,
  Unit29, Unit48
  , ugeraxmlnfe
  , uFuncoesFiscais
  , uTransmiteNFSe
  , uImportaNFe
  , uFuncoesBancoDados
  , uClientesFornecedores
  , uRetornaCaptionEmailPopUpDocs
  , uIRetornaCaptionEmailPopUpDocs
  , uItensInativosImpXMLEntrada
  , uTextoEmailFactory
  , uRetornaLimiteDisponivel
  , uIRetornaLimiteDisponivel
  , uFrmParcelas
  , uListaCnaes
  , uAssinaturaDigital
// Sandro Silva 2023-10-02  , uArquivosDAT
  , uNFSeINI
  , uAtualizaBancoDados
  , uAtualizaTributacaoPerfilTrib
  , uSmallResourceString
  , uChamaRelatorioCommerceFactory
  , uImpressaoOrcamento
  , uFrenteSections
  , uFrmParametroTributacao
  , uRelatorioResumoVendas
  , uDuplicaOrcamento
  , uDuplicaProduto
  , uImportaOrcamento
  , uImportaOrdemServico
  , uDialogs
  , uFrmProdutosDevolucao
  , uOrdemServico
  , uFrmPerfilTributacao
  , uFrmNaturezaOperacao
  , uFrmSituacaoOS
  , uRelatorioVendasNotaFiscal
  , uDrawCellGridModulos
  , uEmail
  , ufrmFichaCadastros
  , uFuncaoMD5
  , uDesenhaBoleto
  , ufrmRelatorioProdMonofasicoCupom
  , ufrmRelatorioProdMonofasicoNota
  , uSistema
  ;

{$R *.DFM}

function ExtraiNodeXml( sXML : String ; sNode : String ) : String ;
var
  inicio : Integer;
  fim : Integer;
begin
  inicio := pos( '<' + snode, sXML );
  fim := pos( '</' + snode, sXML ) + Length( '</' + snode + '>' ) - inicio;
  Result := Copy( sXML, inicio, fim );
end;

function BuscaNumeroNFSe(bP1: Boolean) : Boolean;
  function NumeroNFSeNaoImportadoDoRetorno: Boolean;
  begin
    Result := False;
    if pChar(Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)) = '000000000' then
      Result := True;
  end;
begin
  try
    // Sandro Silva 2022-10-06 if pChar(Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)) = '000000000' then
    if NumeroNFSeNaoImportadoDoRetorno then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
        Form7.ibDataset15.Edit;
      if RetornaValorDaTagNoCampo('numero_nfse', Form7.ibDAtaSet15RECIBOXML.AsString)  <> '' then
        Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('numero_nfse',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('serie_nfse',Form7.ibDAtaSet15RECIBOXML.AsString));

      {Sandro Silva 2022-10-06 inicio}
      if NumeroNFSeNaoImportadoDoRetorno then
      begin
        if RetornaValorDaTagNoCampo('tc:Numero', Form7.ibDAtaSet15RECIBOXML.AsString)  <> '' then
          Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('tc:Numero',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('tc:Serie',Form7.ibDAtaSet15RECIBOXML.AsString));
      end;
      {Sandro Silva 2022-10-06 fim}

      // Sandro Silva 2022-10-06 if pChar(Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)) = '000000000' then
      if NumeroNFSeNaoImportadoDoRetorno then
      begin
        if AllTrim(RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString)) <> '' then
        begin
          Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := AllTrim(RetornaValorDaTagNoCampo('NumeroDaNFSe',Form7.ibDAtaSet15RECIBOXML.AsString))+'/'+AllTrim(RetornaValorDaTagNoCampo('SerieDoRPS',Form7.ibDAtaSet15RECIBOXML.AsString));
        end else
        begin
          Form7.ibDAtaSet15NFEPROTOCOLO.AsString  := Limpanumero(Copy(Form7.ibDAtaSet15RECIBOXML.AsString,Pos('"numeroNFSe" :',Form7.ibDAtaSet15RECIBOXML.AsString)+16,10)) + '/1';
        end;
      end;

      Form7.ibDAtaSet15.Post;
      Form7.ibDAtaSet15.Edit;
    end;
  except end;

  Result := True;
end;

function CancelarNFSe(sP1: String) : Boolean;
begin
  //
  try
    //
    Form7.ibDAtaSet15.Edit;
    Form7.ibDAtaSet15RECIBOXML.AsString := sP1; // Calcelamento da NFSE
    Form7.ibDataSet15STATUS.AsString    := 'NFS-e cancelada';
    Form7.ibDataSet15EMITIDA.AsString   := 'X';
    //
    Form7.ibDAtaSet15.Post;
    //
    // Receber
    //
    if Form7.sModulo = 'VENDA' then
    begin
      //
      Form7.ibDataSet7.First;
      //
      if Copy(Form7.ibDataSet15STATUS.AsString,1,15) = 'NFS-e cancelada' then
      begin
        //
        while not Form7.ibDataSet7.Eof do
        begin
          //
          if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
          begin
            if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
            begin
              Form7.ibDataSet7.Edit;
              Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
            end else
            begin
              Form7.ibDataSet7.Edit;
              Form7.ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
            end;
            //
            Form7.ibDataSet7ATIVO.AsString := '1';
            Form7.ibDataSet7.Post;
            Form7.ibDataSet7.Next;
            //
          end else
          begin
            Form7.ibDataSet7.Next;
          end;
          //
        end;
        //
      end;
    end;
    //
    // CAIXA
    //
    ApagaIntegracaoComOCaixa(True);
    //
    // Relaciona os clientes com o arquivo de vendas
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    //
    // Data da ltima venda para o cliente
    //
    try
      Form7.ibDataSet2.Edit;
      Form7.ibDataSet2ULTIMACO.AsString := '';
      Form7.ibDataSet2.Post;
    except end;
    //
    AgendaCommit(True);
    Commitatudo(True); // Cancelamento NFS-e
    AbreArquivos(False);
    //
    Form7.Close;
    Form7.Show;
    //
  except end;
  //
  Result := True;
  //
end;


function ProdutoValidoParaMarketplace(bP1 : Boolean): String;
begin
  Result := '';
  try
    {Sandro Silva 2022-10-31 inicio
    //Alterado smallhub.com.br para tratar quando o marketplace exigir EAN
    if (ValidaEAN13(LimpaNumero(Form7.IBDataSet4.FieldByName('REFERENCIA').AsString)) = False) then // No tem mais EAN
      Result := Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': EAN invlido';
    }

    if (Length(LimpaNumero(Form7.IBDataSet4.FieldByName('CF').AsString)) <> 8) then // No tem NCM com 8 caracteres numricos
    begin
      if Trim(Result) <> '' then
        Result := Result + #13;
      Result := Result + Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': NCM invlido';
    end;

    if (Trim(Form7.IBDataSet4.FieldByName('NOME').AsString) = '') then
    begin
      if Trim(Result) <> '' then
        Result := Result + #13;
      Result := Result + Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': Grupo de estoque no informado';
    end;
  except
    Result := Form7.IBDataSet4.FieldByName('CODIGO').AsString + '-' + Form7.IBDataSet4.FieldByName('DESCRICAO').AsString + ': No pode ser validado';
  end;

end;

function Manifesto(iP1: integer) : Boolean;
var
  sJustificativa, sRetorno : String;
begin

  //
  // informar o tipo do Evento:
  //
  // Tipo do evento que deseja enviar:
  // 1: Confirmao da operao.
  // 2: Cincia da operao.
  // 3: Desconhecimento da operao.
  // 4: Operao no Realizada.
  //
  if Form7.spdNFe.Ambiente = spdNFeType.akProducao then
  begin
    //
    try
      //
      ConfiguraNfe;
      Form7.spdNFe.TimeOut                      := 60000*9; // A nota j esta no servidor mas no retorna aumentei o tempo para resolver isso
      //
      if iP1 = 4 then
      begin
        sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',chr(10)+'Informe uma justificativa (min. 15 caracteres)'+chr(10)+chr(10), ''));
      end else
      begin
        sJustificativa := '';
      end;
      //
      sRetorno       := Form7.spdNFe.EnviarManifestacaoDestinatario(iP1,pchar(Form7.ibDataSet24NFEID.AsString),pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)),sJustificativa,FormatDateTime('yyyy-mm-dd"T"hh:nn:"00"',Now),1,Form7.sFuso,'91');
      //
      if (Pos('<tpEvento>2102',sRetorno)<>0) then
      begin
        //
        // Cdigo do evento:
        //
        // 210200  Confirmao da Operao
        // 210210  Cincia da Operao
        // 210220  Desconhecimento da Operao
        // 210240  Operao no Realizada
        //
        if (Pos('<xMotivo>Rejeicao:',sRetorno)<>0) and (Pos('<cStat>573',sRetorno)=0)then // Retornou rejeio e no  rejeio por duplicidade
        begin
        end else
        begin
          Form7.ibDataSet24.Edit;
          Form7.ibDataSet24MDESTINXML.AsString := sRetorno;
          Form7.ibDataSet24.Post;
        end;
      end else
      begin
      end;
    except end;
  end;
  //
  Result := True;
end;

function xmlNodeXml(sXML: String; sNode: String): String;
//Sandro Silva 2012-02-08 inicio
// Extrai os elementos do xml
var
  XMLDOM: IXMLDOMDocument;
  iNode: Integer;
  xNodes: IXMLDOMNodeList;
begin
  XMLDOM := CoDOMDocument.Create;
  XMLDOM.loadXML(sXML);
  Result := '';
  xNodes := XMLDOM.selectNodes(sNode);
  for iNode := 0 to xNodes.length -1 do
  begin
    Result := xNodes.item[iNode].xml;
  end;
  XMLDOM := nil;
end;


function RecuperaXML(sP1: Boolean) : Boolean;
var
  sRetorno, wsNFeAssinada : String;
begin
  if not FileExists( Form7.spdNFe.DiretorioXmlDestinatario + pChar(Form7.ibDataSet15NFEID.AsString) + '-nfe.xml') then
  begin
    sRetorno       := Form7.spdNFe.ConsultarNF(Alltrim(Form7.ibDataSet15NFEID.AsString));
    wsNFeAssinada := Form7.ibDataSet15NFEXML.AsString;

    if (Pos('<cStat>100</cStat>',sRetorno) <> 0) or (Pos('<cStat>150</cStat>',sRetorno) <> 0) then // 100|Autorizado o uso da NF-e ou 150|Autorizado o uso da NF-e, autorizao fora de prazo // Sandro Silva 2018-08-10
    begin
      // Se foi autorizada faz a montagem do xml assinado com os dados da autorizao
      if xmlNodeXML(sRetorno, '//protNFe') <> '' then
      begin
        // conferir o digestvalue do retorno com a nota
        if xmlNodeValue(sRetorno, '//infProt/digVal') = xmlNodeValue(wsNFeAssinada, '//DigestValue') then
        begin
          sRetorno := '<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" versao="' + xmlNodeValue(wsNFeAssinada, '//infNFe/@versao') + '">' + wsNFeAssinada + xmlNodeXML(sRetorno, '//protNFe') + '</nfeProc>';

          with TStringList.Create do
          begin
            Text := sRetorno;
            SaveToFile(Form7.spdNFe.DiretorioXmlDestinatario + '\' + Alltrim(Form7.ibDataSet15NFEID.AsString) + '-nfe.xml');
            Free;
          end;
        end;
      end;
    end;
  end;

  if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then 
    Form7.ibDataset15.Edit;
  Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
 
  if (Pos('xMotivo',Form7.ibDataSet15NFEXML.AsString) <> 0) or (Pos('nProt',Form7.ibDataSet15NFEXML.AsString) <> 0) then
  begin
    Form7.ibDataSet15STATUS.AsString       := RetornaValorDaTagNoCampo('xMotivo',Form7.ibDataSet15NFEXML.AsString);
    Form7.ibDataSet15NFEPROTOCOLO.AsString := RetornaValorDaTagNoCampo('nProt',Form7.ibDataSet15NFEXML.AsString);
  end;

  Form7.ibDataSet15.Post;

  Result := True;
end;

{Sandro Silva 2022-09-12 inicio
function FormatFloatXML(dValor: Double; iPrecisao: Integer = 2): String;
// Sandro Silva 2015-12-10 Formata valor float com as casas decimais para usar nos elementos do xml da nfce
// Parmetros:
// dValor: Valor a ser formatado
// iPrecisao: Quantidade de casas decimais resultante no valor formatado. Por default formata com 2 casas. Ex.: 2 casas = 0,00; 3 casas = 0,000
var
  sMascara: String;
begin
  sMascara := '##0.' + DupeString('0', iPrecisao);
  Result := StrTran(Alltrim(FormatFloat(sMascara, dValor)), ',', '.');
end;
}

function RetornaValorDaTagNoCampo(sTag: String; sObs: String): String;
// Extrai o valor do parmetro configurado
// Parmetros:
// sTag: Nome da tag parmetro
// sObs: Texto onde est a tag com a configurao
// Exemplo: Obs= <descANP>GLP</descANP> retorna: GLP
//          Obs= <descANP>GLP<descANP> retorna: GLP
var
  sTextoTag: String;
begin
  Result := '';
  sObs := Trim(sObs);
  sObs := StringReplace(sObs, #$D#$A, '', [rfReplaceAll]); // Eliminar quebras de linha geradas no cadastro de produto pelo campo blob
  if AnsiContainsText(sObs, '<' + sTag + '>') then
  begin
    sTextoTag := Copy(sObs, Pos('<' + sTag + '>', sObs) + Length('<' + sTag + '>'), Length(sObs));
    sTextoTag := StringReplace(STextoTag, '</' + sTag, '<' + sTag, []);
    Result := AllTrim(Copy(sTextoTag, 1, Pos('<' + sTag + '>', STextoTag) -1));
  end;
end;

function RetornaValorDaTagNoCampoCRLF(sTag: String; sObs: String): String;
// Extrai o valor do parmetro configurado
// Parmetros:
// sTag: Nome da tag parmetro
// sObs: Texto onde est a tag com a configurao
// Exemplo: Obs= <descANP>GLP</descANP> retorna: GLP
//          Obs= <descANP>GLP<descANP> retorna: GLP
var
  sTextoTag: String;
begin
  Result := '';
  sObs := Trim(sObs);
//  sObs := StringReplace(sObs, #$D#$A, '', [rfReplaceAll]); // Eliminar quebras de linha geradas no cadastro de produto pelo campo blob
  if AnsiContainsText(sObs, '<' + sTag + '>') then
  begin
    sTextoTag := Copy(sObs, Pos('<' + sTag + '>', sObs) + Length('<' + sTag + '>'), Length(sObs));
    sTextoTag := StringReplace(STextoTag, '</' + sTag, '<' + sTag, []);
    Result := AllTrim(Copy(sTextoTag, 1, Pos('<' + sTag + '>', STextoTag) -1));
  end;
end;


function ItemRejeicao(sRejeicao: String; sXml: String): String;
//Trata mensagens de erro do tipo: [nItem:1] Rejeicao: CFOP nao permitido para o CSOSN informado
// Parmetros:
// sRejeicao: Texto da rejeio retornado pelo servidor
// sXML: contedo xml da nf-e/nfc-e
var
  i: Integer;
begin
  if Pos('nItem', sRejeicao) > 0 then
  begin
    for i := Pos('nItem', sRejeicao) + Length('nItem:') to Length(sRejeicao) do
    begin
      if Copy(sRejeicao, i , 1) = ']' then
        Break;
      Result := Result + Copy(sRejeicao, i , 1);
    end;
  end;
  Result := Trim(Result);
  if Result <> '' then
  begin
    Result := xmlNodeValue(sXML, '//det[@nItem="' + Result + '"]/prod/cProd') + '-' + xmlNodeValue(sXML, '//det[@nItem="' + Result + '"]/prod/xProd');
  end;
end;

function CriaIBTransaction(IBDATABASE: TIBDatabase): TIBTransaction;
//Sandro Silva 2011-04-12 inicio
//Cria um objeto TIBTransaction
begin
  try
    Result := TIBTransaction.Create(Application);
    Result.Params.Add('read_committed');
    Result.Params.Add('rec_version');
    Result.Params.Add('nowait');
    Result.DefaultDatabase := IBDATABASE;
  except
    on E: Exception do
    begin
      //ShowMessage(E.Message);Mauricio Parizotto 2023-10-25
      MensagemSistema(E.Message,msgErro);
      Result := nil;
    end
  end;
end;


function TForm7.CriaIBQuery(IBTRANSACTION: TIBTransaction): TIBQuery;
//Sandro Silva 2011-04-12 inicio
//Cria um objeto TIBQuery
begin
  try
    Result := TIBQuery.Create(Application);
    Result.Database    := IBTRANSACTION.DefaultDataBase;
    Result.Transaction := IBTRANSACTION;
    Result.BufferChunks := 100; // 2014-02-26 Evitar Erro de out of memory
  except
    on E: Exception do
    begin
      //ShowMessage(E.Message); Mauricio Parizotto 2023-10-25
      MensagemSistema(e.Message,msgErro);
      Result := nil;
    end
  end;
end;


function DownloadNFeEmitida(sP1: String): Boolean;
var
  lXMLDocZip: IXMLDOMDocument;
  NodeZip: IXMLDOMNodeList;
  i: Integer;
  slXMLDescom: TStringList;
begin
  //
  try
    //
    if Pos('<cStat>653</cStat>',sP1) <> 0  then // NF-e Cancelada
    begin
      //
      if not (Form7.ibDataset24.State in ([dsEdit, dsInsert])) then Form7.ibDataset24.Edit;
      Form7.ibDataSet24EMITIDA.AsString    := 'X';
      //
    end;
    //
    // Seleciona os elementos contendo xml zipados
    slXMLDescom := TStringList.Create; // Armazena o xml descompactado para extrair o id a ser baixado
    lXMLDocZip  := CoDOMDocument.Create; // No consigo fazer lXMLDocZip.Free
    //
    lXMLDocZip.loadXML(sP1);
    NodeZip     := lXMLDocZip.selectNodes('//retDistDFeInt/loteDistDFeInt/docZip');
    //
    for i := 0 to NodeZip.length - 1 do // Passa por todos os xml zipados
    begin
      try
        slXMLDescom.Clear;
        slXMLDescom.text := Form7.spdNFe.DescompactarXMLZip(NodeZip.item[i].text); // Descompacta xml zipado
        //
        if Pos('nfeProc',slXMLDescom.Text) <> 0 then
        begin
          if (Pos('<cStat>100</cStat>',slXMLDescom.Text)<>0)  or (Pos('<cStat>150</cStat>',slXMLDescom.Text)<>0) then
          begin
            try
              if Pos(Form7.ibDataset24NFEID.AsString,slXMLDescom.Text) <> 0 then
              begin
                // Converter de ANSITOUTF8
                // Tira o cariage return (CR) e Line Fid (LF)
                if not (Form7.ibDataset24.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset24.Edit;
                Form7.ibDataset24NFEXML.AsString := AnsiToUTF8(slXMLDescom.text);  // Grava o XML descompactado na tabela compras
                Form7.ibDataset24.Post;
                // se liberar esta linha duplicava os itens Form7.ImportaNF(True,Form7.ibDataset24NFEXML.AsString); // Depois que o XML esta gravado importa os itens
              end;
            except end;
          end;
        end;
      except
        on E: Exception do
        begin
          //ShowMessage('Erro ao descompactar XML: '+E.Message); Mauricio Parizotto 2023-10-25
          MensagemSistema('Erro ao descompactar XML: '+E.Message,msgErro);
        end
      end;
    end;
    
    slXMLDescom.Free;
    lXMLDocZip := nil;
  except
    on E: Exception do
    begin
      //ShowMessage('Erro 2503: '+E.Message); Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro 2503: '+E.Message,msgErro);
    end
  end;
  
  Result := True;
end;


function DownloadListaDeNFesEmitidas(sP1: String): Boolean;
var
  lXMLDocZip: IXMLDOMDocument;
  NodeZip: IXMLDOMNodeList;
  i: Integer;
  slXMLDescom: TStringList;
  Mais1Ini : tIniFile;
begin
  //
  Form7.ibDataSet24.DisableControls;
  Form7.ibDataSet23.DisableControls; // Sandro Silva 2023-12-04
  //LogRetaguarda('Form7.ibDataSet24.DisableControls;: 3026'); // Sandro Silva 2023-11-27

  try
    //
    if Pos('<cStat>137</cStat>',sP1) <> 0  then // No encontrou nenhuma nota
    begin
      //
      // Bloquear por uma hora
      //
      Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
      Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao',TimeToStr(Time));
      Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
      Mais1Ini.Free;
      //
    end else
    begin
      //
      if xmlNodeValue(sP1, '//retDistDFeInt/ultNSU') <> '' then
      begin
        //
        // Liberar o bloquear por uma hora
        //
        Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
        Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao','00:00:00');
        Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
        Mais1Ini.Free;
        //
        Form1.ibQuery2.Close;
        Form1.ibQuery2.SQL.Clear;
        Form1.ibQuery2.SQL.Add('select gen_id(G_NSU_DOWNLOAD_XML,0) from rdb$database');
        Form1.ibQuery2.Open;
        //
        if StrToInt(Form1.ibQuery2.FieldByname('GEN_ID').AsString) = 0 then
        begin
          //
          // se G_NSU_DOWNLOAD_XML for igual a 0 entao grava a max nsu para no mexer no passado
          // ltimo NSU que tem disponvel para baixar <maxNSU>000000000010099</maxNSU>
          //
          try
            //
            if StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/maxNSU'))) < 50 then
            begin
              Form1.ibQuery2.Close;
              Form1.ibQuery2.SQL.Clear;
              Form1.ibQuery2.SQL.Add('set generator G_NSU_DOWNLOAD_XML to 2');
              Form1.ibQuery2.ExecSQL;
            end else
            begin
              Form1.ibQuery2.Close;
              Form1.ibQuery2.SQL.Clear;
              Form1.ibQuery2.SQL.Add('set generator G_NSU_DOWNLOAD_XML to '+IntToStr( StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/maxNSU')))-50 ));
              Form1.ibQuery2.ExecSQL;
            end;
            //
          except
            on E: Exception do
            begin
              //ShowMessage('Erro 2397: '+E.Message); Mauricio Parizotto 2023-10-25
              MensagemSistema('Erro 2397: '+E.Message,msgErro);
            end
          end;

          {Sandro Silva 2023-11-29 inicio
          /// No faz sentido limpar o xml recebido quando
          if Form1.DisponivelSomenteParaNos = False then //testando se precisa mesmo limpar a varivel para no importar a notas iniciais, quando CNPJ  novo, empresa nova constituda
            sP1 := '';
          }
        end else
        begin
          if StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/ultNSU'))) > 0 then // No pode zerar - Estava voltando zero quando consumo indevido
          begin
            if Pos('<cStat>656</cStat>',sP1) = 0 then // No grava nada quando  consumo indevido
            begin
              Form1.ibQuery2.Close;
              Form1.ibQuery2.SQL.Clear;
              Form1.ibQuery2.SQL.Add('set generator G_NSU_DOWNLOAD_XML to '+IntToStr(StrToInt(LimpaNumero(xmlNodeValue(sP1, '//retDistDFeInt/ultNSU')))));
              Form1.ibQuery2.ExecSQL;
            end;
          end;
        end;
      end;

      // Seleciona os elementos contendo xml zipados
      slXMLDescom := TStringList.Create; // Armazena o xml descompactado para extrair o id a ser baixado
      lXMLDocZip  := CoDOMDocument.Create;

      //LogRetaguarda('3107 com docZip ' + sP1);
      
      lXMLDocZip.loadXML(sP1);
      NodeZip     := lXMLDocZip.selectNodes('//retDistDFeInt/loteDistDFeInt/docZip');

      for i := 0 to NodeZip.length - 1 do // Passa por todos os xml zipados
      begin
        try
          slXMLDescom.Clear;
          slXMLDescom.text := Form7.spdNFe.DescompactarXMLZip(NodeZip.item[i].text); // Descompacta xml zipado

          if xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe') <> '' then  // Valida se  a nota resumida
          begin
            // Salvando dados para realizar o manifesto
            try
              Form7.IBQuery99.Close;
              Form7.IBQuery99.SQL.Clear;
              Form7.IBQuery99.SQL.Add('select NFEID, NUMERONF from COMPRAS where NFEID='+QuotedStr(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')))+' ');
              Form7.IBQuery99.Open;

              if AllTrim(Form7.iBQuery99.FieldByName('NFEID').AsString) = '' then
              begin
                Form7.ibDataSet24.Append;
                Form7.ibDataSet24NUMERONF.AsString   := Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')),26,9)+Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')),23,3);
                Form7.ibDataSet24FORNECEDOR.AsString := pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/xNome'));
                Form7.ibDataSet24NFEID.AsString      := pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/chNFe')); // COVID19
                Form7.ibDataSet24TOTAL.AsFloat       := StrToFloat(StrTran(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/vNF')),'.',','));
                Form7.ibDataSet24EMISSAO.AsDateTime  := StrToDate(Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/dhEmi')),9,2)+'/'+Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/dhEmi')),6,2)+'/'+Copy(pChar(xmlNodeValue(slXMLDescom.Text, '//resNFe/dhEmi')),1,4));
                Form7.ibDataSet24.Post;
              end;
            except
              on E: Exception do
              begin
                //ShowMessage('Erro 2491 ao baixar lista de NF-es emitidas: '+E.Message); Mauricio Parizotto 2023-10-25
                MensagemSistema('Erro 2491 ao baixar lista de NF-es emitidas: '+E.Message,msgErro);
              end
            end;
          end else
          begin
            // Salvando o xml
            Form7.ibDataSet24.Close;
            Form7.ibDataSet24.SelectSQL.Clear;
            Form7.ibDataSet24.SelectSQL.Add('select * from COMPRAS where NFEID = '+QuotedStr(pChar(xmlNodeValue(slXMLDescom.Text, '//infProt/chNFe')))+'');
            Form7.ibDataSet24.Open;

            if Pos(Form7.ibDataset24NFEID.AsString,slXMLDescom.Text) <> 0 then
            begin
              if (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) = 0) and (Pos('<procEventoNFe',Form7.ibDataSet24NFEXML.AsString) = 0) then
              begin
                // Teste problema importao das NF-e de entrada
                if not (Form7.ibDataset24.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset24.Edit;
                Form7.ibDataset24NFEXML.AsString := AnsiToUTF8(slXMLDescom.text);  // Grava o XML descompactado na tabela compras
                Form7.ibDataset24.Post;
              end;
            end;
          end;
        except
          on E: Exception do
          begin
            //ShowMessage('Erro 2501 ao baixar lista de NF-es emitidas: '+E.Message); Mauricio Parizotto 2023-10-25
            MensagemSistema('Erro 2501 ao baixar lista de NF-es emitidas: '+E.Message,msgErro);
          end
        end;
      end;
      
      slXMLDescom.Free;
      lXMLDocZip := nil;
    end;
  except
    on E: Exception do
    begin
      //ShowMessage('Erro 2503 ao baixar lista de NF-es emitidas: '+E.Message); Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro 2503 ao baixar lista de NF-es emitidas: '+E.Message,msgErro);
    end;
  end;
  // Em procedure TForm7.ibDataSet24NewRecord(DataSet: TDataSet); faz DisableControls
  Form7.ibDataSet24.EnableControls; // Sandro Silva 2023-11-17
  Form7.ibDataSet23.EnableControls; // Sandro Silva 2023-12-04
  //LogRetaguarda('Form7.ibDataSet24.EnableControls; 3183'); // Sandro Silva 2023-11-27

  Result := True;
end;

function HasHs(sP1: String; bP2: Boolean): boolean;
var
  IBQHASH: TIBQuery;
  IBTHASH: TIBTransaction;
begin
  //
  if bP2 then
  begin
    Form7.ibQuery1.Close;
    Form7.ibQuery1.SQL.Clear;
    Form7.ibQuery1.SQL.Add('select gen_id(G_HASH_'+sP1+',0) as TOTALREG from rdb$database');
    Form7.ibQuery1.Open;

    try


      IBTHASH := CriaIBTransaction(Form7.ibQuery1.Transaction.DefaultDatabase);
      IBQHASH := Form7.CriaIBQuery(IBTHASH);

      Form7.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta

      IBQHASH.Close;
      IBQHASH.SQL.Clear;
      //IBQHASH.SQL.Add('update HASHS set ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery1.FieldByName('TOTALREG').AsString))))+' where TABELA='+QuotedStr(sP1)+' ');
      IBQHASH.SQL.Add('update HASHS set ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5String(Form7.ibQuery1.FieldByName('TOTALREG').AsString)))+' where TABELA='+QuotedStr(sP1)+' ');
      IBQHASH.ExecSQL;

      if IBQHASH.RowsAffected = 0 then
      begin
        //2015-11-26 No existe ainda controle de hash da tabela
        IBQHASH.Close;
        IBQHASH.SQL.Clear;
        //IBQHASH.SQL.Add('insert into HASHS(TABELA, ENCRYPTHASH) values(' + QuotedStr(sP1) + ',' + QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form7.ibQuery1.FieldByName('TOTALREG').AsString)))) + ')');
        IBQHASH.SQL.Add('insert into HASHS(TABELA, ENCRYPTHASH) values(' + QuotedStr(sP1) + ',' + QuotedStr(Form7.LbBlowfish1.EncryptString(MD5String(Form7.ibQuery1.FieldByName('TOTALREG').AsString))) + ')');
        IBQHASH.ExecSQL;
      end;

      IBQHASH.Transaction.Commit;

      IBTHASH.Free;
      IBQHASH.Free;

    except
    end;

    Result := True;
  end else
  begin
    Commitatudo(True);
    
    Form7.ibQuery2.Close;
    Form7.ibQuery2.SQL.Clear;
    Form7.ibQuery2.SQL.Add('select count(REGISTRO) from '+sP1+' ');
    Form7.ibQuery2.Open;

    //Teste 01
    Form7.ibQuery1.Close;
    Form7.ibQuery1.SQL.Clear;
    Form7.ibQuery1.SQL.Add('select gen_id(G_HASH_'+sP1+',0) as TOTALREG from rdb$database');
    Form7.ibQuery1.Open;

    Form7.ibQuery1.Close;
    Form7.ibQuery1.SQL.Clear;
    Form7.ibQuery1.SQL.Add('select ENCRYPTHASH from HASHS where TABELA='+QuotedStr(sP1)+' ');
    Form7.ibQuery1.Open;

    if Form7.ibQuery1.FieldByName('ENCRYPTHASH').AsString = Form7.LbBlowfish1.EncryptString(MD5String(Form7.ibQuery2.FieldByName('COUNT').AsString)) then
    begin
      Result := True;
    end else
    begin
      Result := False;
    end;
  end;
end;


/////////////////////////////////
function AssinaRegistro(pNome: String; DataSet: TDataSet; bAssina: Boolean): Boolean;
var
  s, sAntigo, sAntigoOrcamentSemCodigo : String;

  sSemCest, sAntigoSemCest : String; // Sandro Silva 2017-11-13  HOMOLOGA 2017 compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior
  sAntigoENCRYPTHASH, sAntigoSemCestENCRYPTHASH: String;
  sAntigoOrcamentENCRYPTHASH, sAntigoOrcamentSemCodigoENCRYPTHASH: String;  
begin
  Result := True;
  s := '';
  //
  try
    //Sandro Silva 2017-11-09 inicio Polimig
    if pNome = 'EMITENTE' then
    begin
      sAntigo :=
      VarToStr(DataSet.FieldByname('CGC').OldValue)+
      VarToStr(DataSet.FieldByname('IE').OldValue);;
      s :=
      DataSet.FieldByname('CGC').AsString+
      DataSet.FieldByname('IE').AsString;
    end;
    
    if pNome = 'VENDA' then
    begin
      sAntigo :=
      VarToStr(DataSet.FieldByname('NUMERONF').OldValue)+
      VarToStr(DataSet.FieldByname('MODELO').OldValue)+
      VarToStr(DataSet.FieldByname('VENDEDOR').OldValue)+
      VarToStr(DataSet.FieldByname('CLIENTE').OldValue)+
      VarToStr(DataSet.FieldByname('OPERACAO').OldValue)+
      VarToStr(DataSet.FieldByname('EMISSAO').OldValue)+
      VarToStr(DataSet.FieldByname('FRETE').OldValue)+
      VarToStr(DataSet.FieldByname('SEGURO').OldValue)+
      VarToStr(DataSet.FieldByname('DESPESAS').OldValue)+
      VarToStr(DataSet.FieldByname('DESCONTO').OldValue)+
      VarToStr(DataSet.FieldByname('VOLUMES').OldValue)+
      VarToStr(DataSet.FieldByname('ESPECIE').OldValue)+
      VarToStr(DataSet.FieldByname('MARCA').OldValue)+
      VarToStr(DataSet.FieldByname('TRANSPORTA').OldValue)+
      VarToStr(DataSet.FieldByname('FRETE12').OldValue)+
      VarToStr(DataSet.FieldByname('SAIDAH').OldValue)+
      VarToStr(DataSet.FieldByname('SAIDAD').OldValue)+
      VarToStr(DataSet.FieldByname('DUPLICATAS').OldValue)+
      VarToStr(DataSet.FieldByname('BASEICM').OldValue)+
      VarToStr(DataSet.FieldByname('BASEISS').OldValue)+
      VarToStr(DataSet.FieldByname('ICMS').OldValue)+
      VarToStr(DataSet.FieldByname('ICMSSUBSTI').OldValue)+
      VarToStr(DataSet.FieldByname('BASESUBSTI').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQUOTA').OldValue)+
      VarToStr(DataSet.FieldByname('ISS').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('TOTAL').OldValue)+
      VarToStr(DataSet.FieldByname('MERCADORIA').OldValue)+
      VarToStr(DataSet.FieldByname('EMITIDA').OldValue)+
      VarToStr(DataSet.FieldByname('SERVICOS').OldValue)+
      VarToStr(DataSet.FieldByname('PESOBRUTO').OldValue)+
      VarToStr(DataSet.FieldByname('PESOLIQUI').OldValue)+
      VarToStr(DataSet.FieldByname('REGISTRO').OldValue)+
      VarToStr(DataSet.FieldByname('NSUH').OldValue)+
      VarToStr(DataSet.FieldByname('NSU').OldValue)+
      VarToStr(DataSet.FieldByname('NSUD').OldValue)+
      VarToStr(DataSet.FieldByname('IDENTIFICADOR1').OldValue)+
      VarToStr(DataSet.FieldByname('COMPLEMENTO').OldValue)+
      VarToStr(DataSet.FieldByname('NVOL').OldValue)+
      VarToStr(DataSet.FieldByname('LOKED').OldValue)+
      VarToStr(DataSet.FieldByname('NFEPROTOCOLO').OldValue)+
      VarToStr(DataSet.FieldByname('STATUS').OldValue)+
      VarToStr(DataSet.FieldByname('NFEID').OldValue)+
      VarToStr(DataSet.FieldByname('NFERECIBO').OldValue)+
      VarToStr(DataSet.FieldByname('PLACA').OldValue)+
      VarToStr(DataSet.FieldByname('ANVISA').OldValue)+
      VarToStr(DataSet.FieldByname('DATA_CANCEL').OldValue)+
      VarToStr(DataSet.FieldByname('HORA_CANCEL').OldValue)+
      VarToStr(DataSet.FieldByname('COD_SIT').OldValue)+
      VarToStr(DataSet.FieldByname('FINNF').OldValue)+
      VarToStr(DataSet.FieldByname('INDFINAL').OldValue)+
      VarToStr(DataSet.FieldByname('INDPRES').OldValue);
      s :=
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('MODELO').AsString+
      DataSet.FieldByname('VENDEDOR').AsString+
      DataSet.FieldByname('CLIENTE').AsString+
      DataSet.FieldByname('OPERACAO').AsString+
      DataSet.FieldByname('EMISSAO').AsString+
      DataSet.FieldByname('FRETE').AsString+
      DataSet.FieldByname('SEGURO').AsString+
      DataSet.FieldByname('DESPESAS').AsString+
      DataSet.FieldByname('DESCONTO').AsString+
      DataSet.FieldByname('VOLUMES').AsString+
      DataSet.FieldByname('ESPECIE').AsString+
      DataSet.FieldByname('MARCA').AsString+
      DataSet.FieldByname('TRANSPORTA').AsString+
      DataSet.FieldByname('FRETE12').AsString+
      DataSet.FieldByname('SAIDAH').AsString+
      DataSet.FieldByname('SAIDAD').AsString+
      DataSet.FieldByname('DUPLICATAS').AsString+
      DataSet.FieldByname('BASEICM').AsString+
      DataSet.FieldByname('BASEISS').AsString+
      DataSet.FieldByname('ICMS').AsString+
      DataSet.FieldByname('ICMSSUBSTI').AsString+
      DataSet.FieldByname('BASESUBSTI').AsString+
      DataSet.FieldByname('ALIQUOTA').AsString+
      DataSet.FieldByname('ISS').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('MERCADORIA').AsString+
      DataSet.FieldByname('EMITIDA').AsString+
      DataSet.FieldByname('SERVICOS').AsString+
      DataSet.FieldByname('PESOBRUTO').AsString+
      DataSet.FieldByname('PESOLIQUI').AsString+
      DataSet.FieldByname('REGISTRO').AsString+
      DataSet.FieldByname('NSUH').AsString+
      DataSet.FieldByname('NSU').AsString+
      DataSet.FieldByname('NSUD').AsString+
      DataSet.FieldByname('IDENTIFICADOR1').AsString+
      DataSet.FieldByname('COMPLEMENTO').AsString+
      DataSet.FieldByname('NVOL').AsString+
      DataSet.FieldByname('LOKED').AsString+
      DataSet.FieldByname('NFEPROTOCOLO').AsString+
      DataSet.FieldByname('STATUS').AsString+
      DataSet.FieldByname('NFEID').AsString+
      DataSet.FieldByname('NFERECIBO').AsString+
      DataSet.FieldByname('PLACA').AsString+
      DataSet.FieldByname('ANVISA').AsString+
      DataSet.FieldByname('DATA_CANCEL').AsString+
      DataSet.FieldByname('HORA_CANCEL').AsString+
      DataSet.FieldByname('COD_SIT').AsString+
      DataSet.FieldByname('FINNF').AsString+
      DataSet.FieldByname('INDFINAL').AsString+
      DataSet.FieldByname('INDPRES').AsString;
    end;

    if pNome = 'ITENS001' then
    begin
      sAntigo :=
      VarToStr(DataSet.FieldByname('NUMERONF').OldValue)+
      VarToStr(DataSet.FieldByname('CODIGO').OldValue)+
      VarToStr(DataSet.FieldByname('DESCRICAO').OldValue)+
      VarToStr(DataSet.FieldByname('ST').OldValue)+
      VarToStr(DataSet.FieldByname('IPI').OldValue)+
      VarToStr(DataSet.FieldByname('ICM').OldValue)+
      VarToStr(DataSet.FieldByname('ISS').OldValue)+
      VarToStr(DataSet.FieldByname('MEDIDA').OldValue)+
      VarToStr(DataSet.FieldByname('QUANTIDADE').OldValue)+
      VarToStr(DataSet.FieldByname('SINCRONIA').OldValue)+
      VarToStr(DataSet.FieldByname('UNITARIO').OldValue)+
      VarToStr(DataSet.FieldByname('TOTAL').OldValue)+
      VarToStr(DataSet.FieldByname('LISTA').OldValue)+
      VarToStr(DataSet.FieldByname('CUSTO').OldValue)+
      VarToStr(DataSet.FieldByname('PESO').OldValue)+
      VarToStr(DataSet.FieldByname('BASE').OldValue)+
      VarToStr(DataSet.FieldByname('BASEISS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQUOTA').OldValue)+
      VarToStr(DataSet.FieldByname('CFOP').OldValue)+
      VarToStr(DataSet.FieldByname('NUMEROOS').OldValue)+
      VarToStr(DataSet.FieldByname('REGISTRO').OldValue)+
      VarToStr(DataSet.FieldByname('XPED').OldValue)+
      VarToStr(DataSet.FieldByname('NITEMPED').OldValue)+
      VarToStr(DataSet.FieldByname('VICMS').OldValue)+
      VarToStr(DataSet.FieldByname('VBC').OldValue)+
      VarToStr(DataSet.FieldByname('VBCST').OldValue)+
      VarToStr(DataSet.FieldByname('VICMSST').OldValue)+
      VarToStr(DataSet.FieldByname('VIPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST_PIS_COFINS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQ_PIS').OldValue)+
      VarToStr(DataSet.FieldByname('ALIQ_COFINS').OldValue)+
      VarToStr(DataSet.FieldByname('CST_IPI').OldValue)+
      VarToStr(DataSet.FieldByname('CST_ICMS').OldValue)+
      VarToStr(DataSet.FieldByname('ANVISA').OldValue)+
      VarToStr(DataSet.FieldByname('PFCPUFDEST').OldValue)+
      VarToStr(DataSet.FieldByname('PICMSUFDEST').OldValue);
      s :=
      DataSet.FieldByname('NUMERONF').AsString+
      DataSet.FieldByname('CODIGO').AsString+
      DataSet.FieldByname('DESCRICAO').AsString+
      DataSet.FieldByname('ST').AsString+
      DataSet.FieldByname('IPI').AsString+
      DataSet.FieldByname('ICM').AsString+
      DataSet.FieldByname('ISS').AsString+
      DataSet.FieldByname('MEDIDA').AsString+
      DataSet.FieldByname('QUANTIDADE').AsString+
      DataSet.FieldByname('SINCRONIA').AsString+
      DataSet.FieldByname('UNITARIO').AsString+
      DataSet.FieldByname('TOTAL').AsString+
      DataSet.FieldByname('LISTA').AsString+
      DataSet.FieldByname('CUSTO').AsString+
      DataSet.FieldByname('PESO').AsString+
      DataSet.FieldByname('BASE').AsString+
      DataSet.FieldByname('BASEISS').AsString+
      DataSet.FieldByname('ALIQUOTA').AsString+
      DataSet.FieldByname('CFOP').AsString+
      DataSet.FieldByname('NUMEROOS').AsString+
      DataSet.FieldByname('REGISTRO').AsString+
      DataSet.FieldByname('XPED').AsString+
      DataSet.FieldByname('NITEMPED').AsString+
      DataSet.FieldByname('VICMS').AsString+
      DataSet.FieldByname('VBC').AsString+
      DataSet.FieldByname('VBCST').AsString+
      DataSet.FieldByname('VICMSST').AsString+
      DataSet.FieldByname('VIPI').AsString+
      DataSet.FieldByname('CST_PIS_COFINS').AsString+
      DataSet.FieldByname('ALIQ_PIS').AsString+
      DataSet.FieldByname('ALIQ_COFINS').AsString+
      DataSet.FieldByname('CST_IPI').AsString+
      DataSet.FieldByname('CST_ICMS').AsString+
      DataSet.FieldByname('ANVISA').AsString+
      DataSet.FieldByname('PFCPUFDEST').AsString+
      DataSet.FieldByname('PICMSUFDEST').AsString;
    end;

    //Sandro Silva 2017-11-09 final Polimig
    if pNome = 'ESTOQUE' then
    begin
      //Sandro Silva 2017-11-13 inicio HOMOLOGA 2017
      // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior
      sAntigoSemCest :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('REFERENCIA').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('NOME').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('PRECO').OldValue)+
        VarToStr(DataSet.FieldByName('QTD_ATUAL').OldValue)+
        VarToStr(DataSet.FieldByName('DAT_INICIO').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_COMPRA').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_VENDA').OldValue)+
        VarToStr(DataSet.FieldByName('CF').OldValue)+
        VarToStr(DataSet.FieldByName('IPI').OldValue)+
        VarToStr(DataSet.FieldByName('CST').OldValue)+
        VarToStr(DataSet.FieldByName('ST').OldValue)+
        VarToStr(DataSet.FieldByName('IAT').OldValue)+
        VarToStr(DataSet.FieldByName('IPPT').OldValue);
      {Sandro Silva 2017-11-13 final HOMOLOGA 2017}
      sAntigo :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('REFERENCIA').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('NOME').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('PRECO').OldValue)+
        VarToStr(DataSet.FieldByName('QTD_ATUAL').OldValue)+
        VarToStr(DataSet.FieldByName('DAT_INICIO').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_COMPRA').OldValue)+
        VarToStr(DataSet.FieldByName('ULT_VENDA').OldValue)+
        VarToStr(DataSet.FieldByName('CF').OldValue)+
        VarToStr(DataSet.FieldByName('IPI').OldValue)+
        VarToStr(DataSet.FieldByName('CST').OldValue)+
        VarToStr(DataSet.FieldByName('ST').OldValue)+
        VarToStr(DataSet.FieldByName('IAT').OldValue)+
        VarToStr(DataSet.FieldByName('CEST').OldValue)+
        VarToStr(DataSet.FieldByName('IPPT').OldValue);

      //Sandro Silva 2017-11-13 inicio HOMOLOGA 2017
      // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior
      sSemCest :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('REFERENCIA').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('NOME').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('PRECO').AsString+
        DataSet.FieldByName('QTD_ATUAL').AsString+
        DataSet.FieldByName('DAT_INICIO').AsString+
        DataSet.FieldByName('ULT_COMPRA').AsString+
        DataSet.FieldByName('ULT_VENDA').AsString+
        DataSet.FieldByName('CF').AsString+
        DataSet.FieldByName('IPI').AsString+
        DataSet.FieldByName('CST').AsString+
        DataSet.FieldByName('ST').AsString+
        DataSet.FieldByName('IAT').AsString+
        DataSet.FieldByName('IPPT').AsString;
      //Sandro Silva 2017-11-13 final HOMOLOGA 2017

      s :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('REFERENCIA').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('NOME').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('PRECO').AsString+
        DataSet.FieldByName('QTD_ATUAL').AsString+
        DataSet.FieldByName('DAT_INICIO').AsString+
        DataSet.FieldByName('ULT_COMPRA').AsString+
        DataSet.FieldByName('ULT_VENDA').AsString+
        DataSet.FieldByName('CF').AsString+
        DataSet.FieldByName('IPI').AsString+
        DataSet.FieldByName('CST').AsString+
        DataSet.FieldByName('ST').AsString+
        DataSet.FieldByName('IAT').AsString+
        DataSet.FieldByName('CEST').AsString+
        DataSet.FieldByName('IPPT').AsString;
    end;
    
    if pNome = 'ALTERACA' then
    begin
      //Sandro Silva 2018-05-25 inicio
      sAntigo :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('QUANTIDADE').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('UNITARIO').OldValue)+
        VarToStr(DataSet.FieldByName('TOTAL').OldValue)+
        VarToStr(DataSet.FieldByName('DATA').OldValue)+
        VarToStr(DataSet.FieldByName('TIPO').OldValue)+
        VarToStr(DataSet.FieldByName('PEDIDO').OldValue)+
        VarToStr(DataSet.FieldByName('ITEM').OldValue)+
        VarToStr(DataSet.FieldByName('VENDEDOR').OldValue)+
        VarToStr(DataSet.FieldByName('CLIFOR').OldValue)+
        VarToStr(DataSet.FieldByName('CAIXA').OldValue)+
        VarToStr(DataSet.FieldByName('VALORICM').OldValue)+
        VarToStr(DataSet.FieldByName('ALIQUICM').OldValue)+
        VarToStr(DataSet.FieldByName('HORA').OldValue)+
        VarToStr(DataSet.FieldByName('DAV').OldValue)+
        VarToStr(DataSet.FieldByName('TIPODAV').OldValue)+
        VarToStr(DataSet.FieldByName('COO').OldValue)+
        VarToStr(DataSet.FieldByName('CCF').OldValue)+
        VarToStr(DataSet.FieldByName('SERIE').OldValue)+
        VarToStr(DataSet.FieldByName('SUBSERIE').OldValue)+
        VarToStr(DataSet.FieldByName('CNPJ').OldValue)+
        VarToStr(DataSet.FieldByName('REFERENCIA').OldValue);
      //Sandro Silva 2018-05-25 fim
      s :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('QUANTIDADE').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('UNITARIO').AsString+
        DataSet.FieldByName('TOTAL').AsString+
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('TIPO').AsString+
        DataSet.FieldByName('PEDIDO').AsString+
        DataSet.FieldByName('ITEM').AsString+
        DataSet.FieldByName('VENDEDOR').AsString+
        DataSet.FieldByName('CLIFOR').AsString+
        DataSet.FieldByName('CAIXA').AsString+
        DataSet.FieldByName('VALORICM').AsString+
        DataSet.FieldByName('ALIQUICM').AsString+
        DataSet.FieldByName('HORA').AsString+
        DataSet.FieldByName('DAV').AsString+
        DataSet.FieldByName('TIPODAV').AsString+
        DataSet.FieldByName('COO').AsString+
        DataSet.FieldByName('CCF').AsString+
        DataSet.FieldByName('SERIE').AsString+
        DataSet.FieldByName('SUBSERIE').AsString+
        DataSet.FieldByName('CNPJ').AsString+
        DataSet.FieldByName('REFERENCIA').AsString;
    end;

    if pNome = 'REDUCOES' then
    begin
      s :=
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('HORA').AsString+
        DataSet.FieldByName('SERIE').AsString+
        DataSet.FieldByName('PDV').AsString+
        DataSet.FieldByName('TIPOECF').AsString+
        DataSet.FieldByName('MARCAECF').AsString+
        DataSet.FieldByName('MODELOECF').AsString+
        DataSet.FieldByName('VERSAOSB').AsString+
        DataSet.FieldByName('DATASB').AsString+
        DataSet.FieldByName('HORASB').AsString+
        DataSet.FieldByName('CUPOMI').AsString+
        DataSet.FieldByName('CUPOMF').AsString+
        DataSet.FieldByName('CONTADORZ').AsString+
        DataSet.FieldByName('TOTALI').AsString+
        DataSet.FieldByName('TOTALF').AsString+
        DataSet.FieldByName('ALIQUOTA01').AsString+
        DataSet.FieldByName('ALIQUOTA02').AsString+
        DataSet.FieldByName('ALIQUOTA03').AsString+
        DataSet.FieldByName('ALIQUOTA04').AsString+
        DataSet.FieldByName('ALIQUOTA05').AsString+
        DataSet.FieldByName('ALIQUOTA06').AsString+
        DataSet.FieldByName('ALIQUOTA07').AsString+
        DataSet.FieldByName('ALIQUOTA08').AsString+
        DataSet.FieldByName('ALIQUOTA09').AsString+
        DataSet.FieldByName('ALIQUOTA10').AsString+
        DataSet.FieldByName('ALIQUOTA11').AsString+
        DataSet.FieldByName('ALIQUOTA12').AsString+
        DataSet.FieldByName('ALIQUOTA13').AsString+
        DataSet.FieldByName('ALIQUOTA14').AsString+
        DataSet.FieldByName('ALIQUOTA15').AsString+
        DataSet.FieldByName('ALIQUOTA16').AsString+
        DataSet.FieldByName('ALIQUOTA17').AsString+
        DataSet.FieldByName('ALIQUOTA18').AsString+
        DataSet.FieldByName('ALIQUOTA19').AsString+
        DataSet.FieldByName('ALIQU01').AsString+
        DataSet.FieldByName('ALIQU02').AsString+
        DataSet.FieldByName('ALIQU03').AsString+
        DataSet.FieldByName('ALIQU04').AsString+
        DataSet.FieldByName('ALIQU05').AsString+
        DataSet.FieldByName('ALIQU06').AsString+
        DataSet.FieldByName('ALIQU07').AsString+
        DataSet.FieldByName('ALIQU08').AsString+
        DataSet.FieldByName('ALIQU09').AsString+
        DataSet.FieldByName('ALIQU10').AsString+
        DataSet.FieldByName('ALIQU11').AsString+
        DataSet.FieldByName('ALIQU12').AsString+
        DataSet.FieldByName('ALIQU13').AsString+
        DataSet.FieldByName('ALIQU14').AsString+
        DataSet.FieldByName('ALIQU15').AsString+
        DataSet.FieldByName('ALIQU16').AsString+
        DataSet.FieldByName('CANCELAMEN').AsString+
        DataSet.FieldByName('DESCONTOS').AsString+
        DataSet.FieldByName('ISSQN').AsString+
        DataSet.FieldByName('SMALL').AsString+
        DataSet.FieldByName('STATUS').AsString+
        DataSet.FieldByName('ESTOQUE').AsString;
    end;

    if pNome = 'ORCAMENT' then
    begin
      sAntigoOrcamentSemCodigo :=
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('QUANTIDADE').OldValue)+
        VarToStr(DataSet.FieldByName('UNITARIO').OldValue)+
        VarToStr(DataSet.FieldByName('TOTAL').OldValue)+
        VarToStr(DataSet.FieldByName('DATA').OldValue)+
        VarToStr(DataSet.FieldByName('TIPO').OldValue)+
        VarToStr(DataSet.FieldByName('PEDIDO').OldValue)+
        VarToStr(DataSet.FieldByName('CLIFOR').OldValue)+
        VarToStr(DataSet.FieldByName('VENDEDOR').OldValue)+
        VarToStr(DataSet.FieldByName('CAIXA').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('ITEM').OldValue)+
        VarToStr(DataSet.FieldByName('VALORICM').OldValue)+
        VarToStr(DataSet.FieldByName('ALIQUICM').OldValue)+
        VarToStr(DataSet.FieldByName('NUMERONF').OldValue)+
        VarToStr(DataSet.FieldByName('COO').OldValue);

      sAntigo :=
        VarToStr(DataSet.FieldByName('CODIGO').OldValue)+
        VarToStr(DataSet.FieldByName('DESCRICAO').OldValue)+
        VarToStr(DataSet.FieldByName('QUANTIDADE').OldValue)+
        VarToStr(DataSet.FieldByName('UNITARIO').OldValue)+
        VarToStr(DataSet.FieldByName('TOTAL').OldValue)+
        VarToStr(DataSet.FieldByName('DATA').OldValue)+
        VarToStr(DataSet.FieldByName('TIPO').OldValue)+
        VarToStr(DataSet.FieldByName('PEDIDO').OldValue)+
        VarToStr(DataSet.FieldByName('CLIFOR').OldValue)+
        VarToStr(DataSet.FieldByName('VENDEDOR').OldValue)+
        VarToStr(DataSet.FieldByName('CAIXA').OldValue)+
        VarToStr(DataSet.FieldByName('MEDIDA').OldValue)+
        VarToStr(DataSet.FieldByName('ITEM').OldValue)+
        VarToStr(DataSet.FieldByName('VALORICM').OldValue)+
        VarToStr(DataSet.FieldByName('ALIQUICM').OldValue)+
        VarToStr(DataSet.FieldByName('NUMERONF').OldValue)+
        VarToStr(DataSet.FieldByName('COO').OldValue);

      s :=
        DataSet.FieldByName('CODIGO').AsString+
        DataSet.FieldByName('DESCRICAO').AsString+
        DataSet.FieldByName('QUANTIDADE').AsString+
        DataSet.FieldByName('UNITARIO').AsString+
        DataSet.FieldByName('TOTAL').AsString+
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('TIPO').AsString+
        DataSet.FieldByName('PEDIDO').AsString+
        DataSet.FieldByName('CLIFOR').AsString+
        DataSet.FieldByName('VENDEDOR').AsString+
        DataSet.FieldByName('CAIXA').AsString+
        DataSet.FieldByName('MEDIDA').AsString+
        DataSet.FieldByName('ITEM').AsString+
        DataSet.FieldByName('VALORICM').AsString+
        DataSet.FieldByName('ALIQUICM').AsString+
        DataSet.FieldByName('NUMERONF').AsString+
        DataSet.FieldByName('COO').AsString;
    end;

    if pNome = 'PAGAMENT' then
    begin
      s :=
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('PEDIDO').AsString+
        DataSet.FieldByName('COO').AsString+
        DataSet.FieldByName('CCF').AsString+
        DataSet.FieldByName('CAIXA').AsString+
        DataSet.FieldByName('CLIFOR').AsString+
        DataSet.FieldByName('VENDEDOR').AsString+
        DataSet.FieldByName('FORMA').AsString+
        DataSet.FieldByName('VALOR').AsString+
        DataSet.FieldByName('GRG').AsString+
        DataSet.FieldByName('CDC').AsString+
        DataSet.FieldByName('GNF').AsString;
    end;

    if pNome = 'DEMAIS' then
    begin
      s :=
        DataSet.FieldByName('DATA').AsString+
        DataSet.FieldByName('HORA').AsString+
        DataSet.FieldByName('ECF').AsString+
        DataSet.FieldByName('DENOMINACAO').AsString+
        DataSet.FieldByName('COO').AsString+
        DataSet.FieldByName('GNF').AsString+
        DataSet.FieldByName('CDC').AsString+
        DataSet.FieldByName('GRG').AsString;
    end;

    //Sandro Silva 2015-10-01 inicio
    if pNome = 'ECFS' then
    begin
      s := DataSet.FieldByName('SERIE').AsString;
    end;
    //Sandro Silva 2015-10-01 final

    Form1.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta

    if (pNome = 'ALTERACA') or (pNome = 'ESTOQUE') then 
    begin
      //sAntigoENCRYPTHASH        := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)));
      sAntigoENCRYPTHASH        := Form1.LbBlowfish1.EncryptString(MD5String(sAntigo));
      //sAntigoSemCestENCRYPTHASH := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigoSemCest)));
      sAntigoSemCestENCRYPTHASH := Form1.LbBlowfish1.EncryptString(MD5String(sAntigoSemCest));
    end;

    if (pNome = 'ORCAMENT') then
    begin
      sAntigoOrcamentENCRYPTHASH := Form1.LbBlowfish1.EncryptString(MD5String(s));
      sAntigoOrcamentSemCodigoENCRYPTHASH := Form1.LbBlowfish1.EncryptString(MD5String(sAntigoOrcamentSemCodigo));
    end;


    if bAssina then
    begin
      // Assina registro
      if pNome = 'ESTOQUE' then
      begin
        // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior, para assinar novamente aps alterao feita pelo PAF
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sAntigoSemCest)))
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sAntigo)))
          or (DataSet.FieldByName('ENCRYPTHASH').isNull)
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(Form1.sPasta))) then // Se o registro j foi violado no assina mais fica asssim pra sempre
        begin
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5String(s)); // Encrypta e grava o hash do registro
        end;
      end else
      if pNome = 'ORCAMENT' then
      begin
        // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior, para assinar novamente aps alterao feita pelo PAF
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sAntigoOrcamentSemCodigo)))
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sAntigo)))
          or (DataSet.FieldByName('ENCRYPTHASH').isNull)
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(Form1.sPasta))) then // Se o registro j foi violado no assina mais fica asssim pra sempre
        begin
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5String(s)); // Encrypta e grava o hash do registro
        end;
      end else
      begin
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sAntigo)))
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(Form1.sPasta)))
          or (DataSet.FieldByName('ENCRYPTHASH').isNull) then // Se o registro j foi violado no assina mais fica asssim pra sempre // Sandro Silva 2018-05-25
        begin
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5String(s)); // Encrypta e grava o hash do registro
        end;
      end;

{      if pNome = 'ESTOQUE' then
      begin
//        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigoSemCest)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)))) or (DataSet.FieldByName('ENCRYPTHASH').isNull) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) then // Se o registro j foi violado no assina mais fica asssim pra sempre
        begin
          //DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(s))); // Encrypta e grava o hash do registro
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(GeraMD5(s)); // Encrypta e grava o hash do registro
        end;
      end else
      begin
        // Sandro Silva
        //if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sAntigo)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) or (DataSet.FieldByName('ENCRYPTHASH').isNull) then // Se o registro j foi violado no assina mais fica asssim pra sempre // Sandro Silva 2018-05-25
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(GeraMD5(sAntigo)))
            or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(GeraMD5(Form1.sPasta)))
            or (DataSet.FieldByName('ENCRYPTHASH').isNull) then // Se o registro j foi violado no assina mais fica asssim pra sempre
        begin
          //DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(s))); // Encrypta e grava o hash do registro
          DataSet.FieldByName('ENCRYPTHASH').AsString := Form1.LbBlowfish1.EncryptString(GeraMD5(s)); // Encrypta e grava o hash do registro
        end;
      end; }
    end else
    begin
      // Sandro Silva
      //if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(s)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) then  // Encrypta e compara o hash do registro
      if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(s)))
        or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(Form1.sPasta))) then  // Encrypta e compara o hash do registro
      begin
        Result := True;
      end else
      begin
        Result := False;
      end;

      //Sandro Silva 2017-11-13 inicio HOMOLOGA 2017
      // compatibilizar os hashs que esto no registros e foram gerados pelo PAF anterior. Para os registros ainda no alterados pelo paf novo que ainda esto assinados pelo PAF antigo
      if (pNome = 'ESTOQUE') and (Result = False) then
      begin
        // Se resultou False deve validar hash com a assinatura da Verso anterior. Pode ser que o registro ainda no foi alterado aps atualizar para nova verso homologada sem campo CEST
        // Sandro Silva
        //if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(sSemCest)))) or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta)))) then
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sSemCest)))
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(Form1.sPasta))) then
        begin
          Result := True;
        end else
        begin
          Result := False;
        end;
      end;
      //Sandro Silva 2017-11-13 final HOMOLOGA 2017

      {Dailon Parisotto 2023-10-06 (f-7420) Inicio}
      // Identificado diferena na gerao dos HASHs entre o COMMERCE e o ORCA, o ORCA gerava sem o campo CODIGO
      // Essa mesma validao deve estar na rotina de "assinaregistro" do COMMERCE e do FRENTE
      if (pNome = 'ORCAMENT') and (Result = False) then
      begin
        if (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(sAntigoOrcamentSemCodigo)))
          or (DataSet.FieldByName('ENCRYPTHASH').AsString = Form1.LbBlowfish1.EncryptString(MD5String(Form1.sPasta))) then
        begin
          Result := True;
        end else
        begin
          Result := False;
        end;
      end;
      {Dailon Parisotto 2023-10-06 (f-7420) Fim}
    end;
  except
    //ShowMessage('Erro ao criptografar head do registro do arquivo '+pNome) Mauricio Parizotto 2023-10-25
    MensagemSistema('Erro ao criptografar head do registro do arquivo '+pNome,msgErro);
  end;
end;

function NaoHouveMovimento(sP1:String): boolean;
begin
  Result := True;
  // Itens de venda
  Form7.ibQuery1.Close;
  Form7.ibQuery1.SQL.Clear;
  Form7.ibQuery1.SQL.Add('select count(CODIGO) from ITENS001 where CODIGO='+QuotedStr(sP1)+' ');
  Form7.ibQuery1.Open;

  if Form7.ibQuery1.FieldByName('COUNT').AsFloat <> 0 then
    Result := False;

  // Itens de compra
  Form7.ibQuery1.Close;
  Form7.ibQuery1.SQL.Clear;
  Form7.ibQuery1.SQL.Add('select count(CODIGO) from ITENS002 where CODIGO='+QuotedStr(sP1)+' ');
  Form7.ibQuery1.Open;

  if Form7.ibQuery1.FieldByName('COUNT').AsFloat <> 0 then
    Result := False;

  // ALTERACA
  Form7.ibQuery1.Close;
  Form7.ibQuery1.SQL.Clear;
  Form7.ibQuery1.SQL.Add('select count(CODIGO) from ALTERACA where CODIGO='+QuotedStr(sP1)+' ');
  Form7.ibQuery1.Open;

  if Form7.ibQuery1.FieldByName('COUNT').AsFloat <> 0 then
    Result := False;
end;

function DenegadoOuCancelado(bP1:Boolean): boolean;
begin
  Result := False;
  
  if FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) then
  begin
    if (Pos('cancelada',LowerCase(Form7.ibDataSet15NFEXML.AsString)) = 0) then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
      Form7.ibDataSet15.Post;
      Result := True;
    end;

    if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataset15STATUS.AsString  := 'NF-e cancelada';
      Form7.ibDataSet15.Delete;
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;

      Form7.ibDataSet15EMITIDA.AsString := 'X';
      Form7.ibDataSet15.Post;

      Result := True;
      Screen.Cursor            := crDefault;
      commitatudo(True);
      Form7.Close;
      Form7.Show;
    end;
  end;
  
  if (FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-den.xml'))))
  or (  Pos('denegado',LowerCase(Form7.ibDataSet15STATUS.AsString)) <> 0) then
  begin
    Screen.Cursor            := crHourGlass;

    if (Pos('denegado',LowerCase(Form7.ibDataSet15NFEXML.AsString)) = 0) then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
      Form7.ibDataSet15.Post;
      Result := True;
    end;

    if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
    begin
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataset15STATUS.AsString  := 'Uso Denegado';
      Form7.ibDataSet15.Delete;
      if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
      Form7.ibDataSet15EMITIDA.AsString := 'X';
      Form7.ibDataSet15.Post;

      Result := True;
      Screen.Cursor            := crDefault;
      commitatudo(True);
      Form7.Close;
      Form7.Show;
    end;
  end;
end;

function VerificaSeEstaSendoUsado(bP1:Boolean): boolean;
begin
  Form7.bEstaSendoUsado := False;

  if not (Form7.ArquivoAberto.State in ([dsInsert])) then
  begin
    try
        Form7.ArquivoAberto.Edit;
        Form7.ArquivoAberto.Post;
        Form7.bEstaSendoUsado := False;
    except
      Form7.bEstaSendoUsado := True;
    end;
  end;
  
  if not bP1 then
  begin
    if Form7.bEstaSendoUsado then
    begin
      AgendaCommit(True);
      Form7.Close;
      Form7.Show;
      
      try
        Form7.ArquivoAberto.Edit;
        Form7.ArquivoAberto.Post;
        Form7.bEstaSendoUsado := False;
      except
        Form7.bEstaSendoUsado := True;
      end;
    end;
  end;
  
  Result := Form7.bEstaSendoUsado;
end;


procedure CopiarMenu(Origem, Destino:TMenuItem; Form:tForm);
var
   MenuItem: TMenuItem;
   i: integer;
begin
  for i := 0 to Origem.Count - 1 do
  begin
    MenuItem := TMenuItem.Create(Form);
    MenuItem.Caption := Origem.Items[i].Caption;
    MenuItem.Visible := Origem.Items[i].Visible;
    MenuItem.Hint    := Origem.Items[i].Hint;
    MenuItem.OnClick := Origem.Items[i].OnClick;
    Destino.Add(MenuItem);
    if Origem.Items[i].count > 0 then  CopiarMenu(Origem.Items[i], Destino.Items[Destino.count -1], Form7)
  end;
end;

procedure PosicionarMenuPopUp(Parent: TObject; Sender: TObject; PopupMenu: TPopupMenu; Ancora: TAnchorKind = akTop);
//Sandro Silva 2011-05-13 inicio
//- Posiciona PopUpMenu na tela
//- Util para chamar o popup a partir do botao contrrio (esquerdo) do mouse
//
var
  Ponto: TPoint;
begin
  with Sender as TControl do
  begin
    if PopupMenu = nil then
       Exit
    else
    begin
      GetCursorPos(Ponto);
      Ponto.X := Left + 1;
      if Ancora = akTop then // Posiciona a partir do top do objeto
        Ponto.Y := Top - TControl(PopupMenu).Height - 53
      else
        if Ancora = akBottom then // Posiciona a partir do bottom do objeto
          Ponto.Y := Top + Height + 1;
      Ponto := TControl(Parent).ClientToScreen(Ponto);
      PopupMenu.popup(Ponto.X, Ponto.Y);
    end;
  end;
end;

function TestarEstadosAlteraEmitadaNota: Boolean;
begin
  Result := ((Form7.ibDataSet13ESTADO.AsString <> 'SC') and (Form7.ibDataSet13ESTADO.AsString <> 'MG')) or (Form1.iReduzida = 2) or (Form7.sRPS = 'S');
end;

function BaixaEstoqueDaNFeAutorizada(sPp1: String): boolean;
//var
//  sCodigo: String; // Sandro Silva 2023-11-07
begin
  // Ateno a rotina abaixo altera a quantidade no estoque
  if TestarEstadosAlteraEmitadaNota then
  begin
    try
      Form7.ibDataSet15.Edit;

      if (Form7.ibDataSet15.State in ([dsEdit, dsInsert])) then
      begin
        if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
        begin
          Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
        end;

        Form7.ibDataSet15.Post;
      end;
    except
    end;
  end;
  
  if (Form7.ibDataSet15EMITIDA.AsString = 'S') then
  begin
    try
      Form7.ibDataSet14.DisableControls;
      Form7.ibDataSet14.Close;
      Form7.ibDataSet14.SelectSQL.Clear;
      Form7.ibDataSet14.SelectSQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
      Form7.ibDataSet14.Open;

      if Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,5) = 'CAIXA' then
      begin
        // Integrao com o Livro caixa CAIXA.DBF                     //
        ApagaIntegracaoComOCaixa(True);

        Form7.ibDataSet12.First;

        if (AllTrim(Form7.ibDataSet14CONTA.AsString) = '') then
        begin
          if (Form7.ibDataSet15TOTAL.AsFloat>0) then
            Form43.ShowModal; // Ok
        end else
        begin
          Form7.ibDataSet12.Locate('NOME',AllTrim(Form7.ibDataSet14CONTA.AsString),[loCaseInsensitive, loPartialKey]);
        end;

        if not Form7.ibDataSet1.Active then Form7.ibDataSet1.Open;
        
        Form7.ibDataSet1.Append;
        Form7.ibDataSet1DATA.Value      := Form7.ibDataSet15EMISSAO.Value;
        //Form7.ibDataSet1HISTORICO.Value := 'Nota Fiscal: '+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+' de '+Form7.ibDataSet15CLIENTE.asString; Mauricio Parizotto 2024-02-19
        Form7.ibDataSet1HISTORICO.Value := Copy('Nota Fiscal: '+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+' de '+Form7.ibDataSet15CLIENTE.asString,1,45);
        Form7.ibDataSet1ENTRADA.Value   := (Form7.ibDataSet15TOTAL.AsFloat - Form1.fRetencaoIR);
        Form7.ibDataSet1NOME.AsString   := Form7.ibDataSet12NOME.AsString;
        Form7.ibDataSet1.Post;
      end;
    except
    end;

    try
      Form7.ibDataSet7.DisableControls;
      Form7.ibDataSet7.First;
      while not Form7.ibDataSet7.Eof do // disable
      begin
        Form7.ibDataSet7.Edit;
        Form7.ibDataSet7HISTORICO.AsString := 'Nota Fiscal: '+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9);
        Form7.ibDataSet7.Post;
        Form7.ibDataSet7.Next;
      end;
    except
    end;

    // Emitida
    Form7.ibDataSet16.DisableControls;
    Form7.ibDataSet16.First;
    while not Form7.ibDataSet16.Eof do // disable
    begin
      // Procura o produto no estoque
      try
        Form7.ibDataSet4.Close;                                                //
        Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
        Form7.ibDataSet4.Open;
        //
        if Form7.ibDataSet16CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString then
        begin
          if Form7.ibDataSet16SINCRONIA.AsFloat <> Form7.ibDataSet16QUANTIDADE.AsFloat then
          begin
            if TestarNatOperacaoMovEstoque then
            begin
              if Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '929' then
              begin

                {Sandro Silva 2023-11-07 inicio}
                try
                  Form7.bFabrica := True;
                  if (Form7.ibDataSet4QTD_ATUAL.AsFloat - Form7.ibDataSet16QUANTIDADE.AsFloat) <= 0 then
                    FabricaComposto(Form7.ibDataSet4CODIGO.AsString, Form7.ibDataSet4, Abs(Form7.ibDataSet4QTD_ATUAL.AsFloat - Form7.ibDataSet16QUANTIDADE.AsFloat), Form7.bFabrica, 1, Form7.sModulo); // Sandro Silva 2023-12-08 FabricaComposto(Form7.ibDataSet4CODIGO.AsString, Form7.ibDataSet4, Form7.ibDataSet16QUANTIDADE.AsFloat, Form7.bFabrica, 1, Form7.sModulo);
                finally
                  Form7.bFabrica := False;
                end;
                {Sandro Silva 2023-11-07 fim}

                Form7.ibDataSet4.Edit;
                Form7.ibDataSet4QTD_ATUAL.AsFloat    := Form7.ibDataSet4QTD_ATUAL.AsFloat - Form7.ibDataSet16QUANTIDADE.AsFloat; // Baixa a quantidade no estoque quando fecha a NF
                Form7.ibDataSet4ULT_VENDA.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
                Form7.ibDataSet4.Post;
              end;
            end;
            
            Form7.sModulo := 'FECHAVENDA';
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16SINCRONIA.AsFloat := Form7.ibDataSet16QUANTIDADE.AsFloat; // Resolvi este problema as 4 da madrugada no NoteBook em casa
            Form7.ibDataSet16.Post;
          end;
        end;
      except
      end;

      Form7.sModulo := 'VENDA';
      Form7.ibDataSet16.Next;
    end;
  end;

  // Ateno a rotina acima altera a quantidade no estoque
  Result := True;
end;



{Sandro Silva 2022-09-12 inicio
// A PEDIDO DO
// VANDERLEI PERETI
// FONES: 49 35664136 / 91427178
// EMAIL: comercial@vpinformatica.com.br
function AliqICMdoCliente16: double;
begin
  if Form1.fAliqICMdoCliente <> 0 then
  begin
    if Form7.ibDataSet13ESTADO.AsString =  Form7.ibDataSet2ESTADO.AsString then
    begin
      Result :=  Form1.fAliqICMdoCliente;
    end else
    begin
      Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
    end;
  end else
  begin
    Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
  end;
end;
}

function utf8Fix(sTexto: String): String;
const
  acento : array[1..47] of string = ('', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '');
  utf8: array[1..47] of string = ('',' ','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','', '?');
var
  iLetra: Integer;
begin
  Result := sTexto;
  for iLetra := 1 to length(utf8) do
  begin
    if Pos(utf8[iLetra], Result) > 0 then
      Result := StringReplace(Result, utf8[iLetra], acento[iLetra], [rfReplaceAll]);
  end;
end;


function xmlNodeValue(sXML: String; sNode: String): String;
var
  XMLDOM: IXMLDOMDocument;
  iNode: Integer;
  xNodes: IXMLDOMNodeList;
begin


  XMLDOM := CoDOMDocument.Create;
  XMLDOM.loadXML(sXML);

  Result := '';
  xNodes := XMLDOM.selectNodes(sNode);
  for iNode := 0 to xNodes.length -1 do
  begin
    Result := xNodes.item[iNode].text;
  end;
  
//  Result := Utf8ToAnsi(Result);
  Result := Utf8Fix(Result);
  XMLDOM := nil;
  
end;

{
function ConsultaProcesso(sP1:String): boolean;
var
  Snapshot: THandle;
  ProcessEntry32: TProcessEntry32;
begin
  //
  Result   := False;
  Snapshot := CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
  if (Snapshot = Cardinal(-1)) then exit;
  //
  ProcessEntry32.dwSize := SizeOf(TProcessEntry32);
  //
  // pesquisa pela lista de processos
  //
  if (Process32First(Snapshot, ProcessEntry32)) then
  repeat
    //
    // enquanto houver processos
    //
    // SubItems.Add(IntToStr(ProcessEntry32.th32ParentPro cessID));
    if ProcessEntry32.szExeFile = sP1 then Result := True;
    //
  until not Process32Next(Snapshot, ProcessEntry32);
  //
  CloseHandle (Snapshot);
  //
end;
Movido para SmallFunc}

function CalculaTotalRecebido(pP1: Boolean): Currency; // Sandro Silva 2023-10-30 Boolean;
begin
  //
  if Form7.sModulo = 'RECEBER' then
  begin
    //
    Form7.ibQuery1.Close;
    Form7.iBQuery1.SQL.Clear;
    Form7.iBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
    Form7.iBQuery1.Open;
    //
    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Label49.Caption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Panel10.Repaint;
    //
  end else
  begin
    //
    Form7.ibQuery1.Close;
    Form7.iBQuery1.SQL.Clear;
    Form7.iBQuery1.SQL.Add('select sum(VALOR_PAGO) from PAGAR where ATIVO >= 5');
    Form7.iBQuery1.Open;
    //
    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Label49.CAption := 'R$'+Format('%14.2n',[Form7.iBQuery1.FieldByName('SUM').AsFloat]);
    Form7.Panel10.Repaint;
    //
  end;
  //
  Result := Form7.iBQuery1.FieldByName('SUM').AsFloat; // Sandro Silva 2023-10-30 Result := True;
  //
end;

function HtmlParaPdf(sP1:String): boolean;
begin
  //
  try
    //
    while FileExists(pChar(sP1+'.pdf')) do
    begin
      //
      try
        DeleteFile(pChar(sP1+'.pdf'));
        DeleteFile(pChar(sP1+'_.pdf'));
      except end;
      //
      Sleep(10);
      //
    end;
    //
    chdir(pChar(Form1.sAtual+'\HTMLtoPDF'));
    //
    while FileExists(pChar('tempo_ok.pdf')) do
    begin
      DeleteFile(pChar('tempo_ok.pdf'));
      Sleep(10);
    end;
    //
    while FileExists(pChar('tempo.pdf')) do
    begin
      DeleteFile(pChar('tempo.pdf'));
      Sleep(10);
    end;
    //
    ShellExecute( 0, 'runas', pChar('html2pdf'),pchar('"'+Form1.sAtual+'\'+sP1+'.htm" "tempo.pdf"'), '', SW_HIDE);
    Sleep(10);
    //
    while not FileExists(pChar(Form1.sAtual+'\HTMLtoPDF\tempo_ok.pdf')) do
    begin
      RenameFile(pChar(Form1.sAtual+'\HTMLtoPDF\tempo.pdf'),pChar(Form1.sAtual+'\HTMLtoPDF\tempo_ok.pdf'));
      Sleep(10);
    end;
    //
    chdir(pChar(Form1.sAtual));
    //
    CopyFile(pChar(Form1.sAtual+'\HTMLtoPDF\tempo_ok.pdf'), pChar(sP1+'_.pdf'),False);
    //
    while not FileExists(pChar(sP1+'.pdf')) do
    begin
      RenameFile(pChar(sP1+'_.pdf'), pChar(sP1+'.pdf'));
      Sleep(10);
    end;
    //
  except end;
  //
  Result := True;
  //
end;

function AbreArquivoNoFormatoCerto(sP1:String): boolean;
begin
  if Copy(sP1,1,3) <> 'OS_' then
    sP1 := Senhas.UsuarioPub;

{Sandro Silva 2023-10-02 inicio
  if Form1.bPDF then
  begin
    Screen.Cursor            := crHourGlass;
    HtmlParaPdf(sP1);
    ShellExecute( 0, 'Open',pChar(sP1+'.pdf'),'', '', SW_SHOWMAXIMIZED);
    Screen.Cursor            := crDefault;
  //end else
  end;

  if Form1.bHtml1 then
  begin
    ShellExecute( 0, 'Open',pChar(sP1+'.HTM'),'', '', SW_SHOWMAXIMIZED);
  end;
}
  if Form1.bPDF then
  begin
    Screen.Cursor            := crHourGlass;
    HtmlParaPdf(sP1);
    ShellExecute( 0, 'Open',pChar(sP1+'.pdf'),'', '', SW_SHOWMAXIMIZED);
    Screen.Cursor            := crDefault;
  end
  else if Form1.bHtml1 then
  begin
    ShellExecute( 0, 'Open',pChar(sP1+'.HTM'),'', '', SW_SHOWMAXIMIZED);
  end;


  Result := True;
end;

procedure ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos(
  XmlEnviado: String; sRetorno: String);
//Exibe orientaes de como proceder em casos de rejeies retornadas pela Sefaz
begin
  if AnsiContainsText(sRetorno, '<cStat>873</cStat>') // Rejeio: Operao com medicamentos e no informado os campos de rastreabilidade [nItem: nnn]
  or AnsiContainsText(sRetorno, '<cStat>840</cStat>') // Rejeio: NCM de medicamento e no informado o grupo de medicamento (med) [nItem:nnn]
  then
  begin
    //Application.MessageBox(pChar('Preencha os campos cProdANVISA, xMotivoIsencao e rastro, da Aba TAGs, no cadastro do produto ' + ItemRejeicao(sRetorno, XmlEnviado)), 'Ateno', mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
    MensagemSistema('Preencha os campos cProdANVISA, xMotivoIsencao e rastro, da Aba TAGs, no cadastro do produto ' + ItemRejeicao(sRetorno, XmlEnviado)
                    ,msgAtencao);
  end;
end;

function LoadXmlDestinatarioSaida(aChaveNFe: String): WideString;
Var
 _file : TStringList;
begin
  //
  _file := TStringList.Create;
  //
  try
    if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml')) then
    begin
      _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml'));
      Result := _file.Text;
    end else
    begin
      if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml')) then
      begin
        _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml'));
        Result := _file.Text;
      end else
      begin
        if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml')) then
        begin
          _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml'));
          Result := _file.Text;
        end else
        begin
          if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml')) then
          begin
            _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml'));
            Result := _file.Text;
          end else
          begin
            Result := Form7.ibDataSet15NFEXML.AsString;
          end;
        end;
      end;
      //
    end;
  except
    Result := Form7.ibDataSet15NFEXML.AsString;
  end;
  //
  _file.Free;
  //
end;


function LoadXmlDestinatarioEntrada(aChaveNFe: String): WideString;
Var
 _file : TStringList;
begin
  //
  _file := TStringList.Create;
  //
  try
    if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml')) then
    begin
      _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-caneve.xml'));
      Result := _file.Text;
    end else
    begin
      if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml')) then
      begin
        _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-den.xml'));
        Result := _file.Text;
      end else
      begin
        if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml')) then
        begin
          _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '-nfe.xml'));
          Result := _file.Text;
        end else
        begin
          if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml')) then
          begin
            _file.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\' + aChaveNFe + '.xml'));
            Result := _file.Text;
          end else
          begin
            Result := Form7.ibDataSet24NFEXML.AsString;
          end;
        end;
      end;
      //
    end;
  except
    Result := Form7.ibDataSet24NFEXML.AsString;
  end;
  //
  _file.Free;
  //
end;

function TForm7.getEnviarDanfePorEmail: String;
var
  oIni: TIniFile;
begin
  oIni := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  try
    Result := oIni.ReadString('ENVIO','Enviar danfe por e-mail','S');
  finally
    oIni.Free;
  end;
end;

function TForm7.getZiparXML: String;
var
  oIni: TIniFile;
begin
  oIni := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  try
    Result := oIni.ReadString('ENVIO','Zipar XML','N');
  finally
    oIni.Free;
  end;
end;

{Dailon Parisotto (f-7811) 2024-02-14 Inicio}
function RetornaModoOperacaoNFe: TModoOperacao;
const
  // UFs listadas no link: https://www.nfe.fazenda.gov.br/portal/disponibilidade.aspx?versao=0.00&tipoConteudo=P2c98tUpxrI=
  // No final da pagina
  UFsSVCAN = ';AC;AL;AP;CE;DF;ES;MG;PA;PB;PI;RJ;RN;RO;RR;RS;SC;SE;SP;TO;';
  UFsSVCRS = ';AM;BA;GO;MA;MS;MT;PE;PR;';
var
  cUF: String;
begin
  Result := moNormal;

  if Form1.bModoSVC then
  begin
    cUF := Form7.ibDataSet13ESTADO.AsString;
    if cUF = EmptyStr then
      cUF := 'SC';

    if Pos(';' + cUF + ';', UFsSVCAN) > 0 then
    begin
      Result := moSVCAN;
      Exit;
    end;
    if Pos(';' + cUF + ';', UFsSVCRS) > 0 then
    begin
      Result := moSVCRS;
      Exit;
    end;
  end;
end;
{Dailon Parisotto (f-7811) 2024-02-14 Fim}

function ConfiguraNFE : Boolean;
var
  Mais1Ini: TIniFile;
  TipoCertificado : string;
begin
  Form1.ConfiguraCredencialTecnospeed; // Sandro Silva 2022-12-15

//  Aguardando tecnospeed confirmar se propriedade est funcionando como proposta, suporte da tecnospeed informou que pode ter inconsistncia no funcionamento
  Form7.spdNFe.DanfeSettings.MensagemIcmsMonofasico := False; // Sandro Silva 2023-06-13

  if LimpaNumero(Form7.ibDataSet13CGC.AsString) <> '' then
    Form7.spdNFe.CNPJ := LimpaNumero(Form7.ibDataSet13CGC.AsString);

  {Dailon Parisotto (f-7811) 2024-02-14 Inicio

  if Form1.bModoScan then
  begin
    Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHomScan.ini';
    Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProdScan.ini';
  end else
  begin
    if Form1.bModoSVC then
    begin
      Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHomSVC.ini';
      Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProdSVC.ini';
    end else
    begin
      Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHom.ini';
      Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProd.ini';
    end;
  end;

  }

  Form7.spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHom.ini';
  Form7.spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProd.ini';

  Form7.spdNFe.ModoOperacao := RetornaModoOperacaoNFe;

  {Dailon Parisotto (f-7811) 2024-02-14 Fim}

  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');

  {Sandro Silva 2024-01-03- inicio}
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='FILE'            Then Form7.spdNFe.TipoCertificado := spdNFeType.ckFile;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='SMARTCARD'       Then Form7.spdNFe.TipoCertificado := spdNFeType.ckSmartCard;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='ACTIVEDIRECTORY' Then Form7.spdNFe.TipoCertificado := spdNFeType.ckActiveDiretory;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='MEMORY'          Then Form7.spdNFe.TipoCertificado := spdNFeType.ckMemory;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado','File'))='LOCALMACHINE'    Then Form7.spdNFe.TipoCertificado := spdNFeType.ckLocalMachine;
  {
  // F5800 Sugesto da Tecnospeed para quando no existir o tipo de certificado configurado no NFE.ini seja considera '' e no 'File'
  // Executvel com essa alterao ser testado no cliente
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado', ''))='FILE'            Then Form7.spdNFe.TipoCertificado := spdNFeType.ckFile;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado', ''))='SMARTCARD'       Then Form7.spdNFe.TipoCertificado := spdNFeType.ckSmartCard;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado', ''))='ACTIVEDIRECTORY' Then Form7.spdNFe.TipoCertificado := spdNFeType.ckActiveDiretory;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado', ''))='MEMORY'          Then Form7.spdNFe.TipoCertificado := spdNFeType.ckMemory;
  if UpperCase(Mais1Ini.ReadString('NFE','Tipo certificado', ''))='LOCALMACHINE'    Then Form7.spdNFe.TipoCertificado := spdNFeType.ckLocalMachine;
  {Sandro Silva 2024-01-03 fim}

  Form7.sFuso                := Mais1ini.ReadString('NFE' , 'FUSO','');
  if Form7.sFuso = '' then
    Form7.sFuso := DefineFusoHorario(Form1.sAtual+'\nfe.ini', 'NFE', 'FUSO', Form7.ibDataSet13ESTADO.AsString, '', False);
  if Form7.sFuso = FusoHorarioPadrao(Form7.ibDataSet13ESTADO.AsString) then
    Form1.HorarioDeVerao.Checked := False
  else
    Form1.HorarioDeVerao.Checked := True;
  
  Form7.sFormatoDoDanfe      := Mais1Ini.ReadString('DANFE','Formato do DANFE','Retrato');
  Form7.sCNPJContabilidade   := Mais1Ini.ReadString('XML','CNPJ da contabilidade','');

  Form1.sVersaoLayout        := Mais1Ini.ReadString('NFE','Layout','4.00');
  {Sandro Silva 2023-03-14 inicio}
  if Form1.sVersaoLayout <> '4.00' then
  begin
    Mais1Ini.WriteString('NFE','Layout','4.00');
    Form1.sVersaoLayout := '4.00';
  end;
  {Sandro Silva 2023-03-14 fim}
  Form1.sModoDbug            := Mais1Ini.ReadString('NFE','dbug','');
  //
  if Form1.sVersaoLayout = '4.00' then
  begin
    // Altera a Verso do Manual no Componente NFe
    // essa mudana afeta o comportamento do componente quanto 
    // Gerao da Chave de Acesso, Assinatura, Comunicao com SEFAZ, Validao de Esquema
    Form7.spdNFe.TimeOut                      := 60000*3;
    Form7.spdNFe.VersaoManual                 := vm60;
    Form7.spdNFeDataSets.VersaoEsquema        := pl_009k; // Sandro Silva 2023-06-07 pl_009;
    Form7.spdNFe.DiretorioEsquemas            := Form1.sAtual + '\nfe\Esquemas\vm60';
    Form7.spdNFe.DiretorioTemplates           := Form1.sAtual + '\nfe\Templates\vm60';
    Form7.spdNFeDataSets.XMLDicionario        := Form1.sAtual + '\nfe\Templates\vm60\Conversor\NFeDataSets.xml';
  {Sandro Silva 2023-06-07 inicio
    //
  end else
  begin
    //
    // Altera a Verso do Manual no Componente NFe
    // essa mudana afeta o comportamento do componente quanto 
    // Gerao da Chave de Acesso, Assinatura, Comunicao com SEFAZ, Validao de Esquema
    //
    Form7.spdNFe.TimeOut                      := 60000;
    Form7.spdNFe.VersaoManual                 := vm50a;
    Form7.spdNFeDataSets.VersaoEsquema        := pl_008h;
    Form7.spdNFe.DiretorioEsquemas            := Form1.sAtual + '\nfe\Esquemas\vm50a';
    Form7.spdNFe.DiretorioTemplates           := Form1.sAtual + '\nfe\Templates\vm50a';
    Form7.spdNFeDataSets.XMLDicionario        := Form1.sAtual + '\nfe\Templates\vm50a\Conversor\NFeDataSets.xml';
    //
  }
  end;

  try
    Form7.spdNFe.NomeCertificado.Text     := Mais1Ini.ReadString('NFE','Certificado','');
  except
    on E: Exception do
    begin
    end;
  end;

  if AllTrim(UpperCase(Form7.ibDataSet13ESTADO.AsString)) <> '' then
  begin
    Form7.spdNFe.UF := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end else
  begin
    Form7.spdNFe.UF := 'SC';
  end;

  if (Mais1Ini.ReadString('NFE','Ambiente', _cAmbienteHomologacao) <> _cAmbienteHomologacao) and (Mais1Ini.ReadString('NFE','Ambiente',_cAmbienteHomologacao) <> _cAmbienteProducao) then
    Form1.DefineAmbienteNFe(_cAmbienteHomologacao, 'Unit7.ConfiguraNFE');
    
  if Mais1Ini.ReadString('NFE','Ambiente',_cAmbienteHomologacao) = _cAmbienteHomologacao then
    Form1.bHomologacao := True
  else
    Form1.bHomologacao := False;
  if Mais1Ini.ReadString('NFE','Ambiente',_cAmbienteHomologacao) = _cAmbienteHomologacao then
    Form7.spdNFe.Ambiente := spdNFeType.akHomologacao
  else
    Form7.spdNFe.Ambiente := spdNFeType.akProducao;

  if Mais1Ini.ReadString('NFE','Consultar Nfes Emitidas','Sim') = 'Sim' then
    Form1.bConsultarNFesEmitidas := True
  else
    Form1.bConsultarNFesEmitidas := False;

  if Mais1Ini.ReadString('NFE','Consultar Nfes Emitidas','Sim') = 'Sim' then
    Form1.ConsultarNFesemitidas1.Checked := True
  else
    Form1.ConsultarNFesemitidas1.Checked := False;

  Mais1ini.Free;

  if Form7.spdNFe.NomeCertificado.Text = '' then
  begin
    Form1.ConfiguraCredencialTecnospeed;

    Form7.spdNFe.ListarCertificados(frmSelectCertificate.lbList.Items);
  end;

  Form7.spdNFe.DiretorioLog                    := 'log';
  Form7.spdNFe.DiretorioXmlDestinatario        := 'xmldestinatario';
  Form7.spdNFe.DiretorioLogErro                := 'LogErro';
  Form7.spdNFe.DanfeSettings.LogotipoEmitente  := 'LOGONFE.BMP';
  Form7.spdNFe.DanfeSettings.ImprimirDuplicata := False;
  Form7.spdNFe.DiretorioTemporario             := Form1.sAtual;

  Form7.spdNFe.DanfeSettings.ModeloRetrato             := Form1.sAtual + '\nfe\Templates\vm60\danfe\Retrato.rtm';
  Form7.spdNFe.DanfeSettings.ModeloPaisagem            := Form1.sAtual + '\nfe\Templates\vm60\danfe\paisagem.rtm';
  Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento := Form1.sAtual + '\nfe\Templates\vm60\danfe\RetratoCanc.rtm';
  Form7.spdNFe.DanfeSettings.ModeloDanfeSimplificado   := Form1.sAtual + '\nfe\Templates\vm60\danfe\RetratoSimplificado.rtm';
  Form7.spdNFe.DanfeSettings.ModeloDanfeXmlResumo      := Form1.sAtual + '\nfe\Templates\vm60\danfe\Resumo.rtm';
  Form7.spdNFe.DanfeSettings.ModeloRTMCCe              := Form1.sAtual + '\nfe\Templates\cce\Impressao\modeloCCe.rtm';

  {Mauricio Parizotto 2024-02-22 Inicio}
  if AnsiContainsText(Copy(Form7.spdNFe.NomeCertificado.Text,pos('OU=',Form7.spdNFe.NomeCertificado.Text),18),'A1') then
    TipoCertificado := 'A1';

  if AnsiContainsText(Copy(Form7.spdNFe.NomeCertificado.Text,pos('OU=',Form7.spdNFe.NomeCertificado.Text),18),'A3') then
    TipoCertificado := 'A3';

  try
    if TipoCertificado <> '' then
    begin
      TSistema.GetInstance.CertificadoDtVal := Form7.spdNFe.GetVencimentoCertificado;
      TSistema.GetInstance.CertificadoTipo  := TipoCertificado;
    end;
  except
  end;
  {Mauricio Parizotto 2024-02-22 Fim}

  Result := True;
end;

function TForm7.TestarNFeHomologacao: Boolean;
var
  oArqDat: TArquivosDAT;
begin
  oArqDat := TArquivosDAT.Create(Usuario);
  try
    Result := (oArqDat.NFe.NFE.Ambiente = tanfHomologacao);
  finally
    FreeAndNil(oArqDat);
  end;
end;

function TForm7.TestarNFSeHomologacao: Boolean;
var
  oArqDat: TArquivosDAT;
begin
  oArqDat := TArquivosDAT.Create(Usuario);
  try
    Result := (oArqDat.NFSe.NFSE.Ambiente = tanfsHomologacao);
  finally
    FreeAndNil(oArqDat);
  end;
end;

function ConsultaCadastro(sP1: String) : String;
var
  Mais1ini : tIniFile;
  sEstado, sM, sRetorno : String;
  Hora, Min, Seg, cent : Word;
  tInicio : tTime;
  I : Integer;
begin
  ConfiguraNFE;
  Form7.spdNFe.Ambiente := spdNFeType.akProducao;

  sM := '';
  tInicio := Time;

  sRetorno    := '';

  if Length(Limpanumero(xmlNodeValue(sRetorno,'//CEP'))) <> 8 then
  begin
    Mais1ini := TIniFile.Create(Form7.spdNFe.ArquivoServidoresProd);

    for I := 1 to 28 do
    begin
      sEstado := AllTrim(Copy(AllTrim(UpperCase(Form7.ibDataSet13ESTADO.AsString))+'SCSPRSACALAMAPBACEDFESGOMAMGMSMTPAPBPEPIPRRJRNRORRSETO      ',(I*2)-1,2));

      if sEstado <> '' then
      begin
        if Length(Limpanumero(xmlNodeValue(sRetorno,'//CEP'))) <> 8 then
        begin
          try
            if Length(LimpaNumero(sP1)) = 14 then
            begin
              sRetorno := Form7.spdNFe.ConsultarCadastro(LimpaNumero(sP1),'CNPJ',sEstado);
            end else
            begin
              sRetorno := Form7.spdNFe.ConsultarCadastro(LimpaNumero(sP1),'CPF',sEstado);
            end;
          except

          end;
        end;

        DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
        sM := sM + Form1.sVersaoLayout + sEstado+': '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0)+chr(10);
        tInicio := Time;
      end;
    end;

    mais1ini.Free;
  end;

  ConfiguraNFE;
  Result := sRetorno;
end;

function DistribuicaoNFe2(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  if AllTrim(sP1) = '' then sP1 := Form1.sAtual;
  if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
  begin
    //ShowMessage('Recuperando XML da pasta \log'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Recuperando XML da pasta \log');
    Form7.ibDataSet15.Edit;
    Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
    Form7.ibDataSet15.Post;
  end;

  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(sP1+'\XML');
    
    Form7.fNFe := Form7.ibDataSet15NFEXML.AsString;

    if (Pos('>Cancelamento</descEvento>',Form7.ibDataSet15NFEXML.AsString) <> 0) then
    begin
      AssignFile(F,pChar(sP1 + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    end else
    begin
      AssignFile(F,pChar(sP1 + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    end;

    Rewrite(F);                  // Abre para gravao
    WriteLn(F,Form7.fNFe);
    CloseFile(F); // Fecha o arquivo
  except
  end;

  Result := True;
end;


function DistribuicaoNFe(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0) and (Pos('<procEventoNFe',Form7.ibDataSet15NFEXML.AsString) = 0) then
  begin
    Form7.ibDataSet15.Edit;
    Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
    Form7.ibDataSet15.Post;
  end;
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(Form1.sAtual+'\'+sP1);
    //
    if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) <> 0) or (Pos('<procEventoNFe',Form7.ibDataSet15NFEXML.AsString) <> 0) then
    begin
      //
      Form7.fNFe := Form7.ibDataSet15NFEXML.AsString;
      //
      if (Pos('>Cancelamento</descEvento>',Form7.ibDataSet15NFEXML.AsString) <> 0) then
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end else
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end;
      //
      Rewrite(F);                  // Abre para gravao
      WriteLn(F,Form7.fNFe);
      CloseFile(F); // Fecha o arquivo
      //
    end;
    //
  except end;
  //
  Result := True;
  //
end;


function DistribuicaoNFEInutilizada(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(Form1.sAtual+'\'+sP1);
    //
    Form7.fNFe := Form7.IBQuery99.FieldByname('XML').AsString;
    AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.IBQuery99.FieldByname('REGISTRO').AsString+'-inutilizada.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                  // Abre para gravao
    WriteLn(F,Form7.fNFe);
    CloseFile(F); // Fecha o arquivo
    //
  except end;
  //
  Result := True;
  //
end;


function DistribuicaoNFeCompra(sP1: String) : Boolean;
var
  F : TExtfile;
begin
  //
  Result := False;
  //
  if (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) = 0) and (Pos('<procEventoNFe',Form7.ibDataSet24NFEXML.AsString) = 0) then
  begin
    Form7.ibDataSet24.Edit;
    Form7.ibDataSet24NFEXML.AsString := LoadXmlDestinatarioEntrada(Form7.ibDataSet24NFEID.AsString); // COVID19
    Form7.ibDataSet24.Post;
  end;
  //
  try
    // ------------------------------------------ //
    // Cria um diretrio com uma cpias dos dados //
    // ------------------------------------------ //
    ForceDirectories(Form1.sAtual+'\'+sP1);
    //
    if (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) <> 0) or (Pos('<procEventoNFe',Form7.ibDataSet24NFEXML.AsString) <> 0) then
    begin
      //
      Form7.fNFe := Form7.ibDataSet24NFEXML.AsString;
      //
      if (Pos('>Cancelamento</descEvento>',Form7.ibDataSet24NFEXML.AsString) <> 0) then
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet24NFEID.AsString+'-caneve.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end else
      begin
        AssignFile(F,pChar(Form1.sAtual+'\'+sP1+'\'+Form7.ibDAtaSet24NFEID.AsString+'-nfe.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      end;
      //
      Rewrite(F);                  // Abre para gravao
      WriteLn(F,Form7.fNFe);
      CloseFile(F); // Fecha o arquivo
      //
      Result := True;
      //
    end;
    //
  except end;
  //
  //
end;


function AssinaturaDigital(sP1:String): String;
begin
  Result := TAssinaturaDigital.New
                              .AssinarArquivo(sP1);
end;

function Audita(pP1, pP2, pP3, pP4 : String; pP5, pP6: Double) : Boolean;
var
  sRegistro : String;
begin
  try
    try
      Form7.ibDataSet100.Close;
      Form7.ibDataSet100.SelectSql.Clear;
      Form7.ibDataset100.SelectSql.Add('select gen_id(G_AUDIT0RIA,1) from rdb$database');
      Form7.ibDataset100.Open;
    except
      //ShowMessage('Erro na tabela de auditoria. Cod. 1'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro na tabela de auditoria. Cod. 1',msgErro);
    end;

    sRegistro := '1'+StrZero(StrToInt(Form7.ibDataSet100.FieldByname('GEN_ID').AsString),9,0);
    Form7.ibDataset100.Close;
    
    Form7.ibDataSet100.Close;
    Form7.ibDataSet100.SelectSql.Clear;
    Form7.ibDataSet100.SelectSql.Add('insert into AUDIT0RIA (ATO, MODULO, USUARIO, HISTORICO, VALOR_DE, VALOR_PARA, DATA, HORA, REGISTRO) values('
            +QuotedStr(pP1)+', '
            +QuotedStr(pP2)+', '
            +QuotedStr(pP3)+', '
            +QuotedStr(pP4)+', '
            +QuotedStr(StrTran(StrZero(pP5,10,2),',','.'))+', '
            +QuotedStr(StrTran(StrZero(pP6,10,2),',','.'))+', '
            +QuotedStr(DateToStrInvertida(Date))+', '
            +QuotedStr(TimeToStr(Time))+', '
            +QuotedStr(sRegistro)+')');

    Form7.ibDataSet100.Open;
  except
    //ShowMessage('Erro na tabela de auditoria. Cod. 2'+chr(10)+chr(10)+Form7.ibDataSet100.SelectSql.Text); Mauricio Parizotto 2023-10-25
    MensagemSistema('Erro na tabela de auditoria. Cod. 2'+chr(10)+chr(10)+Form7.ibDataSet100.SelectSql.Text,msgErro);
  end;

  Result := True;
end;


function DefineJanela(bP1 : Boolean) : Boolean;
begin
  Form7.DbGrid1.Top    := 110-15;
  Form7.DbGrid1.Left   := 10;
  Form7.dbGrid1.Width  := Form1.Width - 30;
  Form7.dbGrid1.Height := Form7.Height - Form7.DbGrid1.Top - 60 -26;
  Form7.Panel7.Visible := True;

  if (Form7.sModulo='CONFOS') or (Form7.sModulo='CONFRECIBO') or (Form7.sModulo = 'NOTA') then
  begin
    Form7.DbGrid1.Top     := 0;
    Form7.DbGrid1.Left    := 10;
    Form7.DbGrid1.Width   := 400;
    Form7.DbGrid1.Height  := Form7.Height - Form7.DbGrid1.Top - 60 -26 - 105;
    Form7.Panel7.Visible  := False;
    Form7.Panel_0.Visible := False;
    Form7.Width           := 410;
    Form7.Panel4.Visible  := False;
    Form1.Panel_3.Visible := False;
  end else
  begin
    Form7.Panel_0.Visible := True;
    {Dailon Parisotto (f-7757) 2023-01-03 Inicio}
    Form7.Width  := Form1.Width;
    {$IFDEF VER150}
    Form7.Width  := Form7.Width - 6;
    {$ENDIF}
    {Dailon Parisotto (f-7757) 2023-01-03 Fim}
    Form7.Panel4.Visible  := True;
    Form1.Panel_3.Visible := True;
  end;
  
  Result := True;
end;


function Altura(MM : Double) : Longint;
var
  mmPointY : Real;
  PageSize, OffSetUL : TPoint;
begin
  mmPointY := Printer.PageHeight / GetDeviceCaps(Printer.Handle,VERTSIZE);
  Escape (Printer.Handle,GETPRINTINGOFFSET,0,nil,@OffSetUL);
  Escape (Printer.Handle,GETPHYSPAGESIZE,0,nil,@PageSize);
  if MM > 0 then Result := round ((MM * mmPointY) - OffSetUL.Y) else Result := round (MM * mmPointY);
end;

function Largura(MM: Double) : Longint;
var
  mmPointX : Real;
  PageSize, OffSetUL: TPoint;
begin
  mmPointX := Printer.PageWidth / GetDeviceCaps(Printer.Handle,HORZSIZE);
  Escape (Printer.Handle,GETPRINTINGOFFSET,0,nil,@OffSetUL);
  Escape (Printer.Handle,GETPHYSPAGESIZE,0,nil,@PageSize);
  if MM > 0 then Result := round ((MM * mmPointX) - OffSetUL.X) else Result := round (MM * mmPointX);
end;

function AgendaCommit(P1: Boolean): Boolean;
begin
  try
    if P1 then
    begin
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,1) from rdb$database');
      Form7.ibDataset101.Open;
    end else
    begin
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,-1) from rdb$database');
      Form7.ibDataset101.Open;
    end;
  except end;
  //
  Result := True;
  //
end;

function Commitatudo(RefazSelect:Boolean): Boolean;
begin
  // bFechaTudo s  usado para incluir novos produtos e novos fornecedores na NF, COMPRA e OF
  if Form7.sModulo = 'COMPRA' then
  begin
    Form7.ibDataSet1.BufferChunks  := 500;
    Form7.ibDataSet27.BufferChunks := 500;
    Form7.ibDataSet25.BufferChunks := 500;
    Form7.ibDataSet21.BufferChunks := 500;
    Form7.ibDataSet10.BufferChunks := 500;
    Form7.ibDataSet30.BufferChunks := 500;
    Form7.ibDataSet28.BufferChunks := 500;
    Form7.ibDataSet19.BufferChunks := 500;
    Form7.ibDataSet18.BufferChunks := 500;
    Form7.ibDataSet16.BufferChunks := 500;
    Form7.ibDataSet15.BufferChunks := 500;
    Form7.ibDataSet23.BufferChunks := 500;
    Form7.ibDataSet24.BufferChunks := 500;
    Form7.ibDataSet35.BufferChunks := 500;
    Form7.ibDataSet13.BufferChunks := 500;
    Form7.ibDataSet14.BufferChunks := 500;
    Form7.ibDataSet11.BufferChunks := 500;
    Form7.ibDataSet26.BufferChunks := 500;
    Form7.ibDataSet9.BufferChunks  := 500;
    Form7.ibDataSet29.BufferChunks := 500;
    Form7.ibDataSet12.BufferChunks := 500;
    Form7.ibDataSet8.BufferChunks  := 500;
    Form7.ibDataSet7.BufferChunks  := 500;
    Form7.ibDataSet2.BufferChunks  := 500;
    Form7.ibDataSet3.BufferChunks  := 500;
    Form7.ibDataSet4.BufferChunks  := 500;
    Form7.ibDataSet5.BufferChunks  := 500;
    Form7.ibDataSet6.BufferChunks  := 500;
    Form7.ibdConversaoCFOP.BufferChunks  := 500; //Mauricio Parizotto 2023-08-25
    Form7.ibdPerfilTributa.BufferChunks  := 500; //Mauricio Parizotto 2023-08-30
    Form7.ibdParametroTributa.BufferChunks  := 500; //Mauricio Parizotto 2023-09-21
    Form7.ibdSituacaoOS.BufferChunks  := 500; //Mauricio Parizotto 2023-12-04
  end else
  begin
    Form7.ibDataSet1.BufferChunks  := 1000;
    Form7.ibDataSet27.BufferChunks := 1000;
    Form7.ibDataSet25.BufferChunks := 1000;
    Form7.ibDataSet21.BufferChunks := 1000;
    Form7.ibDataSet10.BufferChunks := 1000;
    Form7.ibDataSet30.BufferChunks := 1000;
    Form7.ibDataSet28.BufferChunks := 1000;
    Form7.ibDataSet19.BufferChunks := 1000;
    Form7.ibDataSet18.BufferChunks := 1000;
    Form7.ibDataSet16.BufferChunks := 1000;
    Form7.ibDataSet15.BufferChunks := 1000;
    Form7.ibDataSet23.BufferChunks := 1000;
    Form7.ibDataSet24.BufferChunks := 1000;
    Form7.ibDataSet35.BufferChunks := 1000;
    Form7.ibDataSet13.BufferChunks := 1000;
    Form7.ibDataSet14.BufferChunks := 1000;
    Form7.ibDataSet11.BufferChunks := 1000;
    Form7.ibDataSet26.BufferChunks := 1000;
    Form7.ibDataSet9.BufferChunks  := 1000;
    Form7.ibDataSet29.BufferChunks := 1000;
    Form7.ibDataSet12.BufferChunks := 1000;
    Form7.ibDataSet8.BufferChunks  := 1000;
    Form7.ibDataSet7.BufferChunks  := 1000;
    Form7.ibDataSet2.BufferChunks  := 1000;
    Form7.ibDataSet3.BufferChunks  := 1000;
    Form7.ibDataSet4.BufferChunks  := 1000;
    Form7.ibDataSet5.BufferChunks  := 1000;
    Form7.ibDataSet6.BufferChunks  := 1000;
    Form7.ibdConversaoCFOP.BufferChunks  := 1000; //Mauricio Parizotto 2023-08-25
    Form7.ibdPerfilTributa.BufferChunks  := 1000; //Mauricio Parizotto 2023-08-30
    Form7.ibdParametroTributa.BufferChunks  := 1000; //Mauricio Parizotto 2023-09-21
    Form7.ibdSituacaoOS.BufferChunks  := 1000; //Mauricio Parizotto 2023-12-04
  end;

  if Form1.bFechaTudo then
  begin
    // s commitatudo se houve realmente uma alterao no GDB - Talvs controlar com um generator
    // criar uma varivel com um numero de 0 a 9999999999 cada vez que alterar o GDB incrementa
    // este generator depois confere com a variavel se nao  a mesma commita.
    // Sonhei isso e tenho certeza que funciona
    Form7.ibDataSet101.Close;
    Form7.ibDataSet101.SelectSql.Clear;
    if RefazSelect then
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,1) from rdb$database')
    else
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,0) from rdb$database');

    Form7.ibDataset101.Open;

    if Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat > 9999999999 then
    begin
      Form7.ibDataset100.Close;
      Form7.ibDataset100.SelectSql.Clear;
      Form7.ibDataset100.SelectSql.Add('set generator G_MUTADO to 0');
      Form7.ibDataset100.Open;
    end;

    if (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat <> Form7.fMutado) then // or (Form7.ibDataSet100.FieldByname('GEN_ID').AsFloat = 0) then
    begin
      Form7.fMutado := Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat;
      Form7.ibDataSet4.Disablecontrols;

      try
        if Form7.IBTransaction1.Active then
          Form7.IBTransaction1.Commit;
      except
        on e:exception do
        begin
          LogSistema('Commitatudo 5222 '+e.Message);
          MensagemSistema('Falha na conexo com o Banco de Dados. Erro 1848',msgErro);
        end;
      end;

      try
        HasHs('ESTOQUE',True);
        HasHs('REDUCOES',True);
        HasHs('PAGAMENT',True);
        HasHs('ALTERACA',True);
        HasHs('DEMAIS',True);
        HasHs('VENDAS',True);
        HasHs('ITENS001',True);
        HasHs('ORCAMENT',True);
      except
      end;

      if RefazSelect then
      begin
        Form7.ibDataSet1.Selectsql.Clear;
        Form7.ibDataSet27.Selectsql.Clear;
        Form7.ibDataSet25.Selectsql.Clear;
        Form7.ibDataSet21.Selectsql.Clear;
        Form7.ibDataSet10.Selectsql.Clear;
        Form7.ibDataSet30.Selectsql.Clear;
        Form7.ibDataSet28.Selectsql.Clear;
        Form7.ibDataSet19.Selectsql.Clear;
        Form7.ibDataSet18.Selectsql.Clear;
        Form7.ibDataSet16.Selectsql.Clear;
        Form7.ibDataSet15.Selectsql.Clear;
        Form7.ibDataSet23.Selectsql.Clear;
        Form7.ibDataSet24.Selectsql.Clear;
        Form7.ibDataSet35.Selectsql.Clear;
        Form7.ibDataSet13.Selectsql.Clear;
        Form7.ibDataSet14.Selectsql.Clear;
        Form7.ibDataSet11.Selectsql.Clear;
        Form7.ibDataSet26.Selectsql.Clear;
        Form7.ibDataSet9.Selectsql.Clear;
        Form7.ibDataSet29.Selectsql.Clear;
        Form7.ibDataSet12.Selectsql.Clear;
        Form7.ibDataSet8.Selectsql.Clear;
        Form7.ibDataSet7.Selectsql.Clear;
        Form7.ibDataSet2.Selectsql.Clear;
        Form7.ibDataSet3.Selectsql.Clear;
        Form7.ibDataSet4.Selectsql.Clear;
        Form7.ibDataSet5.Selectsql.Clear;
        Form7.ibDataSet6.Selectsql.Clear;
        Form7.ibdConversaoCFOP.Selectsql.Clear; //Mauricio Parizotto 2023-08-25
        Form7.ibdPerfilTributa.Selectsql.Clear; //Mauricio Parizotto 2023-08-30
        Form7.ibdParametroTributa.Selectsql.Clear; //Mauricio Parizotto 2023-09-21
        Form7.ibdSituacaoOS.Selectsql.Clear; //Mauricio Parizotto 2023-12-04

        Form7.ibDataSet1.Selectsql.Add('select * from CAIXA where DATA=CURRENT_DATE order by DATA, REGISTRO');
        Form7.ibDataSet27.Selectsql.Add('select * from ALTERACA where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet25.Selectsql.Add('select * from FLUXO order by DATA');
        Form7.ibDataSet21.Selectsql.Add('select * from GRUPO');
        Form7.ibDataSet10.Selectsql.Add('select * from GRADE');
        Form7.ibDataSet30.Selectsql.Add('select * from SERIE');
        Form7.ibDataSet28.Selectsql.Add('select * from COMPOSTO');
        Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=1 order by ((LINHA * 1000) + COLUNA)');
        Form7.ibDataSet18.Selectsql.Add('select * from TRANSPOR order by upper(NOME)');
        Form7.ibDataSet16.Selectsql.Add('select * from ITENS001 where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet15.Selectsql.Add('select * from VENDAS where EMISSAO=CURRENT_DATE ');
        Form7.ibDataSet23.Selectsql.Add('select * from ITENS002 where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet24.Selectsql.Add('select * from COMPRAS where EMISSAO=CURRENT_DATE ');
        Form7.ibDataSet35.Selectsql.Add('select * from ITENS003 where CODIGO='+QuotedStr('99999')+' ');
        Form7.ibDataSet13.Selectsql.Add('select * from EMITENTE');
        Form7.ibDataSet14.Selectsql.Add('select * from ICM order by CFOP');
        Form7.ibDataSet11.Selectsql.Add('select * from BANCOS');
        Form7.ibDataSet26.Selectsql.Add('select * from RESUMO order by DATA, REGISTRO');
        Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR');
        Form7.ibDataSet29.Selectsql.Add('select * from CONVENIO');
        Form7.ibDataSet12.Selectsql.Add('select * from CONTAS order by NOME');
        Form7.ibDataSet8.Selectsql.Add('select * from PAGAR where EMISSAO=CURRENT_DATE');
        Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where EMISSAO=CURRENT_DATE');
        Form7.ibDataSet3.Selectsql.Add('select * from OS where DATA=CURRENT_DATE ');
        Form7.ibDataSet5.Selectsql.Add('select * from MOVIMENT where NOME='+quotedStr('XXXXXXXXXX')+'');
        Form7.ibDataSet6.Selectsql.Add('select * from CODEBAR where CODIGO=''99999'' ');
        Form7.ibdConversaoCFOP.Selectsql.Add('Select * From CFOPCONVERSAO'); //Mauricio Parizotto 2023-08-25
        Form7.ibdPerfilTributa.Selectsql.Add('Select * From PERFILTRIBUTACAO'); //Mauricio Parizotto 2023-08-30
        Form7.ibdParametroTributa.Selectsql.Add(' Select'+
                                                '  PR.*,'+
                                                '  PF.DESCRICAO'+
                                                ' From PARAMETROTRIBUTACAO PR'+
                                                '  Left Join PERFILTRIBUTACAO PF on PF.IDPERFILTRIBUTACAO = PR.IDPERFILTRIBUTACAO'); //Mauricio Parizotto 2023-09-21
        Form7.ibdSituacaoOS.SelectSQL.Add('Select * From OSSITUACAO'); //Mauricio Parizotto 2023-12-04

        //  CAIXA
        //  ICM
        //  NOTA
        //  TRANSPORT
        //  CONTAS
        //  LIMPA
        //  VENDEDOR
        //  GRUPOS
        //  CONVENIO
        //  CLIENTES
        //  ESTOQUE
        //  BANCOS
        //  BACKUP
        //  CONFIG
        //  CONFOS
        //  CONFRECIBO
        //  RECEBER
        //  PAGAR
        //  OS
        //  VENDA
        //  COMPRA
        //  TECNICO
        //
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO=''99999'' order by upper(DESCRICAO)');
        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where nome = ''X.X.X.X.X.X.'' order by upper(NOME)');
      end;

      Form7.ibDataSet4.EnableControls; // Sandro Silva 2023-03-29
    end;
  end;

  Result := True;
end;

function AbreArquivos(P1:Boolean): Boolean;
begin
  try
    if not Form7.ibDataSet13.active then Form7.ibDataSet13.active := True;
    if not Form7.ibDataSet25.active then Form7.ibDataSet25.active := True;
    if not Form7.ibDataSet28.active then Form7.ibDataSet28.active := True;
    if not Form7.ibDataSet19.active then Form7.ibDataSet19.active := True;
    if not Form7.ibDataSet18.active then Form7.ibDataSet18.active := True;
    if not Form7.ibDataSet14.active then Form7.ibDataSet14.active := True;
    if not Form7.ibDataSet11.active then Form7.ibDataSet11.active := True;
    if not Form7.ibDataSet26.active then Form7.ibDataSet26.active := True;
    if not Form7.ibDataSet9.active  then Form7.ibDataSet9.active  := True;
    if not Form7.ibDataSet29.active then Form7.ibDataSet29.active := True;
    if not Form7.ibDataSet39.active then Form7.ibDataSet39.active := True;
    if not Form7.ibDataSet49.active then Form7.ibDataSet49.active := True;
    if not Form7.ibDataSet12.active then Form7.ibDataSet12.active := True;
    if not Form7.ibDataSet2.active  then Form7.ibDataSet2.active  := True;
    if not Form7.ibDataSet3.active  then Form7.ibDataSet3.active  := True;
    if not Form7.ibDataSet1.active  then Form7.ibDataSet1.active  := True;
    if not Form7.ibDataSet27.active then Form7.ibDataSet27.active := True;
    if not Form7.ibDataSet21.active then Form7.ibDataSet21.active := True;
    if not Form7.ibDataSet10.active then Form7.ibDataSet10.active := True;
    if not Form7.ibDataSet30.active then Form7.ibDataSet30.active := True;
    if not Form7.ibDataSet16.active then Form7.ibDataSet16.active := True;
    if not Form7.ibDataSet15.active then Form7.ibDataSet15.active := True;
    if not Form7.ibDataSet23.active then Form7.ibDataSet23.active := True;
    if not Form7.ibDataSet24.active then Form7.ibDataSet24.active := True;
    if not Form7.ibDataSet35.active then Form7.ibDataSet35.active := True;
    if not Form7.ibDataSet8.active  then Form7.ibDataSet8.active  := True;
    if not Form7.ibDataSet7.active  then Form7.ibDataSet7.active  := True;
    if not Form7.ibDataSet4.active  then Form7.ibDataSet4.active  := True;
    if not Form7.ibDataSet5.active  then Form7.ibDataSet5.active  := True;
    if not Form7.ibDataSet6.active  then Form7.ibDataSet6.active  := True;
    if not Form7.ibdConversaoCFOP.active  then Form7.ibdConversaoCFOP.active  := True; //Mauricio Parizotto 2023-08-25
    if not Form7.ibdPerfilTributa.active  then Form7.ibdPerfilTributa.active  := True; //Mauricio Parizotto 2023-08-30
    if not Form7.ibdParametroTributa.active  then Form7.ibdParametroTributa.active  := True; //Mauricio Parizotto 2023-09-21
    if not Form7.ibdSituacaoOS.active  then Form7.ibdSituacaoOS.active  := True; //Mauricio Parizotto 2023-12-04
  except
    on E: Exception do
    begin
      {
      Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'Ao abrir arquivos.'
                          ),'Erro: 5179',mb_Ok + MB_ICONWARNING);
      Mauricio Parizotto 2023-10-24}

      MensagemSistema(E.Message+chr(10)+chr(10)+'Ao abrir arquivos.'
                      +#13#10+'Erro: 5179'
                      ,msgErro);

      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE );
      Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      FecharAplicacao(ExtractFileName(Application.ExeName)); // Sandro Silva 2024-01-04
      Abort;
    end;
  end;

  if p1 then
  begin
    if Form7.ibDataSet1.Active then Form7.ibDataSet1.EnableControls;
    if Form7.ibDataSet27.Active then Form7.ibDataSet27.EnableControls;
    if Form7.ibDataSet25.Active then Form7.ibDataSet25.EnableControls;
    if Form7.ibDataSet21.Active then Form7.ibDataSet21.EnableControls;
    if Form7.ibDataSet10.Active then Form7.ibDataSet10.EnableControls;
    if Form7.ibDataSet30.Active then Form7.ibDataSet30.EnableControls;
    if Form7.ibDataSet28.Active then Form7.ibDataSet28.EnableControls;
    if Form7.ibDataSet19.Active then Form7.ibDataSet19.EnableControls;
    if Form7.ibDataSet18.Active then Form7.ibDataSet18.EnableControls;
    if Form7.ibDataSet15.Active then Form7.ibDataSet15.EnableControls;
    if Form7.ibDataSet23.Active then Form7.ibDataSet23.EnableControls;
    if Form7.ibDataSet24.Active then Form7.ibDataSet24.EnableControls;
    if Form7.ibDataSet35.Active then Form7.ibDataSet35.EnableControls;
    if Form7.ibDataSet13.Active then Form7.ibDataSet13.EnableControls;
    if Form7.ibDataSet14.Active then Form7.ibDataSet14.EnableControls;
    if Form7.ibDataSet11.Active then Form7.ibDataSet11.EnableControls;
    if Form7.ibDataSet26.Active then Form7.ibDataSet26.EnableControls;
    if Form7.ibDataSet9.Active then Form7.ibDataSet9.EnableControls;
    if Form7.ibDataSet29.Active then Form7.ibDataSet29.EnableControls;
    if Form7.ibDataSet39.Active then Form7.ibDataSet39.EnableControls;
    if Form7.ibDataSet49.Active then Form7.ibDataSet49.EnableControls;
    if Form7.ibDataSet12.Active then Form7.ibDataSet12.EnableControls;
    if Form7.ibDataSet8.Active then Form7.ibDataSet8.EnableControls;
    if Form7.ibDataSet7.Active then Form7.ibDataSet7.EnableControls;
    if Form7.ibDataSet2.Active then Form7.ibDataSet2.EnableControls;
    if Form7.ibDataSet3.Active then Form7.ibDataSet3.EnableControls;
    if Form7.ibDataSet4.Active then Form7.ibDataSet4.EnableControls;
    if Form7.ibDataSet5.Active then  Form7.ibDataSet5.EnableControls;
    if Form7.ibdConversaoCFOP.Active then  Form7.ibdConversaoCFOP.EnableControls; // Mauricio Parizotto 2023-08-25
    if Form7.ibdPerfilTributa.Active then  Form7.ibdPerfilTributa.EnableControls; // Mauricio Parizotto 2023-08-30
    if Form7.ibdParametroTributa.Active then  Form7.ibdParametroTributa.EnableControls; // Mauricio Parizotto 2023-09-21
    if Form7.ibdSituacaoOS.Active then  Form7.ibdSituacaoOS.EnableControls; // Mauricio Parizotto 2023-12-04
  end;
  
  Result := True;
end;

function TraduzSql(P1: String;P2 :Boolean; AoDataSet: TIBDataSet = nil): String;
var
  I : Integer;
begin
  if not Assigned(AoDataSet) then
    AoDataSet := Form7.TabelaAberta;

  P1 := StrTran(P1,'COALESCE(ATIVO,0)=0', 's ativos');
  P1 := StrTran(P1,'COALESCE(ATIVO,0)=1', 's inativos');

  //Mauricio Parizotto 2023-08-22
  //Oramento
  P1 := StrTran(P1,'where COALESCE(ORCAMENTS.NUMERONF,'''') = '''' ', 's pendentes');
  P1 := StrTran(P1,'where COALESCE(ORCAMENTS.NUMERONF,'''') <> '''' ', 's finalizados');
  P1 := StrTran(P1,'ORCAMENTS.', '');


  P1 := StrTran(P1,'Coalesce', '');
  P1 := StrTran(P1, QuotedStr('~'),'');
  P1 := StrTran(P1,'PEDIDO', 'oramento');
  P1 := StrTran(P1,'REGISTRO', 'Lanamento');
  P1 := StrTran(P1,'IDSITUACAO', 'Cdigo'); // Mauricio Parizotto 2023-12-04
  P1 := StrTran(P1,'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+'', ' s clientes ');
  P1 := StrTran(P1,'where coalesce(CLIFOR,'+QuotedStr('F')+')='+QuotedStr('F')+'', ' s fornecedores ');

  P1 := StrTran(P1,'Coalesce(VALOR_RECE,0)=0', ' a receber ');

  P1 := StrTran(P1,' IE', ' Inscrio');
  P1 := StrTran(P1,'(IE)', ' Inscrio');

  if Copy(AoDataSet.SelectSQL.Text,1,12)='select first' then
    P1 := StrTran(P1, 'Listando' ,'Mostrando os ltimos '+Form7.sMaxReg+' registros' );

  P1 := StrTran(P1,' and EMITIDA='+QuotedStr('X'), ', canceladas ');
  P1 := StrTran(P1,' and EMITIDA<>'+QuotedStr('S')+' and EMITIDA<>'+QuotedStr('X'), ', no impressas ');
  P1 := StrTran(P1, '(select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0)<>0',' clientes com contas a receber ');
  P1 := StrTran(P1, '(select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)<>0',' clientes com contas atrasadas ');
  P1 := StrTran(P1, '(select Coalesce(sum(VALOR_DUPL),0) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)=0',' clientes com contas em dia ');
  
  P1 := StrTran(P1,'substring(DATANAS from 6 for 5)', ' aniverssrio ');
  P1 := StrTran(P1, 'MOSTRAR<>'+QuotedStr('0'),' est atrasado ');
  P1 := StrTran(P1, 'MOSTRAR<>'+QuotedStr('1'),' est em dia ');
  P1 := StrTran(P1,'C='+QuotedStr('R   ')+' ',' no conciliado com o estrato do banco ' );
//  P1 := StrTran(P1, 'ContatoS' ,' Contatos ');
  P1 := StrTran(P1, 'CONTATOS' ,' Contatos ');
  P1 := StrTran(P1, 'order by' ,' e ordenando por ' );
  P1 := StrTran(P1, 'group by' ,' e agrupado por ' );
  P1 := StrTran(P1, 'CURRENT_DATE' ,' data de hoje ' );
  P1 := StrTran(P1, 'where' ,' s quando ' );
  P1 := StrTran(P1, '='     ,' igual a '  );
  P1 := StrTran(P1, '<>'    ,' diferente '  );
  P1 := StrTran(P1, '>'     ,' maior que '  );
  P1 := StrTran(P1, '<'     ,' menor que '  );
  P1 := StrTran(P1, 'like'  ,' com '    );
  P1 := StrTran(P1, 'upper' ,'');
  P1 := StrTran(P1, ' and ' ,' e '      );
  P1 := StrTran(P1, ' not ' ,' no '    );
  P1 := StrTran(P1, '(' ,'');
  P1 := StrTran(P1, ')' ,'');
  P1 := StrTran(P1, '%' ,'');
  P1 := StrTran(P1, '  ' ,' ');
  P1 := StrTran(P1, 's quando s' ,'s');

  for I := 1 to AoDataSet.FieldCount do
  begin
    if AoDataSet.Fields[I-1].FieldName <> AoDataSet.Fields[I-1].DisplayLabel then
    begin
      if (AoDataSet.Fields[I-1].FieldName <> 'IPI')
        and (copy(AoDataSet.Fields[I-1].FieldName,1,3) <> 'CST') then
      begin
        P1 := StrTran(P1,' '+AoDataSet.Fields[I-1].FieldName,' '+AoDataSet.Fields[I-1].DisplayLabel);
      end;
    end;
  end;

  //Mauricio Parizotto 2023-08-22 Oramento no usa campos do dataset
  P1 := StrTran(P1, 'CLIFOR' ,'Cliente' );
  P1 := StrTran(P1, 'NUMERONF' ,'Doc. Fiscal');

  Result := P1;
end;


function ImprimeOuNaoANota(pP1:Boolean):Boolean;
var
  vLinha: array [0..200]  of String;  // Cria uma matriz com 100 elementos
                                      // isso eu aprendi num sonho
  vCampo: array [0..3000] of Variant; // Cria uma matriz com 1000 elementos
  ConfItens, ConfSvc, iPagina, I, J : Integer; // e contedo varivel
  F: TextFile;
  Mais1ini, Mais2Ini: TIniFile;
  bMaisItens  : Boolean;
begin
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
  if (Mais1Ini.ReadString('NFE','Ambiente',_cAmbienteHomologacao) <> _cAmbienteProducao) or (Mais1Ini.ReadString('NFE','Formulario','No') <> 'No') then
  begin
    Mais1ini.Free;

    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';   
    {$ENDIF}

    iPagina         := 72;
    Mais1ini        := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    ConfItens       := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Itens','16'));
    ConfSvc         := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Svc','5'));
    //
    Mais1ini.Free;
    //
    // Relaciona a natureza da operao com o arquivo de vendas
    //
    if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = '' then
      Form7.ibDataSet14.Append
    else
      Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
    //
    // Relaciona os clientes com o arquivo de vendas
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    //
    Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
    Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
    //
    try
      //
      // Verifica se o cliente est cadastrado se a nota tem valor
      //
      if (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') and ((Form7.ibDataSet15TOTAL.AsFloat <> 0) or (Form7.ibDataSet15ICMS.AsFloat <> 0)) then
      begin
        //
        // Abre o arquivo de clientes para edio
        //
        try
          if  Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime then
          begin
            Form7.ibDataSet2.Edit;
            Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
            Form7.ibDataSet2.Post;
          end;
        except
          try
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15LOKED.AsString := 'S';
            Form7.ibDataSet15.Post;
          except end;
        end;
        //
        if Form7.ibDataSet15EMITIDA.AsString = 'S' then
        begin
          I := Application.MessageBox(pChar(
                                    chr(10) +'Esta nota j foi impressa!                   '
                                    +chr(10)+
                                    chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                                    'posicionado.'+Chr(10)+
                                    chr(10)+
                                    'Imprimir a nota fiscal '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' agora?'),
                                    'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        end else
        begin
          I := Application.MessageBox(pChar(chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                                    'posicionado.'+Chr(10)+
                                    chr(10)+
                                    'Imprimir a nota fiscal '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' agora?'),
                                    'Ateno',mb_YesNo + MB_ICONWARNING);
        end;
        //
        if I = 6 then
        begin
          //
          // Incio da impresso da nota
          //
          bMaisItens := True;
          Form7.ibDataSet16.First;
          Form7.ibDataSet35.First;
          //
          while bMaisItens do
          begin
            {                                           }
            { Arquivo de NF indexado por LINHA + COLUNA }
            {                                           }
            Form7.ibDataSet19.Active     := False;
            Form7.ibDataSet19.SelectSQL.Clear;
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then  Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=1 order by ((LINHA * 1000) + COLUNA)');
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then  Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=2 order by ((LINHA * 1000) + COLUNA)');
            Form7.ibDataSet19.Open;
            {                                           }
            { Inicializa todos os elementos dos vetores }
            {                                           }
            for I := 1 to 1300 do vCampo[I] := '';
            for I := 1 to 200  do  vLinha[I] := '';

            //
            // Zera os servicos
            //
            for I := 1 to 50 do
            begin
              vCampo[2150 + I] := '';
              vCampo[2300 + I] := '';
              vCampo[2350 + I] := '';
              vCampo[2400 + I] := '';
              vCampo[2600 + I] := '';
            end;

            //
            // Valores nmericos
            //
            vCampo[020] := '************';   //  20 Base de Clculo do ISS
            vCampo[021] := '************';
            vCampo[022] := '************'; //  22 Valor total do ISS
            vCampo[023] := '************'; //  23 Base de Clculo do ICMS
            vCampo[025] := '************'; //  25 Valor do ICM
            vCampo[026] := '************'; //  26 Base de subst
            vCampo[027] := '************'; //  27 ICMS de Subst
            vCampo[028] := '************'; //  28 Total dos Produtos
            vCampo[029] := '************'; //  29 Valor do frete
            vCampo[030] := '************'; //  30 Seguro
            vCampo[031] := '************'; //  31 Outras despesas
            vCampo[032] := '************'; //  32 Valor total do IPI
            vCampo[033] := '************'; //  33 Valor total da nota
            vCampo[063] := Replicate('x',160);   //  Valor por Extenso
            vCampo[046] := '************'; //  29 Valor do desconto
            vCampo[069] := '************';
            vCampo[085] := '************'; //  Valor total dos produtos
            vCampo[020] := '************'; //  Imposto de renda
            //
            vCampo[034] := '*****************************';   //  34 Transportadora Nome
            vCampo[035] := '*';      //  35 Frete por conta (1 ou 2)
            //
            // Transportadora
            //
            if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
            begin
              vCampo[036] := '*******';      //  36 Placa do veculo
              vCampo[037] := '*******';      //  37 estado do veculo
              vCampo[038] := '*******';      //  38 CGC da tranportadora
              vCampo[039] := '*******';      //  39 Transportadora endereo
              vCampo[040] := '*******';      //  40 Transportadora municpio
              vCampo[041] := '*******';      //  41 Estado da transportadora
              vCampo[042] := '*******';      //  42 IE da transportadora
            end;
            //
            vCampo[043] :=  '*******'; //  43 Quantidade de volumes
            vCampo[044] :=  '*******'; //  44 Espcie de volumes
            vCampo[045] :=  '*******'; //  45 Marca dos volumes
            vCampo[047] :=  '*******'; //  47 Peso bruto
            vCampo[048] :=  '*******'; //  48 Peso liquido
            //
            {                                                      }
            { Atribui o valor a cada elemento conf fonte no dBFAST }
            {                                                      }
            vCampo[001] := Form7.ibDataSet13CGC.Value;        //   1 C.G.C. do Emitente
            vCampo[002] := Form7.ibDataSet15OPERACAO.Value;   //   2 Natureza da operaco
            vCampo[003] := Form7.ibDataSet14CFOP.Value;       //   3 C.F.O.
            vCampo[005] := Form7.ibDataSet13IE.Value;         //   5 I.E. do emitente
            vCampo[007] := Form7.ibDataSet2NOME.Value;        //   7 Razo Social do Destinatrio
            vCampo[008] := Form7.ibDataSet2CGC.Value;         //   8 C.G.C. do Destinatrio
            vCampo[009] := DateTimeToStr(Form7.ibDataSet15EMISSAO.asDateTime); //   9 Data de emisso
            vCampo[010] := Form7.ibDataSet2ENDERE.Value;      //  10 Endereo do Destinatrio
            vCampo[011] := Form7.ibDataSet2COMPLE.Value;      //  11 Bairro do cliente
            vCampo[012] := Form7.ibDataSet2CEP.Value;         //  12 CEP do Destinatrio
            vCampo[013] := Form7.ibDataSet15SAIDAD.AsString;  //  13 Data de Sada
            vCampo[014] := Form7.ibDataSet2CIDADE.Value;      //  14 Municpio do Destinatrio
            vCampo[015] := Form7.ibDataSet2FONE.Value;        //  15 Telefone do cliente
            vCampo[016] := Form7.ibDataSet2ESTADO.Value;      //  16 U.F. do Destinatrio
            vCampo[017] := Form7.ibDataSet2IE.Value;          //  17 I.E. do Destinatrio
            vCampo[018] := Form7.ibDataSet15SAIDAH.Value;     //  18 Hora de sada
            //
            vCampo[086] := AllTrim(Form7.ibDataSet2IDENTIFICADOR1.AsString);  // Identificador 1 do cliente
            vCampo[087] := AllTrim(Form7.ibDataSet2IDENTIFICADOR2.AsString);  // Identificador 2 do cliente
            vCampo[088] := AllTrim(Form7.ibDataSet2IDENTIFICADOR3.AsString);  // Identificador 3 do cliente
            vCampo[089] := AllTrim(Form7.ibDataSet2IDENTIFICADOR4.AsString);  // Identificador 4 do cliente
            //
            VCampo[076] := 'X'; // 76 X da nota de saida
            vCampo[077] := ' '; // 77 X da nota de entrada
            //
            vCampo[054] := ''; //  54 Descrio dos servios 1
            vCampo[055] := ''; //  55 Descrio dos Servios 2
            vCampo[056] := ''; //  56 Descrio dos Servios 3
            //
            vCampo[057] := Form7.ibDataSet13ENDERECO.Value;   //  57 Endereco do Emitente
            vCampo[059] := Form7.ibDataSet13MUNICIPIO.Value;  //  59 Cidade do Emitente
            vCampo[060] := Form7.ibDataSet13CEP.Value;        //  60 C.E.P. Emitente
            vCampo[061] := UpperCase(Form7.ibDataSet13ESTADO.AsString);     //  61 Estado do Emitente
            vCampo[062] := Copy(Form7.ibDataSet15NUMERONF.AsString,1,9);   //  62 Nmero da Nota Fiscal
            //
            vCampo[064] := Form7.ibDataSet15IDENTIFICADOR1.Value;     //  Identificador 1
            //
            vCampo[067] := Form7.ibDataSet13NOME.Value;       //  67 Nome do emitente
            vCampo[098] := Form7.ibDataSet15VENDEDOR.Value;     //  98 Nome do vendedor
            vCampo[090] := 'NSU: '+Form7.ibDataSet15NSU.Value;  //  90 NSU
            vCampo[091] := 'Geracao da NSU: '+Form7.ibDataSet15NSUD.AsString +' '+ Copy(Form7.ibDataSet15NSUH.AsString,1,5);  //  Gerao da NSU:
            //
            // Passa os dados do arquivo ITENS001 para os vetores
            //
            I := 0;
            //
            Form7.ibDataSet16.DisableControls;
            while (not Form7.ibDataSet16.Eof) and (I<ConfItens) do // Disable
            begin
              if (Form7.ibDataSet16DESCRICAO.AsString <> '') and (Form7.ibDataSet16QUANTIDADE.AsFloat > 0) then
              begin
                //
                Form7.ibDataSet4.Close;                                                //
                Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                Form7.ibDataSet4.Open;
                //
                // so para sair o 0,00
                //
  //              Form7.ibDataSet16.Edit;
                //
                vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                vCampo[250 + I] := Form7.ibDataSet16MEDIDA.Value;     // 250 Unidades de medida do item
                vCampo[300 + I] := Form7.ibDataSet16QUANTIDADE.Value; // 300 Quantidades do item
                vCampo[350 + I] := Form7.ibDataSet16UNITARIO.Value;   // 350 Valor unitrio do item
                vCampo[400 + I] := Form7.ibDataSet16QUANTIDADE.Value  //
                                   * Form7.ibDataSet16UNITARIO.Value; // 400 Valor total do item
                if Form7.ibDataSet16IPI.AsFloat >= 0 then  vCampo[500 + I] := Form7.ibDataSet16IPI.AsFloat else vCampo[500 + I] := 0;        // 500 % IPI do item
                vCampo[450 + I] := (Form7.ibDataSet16QUANTIDADE.Value * Form7.ibDataSet16UNITARIO.Value * ( Form7.ibDataSet16IPI.Value / 100 )); // 450 Valor IPI do item
                //
                vCampo[550 + I] := Form7.ibDataSet16ICM.Value;        // 550 % ICM do item
                vCampo[600 + I] := Form7.ibDataSet16CODIGO.Value;     // 600 Cdigos do item
                vCampo[650 + I] := Form7.ibDataSet16QUANTIDADE.Value
                                 * Form7.ibDataSet16UNITARIO.Value
                                 * Form7.ibDataSet16ICM.Value
                                  / 100;                     // 650 Valor do ICM do item
                // Procura o produto no estoque
                if Form7.ibDataSet4CODIGO.Value = Form7.ibDataSet16CODIGO.Value then
                begin
                  vCampo[700 + I] := Form7.ibDataSet4CF.Value;          // 700 CF do item
                  vCampo[200 + I] := Form7.ibDataSet4CST.Value;         // 200 ST do item
                  vCampo[750 + I] := Form7.ibDataSet4REFERENCIA.Value;  // 750 Referncia
                end;
                //
                vCampo[800 + I] := Form7.ibDataSet16CFOP.Value;  // 800 CFOP do item
                vCampo[900 + I] := Form7.ibDataSet4LOCAL.Value;  // 900 Local do item
                //
                I := I + 1;
                //
              end else
              begin
                //
                // DESCRICAO NO CORPO DA NOTA
                //
                if (Form7.ibDataSet16DESCRICAO.AsString <> '') then
                begin
                  vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                  I := I + 1;
                end;
                //
              end;
              Form7.ibDataSet16.next;
              //
            end;
            //
            // servios INICIO
            //
            J := 0;
            //
            // servicos
            //
            while (not Form7.ibDataSet35.Eof) and (J<ConfSVC) do // Disable
            begin
              //
              if (Form7.ibDataSet35DESCRICAO.AsString <> '') then
              begin
                //
                vCampo[2150 + J] := Form7.ibDataSet35DESCRICAO.Value;  // 2150 Descrio do item de servico
                vCampo[2300 + J] := Form7.ibDataSet35QUANTIDADE.Value; // 2300 Quantidades do item de servico
                if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then vCampo[2350 + J] := Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.Asfloat;   // 2350 Valor unitrio do item de servico
                vCampo[2400 + J] := Form7.ibDataSet35TOTAL.Value;      // 2400 Valor total do item de servico
                vCampo[2600 + J] := '   ';
                //
                J := J + 1;
                //
              end;
              Form7.ibDataSet35.Next;
            end;
            //
            // servios FIM
            //
            if (Form7.ibDataSet16.eof) and ((Form7.ibDataSet35.eof)) then // Disable
            begin
              //
              bMaisItens := False;
              //
              // Valores
              //
              vCampo[020] := Form7.ibDataSet15SERVICOS.Value;   //  20 Base de Clculo do ISS
              if Form7.ibDataSet15SERVICOS.AsFloat <> 0 then vCampo[021] := Form7.ibDataSet15ISS.AsFloat / Form7.ibDataSet15SERVICOS.AsFloat * 100 else vCampo[021] := 0;
              vCampo[022] := Form7.ibDataSet15ISS.Value;          //  22 Valor total do ISS
              vCampo[023] := Form7.ibDataSet15BASEICM.Value;      //  23 Base de Clculo do ICMS
              vCampo[025] := Form7.ibDataSet15ICMS.Value;         //  25 Valor do ICM
              vCampo[026] := Form7.ibDataSet15BASESUBSTI.Asfloat; //  26 Base de subst
              vCampo[027] := Form7.ibDataSet15ICMSSUBSTI.AsFloat; //  27 ICMS de Subst
              vCampo[028] := Form7.ibDataSet15MERCADORIA.Value;   //  28 Total dos Produtos
              vCampo[029] := Form7.ibDataSet15FRETE.Value;        //  29 Valor do frete
              vCampo[030] := Form7.ibDataSet15SEGURO.Value;       //  30 Seguro
              vCampo[031] := Form7.ibDataSet15DESPESAS.Value;     //  31 Outras despesas
              vCampo[032] := Form7.ibDataSet15IPI.Value;          //  32 Valor total do IPI
              vCampo[033] := Form7.ibDataSet15TOTAL.Value;        //  33 Valor total da nota
              vCampo[046] := Form7.ibDataSet15DESCONTO.Value;     //  29 Valor do desconto
              vCampo[069] := vCampo[033];
              vCampo[085] := Form7.ibDataSet15MERCADORIA.Value;   //  Valor total dos produtos
              //
              vCampo[063] := Alltrim(Extenso(vCampo[033]));
              // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
              try
                if vCampo[020] >= Form1.ConfLimite  then vCampo[068] := vCampo[020] * ((Form1.ConfIR / 100) * 1) else vCAmpo[068] := 0;
              except end;

              // Fatura - Contas a receber
              //
              I := 0;
              //
              Form7.ibDataSet7.First;                 // Procura as duplicatas
              while not Form7.ibDataSet7.Eof do // No contas a receber
              begin
                //
                if AlltRim(Form7.ibDataSet7DOCUMENTO.asString) <> '' then
                begin
                  //
                  vCampo[1000 + I] := Form7.ibDataSet7DOCUMENTO.asString;    // Documento
                  vCampo[1100 + I] := Form7.ibDataSet7VALOR_DUPL.asFloat;    // Valor da duplicata
                  vCampo[1200 + I] := DateTimeToStr(Form7.ibDataSet7VENCIMENTO.asDateTime); // Vencimento
                  //
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = Date then vCampo[1200 + I] := ' VISTA ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime < Date then vCampo[1200 + I] := 'ANTECIP ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = StrToDateTime('30/12/1899') then vCampo[1200 + I] := 'APRESENT';
                  if I < 25 then I := I + 1;
                  //
                end;
                Form7.ibDataSet7.Next;
                //
              end;
              //
              vCampo[034] := Form7.ibDataSet15TRANSPORTA.Value;   //  34 Transportadora Nome
              vCampo[035] := Form7.ibDataSet15FRETE12.Value;      //  35 Frete por conta (0 ou 1)
              //
              // Transportadora
              //
              if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
              begin
                vCampo[036] := Form7.ibDataSet15PLACA.Value;        //  36 Placa do veculo
                vCampo[037] := Form7.ibDataSet18ESTADO.Value;       //  37 estado do veculo
                vCampo[038] := Form7.ibDataSet18CGC.Value;          //  38 CGC da tranportadora
                vCampo[039] := Form7.ibDataSet18ENDERECO.Value;     //  39 Transportadora endereo
                vCampo[040] := Form7.ibDataSet18MUNICIPIO.Value;    //  40 Transportadora municpio
                vCampo[041] := Form7.ibDataSet18UF.Value;           //  41 Estado da transportadora
                vCampo[042] := Form7.ibDataSet18IE.Value;           //  42 IE da transportadora
              end;
              //
              vCampo[043] := Form7.ibDataSet15VOLUMES.Value;      //  43 Quantidade de volumes
              vCampo[044] := Form7.ibDataSet15ESPECIE.Value;      //  44 Espcie de volumes
              vCampo[045] := Form7.ibDataSet15MARCA.Value;        //  45 Marca dos volumes
              vCampo[047] := Form7.ibDataSet15PESOBRUTO.Value;    //  47 Peso bruto
              vCampo[048] := Form7.ibDataSet15PESOLIQUI.Value;    //  48 Peso liquido
              //
              vCampo[049] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1,60);        //  49 Informacoes Complementares 1
              vCampo[050] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*1),60); //  49 Informacoes Complementares 1
              vCampo[051] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*2),60); //  49 Informacoes Complementares 1
              vCampo[052] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*3),60); //  49 Informacoes Complementares 1
              vCampo[053] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*4),60); //  49 Informacoes Complementares 1
              //
            end else
            begin
              bMaisItens := True;
            end;
            //
            // Impresso da NF
            //
            Form7.ibDataSet19.First;
            //
            if Copy(Form7.ibDataSet15NUMERONF.AsString,10,3) = '001' then
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal','Porta','LPT1'));
              Mais2ini.Free;
            end else
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal 2','Porta','LPT1'));
              Mais2ini.Free;
            end;

            try
              Rewrite(F);
            except
              //ShowMessage('Verifique a impressora.'); Mauricio Parizotto 2023-10-25
              MensagemSistema('Verifique a impressora.');
            end;

            // Arquivo de nota fiscal NOTA
            Form7.ibDataSet19.First;
            while not Form7.ibDataSet19.Eof do
            begin
              // No imprime quando a linha e a coluna estiverem zeradas
              if Form7.ibDataSet19LINHA.AsFloat > 200 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19LINHA.AsFloat := 200;
              end;
              if Form7.ibDataSet19COLUNA.AsFloat > 300 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19COLUNA.AsFloat := 300;
              end;
              
              if (Form7.ibDataSet19LINHA.Value + Form7.ibDataSet19COLUNA.Value) > 0 then
              begin
                try
                  if Trunc(Form7.ibDataSet19ELEMENTO.Value) > 0 then
                  begin
                    Form7.ibDataSet19.Edit;
                    Form7.ibDataSet19LAYOUT.AsString := vCampo[ Trunc(Form7.ibDataSet19ELEMENTO.Value) ];
                    Form7.ibDataSet19.Post;
                  end;
                except
                end;
                
                if (Form7.ibDataSet19ELEMENTO.Value >= 150) and (Form7.ibDataSet19ELEMENTO.Value < 999) then
                begin
                  try
                  // Linha dos produtos
                  for I := 0 to ConfItens do
                  begin
                    //
                    if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                    begin
                      try
                        if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                        begin
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right( Replicate(' ',100)+FormatFloat('#,##0.00', vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )] * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString) ),10);
                        end else
                        begin
                          if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                          begin
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                          end;

                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        end;
                      except
                        try
                          Form7.ibDataSet19.Edit;
                          Form7.ibDataSet19TIPO.AsString := '999.999,99';
                          Form7.ibDataSet19.Post;

                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        except
                          //ShowMessage('Erro 2'); Mauricio Parizotto 2023-10-25
                          MensagemSistema('Erro 2',msgErro);
                        end;
                      end;
                    end else
                    begin
                      try
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                               alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                      except end;
                    end;
                  end;

                  except end;
                end else
                begin
                  // SERVICOS SERVIOS servios
                  if (Form7.ibDataSet19ELEMENTO.Value >= 2150) and  (Form7.ibDataSet19ELEMENTO.Value < 2999) then
                  begin

  try
                    // Linha dos Servios
                    //
                    // Resolvi esse problema num sonho
                    //
                    for I := 0 to Form1.ConfSvc do
                    begin
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          //
                          try
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                            //
                                                  vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          except end;
                          //
                        end;
                      end else
                      begin
                        try
                           vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                        except end;
                      end;
                    end;
  except end;
                  end else
                  begin
                    //
  try
                    if Form7.ibDataSet19ELEMENTO.Value > 0 then
                    begin
                      //
                      // Todas as informaes da NF menos itens de produtos ou servios
                      //
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          try
                            try
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                              //
                              vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                              Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                              ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                            except end;
                          except end;
                        end;
                      end
                      else
                        try
                          //
                          // @S 0150
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) =  '@S' then
                          begin
                            try
                              vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ] := Copy(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]+Replicate(' ',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2)),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                            except end;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                   alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]);
                        except end;
                    end;
  except end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@&' then // Comando para a impressora
                    begin
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'E->OBSERVACAO' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + Form7.ibDataSet2OBS.AsString;
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + chr(15);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(18);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[0]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'0';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[1]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'1';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[2]' then vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'2';

                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17))) = 'CHR(27)+[C]+CHR(' then
                      begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'C'+chr(StrToInt(Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-2,2)));
                        iPagina := StrToInt('0'+Limpanumero((Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-3,3))));
                      end;
                    end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@R' then // Texto fixo
                    begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2));
                    end;
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@E' then  // Valor por extenso
                    begin
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] :=
                         Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value)) +
                             Copy(AllTrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ])
                               +' '+Replicate('.x',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2))
                                 ,StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                    end;
                  end;
                end;
              end;
              Form7.ibDataSet19.Next;
            end;
            {                    }
            { Elimina os acentos }
            {                    }
            for J := 1 to iPagina -1 do
              for I := 1 to 36 do
               vLinha[ J ] := strtran( vLinha[ J ],copy('*',I,1),copy('AAAAAEEEEIIIOOOUUCaaaaaeeeeiiiooouuc*',I,1)
            {+chr(8)+StrTran(copy('/`^"~/~^"/^"/^~/",/~^"~/`^"/^"/^~/",',I,1),'/',Chr(39))});
            {                         }
            { Imprime todas as Linhas }
            {                         }
            // MOTOR DA NOTA FISCAL
            try
              Writeln(F,chr(27)+'@');
              for I := 0 to iPagina -1 do
              begin
                try
                  Writeln(F,vLinha[I]);
                except
                  //ShowMessage('Verifique a impressora.'); Mauricio Parizotto 2023-10-25
                  MensagemSistema('Verifique a impressora.',msgAtencao);
                  Abort;
                end;
              end;
              CloseFile(F);
            except
              //ShowMessage('Verifique a impressora.'); Mauricio Parizotto 2023-10-25
              MensagemSistema('Verifique a impressora.',msgAtencao);
              Abort;
            end;
          end;

          if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
          begin
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
            Form7.ibDataSet15.Post;
          end;
        end;
      end;
    except
    end;
  end;
  
  Result := True;
end;


function ImprimeOuNaoANotaZZ(pP1:Boolean):Boolean;
var
  vLinha: array [0..200]  of String;  // Cria uma matriz com 100 elementos
                                      // isso eu aprendi num sonho
  vCampo: array [0..3000] of Variant; // Cria uma matriz com 1000 elementos
  ConfItens, ConfSvc, iPagina, I, J : Integer; // e contedo varivel
  F: TextFile;
  Mais1ini, Mais2Ini: TIniFile;
  bMaisItens  : Boolean;
begin
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');

  begin
    Mais1ini.Free;

    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';   
    {$ENDIF}

    iPagina         := 72;
    Mais1ini        := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    ConfItens       := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Itens','16'));
    ConfSvc         := StrToInt(Mais1Ini.ReadString('Nota Fiscal','Svc','5'));
    //
    Mais1ini.Free;
    //
    // Relaciona a natureza da operao com o arquivo de vendas
    //
    if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = '' then
      Form7.ibDataSet14.Append
    else
      Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
    //
    // Relaciona os clientes com o arquivo de vendas
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    //
    Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
    Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
    //
    try
      //
      // Verifica se o cliente est cadastrado se a nota tem valor
      //
      if (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') and ((Form7.ibDataSet15TOTAL.AsFloat <> 0) or (Form7.ibDataSet15ICMS.AsFloat <> 0)) then
      begin
        //
        // Abre o arquivo de clientes para edio
        //
        try
          if  Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime then
          begin
            Form7.ibDataSet2.Edit;
            Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
            Form7.ibDataSet2.Post;
          end;
        except
          try
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15LOKED.AsString := 'S';
            Form7.ibDataSet15.Post;
          except end;
        end;

        I := Application.MessageBox(pChar(chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                                  'posicionado.'+Chr(10)+
                                  chr(10)+
                                  'Imprimir a nota fiscal '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' agora?'),
                                  'Ateno',mb_YesNo + MB_ICONWARNING);



        if I = 6 then
        begin
          // Incio da impresso da nota
          bMaisItens := True;
          Form7.ibDataSet16.First;
          Form7.ibDataSet35.First;

          while bMaisItens do
          begin
            {                                           }
            { Arquivo de NF indexado por LINHA + COLUNA }
            {                                           }
            Form7.ibDataSet19.Active     := False;
            Form7.ibDataSet19.SelectSQL.Clear;
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=1 order by ((LINHA * 1000) + COLUNA)') else Form7.ibDataSet19.SelectSQL.Add('select * from NOTA where SERIE=2 order by ((LINHA * 1000) + COLUNA)');
            Form7.ibDataSet19.Open;
            {                                           }
            { Inicializa todos os elementos dos vetores }
            {                                           }
            for I := 1 to 1300 do vCampo[I] := '';
            for I := 1 to 200  do  vLinha[I] := '';

            // Zera os servicos
            for I := 1 to 50 do
            begin
              vCampo[2150 + I] := '';
              vCampo[2300 + I] := '';
              vCampo[2350 + I] := '';
              vCampo[2400 + I] := '';
              vCampo[2600 + I] := '';
            end;

            // Valores nmericos
            vCampo[020] := '************';   //  20 Base de Clculo do ISS
            vCampo[021] := '************';
            vCampo[022] := '************'; //  22 Valor total do ISS
            vCampo[023] := '************'; //  23 Base de Clculo do ICMS
            vCampo[025] := '************'; //  25 Valor do ICM
            vCampo[026] := '************'; //  26 Base de subst
            vCampo[027] := '************'; //  27 ICMS de Subst
            vCampo[028] := '************'; //  28 Total dos Produtos
            vCampo[029] := '************'; //  29 Valor do frete
            vCampo[030] := '************'; //  30 Seguro
            vCampo[031] := '************'; //  31 Outras despesas
            vCampo[032] := '************'; //  32 Valor total do IPI
            vCampo[033] := '************'; //  33 Valor total da nota
            vCampo[063] := Replicate('x',160);   //  Valor por Extenso
            vCampo[046] := '************'; //  29 Valor do desconto
            vCampo[069] := '************';
            vCampo[085] := '************'; //  Valor total dos produtos
            vCampo[020] := '************'; //  Imposto de renda
            //
            vCampo[034] := '*****************************';   //  34 Transportadora Nome
            vCampo[035] := '*';      //  35 Frete por conta (1 ou 2)
            //
            // Transportadora
            //
            if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
            begin
              vCampo[036] := '*******';      //  36 Placa do veculo
              vCampo[037] := '*******';      //  37 estado do veculo
              vCampo[038] := '*******';      //  38 CGC da tranportadora
              vCampo[039] := '*******';      //  39 Transportadora endereo
              vCampo[040] := '*******';      //  40 Transportadora municpio
              vCampo[041] := '*******';      //  41 Estado da transportadora
              vCampo[042] := '*******';      //  42 IE da transportadora
            end;
            //
            vCampo[043] :=  '*******'; //  43 Quantidade de volumes
            vCampo[044] :=  '*******'; //  44 Espcie de volumes
            vCampo[045] :=  '*******'; //  45 Marca dos volumes
            vCampo[047] :=  '*******'; //  47 Peso bruto
            vCampo[048] :=  '*******'; //  48 Peso liquido
            //
            {                                                      }
            { Atribui o valor a cada elemento conf fonte no dBFAST }
            {                                                      }
            vCampo[001] := Form7.ibDataSet13CGC.Value;        //   1 C.G.C. do Emitente
            vCampo[002] := Form7.ibDataSet15OPERACAO.Value;   //   2 Natureza da operaco
            vCampo[003] := Form7.ibDataSet14CFOP.Value;       //   3 C.F.O.
            vCampo[005] := Form7.ibDataSet13IE.Value;         //   5 I.E. do emitente
            vCampo[007] := Form7.ibDataSet2NOME.Value;        //   7 Razo Social do Destinatrio
            vCampo[008] := Form7.ibDataSet2CGC.Value;         //   8 C.G.C. do Destinatrio
            vCampo[009] := DateTimeToStr(Form7.ibDataSet15EMISSAO.asDateTime); //   9 Data de emisso
            vCampo[010] := Form7.ibDataSet2ENDERE.Value;      //  10 Endereo do Destinatrio
            vCampo[011] := Form7.ibDataSet2COMPLE.Value;      //  11 Bairro do cliente
            vCampo[012] := Form7.ibDataSet2CEP.Value;         //  12 CEP do Destinatrio
            vCampo[013] := Form7.ibDataSet15SAIDAD.AsString;  //  13 Data de Sada
            vCampo[014] := Form7.ibDataSet2CIDADE.Value;      //  14 Municpio do Destinatrio
            vCampo[015] := Form7.ibDataSet2FONE.Value;        //  15 Telefone do cliente
            vCampo[016] := Form7.ibDataSet2ESTADO.Value;      //  16 U.F. do Destinatrio
            vCampo[017] := Form7.ibDataSet2IE.Value;          //  17 I.E. do Destinatrio
            vCampo[018] := Form7.ibDataSet15SAIDAH.Value;     //  18 Hora de sada
            //
            vCampo[086] := AllTrim(Form7.ibDataSet2IDENTIFICADOR1.AsString);  // Identificador 1 do cliente
            vCampo[087] := AllTrim(Form7.ibDataSet2IDENTIFICADOR2.AsString);  // Identificador 2 do cliente
            vCampo[088] := AllTrim(Form7.ibDataSet2IDENTIFICADOR3.AsString);  // Identificador 3 do cliente
            vCampo[089] := AllTrim(Form7.ibDataSet2IDENTIFICADOR4.AsString);  // Identificador 4 do cliente
            //
            VCampo[076] := 'X'; // 76 X da nota de saida
            vCampo[077] := ' '; // 77 X da nota de entrada
            //
            vCampo[054] := ''; //  54 Descrio dos servios 1
            vCampo[055] := ''; //  55 Descrio dos Servios 2
            vCampo[056] := ''; //  56 Descrio dos Servios 3
            //
            vCampo[057] := Form7.ibDataSet13ENDERECO.Value;   //  57 Endereco do Emitente
            vCampo[059] := Form7.ibDataSet13MUNICIPIO.Value;  //  59 Cidade do Emitente
            vCampo[060] := Form7.ibDataSet13CEP.Value;        //  60 C.E.P. Emitente
            vCampo[061] := UpperCase(Form7.ibDataSet13ESTADO.AsString);     //  61 Estado do Emitente
            vCampo[062] := Copy(Form7.ibDataSet15NUMERONF.Value,1,9);   //  62 Nmero da Nota Fiscal
            //
            vCampo[064] := Form7.ibDataSet15IDENTIFICADOR1.Value;     //  Identificador 1
            //
            vCampo[067] := Form7.ibDataSet13NOME.Value;       //  67 Nome do emitente
            vCampo[098] := Form7.ibDataSet15VENDEDOR.Value;     //  98 Nome do vendedor
            vCampo[090] := 'NSU: '+Form7.ibDataSet15NSU.Value;  //  90 NSU
            vCampo[091] := 'Geracao da NSU: '+Form7.ibDataSet15NSUD.AsString +' '+ Copy(Form7.ibDataSet15NSUH.AsString,1,5);  //  Gerao da NSU:
            //
            // Passa os dados do arquivo ITENS001 para os vetores
            //
            I := 0;
            //
            Form7.ibDataSet16.DisableControls;
            while (not Form7.ibDataSet16.Eof) and (I<ConfItens) do // Disable
            begin
              if (Form7.ibDataSet16DESCRICAO.AsString <> '') and (Form7.ibDataSet16QUANTIDADE.AsFloat > 0) then
              begin
                //
                Form7.ibDataSet4.Close;                                                //
                Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                Form7.ibDataSet4.Open;
                //
                // so para sair o 0,00
                //
  //              Form7.ibDataSet16.Edit;
                //
                vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                vCampo[250 + I] := Form7.ibDataSet16MEDIDA.Value;     // 250 Unidades de medida do item
                vCampo[300 + I] := Form7.ibDataSet16QUANTIDADE.Value; // 300 Quantidades do item
                vCampo[350 + I] := Form7.ibDataSet16UNITARIO.Value;   // 350 Valor unitrio do item
                vCampo[400 + I] := Form7.ibDataSet16QUANTIDADE.Value  //
                                   * Form7.ibDataSet16UNITARIO.Value; // 400 Valor total do item
                if Form7.ibDataSet16IPI.AsFloat >= 0 then  vCampo[500 + I] := Form7.ibDataSet16IPI.AsFloat else vCampo[500 + I] := 0;        // 500 % IPI do item
                vCampo[450 + I] := (Form7.ibDataSet16QUANTIDADE.Value * Form7.ibDataSet16UNITARIO.Value * ( Form7.ibDataSet16IPI.Value / 100 )); // 450 Valor IPI do item
                //
                vCampo[550 + I] := Form7.ibDataSet16ICM.Value;        // 550 % ICM do item
                vCampo[600 + I] := Form7.ibDataSet16CODIGO.Value;     // 600 Cdigos do item
                vCampo[650 + I] := Form7.ibDataSet16QUANTIDADE.Value
                                 * Form7.ibDataSet16UNITARIO.Value
                                 * Form7.ibDataSet16ICM.Value
                                  / 100;                     // 650 Valor do ICM do item
                // Procura o produto no estoque
                if Form7.ibDataSet4CODIGO.Value = Form7.ibDataSet16CODIGO.Value then
                begin
                  vCampo[700 + I] := Form7.ibDataSet4CF.Value;          // 700 CF do item
                  vCampo[200 + I] := Form7.ibDataSet4CST.Value;         // 200 ST do item
                  vCampo[750 + I] := Form7.ibDataSet4REFERENCIA.Value;  // 750 Referncia
                end;
                //
                vCampo[800 + I] := Form7.ibDataSet16CFOP.Value;  // 800 CFOP do item
                vCampo[900 + I] := Form7.ibDataSet4LOCAL.Value;  // 900 Local do item
                //
                I := I + 1;
                //
              end else
              begin
                //
                // DESCRICAO NO CORPO DA NOTA
                //
                if (Form7.ibDataSet16DESCRICAO.AsString <> '') then
                begin
                  vCampo[150 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
                  I := I + 1;
                end;
                //
              end;
              Form7.ibDataSet16.next;
              //
            end;
            //
            // servios INICIO
            //
            J := 0;
            //
            // servicos
            //
            while (not Form7.ibDataSet35.Eof) and (J<ConfSVC) do // Disable
            begin
              //
              if (Form7.ibDataSet35DESCRICAO.AsString <> '') then
              begin
                //
                vCampo[2150 + J] := Form7.ibDataSet35DESCRICAO.Value;  // 2150 Descrio do item de servico
                vCampo[2300 + J] := Form7.ibDataSet35QUANTIDADE.Value; // 2300 Quantidades do item de servico
                if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then vCampo[2350 + J] := Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.Asfloat;   // 2350 Valor unitrio do item de servico
                vCampo[2400 + J] := Form7.ibDataSet35TOTAL.Value;      // 2400 Valor total do item de servico
                vCampo[2600 + J] := '   ';
                //
                J := J + 1;
                //
              end;
              Form7.ibDataSet35.Next;
            end;
            //
            // servios FIM
            //
            if (Form7.ibDataSet16.eof) and ((Form7.ibDataSet35.eof)) then // Disable
            begin
              //
              bMaisItens := False;
              //
              // Valores
              //
              vCampo[020] := Form7.ibDataSet15SERVICOS.Value;   //  20 Base de Clculo do ISS
              if Form7.ibDataSet15SERVICOS.AsFloat <> 0 then vCampo[021] := Form7.ibDataSet15ISS.AsFloat / Form7.ibDataSet15SERVICOS.AsFloat * 100 else vCampo[021] := 0;
              vCampo[022] := Form7.ibDataSet15ISS.Value;          //  22 Valor total do ISS
              vCampo[023] := Form7.ibDataSet15BASEICM.Value;      //  23 Base de Clculo do ICMS
              vCampo[025] := Form7.ibDataSet15ICMS.Value;         //  25 Valor do ICM
              vCampo[026] := Form7.ibDataSet15BASESUBSTI.Asfloat; //  26 Base de subst
              vCampo[027] := Form7.ibDataSet15ICMSSUBSTI.AsFloat; //  27 ICMS de Subst
              vCampo[028] := Form7.ibDataSet15MERCADORIA.Value;   //  28 Total dos Produtos
              vCampo[029] := Form7.ibDataSet15FRETE.Value;        //  29 Valor do frete
              vCampo[030] := Form7.ibDataSet15SEGURO.Value;       //  30 Seguro
              vCampo[031] := Form7.ibDataSet15DESPESAS.Value;     //  31 Outras despesas
              vCampo[032] := Form7.ibDataSet15IPI.Value;          //  32 Valor total do IPI
              vCampo[033] := Form7.ibDataSet15TOTAL.Value;        //  33 Valor total da nota
              vCampo[046] := Form7.ibDataSet15DESCONTO.Value;     //  29 Valor do desconto
              vCampo[069] := vCampo[033];
              vCampo[085] := Form7.ibDataSet15MERCADORIA.Value;   //  Valor total dos produtos
              //
              vCampo[063] := Alltrim(Extenso(vCampo[033]));
              // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
              try
                if vCampo[020] >= Form1.ConfLimite  then vCampo[068] := vCampo[020] * ((Form1.ConfIR / 100) * 1) else vCAmpo[068] := 0;
              except end;

              // Fatura - Contas a receber
              //
              I := 0;
              //
              Form7.ibDataSet7.First;                 // Procura as duplicatas
              while not Form7.ibDataSet7.Eof do // No contas a receber
              begin
                //
                if AlltRim(Form7.ibDataSet7DOCUMENTO.asString) <> '' then
                begin
                  //
                  vCampo[1000 + I] := Form7.ibDataSet7DOCUMENTO.asString;    // Documento
                  vCampo[1100 + I] := Form7.ibDataSet7VALOR_DUPL.asFloat;    // Valor da duplicata
                  vCampo[1200 + I] := DateTimeToStr(Form7.ibDataSet7VENCIMENTO.asDateTime); // Vencimento
                  //
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = Date then vCampo[1200 + I] := ' VISTA ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime < Date then vCampo[1200 + I] := 'ANTECIP ';
                  if Form7.ibDataSet7VENCIMENTO.asDateTime = StrToDateTime('30/12/1899') then vCampo[1200 + I] := 'APRESENT';
                  if I < 25 then I := I + 1;
                  //
                end;
                Form7.ibDataSet7.Next;
              end;
              //
              vCampo[034] := Form7.ibDataSet15TRANSPORTA.Value;   //  34 Transportadora Nome
              vCampo[035] := Form7.ibDataSet15FRETE12.Value;      //  35 Frete por conta (1 ou 2)
              //
              // Transportadora
              if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
              begin
                vCampo[036] := Form7.ibDataSet15PLACA.Value;        //  36 Placa do veculo
                vCampo[037] := Form7.ibDataSet18ESTADO.Value;       //  37 estado do veculo
                vCampo[038] := Form7.ibDataSet18CGC.Value;          //  38 CGC da tranportadora
                vCampo[039] := Form7.ibDataSet18ENDERECO.Value;     //  39 Transportadora endereo
                vCampo[040] := Form7.ibDataSet18MUNICIPIO.Value;    //  40 Transportadora municpio
                vCampo[041] := Form7.ibDataSet18UF.Value;           //  41 Estado da transportadora
                vCampo[042] := Form7.ibDataSet18IE.Value;           //  42 IE da transportadora
              end;
              //
              vCampo[043] := Form7.ibDataSet15VOLUMES.Value;      //  43 Quantidade de volumes
              vCampo[044] := Form7.ibDataSet15ESPECIE.Value;      //  44 Espcie de volumes
              vCampo[045] := Form7.ibDataSet15MARCA.Value;        //  45 Marca dos volumes
              vCampo[047] := Form7.ibDataSet15PESOBRUTO.Value;    //  47 Peso bruto
              vCampo[048] := Form7.ibDataSet15PESOLIQUI.Value;    //  48 Peso liquido
              //
              vCampo[049] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1,60);        //  49 Informacoes Complementares 1
              vCampo[050] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*1),60); //  49 Informacoes Complementares 1
              vCampo[051] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*2),60); //  49 Informacoes Complementares 1
              vCampo[052] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*3),60); //  49 Informacoes Complementares 1
              vCampo[053] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*4),60); //  49 Informacoes Complementares 1
              //
            end else
            begin
              bMaisItens := True;
            end;

            // Impresso da NF
            Form7.ibDataSet19.First;
            
            if Copy(Form7.ibDataSet15NUMERONF.AsString,10,3) = '001' then
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal','Porta','LPT1'));
              Mais2ini.Free;
            end else
            begin
              Mais2ini := TIniFile.Create('retaguarda.ini');
              AssignFile(F,Mais2Ini.ReadString('Nota Fiscal 2','Porta','LPT1'));
              Mais2ini.Free;
            end;
            
            try
              Rewrite(F);
            except
              //ShowMessage('Verifique a impressora.') Mauricio Parizotto 2023-10-25
              MensagemSistema('Verifique a impressora.',msgAtencao);
            end;

            // Arquivo de nota fiscal NOTA
            Form7.ibDataSet19.First;
            while not Form7.ibDataSet19.Eof do
            begin
              // No imprime quando a linha e a coluna estiverem zeradas
              if Form7.ibDataSet19LINHA.AsFloat > 200 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19LINHA.AsFloat := 200;
              end;
              if Form7.ibDataSet19COLUNA.AsFloat > 300 then
              begin
                Form7.ibDataSet19.Edit;
                Form7.ibDataSet19COLUNA.AsFloat := 300;
              end;
              
              if (Form7.ibDataSet19LINHA.Value + Form7.ibDataSet19COLUNA.Value) > 0 then
              begin
                try
                  if Trunc(Form7.ibDataSet19ELEMENTO.Value) > 0 then
                  begin
                    Form7.ibDataSet19.Edit;
                    Form7.ibDataSet19LAYOUT.AsString := vCampo[ Trunc(Form7.ibDataSet19ELEMENTO.Value) ];
                    Form7.ibDataSet19.Post;
                  end;
                except
                end;

                if (Form7.ibDataSet19ELEMENTO.Value >= 150) and (Form7.ibDataSet19ELEMENTO.Value < 999) then
                begin
  try
                  //
                  // Linha dos produtos
                  //
                  for I := 0 to ConfItens do
                  begin
                    //
                    if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                    begin
                      try
                        //
                        if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                        begin
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right( Replicate(' ',100)+FormatFloat('#,##0.00', vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )] * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString) ),10);
                        end else
                        begin
                          if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                          begin
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        end;
                      except
                        try
                          Form7.ibDataSet19.Edit;
                          Form7.ibDataSet19TIPO.AsString := '999.999,99';
                          Form7.ibDataSet19.Post;
                          //
                                                vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                          Right(
                          Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                          ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                        except
                          //ShowMessage('Erro 2');Mauricio Parizotto 2023-10-25
                          MensagemSistema('Erro 2');
                        end;
                      end;
                    end else
                    begin
                      try
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                               alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                      except
                      end;
                    end;
                  end;

  except end;

                end else
                begin
                  // SERVICOS SERVIOS servios
                  if (Form7.ibDataSet19ELEMENTO.Value >= 2150) and  (Form7.ibDataSet19ELEMENTO.Value < 2999) then
                  begin

  try
                    // Linha dos Servios
                    //
                    // Resolvi esse problema num sonho
                    //
                    for I := 0 to Form1.ConfSvc do
                    begin
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                          //
                        except
                          //
                          try
                            Form7.ibDataSet19.Edit;
                            Form7.ibDataSet19TIPO.AsString := '999.999,99';
                            Form7.ibDataSet19.Post;
                            //
                                                  vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right(
                            Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          except end;
                          //
                        end;
                      end else
                      begin
                        try
                           vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat)+I ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )+I ]);
                        except end;
                      end;
                    end;
  except end;
                  end else
                  begin
                    //
  try
                    if Form7.ibDataSet19ELEMENTO.Value > 0 then
                    begin
                      // Todas as informaes da NF menos itens de produtos ou servios
                      if (VarType(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]) = varDouble) then
                      begin
                        try
                          //
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@*' then  // Multiplica o nmero pelo valor do int
                          begin
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat('#,##0.00',
                            vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )]
                            * LimpaNumeroDeixandoAvirgula(Form7.ibDataSet19TIPO.AsString)
                            ),10);
                          end else
                          begin
                            if AllTrim(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.AsString,'9',''),'.',''),',','')) <> '' then
                            begin
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                            end;
                            //
                            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                            Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                            ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                          end;
                        except
                          try
                            try
                              Form7.ibDataSet19.Edit;
                              Form7.ibDataSet19TIPO.AsString := '999.999,99';
                              Form7.ibDataSet19.Post;
                              //
                              vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                              Right( Replicate(' ',100)+FormatFloat(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(Form7.ibDataSet19TIPO.Value,'9','#'),'.','*'),',','.'),'*',','),'#.####','0.0000'),'#.###','0.000'),'#.##','0.00'),'#.#','0.0'),vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value )])
                              ,length(Alltrim(Form7.ibDataSet19Tipo.Value)));
                            except end;
                          except end;
                        end;
                      end
                      else
                        try
                          if Copy(Form7.ibDataSet19TIPO.AsString,1,2) =  '@S' then
                          begin
                            try
                              vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ] := Copy(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]+Replicate(' ',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2)),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                            except end;
                          end;
                          //
                          vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                   alltrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ]);
                        except end;
                    end;
  except end;
                    //
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@&' then // Comando para a impressora
                    begin

                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'E->OBSERVACAO' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + Form7.ibDataSet2OBS.AsString;
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]  + chr(15);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(18);
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[0]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'0';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[1]' then
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'1';
                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[2]' then vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'2';

                      if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17))) = 'CHR(27)+[C]+CHR(' then
                      begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] + chr(27)+'C'+chr(StrToInt(Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-2,2)));
                        iPagina := StrToInt('0'+Limpanumero((Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-3,3))));
                      end;
                    end;
                    
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@R' then // Texto fixo
                    begin
                        vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value))+
                                                                 alltrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2));
                    end;
                    if Copy(Form7.ibDataSet19TIPO.AsString,1,2) = '@E' then  // Valor por extenso
                    begin
                      vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] :=
                         Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ]+Replicate(' ',200),1,Trunc(Form7.ibDataSet19COLUNA.Value)) +
                             Copy(AllTrim(vCampo[ Trunc( Form7.ibDataSet19ELEMENTO.Value ) ])
                               +' '+Replicate('.x',100),StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,4,2))
                                 ,StrToInt(Copy(Form7.ibDataSet19TIPO.AsString,6,2)));
                    end;
                  end;
                end;
              end;
              Form7.ibDataSet19.Next;
            end;
            {                    }
            { Elimina os acentos }
            {                    }
            for J := 1 to iPagina -1 do
              for I := 1 to 36 do
               vLinha[ J ] := strtran( vLinha[ J ],copy('*',I,1),copy('AAAAAEEEEIIIOOOUUCaaaaaeeeeiiiooouuc*',I,1)
            {+chr(8)+StrTran(copy('/`^"~/~^"/^"/^~/",/~^"~/`^"/^"/^~/",',I,1),'/',Chr(39))});
            {                         }
            { Imprime todas as Linhas }
            {                         }
            // MOTOR DA NOTA FISCAL
            try
              Writeln(F,chr(27)+'@');
              for I := 0 to iPagina -1 do
              begin
                try
                  Writeln(F,vLinha[I]);
                except
                  //ShowMessage('Verifique a impressora.'); Mauricio Parizotto 2023-10-25
                  MensagemSistema('Verifique a impressora.',msgAtencao);
                  Abort;
                end;
              end;

              CloseFile(F);

              if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
              begin
                Form7.ibDataSet15.Edit;
                Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
                Form7.ibDataSet15.Post;
              end;
            except
              //ShowMessage('Verifique a impressora.');Mauricio Parizotto 2023-10-25
              MensagemSistema('Verifique a impressora.');
              Abort;
            end;
          end;
        end;
      end;
    except
    end;
  end;

  Result := True;
end;



(*function ExportaNF(pP1:Boolean):Boolean;
var
  vCampo: array [0..30000] of Variant; // Cria uma matriz com 1000 elementos
  I, J : Integer; // e contedo varivel
  F: TextFile;
  vTipo : Word;
begin
  Result := True;

  {$IFDEF VER150}
  ShortDateFormat := 'dd/mm/yyyy';
  {$ELSE}
  FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
  {$ENDIF}

  // Relaciona a natureza da operao com o arquivo de vendas
  if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = '' then
    Form7.ibDataSet14.Append
  else
    Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
  //
  // Relaciona os clientes com o arquivo de vendas
  //
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  Form7.ibDataSet9.Locate('NOME',Form7.ibDataSet15VENDEDOR.AsString,[]);
  Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
  //
  // Verifica se o cliente est cadastrado se a nota tem valor
  //
  if (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') and ((Form7.ibDataSet15TOTAL.AsFloat <> 0) or (Form7.ibDataSet15ICMS.AsFloat <> 0)) then
  begin
    {                                           }
    { Inicializa todos os elementos dos vetores }
    {                                           }
    for I := 1 to 13000 do vCampo[I] := '';
    {                                                      }
    { Atribui o valor a cada elemento conf fonte no dBFAST }
    {                                                      }
    vCampo[001] := Form7.ibDataSet13CGC.Value;        //   1 C.G.C. do Emitente
    vCampo[002] := Form7.ibDataSet15OPERACAO.Value;   //   2 Natureza da operaco
    vCampo[003] := Form7.ibDataSet14CFOP.Value;       //   3 C.F.O.
    vCampo[005] := Form7.ibDataSet13IE.Value;         //   5 I.E. do emitente
    vCampo[007] := Form7.ibDataSet2NOME.Value;        //   7 Razo Social do Destinatrio
    vCampo[008] := Form7.ibDataSet2CGC.Value;         //   8 C.G.C. do Destinatrio
    vCampo[009] := DateTimeToStr(Form7.ibDataSet15EMISSAO.asDateTime); //   9 Data de emisso
    vCampo[010] := Form7.ibDataSet2ENDERE.Value;      //  10 Endereo do Destinatrio
    vCampo[011] := Form7.ibDataSet2COMPLE.Value;      //  11 Bairro do cliente
    vCampo[012] := Form7.ibDataSet2CEP.Value;         //  12 CEP do Destinatrio
    vCampo[013] := Form7.ibDataSet15SAIDAD.AsString;  //  13 Data de Sada
    vCampo[014] := Form7.ibDataSet2CIDADE.Value;      //  14 Municpio do Destinatrio
    vCampo[015] := Form7.ibDataSet2FONE.Value;        //  15 Telefone do cliente
    vCampo[016] := Form7.ibDataSet2ESTADO.Value;      //  16 U.F. do Destinatrio
    vCampo[017] := Form7.ibDataSet2IE.Value;          //  17 I.E. do Destinatrio
    vCampo[018] := Form7.ibDataSet15SAIDAH.Value;     //  18 Hora de sada

    vCampo[086] := AllTrim(Form7.ibDataSet2IDENTIFICADOR1.AsString);  // Identificador 1 do cliente
    vCampo[087] := AllTrim(Form7.ibDataSet2IDENTIFICADOR2.AsString);  // Identificador 2 do cliente
    vCampo[088] := AllTrim(Form7.ibDataSet2IDENTIFICADOR3.AsString);  // Identificador 3 do cliente
    vCampo[089] := AllTrim(Form7.ibDataSet2IDENTIFICADOR4.AsString);  // Identificador 4 do cliente

    VCampo[076] := 'X'; // 76 X da nota de saida
    vCampo[077] := ' '; // 77 X da nota de entrada
    vCampo[034] := Form7.ibDataSet15TRANSPORTA.Value;   //  34 Transportadora Nome
    vCampo[035] := Form7.ibDataSet15FRETE12.Value;      //  35 Frete por conta (0 ou 1)

    // Transportadora
    if AllTrim(Form7.ibDataSet15TRANSPORTA.AsString)=AllTrim(Form7.ibDataSet18NOME.AsString) then
    begin
      vCampo[036] := Form7.ibDataSet15PLACA.Value;        //  36 Placa do veculo
      vCampo[037] := Form7.ibDataSet18ESTADO.Value;       //  37 estado do veculo
      vCampo[038] := Form7.ibDataSet18CGC.Value;          //  38 CGC da tranportadora
      vCampo[039] := Form7.ibDataSet18ENDERECO.Value;     //  39 Transportadora endereo
      vCampo[040] := Form7.ibDataSet18MUNICIPIO.Value;    //  40 Transportadora municpio
      vCampo[041] := Form7.ibDataSet18UF.Value;           //  41 Estado da transportadora
      vCampo[042] := Form7.ibDataSet18IE.Value;           //  42 IE da transportadora
    end;
    //
    vCampo[043] := Form7.ibDataSet15VOLUMES.Value;      //  43 Quantidade de volumes
    vCampo[044] := Form7.ibDataSet15ESPECIE.Value;      //  44 Espcie de volumes
    vCampo[045] := Form7.ibDataSet15MARCA.Value;        //  45 Marca dos volumes
    vCampo[047] := Form7.ibDataSet15PESOBRUTO.Value;    //  47 Peso bruto
    vCampo[048] := Form7.ibDataSet15PESOLIQUI.Value;    //  48 Peso liquido
    //
    vCampo[049] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1,60);        //  49 Informacoes Complementares 1
    vCampo[050] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*1),60); //  49 Informacoes Complementares 1
    vCampo[051] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*2),60); //  49 Informacoes Complementares 1
    vCampo[052] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*3),60); //  49 Informacoes Complementares 1
    vCampo[053] := Copy(Form7.ibDataSet15COMPLEMENTO.AsString+REplicate(' ',3000),1+(60*4),60); //  49 Informacoes Complementares 1
    //
    vCampo[054] := ''; //  54 Descrio dos servios 1
    vCampo[055] := ''; //  55 Descrio dos Servios 2
    vCampo[056] := ''; //  56 Descrio dos Servios 3
    //
    vCampo[057] := Form7.ibDataSet13ENDERECO.Value;   //  57 Endereco do Emitente
    vCampo[059] := Form7.ibDataSet13MUNICIPIO.Value;  //  59 Cidade do Emitente
    vCampo[060] := Form7.ibDataSet13CEP.Value;        //  60 C.E.P. Emitente
    vCampo[061] := UpperCase(Form7.ibDataSet13ESTADO.AsString);     //  61 Estado do Emitente
    vCampo[062] := Copy(Form7.ibDataSet15NUMERONF.AsString,1,9);   //  62 Nmero da Nota Fiscal
    //
    vCampo[064] := Form7.ibDataSet15IDENTIFICADOR1.Value;     //  Identificador 1
    //
    vCampo[067] := Form7.ibDataSet13NOME.Value;       //  67 Nome do emitente
    vCampo[098] := Form7.ibDataSet15VENDEDOR.Value;     //  98 Nome do vendedor
    vCampo[090] := 'NSU: '+Form7.ibDataSet15NSU.Value;  //  90 NSU
    vCampo[091] := 'Geracao da NSU: '+Form7.ibDataSet15NSUD.AsString +' '+ Copy(Form7.ibDataSet15NSUH.AsString,1,5);  //  Gerao da NSU:

    // Passa os dados do arquivo ITENS001 para os vetores
    I := 0;

    while (not Form7.ibDataSet16.Eof) do // Disable
    begin
      if (Form7.ibDataSet16DESCRICAO.AsString <> '') and (Form7.ibDataSet16QUANTIDADE.AsFloat > 0) then
      begin
        Form7.ibDataSet4.Close;                                                //
        Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
        Form7.ibDataSet4.Open;

        vCampo[01000 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 01000 Descrio do item
        vCampo[02000 + I] := Form7.ibDataSet16MEDIDA.Value;     // 02000 Unidades de medida do item
        vCampo[03000 + I] := Form7.ibDataSet16QUANTIDADE.Value; // 03000 Quantidades do item
        vCampo[04000 + I] := Form7.ibDataSet16UNITARIO.Value;   // 04000 Valor unitrio do item
        vCampo[05000 + I] := Form7.ibDataSet16QUANTIDADE.Value  //
                           * Form7.ibDataSet16UNITARIO.Value;   // 05000 Valor total do item
        if Form7.ibDataSet16IPI.AsFloat >= 0 then  vCampo[6000 + I] := Form7.ibDataSet16IPI.AsFloat else vCampo[6000 + I] := 0;        // 06000 % IPI do item
        vCampo[07000 + I] := (Form7.ibDataSet16QUANTIDADE.Value * Form7.ibDataSet16UNITARIO.Value * ( Form7.ibDataSet16IPI.Value / 100 )); // 07000 Valor IPI do item
        //
        vCampo[08000 + I] := Form7.ibDataSet16ICM.Value;        // 08000 % ICM do item
        vCampo[09000 + I] := Form7.ibDataSet16CODIGO.Value;     // 09000 Cdigos do item

        // Procura o produto no estoque
        if Form7.ibDataSet4CODIGO.Value = Form7.ibDataSet16CODIGO.Value then
        begin
          vCampo[11000 + I] := Form7.ibDataSet4CF.Value;          // 11000 CF do item
          vCampo[12000 + I] := Form7.ibDataSet4CST.Value;         // 12000 ST do item
          vCampo[13000 + I] := Form7.ibDataSet4REFERENCIA.Value;  // 13000 Referncia
        end;

        vCampo[14000 + I] := Form7.ibDataSet16CFOP.Value;  // 14000 CFOP do item
        vCampo[15000 + I] := Form7.ibDataSet4LOCAL.Value;  // 15000 Local do item

        I := I + 1;
      end else
      begin
        // DESCRICAO NO CORPO DA NOTA
        if (Form7.ibDataSet16DESCRICAO.AsString <> '') then
        begin
          vCampo[01000 + I] := Form7.ibDataSet16DESCRICAO.Value;  // 150 Descrio do item
          I := I + 1;
        end;
      end;
      Form7.ibDataSet16.next;
    end;

    vCampo[020] := Form7.ibDataSet15SERVICOS.Value;   //  20 Base de Clculo do ISS
    if Form7.ibDataSet15SERVICOS.AsFloat <> 0 then vCampo[021] := Form7.ibDataSet15ISS.AsFloat / Form7.ibDataSet15SERVICOS.AsFloat * 100 else vCampo[021] := 0;
    vCampo[022] := Form7.ibDataSet15ISS.Value;          //  22 Valor total do ISS
    vCampo[023] := Form7.ibDataSet15BASEICM.Value;      //  23 Base de Clculo do ICMS
    vCampo[025] := Form7.ibDataSet15ICMS.Value;         //  25 Valor do ICM
    vCampo[026] := Form7.ibDataSet15BASESUBSTI.Asfloat; //  26 Base de subst
    vCampo[027] := Form7.ibDataSet15ICMSSUBSTI.AsFloat; //  27 ICMS de Subst
    vCampo[028] := Form7.ibDataSet15MERCADORIA.Value;   //  28 Total dos Produtos
    vCampo[029] := Form7.ibDataSet15FRETE.Value;        //  29 Valor do frete
    vCampo[030] := Form7.ibDataSet15SEGURO.Value;       //  30 Seguro
    vCampo[031] := Form7.ibDataSet15DESPESAS.Value;     //  31 Outras despesas
    vCampo[032] := Form7.ibDataSet15IPI.Value;          //  32 Valor total do IPI
    vCampo[033] := Form7.ibDataSet15TOTAL.Value;        //  33 Valor total da nota
    vCampo[046] := Form7.ibDataSet15DESCONTO.Value;     //  29 Valor do desconto
    vCampo[069] := vCampo[0330];
    vCampo[085] := Form7.ibDataSet15MERCADORIA.Value;   //  Valor total dos produtos

    vCampo[063] := Alltrim(Extenso(vCampo[033]));
    // Imposto de renda: Se o valor for maior do que o Teto limite para tributao de IR sobre servios tributa: Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;
    try
      if vCampo[020] >= Form1.ConfLimite  then vCampo[068] := vCampo[020] * ((Form1.ConfIR / 100) * 1) else vCAmpo[068] := 0;
    except end;
    //
    J := 0;

    // servicos
    Form7.ibDataSet35.First;
    while not Form7.ibDataSet35.Eof do
    begin
      if (Form7.ibDataSet35DESCRICAO.AsString <> '') then
      begin
        vCampo[2150 + J] := Form7.ibDataSet35DESCRICAO.Value;  // 2150 Descrio do item de servico
        vCampo[2300 + J] := Form7.ibDataSet35QUANTIDADE.Value; // 2300 Quantidades do item de servico
        if Form7.ibDataSet35QUANTIDADE.AsFloat <> 0 then vCampo[2350 + J] := Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.Asfloat;   // 2350 Valor unitrio do item de servico
        vCampo[2400 + J] := Form7.ibDataSet35TOTAL.Value;      // 2400 Valor total do item de servico
        vCampo[2600 + J] := '   ';
        //
        J := J + 1;
      end;
      Form7.ibDataSet35.Next;
    end;
  end;

  Form7.SaveDialog1.FileName := 'SmallNF'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9)+'.TXT';
  Form7.SaveDialog1.Title    := 'Exportar Nota Fiscal';

  if not Form7.SaveDialog1.Execute then
    Exit;

  DeleteFile(pChar(Form7.SaveDialog1.FileName));
  AssignFile(F, Form7.SaveDialog1.FileName);
  Rewrite(F);

  for I := 1 to 30000 do
  begin
    vTipo := VarType(vCampo[I]);

    //if (vTipo = varString) then Mauricio Parizotto 2024-01-10
    if (vTipo = varUString) then
    begin
      if Alltrim(vCampo[I]) <> '' then
        Writeln(F,StrZero(I,5,0)+'='+vCampo[I]);
    end;

    if (vTipo = varDouble) then
    begin
      Writeln(F,StrZero(I,5,0)+'='+StrZero(vCampo[I],14,4));
    end;
  end;

  CloseFile(F);
end;    *)

(*
function EnviarEMail(sDe, sPara, sCC, sAssunto, sTexto, cAnexo: string; bConfirma: Boolean): Integer;
const
  _cNomeMailEXE = 'email.exe';
type
  TAttachAccessArray = array [0..0] of TMapiFileDesc;
  PAttachAccessArray = ^TAttachAccessArray;
var
{
  RetVal : Integer;
}
  Mais1Ini : tIniFile;
  sAtual : String;
  Msg: TMapiMessage;
  lpSender, lpRecepient, lpComCopia: TMapiRecipDesc;
  FileAttach: TMapiFileDesc;
  SM: TFNMapiSendMail;
  MAPIModule: HModule;
  Flags: Cardinal;
  slAnexos: TStringList;
  Attachments: PAttachAccessArray;

  i: Integer;
  //
begin
  //
  GetDir(0,sAtual);
  //
  Mais1ini := TIniFile.Create('frente.ini');
  //
  if FileExists(pChar('mail.exe')) and (Mais1Ini.ReadString('mail','Host','') <> '') then
  begin
    //
    while FileExists(pChar('email.exe')) do
    begin
      DeleteFile(pChar(Form1.sAtual+'\email.exe'));
      sleep(10);
    end;
    //
    while not FileExists(pChar('email.exe')) do
    begin
      CopyFile(pChar(Form1.sAtual+'\mail.exe'), pChar(Form1.sAtual+'\email.exe'),True);
      sleep(10);
    end;
    //
    ShellExecute( 0, 'Open', pChar(Form1.sAtual+'\'+_cNomeMailEXE) , pChar(sPara+' '+'"'+sAssunto+'"'+' '+'"'+sTexto+'"'+' '+'"'+cAnexo+'"'), '', SW_Show);
    // Deve aguardar o processo do mail finalizar o processo de envio
    while processExists(_cNomeMailEXE) do
    begin
      Sleep(250);
    end;
    //
    Result := 1;
  end else
  begin
    // cria propriedades da mensagem
    FillChar(Msg, SizeOf(Msg), 0);
    //
    with Msg do
    begin
      if (sAssunto <> '') then
        //lpszSubject := PChar(sAssunto);  Mauricio Parizotto 2023-12-29
        lpszSubject := PAnsiChar(AnsiString(sAssunto));

      if (sTexto <> '')   then
        //lpszNoteText := PChar(sTexto); //Corpo da Mensagem Mauricio Parizotto 2023-12-29
        lpszNoteText := PAnsiChar(AnsiString(sTexto)); //Corpo da Mensagem

      // remetente
      if (sDe <> '') then
      begin
        lpSender.ulRecipClass := MAPI_ORIG;
        //lpSender.lpszName := PChar(sDe); Mauricio Parizotto 2023-12-29
        lpSender.lpszName := PAnsiChar(AnsiString(sDe));
        //lpSender.lpszAddress := PChar(sDe); Mauricio Parizotto 2023-12-29
        lpSender.lpszAddress := PAnsiChar(AnsiString(sDe));
        lpSender.ulReserved := 0;
        lpSender.ulEIDSize := 0;
        lpSender.lpEntryID := nil;
        lpOriginator := @lpSender;
      end;

      // destinatrio
      if (sPara <> '') then
      begin
        //
        if not bConfirma then
        begin
          sPara := StrTran(StrTran(sPara,';','><'),' ','');
          sPara := StrTran(sPara,'><','>;<');
        end;
        //
        lpRecepient.ulRecipClass := MAPI_TO;
        //lpRecepient.lpszName := PChar(''); Mauricio Parizotto 2023-12-19
        lpRecepient.lpszName := PAnsiChar(AnsiString(''));
        //lpRecepient.lpszAddress := PChar(sPara); Mauricio Parizotto 2023-12-19
        lpRecepient.lpszAddress := PAnsiChar(AnsiString(sPara));
        lpRecepient.ulReserved := 0;
        lpRecepient.ulEIDSize := 0;
        lpRecepient.lpEntryID := nil;
        nRecipCount := 1;
        lpRecips := @lpRecepient;
      end else
      begin
        if (sCC <> '') then
        begin
          lpComCopia.ulRecipClass := MAPI_CC;
          //lpComCopia.lpszName     := PChar(sCC);
          lpComCopia.lpszName     := PAnsiChar(AnsiString(sCC));
          //lpComCopia.lpszAddress  := PChar(sCC);
          lpComCopia.lpszAddress  := PAnsiChar(AnsiString(sCC));
          lpComCopia.ulReserved   := 0;
          lpComCopia.ulEIDSize    := 0;
          lpComCopia.lpEntryID    := nil;
          nRecipCount             := 1;
          lpRecips                := @lpComCopia;
        end else
        begin
          lpRecips := nil;
        end;
      end;
      // arquivo anexo
      if (cAnexo = '') then
      begin
        nFileCount := 0;
        lpFiles := nil;
      end else
      begin
        slAnexos := RetornaListaQuebraLinha(cAnexo);
        try
          if slAnexos.Count > 0 then
          begin
            GetMem(Attachments, SizeOf(TMapiFileDesc) * slAnexos.Count);
            for i := 0 to Pred(slAnexos.Count) do
            begin
              Attachments[i].ulReserved := 0;
              Attachments[i].flFlags := 0;
              Attachments[i].nPosition := ULONG($FFFFFFFF);
              Attachments[i].lpszPathName := StrNew( PAnsichar(PChar(slAnexos.Strings[i]) ));
              Attachments[i].lpszFileName :=
              StrNew( PAnsichar(PChar( ExtractFileName(slAnexos.Strings[i]) ) ));
              Attachments[i].lpFileType := nil;
            end;
          end
          {endif};
          nFileCount := slAnexos.Count;
          lpFiles := @Attachments^;
        finally
          FreeAndNil(slAnexos);
        end;
      end;

      // carrega dll e o mtodo sPara envio do email
      MAPIModule := LoadLibrary(PChar(MAPIDLL));
      if MAPIModule = 0 then
      begin
        Result := -1
      end else
      begin
        try
          if bConfirma then
          begin
            Flags := MAPI_DIALOG or MAPI_LOGON_UI;
          end else
          begin
            Flags := 0;
          end;
          //
          @SM := GetProcAddress(MAPIModule, 'MAPISendMail');
          if @SM <> nil then
          begin
            Result := SM(0, Application.Handle, Msg, Flags, 0);
          end else
          begin
            Result := 1;
          end;
        finally
          FreeLibrary(MAPIModule);
        end;
      end;
    end;

  end;

  Mais1Ini.Free;

  CHDir(sAtual);
end;
*)

function CriaJpg(sP1: String) :Boolean;
var
  jp: TJPEGImage;  //Requires the "jpeg" unit added to "uses" clause.
begin
  if FileExists(Form1.sAtual+'\LOGOTIP.BMP') then
    Form14.Image1.Picture.LoadFromFile(Form1.sAtual+'\LOGOTIP.BMP')
  else
    Form14.Image1.Picture := Form1.Image1.Picture;

  try
    jp := TJPEGImage.Create;
    jp.Assign(Form14.Image1.Picture.Bitmap);
    jp.CompressionQuality := 100;
    jp.SaveToFile('logotip.jpg');
  except
  end;

  Result := True;
end;

function MostraLabels(tSp1: tImage; tSp2: TLabel): Boolean;
begin
  if Form19.CheckBox8.Checked then
  begin
    with Form1 do
    begin
      tSp2.OnClick     := tSp1.OnClick;
      tSp2.Width       := tSp1.Width;
      tSp2.Top         := -5; // tSp1.Top; // + tSp1.Height -20;
      tSp2.Left        := tSp1.Left;

      // if Form1.sContrasteCor = 'BRANCO' then tSp2.Font.Color := clWhite;
      // if Form1.sContrasteCor = 'PRETO' then tSp2.Font.Color := clBlack;
      // if Form1.sContrasteCor = 'ROSA' then tSp2.Font.Color := clFuchsia;
      // if Form1.sContrasteCor = 'AZUL' then tSp2.Font.Color := clBlack;
      //
      // tSp2.Font.Color := $00F5CB58;
      tSp2.Font.Color := clBlack;
      //
      tSp2.visible     := True;
      tsP2.Repaint;
    end;
  end else
  begin
    with Form1 do
    begin
      tSp2.visible     := False;
    end;
  end;
  //
  Result := True;
end;


function JaTem(p1:tibDataSet; p2:tField; p3: boolean):Boolean;
var
  sReg1, sReg2 : String;
  sDescricao : String;
begin
  Result := False;
  //
  with Form7 do
  begin
    if (AllTrim(p2.AsString) = AllTrim(ibDataSet4DESCRICAO.ASString)) and (Form7.ibDataSet4.FieldByname('SERIE').Value <> 1) then
    begin
      p1.DisableControls;
      sDescricao := p2.AsString;
      //
      sReg1 := p1.FieldByname('REGISTRO').AsString;
      p1.First;
      //
      while not p1.EOF do
      begin
        //
        if (AllTrim(p2.AsString) = AllTrim(sDescricao)) and (sReg1 <> p1.FieldByname('REGISTRO').AsString) then
        begin
          //
          sREg2 := p1.FieldByname('REGISTRO').AsString;
          //
          if p3 then
          begin
            p1.Locate('REGISTRO',sREg1,[]);
            p1.Delete;
            sREg1 := sREg2;
            p1.EnableControls;
            //ShowMessage('Este item j est relacionado.'); Mauricio Parizotto 2023-10-25
            MensagemSistema('Este item j est relacionado.');
          end;
          Result := True;
        end;
        p1.Next;
      end;

      p1.Locate('REGISTRO',sREg1,[]);
      p1.EnableControls;
      if Form12.dbGrid1.CanFocus then
      begin
        if Form12.Visible then
          Form12.dbGrid1.SetFocus;
      end;
      if Form24.dbGrid1.CanFocus then
      begin
        if Form24.Visible then
          Form24.dbGrid1.SetFocus;
      end;

      {Mauricio Parizotto 2024-01-004
      if p1.MoveBy(+1) = 1 then
        p1.MoveBy(-1)
      else if p1.MoveBy(-1) = -1 then
        p1.MoveBy(+1);
      }
    end;
  end;
end;

function Totalizaservicos(sP1: Boolean):Boolean;
begin
  // Servicos
  if Form7.sModulo = 'VENDA' then
  begin
    if (Form7.ibDataSet15NUMERONF.AsString = Form7.ibDataSet35NUMERONF.AsString) then //  Sandro Silva 2022-09-26
    begin
      // Totalizaservicos()  executando em vrios OnChange de campos do DataSet da tabela VENDAS.
      // Precisa validar VENDAS.NUMERONF = ITENS003.NUMERONF para no calcular ISS do primeiro item da nota anterior

      if AllTrim(Form7.ibDataSet35DESCRICAO.AsString) <> '' then
      begin
        //
        Form7.sModulo := 'No';
        //
        if Form7.sRPS = 'S' then
        begin
          Form7.ibQuery1.Close;
          Form7.ibQuery1.Sql.Clear;
          Form7.ibQuery1.Sql.Add('select ISS, BASEISS from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString));
          Form7.ibQuery1.Open;
        end else
        begin
          Form7.ibQuery1.Close;
          Form7.ibQuery1.Sql.Clear;
          Form7.ibQuery1.Sql.Add('select ISS, BASEISS from ICM where Coalesce(ISS,0)<>0 and Coalesce(BASEISS,0)<>0');
          Form7.ibQuery1.Open;
        end;
        //
        Form7.ibQuery3.Close;
        Form7.ibQuery3.Sql.Clear;
        Form7.ibQuery3.Sql.Add('select sum(ISS) as TOTALISS, sum(TOTAL) as SERVICOS from ITENS003 where NUMERONF='+QuotedStr(Form7.ibDataSet15NUMERONF.AsString)+'');
        Form7.ibQuery3.Open;
        //
        Form7.ibDataSet15.Edit;
        Form7.ibDataSet15SERVICOS.AsFloat := Form7.IBQuery3.FieldByname('SERVICOS').AsFloat;
        //
        // Abate o Desconto no ISS
        //
        //Ficha 6253
        {Sandro Silva 2022-09-21 inicio
        Form7.ibDataSet15ISS.AsFloat      := Form7.IBQuery3.FieldByname('TOTALISS').AsFloat - (Form7.ibDataSet15DESCONTO.AsFloat * Form7.ibDataSet14ISS.AsFloat / 100);
        Form7.ibDataSet35.Edit;
        //
        Form7.ibDataSet35ISS.AsFloat      := Form7.ibDataSet35TOTAL.AsFloat * Form7.ibQuery1.FieldByname('ISS').AsFloat / 100 * Form7.ibQuery1.FieldByname('BASEISS').AsFloat / 100;
        }
        Form7.ibDataSet15ISS.AsFloat      := Form7.IBQuery3.FieldByname('TOTALISS').AsFloat - CalculaValorISS(Form7.oArqConfiguracao.NFSe.InformacoesObtidasNaPrefeitura.PadraoProvedor, Form7.ibDataSet15DESCONTO.AsFloat, Form7.ibQuery1.FieldByname('ISS').AsFloat, Form7.ibQuery1.FieldByname('BASEISS').AsFloat); // Sandro Silva 2023-10-02 Form7.ibDataSet15ISS.AsFloat      := Form7.IBQuery3.FieldByname('TOTALISS').AsFloat - (Form7.ibDataSet15DESCONTO.AsFloat * Form7.ibDataSet14ISS.AsFloat / 100);
        Form7.ibDataSet35.Edit;
        //
        // Sandro Silva 2023-10-02 Form7.ibDataSet35ISS.AsFloat      := Form7.Formata2CasasDecimais(Form7.ibDataSet35TOTAL.AsFloat * Form7.ibQuery1.FieldByname('ISS').AsFloat / 100 * Form7.ibQuery1.FieldByname('BASEISS').AsFloat / 100);
        Form7.ibDataSet35ISS.AsFloat      := Form7.Formata2CasasDecimais(CalculaValorISS(Form7.oArqConfiguracao.NFSe.InformacoesObtidasNaPrefeitura.PadraoProvedor, Form7.ibDataSet35TOTAL.AsFloat, Form7.ibQuery1.FieldByname('ISS').AsFloat, Form7.ibQuery1.FieldByname('BASEISS').AsFloat));
        Form7.ibDataSet35BASEISS.AsFloat  := Form7.Formata2CasasDecimais(Form7.ibDataSet35TOTAL.AsFloat * Form7.ibQuery1.FieldByname('BASEISS').AsFloat / 100);
        {Sandro Silva 2022-09-21 fim}
        //
        Form7.sModulo := 'VENDA';
        //
      end;
    end;
  end;
  Result := True;
end;


function TotalizaOS(TotProd, TotServ: Boolean):Boolean;
var
  MyBookMark, MyBookMark1 : TBookMark;
begin
  Form7.ibDataSet3.Edit;

  // Produtos
  if TotProd then // Mauricio Parizotto 2024-02-08
  begin
    MyBookMark := Form7.ibDataSet16.GetBookMark();
    Form7.ibDataSet16.DisableControls;
    Form7.ibDataSet16.First;
    Form7.ibDataSet3TOTAL_PECA.AsFloat := 0;
    while not Form7.ibDataSet16.Eof do // disable
    begin
      Form7.ibDataSet3TOTAL_PECA.AsFloat := Form7.ibDataSet3TOTAL_PECA.AsFloat + Form7.ibDataSet16TOTAL.AsFloat;
      Form7.ibDataSet16.Next;
    end;
  end;

  Form7.ibDataSet16.GotoBookmark(MyBookMark);
  if Form7.sModulo <> 'RETRIBUTA' then
    Form7.ibDataSet16.EnableControls;
  Form7.ibDataSet16.Edit;

  // Servicos
  if TotServ then // Mauricio Parizotto 2024-02-08
  begin
    MyBookMark1 := Form7.ibDataSet35.GetBookMark();
    Form7.ibDataSet35.DisableControls;
    Form7.ibDataSet35.First;
    Form7.ibDataSet3TOTAL_SERV.AsFloat := 0;
    while not Form7.ibDataSet35.Eof do
    begin
      Form7.ibDataSet3TOTAL_SERV.AsFloat := Form7.ibDataSet3TOTAL_SERV.AsFloat + Form7.ibDataSet35TOTAL.AsFloat;
      Form7.ibDataSet35.Next;
    end;
  end;

  Form7.ibDataSet35.GotoBookmark(MyBookMark1);
  Form7.ibDataSet35.EnableControls;
  Form7.ibDataSet35.Edit;

  Form7.ibDataSet3TOTAL_OS.AsFloat := Form7.ibDataSet3TOTAL_FRET.AsFloat + Form7.ibDataSet3TOTAL_SERV.AsFloat + Form7.ibDataSet3TOTAL_PECA.AsFloat - Form7.ibDataSet3DESCONTO.AsFloat;

  Result := True;
end;

function Valida_Campo(Arquivo: String; Text: String;
  Indice, Mensagem: String): Boolean;
begin
  try
    Form7.ibDataSet100.Close;
    Form7.ibDataSet100.SelectSQL.Clear;
    //Form7.ibDataSet100.SelectSQL.Add('select * from '+Arquivo+' where '+Indice+'= '+QuotedStr(TExt)+''); Mauricio Parizotto 2023-09-11
    Form7.ibDataSet100.SelectSQL.Text := 'select * from '+Arquivo+' where Upper('+Indice+') = Upper( '+QuotedStr(TExt)+')';
    Form7.ibDataSet100.Open;

    //if Form7.ibDataSet100.FieldByname(Indice).AsString = Text thenMauricio Parizotto 2023-09-11
    if not Form7.ibDataSet100.IsEmpty then
    begin
      if Indice <> 'CEP' then
      begin
        if Mensagem <> '' then
          {
          Application.MessageBox(Pchar(Mensagem)
                                 ,'Ateno',mb_Ok + MB_ICONWARNING);
          Mauricio Parizotto 2023-10-24}
          MensagemSistema(Mensagem,msgAtencao);
      end else
      begin
        try
          if Alltrim(Form7.ibDataSet2CIDADE.AsString) = '' then
            Form7.ibDataSet2CIDADE.AsString := Form7.ibDataSet100.FieldByname('CIDADE').AsString;
          if Alltrim(Form7.ibDataSet2ESTADO.AsString) = '' then
            Form7.ibDataSet2ESTADO.AsString := Form7.ibDataSet100.FieldByname('ESTADO').AsString;
          if Alltrim(Form7.ibDataSet2COMPLE.AsString) = '' then
          begin
            if Copy(Form7.ibDataSet100.FieldByname('CEP').AsString,7,3) <> '000' then
              Form7.ibDataSet2COMPLE.AsString := Form7.ibDataSet100.FieldByname('COMPLE').AsString;
          end;
        except
        end;
      end;
      Result := False;
    end else
    begin

      Result := True;
    end;
  except
    Result := False;
  end;
end;

{                                   }
{ Joga p/obs a obs na tabela de icm }
{                                   }
function ObservacaoProduto(pP1:Boolean):Boolean;
begin
  // Relacionado ao produto
  //
  if (Copy(Form7.ibDataSet14OBS.AsString,1,24) <> 'PERMITE O APROVEITAMENTO') and  (Copy(Form7.ibDataSet14OBS.AsString,1,24) <> 'DEVOLUCAO DA NF-e')  then
  begin
    try
      if Form7.IBQuery14.Active then
      begin
        if Pos(Alltrim(LimpaLetras(Form7.ibQuery14.FieldByname('OBS').AsString)),LimpaLetras(Form7.ibDataSet15COMPLEMENTO.AsString)) = 0 then
        begin
          {Sandro Silva 2023-11-28 inicio}
          if not (Form7.ibDataSet15.State in [dsEdit, dsInsert]) then
            Form7.ibDataSet15.Edit; 
          {Sandro Silva 2023-11-28 fim}
          Form7.ibDataSet15COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString) + ' ' + Form7.ibQuery14.FieldByname('OBS').AsString; // Nunca limpa s vai acrescentando OK
        end;
      end
    except
    end;
  end;
  //
  Result := True;
end;

function ObservacaoOperacao(pP1:Boolean):Boolean;
var
  sRef : String;
begin
  // Relacionado a operacao
  try
    // Sandro Silva 2023-05-18 if Form7.ibDataSet15FINNFE.AsString <> '4' then // Devolucao Devoluo No deve mudar
    if NFeFinalidadeDevolucao(Form7.ibDataSet15FINNFE.AsString) = False then // Devolucao Devoluo No deve mudar
    begin
      if pP1 then
      begin
        // Quando o parametro pP1 e true se nao contem limpa tudo e poe
        if (Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO') then
        begin
          if (Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,24) <> 'PERMITE O APROVEITAMENTO') then
          begin
            Form7.ibDataSet15COMPLEMENTO.AsString := '   ';
            Form12.sObservacaoAntiga := '   ';
          end;
        end else
        begin
          if Pos(Alltrim(Form7.ibDataSet14OBS.AsString),Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
          begin
            sRef := '';
            if Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,30) = 'NF REFERENTE AO CUPOM FISCAL: ' then
              sRef := Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,36+11);
            if Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,19) = 'NF REFERENTE A OS: ' then
              sRef := Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,29);
            if Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,27) = 'NF REFERENTE AO ORAMENTO: ' then
              sRef := Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,33);

            Form7.ibDataSet15COMPLEMENTO.AsString := sRef + AllTrim(Form7.ibDataSet14OBS.AsString);

            Form12.sObservacaoAntiga := Form7.ibDataSet14OBS.AsString;
          end;
        end;
      end else
      begin
        if (Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO') then
        begin
          if (Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1,24) <> 'PERMITE O APROVEITAMENTO') then
          begin
            Form7.ibDataSet15COMPLEMENTO.AsString := '   ';
            Form12.sObservacaoAntiga := '   ';
          end;
        end else
        begin
          if Pos(AllTrim(Form7.ibDataSet14OBS.AsString),Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
          begin
            //
            if (Pos( LimpaLEtras(Form12.sObservacaoAntiga), LimpaLetras(Form7.ibDataSet15COMPLEMENTO.AsString) ) <> 0) and (Pos( AllTrim(Form12.sObservacaoAntiga), Form7.ibDataSet15COMPLEMENTO.AsString ) = 0) then
            begin
              if AllTrim(Form12.sObservacaoAntiga) <> AllTrim(Form7.ibDataSet14OBS.AsString) then
              begin
                Form7.ibDataSet15COMPLEMENTO.AsString := '';
              end;
            end;

            //if (Pos( LimpaLEtras(AllTrim(Form7.ibDataSet14OBS.AsString)), LimpaLetras(AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString)) ) = 0) then Mauricio Parizotto 2024-02-08 ficha 7828
            begin
              if (Pos(AllTrim(Form12.sObservacaoAntiga), Form7.ibDataSet15COMPLEMENTO.AsString) = 0) then
              begin
                Form7.ibDataSet15COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet14OBS.AsString) + ' ' + Form7.ibDataSet15COMPLEMENTO.AsString;
              end else
              begin
                if Pos(AllTrim(Form12.sObservacaoAntiga), AllTrim(Form7.ibDataSet14OBS.AsString)) = 0 then
                begin
                  Form7.ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,AllTrim(Form12.sObservacaoAntiga), AllTrim(Form7.ibDataSet14OBS.AsString));
                end else
                begin
                  Form7.ibDataSet15COMPLEMENTO.AsString := StringReplace(Form7.ibDataSet15COMPLEMENTO.AsString,AllTrim(Form12.sObservacaoAntiga),AllTrim(Form7.ibDataSet14OBS.AsString),[rfIgnoreCase]);
                end;
              end;
            end;

            Form12.sObservacaoAntiga := AllTrim(Form7.ibDataSet14OBS.AsString);
          end;
        end;
      end;
    end;
  except
  end;

  if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) = 'URB' then
  begin
    // Teste do PAF-ECF quando importa um cupom para NF
    if Pos( StrTran(ParamStr(1),'URB','') ,Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
    begin
      Form7.ibDataSet15COMPLEMENTO.AsString := 'MD-5: '+(StrTran(ParamStr(1),'URB',''))+ ' ' + AllTrim(Form7.ibDataSet15COMPLEMENTO.AsString);
      Form12.DBMemo1.ReadOnly := True;
    end;
  end;

  Result := True;
end;

function Observacao2(pP1:Boolean):Boolean;
begin
  if (pP1) then
  begin
    Form7.ibDataSet24.Edit;
    Form7.ibDataSet24COMPLEMENTO.AsString := Form7.ibDataSet14OBS.AsString;
  end else
  begin
    if Pos(Alltrim(Form7.ibDataSet14OBS.AsString),Form7.ibDataSet24COMPLEMENTO.AsString) = 0 then
    begin
      Form7.ibDataSet24.Edit;
      Form7.ibDataSet24COMPLEMENTO.AsString := AllTrim(Form7.ibDataSet24COMPLEMENTO.AsString) + ' ' + Form7.ibDataSet14OBS.AsString;
    end;
  end;

  if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) = 'URB' then
  begin
    // Teste do PAF-ECF quando importa um cupom para NF
    if Pos( StrTran(ParamStr(1),'URB','') ,Form7.ibDataSet24COMPLEMENTO.AsString) = 0 then
    begin
      Form7.ibDataSet24COMPLEMENTO.AsString := 'MD-5: '+(StrTran(ParamStr(1),'URB',''))+ ' ' + AllTrim(Form7.ibDataSet24COMPLEMENTO.AsString);
    end;
  end;

  Result := True;
end;

procedure TForm7.Sair1Click(Sender: TObject);
begin
  Close;
  Form7.sModulo := '';
end;

procedure TForm7.IntegraBanco(Sender: TField);
begin
  if ibDataSet1.Modified then
    ibDataSet1.Post;
  //
  // Estorno
  //
  if (AllTrim(ibDataSet1CONTA.AsString) <> '') then
  begin
    ibDataSet12.Locate('NOME',Alltrim(ibDataSet1NOME.AsString),[loPartialKey]);
    if ibDataSet11.Locate('PLANO',AllTrim(ibDataSet12CONTA.AsString),[loPartialKey]) then
    begin
      ibDataSet5.Close;
      ibDataSet5.SelectSQL.Clear;
      ibDataSet5.SelectSQL.Add('select * FROM MOVIMENT where NOME=' + QuotedStr(Form1.sEscolhido) + 'and EMISSAO = '+QuotedStr(DateToStrInvertida(ibDataSet1DATA.AsDateTime))+' order by COMPENS');
      ibDataSet5.Open;
      while not ibDataSet5.Eof do
      begin
        if (ibDataSet5HISTORICO.AsString = ibDataSet1HISTORICO.AsString) then
        begin
          if (ibDataSet1SAIDA.AsFloat <> ibDataSet5ENTRADA_.AsFloat) or (ibDataSet1ENTRADA.AsFloat <> ibDataSet5SAIDA_.AsFloat) then
          begin
            ibDataSet5.Delete;
            ibDataSet5.Last;
            ibDataSet1.Edit;
            ibDataSet1CONTA.AsString := '';
          end;
        end;
        ibDataSet5.Next;
      end;
    end;
  end;
  //
  // Lanamento
  //
  if (AllTrim(ibDataSet1CONTA.AsString) = '') and (AllTrim(ibDataSet1NOME.AsString) <> '') then
  begin
    if ibDataSet1ENTRADA.AsFloat + ibDataSet1SAIDA.AsFloat <> 0 then
    begin
      ibDataSet12.Locate('NOME',Alltrim(ibDataSet1NOME.AsString),[loPartialKey]);
      if ibDataSet11.Locate('PLANO',AllTrim(ibDataSet12CONTA.AsString),[loPartialKey]) then
      begin
        //
        Form1.sEscolhido := ibDataSet11NOME.AsString;
        ibDataSet5.Close;
        ibDataSet5.SelectSQL.Clear;
        ibDataSet5.SelectSQL.Add('select * FROM MOVIMENT where NOME=' + QuotedStr(ibDataSet11NOME.AsString) + ' order by COMPENS');
        ibDataSet5.Open;
        ibDataSet5.Append;
        ibDataSet5HISTORICO.AsString := ibDataSet1HISTORICO.AsString;
        ibDataSet5EMISSAO.AsDateTime := ibDataSet1DATA.AsDateTime;
        ibDataSet5ENTRADA_.AsFloat   := ibDataSet1SAIDA.AsFloat;
        ibDataSet5SAIDA_.AsFloat     := ibDataSet1ENTRADA.AsFloat;
        ibDataSet5.Post;
        //
        ibDataSet1.Edit;
        ibDataSet1CONTA.AsString := ibDataSet12CONTA.AsString;
        ibDataSet1.Post;
        //
      end;
    end;
  end;
end;

procedure TForm7.CalculaSAldo(Sender: Boolean);
var
  sW : String;
  SaldoAnterior : Real;
  I : Integer;
begin
  //
  sW      := '';
  //
  if not bNaoCalculaSaldo then
  begin
    //
    for I := 1 to 9999999 do
      Form7.fSaldoVetorCaixa[I] := 0;
      
    SaldoAnterior  := 0;
    Form7.ibDataSet1.DisableControls;
    sRegistro := Form7.ibDataSet1REGISTRO.AsString;
    //
    if ibDataSet1.Modified then
      ibDataSet1.Post;
    //
    if (Pos('where',ibDataSet1.SelectSQL.Text) <> 0) or (Pos('skip',ibDataSet1.SelectSQL.Text) <> 0) then
    begin
      sW := ibDataSet1.SelectSQL.Text;
      ibDataSet1.Close;
      ibDataSet1.SelectSQL.Clear;
      ibDataSet1.SelectSQL.Add('select * from CAIXA order by DATA, REGISTRO');
      ibDataset1.Open;
      Sender := True;
    end;
    //
    // if Sender then
    //
    Form7.ibDataSet1.First;
    while not Form7.ibDataSet1.Eof do
    begin
      SaldoAnterior := SaldoAnterior + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
      try
        Form7.fSaldoVetorCaixa[Form7.ibDataSet1REGISTRO.AsInteger] := SaldoAnterior;
      except
      end;
      Form7.ibDataSet1.Next;
    end;
    //
    if sW <> '' then
    begin
      ibDataSet1.Close;
      ibDataSet1.SelectSQL.Clear;
      ibDataSet1.SelectSQL.Add(sW);
      ibDataset1.Open;
    end;
    //
    if Sender then
      Form7.ibDataSet1.Locate('REGISTRO',sRegistro,[]);
    Form7.ibDataSet1.EnableControls;
    //
  end;
  //
end;

procedure TForm7.SaldoBanco(Sender: Boolean);
var
  sW: String;
  SaldoAnterior: Real;
  sRegistroS: String;
begin
  //
  Screen.Cursor            := crHourGlass;
  //
  sW      := '';
  //
  if not Form7.ibDataSet5.Active then
    Form7.ibDataSet5.Active := True;
  if not Form7.ibDataSet11.Active then
    Form7.ibDataSet11.Active := True;
  //
  if not bNaoCalculaSaldo and (Pos(' and ',ibDataSet5.SelectSQL.Text)=0) then
  begin
    SaldoAnterior  := 0;
    Form7.ibDataSet5.DisableControls;
    sRegistroS     := Form7.ibDataSet5.FieldByName('REGISTRO').AsString;
    //
    if Pos(' and ',ibDataSet5.SelectSQL.Text) <> 0 then
    begin
      sW := ibDataSet5.SelectSQL.Text;
      ibDataSet5.Close;
      ibDataSet5.SelectSQL.Clear;
      ibDataSet5.SelectSQL.Add('select * FROM MOVIMENT where NOME=' + QuotedStr(ibDataSet11NOME.AsString) + ' order by COMPENS');
      ibDataset5.Open;
    end;
    //
    Form7.ibDataSet5.First;
    while (not Form7.ibDataSet5.Eof) do
    begin
      if (AllTrim(Form7.ibDataSet5.FieldByName('COMPENS').AsString)<>'') then
      begin
        SaldoAnterior := SaldoAnterior + Form7.ibDataSet5.FieldByName('ENTRADA_').AsFloat - Form7.ibDataSet5.FieldByName('SAIDA_').AsFloat;
        Form7.fSaldoVetorBanco[Form7.ibDataSet5.FieldByName('REGISTRO').AsInteger] := SaldoAnterior;
      end;
      Form7.ibDataSet5.Next;
    end;
    //
    Form7.ibDataSet11.Locate('NOME',ibDataSet5NOME.AsString,[]);
    Form7.ibDataSet11.Edit;
    Form7.ibDataSet11SALDO3.AsFloat := SaldoAnterior;
    Form7.ibDataSet11.Post;
    //
    if sW <> '' then
    begin
      ibDataSet5.Close;
      ibDataSet5.SelectSQL.Clear;
      ibDataSet5.SelectSQL.Add(sW);
      ibDataset5.Open;
    end;

    Form7.ibDataSet5.Locate('REGISTRO',sRegistroS,[]);
    Form7.ibDataSet5.EnableControls;
  end;

  Screen.Cursor            := crDefault;
end;

procedure TForm7.Image102Click(Sender: TObject);
begin
  {Mauricio Parizotto 2023-12-26 Inicio
  if (sModulo = 'OS') then
    Exit;
  }

  if (sModulo = 'OS') then
  begin
    ExcluirOS;
    Exit;
  end;
  {Mauricio Parizotto 2023-12-26 Fim}

  if (sModulo = 'ORCAMENTO') then
  begin
    ExcluirOrcamento;
    Exit;
  end;

  Form21.Show;
end;

function TForm7.TestarPodeExcluirOrcamento: Boolean;
begin
  Result := False;

  if IBDataSet97.FieldByName('Doc. Fiscal').AsString <> EmptyStr then
  begin
    //Application.MessageBox(PChar(_cOrcamentoComDocFiscal), PChar(_cTituloMsg), MB_ICONINFORMATION + MB_OK); Mauricio Parizotto 2023-10-24
    MensagemSistema(_cOrcamentoComDocFiscal,msgAtencao);
    Exit;
  end;
    
  Result := True;
end;

function TForm7.TestarPodeExcluirOS: Boolean;
begin
  Result := False;

  if (ibDataSet3.FieldByName('NF').AsString <> '') or (ibDataSet3.FieldByName('NFSE').AsString <> '') then
  begin
    Exit;
  end;
    
  Result := True;
end;

procedure TForm7.ExcluirOrcamento;
begin
  if TestarPodeExcluirOrcamento then
  begin
    if Application.MessageBox(PChar(_cMensagemExcluir), PChar(_cTituloMsg), MB_ICONQUESTION + MB_OKCANCEL + MB_DEFBUTTON1) = mrOk then
    begin
      IBDataSet97.DisableControls;
      try
        ibDataSet37.First;
        while not ibDataSet37.Eof do
        begin
          if ibDataSet37PEDIDO.AsString = IBDataSet97.FieldByName('Oramento').AsString then
          begin
            if IbdOrcamentObs.Locate('PEDIDO', ibDataSet37PEDIDO.AsString, []) then
              IbdOrcamentObs.Delete;
            ibDataSet37.Delete;
          end
          else
            ibDataSet37.Next;
        end;
        Form7.Close;
        Form7.Show;
      finally
        IBDataSet97.EnableControls;
      end;
    end;
  end;
end;

procedure TForm7.ExcluirOS;
var
  iErros : integer;
begin
  try
    //Para no dar scroll no grid e acabar exluindo outra OS
    DBGrid1.Enabled := False;

    if Application.MessageBox(PChar(_cMensagemExcluir), PChar(_cTituloMsg), MB_ICONQUESTION + MB_OKCANCEL + MB_DEFBUTTON1) = mrOk then
    begin
      if TestarPodeExcluirOS then
      begin
        iErros := 0;

        //Exclui Produtos
        if not ExecutaComando('Delete from ITENS001 Where NUMEROOS = '+QuotedStr(ibDataSet3NUMERO.AsString),ibDataSet3.Transaction) then
          Inc(iErros);

        //Exclui Servios
        if not ExecutaComando('Delete from ITENS003 Where NUMEROOS = '+QuotedStr(ibDataSet3NUMERO.AsString),ibDataSet3.Transaction) then
          Inc(iErros);

        //Exlui Anexos
        if not ExecutaComando('Delete from OSANEXOS Where IDOS = '+ibDataSet3IDOS.AsString,ibDataSet3.Transaction) then
          Inc(iErros);

        if iErros = 0 then
        begin
          ibDataSet3.Delete;

          DBGrid1.Enabled := True;
          Form7.Close;
          Form7.Show;
        end else
        begin
          MensagemSistema('Erro ao excluir produtos da ordem de servio.',msgAtencao);
        end;
      end else
      begin
        MensagemSistema('Esta Ordem de Servio j foi importada para um documento fiscal e no poder ser excluda.',msgAtencao);
      end;
    end;
  finally
    DBGrid1.Enabled := True;
    DBGrid1.SetFocus;
  end;
end;

procedure TForm7.Image103Click(Sender: TObject);
begin
  Form20.ShowModal;
end;

procedure TForm7.Image106Click(Sender: TObject);
begin
  FechaModulos;

  //Mauricio Parizotto 2023-09-21
  if sModulo = 'PARAMETROTRIBUTACAO' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmParametroTributacao = nil then
      FrmParametroTributacao := TFrmParametroTributacao.Create(Self);
      
    FrmParametroTributacao.Show;
    Exit;
  end;

  //Mauricio Parizotto 2023-11-17
  if sModulo = 'PERFILTRIBUTACAO' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmPerfilTributacao = nil then
      FrmPerfilTributacao := TFrmPerfilTributacao.Create(Self);

    FrmPerfilTributacao.Show;
    Exit;
  end;

  //Mauricio Parizotto 2023-11-17
  if sModulo = 'ICM' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmNaturezaOperacao = nil then
      FrmNaturezaOperacao := TFrmNaturezaOperacao.Create(Self);

    FrmNaturezaOperacao.Show;
    Exit;
  end;

  //Mauricio Parizotto 2023-12-04
  if sModulo = 'OSSITUACAO' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmSituacaoOS = nil then
      FrmSituacaoOS := TFrmSituacaoOS.Create(Self);

    FrmSituacaoOS.Show;
    Exit;
  end;

  {Sandro Silva 2024-01-17 inicio

  Reativar quando estiver concluda a migrao do cadastro de clientes usando a tela padro de cadastro

  if sModulo = 'CLIENTES' then
  begin
    if Form7.IBTransaction1.Active then
      Form7.IBTransaction1.CommitRetaining;
    if FrmFichaCadastros = nil then
      FrmFichaCadastros := TFrmFichaCadastros.Create(Self);

    FrmFichaCadastros.Show;
    Exit;
  end;
  {Sandro Silva 2024-01-17 fim}


  if sModulo = 'OS' then
  begin
    Form30.Show;
  end else
  begin
    if sModulo = 'VENDA' then
    begin
      if Form7.sRPS = 'S' then
      begin
         if (Form7.ibDataSet15EMITIDA.AsString <> 'X') and (Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString)=0) then
           Form48.Show;
      end else
      begin
        if not DenegadoOuCancelado(True) then
        begin
          if (Form7.ibDataSet15EMITIDA.AsString <> 'X') and (alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') and (Form7.ibDataSet15EMITIDA.AsString <> 'E') then
            Form12.Show;
        end;
      end;
    end else
    begin
      if sModulo = 'COMPRA' then
      begin
        VerificaItensInativos;
        Form24.Show;
      end else
      begin
        if sModulo = 'ORCAMENTO' then
        begin
          ShellExecute( 0, 'Open', 'orca.exe', '', '', SW_SHOW);
          sleep(1000);

          while ConsultaProcesso('orca.exe') or ConsultaProcesso('ORCA.EXE') do
          begin
            Form7.Caption := 'Aguarde o fechamento do programa de orcamentos...';
            Application.ProcessMessages;
            sleep(100);
          end;

          Form7.Caption := '';

          AgendaCommit(True);
          Form7.Close;
          Form7.Show;

          Form7.ibDataSet97.EnableControls;

          Abort;
        end else
        begin
          Form7.IBTransaction1.CommitRetaining;
          VerificaSeEstaSendoUsado(False);
          Form10.Show;
        end;
      end;
    end;
  end;
end;

procedure TForm7.VerificaItensInativos;
var
  cProdutos: String;
  nRecNo: Integer;
begin
  // Se tiver registro de itens vai validar os inativos
  if Form24.DBGrid1.DataSource.DataSet.RecordCount > 0 then
  begin
    nRecNo := Form24.DBGrid1.DataSource.DataSet.RecNo;
    Form24.DBGrid1.DataSource.DataSet.DisableControls;
    try
      Form24.DBGrid1.DataSource.DataSet.First;
      while not Form24.DBGrid1.DataSource.DataSet.Eof do
      begin
        if Form24.DBGrid1.DataSource.DataSet.FieldByName('CODIGO').AsString <> EmptyStr then
          cProdutos := cProdutos + QuotedStr(Form24.DBGrid1.DataSource.DataSet.FieldByName('CODIGO').AsString) + ',';

        Form24.DBGrid1.DataSource.DataSet.Next;
      end;

      TItensInativosImpXMLEnt.New
                             //.setDataBase(Self.IBDatabase1) Mauricio Parizotto 2024-01-19
                             .setDataBase(Self.IBDatabase1,Self.IBTransaction1)
                             .Executar(cProdutos);

      //Mauricio Parizotto 2024-01-19
      //if Self.IBTransaction1.Active then
      //  Self.IBTransaction1.CommitRetaining;
    finally
      Form24.DBGrid1.DataSource.DataSet.RecNo := nRecNo;
      Form24.DBGrid1.DataSource.DataSet.EnableControls;
    end;
  end;
end;

procedure TForm7.ibDataSet5NewRecord(DataSet: TDataset);
begin
  //
  ibDataSet5.Edit;
  ibDataSet5REGISTRO.AsString  := sProximo;
  ibDataSet5NOME.AsString      := Form1.sEscolhido;
  //
  ibDataSet5EMISSAO.Value      := Date;
  ibDataSet5PREDATA.Value      := Date;
  //
  bNaoCalculaSaldo             := True;
  ibDataSet5SAIDA_.Value       := 0;
  ibDataSet5ENTRADA_.Value     := 0;
  bNaoCalculaSaldo             := False;
  //
end;

procedure TForm7.ibDataSet1NewRecord(DataSet: TDataset);
begin
  //
  ibDataSet1.Edit;
  //
  ibDataSet1REGISTRO.AsString  := sProximo;
  bNaoCalculaSaldo             := True;
  ibDataSet1DATA.Value         := Date;
  ibDataSet1SAIDA.Value        := 0;
  ibDataSet1ENTRADA.Value      := 0;
  bNaoCalculaSaldo             := False;
  //
end;

procedure TForm7.Image6Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
begin
  {Fonte atual}
  try
    FontDialog1.Font.Name  := DBGrid1.Font.Name;
    FontDialog1.Font.Size  := DBGrid1.Font.Size;
    FontDialog1.Font.Color := DBGrid1.Font.Color;
    FontDialog1.Font.Style := DBGrid1.Font.Style;
    {Dialog box}
    FontDialog1.Execute;
    {Novas configuraes}
    DBGrid1.Font.Name  := FontDialog1.Font.Name;
    DBGrid1.Font.Size  := FontDialog1.Font.Size;
    DBGrid1.Font.Color := FontDialog1.Font.Color;
    DBGrid1.Font.Style := FontDialog1.Font.Style;
    //
    DBGrid1.TitleFont.Name  := FontDialog1.Font.Name;
    DBGrid1.TitleFont.Size  := FontDialog1.Font.Size + 0;
    DBGrid1.TitleFont.Color := FontDialog1.Font.Color;
  //  DBGrid1.TitleFont.sTyle := [fsBold];
    DBGrid1.TitleFont.sTyle := [];
    {Grava a nova Configurao .INF, sModulo  'CAIXA', ou 'CLIENTES' ou ...}
    Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
    Mais1Ini.WriteString(sModulo,'FonteName_',DBGrid1.Font.Name);
    Mais1Ini.WriteString(sModulo,'FonteSize_',IntToStr(DBGrid1.Font.Size));
    Mais1Ini.WriteString(sModulo,'FonteColor_',IntToStr(DBGrid1.Font.Color));
    //
    if DBGrid1.Font.sTyle = [fsBold]   then
      Mais1Ini.WriteString(sModulo,'FonteY_','fsBold');
    if DBGrid1.Font.sTyle = [fsItalic] then
      Mais1Ini.WriteString(sModulo,'FonteY_','fsItalic');
    if DBGrid1.Font.sTyle = []         then
      Mais1Ini.WriteString(sModulo,'FonteY_','');
    //
    Mais1Ini.Free;
    //
  except end;
  //
  try
    Form7.Close;
    Form7.Show;
  except end;
end;

procedure TForm7.Image101Click(Sender: TObject);
begin
  Form7.bEstaSendoUsado := False;

  FechaModulos;

  //Mauricio Parizotto 2023-09-21
  if sModulo = 'PARAMETROTRIBUTACAO' then
  begin
    if FrmParametroTributacao = nil then
      FrmParametroTributacao := TFrmParametroTributacao.Create(Self);
      
    FrmParametroTributacao.lblNovoClick(Sender);
    FrmParametroTributacao.Show;
    Exit;
  end;

  //Mauricio Parizotto 2023-11-17
  if sModulo = 'PERFILTRIBUTACAO' then
  begin
    if FrmPerfilTributacao = nil then
      FrmPerfilTributacao := TFrmPerfilTributacao.Create(Self);
      
    FrmPerfilTributacao.lblNovoClick(Sender);
    FrmPerfilTributacao.Show;
    Exit;
  end;

  //Mauricio Parizotto 2023-11-17
  if sModulo = 'ICM' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmNaturezaOperacao = nil then
      FrmNaturezaOperacao := TFrmNaturezaOperacao.Create(Self);

    FrmNaturezaOperacao.lblNovoClick(Sender);
    FrmNaturezaOperacao.Show;
    Exit;
  end;

  //Mauricio Parizotto 2023-12-04
  if sModulo = 'OSSITUACAO' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmSituacaoOS = nil then
      FrmSituacaoOS := TFrmSituacaoOS.Create(Self);

    FrmSituacaoOS.lblNovoClick(Sender);
    FrmSituacaoOS.Show;
    Exit;
  end;

  {Sandro Silva 2024-01-17 inicio

  Reativar quando estiver concluda a migrao do cadastro de clientes usando a tela padro de cadastro

  if sModulo = 'CLIENTES' then
  begin
    Form7.IBTransaction1.CommitRetaining;
    if FrmFichaCadastros = nil then
      FrmFichaCadastros := TFrmFichaCadastros.Create(Self);

    FrmFichaCadastros.lblNovoClick(Sender);
    FrmFichaCadastros.Show;
    Exit;
  end;
  {Sandro Silva 2024-01-17 fim}


  if sModulo = 'OS' then
  begin
    Form7.ibDataSet3.Append;
    Form7.ibDataSet3DATA_PRO.AsDateTime := Date;
    //Form7.ibDataSet3HORA_PRO.AsString   := TimeToStr(Time); Mauricio Parizotto 2024-01-03 Migrao delphi
    Form7.ibDataSet3HORA_PRO.AsString   := Copy(TimeToStr(Time),1,5);
    Form30.Show;
  end else
  begin
    if sModulo = 'VENDA' then
    begin

      if Form7.sRPS = 'S' then
      begin

        if Form1.ValidaRecursos.PermiteRecursoParaProduto then
        begin
          if Form1.ValidaRecursos.ValidaQtdDocumentoRetaguarda(Date) then
          begin
            Form7.ibDataSet15.Append;
            Form48.Show;
          end;
        end else
        begin
          Form1.MensagemRecursoIndisponivel('NFS-e no est disponvel para esta licena');
        end;
      end else
      begin
        if ValidaLimiteDeEmissaoDeVenda(Form1.ValidaRecursos.DataDoServidor) then
        begin
          Form7.ibDataSet15.Append;

          if ParamCount > 0 then
          begin
            if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) = 'URB' then
            begin
              Form12.ShowModal;
            end
            else
              Form12.Show;
          end
          else
            Form12.Show;
        end;
      end;
    end  else
    begin
      if sModulo = 'COMPRA' then
      begin
        {Sandro Silva 2023-11-28 inicio
        Form7.ibDataSet24.Append;
        Form24.Show;
        }
        Form7.ibDataSet24.DisableControls;
        //LogRetaguarda('Form7.ibDataSet24.DisableControls;: 3130'); // Sandro Silva 2023-11-27
        try
          Form7.ibDataSet24.Append;
          Form24.Show;
        finally
          Form7.ibDataSet24.EnableControls;
        end;
        {Sandro Silva 2023-11-28 fim}
      end else
      begin
        if sModulo = 'ORCAMENTO' then
        begin
          ShellExecute( 0, 'Open', 'orca.exe', '', '', SW_SHOW);
          sleep(1000);

          while ConsultaProcesso('orca.exe') or ConsultaProcesso('ORCA.EXE') do
          begin
            Form7.Caption := 'Aguarde o fechamento do programa de orcamentos...';
            Application.ProcessMessages;
            sleep(100);
          end;
          
          Form7.Caption := '';
          AgendaCommit(True);
          Form7.Close;
          Form7.Show;
          Form7.ibDataSet97.EnableControls;
          Abort;
        end else
        begin
//          Form10.bDesvincularCampos := False; // Sandro Silva 2024-01-04
          Form10.Show;
//          Form7.TabelaAberta.Cancel; //2024-01-03
          Form10.Image201Click(Sender);
//          Form7.TabelaAberta.Append; //2024-01-03
//          Form10.bDesvincularCampos := True; // Sandro Silva 2024-01-04
        end;
      end;
    end;
  end;
end;

procedure TForm7.Image109Click(Sender: TObject);
begin
  begin
    if (dBgrid1.SelectedField.FieldName = 'QTD_MINIM') then
    begin
      if Form7.sWhere = 'where QTD_ATUAL <= QTD_MINIM' then
        Form7.sWhere := ''
      else
        Form7.sWhere := 'where QTD_ATUAL <= QTD_MINIM'
    end
    else
      Form16.ShowModal;
    
    Form7.Close;
    Form7.Show;
  end;
end;

procedure TForm7.DBGrid1DblClick(Sender: TObject);
var
  Mais1Ini: TIniFile;
  sASP : String;
  bButton : Integer;
  F : TextFile;
begin
  // --------------------------------------------------------------------------------- //
  // duplo clique no XML da NF-e                                                       //
  // --------------------------------------------------------------------------------- //
  Screen.Cursor            := crHourGlass;

  try
    if DBGrid1.SelectedField.Name = 'ibDataSet4MARKETPLACE' then
    begin
      Form7.ibDataSet4.Edit;

      if Form7.ibDataSet4MARKETPLACE.AsString = '1' then
      begin
        Form7.ibDataSet4MARKETPLACE.AsString := '0';
      end else
      begin
        if ProdutoValidoParaMarketplace(True) = '' then
        begin
          Form7.ibDataSet4MARKETPLACE.AsString := '1';
        end else
        begin
          Form7.ibDataSet4MARKETPLACE.AsString := '0';
          //ShowMessage('Para vender este produto atravs de Marketplace'+chr(10)+'preencha pelo menos os seguintes campos: '+chr(10)+chr(10)+ProdutoValidoParaMarketplace(True)); Mauricio Parizotto 2023-10-25
          MensagemSistema('Para vender este produto atravs de Marketplace'+chr(10)+'preencha pelo menos os seguintes campos: '+chr(10)+chr(10)+ProdutoValidoParaMarketplace(True));
        end;
      end;

      Form7.ibDataSet4.Post;

      Screen.Cursor            := crDefault;
      Abort;
    end;

    if Pos('MDESTINXML',DBGrid1.SelectedField.Name) <> 0 then
    begin
      Manifestaododestinatrio1Click(Sender);

      Screen.Cursor            := crDefault;
      Abort;
    end;

    if Pos('STATUS',DBGrid1.SelectedField.Name) <> 0 then
    begin
      if ValidaLimiteDeEmissaoDeVenda(DBGrid1.DataSource.DataSet.FieldByName('EMISSAO').AsDateTime) then
      begin
        if not DenegadoOuCancelado(True) then
        begin
          EnviarConsultaImprimirDANFE;

          if Form7.sRPS = 'S' then
          begin
            {try
              Screen.Cursor := crHourGlass; // Cursor de Aguardo //
              if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) = 0 then
              begin
                Sleep(15000);

                  Form1.sConsultaNfse := 'SIM';
                  EnviarConsultaImprimirDANFE;
                  Form1.sConsultaNfse := 'NAO';
              end;
            except
            end; Mauricio Parizotto 2023-04-28}

            Application.ProcessMessages;

            EnviarNFSeporemail1Click(Sender);

            {try
              {try
                Form7.ibDAtaSet15.Post;
              except
              end;

              Screen.Cursor            := crHourGlass;
              AgendaCommit(True);

              Form7.Close;
              Form7.Show;

              Screen.Cursor            := crDefault;
              Form7.ibDAtaSet15.Edit;
            except
            end; Mauricio Parizotto 2023-04-28}

            Screen.Cursor            := crDefault;
            Form7.ibDataSet15.EnableControls;
          end;
        end;
      end;
      Exit;
    end;

    if Pos('NFEID',DBGrid1.SelectedField.Name) <> 0 then
    begin
      if sModulo = 'VENDA' then
      begin
        Clipboard.SetTextBuf(pchar(Form7.ibDataSet15NFEID.AsString));
      end else
      begin
        Clipboard.SetTextBuf(pchar(Form7.ibDataSet24NFEID.AsString));
      end;
      //    ShellExecute( 0, 'Open',pChar('http://www.nfe.fazenda.gov.br/PORTAL/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8='),'','', SW_SHOWMAXIMIZED); // Antigo
      //
      // ShellExecute( 0, 'Open',pChar('http://www.nfe.fazenda.gov.br/PORTAL/consultaRecaptcha.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8='),'','', SW_SHOWMAXIMIZED); // Atualizado em 19/03/18
      ShellExecute( 0, 'Open',pChar('http://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g='),'','', SW_SHOWMAXIMIZED); // Atualizado em 10/11/2021

      Screen.Cursor            := crDefault;
      Abort;
    end;

    if Pos('CCEXML',DBGrid1.SelectedField.Name) <> 0 then
    begin
      fNFe := Form7.ibDataSet15CCEXML.AsString;
      AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      WriteLn(F,fNFe);
      CloseFile(F); // Fecha o arquivo
      ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
      Abort;
    end;

    if Pos('RECIBOXML',DBGrid1.SelectedField.Name) <> 0 then
    begin
      if Form7.sRPS = 'S' then
      begin
        fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);

        if RetornaValorDaTagNoCampo('notaFiscal',fNFe) <> '' then
        begin
          fNFe := '<retorno>'+
                  '<notaFiscal>'+RetornaValorDaTagNoCampo('notaFiscal',fNFe)+'</notaFiscal>'+
                  '<sRetornoDaPrefeitura>'+RetornaValorDaTagNoCampo('sRetornoDaPrefeitura',fNFe)+'</sRetornoDaPrefeitura>'+
                  '</retorno>';
        end;

        if RetornaValorDaTagNoCampo('Nfse',fNFe) <> '' then
        begin
          fNFe := RetornaValorDaTagNoCampo('Nfse',fNFe);
        end;

        fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);

        try
          BuscaNumeroNFSe(True);
        except
        end;
      end;

      fNFe := Form7.ibDataSet15RECIBOXML.AsString;

      AssignFile(F,pchar(Form1.sAtual+'\tempo.txt'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      Write(F,fNFe);
      CloseFile(F); // Fecha o arquivo
      ShellExecute( 0, 'Open','tempo.txt','','', SW_SHOWMAXIMIZED);

      Abort;
    end;

    if Pos('NFEXML',DBGrid1.SelectedField.Name) <> 0 then
    begin
      if sModulo = 'VENDA' then
      begin
        if Form7.sRPS = 'S' then
        begin
          fNFe := Form7.ibDataSet15NFEXML.AsString;
          AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
          Rewrite(F);                  // Abre para gravao
          WriteLn(F,fNFe);
          CloseFile(F); // Fecha o arquivo
          ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
          Abort;
        end else
        begin
          bButton := Application.MessageBox('Validar Schema?', 'Ateno',
                     mb_YesNo + mb_DefButton1 +  + MB_ICONQUESTION);

          if bButton = IDYES  then
          begin
            {Sandro Silva 2022-09-29 inicio
            Clipboard.SetTextBuf(pchar(Form7.ibDataSet15NFEXML.AsString));
            ShellExecute( 0, 'Open',pChar('http://www.sefaz.rs.gov.br/NFE/NFE-VAL.aspx'),'','', SW_SHOWMAXIMIZED);
            }
            ValidarSchemaSefaz(Form7.ibDataSet15NFEXML.AsString);
          end else
          begin
            fNFe := Form7.ibDataSet15NFEXML.AsString;
            AssignFile(F,pChar(Form7.ibDataSet15NFEID.AsString+'.xml'));  // Direciona o arquivo F para EXPORTA.TXT
            Rewrite(F);                  // Abre para gravao
            WriteLn(F,fNFe);
            CloseFile(F); // Fecha o arquivo
            ShellExecute( 0, 'Open',pChar(Form7.ibDataSet15NFEID.AsString+'.xml'),'','', SW_SHOWMAXIMIZED);
          end;
        end;
      end else
      begin
        fNFe := Form7.ibDataSet24NFEXML.AsString;
        AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
        Rewrite(F);                  // Abre para gravao
        WriteLn(F,fNFe);
        CloseFile(F); // Fecha o arquivo
        ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
      end;

      Screen.Cursor            := crDefault;
      Abort;
    end;

  {
    //
    // Procura pelo cdigo de barras no no google
    //
    if DBGrid1.SelectedField.Name = 'ibDataSet4REFERENCIA' then
    begin
  //    ShellExecute( 0, 'Open',pchar('http://www.google.com/products?hl=en&q='+ibDAtaSet4REFERENCIA.AsString+'&ie=UTF-8&sa=N&tab=df'),'', '', SW_SHOWMAXIMIZED)
      ShellExecute( 0, 'Open',pchar('http://www.google.com/products?q='+ibDAtaSet4REFERENCIA.AsString+''),'', '', SW_SHOWMAXIMIZED)
    end;
  }
    //
    // Duplo CLICK no ativo REC
    //
    if DBGrid1.SelectedField.Name = 'ibDataSet7ATIVO' then
    begin
      if (Form7.ibDataSet7VALOR_RECE.Asfloat = 0) or (Form7.ibDataSet7ATIVO.AsFloat >= 5) then
      begin
        Form7.ibDataSet7.Edit;
        if Form7.ibDataSet7ATIVO.AsFloat >=5 then
        begin
          Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat -5;
          Form7.ibDataSet7VALOR_RECE.AsFloat := 0;
          Form7.ibDataSet7RECEBIMENT.AsString := '';
        end else
        begin
          Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
          Form7.ibDataSet7VALOR_RECE.AsFloat := Form7.ibDataSet7VALOR_DUPL.AsFloat;
        end;

        SMALL_DBEdit2Change(Sender);
        Form7.ibDataSet7.Post;

        CarregarContasReceberMarcadas;
        CalculaTotalRecebido(True);
      end;

      Screen.Cursor            := crDefault;
      Abort;
    end;

    // Duplo CLICK no ativo PAG
    if DBGrid1.SelectedField.Name = 'ibDataSet8ATIVO' then
    begin
      if (Form7.ibDataSet8VALOR_PAGO.Asfloat = 0) or (FORM7.ibDataSet8ATIVO.AsFloat >= 5) then
      begin
        Form7.ibDataSet8.Edit;
        if Form7.ibDataSet8ATIVO.AsFloat >=5 then
        begin
          Form7.ibDataSet8ATIVO.AsFloat := Form7.ibDataSet8ATIVO.AsFloat -5;
          Form7.ibDataSet8VALOR_PAGO.AsFloat := 0;
          Form7.ibDataSet8PAGAMENTO.AsString := '';
        end else
        begin
          Form7.ibDataSet8ATIVO.AsFloat := Form7.ibDataSet8ATIVO.AsFloat +5;
          Form7.ibDataSet8VALOR_PAGO.AsFloat := Form7.ibDataSet8VALOR_DUPL.AsFloat;
        end;

        SMALL_DBEdit2Change(Sender);
        Form7.ibDataSet8.Post;

        CarregarContasPagarMarcadas;
        CalculaTotalRecebido(True);
      end;
      Screen.Cursor            := crDefault;
      Abort;
    end;

    // Duplo CLICK no ICM configurao
    if DBGrid1.SelectedField.Name = 'ibDataSet14SOBREIPI' then
    begin
      Form7.ibDataSet14.Edit;
      if (Form7.ibDataSet14SOBREIPI.AsString = 'S') then
        Form7.ibDataSet14SOBREIPI.AsString := 'N'
      else
        Form7.ibDataSet14SOBREIPI.AsString := 'S';
      Form7.ibDataSet14.Post;
      Screen.Cursor            := crDefault;
      Abort;
    end;

    //Mauricio Parizotto 2023-03-28
    if DBGrid1.SelectedField.Name = 'ibDataSet14FRETESOBREIPI' then
    begin
      Form7.ibDataSet14.Edit;
      if (Form7.ibDataSet14FRETESOBREIPI.AsString = 'S') then
        Form7.ibDataSet14FRETESOBREIPI.AsString := 'N'
      else
        Form7.ibDataSet14FRETESOBREIPI.AsString := 'S';
      Form7.ibDataSet14.Post;
      Screen.Cursor            := crDefault;
      Abort;
    end;


    if DBGrid1.SelectedField.Name = 'ibDataSet14SOBREFRETE' then
    begin
      Form7.ibDataSet14.Edit;
      if (Form7.ibDataSet14SOBREFRETE.AsString = 'S') then
        Form7.ibDataSet14SOBREFRETE.AsString := 'N'
      else
        Form7.ibDataSet14SOBREFRETE.AsString := 'S';

      Screen.Cursor            := crDefault;
      Abort;
    end;

    if DBGrid1.SelectedField.Name = 'ibDataSet14SOBRESEGURO' then
    begin
      Form7.ibDataSet14.Edit;
      if (Form7.ibDataSet14SOBRESEGURO.AsString = 'S') then
        Form7.ibDataSet14SOBRESEGURO.AsString := 'N'
      else
        Form7.ibDataSet14SOBRESEGURO.AsString := 'S';

      Screen.Cursor            := crDefault;
      Abort;
    end;

    if DBGrid1.SelectedField.Name = 'ibDataSet14SOBREOUTRAS' then
    begin
      Form7.ibDataSet14.Edit;
      if (Form7.ibDataSet14SOBREOUTRAS.AsString = 'S') then
        Form7.ibDataSet14SOBREOUTRAS.AsString := 'N'
      else
        Form7.ibDataSet14SOBREOUTRAS.AsString := 'S';
      Form7.ibDataSet14.Post;
      Screen.Cursor            := crDefault;
      Abort;
    end;

    // --------------------------------------------------------------------------------- //
    // duplo clique no CGC                                                               //
    // --------------------------------------------------------------------------------- //
    if Pos('CGC',DBGrid1.SelectedField.Name) <> 0 then
    begin
      Clipboard.SetTextBuf(pChar(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)));
      if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
      begin
        {Dailon Parisotto 2023-10-11 Inicio

        bButton := Application.MessageBox(PChar('Em qual portal deseja fazer a consulta?' + slineBreak + slineBreak +
                                                'Sim - Federal' + slineBreak +
                                                'No - Estadual' + slineBreak +
                                                'Cancelar - Nenhuma das opes acima.'), PChar(_cTituloMsg),
                   MB_YESNOCANCEL + mb_DefButton1 + MB_ICONQUESTION);

        }
        bButton := MensagemPortalConsultaCNPJCPF;
        {Dailon Parisotto 2023-10-11 Fim}

        if bButton = IDYES  then
        begin
          {Dailon Parisotto 2023-10-11 Inicio

          if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
            ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/PessoaJuridica/CNPJ/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED)
          else
            ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/Aplicacoes/ATCTA/CPF/ConsultaPublica.asp?cnpf='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED);

          }
          if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
            ShellExecute( 0, 'Open',pChar('https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/cnpjreva_solicitacao.asp?cnpj='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED)
          else
            ShellExecute( 0, 'Open',pChar('https://servicos.receita.fazenda.gov.br/Servicos/CPF/ConsultaSituacao/ConsultaPublica.asp?cpf='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED);
          {Dailon Parisotto 2023-10-11 Fim}
        end else
        begin
          if bButton = IDNO  then
          begin
            sAsp := 'http://www.sintegra.gov.br/';
            ShellExecute( 0, 'Open',pChar(sASP),'', '', SW_SHOWMAXIMIZED);
          end;
        end;
        Screen.Cursor            := crDefault;
        Abort;
      end else
      begin
        Clipboard.SetTextBuf(pChar(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)));

        {Dailon Parisotto 2023-10-11 Inicio
        
        if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
          ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/PessoaJuridica/CNPJ/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED)
        else
          ShellExecute( 0, 'Open',pChar('http://www.receita.fazenda.gov.br/Aplicacoes/ATCTA/CPF/ConsultaPublica.asp?cpf='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED);

        }
        if Length(LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)) = 14 then
          ShellExecute( 0, 'Open',pChar('https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/cnpjreva_solicitacao.asp?cnpj='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED)
        else
          ShellExecute( 0, 'Open',pChar('https://servicos.receita.fazenda.gov.br/Servicos/CPF/ConsultaSituacao/ConsultaPublica.asp?cpf='+LimpaNumero(TabelaAberta.FieldByname('CGC').AsString)),'', '', SW_SHOWMAXIMIZED);
        {Dailon Parisotto 2023-10-11 Fim}

        Screen.Cursor            := crDefault;
        Abort;
      end;
    end;
    // --------------------------------------------------------------------------------- //
    // duplo clique no CGC  The End                                                      //
    // --------------------------------------------------------------------------------- //
    if Pos('COMPENS',DBGrid1.SelectedField.Name)<>0 then
    begin
      try
        if ibDataSet5COMPENS.AsString = '' then
        begin
          ibDataSet5.Edit;
          ibDataSet5COMPENS.AsDateTime := Date;
          if (Form7.ibDataset5.State in ([dsEdit, dsInsert])) then Form7.ibDataset5.Post;
          ibDataSet5.Edit;
        end;
      except end;
      Screen.Cursor            := crDefault;
      Abort;
    end;
    //*)
    if Pos('EMAIL',DBGrid1.SelectedField.Name) <> 0 then
    begin
      if (ValidaEmail(DBGrid1.SelectedField.AsString)) then
        ShellExecute( 0, 'Open',pChar('mailto:'+AllTrim(DBGrid1.SelectedField.AsString)),'New', '', SW_SHOWMAXIMIZED);
    end else
    begin
      // --------------------- //
      // Duplo click no dbgrid //
      // --------------------- //
      if sModulo = 'BANCOS' then
      begin
        iFoco := 7;
        Form10.Show;
      end;
      if sModulo = '2CONTAS' then
      begin
        Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
        Mais1Ini.WriteString('BANCOS','BANCO',ibDataSet11NOME.AsString);
        Mais1Ini.Free;
        close;
        Form1.imgBancosClick(Sender);
      end;  

      if sModulo = 'OS' then
      begin
        Form7.Image106Click(Sender);
      end else
      begin
        if sModulo = 'VENDA' then
        begin
          if (Form7.ibDataSet15EMITIDA.AsString <> 'X') and (AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '') then
            Form7.Image106Click(Sender);
        end else
        begin
          if sModulo = 'COMPRA' then
          begin
            Form7.Image106Click(Sender);
          end else
          begin
            if  (sModulo <> 'BANCOS')
            and (sModulo <> '2CONTAS')
            and (sModulo <> 'NOTA')
            and (sModulo <> 'CONFOS')
            and (sModulo <> 'CONFRECIBO') then
            begin
              if sModulo = 'ORCAMENTO' then
              begin
                ShellExecute( 0, 'Open', pChar(Form1.sAtual+'\orca.exe'), pChar(Form7.ibDataSet97.FieldByname('Oramento').AsString), '', SW_SHOW);
                sleep(1000);
                while ConsultaProcesso('orca.exe') or ConsultaProcesso('ORCA.EXE') do
                begin
                  Form7.Caption := 'Aguarde o fechamento do programa de orcamentos...';
                  Application.ProcessMessages;
                  sleep(100);
                end;
                //
                Form7.Caption := '';
                AgendaCommit(True);
                Form7.Close;
                Form7.Show;
                //
                Form7.ibDataSet97.EnableControls;
                //
                Screen.Cursor            := crDefault;
                Abort;
                //
              end else
              begin
                Form7.Image106Click(Sender);
              end;
            end;
          end;
        end;
      end;
    end;
  finally
    Screen.Cursor            := crDefault;
  end;
end;

{Dailon Parisotto 2023-10-11 Inicio}
function TForm7.MensagemPortalConsultaCNPJCPF: Integer;
var
  ofrmMsg: TForm;
  oBotaoSim, oBotaoNao, oBotaoCancela: TButton;
begin
  ofrmMsg := CreateMessageDialog('Em qual portal deseja fazer a consulta?', mtConfirmation, mbYesNoCancel);
  try
    ofrmMsg.Caption := _cTituloMsg;
    ofrmMsg.Position := Self.Position;

    oBotaoSim := TButton(ofrmMsg.FindChildControl('Yes'));
    oBotaoSim.Caption := 'Federal';
    oBotaoSim.Width := Canvas.TextWidth(oBotaoSim.Caption) + 32;

    oBotaoNao := TButton(ofrmMsg.FindChildControl('No'));
    oBotaoNao.Caption := 'Estadual';
    oBotaoNao.Left := oBotaoSim.Left + oBotaoSim.Width + 16;
    oBotaoNao.Width := Canvas.TextWidth(oBotaoNao.Caption) + 32;

    oBotaoCancela := TButton(ofrmMsg.FindChildControl('Cancel'));
    oBotaoCancela.Caption := 'Cancelar';
    oBotaoCancela.Left := oBotaoNao.Left + oBotaoNao.Width + 16;
    oBotaoCancela.Width := Canvas.TextWidth(oBotaoCancela.Caption) + 32;

    if ofrmMsg.Width < (oBotaoCancela.Left + oBotaoCancela.Width + oBotaoSim.Left) then
      ofrmMsg.Width := oBotaoCancela.Left + oBotaoCancela.Width + oBotaoSim.Left;

    Result := ofrmMsg.ShowModal;
  finally
    FreeAndNil(ofrmMsg);
  end;
end;
{Dailon Parisotto 2023-10-11 Fim}

procedure TForm7.DBGrid1KeyPress(Sender: TObject; var Key: Char);
var
  I : Integer;
begin
 if (DBGrid1.SelectedField.Name = 'ibDataSet14SOBREIPI') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14SOBREFRETE') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14SOBRESEGURO') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14SOBREOUTRAS') or
    (DBGrid1.SelectedField.Name = 'ibDataSet14FRETESOBREIPI')  then
 begin
   if Key <> chr(13) then
     Key := Chr(0);
 end;

 if Key = Chr(18) then
 begin
   Form20.Panel1.Visible := True;
   Form20.ShowModal;
 end;
 //
 if Key = Chr(6) then
  Form7.Image103Click(Sender);
 //
 if (dBGrid1.SelectedField.Name = 'ibDataSet1NOME') or
    (dBGrid1.SelectedField.Name = 'ibDataSet4NOME') or
    (dBGrid1.SelectedField.Name = 'ibDataSet7NOME') or
    (dBGrid1.SelectedField.Name = 'ibDataSet8NOME') then
 begin
   if Key <> chr(13) then
     Key := Chr(0);
 end;
 //
 if Form7.bFlag = True then
 begin

   I := DbGrid1.SelectedIndex;

   if Key = chr(13) then
   begin
     if (sModulo = 'CONCILIACAO') and (dBGrid1.SelectedField.Name = 'ibDataSet5COMPENS') then
       ArquivoAberto.Next
     else
       DbGrid1.SelectedIndex := DbGrid1.SelectedIndex  + 1;
   end;

   if dbGrid1.SelectedField.DataType = ftFloat then
   begin
     if Key = chr(46) then
       key := chr(44);
   end;

   if Key = chr(13) then
   begin
     if (I = DbGrid1.SelectedIndex) and (sModulo <> 'CONCILIACAO') then
     begin
       DbGrid1.SelectedIndex := 0;
       ArquivoAberto.Next;
     end;
   end;
   //
   if Copy(UpperCase(dBGrid1.SelectedField.DisplayLabel),1,3) = 'SAL' then
   begin
     DbGrid1.SelectedIndex := 0;
     ArquivoAberto.Next;
   end;
 end
 else
   Form7.bFlag := True;

 dBgrid1.Refresh;

end;


procedure TForm7.Cartaparamaladireta1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\carta.doc'),'','', SW_SHOWMAXIMIZED);
end;

procedure TForm7.Imprimircarta1Click(Sender: TObject);
begin
  try
    Form33 := TForm33.Create(nil);
    Form33.ShowModal;
  finally
    FreeAndNil(Form33);
  end;
end;

procedure TForm7.Oramento1Click(Sender: TObject);
begin
  Form7.Close;
  Form7.sModulo := 'ORCAMENTO';
  Form7.sTitulo := 'Oramentos';
  Form7.sRPS := 'N';
  Form7.Show;
end;

procedure TForm7.Grupos1Click(Sender: TObject);
begin
  Form7.sModulo := 'GRUPOS';
  Form7.sTitulo := 'Grupos de mercadorias no estoque';
  Form7.sRPS := 'N';
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Inventrio1Click(Sender: TObject);
begin
  Form32.ShowModal;
end;

procedure TForm7.Relatriodeconpras1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.RadioButton1.Visible := True;
  Form38.rbItemPorITem.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de compras';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Relatriodevendas1Click(Sender: TObject);
begin
  frmRelVendasNotaFiscal := TfrmRelVendasNotaFiscal.Create(nil);
  try
    frmRelVendasNotaFiscal.Imagem             := imgImprimir.Picture;
    frmRelVendasNotaFiscal.Usuario            := Usuario;
    frmRelVendasNotaFiscal.Transaction        := IBTransaction1;
    frmRelVendasNotaFiscal.DecimaisValor      := StrToIntDef(Form1.ConfPreco,0);
    frmRelVendasNotaFiscal.DecimaisQuantidade := StrToIntDef(Form1.ConfCasas,0);
    frmRelVendasNotaFiscal.ShowModal;
  finally
    FreeAndNil(frmRelVendasNotaFiscal);
  end;
end;

procedure TForm7.Previsodecompra1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Panel3.Visible  := True;
  Form7.sModulo := 'Previso de compras';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Movimentaodoitem1Click(Sender: TObject);
begin
  Form10.Image203Click(Sender);
end;

procedure TForm7.Imprimirpedidosdevenda1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de vendas (Cupom Fiscal)';
  Form38.Label17.Visible := True;
  Form38.Edit1.Visible   := True;
  Form38.cbListarCodigos.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Label17.Visible := False;
  Form38.Edit1.Visible   := False;
end;

procedure TForm7.Listadepreos1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
begin
  if Form7.sModulo = 'ESTOQUE' then
  begin
    Form7.Caption := 'Lista de preos';
    { L as configuraes no .INF }
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    { -- Mais1Ini.WriteString(Mais.sEscolhido,'L'+alltrim(IntToStr(I)), -- }
    Form39.CheckBox4.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo1','7'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00') +'%';
    Form39.CheckBox5.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo2','14'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00') +'%';
    Form39.CheckBox6.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo3','21'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00') +'%';
    //
    Form39.Label1.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00');
    Form39.Label2.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00');
    Form39.Label3.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00');
    
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    Form39.CheckBox7.Visible := False;
    Form39.CheckBox8.Visible := False;

    Form39.Height := 80;
  end;

  Form9.Show;
  Form14.Caption := 'Assistente para lista de preos';
  Form14.Show;
  Form39.Show;
end;

procedure TForm7.Etiquetas1Click(Sender: TObject);
begin
  try
    Form15 := TForm15.Create(nil);
    Form15.ShowModal;
  finally
    FreeAndNil(Form15);
  end;
end;

procedure TForm7.Contasbancrias1Click(Sender: TObject);
var
  I : Integer;
begin
  try
    for I := Menuitem34.Count -1 downto 13 do
    begin
      Menuitem34.Items[I].Destroy;
    end;
  except
  end;

  Form7.sModulo := '2CONTAS';
  Form7.sTitulo := 'Contas bancrias';
  Form7.sRPS := 'N';
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.miSobreSistemaClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miExcluirOSClick(Sender: TObject);
begin
  ExcluirOS;
end;

procedure TForm7.miExibirAjudaCaixaClick(Sender: TObject);
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
end;

procedure TForm7.Sobreoprograma3Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaEstoqueClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaBancoClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaReceberClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaPagarClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaVendedorClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.Sobreoprograma9Click(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaPlanoContasClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.miSobreSistemaCliforClick(Sender: TObject);
begin
  Form1.Sobreoprograma1Click(Sender);
end;

procedure TForm7.ibDataSet15MERCADORIAChange(Sender: TField);
var
  I, bButton : Integer;
  fDesconto, fTotal9, fAliquota, fRetencao, fST : Real;
  sReg14: String;
  sReg16: String;
  fRateioDoDesconto: Real; // Sandro Silva 2023-12-12
  dvCredICMSSN: Double; // Sandro Silva 2023-12-12
begin
  // No faz nada quando entra a 1 vez
  if Form7.sModulo <> 'CANCELA' then // Sandro Silva 2022-11-07 if Form7.sModulo <> 'CALCELA' then
  begin
    //if (Alltrim(Form7.ibDataSet15OPERACAO.AsString) <> '') and (Form7.ibDataSet15FINNFE.AsString <> '2-Complementar') then
    if (Alltrim(Form7.ibDataSet15OPERACAO.AsString) <> '') then //Mauricio Parizotto 2023-06-05 se necessrio ajustar o cdigo para  (Form7.ibDataSet15FINNFE.AsString <> '2')
    begin
      Form7.ibDataSet16.DisableControls;

      try
        Form7.ibDataSet14.DisableControls;
        sReg14 := Form7.ibDataSet14REGISTRO.AsString;
        sReg16 := Form7.ibDataSet16REGISTRO.AsString;

        try
          Form7.ibDataSet14.First;
          while (Form7.ibDataSet14ISS.AsFloat = 0) and ( not Form7.ibDataSet14.EOF) do
          begin
            Form7.ibDataSet14.Next;
          end;

          if Form7.ibDataSet14ISS.AsFloat <> 0  then
          begin
            Form7.ibDataSet15.Edit;
          end;
        except
        end;

        try
          Form7.ibDataSet14.Locate('REGISTRO',sReg14,[]);
          Form7.ibDataSet14.EnableControls;
        except
        end;

        // SIMPLES NACIONAL
        if Copy(Form7.ibDataSet14OBS.AsString,1,26) = 'PERMITE O REAPROVEITAMENTO' then
        begin
          try
            Form7.ibDataSet14.Edit;
            Form7.ibDataSet14OBS.AsString := StrTran(Form7.ibDataSet14OBS.AsString,'REAPROVEITAMENTO','APROVEITAMENTO');
            Form7.ibDataSet14.Post;
          except
          end;
        end;

        if Copy(Form7.ibDataSet14OBS.AsString,1,24) = 'PERMITE O APROVEITAMENTO' then
        begin
          // ObservacaoOperacao(False); // simplas nacional PERMITE O APROVEITAMENTO
          try
            // PERMITE O APROVEITAMENTO DO CRDITO DE ICMS NO VALOR DE R$; CORRESPONDENTE  ALQUOTA DE 2,82%, NOS TERMOS DO ART. 23 DA LC 123
            try
              fAliquota := StrToFloat(Alltrim(StrTran(Copy(Form7.ibDataSet14OBS.AsString,90,4),'.',',')));
            except
              fAliquota := 2.82;
            end;

            {Sandro Silva 2023-12-12 inicio
            Form7.IBQuery99.Close;
            Form7.IBQuery99.SQL.Clear;
            Form7.IBQuery99.SQL.Add('select sum(Itens001.TOTAL) from ITENS001 ,ESTOQUE where ESTOQUE.DESCRICAO=ITENS001.DESCRICAO and (ESTOQUE.CSOSN=''101'' or ESTOQUE.CSOSN=''201'' or ESTOQUE.CSOSN=''900'') and ITENS001.NUMERONF='+QuotedStr(Form7.ibDataSet15NUMERONF.AsString)+' ');
            Form7.IBQuery99.Open;

            fST := Form7.IBQuery99.FieldByname('SUM').AsFloat;

            if FST > 0 then
            begin
              if Pos(Form7.sAproveitamento,Form7.ibDataSet15COMPLEMENTO.AsString) <> 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset15.Edit;
                Form7.ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,Form7.sAproveitamento,'');                      // Retira o anterios
              end;

              Form7.sAproveitamento := StrTran(Form7.ibDataSet14OBS.AsString,'R$;','R$ '+Alltrim(Format('%12.2n',[ fST * fAliquota / 100])) +'; ');  // Gera o novo e grava em sAproveitamento

              if Pos(Form7.sAproveitamento,Form7.ibDataSet15COMPLEMENTO.AsString) = 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset15.Edit;
                Form7.ibDataSet15COMPLEMENTO.AsString := Form7.sAproveitamento + Form7.ibDataSet15COMPLEMENTO.AsString;                                // Coloca o novo
              end;
            end;
            }

            Form7.IBQuery99.Close;
            Form7.IBQuery99.SQL.Clear;
            Form7.IBQuery99.SQL.Text :=
              'select ITENS001.CODIGO, ITENS001.TOTAL ' +
              ' from ITENS001 ' +
              'where (coalesce(ITENS001.CSOSN, '''') in (''101'', ''201'',''900'')) ' +
              ' and ITENS001.NUMERONF='+QuotedStr(Form7.ibDataSet15NUMERONF.AsString);
            Form7.IBQuery99.Open;

            fST := 0.00;
            Form7.IBQuery99.First;
            while Form7.IBQuery99.Eof = False do
            begin
              if (Form7.ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.IBQuery99.FieldByname('TOTAL').AsFloat) <> 0 then
              begin
                fRateioDoDesconto  := Arredonda((Form7.ibDataSet15.FieldByname('DESCONTO').AsFloat / Form7.ibDataSet15.FieldByname('MERCADORIA').AsFloat * Form7.IBQuery99.FieldByname('TOTAL').AsFloat),2);

                dvCredICMSSN := StrToFloat(FormatFloat('0.00', (Form7.IBQuery99.FieldByname('TOTAL').AsFloat - fRateioDoDesconto) * fAliquota / 100));

                fST := fST + dvCredICMSSN;

              end;

              Form7.IBQuery99.Next;
            end;

            if FST > 0 then
            begin
              {Mauricio Parizotto 2024-01-31 Inicio
              if Pos(Form7.sAproveitamento,Form7.ibDataSet15COMPLEMENTO.AsString) <> 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset15.Edit;
                ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,sAproveitamento,'');                      // Retira o anterios
              end;

              sAproveitamento := StrTran(Form7.ibDataSet14OBS.AsString,'R$;','R$ '+Alltrim(Format('%12.2n',[fST])) +'; ');  // Gera o novo e grava em sAproveitamento

              if Pos(sAproveitamento,ibDataSet15COMPLEMENTO.AsString) = 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset15.Edit;

                ibDataSet15COMPLEMENTO.AsString := sAproveitamento + ibDataSet15COMPLEMENTO.AsString;                                // Coloca o novo
              end;
              }

              //Alterado para copiar texto padro at a palavra CORRESPONDENTE somente, para alterar somente o valor, cliente configura mais informaes na observao
              if Pos(Copy(Form7.sAproveitamento,1, Pos('CORRESPONDENTE',Form7.sAproveitamento) ),    Copy(Form7.ibDataSet15COMPLEMENTO.AsString,1, Pos('CORRESPONDENTE',Form7.ibDataSet15COMPLEMENTO.AsString)  )) <> 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset15.Edit;

                ibDataSet15COMPLEMENTO.AsString := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,Copy(sAproveitamento,1, Pos('CORRESPONDENTE',Form7.sAproveitamento) -1 ),'');                      // Retira o anterios
              end;

              sAproveitamento := StrTran(Form7.ibDataSet14OBS.AsString,'R$;','R$ '+Alltrim(Format('%12.2n',[fST])) +'; ');  // Gera o novo e grava em sAproveitamento

              if Pos(sAproveitamento,ibDataSet15COMPLEMENTO.AsString) = 0 then
              begin
                if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
                  Form7.ibDataset15.Edit;

                //Se ja tinha mensagem, apenas preenche com o resto
                if Pos('CORRESPONDENTE ',ibDataSet15COMPLEMENTO.AsString) > 0 then
                  ibDataSet15COMPLEMENTO.AsString := Copy(sAproveitamento, 1, Pos('CORRESPONDENTE',Form7.sAproveitamento) -1  ) + ibDataSet15COMPLEMENTO.AsString
                else
                  ibDataSet15COMPLEMENTO.AsString := sAproveitamento + ibDataSet15COMPLEMENTO.AsString
              end;

              {Mauricio Parizotto 2024-01-31 Fim}
            end;
            {Sandro Silva 2023-12-12 fim}
          except
          end;
        end else
        begin
          // Joga p/obs a obs na tabela de icm //
          // 'Reteno de 4,65% correspondente a soma das aliquotas da CSLL da COFINS e PIS/PASEP. R$'
          if Copy(Form7.ibDataSet14OBS.AsString,1,8) = 'Reteno' then
          begin
            Form7.ibDataSet15COMPLEMENTO.AsString  := '';
            ObservacaoOperacao(True); // Retencao
            try
              fRetencao := Form7.ibDataSet15SERVICOS.Value * StrToFloat(LimpaNumeroDeixandoAvirgula(Copy(Form7.ibDataSet14OBS.AsString,13,5))) / 100; // Reteno
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15COMPLEMENTO.AsString  := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,'R$','X$');
              Form7.ibDataSet15COMPLEMENTO.AsString  := StrTran(Form7.ibDataSet15COMPLEMENTO.AsString,'X$','R$ '+AllTrim(Format('%12.2n',[fRetencao])));
            except
            end;
          end;
        end;
      except
      end;
      //
      Form7.ibDataSet14.EnableControls;

      if Form7.sModulo = 'DESCONTO1' then
      begin
        if ibDataSet15MERCADORIA.AsFloat <> 0 then
        begin
          if (Form7.ibDataSet15MERCADORIA.AsFloat < 0) or (Pos('+',Form12.SMALL_DBEdit17.Text) <> 0) then
          begin
            if (Pos('+',Form12.SMALL_DBEdit17.Text) <> 0) then
            begin
              // + 10 Acrescimo
              Form12.FVELHO := Form12.fVELHO + (form12.fVELHO * StrToFloat(StrTran(Form12.SMALL_DBEdit17.Text,'+','')) / 100);
            end else
            begin
              // - 10 Desconto
              Form12.FVELHO := Form12.fVELHO +
              (form12.fVELHO * Form7.ibDataSet15MERCADORIA.AsFloat / 100);
            end;
          end else
          begin
            ibDataSet16.First;
            fTotal9 := 0;

            while not Form7.ibDataSet16.Eof do // Disable
            begin
              if Form7.ibDataSet16BASEISS.AsFloat <> 100 then
              begin
                if (Pos(Alltrim(Form7.ibDataSet16.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5104 Industrializao efetuada para outra empresa no soma na base
                begin
                  fTotal9 := fTotal9 + Arredonda(Form7.ibDataSet16.FieldByname('TOTAL').AsFloat,2);
                end;
              end;

              ibDataSet16.Next;
            end;

            // desconto
            bButton := IDNO;
            if fTotal9 <> 0 then
            begin
              if (((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100) > 0.0001 then
              begin
                bButton := Application.MessageBox(Pchar('Confirma um desconto de:                    ' + chr(10) +
                Chr(10) +
                '           % ' + AllTrim(Format('%12.2n',[((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100])) +
                Chr(10) +
                Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
              end;

              // Acrescimo
              if (((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100) < -0.001 then
              begin
                bButton := Application.MessageBox(Pchar('Confirma um acrscimo de:                    ' + chr(10) +
                Chr(10) +
                '           % ' + AllTrim(Format('%12.2n',[-1*((ibDataSet15MERCADORIA.AsFloat/fTotal9)-1)*-100])) +
                Chr(10) +
                Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
              end;
            end;

            sModulo := 'MEMO1';

            if bButton = IDYES then
            begin
              try
                for I := 1 to 10 do
                begin
                  fDesconto := ibDataSet15MERCADORIA.AsFloat/fTotal9;
                  if fTotal9 <> ibDataSet15MERCADORIA.AsFloat then
                  begin
                    ibDataSet16.First;
                    fTotal9 := 0;
                    while not Form7.ibDataSet16.Eof do // disable
                    begin
                      if ibDataSet16QUANTIDADE.AsFloat * ibDataSet16UNITARIO.Asfloat <> 0 then
                      begin
                        Form7.ibDataSet4.Close;                                                //
                        Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
                        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');  //
                        Form7.ibDataSet4.Open;
                        
                        ibDataSet16.Edit;
                        if (((ibDataSet16TOTAL.Asfloat * fDesconto) / ibDataSet16QUANTIDADE.AsFloat) < ibDataSet4CUSTOCOMPR.AsFloat) and (Form1.ConfCusto = 'No') then
                        begin
                          //ShowMessage('No  possvel dar descontos com o preo abaixo do custo'); Mauricio Parizotto 2023-10-25
                          MensagemSistema('No  possvel dar descontos com o preo abaixo do custo',msgAtencao);
                          // Sandro Silva 2023-04-26 ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
                          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(CorrigeCustoCompraNaVenda(Form7.ibDataSet4CUSTOCOMPR.AsFloat), StrToInt(Form1.ConfPreco));
                        end else
                        begin
                          ibDataSet16TOTAL.AsFloat := Arredonda(ibDataSet16TOTAL.Asfloat * fDesconto,StrToInt(Form1.ConfPreco));
                        end;

                        ibDataSet16.Post;

                        if Form7.ibDataSet16BASEISS.AsFloat <> 100 then
                        begin
                          if (Pos(Alltrim(Form7.ibDataSet16.FieldByname('CFOP').AsString),Form1.CFOP5124) = 0) then// 5104 Industrializao efetuada para outra empresa no soma na base
                          begin
                            fTotal9 := fTotal9 + Arredonda(Form7.ibDataSet16.FieldByname('TOTAL').AsFloat,2);
                          end;
                        end;
                      end;
                      ibDataSet16.Next;
                    end;
                  end;
                end;
              except
              end;
            end else
            begin
              ibDataSet15.Edit;
              ibDataSet15MERCADORIA.AsFloat := fTotal9;
              ibDataSet15.Post;
              ibDataSet15.Edit;
            end;
          end;
        end;

        Form7.ibDataSet16.Locate('REGISTRO',sReg16,[]);
      end;

      // Reteno de 4,65% correspondente a soma das aliquotas da CSLL da COFINS e PIS/PASEP. R$
      fRetencao := 0;

      if Copy(Form7.ibDataSet14OBS.AsString,1,8) = 'Reteno' then
      begin
        try
          fRetencao := Form7.ibDataSet15SERVICOS.Value * StrToFloat(LimpaNumeroDeixandoAvirgula(Copy(Form7.ibDataSet14OBS.AsString,13,5))) / 100; // Reteno
        except
        end;
      end;
      // ------------------------ //
      // Dedus o ISS retido       //
      // ------------------------ //
      Form1.fRetencoes := 0;
      //
      Form48.SMALL_DBEdit16.Hint := '';

      if Form7.sRPS = 'S' then
      begin
        if Pos('(I)',Form7.ibDataset15MARCA.AsString) <> 0 then
        begin
          // ISS
          Form1.fRetencoes := Form7.ibDataSet15ISS.AsFloat;
          Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[( Form7.ibDataSet15ISS.AsFloat )]))  +' de ISS'+chr(10);
        end;
        //
        // Pis
        // Cofins
        // Inss
        // Ir
        // Csll
        //
        if Pos('(F)',Form7.ibDataset15MARCA.AsString) <> 0 then
        begin
          try
            // Pis
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString))    <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes + Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaPIS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))    / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de PIS'+chr(10);
            end;
          except
          end;

          try
            // Cofins
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCOFINS',form7.ibDataSet4.FieldByname('TAGS_').AsString))) / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de COFINS'+chr(10);
            end;
          except
          end;

          try
            // Inss
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaINSS',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de INSS'+chr(10);
            end;
          except
          end;

          try
            // Ir
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString))     <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaIR',form7.ibDataSet4.FieldByname('TAGS_').AsString)))     / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de IR'+chr(10);
            end;
          except
          end;

          try
            // Csll
            if AllTrim(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString))   <> '' then
            begin
              Form1.fRetencoes := Form1.fRetencoes +Arredonda(( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ),2);
              Form48.SMALL_DBEdit16.Hint := Form48.SMALL_DBEdit16.Hint + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[ ( StrToFloat(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('AliquotaCSLL',form7.ibDataSet4.FieldByname('TAGS_').AsString)))   / 100 * ( ibDataSet15.FieldByname('SERVICOS').AsFloat-ibDataSet15.FieldByname('DESCONTO').AsFloat ) ) ]))  +' de CSLL'+chr(10);
            end;
          except
          end;
        end;
      end;
      // ------------------------ //
      // Dedus o imposto de renda //
      // ------------------------ //
      // Servicos >= ConfLimite then IR = Servicos * (( ConfIR / 100) * 1) else IR = 0;

      if Form7.ibDataSet15SERVICOS.AsFloat >= Form1.ConfLimite then
      begin
        // ObservacaoOperacao(True); // Retencao
        Form1.fRetencaoIR := (Form7.ibDataSet15SERVICOS.AsFloat * (( Form1.ConfIR / 100) * 1));
        Form7.ibDataSet15COMPLEMENTO.AsString := Form7.ibDataSet15COMPLEMENTO.AsString + ' ' + 'Reteno de R$ '+ AllTrim(Format('%14.2n',[  (Form7.ibDataSet15SERVICOS.AsFloat * (( Form1.ConfIR / 100) * 1))  ]))  +' de IRRF';
      end else
      begin
        Form1.fRetencaoIR := 0;
      end;

      if Format('%12.2n',[Form7.ibDataSet15TOTAL.AsFloat]) <> Format('%12.2n',[( Form7.ibDataSet15MERCADORIA.Value  +
                                                                                 Form7.ibDataSet15SERVICOS.Value    +
                                                                                 Form7.ibDataSet15FRETE.Value       +
                                                                                 Form7.ibDataSet15SEGURO.Value      +
                                                                                 Form7.ibDataSet15IPI.Value         +
                                                                                 Form7.ibDataSet15ICMSSUBSTI.Value  +
                                                                                 //fFCPRetido      +
                                                                                 Form7.ibDataSet15VFCPST.Value      +
                                                                                 Form7.ibDataSet15DESPESAS.Value    -
                                                                                 Form7.ibDataSet15DESCONTO.Value    -
                                                                                 Form1.fRetencoes -
                                                                                 fRetencao)
                                                                              ]) then
      begin

        Form7.ibDataSet15TOTAL.AsFloat :=  Arredonda(Form7.ibDataSet15MERCADORIA.Value + // Mercadoria +
                                                     Form7.ibDataSet15SERVICOS.Value   + // Servios +
                                                     Form7.ibDataSet15FRETE.Value      + // Frete +
                                                     Form7.ibDataSet15SEGURO.Value     + // Seguro +
                                                     Form7.ibDataSet15IPI.Value        + // Ipi +
                                                     Form7.ibDataSet15ICMSSUBSTI.Value + // Valor do ICMS substituio
                                                     //fFCPRetido     + // Fundo de combate a pobresa retido por st
                                                     Form7.ibDataSet15VFCPST.Value     + // Fundo de combate a pobresa retido por st
                                                     Form7.ibDataSet15DESPESAS.Value   - // Despesas
                                                     Form7.ibDataSet15DESCONTO.Value   - // Desconto
                                                     Form1.fRetencoes -                // ISS retido
                                                     fRetencao
                                                     ,2);                       

      end;

      {Mauricio Parizotto 2023-06-06 trocado pela procedure
      Form12.edtTotalNota.ShowHint := True;
      Form12.edtTotalNota.Hint     :=
        '+ Mercadoria: '+FloatToStr(Form7.ibDataSet15MERCADORIA.Value)+CHR(10)+
        '+ Servios: '+FloatToStr(Form7.ibDataSet15SERVICOS.Value)+CHR(10)+
        '+ Frete: '+FloatToStr(Form7.ibDataSet15FRETE.Value)+CHR(10)+
        '+ Seguro: '+FloatToStr(Form7.ibDataSet15SEGURO.Value)+CHR(10)+
        '+ IPI: '+FloatToStr(Form7.ibDataSet15IPI.Value)+CHR(10)+
        '+ ICMS Substituio: '+FloatToStr(Form7.ibDataSet15ICMSSUBSTI.Value)+CHR(10)+
        //'+ FCP ST: '+FloatToStr(fFCPRetido)+CHR(10)+
        '+ FCP ST: '+FloatToStr(Form7.ibDataSet15VFCPST.Value)+CHR(10)+
        '+ Despesas: '+FloatToStr(Form7.ibDataSet15DESPESAS.Value)+CHR(10)+
        '- Desconto: '+FloatToStr(Form7.ibDataSet15DESCONTO.Value)+CHR(10)+
        '- Retenes: '+FloatToStr(Form1.fRetencoes)+CHR(10)+
        '- Reteno de IR: '+FloatToStr(fRetencao)+CHR(10);
      }
      HintTotalNotaVenda(fRetencao);

      if Form7.sModulo <> 'RETRIBUTA' then
        Form7.ibDataSet16.EnableControls;
      //
      // Soma o CFOP 5124 ou 6124 no TOTAL da nota mas no soma na MERCADORIA
      // 5104 Industrializao efetuada para outra empresa
      //
      if AllTrim(Form1.CFOP5124) <> '' then // Ok
      begin
        try
          Form7.IBDataSet100.Close;
          Form7.ibDataSet100.SelectSQL.Clear;
          Form7.ibDataSet100.SelectSQL.Add('select sum(TOTAL) from ITENS001 where NUMERONF='+QuotedStr(IbDAtaSet15NUMERONF.AsString)+' and '+Form1.CFOP5124);
          Form7.ibDataSet100.Open;
          // Soma o CFOP 5104 ou 6124 no TOTAL da nota mas no soma na MERCADORIA
        except
        end;
      end;
    end;
  end;

  try
    // Abate o Desconto no ISS
    Totalizaservicos(True);
  except
  end;
end;

procedure TForm7.FormCreate(Sender: TObject);
begin
  IBDatabase1.Connected := False; // Garantia, caso esquecer a propriedade Connected := True no objeto Sandro Silva 2023-12-26
  {Sandro Silva 2023-07-05 inicio}
  slPickListBandeira         := TStringList.Create;
  slPickListFormaDePagamento := TStringList.Create;
  slPickListBanco            := TStringList.Create;
  slPickListInstituicao      := TStringList.Create;
  {Sandro Silva 2023-07-05 fim}

  FbImportandoXML := False;
  Form7.sAproveitamento := '';
  Form7.bMudei := False;
  dbGrid1.ReadOnly := True;
  Form7.Label208.Caption  := 'Liberar';

  // NF-e
  bProximas := False;
  bContingencia := False;
  bFirst := False;

  sAjuda := 'INDEX.HTM';

  //Mauricio Parizotto 2023-05-29
  //Campos Somente Leitura ao editar pelo Grid
  ibDataSet7INSTITUICAOFINANCEIRA.Tag := CAMPO_SOMENTE_LEITURA_NO_GRID;
  ibDataSet7NOME.Tag := CAMPO_SOMENTE_LEITURA_NO_GRID;
  ibDataSet11INSTITUICAOFINANCEIRA.Tag := CAMPO_SOMENTE_LEITURA_NO_GRID;
  ibDataSet7FORMADEPAGAMENTO.Tag := CAMPO_SOMENTE_LEITURA_NO_GRID;
  ibdParametroTributaDESCRICAO.Tag := CAMPO_SOMENTE_LEITURA_NO_GRID; // Mauricio Parizotto 2023-09-21
  //Mauricio Parizotto 2023-06-01
  imgNovo.Transparent := False;
  imgExcluir.Transparent := False;
  imgProcurar.Transparent := False;
  imgImprimir.Transparent := False;
  imgVisualizar.Transparent := False;
  imgLibBloq.Transparent := False;
  imgEditar.Transparent := False;
  Image308.Transparent := False;
  imgFiltrar.Transparent := False;

  {$IFDEF VER150}
  {$ELSE}
  DBGrid1.DrawingStyle       := gdsGradient;
  DBGrid1.GradientEndColor   := $00F0F0F0;
  DBGrid1.GradientStartColor := $00F0F0F0;
  {$ENDIF}

  //Mauricio Parizotto 2023-12-05
  //Marca campo chave da tabela
  ibdSituacaoOSIDSITUACAO.ProviderFlags := [pfInUpdate,pfInWhere,pfInKey];
end;

procedure TForm7.ibDataSet14INTEGRACAOChange(Sender: TField);
begin
  if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,5) <> 'CAIXA' then
     if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,7) <> 'RECEBER' then
        if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,5) <> 'PAGAR' then
           if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,7) <> 'ESTOQUE' then
              if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,1) <> '=' then
                 if Copy(AnsiUpperCase(ibDataSet14INTEGRACAO.Value),1,1) <> '0' then
                    if ibDataSet14INTEGRACAO.Value <> '' then
                       ibDataSet14INTEGRACAO.Value := '';

end;

procedure TForm7.DBGrid1TitleClick(Column: TColumn);
var
  Mais1ini : tIniFile;
  CampoPK   : string;
begin
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');

  if (form7.sModulo = 'RECEBER') and (Column.FieldName='NOME') then
    Mais1Ini.WriteString(sModulo,'ORDEM',Column.FieldName+', EMISSAO')
  else
    Mais1Ini.WriteString(sModulo,'ORDEM',Column.FieldName);

  {Mauricio Parizotto 2023-12-05 Inicio}
  try
    CampoPK := GetCampoPKDataSet(Form7.TabelaAberta);
  except
    CampoPK := 'REGISTRO';
  end;

  //Mais1Ini.WriteString(sModulo,'REGISTRO',TabelaAberta.FieldByName('REGISTRO').AsString);
  Mais1Ini.WriteString(sModulo,'REGISTRO',TabelaAberta.FieldByName(CampoPK).AsString);
  {Mauricio Parizotto 2023-12-05 Fim}
  Mais1Ini.Free;
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.ibDataSet7VALOR_RECEValidate(Sender: TField);
var
  fTotal : Real;
  bButton: Integer;
  sp : String;
  sR : String;
begin
  if Form7.sModulo <> 'VENDA' then
  begin
    if ibDataSet1.Locate('HISTORICO',Alltrim(copy('Receb. doc. '+ibDataSet7DOCUMENTO.AsString+'-'+ibDataSet7NOME.AsString+Replicate(' ',45),1,45)),[loPartialKey]) then
    begin
      if AllTrim(ibDataSet1HISTORICO.AsString) = Alltrim(copy('Receb. doc. '+ibDataSet7DOCUMENTO.AsString+'-'+ibDataSet7NOME.AsString+Replicate(' ',45),1,45)) then
      begin
        ibDataSet1.Delete;
      end;
    end;

    if ibDataSet7VALOR_RECE.Value > 0 then
    begin
      if ibDataSet7VALOR_RECE.Value < ibDataSet7VALOR_DUPL.Value then
      begin
        bButton := Application.MessageBox('Criar uma nova conta a receber no restante do valor?','Ateno',
                                              MB_ICONQUESTION +
                                              mb_YesNo + mb_DefButton1);

        if bButton = IDYES then
        begin
          try
            ibDataSet100.Close;
            ibDataSet100.SelectSql.Clear;
            ibDataset100.SelectSql.Add('select gen_id(G_RECEBER,1) from rdb$database');
            ibDataset100.Open;
            sP := StrZero(StrToInt(ibDataSet100.FieldByname('GEN_ID').AsString),10,0);

            ibDataset100.Close;

            if copy(ibDataSet7DOCUMENTO.AsString,1,1) = '0' then
              sR := 'A'
            else
              sR := Chr(Ord(ibDataSet7DOCUMENTO.AsString[1])+1);

            if ibDataSet7VALOR_JURO.AsFloat > ibDataSet7VALOR_DUPL.AsFloat then
            begin
              bButton := Application.MessageBox('Incluir os juros na nova conta a receber?','Ateno',
                                                    MB_ICONQUESTION +
                                                    mb_YesNo + mb_DefButton2);

              if bButton = IDYES then
              begin
                fTotal := ibDataSet7VALOR_JURO.AsFloat - ibDataSet7VALOR_RECE.AsFloat;
              end else
              begin
                fTotal := ibDataSet7VALOR_DUPL.AsFloat - ibDataSet7VALOR_RECE.AsFloat;
              end;
            end else
            begin
              fTotal := ibDataSet7VALOR_DUPL.AsFloat - ibDataSet7VALOR_RECE.AsFloat;
            end;

            Form7.ibDataSet100.Close;
            Form7.ibDataSet100.SelectSql.Clear;
            Form7.ibDataSet100.SelectSql.Add('insert into RECEBER (DOCUMENTO, VALOR_DUPL, VALOR_RECE, EMISSAO, VENCIMENTO, NOME, HISTORICO, CONTA, NUMERONF, REGISTRO) values('
              +QuotedStr(sR+copy(ibDataSet7DOCUMENTO.AsString,2,9))+', '
              +QuotedStr(StrTran(StrZero(fTotal,10,2),',','.'))
              +', '+QuotedStr('0')
              +', '+QuotedStr(DateToStrInvertida(Date))
              +', '+QuotedStr(DateToStrInvertida(Date))
              +', '+QuotedStr(StrTran(ibDataSet7Nome.AsString,chr(39),''))
              +', '+QuotedStr(StrTran(ibDataSet7Historico.AsString,chr(39),''))
              +', '+QuotedStr(ibDataSet7CONTA.AsString)
              +', '+QuotedStr(ibDataSet7NUMERONF.AsString)
              +', '+QuotedStr(sP)+') ');
            Form7.ibDataSet100.Open;
          except
          end;
        end;
      end;

      if ibDataSet7RECEBIMENT.AsString = '' then
        ibDataSet7RECEBIMENT.AsDateTime := Date;

      try
        if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
        begin
          if Pos(Form7.ibDataSet7PORTADOR.AsString,'RECEBIDO') = 0 then
          begin
            Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
          end;
        end;
      except
      end;
    end;

    if ibDataSet7VALOR_RECE.Value <> 0 then // Se valor Zero apaga o antigo mas no grava o novo
    begin
      Form7.ibDataSet1.Append;
      Form7.ibDataSet1DATA.AsDateTime    := ibDataSet7RECEBIMENT.AsDateTime;
      Form7.ibDataSet1ENTRADA.AsFloat    := ibDataSet7VALOR_RECE.AsFloat;
      Form7.ibDataSet1HISTORICO.AsString := Alltrim(copy('Receb. doc. '+ibDataSet7DOCUMENTO.AsString+'-'+ibDataSet7NOME.AsString+Replicate(' ',45),1,45));
      Form7.ibDataSet1NOME.AsString      := ibDataSet7CONTA.AsString;     // contas bancrias
      Form7.ibDataSet1.Post;
    end;
  end;
end;

procedure TForm7.ibDataSet5COMPENSSetText(Sender: TField; const Text: String);
begin
  { ------------------------------------------------------------------ }
  { Cuidado: Esta rotina est associada a todos os campos do tipo data }
  { ------------------------------------------------------------------ }
  if Text = '  /  /    ' then
  begin
    Sender.AsString := '';
  end else
  begin
    try
      if (StrToDate(Text) <= (Date-(360*90))) or (StrToDate(Text) >= (Date+(360*90))) then
      begin
        if Application.MessageBox(Pchar('Esta data no parece ser a correta. Voc confirma '+text+ Chr(10) +
                                        'como a data vlida?' + Chr(10))
                                         ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION) <> IDYES then
        begin
          Form7.bFlag := False;
        end else
        begin
          try
            Sender.AsString := Text;
          except
            begin
              Form7.bFlag := False;
              //ShowMessage('Esta data no  vlida, digite-a novamente.'); Mauricio Parizotto 2023-10-25
              MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
            end;
          end;
        end;
      end else
      begin
        try
          Sender.AsString := Text;
        except
          begin
            Form7.bFlag := False;
            //ShowMessage('Esta data no  vlida, digite-a novamente.');  Mauricio Parizotto 2023-10-25
            MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
          end;
        end;
      end;
    except
      Form7.bFlag := False;
      //ShowMessage('Esta data no  vlida, digite-a novamente.');  Mauricio Parizotto 2023-10-25
      MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
    end;
  end;
end;

procedure TForm7.DefineCaptionReceberPagar;
begin
  if not Panel2.Visible then
    Exit;

   if sModulo = 'PAGAR' then
    lblRecebPagto.Caption := 'Pagamento:';
   if sModulo = 'RECEBER' then
    lblRecebPagto.Caption := 'Recebimento:';
end;

function TForm7.MovimentaEstoqueAlteracaBloqueados: Boolean;
var
  cModuloAnt: String;
begin
  // Result Representa se deve agendar o Commit
  Result := False;
  try
    // Processa os produtos que ainda no foram baixados do estoque por motivo de Dead Look
    cModuloAnt := sModulo;
    try
      sModulo := 'NAO';
      // Teste LOKED Ronei
      ibDataSet27.Close;
      ibDataSet27.SelectSQL.Clear;
      ibDataSet27.SelectSQL.Add('select * from ALTERACA where TIPO='+QuotedStr('LOKED')+' or TIPO='+QuotedStr('CANLOK')+' or TIPO='+QuotedStr('KOLNAC'));
      ibDataSet27.Open;

      ibDataSet27.First;
      while not ibDataSet27.Eof do
      begin
        try
          if AllTrim(Form7.ibDataSet27CODIGO.AsString)<>'' then
          begin
            Result := True;

            Form7.ibDataSet4.Close;
            Form7.ibDataSet4.SelectSQL.Clear;
            Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet27CODIGO.AsString)+' ');
            Form7.ibDataSet4.Open;

            if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet27CODIGO.AsString then
            begin
              ibDataSet4.Edit;

              if (Form7.ibDataSet27TIPO.AsString = 'CANLOK') or (Form7.ibDataSet27TIPO.AsString = 'KOLNAC') then
              begin
                ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat + ibDataSet27QUANTIDADE.AsFloat; // Mantem a sincronia
              end else
              begin
                ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat - ibDataSet27QUANTIDADE.AsFloat; // Mantem a sincronia
              end;

              ibDataSet4ULT_VENDA.AsDateTime := ibDataSet27DATA.AsDateTime; // Mantem a sincronia
              ibDataSet4.Post;
            end;

            ibDataSet27.Edit;
            if AllTrim(ibDataSet27SERIE.AsString)='' then
            begin
              if Form7.ibDataSet27TIPO.AsString = 'LOKED' then
              begin
                ibDataSet27TIPO.AsString  := 'BALCAO'; // Resolvi este problema baseado no sincronia
              end;

              if Form7.ibDataSet27TIPO.AsString = 'CANLOK' then
              begin
                ibDataSet27TIPO.AsString  := 'CANCEL'; // Resolvi este problema baseado no sincronia
              end;

              if Form7.ibDataSet27TIPO.AsString = 'KOLNAC' then
              begin
                ibDataSet27DESCRICAO.AsString := '<CANCELADO>';
                ibDataSet27TIPO.AsString      := 'CANCEL'; // Resolvi este problema baseado no sincronia
              end;
            end else
            begin
              ibDataSet27TIPO.AsString  := 'VENDA'; // Resolvi este problema baseado no sincronia
            end;
          end;
        except
        end;

        ibDataSet27.Next;
      end;

      if (Form7.ibDataset4.State in ([dsEdit, dsInsert])) then
        ibDataSet27.Post;

      try
        ibDataSet16.Close;
        ibDataSet16.SelectSQL.Clear;
        ibDataSet16.SelectSQL.Add('update ITENS001 set SINCRONIA=QUANTIDADE where coalesce(SINCRONIA,9999999)=9999999');
        ibDataSet16.Open;
      except
      end;

      ibDataSet16.Close;
      ibDataSet16.SelectSQL.Clear;
      ibDataSet16.SelectSQL.Add('select * from ITENS001, VENDAS where ITENS001.NUMERONF=VENDAS.NUMERONF and Coalesce(EMITIDA,''R'')=''S'' and coalesce(ITENS001.QUANTIDADE,0) <> coalesce(ITENS001.SINCRONIA,0)');
      ibDataSet16.Open;

      ibDAtaSet16.First;

      while not ibDataSet16.Eof do
      begin
        Result := True;

        try
          Form7.ibQuery1.Close;
          Form7.IBQuery1.SQL.Clear;
          Form7.IBQuery1.SQL.Add('select EMITIDA from VENDAS where NUMERONF='+QuotedStr(Form7.ibDataSet16NUMERONF.AsString)+'');
          Form7.IBQuery1.Open;

          if Form7.ibQuery1.FieldByName('EMITIDA').AsString = 'S' then
          begin
            if AllTrim(Form7.ibDataSet16CODIGO.AsString)<>'' then
            begin
              Form7.ibDataSet4.Close;
              Form7.ibDataSet4.SelectSQL.Clear;
              Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
              Form7.ibDataSet4.Open;

              if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet16CODIGO.AsString then
              begin
                ibDataSet4.Edit;
                ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat - ibDataSet16QUANTIDADE.AsFloat; // Mantem a sincronia
                ibDataSet4ULT_VENDA.AsDateTime := Date; // Mantem a sincronia
                ibDataSet4.Post;
                ibDataSet16.Edit;
                ibDataSet16SINCRONIA.AsFloat   := ibDataSet16QUANTIDADE.AsFloat; // Resolvi este problema as 4 da madrugada no NoteBook em casa
                ibDataSet16.Post;
              end;
            end;
          end;
        except
        end;

        ibDataSet16.Next;
      end;

      try
        ibDataSet23.Close;
        ibDataSet23.SelectSQL.Clear;
        ibDataSet23.SelectSQL.Add('update ITENS002 set SINCRONIA=QUANTIDADE where coalesce(SINCRONIA,9999999)=9999999');
        ibDataSet23.Open;
      except
      end;

      ibDataSet23.Close;
      ibDataSet23.SelectSQL.Clear;
      ibDataSet23.SelectSQL.Add('select * from ITENS002 where coalesce(QUANTIDADE,0) <> coalesce(SINCRONIA,0)');
      ibDataSet23.Open;

      ibDAtaSet23.First;

      while not ibDataSet23.Eof do
      begin
        Result := True;

        try
          if AllTrim(Form7.ibDataSet23CODIGO.AsString)<>'' then
          begin
            Form7.ibDataSet4.Close;
            Form7.ibDataSet4.SelectSQL.Clear;
            Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');
            Form7.ibDataSet4.Open;

            if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet23CODIGO.AsString then
            begin
              ibDataSet4.Edit;
              ibDataSet4QTD_ATUAL.AsFloat := ibDataSet4QTD_ATUAL.AsFloat + ibDataSet23QUANTIDADE.AsFloat; // Mantem a sincronia
              ibDataSet4.Post;

              ibDataSet23.Edit;
              ibDataSet23SINCRONIA.AsFloat   := ibDataSet23QUANTIDADE.AsFloat;       // Resolvi este problema as 4 da madrugada no NoteBook em casa

              if ibDataSet23CUSTO.AsFloat = 0 then
                ibDataSet23CUSTO.Value         := Form7.ibDataSet4CUSTOCOMPR.AsFloat;   // Custo de compra            //

              ibDataSet23.Post;
            end;
          end;
        except
        end;

        ibDataSet23.Next;
      end;
    finally
      sModulo := cModuloAnt;
    end;
  except
  end;
end;

procedure TForm7.FormShow(Sender: TObject);
var
  Mais1Ini : TiniFile;
  J, I, iLeft, iIconeCom : Integer;
  tInicio : tTime;
  Hora, Min, Seg, cent : Word;
  bA : Boolean;
  sSerieNFSelecionada: String;
begin
  tInicio               := Time;

  {$Region'/// Ajustes de Layout ////'}
  Form1.Panel4.Visible  := True;
  FbDuplicandoProd      := False;
  Screen.Cursor         := crHourGlass;

  // RECEBER CONTAS
  Panel2.Visible        := False;
  Panel3.Visible        := False;

  // Desabilita os grids e paineis secundrios
  Panel9.Caption        := '0,00';
  Panel9.Visible        := False;
  Panel10.Visible       := False;
  dbGrid2.Visible       := False;
  dbGrid3.Visible       := False;
  dbGrid4.Visible       := False;

  Form7.Caption := StrTran(sTitulo,'(RPS) RPS','(RPS)');

  Relatriodecomisses1.Visible := False;

  Form7.AlphaBlend      := True;
  Form7.AlphaBlendValue := 0;

  DefineJanela(True);
  {$Endregion}

  try
    if Form10.Visible then
      Form10.Close;
  except
  end;

  if oArqConfiguracao = nil then
    oArqConfiguracao := TArquivosDAT.Create(Usuario);


  {Sandro Silva 2023-06-19 inicio}
  if Form7.sModulo <> 'VENDA' then
  begin
    Form7.ibDataSet7VALOR_DUPL.DisplayWidth := 14;
    Form7.ibDataSet7PORTADOR.Index := 12;
    Form7.ibDataSet7PORTADOR.DisplayWidth  := 33;
    Form7.ibDataSet7DOCUMENTO.DisplayWidth := 12;
  end;
  {Sandro Silva 2023-06-19 fim}

  try
    // Pega os dados do Emitente
    Form7.ibDataSet13.Active := True;
    // Sandro Silva 2022-10-31 if Pos('1'+UpperCase(UpperCase(Form7.ibDataSet13ESTADO.AsString))+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21mg2') = 0 then
    if (Pos('1'+UpperCase(UpperCase(Form7.ibDataSet13ESTADO.AsString))+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21mg2') = 0)
     or (Form1.ValidaEmitenteMunicipio = False) then
    begin
      try
        try
          Form17 := TForm17.Create(nil);
          Form17.ShowModal;
        finally
          FreeAndNil(Form17);
        end;


        if Form1.CanFocus then
          Form1.SetFocus;
      except
      end;
    end;

    Commitatudo(True);
    AgendaCommit(False);


    {$Region'//// Mdulo Estoque/Venda ////'}
    {Dailon Parisotto (f-7712) 2024-02-16 Inicio
    if (sModulo = 'ESTOQUE') and (not Form12.Visible) and (not Form30.Visible) then
    }
    if ((sModulo = 'ESTOQUE') or (sModulo = 'VENDA')) and (not Form12.Visible) and (not Form30.Visible) then
    {Dailon Parisotto (f-7712) 2024-02-16 Fim}
    begin
      ibDataSet27.DisableControls;
      ibDataSet4.DisableControls;
      ibDataSet16.DisableControls;
      ibDataSet23.DisableControls;
      //LogRetaguarda('unit7 ibDataSet23.DisableControls 9904'); // Sandro Silva 2023-12-04
      ibDataSet12.DisableControls;

      AtualizaPromocao(True);
      bA := False;

      {Dailon Parisotto (f-7712) 2024-02-16 Inicio}
      bA := MovimentaEstoqueAlteracaBloqueados;
      {Dailon Parisotto (f-7712) 2024-02-16 Fim}
      // Se der um try no grava nada
      try
        Form7.ibQuery5.Close;
        Form7.IBQuery5.SQL.Clear;
        Form7.IBQuery5.SQL.Add('select CODIGO, DESCRICAO, QTD_ATUAL from ESTOQUE where QTD_ATUAL < 0');
        Form7.IBQuery5.Open;

        Form7.IBQuery5.First;
        while not Form7.IBQuery5.Eof do
        begin
          // Verifica se  produto composto
          Form7.IBQuery3.Close;
          Form7.IBQuery3.SQL.Clear;
          Form7.IBQuery3.SQL.Add('select * from COMPOSTO where CODIGO='+QuotedStr(Form7.IBQuery5.FieldByname('CODIGO').AsString)+' ');
          Form7.IBQuery3.Open;

          if AllTrim(Form7.IBQuery5.FieldByname('CODIGO').AsString) = AllTrim(Form7.IBQuery3.FieldByname('CODIGO').AsString) then
          begin
            try
              Form7.bFabrica := True;

              Form7.IBQuery3.First;
              while not Form7.IBQuery3.Eof do
              begin
                bA := True;

                Form7.ibDataSet4.Close;
                Form7.ibDataSet4.Selectsql.Clear;
                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.IBQuery3.FieldByname('DESCRICAO').AsString)+' ');  //
                Form7.ibDataSet4.Open;

                Form7.ibDataSet4.Edit;
                Form7.ibDataSet4QTD_ATUAL.AsFloat := Arredonda(Form7.ibDataSet4QTD_ATUAL.AsFloat - (Form7.IBQuery3.FieldByname('QUANTIDADE').AsFloat * (Form7.IBQuery5.FieldByname('QTD_ATUAL').AsFloat*-1)),3);
                Form7.ibDataSet4.Post;

                Form7.IBQuery3.Next;
              end;
            except
              //ShowMEssage('Erro: 7319');  Mauricio Parizotto 2023-10-25
              MensagemSistema('Erro: 7319',msgErro);
            end;

            Form7.ibDataSet4.Close;
            Form7.ibDataSet4.Selectsql.Clear;
            Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.IBQuery5.FieldByname('DESCRICAO').AsString)+' ');  //
            Form7.ibDataSet4.Open;

            Form7.ibDataSet4.Edit;
            Form7.ibDataSet4QTD_ATUAL.AsFloat := Form7.ibDataSet4QTD_ATUAL.AsFloat + (Form7.IBQuery5.FieldByname('QTD_ATUAL').AsFloat*-1);
            Form7.ibDataSet4.Post;

            Form7.bFabrica := False;
          end;

          Form7.IBQuery5.Next;
        end;
      except
        Form7.IBTransaction1.Rollback;
      end;

      if bA then
      begin
        Commitatudo(True);
        AgendaCommit(False);
      end;

      ibDataSet27.EnableControls;
      ibDataSet4.EnableControls;
      ibDataSet16.EnableControls;
      ibDataSet23.EnableControls;
      //LogRetaguarda('unit7 ibDataSet23.EnableControls 10159'); // Sandro Silva 2023-12-04
      ibDataSet12.EnableControls;
    end;

    {$Endregion}

    {$Region' //// Mdulo Clientes ////'}
    if sModulo = 'CLIENTES' then
    begin
      try
        if Form1.bFechaTudo then
        begin
          Form7.ibDataSet15.Close;
          Form7.ibDataSet15.SelectSql.Clear;
          Form7.ibDataset15.SelectSql.Add('select * from VENDAS where LOKED='+QuotedStr('S')+' ');
          Form7.ibDataset15.Open;

          while not ibDataset15.Eof do
          begin
            // Abre o arquivo de clientes para edio
            try
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.SelectSql.Clear;
              Form7.ibDataset2.SelectSql.Add('select * from CLIFOR where NOME='+QuotedStr(AllTrim(Form7.ibDataSet15CLIENTE.AsString))+' ');
              Form7.ibDataset2.Open;

              if (Form7.ibDataSet2ULTIMACO.AsDateTime < Form7.ibDataSet15EMISSAO.AsDateTime) and (AllTrim(Form7.IBDataSet2NOME.AsString)=AllTrim(Form7.ibDataSet15CLIENTE.AsString)) then
              begin
                sModulo := 'LOKED';
                Form7.ibDataSet2.Edit;
                Form7.ibDataSet2ULTIMACO.AsDateTime := Form7.ibDataSet15EMISSAO.AsDateTime;
                Form7.ibDataSet2.Post;
                sModulo := 'CLIENTES';
              end;

              try
                Form7.ibDataSet15.Edit;
                Form7.ibDataSet15LOKED.AsString := '';
                Form7.ibDataSet15.Post;
              except
              end;
            except
              sModulo := 'CLIENTES';
            end;

            Form7.ibDataSet15.Next;
          end;
        end;
      except
        Form7.ibDataSet15.Close;
        Form7.ibDataSet15.SelectSql.Clear;
        Form7.ibDataSet15.Selectsql.Add('select * from VENDAS where EMISSAO=CURRENT_DATE ');
        Form7.ibDataset15.Open;

        Form7.ibDataSet2.Close;
        Form7.ibDataSet2.SelectSql.Clear;
        Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR order by upper(NOME)');
        Form7.ibDataset2.Open;

        sModulo := 'CLIENTES';
      end;
    end;
    {$Endregion}

    dbGrid1.DataSource := Form7.DataSource13;
    Form4.Close;

    bSoLeitura := SomenteLeitura;

    {$Region '//// Permises Usurios'}

    {$Endregion}

    //2024-01-17 Sandro Silva Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
    Mais1ini := TIniFile.Create(IniFileUsuarioLogado);
    try
      if AllTrim(sModulo) <> '' then
      begin
        DBGrid1.Font.Name  := Mais1Ini.ReadString(sModulo,'FonteName_','Microsoft Sans Serif');
        DBGrid1.Font.Size  := StrToInt(Mais1Ini.ReadString(sModulo,'FonteSize_','10'));
        DBGrid1.Font.Color := StrToInt(Mais1Ini.ReadString(sModulo,'FonteColor_','0'));

        if Mais1Ini.ReadString(sModulo,'FonteY_','') = ''         then
          DBGrid1.Font.Style := [];                  //
        if Mais1Ini.ReadString(sModulo,'FonteY_','') = 'fsItalic' then
          DBGrid1.Font.Style := [fsItalic];         //
        if Mais1Ini.ReadString(sModulo,'FonteY_','') = 'fsBold'   then
          DBGrid1.Font.Style := [fsBold];

        DBGrid1.TitleFont.Name  := DBGrid1.Font.Name;

        {$IFDEF VER150}
        DBGrid1.TitleFont.Size  := DBGrid1.Font.Size +2;
        {$ELSE}
        DBGrid1.TitleFont.Size  := DBGrid1.Font.Size;
        {$ENDIF}

        DBGrid1.TitleFont.Color := DBGrid1.Font.Color;
        DBGrid1.TitleFont.sTyle := [];
      end;
    except
    end;

      // Abilita ou desabilita os campos                   //
      if (sModulo = 'COMPRA') or (sModulo = 'VENDA') or (sModulo = 'OS') then
      begin
        Form7.ibDataSet35UNITARIO.Visible := False;
        Form7.ibDataSet16UNITARIO.Visible := False;
        //
        if (sModulo = 'COMPRA') then
        begin
          dbGrid2.Left    := Form7.Width - 447 - 5; // Form7.Width - 410 -5;
          dbGrid2.Top     := dbGrid1.Top;
          dbGrid2.Height  := (dbGrid1.Height div 2) - Panel9.Height;
          dbGrid2.Width   := 432;
        end
        else
        begin
          dbGrid2.Left    := Form7.Width - 410 - 5;
          dbGrid2.Top     := dbGrid1.Top;
          dbGrid2.Height  := (dbGrid1.Height div 2) - Panel9.Height;
          dbGrid2.Width   := 395;
        end;

        dbGrid2.Visible := True;

        Panel9.Top     := dbGrid2.Top + dbGrid2.Height -1;
        Panel9.Left    := dbGrid2.Left;
        Panel9.width   := dbGrid2.Width;
        Panel9.Visible := True;

        if (sModulo = 'COMPRA') then
        begin
          dbGrid3.Left    := Form7.Width - 447 -5;
          dbGrid3.Top     := Panel9.Top + Panel9.Height + 10;
          dbGrid3.Height  := dbGrid1.Height - dbGrid2.Height - Panel9.Height - 5 -4;
          dbGrid3.Width   := 432;
        end
        else
        begin
          dbGrid3.Left    := Form7.Width - 410 -5;
          dbGrid3.Top     := Panel9.Top + Panel9.Height + 10;
          dbGrid3.Height  := dbGrid1.Height - dbGrid2.Height - Panel9.Height - 5 -4;
          dbGrid3.Width   := 395;
        end;

        dBgrid3.Visible        := True;

        Panel10.Top     := dbGrid3.Top + dbGrid3.Height -1;
        Panel10.Left    := dbGrid3.Left;
        Panel10.Width   := dbGrid3.Width;

        Panel10.Visible := True;

        dbGrid1.Width   := dbGrid1.Width - dbGrid3.Width - 15;

        Form7.ibDataSet16UNITARIO.Visible       := False;
        Form7.ibDataSet16CFOP.Visible           := False;
        Form7.ibDataSet16DESCRICAO.DisplayWidth := 41;

        Form7.ibDataSet23UNITARIO.Visible       := False;
        Form7.ibDataSet23IPI.Visible            := False;
        Form7.ibDataSet23ICM.Visible            := False;
        Form7.ibDataSet23CST_ICMS.Visible       := False;
        Form7.ibDataSet23CST_IPI.Visible        := False;
        Form7.ibDataSet23CFOP.Visible           := False;
        if (sModulo = 'COMPRA') then
        begin
          Form7.ibDataSet23CFOP.Visible           := True;

        end;
        Form7.ibDataSet23VICMS.Visible          := False;
        Form7.ibDataSet23VBC.Visible            := False;
        Form7.ibDataSet23VBCST.Visible          := False;
        Form7.ibDataSet23VICMSST.Visible        := False;
        Form7.ibDataSet23PICMSST.Visible      := True; //Sandro Silva 2024-03-28
        Form7.ibDataSet23VIPI.Visible           := False;
        Form7.ibDataSet23EAN_ORIGINAL.Visible   := False;

        Form7.ibDataSet23DESCRICAO.DisplayWidth := 41;
        Form7.ibDataSet23TOTAL.DisplayWidth     := 10;
        Form7.ibDataSet23QUANTIDADE.DisplayWidth:= 9;

        {$IFDEF VER150}
        Form7.DBGrid1.Options   := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];
        {$ELSE}
        Form7.DBGrid1.Options   := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize,dgTitleClick	];
        {$ENDIF}

        Form7.DbGrid1.ReadOnly  := True;
        Form7.DbGrid1.Update;
        Form7.Image308.Visible  := False;
        Form7.imgLibBloq.Visible  := True;
        Form7.Label208.Caption  := 'Liberar';

        if Form7.sRPS = 'S' then
        begin
            Form7.dBGrid2.Visible     := False;
            form7.Panel9.Visible      := False;

            dbGrid3.Top            := dbGrid1.Top;
            dbGrid3.Height         := (dbGrid1.Height);
        end;
      end;

      FormShowModulos(Mais1Ini, sSerieNFSelecionada);

      //TabelaAberta.DisableControls;  Mauricio Parizotto 2024-01-04

      try
        {$IFDEF VER150}
        Form7.DBGrid1.Options := [dgTitles, dgColLines, dgRowLines, dgTabs, dgColumnResize]; // 2CONTAS
        {$ELSE}
        Form7.DBGrid1.Options := [dgTitles, dgColLines, dgRowLines, dgTabs, dgColumnResize,dgTitleClick]; // 2CONTAS
        {$ENDIF}

        try
          for I := 1 to iCampos do
          begin
            ArquivoAberto.Fields[I-1].Visible := True;
            if copy(sMostra+'FFFFFFFFFFFFFFFFFFFF',I,1) = 'F' then
              ArquivoAberto.Fields[I-1].Visible := False;
          end;
        except
        end;
      except
      end;

      // Visual
      iIconeCom := 70;

      Form7.MenuItem61.Enabled := True;
      Form7.MenuItem62.Enabled := True;
      Form7.MenuItem63.Enabled := True;
      Form7.Ativo5.Enabled     := True;

      if Form7.bSoLeitura then
      begin
        try
          if Form7.Menu <> MainMenu99 then
          begin
            if sModulo <> 'RECEBER' then Form7.Menu.Items[1].Enabled := False else
            begin
              Form7.MenuItem61.Enabled := False;
              Form7.MenuItem62.Enabled := False;
              Form7.MenuItem63.Enabled := False;
              Form7.Ativo5.Enabled     := False;
            end;

            imgNovo.Visible := False;
            imgExcluir.Visible := False;
            imgLibBloq.Visible := False; Form7.Label208.Caption  := 'Bloquear';
            Image308.Visible := False;

            lblNovo.Visible := False;
            lblExcluir.Visible := False;
            Label208.Visible := False;
          end;
        except
        end;
      end else
      begin
        try
          if (Form7.Menu <> MainMenu99) or  (sModulo = 'GRUPOS') or (sModulo = 'TRANSPORT')  then
          begin
            imgNovo.Visible := True;
            imgExcluir.Visible := True;
            imgLibBloq.Visible := True; Form7.Label208.Caption  := 'Liberar';

            lblNovo.Visible := True;
            lblExcluir.Visible := True;
            Label208.Visible := True;

            if (Form7.Menu <> MainMenu99) then
              Form7.Menu.Items[1].Enabled := True;
          end;
        except
        end;
      end;

      try
        if not Form7.bSoLeitura then
        begin
          Form7.Image308.Visible  := False;
          Form7.imgLibBloq.Visible  := True; Form7.Label208.Caption  := 'Liberar';
          Form7.Label208.Visible  := True;
        end;
        if (sModulo = 'NOTA') or (sModulo = 'CONCILIACAO') or (Form7.sModulo = 'CONFOS') or (Form7.sModulo = 'CONFRECIBO') then
        begin
          {$IFDEF VER150}
          Form7.DBGrid1.Options  := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs]; // NOTA CONCILIACAO CONFOS CONFRECIBO
          {$ELSE}
          Form7.DBGrid1.Options  := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgTitleClick]; // NOTA CONCILIACAO CONFOS CONFRECIBO
          {$ENDIF}

          Form7.dbGrid1.ReadOnly := False;
        end;
      except
      end;

    // Abre e posiciona
    imgFiltrar.Visible := True;
    imgEditar.Visible := True;
    imgNovo.Visible := True;
    lblFiltrar.Visible := True;
    lblEditar.Visible := True;
    lblNovo.Visible := True;

    if (sModulo = 'TECNICO') then
    begin
      imgFiltrar.Visible := False;
      lblFiltrar.Visible := False;
    end;

    if sModulo = 'ORCAMENTO' then
    begin
      imgExcluir.Visible := True;
      lblExcluir.Visible := True;
      imgEditar.Visible := False;
      lblEditar.Visible := False;
    end;

    if sModulo = 'VENDA' then
    begin
      imgExcluir.Visible := False;
      lblExcluir.Visible := False;
    end;

    if (sModulo = 'COMPRA') or (sModulo = 'VENDA') or (sModulo = 'OS') then
    begin
      Image308.Visible := False;
      imgLibBloq.Visible := False;
      Form7.Label208.Caption  := 'Bloquear';
      Label208.Visible := False;
    end;

    if (sModulo = 'OS') then
    begin
      //imgExcluir.Visible := False; // No pode apagar DAV
      imgExcluir.Visible := True;
      lblExcluir.Visible := True;
    end;

    iLeft := 2+5;

    if imgNovo.Visible then
    begin
      imgNovo.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;

    if imgExcluir.Visible then
    begin
      imgExcluir.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;

    if imgProcurar.Visible then
    begin
      imgProcurar.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;

    if imgImprimir.Visible then
    begin
      imgImprimir.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;

    if imgVisualizar.Visible then
    begin
      imgVisualizar.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;

    if imgEditar.Visible then
    begin
      imgEditar.Left := iLeft ;
      iLeft := iLeft + iIconeCom;
    end;

    if imgLibBloq.Visible then
    begin
      imgLibBloq.Left := iLeft ;
      Image308.Left := imgLibBloq.Left;
      iLeft := iLeft + iIconeCom;
    end;

    if imgFiltrar.Visible then
    begin
      imgFiltrar.Left := iLeft ;
    end;


    {$Region'//// Monta SQL Consulta ////'}

    if (AllTrim(sWhere)     = 'where')     then
      swhere   := '';
    if (UpperCase(sOrderBy) = 'ORDER BY NOME')      then
    begin
      if sModulo = 'ESTOQUE' then
      begin
        sOrderBy := 'order by upper(NOME), upper(DESCRICAO)';
      end else
      begin
        sOrderBy := 'order by upper(NOME)';
      end;
    end;

    if (UpperCase(sOrderBy) = 'ORDER BY DESCRICAO') then
      sOrderBy := 'order by upper(DESCRICAO)';

    //Mauricio Parizotto 2024-01-04 Comentado If pois estava bagunando click no gid
    //if (AllTrim(StrTran(StrTran(StrTran(StrTran(StrTran(StrTran(AllTrim(UpperCase(TabelaAberta.SelectSQL.Text)),Chr(10),''),Chr(13),''),'COALESCE(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA''',''),'  ',' '),'WHERE ORDER','ORDER'),'AND ORDER','ORDER'))
    //  <> AllTrim(StrTran(StrTran(StrTran(AllTrim(UpperCase(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy))),Chr(10),''),Chr(13),''),'  ',' '))) or (not TabelaAberta.Active) then
    begin
      // Este bloco tem toda a demora
      begin
        try
          TabelaAberta.Close;
          TabelaAberta.SelectSQL.Clear;
          //
          if (sModulo = 'VENDA') and (pos('and',sWhere)=0) then
          begin
            // Filtro auxiliar
            //
            // Sandro Silva 2023-04-24 TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' and EMISSAO >'+QuotedStr( DateToStrInvertida(DATE - 30) )+' '+AllTrim(sOrderBy));
            // Sandro Silva 2023-04-24 Ficha 6777
            // Sandro Silva 2023-05-05 TabelaAberta.SelectSQL.Add(Trim(sSelect) + ' ' + Trim(sWhere) + ' and EMISSAO > (select coalesce(max(EMISSAO), current_date) - 90 from VENDAS where NUMERONF like ''%' + sSerieNFSelecionada + ''') ' + ' ' + Trim(sOrderBy));
            TabelaAberta.SelectSQL.Add(Trim(sSelect) + ' ' + Trim(sWhere) + ' and EMISSAO > (select coalesce(max(EMISSAO), current_date) - 90 from VENDAS where NUMERONF like ''%' + sSerieNFSelecionada + ''') ' + ' ' + Trim(sOrderBy));
          end else
          begin
            if (sModulo = 'RECEBER') then
            begin
              if sWhere <> '' then
              begin
                TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' and coalesce(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA'' '+AllTrim(sOrderBy));
              end else
              begin
                TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' where coalesce(HISTORICO,''XXX'')<>''NFE NAO AUTORIZADA'' '+AllTrim(sOrderBy));
              end;
            end else
            begin
              TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy));
            end;
          end;
          //
          TabelaAberta.Open;
        except
          on E: Exception do
          begin
            sWhere   := '';
            if Form7.sModulo <> 'ORCAMENTO' then
            begin
              {
              Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+TabelaAberta.SelectSQL.Text+chr(10)+chr(10)
              ),'Erro: 2211',mb_Ok + MB_ICONWARNING);
              Mauricio Parizotto 2023-10-24}

              MensagemSistema(E.Message+chr(10)+chr(10)+TabelaAberta.SelectSQL.Text+chr(10)+chr(10)+#13#10+'Erro: 2211'
                              ,msgErro);

              sOrderBy := ''
            end else
            begin
              //Sandro Silva 2019-09-25 No est agrupando quando lana itens em data diferentes sOrderBy  := 'group by PEDIDO, DATA, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO';
              sOrderBy  := 'group by ORCAMENTS.PEDIDO, ORCAMENTS.CLIFOR, ORCAMENTS.VENDEDOR, ORCAMENTS.NUMERONF order by ORCAMENTS.PEDIDO';
              sOrderBy  := '';
            end;

            TabelaAberta.Close;
            TabelaAberta.SelectSQL.Clear;
            TabelaAberta.SelectSQL.Add(AllTrim(sSelect)+' '+AllTrim(sWhere)+' '+AllTrim(sOrderBy));
            TabelaAberta.Open;
          end;
        end;
      end;
    end;

    {$Endregion}


    if (sModulo = 'ORCAMENTO') then
      TabelaAberta.FieldByName('Registro').Visible := False;

    //if (sModulo <> 'CAIXA') and (sModulo <> 'BANCOS') then Mauricio Parizotto 2023-12-04
    if (sModulo <> 'CAIXA') and (sModulo <> 'BANCOS') and (sModulo <> 'OSSITUACAO') then
    begin
      try
        if not bFirst then
        begin
          if not TabelaAberta.Locate('REGISTRO',sRegistro,[]) then
            TabelaAberta.Last;
        end else
        begin
          bFirst := False;
        end;
      except
        TabelaAberta.First;
      end;
    end
    else
      TabelaAberta.Last;

    dbGrid1.DataSource := DataSourceAtual;

    //{Mauricio Parizotto 2024-01-04
    try
      if StrToInt('0'+LimpaNumero(sLinha)) > 0 then
      begin
        TabelaAberta.MoveBy((StrToIntDef(LimpaNumero(sLinha) ,0) -1) *-1);
        TabelaAberta.MoveBy((StrToIntDef(LimpaNumero(sLinha) ,0) -1) * 1);

        {
        I := TabelaAberta.MoveBy(StrToInt('0'+LimpaNumero(sLinha))*-1);
        TabelaAberta.MoveBy(I*-1);
        }
      end;
    except
    end;

    try
      dbGrid1.SelectedIndex := StrToInt('0'+LimpaNumero(sColuna));
    except
      dbGrid1.SelectedIndex := 0;
    end;

    // Este bloco tem toda a demora
    DefineLayoutFiltro;

    Form7.Panel7.Caption   := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    Form7.pnlFiltro.Repaint;

    if imgNovo.Visible then
      MostraLabels(Form7.imgNovo,Form7.lblNovo);
    if imgExcluir.Visible then
      MostraLabels(Form7.imgExcluir,Form7.lblExcluir);
    if imgProcurar.Visible then
      MostraLabels(Form7.imgProcurar,Form7.lblProcurar);
    if imgVisualizar.Visible then
      MostraLabels(Form7.imgVisualizar,Form7.lblVisualizar);
    if imgImprimir.Visible then
      MostraLabels(Form7.imgImprimir,Form7.lblImprimir);
    if imgEditar.Visible then
      MostraLabels(Form7.imgEditar,Form7.lblEditar);
    if imgFiltrar.Visible then
      MostraLabels(Form7.imgFiltrar,Form7.lblFiltrar);
    if imgProcurar.Visible then
      MostraLabels(Form7.imgProcurar,Form7.lblProcurar);
    if imgLibBloq.Visible then
      MostraLabels(Form7.imgLibBloq,Form7.Label208);

    try
      if (sModulo = 'NOTA') or (Form7.sModulo = 'CONFOS') or (Form7.sModulo = 'CONFRECIBO') then
      begin
        Form4.Show;
        Form4.FormClick(Sender);
        TabelaAberta.EnableControls;
      end;
    except
    end;
  except
    on E: Exception do
    begin
      //ShowMessage('Erro: 673 "'+E.Message+'"'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro: 673 "'+E.Message+'"',msgErro);
      Form7.DestroyWindowHandle;
      Application.Terminate;
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE );
      Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE );
      Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      FecharAplicacao(ExtractFileName(Application.ExeName)); // Sandro Silva 2024-01-04
    end;
  end;

  DefineCaptionReceberPagar;

  try
    if sModulo = 'CAIXA' then
    begin
      // S Calcula o Saldo quando houve realmente alguma alterao no GDB
      // talvez um dia criar um generator somente para o caixa.
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,0) from rdb$database');
      Form7.ibDataset101.Open;

      if (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat <> Form7.fMutado3) then
      begin
        Form7.fMutado3 := Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat;
        CalculaSaldo(False);
        //TabelaAberta.Last; Mauricio Parizotto 2024-01-04
        {Sandro Silva 2024-03-15 inicio}
        // Para o Caixa precisa movimentar o ponteiro do dataset at o ltimo registro para que seja calculado o saldo dia a dia
        TabelaAberta.Last;
        {Sandro Silva 2024-03-15 fim}
      end;
    end;

    if sModulo = 'BANCOS' then
    begin
      Form7.ibDataSet101.Close;
      Form7.ibDataSet101.SelectSql.Clear;
      Form7.ibDataset101.SelectSql.Add('select gen_id(G_MUTADO,0) from rdb$database');
      Form7.ibDataset101.Open;

      if (Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat <> Form7.fMutado3) then
      begin
        Form7.fMutado3 := Form7.ibDataSet101.FieldByname('GEN_ID').AsFloat;
        SaldoBanco(True);
        //TabelaAberta.Last; Mauricio Parizotto 2024-01-04
      end;
    end;

    {Mauricio Parizotto 2024-01-04
    //Posiciona Grid na linha salva
    try
      if TabelaAberta.Active then
      begin
        if TabelaAberta.MoveBy(+1) = 1 then
          TabelaAberta.MoveBy(-1)
        else if TabelaAberta.MoveBy(-1) = -1 then
          TabelaAberta.MoveBy(+1);
      end;
    except
      TabelaAberta.First;
    end;
    }

    try
      DBGrid1.Visible   := True;
      pnlFiltro.Visible := True;

      if Form7.DBGrid1.CanFocus then
        Form7.DBGrid1.SetFocus;

      ArquivoAberto.EnableControls;

      Form7.Menu:= Form7.Menu;

      Mais.LeLabels(True);
      AbreArquivos(True);
    except
    end;
  except
  end;

  // Se no existe cria o layout da nova nota
  if sModulo = 'RECEBER' then
  begin
    btnRetornoCNAB400.Visible := True; // Sandro Silva 2022-12-21 Button1.Visible := True;
  end;

  DefineCaptionReceberPagar;

  Form7.AlphaBlendValue := 255;
  TabelaAberta.EnableControls;

  DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
  Form7.Panel7.Hint := 'Tempo: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0) + ' ';
  Form7.Panel7.ShowHint := True;

  Screen.Cursor := crDefault;

  MarcaColunaOrderBy;
end;

procedure TForm7.DefineLayoutFiltro;
begin
  // Layout Padro
  pnlFiltro.width      := dbGrid1.Width;
  pnlFiltro.Left       := dbGrid1.Left;
  pnlFiltro.Height     := 24;
  lblHomologacao.Top   := 0;
  lblHomologacao.Width := pnlFiltro.width;

  // Esconde a borda
  Panel7.Left := -1;
  Panel7.Width := pnlFiltro.Width + 2;
  Panel7.Top := -1;
  Panel7.Height := pnlFiltro.Height + 2;

  lblHomologacao.Visible := False;
  if (sModulo = 'VENDA') then
  begin
    if Form7.sRPS = 'S' then
      lblHomologacao.Visible := TestarNFSeHomologacao
    else
      lblHomologacao.Visible := TestarNFeHomologacao;

    if lblHomologacao.Visible then
    begin
      pnlFiltro.Height := pnlFiltro.Height + lblHomologacao.Height;
      Panel7.Top := lblHomologacao.Top + lblHomologacao.Height;
      // Diminui do Grid o LABEL
      DBGrid1.Height := DBGrid1.Height - lblHomologacao.Height; 
    end;
  end;

  pnlFiltro.Top := dbGrid1.Top + dbGrid1.Height -1;
end;

(*
function TForm7.RetornarSQLEstoqueOrcamentos: String;
//var
//  slSQL: TStringList;
begin
  //slSQL := TStringList.Create;
  try
    {Sandro Silva 2023-08-01 inicio

    Conforme combinado, no usar .add para concatenar string de comando sql.
    Isso dificulta o Debug.
    Concatenar a string de forma simples, separando em linhas e usando  '' + ''


    slSQL.Add('WITH ORCAMENTS AS (');
    slSQL.Add('SELECT');
    slSQL.Add('    ORCAMENT.PEDIDO');
    slSQL.Add('    , MIN(ORCAMENT.DATA) AS DATA');
    slSQL.Add('    , ORCAMENT.NUMERONF');
    slSQL.Add('    , ORCAMENT.CLIFOR');
    slSQL.Add('    , ORCAMENT.VENDEDOR');
    slSQL.Add('    , SUM(CASE WHEN DESCRICAO <> ' + QuotedStr('Desconto') + ' THEN TOTAL ELSE 0 END) AS TOTALBRUTO');
    slSQL.Add('    , SUM(CASE WHEN DESCRICAO  = ' + QuotedStr('Desconto') + ' THEN TOTAL ELSE 0 END) AS DESCONTO');
    slSQL.Add('FROM ORCAMENT');
    slSQL.Add('GROUP BY ORCAMENT.PEDIDO, ORCAMENT.CLIFOR, ORCAMENT.VENDEDOR, ORCAMENT.NUMERONF');
    slSQL.Add(')');
    slSQL.Add('SELECT');
    slSQL.Add('    ORCAMENTS.PEDIDO as "Oramento"');
    slSQL.Add('    , ORCAMENTS.DATA as "Data"');
    slSQL.Add('    , ORCAMENTS.CLIFOR as "Cliente"');
    slSQL.Add('    , ORCAMENTS.VENDEDOR as "Vendedor"');
    slSQL.Add('    , TOTALBRUTO as "Total bruto"');
    slSQL.Add('    , DESCONTO as "Desconto"');
    slSQL.Add('    , (TOTALBRUTO - DESCONTO) as "Total lquido"');
    slSQL.Add('    , ORCAMENTS.NUMERONF as "Doc. Fiscal"');
    slSQL.Add('    , ORCAMENTS.PEDIDO as "Registro"');
    slSQL.Add('FROM ORCAMENTS');
    Result := slSQL.Text;
    }

    {Sandro Silva 2023-09-25 inicio
    Result :=
      'WITH ORCAMENTS AS ( ' +
      ' SELECT ' +
      '    ORCAMENT.PEDIDO ' +
      '    , MIN(ORCAMENT.DATA) AS DATA ' +
      '    , max(ORCAMENT.NUMERONF) as NUMERONF ' +
      ', max(ORCAMENT.CLIFOR) as CLIFOR ' +
      ', max(case when coalesce((select first 1 O2.VENDEDOR from ORCAMENT O2 where O2.PEDIDO = ORCAMENT.PEDIDO), '''') = '''' then ' +
      '    (select first 1 O2.VENDEDOR from ORCAMENT O2 where O2.PEDIDO = ORCAMENT.PEDIDO order by registro desc) ' +
      '  else ' +
      '    (select first 1 O2.VENDEDOR from ORCAMENT O2 where O2.PEDIDO = ORCAMENT.PEDIDO) ' +
      '  end) ' +
      'as VENDEDOR ' +
      '    , SUM(CASE WHEN ORCAMENT.DESCRICAO <> ' + QuotedStr('Desconto') + ' THEN ORCAMENT.TOTAL ELSE 0 END) AS TOTALBRUTO ' +
      '    , SUM(CASE WHEN ORCAMENT.DESCRICAO  = ' + QuotedStr('Desconto') + ' THEN ORCAMENT.TOTAL ELSE 0 END) AS DESCONTO ' +
      ' FROM ORCAMENT ' +
      ' GROUP BY ORCAMENT.PEDIDO ' + //, ORCAMENT.CLIFOR, ORCAMENT.VENDEDOR ' +
      ' ) ' +
      ' SELECT ' +
      '     ORCAMENTS.PEDIDO as "Oramento" ' +
      '    , ORCAMENTS.DATA as "Data" ' +
      '    , ORCAMENTS.CLIFOR as "Cliente" ' +
      '    , ORCAMENTS.VENDEDOR as "Vendedor" ' +
      '    , TOTALBRUTO as "Total bruto" ' +
      '    , DESCONTO as "Desconto" ' +
      '    , (TOTALBRUTO - DESCONTO) as "Total lquido" ' +
      '    , ORCAMENTS.NUMERONF as "Doc. Fiscal" ' +
      '    , ORCAMENTS.PEDIDO as "Registro" ' +
      ' FROM ORCAMENTS ';
  }
    Result :=
      'WITH ORCAMENTS AS ( ' +
      '  select Q.PEDIDO ' +
      '  , Q.DATA ' +
      '  , Q.NUMERONF ' +
      '  , Q.CLIFOR ' +
      '  , O2.VENDEDOR ' +
      '  , Q.TOTALBRUTO ' +
      '  , Q.DESCONTO ' +
      '  from ' +
      '  ( ' +
      '   SELECT ' +
      '      ORCAMENT.PEDIDO ' +
      '      , MIN(ORCAMENT.DATA) AS DATA ' +
      '      , max(ORCAMENT.NUMERONF) as NUMERONF ' +
      '      , max(ORCAMENT.CLIFOR) as CLIFOR ' +
      '      , cast(list(distinct coalesce(ORCAMENT.VENDEDOR, '''')) as varchar(5000)) as VENDEDOR' +
      '      , SUM(CASE WHEN ORCAMENT.DESCRICAO <> ' + QuotedStr('Desconto') + ' THEN ORCAMENT.TOTAL ELSE 0 END) AS TOTALBRUTO ' +
      '      , SUM(CASE WHEN ORCAMENT.DESCRICAO  = ' + QuotedStr('Desconto') + ' THEN ORCAMENT.TOTAL ELSE 0 END) AS DESCONTO ' +
      '      , max(ORCAMENT.REGISTRO) as REGISTRO ' +      
      '   FROM ORCAMENT ' +
      '   GROUP BY ORCAMENT.PEDIDO ' + //, ORCAMENT.CLIFOR, ORCAMENT.VENDEDOR ' +
      '  ) Q ' +
      '  left join ORCAMENT O2 on O2.REGISTRO = Q.REGISTRO ' +
      ' ) ' +
      ' SELECT ' +
      '     ORCAMENTS.PEDIDO as "Oramento" ' +
      '    , ORCAMENTS.DATA as "Data" ' +
      '    , ORCAMENTS.CLIFOR as "Cliente" ' +
      '    , ORCAMENTS.VENDEDOR as "Vendedor" ' +
      '    , TOTALBRUTO as "Total bruto" ' +
      '    , DESCONTO as "Desconto" ' +
      '    , (TOTALBRUTO - DESCONTO) as "Total lquido" ' +
      '    , ORCAMENTS.NUMERONF as "Doc. Fiscal" ' +
      '    , ORCAMENTS.PEDIDO as "Registro" ' +
      ' FROM ORCAMENTS ';
  {Sandro Silva 2023-09-25 fim}

  finally
    //FreeAndNil(slSQL);
  end;
end;

Mauricio Parizotto 2023-10-16 movido para ufuncoesRetaguarda*)

procedure TForm7.DBGrid1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  Form7.iKey := Key;

  if Key = VK_F11  then
    Form7.Agrupar1Click(Sender);
  if Key = VK_F3   then
    Form20.Button1Click(Sender);
  if Key = VK_F5   then
  begin
    {
    Screen.Cursor            := crHourGlass;
    AgendaCommit(True);
    //
    Form7.Close;
    Form7.Show;
    //
    Screen.Cursor            := crDefault;
    Mauricio Parizotto 2023-05-31}

    RefreshDados;
  end;

  DBGridCopiarCampo((Sender as TDBGrid), Key, Shift);
end;

procedure TForm7.Imprimircheque1Click(Sender: TObject);
begin
  try
    Form23 := TForm23.create(nil);
    Form23.ShowModal;
  finally
    FreeAndNil(Form23);
  end;
end;

procedure TForm7.ibDataSet24MERCADORIAChange(Sender: TField);
begin
  //CalculaTotalNota;
end;

procedure TForm7.ibDataSet2BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo VENDAS e o arquivo RECEBER }
  sNumeroAnterior := ibDataSet2REGISTRO.AsString;
  sNomeAnterior   := ibDataSet2NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet5ENTRADA_Change(Sender: TField);
begin
  if ibDataSet5ENTRADA_.AsFloat < 0 then
    ibDataSet5ENTRADA_.AsFloat := 0;
  if ibDataSet5ENTRADA_.AsFloat <> 0 then
  begin
    if ibDataSet5SAIDA_.AsFloat <> 0 then
      ibDataSet5SAIDA_.AsFloat := 0;
  end;
  if Form7.sModulo = 'BANCOS' then
    SaldoBanco(True);
  ibDataSet5.Edit;
end;

procedure TForm7.ibDataSet5SAIDA_Change(Sender: TField);
begin
  if ibDataSet5SAIDA_.AsFloat < 0 then
    ibDataSet5SAIDA_.AsFloat := 0;
  if ibDataSet5SAIDA_.AsFloat <> 0 then
  begin
    if ibDataSet5ENTRADA_.AsFloat <> 0 then
      ibDataSet5ENTRADA_.AsFloat := 0;
  end;
  if Form7.sModulo = 'BANCOS' then
    SaldoBanco(True);
  ibDataSet5.Edit;
end;

procedure TForm7.ibDataSet1ENTRADAChange(Sender: TField);
begin
  if sModulo = 'CAIXA' then CalculaSaldo(True);
  IntegraBanco(Sender);
  ibDataSet1.Edit;
end;

procedure TForm7.ibDataSet1SAIDAChange(Sender: TField);
begin
  if sModulo = 'CAIXA' then CalculaSaldo(True);
  IntegraBanco(Sender);
  ibDataSet1.Edit;
end;

procedure TForm7.ibDataSet2NOMESetText(Sender: TField; const Text: String);
var
  cTexto: String;
begin
  cTexto := Text;

  if (AllTrim(ibDataSet2NOME.AsString) <> '') and (AllTrim(cTexto) = '') then
  begin
    //ShowMessage('Nome invlido (no pode ficar em branco).'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Nome invlido (no pode ficar em branco).',msgAtencao);
  end else
  begin
    if Valida_Campo('CLIFOR',AllTrim(cTexto),'NOME','Este cliente j foi cadastrado') then
      ibDataSet2NOME.AsString := AllTrim(cTexto);
  end;
end;

procedure TForm7.ibDataSet4BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo VENDAS e o arquivo RECEBER }
  sNumeroAnterior     := ibDataSet4REGISTRO.AsString;
  sNomeAnterior       := ibDataSet4DESCRICAO.AsString;
  fQuantidadeAnterior := ibDataSet4QTD_ATUAL.AsFloat;
  fPrecoAnterior      := Form7.ibDataSet4PRECO.AsFloat;
end;

procedure TForm7.ibDataSet4DESCRICAOSetText(Sender: TField; const Text: String);
var
  cTexto: String;
begin
  cTexto := AllTrim(Text);

  if (AllTrim(ibDataSet4DESCRICAO.AsString) <> '') and (AllTrim(cTexto) = '') then
  begin
    //ShowMessage('Descrio invlida (no pode ficar em branco).'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Descrio invlida (no pode ficar em branco).',msgAtencao);
  end else
  begin
    if Valida_Campo('ESTOQUE',cTexto,'DESCRICAO','Este produto j foi cadastrado') then
      ibDataSet4DESCRICAO.AsString := cTexto;
  end;
end;

procedure TForm7.ibDataSet4NewRecord(DataSet: TDataSet);
var
  sCodigo : String;
begin
  {Dailon Parisotto 2023-10-10 Inicio

  if (Form7.iKey = VK_Down) then

  }
  if (Form7.iKey = VK_Down) and (not FbDuplicandoProd) then
  {Dailon Parisotto 2023-10-10 Fim}
  begin
    iKey := 0;
    Abort;
  end else
  begin
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select gen_id(G_CODIGO,1) from rdb$database');
    IBDataSet99.Open;
    sCodigo := StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),5,0);
    IBDataSet99.Close;
    //
    Form7.sModulo := 'XXXXXXXX';
    //
    sNomeAnterior := ''; //  usado quando se altera o nome do produto
    ibDataSet4CODIGO.ReadOnly       := False;
    ibDataSet4REGISTRO.AsString     := sProximo;
    ibDataSet4CODIGO.AsString       := sCodigo;
    ibDataSet4PRECO.AsFloat         := 0.01;
    ibDataSet4CUSTOCOMPR.AsFloat    := 0;
    ibDataSet4CUSTOMEDIO.AsFloat    := 0;
    ibDataSet4QTD_ATUAL.AsFloat     := 0;
    ibDataSet4QTD_MINIM.AsFloat     := 0;
    ibDataSet4QTD_INICIO.AsFloat    := 0;
    ibDataSet4PESO.AsFloat          := 0;
    ibDataSet4IPI.AsFloat           := 0;
    ibDataSet4IPPT.AsString         := 'T';
    ibDataSet4IAT.AsString          := 'T';
    ibDataSet4DAT_INICIO.AsDateTime := Date;

    ibDataSet4FATORC.AsFloat        := 1;
    ibDataSet4MEDIDA.AsString       := 'UND';
    ibDataSet4MEDIDAE.AsString      := 'UND';
    //
    ibDataSet4CODIGO.ReadOnly       := True;
    //
    ibDataSet4.Post;
    ibDataSet4.Edit;
    //
    AgendaCommit(True);
    //
    Form7.sModulo := 'ESTOQUE';
  end;
end;

procedure TForm7.Fluxodecaixa2Click(Sender: TObject);
begin
  Form27.ShowModal;
end;

procedure TForm7.ibDataSet7NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet7REGISTRO.AsString     := sProximo;
{
  //
  // Nosso Numero
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_NN,1) from rdb$database');
    ibDataset99.Open;
    ibDataSet7NN.AsString := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
}
  //
  if Form7.sModulo = 'VENDA' then
    ibDataSet7NUMERONF.AsString  := Form7.ibDataSet15NUMERONF.AsString;
  //
  ibDataSet7VALOR_RECE.AsFloat    := 0;
  ibDataSet7VALOR_DUPL.AsFloat    := 0;
  ibDataSet7VALOR_JURO.ReadOnly   := False;
  ibDataSet7VALOR_JURO.AsFloat    := 0;
  ibDataSet7VALOR_JURO.ReadOnly   := True;
  ibDataSet7EMISSAO.AsDateTime    := Date;
  //
  // Sugere sempre a data de vencimento de acordo com a configurao
  //
  ibDataSet7VENCIMENTO.AsDateTime := Date + StrtoInt('0'+Limpanumero(Form19.MaskEdit4.Text));
  ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
  //
end;

procedure TForm7.ibDataSet4QTD_ATUALChange(Sender: TField);
begin
  try
    if Form7.sModulo = 'ESTOQUE' then
    begin
      // Grade
      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;

      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
      begin
        // Grade - Alterao na ficha da mercadoria
        Form1.rReserva := 0;
        Form13.Label1.Caption := 'Alterao na ficha da mercadoria';
        Form13.ShowModal; // Alterao na ficha da mercadoria

        // alterado para no poder mais cancelar a alterao na quantidade clicando no cancelar
      end;

      if Form7.bFabrica then
      begin
        if not ibDataSet27.Active then
          ibDataSet27.Open;

        ibDataSet27.Append;
        ibDataSet27DATA.AsDateTime     := Date;
        ibDataSet27CODIGO.AsString     := ibDataSet4CODIGO.AsString;
        ibDataSet27DESCRICAO.AsString  := ibDataSet4DESCRICAO.AsString;
        ibDataSet27QUANTIDADE.AsFloat  := ibDataSet4QTD_ATUAL.AsFloat - fQuantidadeAnterior;
        ibDataSet27TIPO.AsString       := 'FABRIC';
        ibDataSet27MEDIDA.AsString     := ibDataset4MEDIDA.AsString;
        ibDataSet27VENDEDOR.AsString   := Senhas.Usuario.Text;
        ibDataSet27.Post;

        fQuantidadeAnterior := ibDataSet4QTD_ATUAL.AsFloat;
      end;
    end;
  except end;
end;

procedure TForm7.ibDataSet1BeforeDelete(DataSet: TDataSet);
begin
  if sModulo = 'CAIXA' then
    RegistraExclusaoRegistro(ibDataSet1);
end;

procedure TForm7.ibDataSet5BeforeDelete(DataSet: TDataSet);
begin
  if sModulo = 'BANCOS' then
    RegistraExclusaoRegistro(ibDataSet5);
end;

procedure TForm7.FormClose(Sender: TObject; var Action: TCloseAction);
var
  Mais1ini : tIniFile;
  CampoPK   : string;
begin
  try
    if sTitulo = 'Cadastro dos vendedores' then
      sModulo := 'VENDEDOR'; // No grava o Filtro registro coluna etc

    if (sModulo <> 'CONFIG') and (Alltrim(sModulo)<>'') and (Assigned(TabelaAberta)) and (TabelaAberta.Active) then
    begin
      //Mauricio Parizotto 2023-12-04
      try
        CampoPK := GetCampoPKDataSet(Form7.ArquivoAberto);
      except
        CampoPK := 'REGISTRO';
      end;


      Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');

      if sRPS = 'S' then //ver onde est setando para 'S'
      begin
        sModulo := 'RPS';
      end;

      if AllTrim(sWhere) = 'where' then
        sWhere := '';
      Mais1Ini.WriteString(sModulo,'FILTRO',AllTrim(sWhere));
      //Mais1Ini.WriteString(sModulo,'REGISTRO',TabelaAberta.FieldByName('REGISTRO').AsString); Mauricio Parizotto 2023-12-04
      Mais1Ini.WriteString(sModulo,'REGISTRO',TabelaAberta.FieldByName(CampoPK).AsString);
      Mais1Ini.WriteString(sModulo,'COLUNA',StrZero(DbGrid1.SelectedIndex,2,0));
      Mais1Ini.WriteString(sModulo,'LINHA',StrZero(TStringGrid(DBGrid1).Row,4,0));
      Mais1Ini.Free;

      if sModulo = 'RPS' then
      begin
        sModulo := 'VENDA';
      end;
    end;
  except
  end;

  try
    if Form9.Visible  then
      Form9.Close;
    if Form14.Visible then
      Form14.Close;
    if Form21.Visible then
      Form21.Close;
    if Form20.Visible then
      Form20.Close;
    if Form16.Visible then
      Form16.Close;
    if Form4.Visible  then
      Form4.Close;
  except
  end;

  try
    Form38.Caption := 'Cancelar';
    Form6.Tag := 36;

    if sModulo = 'COMPRA' then
    begin
      Form1.AvisoNFECompra(True);
    end;

    if sModulo = 'CAIXA' then
    begin
      Form1.AvisoCaixa(True);
    end;

    if sModulo = 'BANCOS' then
    begin
      Form1.AvisoBanco(True);
    end;

    if sModulo = 'ESTOQUE' then
    begin
      Form1.AvisoEstoque(True);
    end;

    if sModulo = 'PAGAR' then
    begin
      Form1.AvisoPagar(True);
    end;

    if sModulo = 'OS' then
    begin
      Form1.AvisoOS(True);
    end;

    if sModulo = 'RECEBER' then
    begin
      Form1.AvisoReceber(True);
    end;

    if sModulo = 'CLIENTES' then
    begin
      Form1.AvisoCliFor(True);
    end;

    Form1.AvisoIndicadores(True);
  except
  end;

  try
    //dbGrid1.DataSource := DataSource13; Mauricio Parizotto 2023-08-14  causa erro invalid transaction handle f-7258 
    dbGrid1.DataSource := nil;
    {Dailon Parisotto (f-7803) 2024-01-11 Inicio}
    DataSourceAtual    := nil;
    TabelaAberta       := nil;
    ArquivoAberto      := nil;
    sSelect   := EmptyStr;
    sWhere    := EmptyStr;
    sOrderBy  := EmptyStr;
    DBGrid1.Visible := False;
    DBGrid2.Visible := False;
    DBGrid3.Visible := False;
    DBGrid4.Visible := False;
    lblHomologacao.Visible := False;

    pnlFiltro.Visible := False;
    Panel2.Visible := False;
    Panel9.Visible := False;
    Panel10.Visible := False;

    DBGrid1.Refresh;
    Self.Repaint;
    {Dailon Parisotto (f-7803) 2024-01-11 Fim}
  except
    on E: Exception do
    begin

    end;
  end;
end;

procedure TForm7.RegistroFiscal1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\sintegra.exe') then
    ShellExecute( 0, 'Open', 'sintegra.exe', '', '', SW_SHOW)
  else
    //ShowMessage('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.',msgAtencao);
end;

procedure TForm7.Aumentodepreo1Click(Sender: TObject);
begin
  try
    Form34 := TForm34.Create(nil);
    Form34.ShowModal;
  finally
    FreeAndNil(Form34);
  end;
end;

procedure TForm7.ibDataSet2ESTADOSetText(Sender: TField; const Text: String);
begin
  if (Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0) and (AllTrim(Text)<>'') then
  begin
    //ShowMessage('Estado invlido'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Estado invlido',msgAtencao);
    ibDataSet2ESTADO.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end
  else
    ibDataSet2ESTADO.AsString := UpperCase(Text);
end;


procedure TForm7.ibDataSet13ESTADOSetText(Sender: TField; const Text: String);
begin
  if (Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0) and (AllTrim(Text)<>'') then
  begin
    //ShowMessage('Estado invlido'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Estado invlido',msgAtencao);
    Form7.ibDataSet13ESTADO.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end
  else
    Form7.ibDataSet13ESTADO.AsString := UpperCase(Text);
end;

procedure TForm7.ibDataSet15VOLUMESChange(Sender: TField);
begin
  ibDataSet15.Edit;

  if ibDataSet15VOLUMES.AsFloat = 0 then
  begin
    ibDataSet15ESPECIE.AsString := '';
    ibDataSet15MARCA.AsString   := '';
  end;

  if ibDataSet15VOLUMES.AsFloat = 1 then
  begin
    if ibDataSet15ESPECIE.AsString = '' then
      ibDataSet15ESPECIE.AsString := 'CAIXA';
    if ibDataSet15MARCA.AsString   = '' then
      ibDataSet15MARCA.AsString   := 'VARIAS';
  end;
  
  if ibDataSet15VOLUMES.AsFloat > 1 then
  begin
    if ibDataSet15ESPECIE.AsString = '' then
      ibDataSet15ESPECIE.AsString := 'CAIXAS';
    if ibDataSet15MARCA.AsString   = '' then
      ibDataSet15MARCA.AsString   := 'VARIAS';
  end;
end;

procedure TForm7.ibDataSet12BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo CAIXA                      }
  sNumeroAnterior := ibDataSet12REGISTRO.AsString;
  sNomeAnterior   := ibDataSet12NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet12AfterPost(DataSet: TDataSet);
var
  sNomeNovo : String;
  sNomeVolta : String;
begin
  //
  // PLANO DE CONTAS
  //
  if (sNomeAnterior <> ibDataSet12NOME.AsString) and (sNomeAnterior <> '') and (sNumeroAnterior = ibDataSet12REGISTRO.AsString) then
  begin
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    sNomeNovo  := ibDataSet12NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // CAIXA
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update CAIXA set NOME='+QuotedStr(sNomeNovo)+' where NOME='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    // PAGAR
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update PAGAR set CONTA='+QuotedStr(sNomeNovo)+' where CONTA='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    // RECEBER
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update RECEBER set CONTA='+QuotedStr(sNomeNovo)+' where CONTA='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;
    //
    // ICM
    //
    Form7.ibQueryCoringa.Close;
    Form7.ibQueryCoringa.SQL.Clear;
    Form7.ibQueryCoringa.SQL.Add('update ICM set CONTA='+QuotedStr(sNomeNovo)+' where CONTA='+QuotedStr(sNomeVolta)+'');
    Form7.ibQueryCoringa.ExecSQL;

    Screen.Cursor := crDefault;
  end;
  
  AgendaCommit(True);
end;

procedure TForm7.Relatriodecomisses1Click(Sender: TObject);
begin
  Form37.Caption := 'Relatrio de comisses';
  if AllTrim(Form7.ibDataSet9NOME.AsString) = '' then
  begin
    //ShowMessage('Nome do vendedor invlido.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Nome do vendedor invlido.');
    Abort;
  end
  else
    Form37.ShowModal;
end;

procedure TForm7.Resumodasvendas1Click(Sender: TObject);
var
  oIni : tIniFile;
begin
  Form7.ibDataSet99.Close;
  Form7.ibDataSet99.SelectSql.Clear;
  Form7.ibDataSet100.Close;
  Form7.ibDataSet100.SelectSql.Clear;
  CriaJpg('logotip.jpg');
  frmRelResumoVendas := TfrmRelResumoVendas.Create(nil);
  try
    frmRelResumoVendas.DataBase           := IBDatabase1;
    frmRelResumoVendas.Imagem             := imgImprimir.Picture;
    frmRelResumoVendas.Usuario            := Usuario;
    frmRelResumoVendas.DataSetEstoque     := ibDataSet4;
    frmRelResumoVendas.CasasDecimaisPreco := StrToIntDef(Form1.ConfPreco,2);
    frmRelResumoVendas.CasasDecimaisQtde  := StrToIntDef(Form1.ConfCasas,2);
    if sModulo = 'ESTOQUE' then
    begin
      frmRelResumoVendas.WhereEstoque     := sWhere;
      frmRelResumoVendas.OrderBy          := sOrderBy;
    end
    else
    begin
      // Se no for estoque ento pega do INI o WHERE do ESTOQUE
      // para atualizar os valores igual na rotina ESTOQUE
      oIni := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
      try
        frmRelResumoVendas.WhereEstoque     := oIni.ReadString('ESTOQUE','FILTRO',EmptyStr);
        frmRelResumoVendas.OrderBy          := EmptyStr;
      finally
        FreeAndNil(oIni);
      end;
    end;
    frmRelResumoVendas.SqlTraduzido       := TraduzSql('Listando ' + frmRelResumoVendas.WhereEstoque + ' e ordenado por lucro bruto',True, ibDataSet4);
    frmRelResumoVendas.ShowModal;
  finally
    AgendaCommit(True);
    FreeAndNil(frmRelResumoVendas);
  end;
end;

procedure TForm7.Histrico1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Histrico';
  Form38.ShowModal;
  sModulo := sModuloAnterior;
  if Form38.Caption <> 'Cancelar' then
    Form10.Image203Click(Sender);
  Form7.ArquivoAberto.EnableControls;
  //
end;

procedure TForm7.ibDataSet7AfterPost(DataSet: TDataSet);
begin
  begin
    if form7.SModulo = 'RECEBER' then
      if (Alltrim(ibDataSet7DOCUMENTO.AsString) = '') and (ibDataSet7VALOR_DUPL.AsFloat <> 0) then
        //ShowMessage('O nmero da duplicata deve ser preenchido.'); Mauricio Parizotto 2023-10-25
        MensagemSistema('O nmero da duplicata deve ser preenchido.');
  end;

  AgendaCommit(True);

  Form1.ibQuery2.Close;
  Form1.ibQuery2.SQL.Clear;
  Form1.ibQuery2.SQL.Add('set generator G_GRAFICO_RECEBER to 0');
  Form1.ibQuery2.ExecSQL;
end;


procedure TForm7.ibDataSet7VALOR_RECEChange(Sender: TField);
begin
  if ibDataSet7VALOR_RECE.AsFloat < 0 then
    ibDataSet7VALOR_RECE.AsFloat := 0;
end;

procedure TForm7.ibDataSet4REFERENCIASetText(Sender: TField;
  const Text: String);
var
  cTexto: String;
begin
  cTexto := AllTrim(Text);

  if Alltrim(cTexto) = '' then ibDataSet4REFERENCIA.AsString := '' else
  begin
    if Valida_Campo('ESTOQUE',cTexto,'REFERENCIA','Esta referncia j foi cadastrada') then
        ibDataSet4REFERENCIA.AsString := cTexto;
  end;
end;

procedure TForm7.ibDataSet12NewRecord(DataSet: TDataSet);
begin
  ibDataSet12REGISTRO.AsString := sProximo;
  sNomeAnterior := '';
end;

procedure TForm7.ibDataSet3NewRecord(DataSet: TDataSet);
var
  sNumero : String;
  cGenerator: String;
  qryAux: TIBQuery;
  ConfSistema : TArquivosDAT;
begin
  {
  Dailon Parisotto (f-5604) 2024-01-31 Inicio
  Enquanto o sNumero for em branco (Novo ou quando ja existe com o numero gerado) fica tentando gerar novo numero
  }
  while (sNumero = EmptyStr) do
  begin
    IBDataSet99.Close;
    qryAux := CriaIBQuery(Form7.IBTransaction1);
    try
      IBDataSet99.SelectSQL.Clear;
      IBDataSet99.SelectSQL.Add('select gen_id(G_NUMEROOS,1) from rdb$database');
      IBDataSet99.Open;
      cGenerator := StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0);

      qryAux.Close;
      qryAux.SQL.Add('SELECT');
      qryAux.SQL.Add('  COUNT(REGISTRO) AS QTDE');
      qryAux.SQL.Add('FROM OS');
      qryAux.SQL.Add('WHERE');
      qryAux.SQL.Add('(NUMERO=:XNUMERO)');
      qryAux.ParamByName('XNUMERO').AsString := cGenerator;
      qryAux.Open;

      if qryAux.FieldByName('QTDE').AsInteger <= 0 then
        sNumero := cGenerator;
    finally
      FreeAndNil(qryAux);
      IBDataSet99.Close;
    end;
  end;
  {Dailon Parisotto (f-5604) 2024-01-31 Fim}

  {Mauricio Parizotto 2023-11-21 Inicio
  try
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select OBSERVACAO from OS where NUMERO='+QuotedStr(StrZero( StrtoFloat(AllTrim( sNumero ))-1,10,0))+' ');
    IBDataSet99.Open;
  except end;
  }

  ibDataSet3REGISTRO.AsString   := sProximo;
  ibDataSet3IDOS.AsInteger      := sProximoID; //Mauricio Parizotto 2023-11-29
  ibDataSet3NUMERO.AsString     := sNumero;
  ibDataSet3DATA.AsDateTime     := Date;
  //ibDataSet3HORA.AsString       := TimeToStr(Time); Mauricio Parizotto 2024-01-03
  ibDataSet3HORA.AsString       := Copy(TimeToStr(Time),1,5);
  ibDataSet3TEMPO.AsString      := '00:45';
  ibDataSet3SITUACAO.AsString   := 'Agendada';
  {
  try
    ibDataSet3OBSERVACAO.AsString := IBDataSet99.FieldByname('OBSERVACAO').AsString;
  except end;

  IBDataSet99.Close;
  }

  try
    ConfSistema := TArquivosDAT.Create(Usuario,ibDataSet3.Transaction);
    ibDataSet3OBSERVACAO.AsString := ConfSistema.BD.OS.ObservacaoOS;
  finally
    FreeAndNil(ConfSistema);
  end;
  {Mauricio Parizotto 2023-11-21 Fim}

  ibDataSet2.Append;
end;

procedure TForm7.Caixa1Click(Sender: TObject);
var
  dData : TDateTime;
  F: TextFile;
  fTotal, fTotal1, fTotal2 : Real;
  nSaldoAnt: Real;
begin
  fTotal := 0;
  Screen.Cursor := crHourGlass;
  //
  dData := ibDataSet1DATA.AsDateTime;
  Form16.Button3.Click; // Limpa os filtros //
  ibDataSet1.Locate('DATA',dData,[]);
  //ibDataSet1.MoveBy(-1);
  //
  nSaldoAnt := Form7.ibDataSet1SALDO.AsFloat;

  if Form7.ibDataSet1ENTRADA.AsFloat > 0 then
    nSaldoAnt := nSaldoAnt - Form7.ibDataSet1ENTRADA.AsFloat;
  if Form7.ibDataSet1SAIDA.AsFloat > 0 then
    nSaldoAnt := nSaldoAnt + Form7.ibDataSet1SAIDA.AsFloat;

  if Form1.bHtml1 then
  begin
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    Writeln(F,'<html><head><title>'+AllTrim(Form7.ibDataSet13NOME.AsString) + ' - '+Form7.sModulo+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font><p></center>');
    Writeln(F,'<br><font face="Microsoft Sans Serif" size=2><b><center>CAIXA DO DIA '+DateTimeToStr(dData)+'</b><br><br>');
    WriteLn(F,'<table  border=1   style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
    WriteLn(F,' <tr>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Histrico</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Entrada</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Sada</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Saldo</td>');
    WriteLn(F,' </tr>');
    //
    WriteLn(F,' <tr>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Saldo anterior</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1></td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1></td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[nSaldoAnt])+'</td>');
    WriteLn(F,' </tr>');
    //
  end else
  begin
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.txt'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    Writeln(F,'');
    Writeln(F,'');
    Writeln(F,'');
    Writeln(F,UpperCase(ibDataSet13NOME.AsString));
    Writeln(F,'CNPJ.: '+ ibDataSet13CGC.AsString + ' IE.: ' + ibDataSet13IE.AsSTring);
    Writeln(F,'');
    Writeln(F,'CAIXA DO DIA '+DateTimeToStr(dData));
    Writeln(F,'');
    Writeln(F,'                                         Saldo anterior.: '+
                                           Format('%12.2n',[nSaldoAnt]));
    Writeln(F,'');
    Writeln(F,'Histrico                                    Entrada      Sada       ');
    Writeln(F,'-------------------------------------------- ------------ ------------');
    //
  end;
  //
  fTotal1 := 0;
  fTotal2 := 0;

  {Dailon Parisotto (f-184) 2024-03-04 Inicio

  if not ibDataSet1.BOF then
    ibDataSet1.MoveBy(1);

  Dailon Parisotto (f-184) 2024-03-04 Fim}
  while not Form7.ibDataSet1.EOF and (dData = ibDataSet1DATA.AsDateTime) do
  begin
    //
    if ibDataSet1DATA.AsDateTime = dData then
    begin
      //
      if Form1.bHtml1 then
      begin
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+AllTrim(Form7.ibDataSet1HISTORICO.AsString)+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1ENTRADA.AsFloat])+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1SAIDA.AsFloat])+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[Form7.ibDataSet1SALDO.AsFloat])+'</td>');
        WriteLn(F,' </tr>');
      end else
      begin
        //
        Writeln(F,
                  Copy(AllTrim(Form7.ibDataSet1HISTORICO.AsString)+replicate(' ',44),1,44) + ' ' +
                  Format('%12.2n',[Form7.ibDataSet1ENTRADA.AsFloat]) + ' ' +
                  Format('%12.2n',[Form7.ibDataSet1SAIDA.AsFloat]));
      end;
      //
      fTotal  := Form7.ibDataSet1SALDO.AsFloat;
      fTotal1 := fTotal1 + Form7.ibDataSet1SAIDA.AsFloat;
      fTotal2 := ftotal2 + Form7.ibDataSet1ENTRADA.AsFloat;
      //
    end;
    //
    Form7.ibDataSet1.Next;
    //
  end;
  //
  if Form1.bHtml1 then
  begin
    //
    WriteLn(F,' <tr>');
    Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1></td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal2])+'</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal1])+'</td>');
    Writeln(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal2-ftotal1])+'</td>');
    WriteLn(F,' </tr>');
    //
    Writeln(F,'</table>');
    //
    WriteLn(F,'<center><br><font face="Microsoft Sans Serif" size=1></b>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
    + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
    + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br></center>');
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  end else
  begin
    //
    Writeln(F,'-------------------------------------------- ------------ ------------');
    Writeln(F,'                                             '+
                                           Format('%12.2n',[fTotal2]) + ' ' +
                                           Format('%12.2n',[fTotal1]));
    Writeln(F,'');
    Writeln(F,'                                            Saldo final.: '+
                                           Format('%12.2n',[fTotal]));

    Writeln(F,'');
    Writeln(F,'                                         (Entrada-Sada): '+
                                           Format('%12.2n',[fTotal2-Ftotal1]));
    //
    CloseFile(F);
    ShellExecute( 0, 'Open',pChar(Senhas.UsuarioPub+'.TXT'),'','', SW_SHOWMAXIMIZED);
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor normal
  //
end;

procedure TForm7.FormKeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if Key = VK_F1 then
    HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
  if Form7.sModulo <> 'RETRIBUTA' then
    Form7.ibDataSet16.EnableControls;
  {Sandro Silva 2022-10-18 inicio}
  if Sender.ClassType = TDBGrid then
  begin
    Key := Form1.BloqueiaCtrlXTField(Sender, Key, Shift);
  end;
  {Sandro Silva 2022-10-19 final}  
end;

procedure TForm7.ibDataSet1NOMEChange(Sender: TField);
begin
//  if Form10.Button7.Visible then Form10.Button7.Enabled := True;
//  if (ibDataSet1ENTRADA.AsFloat + ibDataSet1SAIDA.AsFloat) <> 0 then IntegraBanco(Sender);
end;

procedure TForm7.MenuItem34Click(Sender: TObject);
var
  I : Integer;
  NewItem: TMenuItem;
  bI : Boolean;
begin
  //
  if not bSoLeitura then
  begin
    Contasbancrias1.Enabled := True;
    Mostrartodososlanamentos1.Enabled := True;
  end else
  begin
    Contasbancrias1.Enabled := False;
    Mostrartodososlanamentos1.Enabled := False;
  end;
  //
  ibDataSet11.First;
  while not ibDataSet11.eof do
  begin
    bI := True;
    for I := 0 to Menuitem34.Count -1 do
    begin
      if Menuitem34.Items[I].Caption = ibDataSet11Nome.Value then
        bI := False;
    end;
    if bI then
    begin
      if AllTrim(ibDataSet11Nome.AsString) <> '' then
      begin
        NewItem := TMenuItem.Create(MenuItem34);
        NewItem.Caption := ibDataSet11Nome.Value;
        MenuItem34.Add(NewItem);
        NewItem.OnClick := Form1.EscolheOBanco;
      end;
    end;
    ibDataSet11.Next;
  end;
  
  for I := 0 to (MenuItem34.Count-1) do
  begin
    if I > 7 then
    begin
      if MenuiTem34.Items[I].Caption = Form1.sEscolhido then
        MenuiTem34.Items[I].Checked := True
      else
        MenuiTem34.Items[I].Checked := False;
    end;
  end;
end;

procedure TForm7.ibDataSet7VALOR_DUPLChange(Sender: TField);
var
  I: Integer;
  fJuro: Real;
begin
  //
  try
    //
    ibDataSet7VALOR_JURO.ReadOnly := False;
    //
    if ibDataSet7VALOR_RECE.AsFloat = 0 then
    begin
      if ( Date - ibDataSet7VENCIMENTO.AsDateTime ) > 0 then
      begin
        if Form19.rbJurosSimples.Checked then
        begin
          if ibDataSet7VALOR_JURO.AsFloat <> ibDataSet7VALOR_DUPL.AsFloat * (((( Date - ibDataSet7VENCIMENTO.AsDateTime )) * Form1.ftaxa / 100) + 1) then
          begin
            ibDataSet7VALOR_JURO.AsFloat := ibDataSet7VALOR_DUPL.AsFloat * (((( Date - ibDataSet7VENCIMENTO.AsDateTime )) * Form1.ftaxa / 100) + 1)
          end;
        end else
        begin
          fJuro := ibDataSet7VALOR_DUPL.AsFloat;
          for I := 1 to Trunc(Date - ibDataSet7VENCIMENTO.AsDateTime) do
            fJuro  := fJuro * ((Form1.fTaxa / 100) + 1);

          if fJuro <> ibDataSet7VALOR_DUPL.AsFloat then
            ibDataSet7VALOR_JURO.AsFloat := fJuro;
        end;
      end else
      begin
        if ibDataSet7VALOR_JURO.AsFloat <> ibDataSet7VALOR_DUPL.AsFloat then
          ibDataSet7VALOR_JURO.AsFloat := ibDataSet7VALOR_DUPL.AsFloat;
      end;
    end else
    begin
      if ibDataSet7VALOR_JURO.AsFloat <> ibDataSet7VALOR_DUPL.AsFloat then
        ibDataSet7VALOR_JURO.AsFloat := ibDataSet7VALOR_DUPL.AsFloat;
    end;
    //
    ibDataSet7VALOR_JURO.ReadOnly := True;
    if ibDataSet7VALOR_DUPL.AsFloat < 0 then
      ibDataSet7VALOR_DUPL.AsFloat := 0;
  except
  end;
  //
  try
    if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
    begin
      Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString + '(000)', 1, 11) + 'VENCIMENTO';
    end;
  except
  end;
  //
end;

procedure TForm7.PopupMenu1Popup(Sender: TObject);
var
  cEmails, cTransp: string;
begin
  Ativo1.Visible := False;
  Receberestaconta1.Visible := False;
  Pagarestaconta1.Visible   := False;
  Imprimirrecibo3.Visible   := False;
  Baixaestacontanobanco1.Visible := False;
  //
  // NF-e
  //
  N1EnviarNFe1.Caption                        := '1 - Enviar NF-e';
  N6VisualizarDANFE1.Caption                  := '6 - Visualizar DANFE'; // Sandro Silva 2023-02-14
  N6EnviarNFeConsultareImprimirDANFE1.Caption := '8 - Enviar NF-e, Consultar e Imprimir DANFE';
  ransmitirNotaFiscaldeServioNFSe1.Caption    := 'Transmitir Nota Fiscal de Servio (NFS-e)';
  PrvisualizarDANFE1.Visible                       := False;
  CancelarNFSe1.Visible                            := False;
  EnviarNFSeporemail1.Visible                      := False;
  EnviarOrcamentoPorEmail1.Visible                 := False;
  Visu1.Visible                                    := False;
  ransmitirNotaFiscaldeServioNFSe1.Visible         := False;
  LimparRetornosda1.Visible                        := False;
  ConsultarNFSe1.Visible                           := False;
  N0TestarservidorNFe1.Visible                     := False;
  N1enviarNFe1.Visible                             := False;
  N2ConsultarrecibodaNFe1.Visible                  := False;
  N3ConsultarNFe1.Visible                          := False;
  N4ImprimirDANFE1.Visible                         := False;
  N70.Visible                                      := False; 
  ExportarXML1.Visible                             := False;
  N5EnviarDANFEporemail1.Visible                   := False;
  N6VisualizarDANFE1.Visible                       := False;
  CancelarNFe1.Visible                             := False;
  CartadeCorreoEletrnicaCCe1.Visible               := False;
  CCartadeCorreoEletronicaCCe1.Visible             := False;
  IImprimirCartadeCorreoEletronicaCCe1.Visible     := False;
  EEnviarcartadecorreoporemail1.Visible            := False; // Sandro Silva 2023-06-05 Faltou no card 6107
  N6EnviarNFeConsultareImprimirDANFE1.Visible      := False;
  N9ImprimirDANFEemformulriodecontingncia1.Visible := False;
  VVerificaresquemashema1.Visible                  := False;
  RRecuperaroXMLdestaNFe1.Visible                  := False;
  Manifestaododestinatrio1.Visible                 := False;
  ManifestaododestinatrioDesc1.Visible             := False;
  Manifestaaododestinatrio1.Visible                := False;
  VisualizarXMLdamanifestaododestinatrio1.Visible  := False;
  N66.Visible                                      := False;
  DuplicatestaNFe1.Visible                         := False;
  DuplicarProduto.Visible                          := False;
  DuplicaOrcamento.Visible                         := False;
  ImprimirOrcamento.Visible                        := False;
  ImprimirOrdemdeServio2.Visible                   := False; // Mauricio Parizotto 2023-11-21
  //
  Editar1.Visible := True;
  Apagar2.Visible := True;
  //
  Editar1.Enabled := True;
  Apagar2.Enabled := True;
  //
  if Form7.bSoLeitura then
  begin
    Editar1.Enabled           := False;
    Apagar2.Enabled           := False;
    Ativo1.Enabled            := False;
    Pagarestaconta1.Enabled   := False;
    Receberestaconta1.Enabled := False;
    Baixaestacontanobanco1.Visible := False;
  end else
  begin
    Editar1.Enabled           := True;
    Apagar2.Enabled           := True;
    Ativo1.Enabled            := True;
    Pagarestaconta1.Enabled   := True;
    Receberestaconta1.Enabled := True;
    //
    if sModulo = 'RECEBER'  then
    begin
      Imprimirrecibo3.Visible := True;
      if ibDataSet7VALOR_RECE.AsFloat = 0 then
        Receberestaconta1.Enabled := True
      else
        Receberestaconta1.Enabled := False;
      if ibDataSet7VALOR_RECE.AsFloat <> 0 then
        Imprimirrecibo3.Enabled := True
      else
        Imprimirrecibo3.Enabled := False;
      Baixaestacontanobanco1.Visible  := True;
      //
      if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
      begin
        Baixaestacontanobanco1.Enabled := True;
      end else
      begin
        Baixaestacontanobanco1.Enabled := False;
      end;
      //
    end;
    //
    if sModulo = 'PAGAR'  then
    begin
      if ibDataSet8VALOR_PAGO.AsFloat = 0 then
        Pagarestaconta1.Enabled := True
      else
        Pagarestaconta1.Enabled := False;
    end;
    {Sandro Silva 2023-07-03 inicio
    if sModulo = 'ICM' then
      Abort;
    }
    if sModulo = 'CLIENTES' then
    begin
      if ibDataSet2ATIVO.AsString='1' then
        Ativo1.Checked := False
      else
        Ativo1.Checked := True;
      Ativo1.Visible := True;
    end;
    if sModulo = 'RECEBER' then
    begin
      if ibDataSet7ATIVO.AsString='1' then
        Ativo1.Checked := False
      else
        Ativo1.Checked := True;
      if ibDataSet7ATIVO.AsString='1' then
        Ativo5.Checked := False
      else
        Ativo5.Checked := True;
      Ativo1.Visible := True;
    end;
    if sModulo = 'ESTOQUE'  then
    begin
      DuplicarProduto.Visible := True;
      if ibDataSet4ATIVO.AsString='1' then
        Ativo1.Checked := False
      else
        Ativo1.Checked := True;
      Ativo1.Visible := True;
    end;
    //
    if sModulo = 'ORCAMENTO'  then
    begin
      Editar1.Visible := False;
      Apagar2.Visible := True;

      EnviarOrcamentoPorEmail1.Visible := True;
      DuplicaOrcamento.Visible         := True;
      ImprimirOrcamento.Visible        := True;

      cEmails := TRetornaCaptionEmailPopUpDocs.New
                                              .SetDataBase(IBDatabase1)
                                              .setCodigoClifor(Form7.ibDataSet97.FieldByname('Cliente').AsString)
                                              .Retornar;

      EnviarOrcamentoPorEmail1.Enabled := (cEmails <> EmptyStr);
      EnviarOrcamentoPorEmail1.Caption := 'Enviar oramento por e-mail ' + cEmails;
    end;
    
    if sModulo = 'OS'  then
    begin
      //Mauricio Parizotto 2023-12-26
      //Apagar2.Enabled := False;
      //Apagar2.Visible := False;
      Apagar2.Enabled := True;
      Apagar2.Visible := True;
      ImprimirOrdemdeServio2.Visible := True; // Mauricio Parizotto 2023-11-21
    end;

    if sModulo = 'COMPRA'  then
    begin
      N6VisualizarDANFE1.Caption := 'Visualizar DANFE'; // Sandro Silva 2023-02-14
      N6VisualizarDANFE1.Visible                       := True; // Sandro Silva 2023-02-14
      Manifestaododestinatrio1.Visible                 := True;
      VisualizarXMLdamanifestaododestinatrio1.Visible  := True;
      ManifestaododestinatrioDesc1.Visible             := True;
      Manifestaaododestinatrio1.Visible                := True;
    end;

    if sModulo = 'VENDA'  then
    begin
      // NF-e
      Apagar2.Visible                                  := False;

      if Form7.sRPS <> 'S' then
      begin
        N0TestarservidorNFe1.Visible                     := True;
        N1enviarNFe1.Visible                             := True;
        N2ConsultarrecibodaNFe1.Visible                  := True;
        N3ConsultarNFe1.Visible                          := True;
        N4ImprimirDANFE1.Visible                         := True;
        N5EnviarDANFEporemail1.Visible                   := True;
        N6VisualizarDANFE1.Visible                       := True;
        CancelarNFe1.Visible                             := True;
        CartadeCorreoEletrnicaCCe1.Visible               := True;
        CCartadeCorreoEletronicaCCe1.Visible             := True;
        IImprimirCartadeCorreoEletronicaCCe1.Visible     := True;
        EEnviarcartadecorreoporemail1.Visible            := True; // Sandro Silva 2023-06-05 Faltou no card 6107
        N6EnviarNFeConsultareImprimirDANFE1.Visible      := True;
        N9ImprimirDANFEemformulriodecontingncia1.Visible := True;
        VVerificaresquemashema1.Visible                  := True;
        RRecuperaroXMLdestaNFe1.Visible                  := True;
        N66.Visible                                      := True;
        DuplicatestaNFe1.Visible                         := True;
        ExportarXML1.Visible                             := True;
        N70.Visible                                      := True;
        //
      end else
      begin
        CancelarNFSe1.Visible                            := True;
        EnviarNFSeporemail1.Visible                      := True;
        Visu1.Visible                                    := True;
        ransmitirNotaFiscaldeServioNFSe1.Visible         := True;
        ConsultarNFSe1.Visible                           := True;
        LimparRetornosda1.Visible                        := True;
        LimparRetornosda1.Enabled                        := (Pos(' NAO AUTORIZADA',Form7.ibDataSet15STATUS.AsString) <> 0);
      end;
      //
      {Sandro Silva 2022-09-28 inicio
      if Pos('Falha no Schema',Form7.ibDataSet15STATUS.AsString)<> 0 then
      begin
        VVerificaresquemashema1.Enabled  := True;
      end else
      begin
        VVerificaresquemashema1.Enabled  := False;
      end;
      }
      VVerificaresquemashema1.Enabled := PermiteValidarSchema(Form7.ibDataSet15); // Ficha 6275 Sempre que estiver preenchido o campo NFEXML pode verificar o schema
      {Sandro Silva 2022-09-28 fim}
      //
      if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
      begin
        N2ConsultarrecibodaNFe1.Enabled  := True;
        N3ConsultarNFe1.Enabled          := True;
        RRecuperaroXMLdestaNFe1.Enabled  := True;
      end else
      begin
        N2ConsultarrecibodaNFe1.Enabled  := False;
        N3ConsultarNFe1.Enabled          := False;
        RRecuperaroXMLdestaNFe1.Enabled  := False;
      end;

      if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
      begin
        N4ImprimirDANFE1.Enabled    := True;
        N6VisualizarDANFE1.Enabled  := True;

        N1enviarNFe1.Enabled                 := False;
        if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) <> 0) or (Form7.ibDataSet15EMITIDA.AsString = 'X') then
          N4ImprimirDANFE1.Enabled := True
        else
          N4ImprimirDANFE1.Enabled := False;

        //Mauricio Parizotto 2023-07-04
        if AnsiContainsText(UpperCase(Form7.ibDataSet15STATUS.AsString),'DENEGAD')  then
        begin
          N4ImprimirDANFE1.Enabled    := False;
          N6VisualizarDANFE1.Enabled  := False;
        end;

        ExportarXML1.Enabled := N4ImprimirDANFE1.Enabled;
         
        N5EnviarDANFEporemail1.Enabled       := True;
        CancelarNFe1.Enabled                 := True;
        CCartadeCorreoEletronicaCCe1.Enabled := True;
        IImprimirCartadeCorreoEletronicaCCe1.Enabled := Trim(Form7.ibDataSet15CCEXML.AsString) <> EmptyStr; // Sandro Silva 2023-06-05 Deve ficar enable se for venda com NF-e
        EEnviarcartadecorreoporemail1.Enabled        := Trim(Form7.ibDataSet15CCEXML.AsString) <> EmptyStr; // Sandro Silva 2023-06-05 Deve ficar enable se for venda com NF-e
        //
        N9ImprimirDANFEemformulriodecontingncia1.Enabled            := False;
      end else
      begin
        N1enviarNFe1.Enabled             := True;
        N4ImprimirDANFE1.Enabled         := False;
        ExportarXML1.Enabled             := False;
        N5EnviarDANFEporemail1.Enabled   := False;
//        if Alltrim(Form7.ibDataSet15NFERECIBO.AsString) = '' then N2ConsultarrecibodaNFe1.Enabled := False else N2ConsultarrecibodaNFe1.Enabled := True;
//        if Alltrim(Form7.ibDataSet15NFERECIBO.AsString) = '' then N3ConsultarNFe1.Enabled := False else N3ConsultarNFe1.Enabled := True;
        CancelarNFe1.Enabled                 := False;
        CCartadeCorreoEletronicaCCe1.Enabled := False;
        IImprimirCartadeCorreoEletronicaCCe1.Enabled := False; // Sandro Silva 2023-06-05 Deve ficar enable se for venda com NF-e
        EEnviarcartadecorreoporemail1.Enabled        := False; // Sandro Silva 2023-06-05 Deve ficar enable se for venda com NF-e

        //
        N9ImprimirDANFEemformulriodecontingncia1.Enabled            := True;
        //
      end;

      // Manter consulta devido a outros lugares utilizar ibDataSet2 para pegar o e-mail (NFSe por exemplo)
      Form7.ibDataSet2.Close;
      Form7.ibDataSet2.Selectsql.Clear;
      Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
      Form7.ibDataSet2.Open;

      {Sandro Silva 2023-06-05 inicio
      IImprimirCartadeCorreoEletronicaCCe1.Enabled := Alltrim(Form7.ibDataSet15CCEXML.AsString) <> EmptyStr;
      EEnviarcartadecorreoporemail1.Enabled        := Alltrim(Form7.ibDataSet15CCEXML.AsString) <> EmptyStr;
      }

      cTransp := Form7.ibDataSet15TRANSPORTA.AsString;
      if EnviarNFSeporemail1.Visible then // Se for Servio no tem transportador
        cTransp := EmptyStr;

      cEmails := TRetornaCaptionEmailPopUpDocs.New
                                              .SetDataBase(IBDatabase1)
                                              .setCodigoClifor(Form7.ibDataSet15CLIENTE.AsString)
                                              .setCodigoTranspor(cTransp)
                                              .Retornar;

      if N5EnviarDANFEporemail1.Visible then
      begin
        N5EnviarDANFEporemail1.Enabled := (cEmails <> EmptyStr);
        N5EnviarDANFEporemail1.Caption := '5 - Enviar o XML e DANFE por e-mail ' + cEmails;
      end else
      begin
        EnviarNFSeporemail1.Enabled := (cEmails <> EmptyStr);
        EnviarNFSeporemail1.Caption := 'Enviar NFS-e por e-mail ' + cEmails;
      end;

      EEnviarcartadecorreoporemail1.Caption := 'Enviar Carta por e-mail';
      if EEnviarcartadecorreoporemail1.Enabled then
        EEnviarcartadecorreoporemail1.Caption := EEnviarcartadecorreoporemail1.Caption + ' ' + cEmails;

      //
      if Form7.ibDataSet15EMITIDA.AsString = 'X' then
      begin
        N1enviarNFe1.Enabled                             := False;
        N2ConsultarrecibodaNFe1.Enabled                  := False;
        N3ConsultarNFe1.Enabled                          := False;
        N5EnviarDANFEporemail1.Enabled                   := False;
        CancelarNFe1.Enabled                             := False;
        CCartadeCorreoEletronicaCCe1.Enabled             := False;
        IImprimirCartadeCorreoEletronicaCCe1.Enabled     := False;
        N6EnviarNFeConsultareImprimirDANFE1.Enabled      := False;
        N9ImprimirDANFEemformulriodecontingncia1.Enabled := False;
      end;
      //
    end;
    //
  end;
  //
  {Sandro Silva 2022-09-12 inicio}
  // Ficha 4128/6230
  PrvisualizarDANFE1.Visible := CancelarNFe1.Visible;
  PrvisualizarDANFE1.Enabled := ((Trim(Form7.ibDataSet15.FieldByName('NFEPROTOCOLO').AsString) = '') and (Form7.ibDataSet15.FieldByName('MODELO').AsString = '55'));
  {Sandro Silva 2022-09-12 fim}

  DefinirCaptionHomologacaoPopUpMenuDocs;
end;

procedure TForm7.DefinirCaptionHomologacaoPopUpMenuDocs;
const
  _cHomologacao = ' (HOMOLOGAO)';
begin
  if TestarNFeHomologacao then
  begin
    if (N1EnviarNFe1.Visible) then
      N1EnviarNFe1.Caption := N1EnviarNFe1.Caption + _cHomologacao;
    if (N6EnviarNFeConsultareImprimirDANFE1.Visible) then
      N6EnviarNFeConsultareImprimirDANFE1.Caption := N6EnviarNFeConsultareImprimirDANFE1.Caption + _cHomologacao;
  end;
  if TestarNFSeHomologacao then
  begin
    if ransmitirNotaFiscaldeServioNFSe1.Visible then
      ransmitirNotaFiscaldeServioNFSe1.Caption := ransmitirNotaFiscaldeServioNFSe1.Caption + _cHomologacao;
  end;
end;

procedure TForm7.Ativo1Click(Sender: TObject);
begin
  //
  try
    if sModulo = 'RECEBER' then
    begin
      ibDataSet7.Edit;
      if ibDataSet7ATIVO.AsString = '1' then
      begin
        Ativo1.Checked := False;
        Ativo2.Checked := False;
//        Ativo5.Checked := False;
        ibDataSet7ATIVO.AsString := '0';
        //
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub, 'ATIVOU DOCUMENTO '+ibDataSet7DOCUMENTO.AsString,(ibDataSet7VALOR_DUPL.AsFloat),0);   // Ato, Modulo, Usurio, Histrico
        //
      end else
      begin
        Ativo1.Checked := True;
        Ativo2.Checked := True;
//        Ativo5.Checked := True;
        ibDataSet7ATIVO.AsString := '1';
        //
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub,'INATIVOU DOCUMENTO '+ibDataSet7DOCUMENTO.AsString,(ibDataSet7VALOR_DUPL.AsFloat),0);   // Ato, Modulo, Usurio, Histrico
        //
      end;
      ibDataSet7.Post;
    end;
    //
    if sModulo = 'CLIENTES' then
    begin
      ibDataSet2.Edit;
      if ibDataSet2ATIVO.AsString='1' then
      begin
        Ativo1.Checked := False;
        Ativo2.Checked := False;
        ibDataSet2ATIVO.AsString := '0';
      end else
      begin
        Ativo1.Checked := True;
        Ativo2.Checked := True;
        ibDataSet2ATIVO.AsString := '1';
      end;
      ibDataSet2.Post;
    end;
    //
    if sModulo = 'ESTOQUE' then
    begin
      ibDataSet4.Edit;
      if ibDataSet4ATIVO.AsString='1' then
      begin
        Ativo1.Checked := False;
        Ativo4.Checked := False;
        ibDataSet4ATIVO.AsString := '0';
      end else
      begin
        Ativo1.Checked := True;
        Ativo4.Checked := True;
        ibDataSet4ATIVO.AsString := '1';
      end;
      ibDataSet4.Post;
//    ibDataSet4.Edit;
    end;
  except end;
end;

procedure TForm7.Emailpara1Click(Sender: TObject);
begin
  if (ibDataSet2ATIVO.AsString<>'1') and (ValidaEmail(ibDataSet2EMAIL.AsString)) then
     ShellExecute( 0, 'Open',pChar('mailto:'+AllTrim(ibDataSet2EMAIL.AsString)),'New', '', SW_SHOWMAXIMIZED);
end;

procedure TForm7.MenuItem1Click(Sender: TObject);
begin
  //
  Enviartorpedo1.Caption      := 'Enviar uma mensagem WhatsApp para: '+Alltrim(ibDataSet2NOME.AsString);
  if LimpaNumero(ibDataSet2WHATSAPP.AsString) = '' then Enviartorpedo1.Enabled := False else Enviartorpedo1.Enabled := True;
  //
  Emailpara1.Caption        := 'Enviar um e-mail para: '+Alltrim(ibDataSet2NOME.AsString);
  //
  if ( Pos('@',ibDataSet2EMAIL.AsString) = 0) then Emailpara1.Enabled := False else Emailpara1.Enabled := True;
  if AllTrim(sWhere) = '' then
    Enviaremailparatodos1.Caption := 'Enviar um e-mail texto para todos os clientes e fornecedores'
  else
    Enviaremailparatodos1.Caption := 'Enviar o e-mail texto para todos os clientes e fornecedores filtrados';
  //
end;

procedure TForm7.MenuItem27Click(Sender: TObject);
begin
  if ibDataSet4ATIVO.AsString='1' then Ativo4.Checked := False else Ativo4.Checked := True;
end;


procedure TForm7.Ativo4Click(Sender: TObject);
begin
  try
    ibDataSet4.Edit;
    if ibDataSet4ATIVO.AsString='1' then
    begin
      Ativo1.Checked := False;
      Ativo4.Checked := False;
      ibDataSet4ATIVO.AsString := '0';
    end else
    begin
      Ativo1.Checked := True;
      Ativo4.Checked := True;
      ibDataSet4ATIVO.AsString :='1';
    end;
    ibDataSet4.Post;
  except end;
end;

procedure TForm7.Relatriodeservios1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de servios';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Relatriodeoramentospendentes1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Relatrio de oramentos pendentes';
  Form38.ShowModal; // Ok
end;

procedure TForm7.ibDataSet4MARGEMLBChange(Sender: TField);
begin
  if ibDataSet4CUSTOCOMPR.Asfloat < 0 then
    ibDataSet4CUSTOCOMPR.Asfloat := 0;

  if (ibDataSet4MARGEMLB.AsFloat <> 0) and (ibDataSet4CUSTOCOMPR.AsFloat <> 0) then
    ibDataSet4PRECO.AsFloat := StrToFloat(Format('%8.2f',[(ibDataSet4CUSTOCOMPR.AsFloat * ((ibDataSet4MARGEMLB.AsFloat / 100)+1))]));
end;


procedure TForm7.ibDataSet4BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  //
  if AllTrim(Form7.ibDataSet4DESCRICAO.AsString) <> '' then
  begin
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    sApagar := 'O sistema encontrou lanamentos referentes ao produto: '+Chr(10)+
               Chr(10)+
               Chr(10)+Form7.ibDataSet4DESCRICAO.AsString+Chr(10)+
               Chr(10)+
               'nos seguintes arquivos:'+chr(10)+chr(10);

    //
    ibDataSet16.Close;
    ibDataSet16.SelectSQL.Clear;
    ibDataSet16.SelectSQL.Add('select * from ITENS001 where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
    ibDataSet16.Open;
    //
    ibDataSet23.Close;
    ibDataSet23.SelectSQL.Clear;
    ibDataSet23.SelectSQL.Add('select * from ITENS002 where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
    ibDataSet23.Open;
    
    ibDataSet27.Close;
    ibDataSet27.SelectSQL.Clear;
    ibDataSet27.SelectSQL.Add('select * from ALTERACA where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
    ibDataSet27.Open;

    if Form7.ibDataSet16.Locate('DESCRICAO',Form7.ibDataSet4DESCRICAO.AsString,[]) then sApagar := sApagar + '      Movimento de vendas'+Chr(10); // Vendas
    if Form7.ibDataSet23.Locate('DESCRICAO',Form7.ibDataSet4DESCRICAO.AsString,[]) then sApagar := sApagar + '      Movimento de compras'+Chr(10); // Compras
    if Form7.ibDataSet27.Locate('DESCRICAO',Form7.ibDataSet4DESCRICAO.AsString,[]) then sApagar := sApagar + '      Movimento de vendas por ECF ou alterao na quantidade '+Chr(10);

    Screen.Cursor := crDefault; // Cursor de Aguardo

    if Length(sApagar) <> 85+Length(Form7.ibDataSet4DESCRICAO.AsString)  then
    begin
      sApagar := sApagar + Chr(10) + Chr(10) + 'Portanto no pode ser apagado.' + Chr(10)
                                             + Chr(10)
                                             + 'Para tornar este item inativo clique no menu "Edita"'
                                             + Chr(10) + 'e desabilite a opo "Ativo".' + Chr(10);
      //ShowMessage(sApagar); Mauricio Parizotto 2023-10-25
      MensagemSistema(sApagar);
      Abort;
    end;
  end;

  Screen.Cursor := crHourGlass; // Cursor de Aguardo

  // Alteraca
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('delete from CODEBAR where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString));
  ibDataSet99.Open;

  // Alteraca
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('delete from ALTERACA where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString));
  ibDataSet99.Open;

  // Apaga a controle de serial
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.Selectsql.Add('delete from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
  ibDataSet99.Open;

  // Apaga a grade
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.Selectsql.Add('delete from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' ');
  ibDataSet99.Open;

  // Apaga na composio
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.Selectsql.Add('delete from COMPOSTO where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString)+' ');
  ibDataSet99.Open;

  // Reaproveita o Nmero do Cdigo do produto
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_CODIGO,0) from rdb$database');
  IBDataSet99.Open;

  if Form7.ibDataSet4CODIGO.AsString = StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),5,0) then
  begin
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select gen_id(G_CODIGO,-1) from rdb$database');
    IBDataSet99.Open;
  end;
  
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_HASH_ESTOQUE,-1) from rdb$database');
    ibDataset99.Open;
  except end;

  RegistraExclusaoRegistro(ibDataSet4);

  Screen.Cursor := crDefault; // Cursor de Aguardo
end;

procedure TForm7.ibDataSet18ESTADOSetText(Sender: TField; const Text: String);
begin
  if Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0 then
  begin
     //ShowMessage('Estado invlido'); Mauricio Parizotto 2023-10-25
     MensagemSistema('Estado invlido',msgAtencao);

     ibDataSet18ESTADO.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end else
    ibDataSet18ESTADO.AsString := UpperCase(Text);
end;

procedure TForm7.ibDataSet15TOTALChange(Sender: TField);
begin
  TestarLimiteDisponivel;
end;

function TForm7.TestarLimiteDisponivel(AbMostraMsg: Boolean = True): Boolean;
var
  nCredito: Real;
  oLimDisp: IRetornaLimiteDisponivel;
begin
  Result := True;
  if (Form7.sModulo = 'VENDA') or (Form7.sModulo = 'DESCONTO') then
  begin
    if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet15OPERACAO.AsString then
      Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
    if Form7.ibDataSet2NOME.AsString <> Form7.ibDataSet15CLIENTE.AsString then
    begin
      Form7.ibDataSet2.Close;
      Form7.ibDataSet2.Selectsql.Clear;
      Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
      Form7.ibDataSet2.Open;
    end;
    if (Form7.ibDataSet2CREDITO.AsFloat <> 0) and (ibDataSet15TOTAL.Asfloat <> 0) and ((ibDataSet15EMITIDA.AsString <> 'S') or (TestarEstadosAlteraEmitadaNota)) then
    begin
      if UpperCase(Form7.ibDataSet14INTEGRACAO.AsString) = 'RECEBER' then
      begin
        oLimDisp := TRetornaLimiteDisponivel.New
                                            .setDataBase(IBDatabase1)
                                            .setCliente(Form7.ibDataSet2NOME.AsString)
                                            .setNumeroNFReceber(Form7.ibDataSet15NUMERONF.AsString)
                                            .CarregarDados;

        nCredito := oLimDisp.RetornarValor - ibDataSet15TOTAL.Asfloat;

        if (nCredito < 0) then
        begin
          Result := False;
          if AbMostraMsg then
            {
            ShowMessage('Ateno:'+sLineBreak
                                  + sLineBreak
                                  + 'Cliente: '+Form7.ibDataSet2NOME.AsString + sLineBreak
                                  + sLineBreak
                                  + 'Limite de crdito: R$ '+Format('%10.2n',[Form7.ibDataSet2CREDITO.AsFloat]) + '                ' + sLineBreak
                                  + 'Contas a receber: R$ '+Format('%10.2n',[oLimDisp.RetornarValorContasReceber]) + sLineBreak
                                  + 'Total da nota: R$ '+Format('%10.2n',[Form7.ibDataSet15TOTAL.Asfloat]) + sLineBreak
                                  + sLineBreak
                                  + 'Limite de crdito excedido em: R$ '+Format('%10.2n',[(nCredito)*-1])
                                  + sLineBreak+sLineBreak+sLineBreak
                                  + '           MUDE A FORMA DE PAGAMENTO.                      '
                                  + sLineBreak);
            Mauricio Parizotto 2023-10-25}
            MensagemSistema('Ateno:'+sLineBreak
                            + sLineBreak
                            + 'Cliente: '+Form7.ibDataSet2NOME.AsString + sLineBreak
                            + sLineBreak
                            + 'Limite de crdito: R$ '+Format('%10.2n',[Form7.ibDataSet2CREDITO.AsFloat]) + '                ' + sLineBreak
                            + 'Contas a receber: R$ '+Format('%10.2n',[oLimDisp.RetornarValorContasReceber]) + sLineBreak
                            + 'Total da nota: R$ '+Format('%10.2n',[Form7.ibDataSet15TOTAL.Asfloat]) + sLineBreak
                            + sLineBreak
                            + 'Limite de crdito excedido em: R$ '+Format('%10.2n',[(nCredito)*-1])
                            + sLineBreak+sLineBreak+sLineBreak
                            + '           MUDE A FORMA DE PAGAMENTO.                      '
                            + sLineBreak
                            ,msgAtencao);
        end;
      end;
    end;
  end;
end;

procedure TForm7.ibDataSet18UFSetText(Sender: TField; const Text: String);
begin
  if Pos('1'+UpperCase(Text)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX21  21mg2')
     = 0 then
  begin
     //ShowMessage('Estado invlido'); Mauricio Parizotto 2023-10-25
     MensagemSistema('Estado invlido',msgAtencao);
     ibDataSet18UF.AsString := UpperCase(Form7.ibDataSet13ESTADO.AsString);
  end else
    ibDataSet18UF.AsString := UpperCase(Text);
end;

procedure TForm7.DBGrid1DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  I, OldBkMode : Integer;
  yRect, xRect : tREct;
  sTex : String;
begin
  try
    dbGrid1.Canvas.Pen.Width    := 0;
    dbGrid1.Canvas.Pen.Color    := clWhite;

    if not (gdFocused in State) and not (gdFixed in State) and not (gdSelected in State) then
    begin
      try
        if (Field.DataType <> ftFloat) and (Field.DataType <> ftBCD) then
        begin
          if sModulo = 'CLIENTES' then
          begin
            if ibDataSet2ATIVO.AsString='1'  then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              if ibDataSet2MOSTRAR.AsString='1'  then DBGrid1.Canvas.Font.Color := clRed else DBGrid1.Canvas.Font.Color := clBlack;

              if (Field.FieldName = 'EMAIL') and (ValidaEmail(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                DBGrid1.Canvas.Font.Color := clBlue;
                DBGrid1.Canvas.Font.Style := [fsUnderline];
              end;

              if Field.FieldName = 'IE' then
              begin
                if (Length(AllTrim(Form7.ibDataSet2CGC.AsString)) = 18) and (UpperCase(AllTrim(Form7.ibDataSet2IE.AsString))<>'ISENTO') then
                begin
                  // NESTE CASO SERA MANTIDO A ConsisteInscricaoEstadual DA UNIT7, SE USAR DA SMALLFUNC_XE FICA LENTO
                  // DEVIDO A SEMPRE CARREGAR A DLL
                  if (LimpaNumero(Form7.ibDataSet2IE.AsString) <> EmptyStr) and (ConsisteInscricaoEstadual(LimpaNumero(Form7.ibDataSet2IE.AsString),Form7.ibDataSet2ESTADO.AsString)) then
                  begin
                    DBGrid1.Canvas.Font.Color := clRed;
                    DBGrid1.Canvas.Font.Style := [fsUnderline];
                  end else DBGrid1.Canvas.Font.Color := clBlack;
                end;
              end;
              //
              // O dgito 9 (nove) ser acrescentado  esquerda dos atuais nmeros, passando a ter o formato: 9XXXX-XXXX.
              // O nono dgito dever ser acrescentado no momento da discagem por todos os usurios, de aparelhos fixos ou mveis que liguem para telefones mveis da rea 11, independentemente do local de origem da chamada.
              // Assim, quem fizer um interurbano para um celular da rea 11 a partir de 29 de julho ter que teclar 14 dgitos - 0 + Cdigo da Operadora + 11 + 9XXXX-XXXX.
              //
              if Field.FieldName = 'CELULAR' then
              begin
                if (Copy(Form7.IBDataSet2CELULAR.AsString,1,7) = '(0xx11)') and (Length(AllTrim(Form7.IBDataSet2CELULAR.AsString))=15) then
                begin
                  if Copy(RetornaOperadora(Form7.IBDataSet2CELULAR.AsString),1,12) <> 'Convencional' then
                  begin
                    ibDAtaSet2.Edit;
                    ibDataSet2CELULAR.AsString := StrTran(ibDataSet2CELULAR.AsString,'(0xx11)','(9xx99)');
                    ibDataSet2CELULAR.AsString := StrTran(ibDataSet2CELULAR.AsString,'(9xx99)','(0xx11)9');
                    ibDAtaSet2.Post;
                    ibDAtaSet2.Edit;
                  end;
                end;
              end;
            end;
          end;

          if sModulo = 'CONVENIO' then
          begin
            if ibDataSet2ATIVO.AsString='1'  then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              if (Field.Name = 'ibDataSet29EMAIL') and (ValidaEmail(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                DBGrid1.Canvas.Font.Color := clBlue;
                DBGrid1.Canvas.Font.Style := [fsUnderline];
              end;
            end;
          end;

          if sModulo = 'FORNECED' then
          begin
            if ibDataSet2ATIVO.AsString='1' then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              if (Field.Name = 'ibDataSet3EMAIL') and (ValidaEmail(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                DBGrid1.Canvas.Font.Color := clBlue;
                DBGrid1.Canvas.Font.Style := [fsUnderline];
              end;
            end;
          end;

          if sModulo = 'TRANSPORT' then
          begin
            if (Field.Name = 'ibDataSet18EMAIL') and (ValidaEmail(Form7.ibDataSet18EMAIL.AsString)) then
            begin
              DBGrid1.Canvas.Font.Color := clBlue;
              DBGrid1.Canvas.Font.Style := [fsUnderline];
            end;
          end;

          if sModulo = 'ESTOQUE' then
          begin
            if ibDataSet4ATIVO.AsString='1'  then DBGrid1.Canvas.Font.Color := clSilver else
            begin
              if Form7.ibDataSet4QTD_ATUAL.AsFloat < Form7.ibDataSet4QTD_MINIM.AsFloat then
              begin
                DBGrid1.Canvas.Font.Color := clRed;
              end;

              // Composio Ok
              if (Field.Name = 'ibDataSet4DESCRICAO') and (not Form10.Visible) then
              begin
                Form7.ibDataSet99.Close;
                Form7.ibDataSet99.SelectSQL.Clear;
                Form7.IbDataSet99.SelectSQL.Add('select CODIGO from COMPOSTO where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' ');
                Form7.IbDataSet99.Open;

                if Form7.ibDataSet4CODIGO.AsString = Form7.IbDataSet99.FieldByname('CODIGO').AsString then
                  DBGrid1.Canvas.Font.Color := clGreen;
              end;

              if Field.FieldName = 'REFERENCIA' then
              begin
                try
                  //if not ValidaEAN13(Form7.ibDataSet4REFERENCIA.AsString) then Mauricio Parizotto 2023-07-05
                  if not ValidaEAN(Form7.ibDataSet4REFERENCIA.AsString) then
                  begin
                    DBGrid1.Canvas.Font.Color := clRed;
                    DBGrid1.Canvas.Font.Style := [fsUnderline];
                  end else DBGrid1.Canvas.Font.Color := clBlack;
                except
                  DBGrid1.Canvas.Font.Color := clRed;
                  DBGrid1.Canvas.Font.Style := [fsUnderline];
                end;
              end;

              if Form7.ibDataSet4MEDIDA.AsString <> '' then
              begin
                if Field.FieldName = 'MEDIDA' then
                begin
                  Form7.IBDataSet99.Close;
                  Form7.IBDataSet99.SelectSQL.Clear;
                  Form7.IBDataSet99.SelectSQL.Add('select SIGLA from MEDIDA where SIGLA='+QuotedStr(Form7.IBDataSet4MEDIDA.AsString)+'');
                  Form7.IBDataSet99.Open;

                  if Form7.ibDataSet4MEDIDA.AsString <> Form7.IBDataSet99.FieldByname('SIGLA').AsString then
                  begin
                    DBGrid1.Canvas.Font.Color := clRed;
                    DBGrid1.Canvas.Font.Style := [fsUnderline];
                  end else DBGrid1.Canvas.Font.Color := clBlack;
                end;
              end;
            end;
          end;

          if sModulo = 'RECEBER' then
          begin
            if ibDataSet7Vencimento.Value < date then DBGrid1.Canvas.Font.Color := clRed;
            if ibDataSet7Vencimento.Value = date then DBGrid1.Canvas.Font.Color := clBlue;
            if ibDataSet7Valor_Rece.Value <> 0   then DBGrid1.Canvas.Font.Color := clGreen;
            if ibDataSet7ATIVO.AsString=  '1'    then DBGrid1.Canvas.Font.Color := clSilver;
          end;

          if sModulo = 'OS' then
          begin
            if ibDataSet3SITUACAO.AsString = 'Fechada'    then DBGrid1.Canvas.Font.Color := clGreen;
            if ibDataSet3SITUACAO.AsString = 'Aberta'     then DBGrid1.Canvas.Font.Color := clRed;
            if ibDataSet3SITUACAO.AsString = 'Agendada'   then DBGrid1.Canvas.Font.Color := clBlack;
          end;

          if sModulo = 'PAGAR' then
          begin
            if ibDataSet8Vencimento.Value < date then DBGrid1.Canvas.Font.Color := clRed;
            if ibDataSet8Vencimento.Value = date then DBGrid1.Canvas.Font.Color := clBlue;
            if ibDataSet8Valor_Pago.Value <> 0 then DBGrid1.Canvas.Font.Color := clGreen;
          end;

          if sModulo = 'CAIXA' then
          begin
            if ibDataSet1.FieldByName('DATA').Value <> date then DBGrid1.Canvas.Font.Color := clGray;
            if AllTrim(ibDataSet1.FieldByName('NOME').AsString) = '' then
            begin
              if ibDataSet1.FieldByName('DATA').Value <> date then DBGrid1.Canvas.Font.Color := $009F9FFF else DBGrid1.Canvas.Font.Color :=  clRed;
            end;
          end;
          
          if sModulo = 'ICM' then
          begin
            if (Copy(ibDataSet14CFOP.AsString,1,1) = '1') or (Copy(ibDataSet14CFOP.AsString,1,1) = '2')  then DBGrid1.Canvas.Font.Color := clGreen;
            if (Copy(ibDataSet14CFOP.AsString,1,1) = '5') or (Copy(ibDataSet14CFOP.AsString,1,1) = '6')  then DBGrid1.Canvas.Font.Color := clBlue;
            if (Copy(ibDataSet14CFOP.AsString,1,1) = '3') or (Copy(ibDataSet14CFOP.AsString,1,1) = '7')  then DBGrid1.Canvas.Font.Color := clSilver;
            if (Copy(ibDataSet14CFOP.AsString,1,1) = ' ') then DBGrid1.Canvas.Font.Color := clBlack;
          end;

          if sModulo = 'ORCAMENTO' then
          begin
            try
              if AllTrim(Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString) = '' then
                DBGrid1.Canvas.Font.Color := clBlack
              else
                DBGrid1.Canvas.Font.Color  := _COR_AZUL;//$00EAB231;
            except
            end;
          end;

          if sModulo = 'VENDA' then
          begin
            if (Field.Name = 'ibDataSet15NUMERONF')     then
              DBGrid1.Canvas.Font.Style := [fsBold];

            if Form7.ibDataSet15EMITIDA.AsString = 'S' then
              DBGrid1.Canvas.Font.Color  := clBlack
            else
              DBGrid1.Canvas.Font.Color  := clRed;

            if alltrim(Form7.ibDataSet15NFERECIBO.AsString)    <> '' then
              DBGrid1.Canvas.Font.Color := clBlue;

            if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) <> 0 then
              DBGrid1.Canvas.Font.Color  := _COR_AZUL;//$00EAB231;

            if Form7.sRPS = 'S' then
            begin
              if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) <> 0 then
                DBGrid1.Canvas.Font.Color  := _COR_AZUL;//$00EAB231;
            end;

            if Form7.ibDataSet15EMITIDA.AsString = 'X' then
              DBGrid1.Canvas.Font.Color := clSilver;
          end;

          if sModulo = 'COMPRA' then
          begin
            if (Field.Name = 'ibDataSet24NUMERONF')     then
              DBGrid1.Canvas.Font.Style := [fsBold];
          end;

          dbGrid1.Canvas.FillRect(Rect);

          {Mauricio Parizotto 2024-01-03

          if Pos('WHATSAPP',UpperCase(Field.DisplayLabel)) <> 0 then
          begin
            yRect := Rect;
            YRect.Left   := Rect.Right - 40;
            YREct.Bottom := Rect.Top   + 40;

            if LimpaNumero(Field.AsString) <> '' then
              dbGrid1.Canvas.StretchDraw(yRect,Form7.ImageWhatsApp.Picture.Graphic);  // Claro
          end;
          }

          if (Field.FieldName = 'CONTATOS') then
          begin
            sTex := Right(Field.AsString,100);
          end;

          if ((Field.Name = 'ibDataSet15NUMERONF') and (Copy(Field.AsString,10,3)='RPS')) then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9))
          else if (Field.Name = 'ibDataSet15NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.Name = 'ibDataSet7NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.Name = 'ibDataSet24NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.Name = 'ibDataSet8NUMERONF') then
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Copy(Field.AsString,1,9)+'/'+Copy(Field.AsString,10,3))
          else if (Field.FieldName = 'CONTATOS') then
            DbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,sTex)
          else
            DbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,StrTran(StrTran(Copy(Field.AsString,1,Field.DisplayWidth),chr(10),' '),chr(13),' '));

        end;
      except
        try
          for I := 1 to iCampos do
            ArquivoAberto.Fields[I-1].Visible := True;
        except end;
      end;
    end;

    {Mauricio Parizotto 2024-01-03 - uDrawCellGridModulos

    if Field.Name = 'ibDataSet5COMPENS' then
    begin
      if Form7.ibDataSet5COMPENS.AsString = '' then
      begin
        dbGrid1.Canvas.FillRect(Rect);
        DBGrid1.Canvas.Font.Color   := clRed;
        dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'<Clique Duplo>');
      end;
    end;


    if Field.Name = 'ibDataSet1NOME' then
    begin
      if Form7.ibDataSet1NOME.AsString = '' then
      begin
        dbGrid1.Canvas.FillRect(Rect);
        DBGrid1.Canvas.Font.Color   := clRed;
        dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'<Plano de Contas>');
      end;
    end;



    if Field.Name = 'ibDataSet24MDESTINXML' then
    begin
      yRect := Rect;
      YRect.Left   := Rect.Right - 20;
      YREct.Bottom := Rect.Top   + 40;

      dbGrid1.Canvas.FillRect(Rect);

      if Pos('<tpEvento>210200',Form7.ibDataSet24MDESTINXML.AsString)<>0 then
      begin
        DBGrid1.Canvas.Font.Color   := _COR_AZUL;//$00EAB231;
        dbGrid1.Canvas.StretchDraw(yRect,Form7.Positivo.Picture.Graphic);  // Positivo
        dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Operao confirmada');
      end else
      begin
        if (Pos('<tpEvento>210210',Form7.ibDataSet24MDESTINXML.AsString)<>0)  then
        begin
          if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString)=0) and (Form7.ibDataSet24MERCADORIA.Asfloat = 0) then
          begin
            // Cincia da operao
            DBGrid1.Canvas.Font.Color   := clMaroon;
            dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoDownloadXML.Picture.Graphic);
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Ciencia da Operacao - Importe o XML');
          end else
          begin
            // 210210  Cincia da Operao
            DBGrid1.Canvas.Font.Color   := clGreen;
            dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoVerde.Picture.Graphic);  // Positivo
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Ciente da Operao');
          end;
        end else
        begin
          if (Pos('<tpEvento>21020',Form7.ibDataSet24MDESTINXML.AsString)<>0) then
          begin
            // 210220  Desconhecimento da Operao
            DBGrid1.Canvas.Font.Color := clSilver;
            dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoDownloadXML.Picture.Graphic);  // Positivo
            dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Desconhecimento da Operao');
          end else
          begin
            if (Pos('<tpEvento>210240',Form7.ibDataSet24MDESTINXML.AsString)<>0) then
            begin
              // 210240  Operao no Realizada
              DBGrid1.Canvas.Font.Color := clSilver;
              dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoDownloadXML.Picture.Graphic);  // Positivo
              dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Operao no Realizada');
            end else
            begin
              // Manifestar ciencia
              if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) then
              begin
                DBGrid1.Canvas.Font.Color   := clRed;
                dbGrid1.Canvas.StretchDraw(yRect,Form7.PositivoVermelho.Picture.Graphic);  // Positivo
                dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'Manifeste Cincia');
              end else
              begin
                DBGrid1.Canvas.Font.Color   := clBlack;
                dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'NF Manual (Guarde o Doc)');
              end;
            end;
          end;
        end;
      end;
    end;



    if Field.Name = 'ibDataSet15STATUS' then
    begin
      yRect := Rect;
      YRect.Left       := Rect.Right - 20;
      YRect.Bottom     := Rect.Top + 40;

      if Form7.sRPS = 'S' then
      begin
        if Pos('ChaveDeCancelamento',Form7.ibDataSet15RECIBOXML.AsString) <> 0 then
        begin
          dbGrid1.Canvas.StretchDraw(yRect,Form7.Image9.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(yRect,Form7.image8.Picture.Graphic);
        end
      end else
      begin
        if Form7.ibDataSet15EMITIDA.AsString = 'X' then
        begin
          dbGrid1.Canvas.StretchDraw(yRect,Form7.Image1.Picture.Graphic)
        end else
        begin
          if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
          begin
            dbGrid1.Canvas.StretchDraw(yRect,Form7.image8.Picture.Graphic);
          end else
          begin
            dbGrid1.Canvas.StretchDraw(yRect,Form7.Image9.Picture.Graphic);
          end;
        end;
      end;
    end;

    if sModulo = 'ESTOQUE' then
    begin
      if Field.Name = 'ibDataSet4MARKETPLACE' then
      begin
        if (Form7.ibDataSet4MARKETPLACE.AsString = '1') then
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image13.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end;
      end;
    end;


    if sModulo = 'RECEBER' then
    begin
      if Field.Name = 'ibDataSet7ATIVO' then
      begin
        if (Form7.ibDataSet7VALOR_RECE.Asfloat = 0) or (FORM7.ibDataSet7ATIVO.AsFloat >= 5) then
        begin
          if ibDataSet7ATIVO.AsFloat >= 5 then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image13.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image18.Picture.Graphic);
        end;
      end;
    end;

    if sModulo = 'PAGAR' then
    begin
      if Field.Name = 'ibDataSet8ATIVO' then
      begin
        if (Form7.ibDataSet8VALOR_PAGO.Asfloat = 0) or (Form7.ibDataSet8ATIVO.AsFloat >= 5) then
        begin
          if ibDataSet8ATIVO.AsFloat >= 5 then dbGrid1.Canvas.StretchDraw(Rect,Form7.Image13.Picture.Graphic) else dbGrid1.Canvas.StretchDraw(Rect,Form7.Image14.Picture.Graphic);
        end else
        begin
          dbGrid1.Canvas.StretchDraw(Rect,Form7.Image18.Picture.Graphic);
        end;
      end;
    end;


    if (Field.Name = 'ibDataSet14SOBREIPI') or
       (Field.Name = 'ibDataSet14SOBREFRETE') or
       (Field.Name = 'ibDataSet14SOBRESEGURO') or
       (Field.Name = 'ibDataSet14SOBREOUTRAS') or
       (Field.Name = 'ibDataSet14FRETESOBREIPI')  then
    begin
      dbGrid1.Canvas.FillRect(Rect);
      dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,'          ');
      //
      if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '5') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '6') then
      begin
        if Field.Name = 'ibDataSet14SOBREIPI' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBREIPI.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;

        if Field.Name = 'ibDataSet14SOBREFRETE' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBREFRETE.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;

        if Field.Name = 'ibDataSet14SOBRESEGURO' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBRESEGURO.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;

        if Field.Name = 'ibDataSet14SOBREOUTRAS' then
        begin
          if (Alltrim(Form7.ibDataSet14SOBREOUTRAS.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;


        if Field.Name = 'ibDataSet14FRETESOBREIPI' then
        begin
          if (Alltrim(Form7.ibDataSet14FRETESOBREIPI.AsString) = 'S') then
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image10.Picture.Graphic)
          else
            dbGrid1.Canvas.StretchDraw(Rect,Form7.Image11.Picture.Graphic);
        end;
      end;
    end;


    if (Field.Name = 'ibDataSet14'+UpperCase(Form7.ibDataSet13ESTADO.AsString)) or (Field.Name = 'ibDataSet14'+UpperCase(Form7.ibDataSet13ESTADO.AsString)+'_') then
    begin
      DBGrid1.Canvas.Font.Color   := clRed;
      dbGrid1.Canvas.FillRect(Rect);
      dbGrid1.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Field.AsString);
    end;

    if Field.Name = 'ibDataSet7VENCIMENTO' then
    begin
      if (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 7) then
        DBGrid1.Canvas.Font.Color   := clRed
      else
        DBGrid1.Canvas.Font.Color   := clBlack;
      dbGrid1.Canvas.TextOut(Rect.Left+dbGrid1.Canvas.TextWidth('99/99/9999_'),Rect.Top+2,Copy(DiaDaSemana(Form7.ibDataSet7VENCIMENTO.AsDateTime),1,3) );
    end;

    if Field.Name = 'ibDataSet7MOVIMENTO' then
    begin
      if Form7.ibDataSet7MOVIMENTO.AsString <> '' then
      begin
        if (DayOfWeek(Form7.ibDataSet7MOVIMENTO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet7MOVIMENTO.AsDateTime) = 7) then
          DBGrid1.Canvas.Font.Color   := clRed
        else
          DBGrid1.Canvas.Font.Color   := clBlack;
        dbGrid1.Canvas.TextOut(Rect.Left + dbGrid1.Canvas.TextWidth('99/99/9999_'), Rect.Top + 2, Copy(DiaDaSemana(Form7.ibDataSet7MOVIMENTO.AsDateTime), 1, 3) );
      end;
    end;


    if Field.Name = 'ibDataSet1DATA' then
    begin
      if (DayOfWeek(Form7.ibDataSet1DATA.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet1DATA.AsDateTime) = 7) then
        DBGrid1.Canvas.Font.Color   := clRed
      else
        DBGrid1.Canvas.Font.Color   := clBlack;
      DBGrid1.Canvas.TextOut(Rect.Left+dbGrid1.Canvas.TextWidth('99/99/9999_'),Rect.Top+2,Copy(DiaDaSemana(Form7.ibDataSet1DATA.AsDateTime),1,3) );
    end;

    if Field.Name = 'ibDataSet15EMISSAO' then
    begin
      if (DayOfWeek(Form7.ibDataSet15EMISSAO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet15EMISSAO.AsDateTime) = 7) then
        DBGrid1.Canvas.Font.Color   := clRed
      else
        DBGrid1.Canvas.Font.Color   := clBlack;
      DBGrid1.Canvas.TextOut(Rect.Left + dbGrid1.Canvas.TextWidth('99/99/9999_'), Rect.Top + 2, Copy(DiaDaSemana(Form7.ibDataSet15EMISSAO.AsDateTime), 1, 3) );
    end;
    }

    {$IFDEF VER150}
    begin
      DBGrid1.Canvas.Brush.Color := Form7.Panel7.Color;
      DBGrid1.Canvas.Pen.Color   := clRed;

      xRect.Left   := REct.Left;
      xRect.Top    := -2;
      xRect.Right  := Rect.Right;
      xRect.Bottom := Rect.Bottom - Rect.Top + 3;

      dbGrid1.Canvas.FillRect(xRect);

      if Pos(Field.FieldName,sOrderBy) <> 0 then
        DBGrid1.Canvas.Font.Style := [fsBold]
      else
        DBGrid1.Canvas.Font.Style := [];

      OldBkMode := SetBkMode(Handle, TRANSPARENT);
      DBGrid1.Canvas.Font.Color := clblack;
      DBGrid1.Canvas.TextOut(Rect.Left + 3, 3, AllTrim(Field.DisplayLabel));
      DBGrid1.Canvas.Font.Color := clblack;
      SetBkMode(Handle, OldBkMode);
    end;
    {$ELSE}
    {$ENDIF}

  except
  end;
end;

procedure TForm7.Balancetegerencial1Click(Sender: TObject);
var
  F: TextFile;
  fTotalNaoIdentificado, fSaldo, fTotalDasCONTAS, fTotalDasDespesas, fTotalDasReceitas, fTotalRetiradas : Real;
  Mais1Ini: TIniFile;
  I : Integer;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  Form7.ibDataSet1.DisableControls;
  Form7.ibDataSet12.DisableControls;
  //
  Form7.ibDataSet12.Close;
  Form7.ibDataSet12.SelectSQL.Clear;
  Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
  Form7.ibDataSet12.Open;
  Form7.ibDataSet12.First;
  //
  // Receitas
  //
  DeleteFile(pChar(Form1.sAtual+'\1.gra'));
  DeleteFile(pChar(Form1.sAtual+'\3.gra'));
  DeleteFile(pChar(Form1.sAtual+'\5.gra'));
  //
  DeleteFile(pChar(Form1.sAtual+'\1.png'));
  DeleteFile(pChar(Form1.sAtual+'\3.png'));
  DeleteFile(pChar(Form1.sAtual+'\5.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\1.gra');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','ENTRADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '1') and (Form7.ibDataSet12MES.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12MES.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  //
  CriaJpg('logotip.jpg');
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '1.GRA SMALLSOFT','', SW_SHOWMINNOACTIVE);
  //
  // Receitas
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\3.gra');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','SADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '3') and (Form7.ibDataSet12MES.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12MES.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  Mais1Ini.Free;
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '3.GRA  SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  // BANCOS
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\5.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','BANCOS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','2000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','4000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '5') and (Form7.ibDataSet12MES.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12MES.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '5.GRA  SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>BALANCETE GERENCIAL MENSAL</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>'+MesExtenso(Month(Form38.MonthCalendar1.Date))+' de '+ IntToStr(Year(Form38.MonthCalendar1.Date)) +'</b></font>');
  WriteLn(F,'<br></center>');              // Linha em branco
  WriteLn(F,'<br>');              // Linha em branco
  //
  WriteLn(F,'<center>');
  WriteLn(F,'<table  border=0>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  //
  ibDataSet1.Close;
  ibDataSet1.SelectSQL.Clear;
  ibDataSet1.SelectSQL.Add('select * from CAIXA order by DATA, REGISTRO');
  ibDataSet1.Open;
  
  CalculaSaldo(True);

  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('select * from CAIXA where extract(month from DATA)='+QuotedStr(StrZero(Month(Form38.MonthCalendar1.Date),2,0))+' and extract(year from DATA)='+QuotedStr(StrZero(Year(Form38.MonthCalendar1.Date),4,0))+' order by DATA, REGISTRO');
  ibDataSet99.Open;
  ibDataSet99.First;

  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);

  fSaldo := Form7.ibDataSet1SALDO.AsFloat- Form7.ibDataSet1ENTRADA.AsFloat + Form7.ibDataSet1SAIDA.AsFloat;

  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=2 align=left><font size=2>Saldo inicial do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>ENTRADAS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');

  Form7.ibDataSet12.First;
  fTotalDasReceitas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '1' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalDasReceitas := fTotalDasReceitas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo])+'<br></font></td>');
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\1.png"><img src="1.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>SADAS<br></td>');
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasDespesas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '3' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalDasDespesas := fTotalDasDespesas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo +fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  //
  // ENTRADAS - SAIDAS
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>ENTRADAS - SAIDAS</font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas +  fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
  WriteLn(F,'    </tr>');
  //
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\3.png"><img src="3.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  //
  // Cabealho
  //
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>BANCOS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasContas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '5' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalDasContas := fTotalDasContas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'     <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'     <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\5.png"><img src="5.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  // Cabealho
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
//  WriteLn(F,'   <table  border=0 align=left width=400>');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>RETIRADAS/INTEGRALIZAES<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ms</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalRETIRADAS := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '7' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12MES.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalRetiradas := fTotalRetiradas + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Saldo Final
  ibDataSet99.Last;
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=2 align=left><font size=2>Saldo final do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2 color=#FF0000>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas - Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  Form7.ibDataSet12.First;
  fTotalNaoIdentificado := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) <> '1') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '3') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '5') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '7') then
    begin
      fTotalNaoIdentificado := fTotalNaoIdentificado + Form7.ibDataSet12MES.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=3 align=left><font size=2>Lanamentos no identificados no caixa<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalNaoIdentificado])+'<br></font></td>');
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,'</table>');
  WriteLn(F,'   </td>');
  WriteLn(F,'  </tr>');
  WriteLn(F,' </table>');
  WriteLn(F,'<br><font size=1 color=#C0C0C0><b>Saldo do caixa do dia anterior + Receitas - Despesas + Bancos = Saldo do caixa atual</b></font>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);
  //
  Form7.ibDataSet1.EnableControls;
  Form7.ibDataSet12.Enablecontrols;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;

procedure TForm7.Balancetegerencialanual1Click(Sender: TObject);
var
  F: TextFile;
  fTotalNaoIdentificado, fSaldo, fTotalDasCONTAS, fTotalDasDespesas, fTotalDasReceitas, fTotalRetiradas : Real;
  Mais1Ini: TIniFile;
  I : Integer;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  Form7.ibDataSet1.DisableControls;
  Form7.ibDataSet12.DisableControls;
  //
  Form7.ibDataSet12.Close;
  Form7.ibDataSet12.SelectSQL.Clear;
  Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
  Form7.ibDataSet12.Open;
  Form7.ibDataSet12.First;
  //
  // Receitas
  //
  DeleteFile(pChar(Form1.sAtual+'\11.gra'));
  DeleteFile(pChar(Form1.sAtual+'\13.gra'));
  DeleteFile(pChar(Form1.sAtual+'\15.gra'));
  //
  DeleteFile(pChar(Form1.sAtual+'\11.png'));
  DeleteFile(pChar(Form1.sAtual+'\13.png'));
  DeleteFile(pChar(Form1.sAtual+'\15.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\11.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','ENTRADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '1') and (Form7.ibDataSet12ANO.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12ANO.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  CriaJpg('logotip.jpg');
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '11.GRA SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  // Receitas
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\13.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','SADAS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '3') and (Form7.ibDataSet12ANO.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12ANO.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  Mais1Ini.Free;
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '13.GRA SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  // BANCOS
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\15.GRA');
  // Titulo
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','1');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','Titulo','BANCOS');
  Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
  Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
  //
  // Acumula os valores
  I := 0;
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) = '5') and (Form7.ibDataSet12ANO.AsFloat <>0) then
    begin
      I := I +1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
       StrTran(Format('%15.2n',[Abs(Form7.ibDataSet12ANO.AsFloat)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<'+Copy(Form7.ibDataSet12NOME.AsString,1,20)+'>');
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  //
  Mais1Ini.Free;
  ShellExecute( 0, 'Open', 'GRAFICOS.EXE', '15.GRA SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  //
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>BALANCETE GERENCIAL ANUAL</b></font>');
  WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>'+MesExtenso(Month(Form38.MonthCalendar1.Date))+' de '+ IntToStr(Year(Form38.MonthCalendar1.Date)) +'</b></font>');
  WriteLn(F,'<br></center>');              // Linha em branco
  WriteLn(F,'<br>');                       // Linha em branco
  //
  WriteLn(F,'<br></center>');              // Linha em branco
  WriteLn(F,'<br>');                       // Linha em branco
  //
  WriteLn(F,'<center>');
  WriteLn(F,'<table border=0>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  //
  ibDataSet1.Close;
  ibDataSet1.SelectSQL.Clear;
  ibDataSet1.SelectSQL.Add('select * from CAIXA order by DATA, REGISTRO');
  ibDataSet1.Open;
  //
  CalculaSaldo(True);
  //
  ibDataSet99.Close;
  ibDataSet99.SelectSQL.Clear;
  ibDataSet99.SelectSQL.Add('select * from CAIXA where extract(year from DATA)='+QuotedStr(StrZero(Year(Form38.MonthCalendar1.Date),4,0))+' order by DATA, REGISTRO');
  ibDataSet99.Open;
  ibDataSet99.First;
  //
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  fSaldo := Form7.ibDataSet1SALDO.AsFloat- Form7.ibDataSet1ENTRADA.AsFloat + Form7.ibDataSet1SAIDA.AsFloat;
  //
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td  '+{nowrap}' colspan=2 align=left><font size=2>Saldo inicial do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td  '+{nowrap}' align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'        <td  '+{nowrap}' align=right><font size=2>'+ Format('%15.2n',[fSaldo])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td  '+{nowrap}' colspan=4><font size=2 ><b>ENTRADAS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  //
  Form7.ibDataSet12.First;
  fTotalDasReceitas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '1' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalDasReceitas := fTotalDasReceitas + Form7.ibDataSet12ANO.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo])+'<br></font></td>');

  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\11.png"><img src="11.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>SADAS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasDespesas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '3' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalDasDespesas := fTotalDasDespesas + Form7.ibDataSet12ANO.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo +fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  //
  // ENTRADAS - SAIDAS
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>ENTRADAS - SAIDAS</font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas +  fTotalDasDespesas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
  WriteLn(F,'    </tr>');
  //
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\13.png"><img src="13.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Cabealho
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>BANCOS<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalDasContas := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '5' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalDasContas := fTotalDasContas + Form7.ibDataSet12ano.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'     <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'     <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'     <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,'  <td>');
  WriteLn(F,'   <table  border=0>');
  WriteLn(F,'    <tr>');
  WriteLn(F,'     <td  ><a href="'+Form1.sAtual+'\15.png"><img src="15.png" border="0" width=300 height=150></a></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  // Cabealho
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  WriteLn(F,'    <tr bgcolor=#FFFFFF>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=4><font size=2 ><b>RETIRADAS/INTEGRALIZAES<br></td>');
  WriteLn(F,'    <tr  bgcolor=#'+Form1.sHtmlCor+' align=left>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Cdigo</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Conta</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Valor ano</font></th>');
  WriteLn(F,'        <th  '+{nowrap}'><font size=2>Saldo</font></th>');
  WriteLn(F,'    </tr>');
  //
  Form7.ibDataSet12.First;
  fTotalRETIRADAS := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if Copy(ibDataSet12CONTA.AsString,1,1) = '7' then
    begin
      WriteLn(F,'    <tr bgcolor=#FFFFFF>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12CONTA.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2>'+Form7.ibDataSet12NOME.AsString+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet12ANO.AsFloat])+'<br></font></td>');
      WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2><br></font></td>');
      fTotalRetiradas := fTotalRetiradas + Form7.ibDataSet12ANO.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=left><font size=2><br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas])+'<br></font></td>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  //
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
  WriteLn(F,'   <table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=400>');
  // Saldo Final
  ibDataSet99.Last;
  ibDataset1.Locate('REGISTRO',ibDataSet99.FieldByname('REGISTRO').AsString,[]);
  //
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=2 align=left><font size=2>Saldo final do caixa do dia '+DateToStr(Form7.ibDataSet1DATA.AsDateTime)+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2 color=#FF0000>'+ Format('%15.2n',[fTotalDasReceitas + fSaldo + fTotalDasDespesas + fTotalDasContas + fTotalRetiradas - Form7.ibDataSet1SALDO.AsFloat])+'<br></font></td>');
  Form7.ibDataSet12.First;
  fTotalNaoIdentificado := 0;
  while not Form7.ibDataSet12.EOF do
  begin
    //
    if (Copy(ibDataSet12CONTA.AsString,1,1) <> '1') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '3') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '5') and (Copy(ibDataSet12CONTA.AsString,1,1) <> '7') then
    begin
      fTotalNaoIdentificado := fTotalNaoIdentificado + Form7.ibDataSet12ano.AsFloat;
    end;
    Form7.ibDataSet12.Next;
    //
  end;
  WriteLn(F,'    <tr bgcolor=#'+Form1.sHtmlCor+'>');
  WriteLn(F,'        <td   '+{nowrap}'  colspan=3 align=left><font size=2>Lanamentos no identificados no caixa<br></font></td>');
  WriteLn(F,'        <td   '+{nowrap}'   align=right><font size=2>'+ Format('%15.2n',[fTotalNaoIdentificado])+'<br></font></td>');
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table>');
  WriteLn(F,'  </td>');
  WriteLn(F,' </tr>');
  WriteLn(F,'</table>');
  WriteLn(F,'   </td>');
  WriteLn(F,'  </tr>');
  WriteLn(F,' </table>');
  WriteLn(F,'<br><font size=1 color=#C0C0C0><b>Saldo do caixa do dia anterior + Receitas - Despesas + Bancos = Saldo do caixa atual</b></font>');
  //
  // ---------------------------------------------------------------------------
  WriteLn(F,'<br>');              // Linha em branco
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</center>');
  WriteLn(F,'</html>');
  CloseFile(F);
  Form7.ibDataSet1.EnableControls;
  Form7.ibDataSet12.Enablecontrols;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;


procedure TForm7.ibDataSet1BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet1ENTRADA.AsFloat + (ibDataSet1SAIDA.AsFloat*-1);
end;

procedure TForm7.Ranquingdeclientes1Click(Sender: TObject);
begin
  //
  Form7.Close;
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Ranking de clientes';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.MenuItem60Click(Sender: TObject);
begin
  //
  if sModulo = 'RECEBER'  then
  begin
    if ibDataSet7ATIVO.AsString = '1' then
      Ativo5.Checked := False
    else
      Ativo5.Checked := True;
    //
    Acertodecontasde1.Visible := False;
    //
    Acertodecontasde1.Visible := True;
    Acertodecontasde1.Caption := 'Receber contas de: '+Form7.ibDataSet7NOME.AsString;
    //
  end;
  //
end;

procedure TForm7.ibDataSet19AfterPost(DataSet: TDataSet);
begin
  Form4.FormClick(Form4);
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet2CGCSetText(Sender: TField; const Text: String);
var
  sRetorno : String;
  I : Integer;
  slCNAE: TStringList;
  function TamanhoNumeroComplmento(sNumero: String): Integer;
  begin
    Result := Length(sNumero);
  end;
begin
  //
  {Sandro Silva 2022-12-15 inicio 
  Form7.spdNFe.ConfigurarSoftwareHouse('07426598000124','9830b685216a9c4613bc76c84098272d');
  }
  Form1.ConfiguraCredencialTecnospeed;
  {Sandro Silva 2022-12-15 fim}

  //
  if LimpaNumero(Text) <> '' then
  begin
    if CpfCgc(LimpaNumero(Text)) then
    begin
       if UpperCase(Form1.ConfAceitaCGCDuplo) = 'SIM' then
       begin
         ibDataSet2CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)));
       end else
       begin
         if (Valida_Campo('CLIFOR',ConverteCpfCgc(AllTrim(LimpaNumero(Text))),'CGC','Este CPF/CNPJ j foi cadastrado')) then
            ibDataSet2CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)));
       end;
    end else
    begin
      //ShowMessage('CPF ou CNPJ invlido!'); Mauricio Parizotto 2023-10-25
      MensagemSistema('CPF ou CNPJ invlido!',msgAtencao);
    end;
  end
  else
  begin
    if (ibDataSet2CGC.OldValue <> '') then
      ibDataSet2CGC.AsString := ibDataSet2CGC.OldValue
    else
      ibDataSet2CGC.AsString := '';
  end;

  if (AllTrim(Form7.IBDataSet2NOME.AsString) = '') and (AllTrim(LimpaNumero(Form7.IBDataSet2CGC.AsString))<>'') then
  begin
    Screen.Cursor            := crHourGlass;

    try
      if (Length(LimpaNumero(Form7.ibDataSet2CGC.AsString)) = 14) then
      begin
        sRetorno := ConsultaCadastro(Form7.ibDataSet2CGC.AsString);

        if AllTrim(xmlNodeValue(sRetorno,'//xNome')) <> '' then
        begin
          Form7.IBDataSet2IE.AsString     := xmlNodeValue(sRetorno,'//IE');
          Form7.IBDataSet2ESTADO.AsString := xmlNodeValue(sRetorno,'//UF');
          Form7.IBDataSet2NOME.AsString   := Copy(PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xNome'))), 1, Form7.IBDataSet2NOME.Size); // Sandro Silva 2024-01-15 PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xNome')));
          Form7.IBDataSet2ENDERE.AsString := Copy(PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xLgr'))), 1, Form7.IBDataSet2ENDERE.Size - TamanhoNumeroComplmento(', ' + xmlNodeValue(sRetorno,'//nro'))) + ', ' + PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//nro'))); // Sandro Silva 2024-01-15 PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xLgr')+', '+xmlNodeValue(sRetorno,'//nro') + ' ' + xmlNodeValue(sRetorno,'//xCpl')));
          Form7.IBDataSet2COMPLE.AsString := Copy(PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xBairro'))), 1, Form7.IBDataSet2COMPLE.Size);  // Sandro Silva 2024-01-15 PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xBairro')));
          Form7.IBDataSet2CEP.AsString    := Copy(xmlNodeValue(sRetorno,'//CEP'),1,5)+'-'+copy(xmlNodeValue(sRetorno,'//CEP'),6,3);
          Form7.IBDataSet2OBS.AsString    := 'CNAE: ' + xmlNodeValue(sRetorno,'//CNAE') + ' ' + xmlNodeValue(sRetorno,'//xMotivo');

          Form7.ibDataset99.Close;
          Form7.ibDataset99.SelectSql.Clear;
          Form7.ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where CODIGO='+QuotedStr(xmlNodeValue(sRetorno,'//cMun'))+' ');
          Form7.ibDataset99.Open;

          Form7.IBDataSet2CIDADE.AsString := Form7.IBDataSet99.FieldByname('NOME').AsString;

          { Dailon 2023-08-01 Inicio}
          slCNAE := TStringList.Create;
          try
            slCNAE.Text := getListaCnae;

            for I := 0 to slCNAE.Count -1 do
            begin
              if Copy(slCNAE[I],1,7) = xmlNodeValue(sRetorno,'//CNAE') then
              begin
                Form7.IBDataSet2OBS.AsString    := 'CNAE: ' + AllTrim(slCNAE[I]) + ' ' + xmlNodeValue(sRetorno,'//xMotivo');
              end;
            end;
          finally
            FreeAndNil(slCNAE);
          end;
          { Dailon 2023-08-01 Fim}
        end;
      end;
    except
    end;
  end;

  Screen.Cursor            := crDefault;
end;

procedure TForm7.ibDataSet7DOCUMENTOSetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(Text) <> '' then
    Valida_Campo('RECEBER', Text, 'DOCUMENTO','Esta conta j est cadastrada');
  ibDataSet7DOCUMENTO.AsString := AllTrim(Text);
end;

procedure TForm7.ibDataSet5DOCUMENTOSetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(Text) <> '' then
    Valida_Campo('MOVIMENT', Text, 'DOCUMENTO','Este documento j est cadastrado');
  ibDataSet5DOCUMENTO.AsString := Text;
end;

procedure TForm7.ibDataSet13CGCSetText(Sender: TField; const Text: String);
var
  sRetorno : String;
  I: Integer;
begin
  {
  if LimpaNumero(Text) <> '' then
  begin
    if CpfCgc(LimpaNumero(Text)) then
      ibDataSet13CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)))
    else
      ShowMessage('CPF ou CNPJ invlido!');
  end
  else
    ibDataSet13CGC.AsString := '';

  if (AllTrim(Form7.IBDataSet13NOME.AsString) = '') and (AllTrim(LimpaNumero(Form7.IBDataSet13CGC.AsString))<>'') then
  begin
    Screen.Cursor            := crHourGlass;

    try
      if (Length(LimpaNumero(Form7.ibDataSet13CGC.AsString)) = 14) or (Length(LimpaNumero(Form7.ibDataSet13CGC.AsString)) = 11) then
      begin
        sRetorno := ConsultaCadastro(Form7.ibDataSet13CGC.AsString);

        if AllTrim(xmlNodeValue(sRetorno,'//xNome')) <> '' then
        begin
          Form7.ibDataset13IE.AsString       := xmlNodeValue(sRetorno,'//IE');
          Form7.ibDataset13ESTADO.AsString   := xmlNodeValue(sRetorno,'//UF');
          Form7.ibDataset13NOME.AsString     := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xNome')));
          Form7.ibDataset13ENDERECO.AsString := PrimeiraMaiuscula(ConverteAcentos(xmlNodeValue(sRetorno,'//xLgr')+', '+xmlNodeValue(sRetorno,'//nro') + ' ' + xmlNodeValue(sRetorno,'//xCpl')));
          Form7.ibDataset13COMPLE.AsString   := PrimeiraMaiuscula((xmlNodeValue(sRetorno,'//xBairro')));
          Form7.ibDataset13CEP.AsString      := copy(xmlNodeValue(sRetorno,'//CEP'),1,5)+'-'+copy(xmlNodeValue(sRetorno,'//CEP'),6,3);
          Form7.ibDataset13CNAE.AsString     := xmlNodeValue(sRetorno,'//CNAE');

          for I := 0 to Form17.ComboBox7.Items.Count -1 do
          begin
            if Copy(Form17.ComboBox7.Items[I],1,7) = AllTrim(Form7.ibDataSet13CNAE.AsString) then
            begin
              Form17.ComboBox7.ItemIndex := I;
            end;
          end;

          Form7.ibDataset99.Close;
          Form7.ibDataset99.SelectSql.Clear;
          Form7.ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where CODIGO='+QuotedStr(xmlNodeValue(sRetorno,'//cMun'))+' ');
          Form7.ibDataset99.Open;

          Form7.ibDataset13MUNICIPIO.AsString := Form7.IBDataSet99.FieldByname('NOME').AsString;

          Form17.ComboBox1.ItemIndex    := 0;
          Form7.ibDataset13CRT.AsString := '1';
        end;
      end;
    except

    end;
  end;

  Screen.Cursor            := crDefault;
  Mauricio Parizotto 2023-06-27}
end;

procedure TForm7.ibDataSet18CGCSetText(Sender: TField; const Text: String);
begin
  if LimpaNumero(Text) <> '' then
  begin
    if CpfCgc(LimpaNumero(Text)) then
      ibDataSet18CGC.AsString := ConverteCpfCgc(AllTrim(LimpaNumero(Text)))
    else
      //ShowMessage('CPF ou CNPJ invlido!') Mauricio Parizotto 2023-10-25
      MensagemSistema('CPF ou CNPJ invlido!',msgAtencao);
  end else
    ibDataSet18CGC.AsString := '';
end;

procedure TForm7.ibDataSet21NOMESetText(Sender: TField; const Text: String);
begin
  if Valida_Campo('GRUPO',Text,'NOME','Este grupo j foi cadastrado') then
  ibDataSet21NOME.AsString := Text;
end;

procedure TForm7.ibDataSet9NOMESetText(Sender: TField; const Text: String);
begin
  if Valida_Campo('VENDEDOR',Text,'NOME','Este vendedor j foi cadastrado') then
  ibDataSet9NOME.AsString := Text;
end;

procedure TForm7.ibDataSet4PRECOChange(Sender: TField);
begin
  {Dailon Parisotto 2023-10-09 Inicio}
  if FbDuplicandoProd then
    Exit;
  {Dailon Parisotto 2023-10-09 fim}
  //
  if ibDataSet4PRECO.AsFloat <= 0 then
  begin
    //ShowMessage('O valor unitrio no pode aceitar valor negativo ou nulo.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('O valor unitrio no pode aceitar valor negativo ou nulo.',msgAtencao);

    if Form7.fPrecoAnterior <= 0 then
      Form7.fPrecoAnterior := 0.01;
    Form7.ibDataSet4PRECO.AsFloat := Form7.fPrecoAnterior;
    if Form10.Visible then
      Form10.SMALL_DBEdit7.Text := Form7.ibDataSet4PRECO.AsString;
    Abort;
  end
  else
    ibDataSet4ALTERADO.AsString := '1';

  Form7.ibDataSet4OFFPROMO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
end;

procedure TForm7.Balancetegerancialmensal1Click(Sender: TObject);
begin
  Form1.Planodecontas1Click(Sender);
  Balancetegerencial1Click(Sender);
  Form1.imgCaixaClick(Sender);
end;

procedure TForm7.Balancetegerencialanual2Click(Sender: TObject);
begin
  Form1.Planodecontas1Click(Sender);
  Balancetegerencialanual1Click(Sender);
  Form1.imgCaixaClick(Sender);
end;

procedure TForm7.ibDataSet9BeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibDataSet9, EmptyStr, ' (VENDEDOR)');
end;

procedure TForm7.ibDataSet9BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de    }
  { alterar o nome. Se o nome for alterado deve ser  }
  { atualizado o arquivo VENDAS e o arquivo ALTERACA }
  sNumeroAnterior := ibDataSet9REGISTRO.AsString;
  sNomeAnterior   := ibDataSet9NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet9AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  //
  // VENDEDOR
  //
  if (sNomeAnterior <> ibDataSet9NOME.AsString) and (sNomeAnterior <> '')  and (sNumeroAnterior = ibDataSet9REGISTRO.AsString) then
  begin
    //
    sNomeNovo  := ibDataSet9NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // VENDAS
    //
    Form7.ibDataSet15.Close;
    Form7.ibDataSet15.SelectSQL.Clear;
    Form7.ibDataSet15.SelectSQL.Add('update VENDAS set VENDEDOR='+QuotedStr(sNomeNovo)+' where upper(VENDEDOR)='+QuotedStr(UpperCase(sNomeVolta))+'');
    Form7.ibDataSet15.Open;
    //
    // OS
    //
    Form7.ibDataSet3.Close;
    Form7.ibDataSet3.SelectSQL.Clear;
    Form7.ibDataSet3.SelectSQL.Add('update OS set TECNICO='+QuotedStr(sNomeNovo)+' where upper(TECNICO)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet3.Open;
    //
    // ITENS003
    //
    Form7.ibDataSet3.Close;
    Form7.ibDataSet3.SelectSQL.Clear;
    Form7.ibDataSet3.SelectSQL.Add('update ITENS003 set TECNICO='+QuotedStr(sNomeNovo)+' where upper(TECNICO)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet3.Open;
    //
    // ORCAMENT
    //
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    Form7.ibDataSet27.SelectSQL.Add('update ORCAMENT set VENDEDOR='+QuotedStr(sNomeNovo)+' where upper(VENDEDOR)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet27.Open;
    //
    // ALTERACA
    //
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    Form7.ibDataSet27.SelectSQL.Add('update ALTERACA set VENDEDOR='+QuotedStr(sNomeNovo)+' where upper(VENDEDOR)='+QuotedStr(Uppercase(sNomeVolta))+'');
    Form7.ibDataSet27.Open;
    //
    ibDataSet9.Enablecontrols;
    ibDataSet27.EnableControls;
    Screen.Cursor := crDefault; // Cursor de Aguardo
    //
  end;
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.MenuItem23Click(Sender: TObject);
begin
  //
  Form7.EnvioaoFISCOREDUOZ1.Visible := True;
  ImprimiraNFemformulrionumerado1.Visible := (TestarNFeHomologacao);
  ImprimirtodasasNFfiltradas1.Visible     := (TestarNFeHomologacao);
  ImprimirNF3.Visible                     := (TestarNFeHomologacao);
  //
  if FileExists(Form1.sAtual+'\orca.exe') then
  begin
    Relatriodeoramentospendentes1.Visible := True;
    ImportarOramento1.Visible := True;
    ImportarOS1.Visible := True;
    Oramento1.Visible := True;
    N6.Visible := True;
  end else
  begin
    Relatriodeoramentospendentes1.Visible := False;
    ImportarOramento1.Visible := False;
    ImportarOS1.Visible := False;
    Oramento1.Visible := False;
    N6.Visible := False;
  end;
  //
  ArquivotextoNotaFiscalPaulista1.Visible := False;
  //
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'SP' then ArquivotextoNotaFiscalPaulista1.Visible := True;
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'AL' then
  begin
    ArquivotextoNotaFiscalPaulista1.Visible := True;
    ArquivotextoNotaFiscalPaulista1.Caption := 'Arquivo texto "Nota Fiscal Alagoana"...';
  end;
  //
//  ImprimirNF2.Caption := 'Imprimir NF nmero '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet15CLIENTE.AsString;
  Exportar1.Caption   := 'Exportar NF nmero '+ Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet15CLIENTE.AsString;
  if bSoLeitura then Grupos1.Enabled := False else Grupos1.Enabled := True;
  //
{
  Mais1ini := TIniFile.Create(Form1.sAtual+'\nfe.ini');
  //
  if (Mais1Ini.ReadString('NFE','Ambiente','Homologacao') = 'Producao') and (Mais1Ini.ReadString('NFE','Formulario','No') = 'No') then
  begin
    ImprimirNF2.Visible                 := False;
    ImprimirtodasasNFfiltradas1.Visible := False;
  end else
  begin
    ImprimirNF2.Visible                 := True;
    ImprimirtodasasNFfiltradas1.Visible := True;
  end;
  //
  Mais1ini.Free;
}
  //
end;

procedure TForm7.ibDataSet21AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //
  // GRUPO de Mercadorias
  //
  Form7.ibDataSet4.DisableControls;
  Form7.ibDataSet21.DisableControls;
  //
  if (sNomeAnteriorDoGrupo <> ibDataSet21NOME.AsString) and (sNumeroAnteriorGrupo = ibDataSet21REGISTRO.AsString) then
  begin
    sNomeNovo  := ibDataSet21NOME.AsString;
    sNomeVolta := sNomeAnteriorDoGrupo;
    //
    // ESTOQUE
    //
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.SelectSQL.Clear;
    Form7.ibDataSet4.SelectSQL.Add('update ESTOQUE set NOME='+QuotedStr(sNomeNovo)+' where NOME='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet4.Open;
    //
  end;
  Form7.ibDataSet21.EnableControls;
  Form7.ibDataSet4.EnableControls;
  Screen.Cursor := crDefault;
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet21BeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibDataSet21);
end;

procedure TForm7.ibDataSet21BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo de ESTOQUE                 }
  sNumeroAnteriorGrupo := ibDataSet21REGISTRO.AsString;
  sNomeAnteriorDoGrupo := ibDataSet21NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet3NOMEChange(Sender: TField);
begin
//  if Form10.Button7.Visible then Form10.Button7.Enabled := True;
end;

procedure TForm7.ibDataSet4AfterPost(DataSet: TDataSet);
var
  sNomeNovo  : String;
  sNomeVolta : String;
begin
  // Quando troca o nome do produto
  if (sNomeAnterior <> ibDataSet4DESCRICAO.AsString) and (AllTrim(sNomeAnterior) <> '') and (sNumeroAnterior = ibDataSet4REGISTRO.AsString) then
  begin
    Form1.LbBlowfish1.GenerateKey(Form1.sPasta);
    
    Form7.ibDataSet4.DisableControls;

    sNomeNovo  := ibDataSet4DESCRICAO.AsString;
    sNomeVolta := sNomeAnterior;

    // ALTERACA
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    //Form7.ibDataSet27.SelectSQL.Add('update ALTERACA set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+'  where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet27.SelectSQL.Add('update ALTERACA set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5String(Form1.sPasta)))+'  where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet27.Open;

    // ORCAMENTO
    Form7.ibDataSet27.Close;
    Form7.ibDataSet27.SelectSQL.Clear;
    //Form7.ibDataSet27.SelectSQL.Add('update ORCAMENT set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet27.SelectSQL.Add('update ORCAMENT set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5String(Form1.sPasta)))+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet27.Open;

    // COMPOSICAO
    Form7.ibDataSet28.Close;
    Form7.ibDataSet28.SelectSQL.Clear;
    Form7.ibDataSet28.SelectSQL.Add('update COMPOSTO set DESCRICAO='+QuotedStr(sNomeNovo)+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet28.Open;

    // ITENS001
    Form7.ibDataSet16.Close;
    Form7.ibDataSet16.SelectSQL.Clear;
    //Form7.ibDataSet16.SelectSQL.Add('update ITENS001 set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5Print(MD5String(Form1.sPasta))))+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet16.SelectSQL.Add('update ITENS001 set DESCRICAO='+QuotedStr(sNomeNovo)+', ENCRYPTHASH='+QuotedStr(Form7.LbBlowfish1.EncryptString(MD5String(Form1.sPasta)))+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet16.Open;

    // ITENS002
    Form7.ibDataSet23.Close;
    Form7.ibDataSet23.SelectSQL.Clear;
    Form7.ibDataSet23.SelectSQL.Add('update ITENS002 set DESCRICAO='+QuotedStr(sNomeNovo)+' where DESCRICAO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet23.Open;

    Form7.ibDataSet4.EnableControls;
  end;

  AgendaCommit(True);
end;

procedure TForm7.ibDataSet2AfterPost(DataSet: TDataSet);
var
  bButton : Integer;
  sNomeNovo, sNomevolta : String;
begin
  if sModulo <> 'LOKED' then
  begin
    try
      Form7.TabelaAberta.DisableControls;
    except
    end;
    
    // Est variavel foi Iniciada no BeforeEdit        //
    // Se o nome for alterado deve ser                 //
    // atualizado o arquivo VENDAS e o arquivo RECEBER //
    Form7.LbBlowfish1.GenerateKey(Form1.sPasta); // Minha chave secreta

    try
      if (sNomeAnterior <> ibDataSet2NOME.AsString) and (sNomeAnterior <> '') and (sNumeroAnterior = ibDataSet2REGISTRO.AsString) then
      begin
        sNomeNovo  := ibDataSet2NOME.AsString;
        sNomeVolta := sNomeAnterior;

        bButton := Application.MessageBox(Pchar('O nome foi alterado' +
                                                Chr(10) +
                                                Chr(10) + '     de: ' + sNomeAnterior +
                                                Chr(10) + '  para: ' + sNomeNovo +
                                                Chr(10) +
                                                Chr(10) + 'Os movimentos de: Vendas, contas a receber, vendas no balco          '+
                                                Chr(10) + 'e oramento vo ser atribudos a este novo nome.' + Chr(10) +
                                                Chr(10) +
                                                'Continuar?'+
                   Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        if bButton = IDYES then
        begin
          Screen.Cursor := crHourGlass;

          //Mauricio Parizotto 2023-05-04
          if not AtualizaDescricaoCliFor(sNomeNovo,sNomeVolta,IBDatabase1) then
          begin
            ibDataSet2.Edit;
            sNomeAnterior := sNomeVolta;
            ibDataSet2NOME.AsString := sNomeVolta;
            ibDataSet2.Post;
          end;

          // VENDEDORES - Sistema cria um novo tova vez
          ExecutaComando('Delete from VENDEDOR where NOME = '+QuotedStr(sNomevolta),ibDataSet2.Transaction);

          Screen.Cursor := crDefault; // Cursor normal
        end else
        begin
          ibDataSet2.Locate('NOME',sNomeNovo,[]);
          if ibDataSet2NOME.AsString = sNomeNovo then
          begin
            ibDataSet2.Edit;
            sNomeAnterior := sNomeVolta;
            ibDataSet2NOME.AsString := sNomeVolta;
            ibDataSet2.Post;
          end;

          // VENDEDORES - Sistema cria um novo tova vez.
          ExecutaComando('Delete from VENDEDOR where NOME = '+QuotedStr(sNomeNovo),ibDataSet2.Transaction);
        end;
      end;
    except
      //ShowMessage('Erro 7/1 ao renomear o nome do cliente.') Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro 7/1 ao renomear o nome do cliente.',msgErro);
    end;
    
    Form7.TabelaAberta.EnableControls;
    AgendaCommit(True);
  end;
end;

procedure TForm7.Inadimlencia1Click(Sender: TObject);
var
  Mais1Ini : TiniFile;
  ValorDevido, ValorRecebido: array [0..12] of Real;  // Cria uma matriz com 100 elementos
  F: TextFile;
  iOp1 : Real;
  iAno, I : Integer;
begin
  {$IFDEF VER150}
  ShortDateFormat := 'dd/mm/yyyy';
  {$ELSE}
  FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
  {$ENDIF}

  Screen.Cursor := crHourGlass; // Cursor de Aguardo

  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - INADIMPLNCIA')+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  // cria o grfico de inadim.png
  //
  for iAno := 0 to 10 do
  begin
    WriteLn(F,'<table  border=0 cellspacing=10 cellpadding=10 width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   vAlign=Top align=Right width=50%><a href="'+StrZero((year(Date)-iAno),4,0)+'.png"><img src="'+StrZero((year(Date)-iAno),4,0)+'.png" border="0" width=400 height=200></a></td>');
    WriteLn(F,'  <td   vAlign=Top align=Left width=50%>');
    WriteLn(F,'   <br><br>');
    WriteLn(F,'   <table  border=1  style="border-collapse:Collapse"  cellspacing=0 cellpadding=3>');
    WriteLn(F,'    <tr>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Ms</th>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Valor devido</th>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Valor recebido</th>');
    WriteLn(F,'     <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Inadimplncia</th>');
    WriteLn(F,'    </tr>');
    //
    for I := 1 to 12 do Valorrecebido[I] := 0;
    for I := 1 to 12 do ValorDevido[I] := 0;
    //
    Form7.IBDataSet99.Close;
    Form7.IBDataSet99.SelectSQL.Clear;
    Form7.IBDataSet99.SelectSQL.Add('select * from RECEBER where coalesce(ATIVO,9)<>1 order by VENCIMENTO');
    Form7.IBDataSet99.Open;
    //
    Form7.ibDataSet99.First;
    while not Form7.ibDataSet99.EOF do
    begin
      if (ibDataSet99.FieldByname('VENCIMENTO').AsDateTime <= Date) and (Form7.ibDataSet7ATIVO.AsString<>'1') then
      begin
        if not ((Year(ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Year(Date)) and (Month(ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Month(Date))) then
        begin
          if ibDataSet99.FieldByname('VALOR_RECE').Value <> 0 then
            if Year(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Year(Date)-iAno then
              Valorrecebido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] := Valorrecebido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] + Form7.ibDataSet99.FieldByname('VALOR_RECE').AsFloat;
          if Year(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime) = Year(Date)-iAno then
          begin
            ValorDevido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] := ValorDevido[Month(Form7.ibDataSet99.FieldByname('VENCIMENTO').AsDateTime)] + Form7.ibDataSet99.FieldByname('VALOR_DUPL').AsFloat;
          end;
        end;
      end;
      Form7.ibDataSet99.Next;
    end;
    //
    DeleteFile(pChar(StrZero((year(Date)-iAno),4,0)+'.gra'));
    DeleteFile(pChar(StrZero((year(Date)-iAno),4,0)+'.png'));
    //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\'+StrZero((year(Date)-iAno),4,0)+'.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp',StrZero((year(Date)-iAno),4,0)+'.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','% DE INADIMPLNCIA EM '+StrZero((year(Date)-iAno),4,0));
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Series','1');
    Mais1Ini.WriteString('DADOS','MarcasS1','1');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
    Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); //  Verde
    //
    Mais1Ini.WriteString('DADOS','TituloSerie1',StrZero(Year(Date)-iAno,4,0));
    //
    for I := 1 to 12 do
    begin
      if ValorDevido[I] = 0 then
        iOp1 := 0
      else
        iOp1 := 100-(ValorRecebido[I]/ValorDevido[I]*100);
      //
      WriteLn(F,'    <tr>');
      WriteLn(F,'     <td  ><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Copy(MesExtenso(I),1,3)+'</td>');
      WriteLn(F,'     <td   Align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[ValorDevido[I]])+'</td>');
      WriteLn(F,'     <td   Align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[ValorRecebido[I]])+'</td>');
      WriteLn(F,'     <td   Align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[iOp1])+' %</td>');
      WriteLn(F,'    </tr>');
      //
      //
      //  ValorDevido[i]    = Total do Valor a Receber
      //  Valorrecebido[i]  = Total de Valor Recebido
      //
      if ValorDevido[I] = 0 then
        iOp1 := 0
      else
        iOp1 := 100-(ValorRecebido[I]/ValorDevido[I]*100);

      if iOp1 < 0 then
        iOp1 := 0;
      //
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                           'S1<'+StrTran(Format('%15.2n', [iOp1]),'.','')+
                           '>S2<'+StrTran(Format('%15.2n',[iOp1]),'.','')+
                           '>VX<'+StrZero(I,2,0)+'>LX<'+StrZero(I,2,0)+'>');

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                            'S1<'+StrTran(Format('%15.2n', [iOp1]),'.','')+
                            '>S2<'+StrTran(Format('%15.2n',[iOp1]),'.','')+
                            '>VX<'+StrZero(I,2,0)+'>LX<'+Copy(MesExtenso(I),1,3)+'>');

    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe',pChar(StrZero((year(Date)-iAno),4,0)+'.gra SMALLSOFT'), '', SW_SHOWMINNOACTIVE);
    while not FileExists(StrZero((year(Date)-iAno),4,0)+'.png') do sleep(100);
    //
    WriteLn(F,'  </table>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
  end;
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  WriteLn(F,'<center><br><font face="verdana" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
  + Copy(DateTimeToStr(Date),7,4) +', '+ LowerCase(DiaDaSemana(Date)) + ' s ' + TimeToStr(Time)+'</font></center>');
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);                                    // Fecha o arquivo
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
end;

function TForm7.IniFileUsuarioLogado: String;
begin
  Result := Form1.sAtual+'\'+Usuario+'.inf';
end;

procedure TForm7.CurvaABC1Click(Sender: TObject);
begin
  Form7.Close;
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Curva ABC de clientes';
  Form38.ShowModal; // Ok
end;

procedure TForm7.CurvaABCdoestoque1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Curva ABC do estoque';

  Form38.ShowModal; // Ok
end;

procedure TForm7.Duplicata1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open', 'smalldupl.exe',pChar(Form7.ibDataSet7DOCUMENTO.AsString+' '+'1'), '', SW_SHOW);
end;

procedure TForm7.Carn1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open', 'smalldupl.exe',pChar(Form7.ibDataSet7DOCUMENTO.AsString+' '+'2'), '', SW_SHOW);
end;

procedure TForm7.miExibirAjudaPlanoContasClick(Sender: TObject);
begin
  //
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
  //
end;

procedure TForm7.miExibirAjudaVendedorClick(Sender: TObject);
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
end;

procedure TForm7.ibDataSet2OBSSetText(Sender: TField; const Text: String);
begin
  try
    ibDataSet2OBS.AsString := Text;
  except
    //ShowMessage('Erro 10/10 comunique o suporte tcnico.');  Mauricio Parizotto 2023-10-25
    MensagemSistema('Erro 10/10 comunique o suporte tcnico.',msgErro);
  end;
end;

procedure TForm7.Analisegrafica1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  J, I : Integer;
  v1: array [0..4] of Real;
  F: TextFile;
  sNome : String;
  bChave : boolean;
begin
  Form7.ibDataSet1.DisableControls;

  try
    for I := 1 to 4 do v1[I] := 0;

    CriaJpg('logotip.jpg');

    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
    {$ENDIF}

    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE GRFICA DAS CONTAS</b></font>');
    WriteLn(F,'<br><center>');   // Linha em branco
    WriteLn(F,'<br>');           // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
  //  Form7.ibDataSet1.DisableControls;
    //
    sNome := '';
    //
    ibDataSet1.Close;
    ibDataSet1.SelectSQL.Clear;
    ibDataSet1.SelectSQL.Add('select * from CAIXA order by upper(NOME)');
    ibDataSet1.Open;
    //
    ibDataSet1.First;
    bChave := True;
    //
    while bChave do
    begin
      if (AllTrim(sNome) <> AllTrim(ibDataSet1NOME.AsString)) or (ibDataSet1.Eof) then
      begin
        if ibDataSet1.Eof then bChave := False;

        if (AllTrim(sNome) <> '') then
        begin
          if AllTrim(ibDataSet12NOME.AsString) = AllTrim(sNome) then
          begin
            //
            if allTrim(Form7.ibDataSet12CONTA.AsString) <> '' then
            begin
              //
              DeleteFile(pChar(Form1.sAtual+'\'+allTrim(Form7.ibDataSet12CONTA.AsString)+'.gra'));
              DeleteFile(pChar(Form1.sAtual+'\'+allTrim(Form7.ibDataSet12CONTA.AsString)+'.png'));
              //                               //
              // cria o grfico de receber.png //
              //                               //
              Mais1ini := TIniFile.Create(Form1.sAtual+'\'+AllTrim(Form7.ibDataSet12CONTA.AsString)+'.gra');
              Mais1Ini.WriteString('DADOS','3D','1');
    //          Mais1Ini.WriteString('DADOS','NomeBmp',AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png');
              Mais1Ini.WriteString('DADOS','TituloY','');
              Mais1Ini.WriteString('DADOS','TipoS1','0');
              Mais1Ini.WriteString('DADOS','Titulo',AllTrim(ibDataSet12NOME.AsString));
              Mais1Ini.WriteString('DADOS','Legenda','0');
              Mais1Ini.WriteString('DADOS','Series','1');
              Mais1Ini.WriteString('DADOS','MarcasS1','1');
              Mais1Ini.WriteString('DADOS','TituloX','');
              Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
              Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
              Mais1Ini.WriteString('DADOS','CorS1','13803635');
              Mais1Ini.WriteString('DADOS','CorS2','13421823');
              //
              Mais1Ini.WriteString('DADOS','TituloSerie1','Anos');
              //
              // Se for uma conta negativa multiplica por -1
              //
              J := -1;
              for I := 1 to 4 do if v1[I] > 0 then J := 1;
              //
              for I := 1 to 4 do
              begin
                try
                  Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                               'S1<'+StrTran(Format('%15.2n',[v1[I]*J]),'.','')+'>'+
                                               'S2<'+StrTran(Format('%15.2n',[v1[I]*J]),'.','')+'>'+
                                               'VX<'+StrZero(I,2,0)+'>LX<'+StrZero(Year(Date)-4+I,2,0)+'>');
                except end;
              end;
              //
              Mais1Ini.Free;
              //
              ShellExecute( 0, 'Open', 'graficos.exe', pchar(AllTrim(Form7.ibDataSet12CONTA.AsString)+'.GRA SMALLSOFT'), '', SW_SHOWMINNOACTIVE);
              while not FileExists(AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png') do sleep(10);
              WriteLn(F,'     <br><br><br><a href="'+Form1.sAtual+'\'+AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png"><img src="'+AllTrim(Form7.ibDataSet12CONTA.AsString)+'.png" border="0" width=600 height=300></a>');
              //
              for I := 1 to 4 do v1[I] := 0;
              //
            end;
          end;
        end;
        //
        sNome := ibDataSet1NOME.AsString;
        ibDataSet12.Locate('NOME',Alltrim(ibDataSet1NOME.AsString),[loPartialKey]);
      end;

      // Acumula os valores
      if AllTrim(sNome) <> '' then
      begin
        if Year(date)-3 = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[1] := v1[1] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
        if Year(date)-2 = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[2] := v1[2] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
        if Year(date)-1 = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[3] := v1[3] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
        if Year(date)   = Year(Form7.ibDataSet1DATA.AsDateTime) then v1[4] := v1[4] + Form7.ibDataSet1ENTRADA.AsFloat - Form7.ibDataSet1SAIDA.AsFloat;
      end;

      ibDataSet1.Next;
    end;
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco

    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
  except
  end;

  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
end;

procedure TForm7.ibDataSet4BeforePost(DataSet: TDataSet);
begin
  sRegistro := DataSet.FieldByname('REGISTRO').AsString;
  if ibDataSet4PRECO.AsFloat <=0 then
    ibDataSet4PRECO.AsFloat := 0.01;
  AssinaRegistro('ESTOQUE',DataSet, True);
  AuditaAlteracaoEstoqueManual;
end;

procedure TForm7.ibDataSet28NewRecord(DataSet: TDataSet);
begin
  ibDataSet28REGISTRO.AsString := sProximo;
  ibDataSet28CODIGO.AsString := ibDataSet4CODIGO.AsString;
end;

procedure TForm7.MenuItem58Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Romaneio de entrega';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Label38Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open','http://www.smallsoft.com.br','', '', SW_SHOWMAXIMIZED);
end;

procedure TForm7.ibDataSet14BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de   }
  { alterar o nome. Se o nome for alterado deve ser }
  { atualizado o arquivo VENDAS e o arquivo RECEBER }
  sNumeroAnterior14 := ibDataSet14REGISTRO.AsString;
  sNomeAnterior14 := ibDataSet14NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet14AfterPost(DataSet: TDataSet);
var
  bButton : Integer;
  sNomeNovo, sNomevolta : String;
begin
  // NATUREZE DA OPERAO
  try
    if (sNomeAnterior14 <> ibDataSet14NOME.AsString) and (sNomeAnterior14 <> '') and (sNumeroAnterior14 = ibDataSet14REGISTRO.AsString) then
    begin
      sNomeNovo  := ibDataSet14NOME.AsString;
      sNomeVolta := sNomeAnterior14;
      sRegistro  := ibDataSet14REGISTRO.AsString;
      //
      bButton := Application.MessageBox(Pchar('O nome da natureza da operao foi alterada' +
                                              Chr(10) +
                                              Chr(10) + '     de: ' + sNomeAnterior14 +
                                              Chr(10) + '  para: ' + ibDataSet14NOME.AsString +
                                              Chr(10) +
                                              Chr(10) + 'Os movimentos vo ser atribudos'+
                                              Chr(10) + 'a este novo nome.' + Chr(10) +
                                              Chr(10) +
                                              'Continuar?'+
                 Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
      if bButton = IDYES then
      begin
        // ALTERACA
        Form7.ibDataSet15.Close;
        Form7.ibDataSet15.SelectSQL.Clear;
        Form7.ibDataSet15.SelectSQL.Add('update VENDAS set OPERACAO='+QuotedStr(sNomeNovo)+' where OPERACAO='+QuotedStr(sNomeVolta)+'');
        Form7.ibDataSet15.Open;

        // COMPRAS
        Form7.ibDataSet24.Close;
        Form7.ibDataSet24.SelectSQL.Clear;
        Form7.ibDataSet24.SelectSQL.Add('update COMPRAS set OPERACAO='+QuotedStr(sNomeNovo)+' where OPERACAO='+QuotedStr(sNomeVolta)+'');
        Form7.ibDataSet24.Open;
      end else
      begin
        ibDataSet14.Locate('NOME',sNomeNovo,[]);
        if ibDataSet14NOME.AsString = sNomeNovo then
        begin
          ibDataSet14.Edit;
          sNomeAnterior14 := sNomeVolta;
          ibDataSet14NOME.AsString := sNomeVolta;
          ibDataSet14.Post;
        end;
      end;
    end;
  except
    //ShowMessage('Erro 7/10042 comunique o suporte tcnico.') Mauricio Parizotto 2023-10-25
    MensagemSistema('Erro 7/10042 comunique o suporte tcnico.',msgErro);
  end;
  
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet14BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  sNomeAnterior := Form7.ibDataSet14NOME.AsString;

  if AllTrim(Form7.ibDataSet14NOME.AsString) <> '' then
  begin
    sApagar := 'O sistema encontrou lanamentos referentes a esta operao '+Chr(10)+
               'nos seguintes arquivos:'+chr(10)+chr(10);
    // --------------- //
    // Vendas com NF   //
    // --------------- //
    ibDataSet15.First;
    while not ibDataSet15.Eof do
    begin
      if sNomeAnterior = ibDataSet15OPERACAO.AsString then
      begin
         sApagar := sApagar + '      Movimento de vendas'+Chr(10);
         ibDataSet15.Last;
      end;
      ibDataSet15.Next;
    end;
    Screen.Cursor := crDefault; // Cursor de Aguardo
    ibDataSet15.EnableControls;
    //
    ibDataSet24.DisableControls;

    //LogRetaguarda('ibDataSet24.DisableControls; 16549'); // Sandro Silva 2023-11-27

    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    // Procura e altera o novo nome no Arquivo de VENDAS//
    ibDataSet24.First;
    while not ibDataSet24.Eof do
    begin
      if sNomeAnterior = ibDataSet24OPERACAO.AsString then
      begin
        sApagar := sApagar + '      Movimento de compras'+Chr(10);
        ibDataSet24.Last;
      end;
      ibDataSet24.Next;
    end;
    Screen.Cursor := crDefault; // Cursor de Aguardo
    ibDataSet24.EnableControls;

    //LogRetaguarda('ibDataSet24.EnableControls; 16567'); // Sandro Silva 2023-11-27

    if Length(sApagar) <> 85 then
    begin
      sApagar := sApagar + Chr(10) + Chr(10) + 'Portanto no pode ser apagado.' + Chr(10)
                                             + Chr(10);
      //ShowMessage(sApagar); Mauricio Parizotto 2023-10-25
      MensagemSistema(sApagar);
      Abort;
    end;
  end;
  RegistraExclusaoRegistro(ibDataSet14);
end;

procedure TForm7.ibDataSet28AfterDelete(DataSet: TDataSet);
begin
  Form7.ibDataSet4.Edit;
  Form7.ibDataSet4CUSTOCOMPR.AsFloat := 0; // S atualiza o custo de produtos compostos
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet11PLANOSetText(Sender: TField; const Text: String);
begin
 Form7.ibDataSet12.First;
 while not ibDataSet12.Eof and (AllTrim(Form7.ibDataSet12CONTA.AsString) <> AllTrim(Text)) do ibDataSet12.Next;
 if AllTrim(Form7.ibDataSet12CONTA.AsString) = AllTrim(Text) then Sender.AsString := AllTrim(ibDataSet12CONTA.AsString) else
 begin
   //ShowMessage('Esta conta no existe no plano de contas.'); Mauricio Parizotto 2023-10-25
   MensagemSistema('Esta conta no existe no plano de contas.',msgAtencao);
   Sender.AsString := '';
 end;
end;

procedure TForm7.ibDataSet2DATANASSetText(Sender: TField; const Text: String);
begin
  { ------------------------------------------------------------------ }
  { Cuidado: Esta rotina est associada a todos os campos do tipo data }
  { ------------------------------------------------------------------ }
  if Text = '  /  /    ' then
  begin
    Sender.AsString := '';
  end else
  begin
    try
      Sender.AsString := Text;
    except
      begin
        Form7.bFlag := False;
        //ShowMessage('Esta data no  vlida, digite-a novamente.'); Mauricio Parizotto 2023-10-25
        MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
      end;
    end;
  end;
end;

procedure TForm7.MenuItem119Click(Sender: TObject);
begin
  Form37.Caption := 'Relatrio de convnio';
  if Form7.ibDataSet29.MoveBy(+1) = 1 then
    Form7.ibDataSet29.MoveBy(-1)
  else
    if Form7.ibDataSet29.MoveBy(-1) = -1 then
      ArquivoAberto.MoveBy(+1);
  Form37.ShowModal;
  Form37.Caption := 'Relatrio de comisses';
end;

procedure TForm7.Relatriodetodososconvnios1Click(Sender: TObject);
begin
  //
  Form37.Caption := 'Relatrio de convnio TODOS';
  ibDataSet29.First;
  Form37.ShowModal;
  Form37.Caption := 'Relatrio de comisses';
  //
end;

procedure TForm7.ibDataSet29NOMESetText(Sender: TField;
  const Text: String);
begin
  if Valida_Campo('CONVENIO',Text,'NOME','Este convnio j foi cadastrado') then
  ibDataSet29NOME.AsString := Text;
end;

procedure TForm7.ibDataSet2CONVENIOSetText(Sender: TField; const Text: String);
begin
  ibDataSet29.Locate('NOME',AllTrim(Text),[]);
  
  if AllTrim(Text) = '' then
    ibDataSet2CONVENIO.AsString := Text
  else
    if Pos(AnsiUpperCase(AllTrim(Text)),AnsiUpperCase(ibDataSet29NOME.AsString)) <> 0 then
      ibDataSet2CONVENIO.AsString := ibDataSet29NOME.AsString
    else
      //ShowMessage('Convnio no cadastrado.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Convnio no cadastrado.',msgAtencao);
end;

procedure TForm7.ibDataSet29BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de    }
  { alterar o nome. Se o nome for alterado deve ser  }
  { atualizado o arquivo CLIENTES                    }
  sNumeroAnterior := ibDataSet29REGISTRO.AsString;
  sNomeAnterior   := ibDataSet29NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibDataSet29AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  //
  // CONVENIO
  //
  if (sNomeAnterior <> ibDataSet29NOME.AsString) and (sNomeAnterior <> '')  and (sNumeroAnterior = ibDataSet29REGISTRO.AsString) then
  begin
    sNomeNovo  := ibDataSet29NOME.AsString;
    sNomeVolta := sNomeAnterior;
    //
    // VENDAS
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.SelectSQL.Clear;
    Form7.ibDataSet2.SelectSQL.Add('update CLIFOR set CONVENIO='+QuotedStr(sNomeNovo)+' where CONVENIO='+QuotedStr(sNomeVolta)+'');
    Form7.ibDataSet2.Open;
    //
  end;
  //
  if AllTrim(ibDataSet29NOME.AsString) = '' then ibDataSet29.Delete;
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet29BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  if AllTrim(Form7.ibDataSet29NOME.AsString) <> '' then
  begin
    //
    sApagar := '';
    //
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.SelectSql.Clear;
    Form7.ibDataSet2.SelectSql.Add('select * from CLIFOR where CONVENIO <> ''''');
    Form7.ibDataSet2.Open;

    Form7.ibDataSet2.First;
    while not Form7.ibDataSet2.Eof do
    begin
      if AllTrim(Form7.ibDataSet2CONVENIO.AsString) = AllTrim(Form7.ibDataSet29NOME.AsString) then sApagar := 'Este registro no pode ser apagado por'+Chr(10)+'estar relacionado ao cadastro de clientes.';
      Form7.ibDataSet2.Next;
    end;

    if sApagar <> '' then
    begin
      //ShowMessage(sApagar); Mauricio Parizotto 2023-10-25
      MensagemSistema(sApagar);
      Abort;
    end;
  end;
  RegistraExclusaoRegistro(ibDataSet29)
end;

procedure TForm7.ibDataSet29DESCONTOSetText(Sender: TField;
  const Text: String);
begin
  if Alltrim(ibDataSet29NOME.AsString) = '' then Form7.ibDataSet29.Delete else ibDataSet29DESCONTO.AsString := Text;;
end;

procedure TForm7.ibDataSet30NewRecord(DataSet: TDataSet);
begin
  ibDataSet30REGISTRO.AsString := sProximo;
  ibDataSet30CODIGO.AsString   := ibDataSet4CODIGO.AsString;
  ibDataSet30.Post;
  ibDataSet30.Edit;
end;
procedure TForm7.ibDataSet30FilterRecord(DataSet: TDataSet;
  var Accept: Boolean);
begin
  if ibDataSet30CODIGO.AsString = ibDataSet4CODIGO.AsString then Accept := True else Accept := False;

end;

procedure TForm7.Receberconvnio1Click(Sender: TObject);
begin
  Form37.Caption := 'Receber convnio';
  if Form7.ibDataSet29.MoveBy(+1) = 1 then
    Form7.ibDataSet29.MoveBy(-1)
  else
    if Form7.ibDataSet29.MoveBy(-1) = -1 then
      ArquivoAberto.MoveBy(+1);
  Form37.Panel3.Visible := True;
  Form37.ShowModal;
  Form37.Caption := 'Relatrio de comisses';
  Form37.Panel3.Visible := False;
end;

procedure TForm7.Acertodecontasde1Click(Sender: TObject);
var
  F: TextFile;
  fTotal, fTotal1 : Real;
  I : Integer;
  sNome : String;
begin
  try
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  
    try
      Rewrite(F);                           // Abre para gravao
    except
      //ShowMessage('No foi possvel gravar no arquivo '+'ARQU001.HTM'+Chr(10)+Chr(10)+'Este programa ser fechado.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('No foi possvel gravar no arquivo '+'ARQU001.HTM'+Chr(10)+Chr(10)+'Este programa ser fechado.',msgAtencao);

      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE );
      Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      FecharAplicacao(ExtractFileName(Application.ExeName)); // Sandro Silva 2024-01-04
    end;

    Writeln(F,'<html><head><title>'+AllTrim(Form7.Acertodecontasde1.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="30">');

    WriteLn(F,'<center><img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font size=3 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font></center>');
    WriteLn(F,'<hr><font face="Microsoft Sans Serif" size=3 color=#000000><b>Cliente: '+AllTrim(Form7.ibDataSet7NOME.AsString)+'</b></font><hr>');

    Form7.ibDataSet7.DisableControls;

    // CONTAS A RECEBER
    fTotal  := 0;
    fTotal1 := 0;
    
    Writeln(F,'<br><font face="Microsoft Sans Serif" size=1><b>CONTAS A RECEBER</b>');
    WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Documento</td>');
    WriteLn(F,'  <td  width=300 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Histrico</td>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Vencimento</td>');
    WriteLn(F,'  <td  width=100 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Valor</td>');
    WriteLn(F,'  <td  width=100 bgcolor=#'+Form1.sHtmlCor+'><font face="Microsoft Sans Serif" size=1>Valor Atual</td>');
    WriteLn(F,' </tr>');
    //
    sNome := Form7.ibDataSet7NOME.AsString;
    //
    Form7.ibDataSet7.First;
    while not (Form7.ibDataSet7.Eof) do
    begin
      if (Form7.ibDataSet7VALOR_RECE.AsFloat = 0) and (AllTrim(Form7.ibDataSet7NOME.AsString) = AllTrim(sNome)) then
      begin
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet7DOCUMENTO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet7HISTORICO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+DateTimeToStr(Form7.ibDataSet7VENCIMENTO.AsDateTime)+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%10.2n',[Form7.ibDataSet7VALOR_DUPL.AsFloat])+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Microsoft Sans Serif" size=1>'+Format('%10.2n',[Form7.ibDataSet7VALOR_JURO.AsFloat])+'</td>');
        WriteLn(F,' </tr>');
        fTotal  := fTotal  + Form7.ibDataSet7VALOR_DUPL.AsFloat;
        fTotal1 := fTotal1 + Form7.ibDataSet7VALOR_JURO.AsFloat;
      end;
      Form7.ibDataSet7.Next;
    end;
    //
    // Totalizador
    //
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal])+'</td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.2n',[fTotal1])+'</td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table><br><br><br>');
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
    I := Application.MessageBox(Pchar('Tem certeza que quer efetuar quitao das contas'
                            + chr(10)+'a receber do cliente '+AllTrim(sNome)+chr(10)
                            +' no valor de R$ '+AllTrim(Format('%12.2n',[fTotal]))+chr(10)
                            +' Conforme apresentado no relatrio?'
                            + Chr(10))
                            ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);
    if I = IDYES then
    begin
      //
      I := Application.MessageBox(Pchar('Imprimir recibo?'
                            + Chr(10))
                            ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION);
      if I = IDYES then
      begin
        Form7.fTotalDoRecibo       := fTotal;
        Form7.sReciboProvenienteDe := 'Referente ao pagamento das duplicatas de '+AllTrim(sNome);
        Form7.sReciboRecebemosDe   := AllTrim(sNome);
        Form7.RECIBOClick(Sender);
      end;

      // CONTAS A RECEBER
      Form7.sModulo := 'AUTOMATICO';

      Form7.ibDataSet7.First;

      while (not Form7.ibDataSet7.Eof) do
      begin
        if (Form7.ibDataSet7VALOR_RECE.AsFloat = 0) and (Form7.ibDataSet7NOME.AsString = sNome) then
        begin
          Form7.ibDataSet7.Edit;
          Form7.ibDataSet7RECEBIMENT.AsDateTime := Date;
          Form7.ibDataSet7VALOR_RECE.AsFloat    := Form7.ibDataSet7VALOR_DUPL.AsFloat;
          Form7.ibDataSet7.Post;
        end;
        Form7.ibDataSet7.Next;
        //
        if ((Form7.ibDataSet7.Eof) and ((Form7.ibDataSet7VALOR_RECE.AsFloat = 0) and (Form7.ibDataSet7NOME.AsString = sNome))) then Form7.ibDataSet7.First;
        //
      end;
      Form7.sModulo := 'RECEBER';
      //
    end;
  except
  end;

  Form7.ibDataSet7.EnableControls;
end;

procedure TForm7.RECIBOClick(Sender: TObject);
var
  rRect : Trect;
  Mais1Ini : TiniFile;
  I, Tamanho, iTamanho, iColunas: Integer;
  sTexto : String;
begin
  try
    //
    Mais1Ini := TIniFile.Create('retaguarda.ini');
    Mais1Ini.UpdateFile;
    //
    //
    if PrintDialog1.Execute then
    begin
      //
      iTamanho := 10;
      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
      Printer.Canvas.Font.Style := [];                // Fonte
      Printer.Canvas.Font.Size  := iTamanho;          // Tamanho da Fonte
      Printer.Canvas.Font.Color := clBlack;           // Cor da Fonte
      Tamanho  := Printer.Canvas.TextWidth('a');       // Tamanho que cada caractere ocupa na impresso em pontos
      icolunas := (Printer.PageWidth div Tamanho)-2;
      //
      if iColunas > 80 then iTamanho := 11;
      if iColunas < 40 then iTamanho := 9;
      if iColunas < 30 then iTamanho := 6;
      //
      if iColunas > 80 then
      begin
        //
        rRect.Top     := Tamanho * 2;
        rRect.Left    := Tamanho * 2;
        rRect.Right   := ((Printer.PageWidth-(Tamanho*2))) div 3;
        rRect.Bottom  := ((Printer.PageWidth-(Tamanho*2)) div 4) div 3;
        //
      end else
      begin
        //
        rRect.Top     := Tamanho;
        rRect.Left    := Tamanho;
        rRect.Right   := (Printer.PageWidth-(Tamanho*2));
        rRect.Bottom  := (Printer.PageWidth-(Tamanho*2)) div 4;
        //
      end;
      ////////////////////////////////////////////////////////
      //         IMPRESSO DO RECIBO EM JATO DE TINTA       //
      ////////////////////////////////////////////////////////
      if FileExists(Form1.sAtual+'\LOGOTIP.BMP') then Form14.Image1.Picture.LoadFromFile('LOGOTIP.BMP');
      //
      Screen.Cursor             := crHourGlass;       // Cursor de Aguardo
      Printer.Canvas.Pen.Width  := 3;                // Largura da linha
      Printer.Canvas.Pen.Style  := psSolid;
      //
      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
      Printer.Canvas.Font.Style := [];                // Fonte
      Printer.Canvas.Font.Size  := iTamanho;          // Tamanho da Fonte
      Printer.Canvas.Font.Color := clBlack;           // Cor da Fonte
      //
      Tamanho  := Printer.Canvas.TextWidth('a');       // Tamanho que cada caractere ocupa na impresso em pontos
      icolunas := (Printer.PageWidth div Tamanho)-2;
      //
      Printer.Title := 'Recibo';                      // Este ttulo  visto no spoool da impressora
      //
      Printer.BeginDoc;   // Inicia o documento de impresso
      //
      Printer.Canvas.Font.Size  := iTamanho;
      Printer.Canvas.StretchDraw(rRect,Form14.Image1.Picture.Graphic);
      //
      // Linha da Margem Superior
      //
      Printer.Canvas.Brush.Style := bsClear;
      Printer.Canvas.Font.Size   := iTamanho;
      Printer.Canvas.Rectangle(10,10, (Printer.PageWidth)-10,(Tamanho * 60)-10);
      //
      // Titulo
      //
      Printer.Canvas.Font.Name  := 'Times';           // Fonte
      Printer.Canvas.Font.Size  := iTamanho * 3;      // Tamanho da Fonte
      Printer.Canvas.Font.Style := [fsBold];  // Coloca em negrito
      Printer.Canvas.TextOut(((Printer.PageWidth div 2) - (Printer.Canvas.TextWidth('Recibo') div 2)),Tamanho * 9,'Recibo');
      //
      // R$ Valor
      //
//      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
//      Printer.Canvas.Font.Size  := iTamanho * 2;        // Tamanho da Fonte
      Printer.Canvas.TextOut(((Printer.PageWidth div 2) - (Printer.Canvas.TextWidth('R$ '+AllTrim(Format('%10.2n',[fTotalDoRecibo]))) div 2)),Tamanho * 14,'R$ '+AllTrim(Format('%10.2n',[fTotalDoRecibo])));
      //
      Printer.Canvas.Font.Name  := 'Microsoft Sans Serif';           // Fonte
      Printer.Canvas.Font.Style := [];
      Printer.Canvas.Font.Size  := iTamanho;
      //
      // Pagador
      //
      sTexto := 'Recebemos de: '+AllTrim(Form7.sReciboRecebemosDe)+' a importncia de ' + AllTrim(Extenso(fTotalDoRecibo)) + ' ' + Form7.sReciboProvenienteDe+Replicate(' ',500);
      //
      for I := 0 to 6 do
      begin
        Printer.Canvas.TextOut(Tamanho * 2,Tamanho * (21 + (I*2)),AllTrim(Copy(sTexto,((I*icolunas)+1),icolunas)));
      end;
      //
      // Local e data de pagamento
      //
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 36,Form7.ibDataSet13.FieldByName('MUNICIPIO').AsString + ' (' + Uppercase(Form7.ibDataSet13.FieldByname('ESTADO').AsString) + '),');
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 38,IntToStr(Day(Date)) + ' de ' + Alltrim(MesExtenso(Month(Date))) + ' de ' + IntToStr(Year(Date)));
      //
      // Assinatura
      // Dados do emitente
      //
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 44, Replicate('_', Length(Form7.ibDataSet13.FieldByName('NOME').AsString)));
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 46,Form7.ibDataSet13.FieldByName('NOME').AsString);
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 48,'CNPJ/CPF: '+Form7.ibDataSet13.FieldByName('CGC').AsString);
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 50,'Insc. Estadual '+Form7.ibDataSet13.FieldByName('IE').AsString);
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 52,AllTrim(Form7.ibDataSet13.FieldByName('ENDERECO').AsString)+' - '+AllTrim(Form7.ibDataSet13.FieldByName('COMPLE').AsString));
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 54,'Fone: '+AllTrim(Form7.ibDataSet13.FieldByName('TELEFO').AsString));
      Printer.Canvas.TextOut(Tamanho * 2,Tamanho * 56,Form7.ibDataSet13.FieldByName('CEP').AsString+' ' + AllTrim(Form7.ibDataSet13.FieldByName('MUNICIPIO').AsString)+' - ' + AllTrim(Uppercase(Form7.ibDataSet13.FieldByname('ESTADO').AsString)));
      //
      Printer.EndDoc;
      Screen.Cursor := crDefault;
      //
    end;
  except end;
end;

procedure TForm7.ibDataSet12BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
  MyBookMark : TBookMark;
begin
  if AllTrim(Form7.ibDataSet12NOME.AsString) <> '' then
  begin
    //
    MyBookMark := Form7.ibDataSet12.GetBookmark;
    sApagar := '';
    Form7.ibDataSet1.DisableControls;
    Form7.ibDataSet1.First;
    while not Form7.ibDataSet1.Eof do
    begin
      if AllTrim(Form7.ibDataSet1NOME.AsString) = AllTrim(Form7.ibDataSet12NOME.AsString) then
      begin
        sApagar := 'Este registro no pode ser apagado por'+Chr(10)+'estar relacionado ao livro caixa.';
        Form7.ibDataSet1.Last;
      end;
      Form7.ibDataSet1.Next;
    end;
    Form7.ibDataSet1.EnableControls;

    if sApagar <> '' then
    begin
      Form7.ibDataSet12.GotoBookmark(MyBookMark);
      //ShowMessage(sApagar);Mauricio Parizotto 2023-10-25
      MensagemSistema(sApagar);
      Abort;
    end;
  end;
  RegistraExclusaoRegistro(ibDataSet12);
end;

procedure TForm7.ibDataSet14NOMESetText(Sender: TField; const Text: String);
begin
  if Valida_Campo('ICM',Text,'NOME','Esta operao j foi cadastrada') then
  ibDataSet14NOME.AsString := Text;
end;

procedure TForm7.ibDataSet1AfterDelete(DataSet: TDataSet);
begin
  //
//  MybookMark := ibDataSet1.GetBookmark;
  if sModulo = 'CAIXA' then CalculaSAldo(True);
//  ibDataSet1.GotoBookmark(MybookMark);
  AgendaCommit(True);
  //
end;

procedure TForm7.Colunas1Click(Sender: TObject);
begin
  //
  Form9.Close;
  Form9.Show;
  //
end;

procedure TForm7.imgLibBloqClick(Sender: TObject);
var
  i : integer;
begin
  if (Form7.sModulo = 'OS')    or
     (Form7.sModulo = 'VENDA') or
     (Form7.sModulo = 'ORCAMENTO') or
     (Form7.sModulo = 'COMPRA')  then
     Abort;

  {$IFDEF VER150}
  if Form7.DBGrid1.Options = [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize] then // Boto Libera
  {$ELSE}
  if Form7.DBGrid1.Options = [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize,dgTitleClick] then // Boto Libera
  {$ENDIF}
  begin
    {$IFDEF VER150}
    Form7.DBGrid1.Options   := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];        // Boto Libera
    {$ELSE}
    Form7.DBGrid1.Options   := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize,dgTitleClick];        // Boto Libera
    {$ENDIF}
    Form7.dbGrid1.ReadOnly  := False;
    Form7.imgLibBloq.Visible  := False; Form7.Label208.Caption  := 'Bloquear';
    Form7.Image308.Visible  := True;

    //Mauricio Parizotto 2023-05-29
    //Seta para ReadOnly para o grid no poder editar
    try
      for i := 0 to Form7.DBGrid1.DataSource.DataSet.FieldCount -1 do
      begin
      if Form7.DBGrid1.DataSource.DataSet.Fields[i].Tag = 10 then
        Form7.DBGrid1.DataSource.DataSet.Fields[i].ReadOnly := True;
      end;
    except
    end;
  end else
  begin
    {$IFDEF VER150}
    Form7.DBGrid1.Options   := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize]; // Boto Libera
    {$ELSE}
    Form7.DBGrid1.Options   := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize,dgTitleClick]; // Boto Libera
    {$ENDIF}
    Form7.dbGrid1.ReadOnly  := True;
    Form7.Image308.Visible  := False;
    Form7.imgLibBloq.Visible  := True; Form7.Label208.Caption  := 'Liberar';
  end;

  dBGrid1.Repaint;

  if ArquivoAberto.Active then
  begin
    if Form7.DBGrid1.CanFocus then Form7.DBGrid1.SetFocus;
    if ArquivoAberto.MoveBy(+1) = 1 then
      ArquivoAberto.MoveBy(-1)
    else
      if ArquivoAberto.MoveBy(-1) = -1 then
        ArquivoAberto.MoveBy(+1);
  end;
end;

procedure TForm7.ibDataSet8VALOR_DUPLChange(Sender: TField);
begin
  if ibDataSet8VALOR_DUPL.AsFloat < 0 then
    ibDataSet8VALOR_DUPL.AsFloat := 0;
  {Sandro Silva 2023-12-27 inicio}
  // F7709 - Caso do banco onde existia registro com VALOR_DUPL e VALOR_PAGO armazenando o valor "INF"  
  if AnsiContainsText(ibDataSet8VALOR_DUPL.AsString, 'INF') then
    ibDataSet8VALOR_DUPL.AsFloat := 0;
  {Sandro Silva 2023-12-27 fim}
end;

procedure TForm7.ibDataSet8VALOR_PAGOChange(Sender: TField);
begin
  if Form10.Visible then
  begin
    if Form10.Button1.CanFocus then
    begin
      Form10.Button1.Default := True;
      Form10.Button1.Default := False;
      Form10.Button1.SetFocus;
    end;
  end;
  if ibDataSet8VALOR_PAGO.AsFloat < 0 then
    ibDataSet8VALOR_PAGO.AsFloat := 0;
  {Sandro Silva 2023-12-27 inicio}
  // F7709 - Caso do banco onde existia registro com VALOR_DUPL e VALOR_PAGO armazenando o valor "INF"
  if AnsiContainsText(ibDataSet8VALOR_PAGO.AsString, 'INF') then
    ibDataSet8VALOR_PAGO.AsFloat := 0;
  {Sandro Silva 2023-12-27 fim}
end;

procedure TForm7.ibDataSet8VALOR_PAGOValidate(Sender: TField);
var
  cNovoID: String;
  cPrimNumDoc: String;
  qryGenerator: TIBQuery;
begin
  if ibDataSet1.Locate('HISTORICO',copy('Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString,1,25),[loPartialKey]) then
  begin
    if AllTrim(Copy(ibDataSet1HISTORICO.AsString,1,25)) = AllTrim(copy('Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString,1,25)) then
    begin
      ibDataSet1.Delete;
    end;
  end;

  {Dailon Parisotto (f-6594) 2023-02-01 Inicio}
  if (ibDataSet8VALOR_PAGO.Value > 0) then
  begin
    if (ibDataSet8VALOR_PAGO.Value < ibDataSet8VALOR_DUPL.Value)
      and (MensagemSistemaPergunta('Criar uma nova conta a pagar no restante do valor?', [mb_YesNo, mb_DefButton1]) = mrYes) then
    begin
      qryGenerator := CriaIBQuery(IBTransaction1);
      try
        qryGenerator.Close;
        qryGenerator.SQL.Clear;
        qryGenerator.SQL.Add('select gen_id(G_PAGAR,1) from rdb$database');
        qryGenerator.Open;

        cNovoID := StrZero(StrToInt(qryGenerator.FieldByname('GEN_ID').AsString),10,0);
      finally
        FreeAndNil(qryGenerator);
      end;
      if copy(ibDataSet8DOCUMENTO.AsString,1,1) = '0' then
        cPrimNumDoc := 'A'
      else
        cPrimNumDoc := Chr(Ord(ibDataSet8DOCUMENTO.AsString[1])+1);
      try
        ibDataSet100.Close;
        ibDataSet100.SelectSql.Clear;
        ibDataSet100.SelectSql.Add('INSERT INTO PAGAR (HISTORICO, PORTADOR, DOCUMENTO, NOME, EMISSAO, VENCIMENTO, VALOR_DUPL, CONTA, NUMERONF, REGISTRO)');
        ibDataSet100.SelectSQL.Add('VALUES (');
        ibDataSet100.SelectSQL.Add(QuotedStr(ibDataSet8HISTORICO.AsString));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(ibDataSet8PORTADOR.AsString));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(cPrimNumDoc + Copy(ibDataSet8DOCUMENTO.AsString, 2, 9)));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(ibDataSet8NOME.AsString));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(DateToStrInvertida(Date)));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(DateToStrInvertida(Date)));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(StrTran(StrZero(ibDataSet8VALOR_DUPL.Value - ibDataSet8VALOR_PAGO.Value, 10, 2),',','.')));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(ibDataSet8CONTA.AsString));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(ibDataSet8NUMERONF.AsString));
        ibDataSet100.SelectSQL.Add(',' + QuotedStr(cNovoID));
        ibDataSet100.SelectSQL.Add(')');
        ibDataSet100.Open;
      finally
        ibDataSet100.Close;
      end;
    end;
  end;
  {Dailon Parisotto (f-6594) 2023-02-01 Fim}

  if ibDataSet8VALOR_PAGO.Value > 0
    then if ibDataSet8PAGAMENTO.AsString = ''
      then ibDataSet8PAGAMENTO.AsDateTime := Date + Time;
  
  if ibDataSet8VALOR_PAGO.Value <> 0 then // Se valor Zero apaga o antigo mas no grava o novo
  begin
    ibDataSet1.Append;
    ibDataSet1DATA.AsDateTime    := ibDataSet8PAGAMENTO.AsDateTime + Time;
    ibDataSet1SAIDA.AsFloat      := ibDataSet8VALOR_PAGO.AsFloat;
    //ibDataSet1HISTORICO.AsString := 'Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString;
    ibDataSet1HISTORICO.AsString := Copy('Pag. doc. '+ibDataSet8DOCUMENTO.AsString+'-'+ibDataSet8NOME.AsString,1,45);
    ibDataSet1NOME.AsString      := ibDataSet8CONTA.AsString;     // contas bancrias
    ibDataSet1.Post;
  end;
end;

procedure TForm7.ibDataSet8NewRecord(DataSet: TDataSet);
begin
  ibDataSet8REGISTRO.AsString := sProximo;
  ibDataSet8VALOR_PAGO.AsFloat    := 0;
  ibDataSet8VALOR_DUPL.AsFloat    := 0;
  ibDataSet8EMISSAO.AsDateTime    := Date;
  { Sugere sempre a data de vencimento de acordo com a configurao }
  ibDataSet8VENCIMENTO.AsDateTime := SomaDias(Date,StrToInt(AllTrim(Form19.MaskEdit4.Text)));
  ibDataSet8PORTADOR.AsString     := '';
end;

procedure TForm7.Sosclientes1Click(Sender: TObject);
begin
  sWhere := 'where CLIFOR='+QuotedStr('C')+ ' ';

  Form7.Close;
  Form7.Show;
  
  Mostrartodososclientesefornecedores1.Checked := False;
end;

procedure TForm7.Sosfornecedores1Click(Sender: TObject);
begin
  sWhere := 'where CLIFOR='+QuotedStr('F')+ ' ';
  
  Form7.Close;
  Form7.Show;

  Mostrartodososclientesefornecedores1.Checked := False;
end;

procedure TForm7.Acertodecontasde2Click(Sender: TObject);
var
  F: TextFile;
  fTotal : Real;
  I : Integer;
  sNome : String;
begin
  try
    DeleteFile(pChar(Senhas.UsuarioPub+'.HTM'));
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    try
      Rewrite(F);                           // Abre para gravao
    except
      //ShowMessage('No foi possvel gravar no arquivo '+'ARQU001.HTM'+Chr(10)+Chr(10)+'Este programa ser fechado.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('No foi possvel gravar no arquivo '+'ARQU001.HTM'+Chr(10)+Chr(10)+'Este programa ser fechado.',msgAtencao);
      
      Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE );
      Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );
      Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
      FecharAplicacao(ExtractFileName(Application.ExeName)); // Sandro Silva 2024-01-04
    end;
    
    Writeln(F,'<html><head><title>'+AllTrim(Form7.Acertodecontasde2.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="30">');
    //
    WriteLn(F,'<center><img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font size=3 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font></center>');
    WriteLn(F,'<hr><font face="Verdana" size=3 color=#000000><b>Fornecedor: '+AllTrim(Form7.ibDataSet8NOME.AsString)+'</b></font><hr>');
    //
    Form7.ibDataSet8.DisableControls;
    //
    // CONTAS A RECEBER
    //
    fTotal  := 0;
    //
    Writeln(F,'<br><font face="Verdana" size=1><b>CONTAS A PAGAR</b>');
    WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Documento</td>');
    WriteLn(F,'  <td  width=300 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Histrico</td>');
    WriteLn(F,'  <td  width=050 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Vencimento</td>');
    WriteLn(F,'  <td  width=100 bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana" size=1>Valor</td>');
    WriteLn(F,' </tr>');
    //
    sNome := Form7.ibDataSet8NOME.AsString;
    //
    Form7.ibDataSet8.First;
    while not (Form7.ibDataSet8.Eof) do
    begin
      if (Form7.ibDataSet8VALOR_PAGO.AsFloat = 0) and (Form7.ibDataSet8NOME.AsString = sNome) then
      begin
        WriteLn(F,' <tr>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+Form7.ibDataSet8DOCUMENTO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+Form7.ibDataSet8HISTORICO.AsString+'</td>');
        Writeln(F,'  <td   bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+DateTimeToStr(Form7.ibDataSet8VENCIMENTO.AsDateTime)+'</td>');
        Writeln(F,'  <td   align=Right bgcolor=#FFFFFFFF><font face="Verdana" size=1>'+Format('%10.2n',[Form7.ibDataSet8VALOR_DUPL.AsFloat])+'</td>');
        WriteLn(F,' </tr>');
        fTotal  := fTotal  + Form7.ibDataSet8VALOR_DUPL.AsFloat;
      end;
      Form7.ibDataSet8.Next;
    end;
    //
    // Totalizador
    //
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+'></td>');
    WriteLn(F,'  <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Verdana" size=1>'+Format('%12.2n',[fTotal])+'</td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table><br><br><br>');
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
    I := Application.MessageBox(Pchar('Tem certeza que quer efetuar o pagamento das contas'
                            + chr(10)+'a pagar do fornecedor '+AllTrim(sNome)+chr(10)
                            +' no valor de R$ '+AllTrim(Format('%12.2n',[fTotal]))+chr(10)
                            +' Conforme apresentado no relatrio?'
                            + Chr(10))
                            ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);
    if I = IDYES then
    begin
      // CONTAS A PAGAR
      Form7.sModulo := 'AUTOMATICO';
      //
      Form7.ibDataSet8.First;
      //
      while (not Form7.ibDataSet8.Eof) do
      begin
        if (Form7.ibDataSet8VALOR_PAGO.AsFloat = 0) and (Form7.ibDataSet8NOME.AsString = sNome) then
        begin
          Form7.ibDataSet8.Edit;
          Form7.ibDataSet8VALOR_PAGO.AsFloat := Form7.ibDataSet8VALOR_DUPL.AsFloat;
          Form7.ibDataSet8.Post;
        end;
        Form7.ibDataSet8.Next;
        //
        if ((Form7.ibDataSet8.Eof) and ((Form7.ibDataSet8VALOR_PAGO.AsFloat = 0) and (Form7.ibDataSet8NOME.AsString = sNome))) then
          Form7.ibDataSet8.First;
      end;
      Form7.sModulo := 'PAGAR';
    end;
  except
  end;

  Form7.ibDataSet8.EnableControls;
end;

procedure TForm7.MenuItem71Click(Sender: TObject);
begin
  if sModulo = 'PAGAR'  then
  begin
    Acertodecontasde1.Visible := False;

    Acertodecontasde2.Visible := True;
    Acertodecontasde2.Caption := 'Pagar contas de: '+Form7.ibDataSet8NOME.AsString;
  end;
end;

procedure TForm7.odas1Click(Sender: TObject);
begin
  // Destaca o menu ativo
  sWhere := '';

  Form7.Close;
  Form7.Show;

  Odas1.Checked         := True;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked := False;
end;

procedure TForm7.Receber2Click(Sender: TObject);
begin
  //
  sWhere := ' where Coalesce(VALOR_RECE,0)=0';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Odas1.Checked          := False;
  Receber2.Checked       := True;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := False;
end;

procedure TForm7.Jrecebidas2Click(Sender: TObject);
begin
  //
  sWhere := ' where VALOR_RECE<>0';
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := True;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := False;
  //
end;

procedure TForm7.Atrasadas3Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_RECE = 0 and VENCIMENTO < CURRENT_DATE';
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := True;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := False;
  //
end;

procedure TForm7.Avencer3Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_RECE = 0 and VENCIMENTO > CURRENT_DATE';
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := True;
  Vencendohoje2.Checked  := False;
  //
end;

procedure TForm7.Vencendohoje2Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_RECE = 0 and VENCIMENTO = CURRENT_DATE';
  //
  Form7.Close;
  Form7.Show;
  //
  Odas1.Checked          := False;
  Receber2.Checked       := False;
  Jrecebidas2.Checked    := False;
  Atrasadas3.Checked     := False;
  Avencer3.Checked       := False;
  Vencendohoje2.Checked  := True;
  //
end;

procedure TForm7.odas2Click(Sender: TObject);
begin
  //
  sWhere := '';
  //
  Form7.Close;
  Form7.Show;
  //
  Form7.odas2.Checked    := True;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Pagar2Click(Sender: TObject);
begin
  //
  sWhere := ' where VALOR_PAGO=0';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := True;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Jpagas2Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO<>0';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := True;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Avencer1Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO=0 and VENCIMENTO > CURRENT_DATE';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := True;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Atrasadas1Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO=0 and VENCIMENTO < CURRENT_DATE';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := True;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := False;
  //
end;

procedure TForm7.Vencendohoje3Click(Sender: TObject);
begin
  //
  sWhere := 'where VALOR_PAGO=0 and VENCIMENTO=CURRENT_DATE';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativo
  //
  Form7.odas2.Checked    := False;
  Form7.Pagar2.Checked    := False;
  Form7.Jpagas2.Checked    := False;
  Form7.Atrasadas1.Checked  := False;
  Form7.Avencer1.Checked     := False;
  Form7.Vencendohoje3.Checked := True;
  //
end;

procedure TForm7.odas3Click(Sender: TObject);
begin
  //
  sWhere := '';
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativ
  //
  Odas3.Checked                  := True;
  Lanamentoscompensados1.Checked  := False;
  Lanamentosnocompensados1.Checked := False;
  //
end;

procedure TForm7.Lanamentoscompensados1Click(Sender: TObject);
begin
  //
  sWhere := 'where NOME=' + QuotedStr(Form1.sEscolhido)+' and COMPENS <>'+QuotedStr('1899/12/30');
  Form7.Close;
  Form7.Show;
  //
  // Destaca o menu ativ
  //
  Odas3.Checked                  := False;
  Lanamentoscompensados1.Checked  := True;
  Lanamentosnocompensados1.Checked := False;
  //
end;

procedure TForm7.Lanamentosnocompensados1Click(Sender: TObject);
var
  I : Integer;
begin
  //
  Screen.Cursor  := crHourGlass;    // Cursor de Aguardo
  sWhere := 'where NOME=' + QuotedStr(Form1.sEscolhido)+' and (COMPENS='+QuotedStr('1899/12/30')+' or coalesce(COMPENS,'+QuotedStr('1899/12/30')+')='+QuotedStr('1899/12/30')+') ';
  Form7.Close;
  Form7.Show;
  //
  sMostra := 'TTTTTFTFFFF';
  with ArquivoAberto do
  begin
    for I := 1 to iCampos do  if copy(sMostra,I,1) = 'T' then Fields[I-1].Visible := True
    else  Fields[I-1].Visible := False;
  end;
  //
end;

procedure TForm7.Label3MouseLeave(Sender: TObject);
begin
  with Sender as tLabel do Font.Style := [];
end;

procedure TForm7.Label3MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  with Sender as tLabel do Font.Style := [fsBold];
end;

procedure TForm7.ibDataSet2BeforeDelete(DataSet: TDataSet);
var
  sApagar : String;
begin
  if AllTrim(Form7.ibDataSet2NOME.AsString) <> '' then
  begin
    sApagar := 'O sistema encontrou lanamentos referentes a este cliente '+Chr(10)+
               'nos seguintes arquivos:'+chr(10)+chr(10);
    // --------------- //
    // Vendas com NF   //
    // --------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIENTE from VENDAS where CLIENTE='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIENTE').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Movimento de vendas'+Chr(10);
    // ---------------- //
    // Vendas no balco //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIFOR from ALTERACA where CLIFOR='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIFOR').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Vendas no balco'+Chr(10);
    // ---------------- //
    // Vendas no balco //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIFOR from ORCAMENT where CLIFOR='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIFOR').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Oramentos'+Chr(10);
    // ---------------- //
    // Contas a receber //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select NOME from RECEBER where NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('NOME').AsString = Form7.ibDataSet2NOME.AsString then  sApagar := sApagar + '      Contas a receber'+Chr(10);
    // --------------- //
    // Compras com NF  //
    // --------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select FORNECEDOR from COMPRAS where FORNECEDOR='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('FORNECEDOR').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      Movimento de compras'+Chr(10);
    // --------------- //
    // OS              //
    // --------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select CLIENTE from OS where CLIENTE='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    //
    if Form1.ibQuery1.FieldByname('CLIENTE').AsString = Form7.ibDataSet2NOME.AsString then sApagar := sApagar + '      OS'+Chr(10);
    // ---------------- //
    // Contas a Pagar   //
    // ---------------- //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.Sql.Clear;
    Form1.ibQuery1.Sql.Add('select NOME from PAGAR where NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' ');
    Form1.ibQuery1.Open;
    
    if Form1.ibQuery1.FieldByname('NOME').AsString = Form7.ibDataSet2NOME.AsString then  sApagar := sApagar + '      Contas a pagar'+Chr(10);
    
    if Length(sApagar) <> 84 then
    begin
      sApagar := sApagar + Chr(10) + Chr(10) + 'Portanto no pode ser apagado.' + Chr(10)
                                             + Chr(10)
                                             + 'Para tornar este cliente inativo entre no menu "Edita"'
                                             + Chr(10) + 'e desabilite a opo "Ativo".' + Chr(10);
      //ShowMessage(sApagar); Mauricio Parizotto 2023-10-25
      MensagemSistema(sApagar,msgAtencao);
      Abort;
    end;
    
    DeleteFile(Pchar('contatos\'+AllTrim(LimpaLetrasPor_(Form7.ibDataSet2NOME.AsString))+'.txt')); // Quando apara o cliente
  end;
  Form7.ibDataSet9.Close;                                                    //
  Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
  Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME=:NOME'); //
  Form7.ibDataSet9.DataSource := DataSource2;
  Form7.ibDataSet9.Open;

  if Form7.ibDataSet9NOME.AsString = Form7.ibDataset2NOME.AsString then
  begin
    try
      if Form7.ibDataSet9.RecordCount > 0  then // Se ambos estiverem vazios, Form7.ibDataSet9NOME.AsString e Form7.ibDataset2NOME.AsString ocorre erro
        Form7.ibDataSet9.Delete;
    except end;
  end;

  RegistraExclusaoRegistro(IBDataSet2);
end;

procedure TForm7.Image_FechaClick(Sender: TObject);
begin
  //
  try
    if Form12.Visible then Form12.Close;
  except end;
  //
  try
    if Form24.Visible then Form24.Close;
  except end;
  //
  Form7.Close;
  Label1.Caption := 'Small Commerce';
  Label2.Caption := 'Small Commerce';
  //
end;

procedure TForm7.Balanas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form7.sModulo   := 'BALANCA';
  Form38.Caption  := 'Exportao de arquivo TXT para balana';
  //
  Form38.Panel1.Visible := True;
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Fechadas1Click(Sender: TObject);
begin
  //
  sWhere := 'where upper(SITUACAO)='+QuotedStr('FECHADA');
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := True;
  //
end;

procedure TForm7.Abertas1Click(Sender: TObject);
begin
  //
  sWhere := 'where upper(SITUACAO)='+QuotedStr('ABERTA');
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := True;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := True ;
  Fechadas1.Checked         := False;
  //
end;

procedure TForm7.MenuItem140Click(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.MenuItem147Click(Sender: TObject);
begin
  //
  sWhere := '';
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := True;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := False;
  //
end;

procedure TForm7.miTermoUsoServicoClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.Image210Click(Sender: TObject);
begin
//  Form6.Show;
end;

procedure TForm7.ibDataSet3TOTAL_FRETChange(Sender: TField);
begin
  TotalizaOS(True,True);
end;

procedure TForm7.imgVisualizarClick(Sender: TObject);
begin
  if (Form7.sModulo = 'ORCAMENTO') then
  begin
    {Dailon Parisotto 2023-10-13 Inicio
    if FileExists(Form1.sAtual+'\ORCAMENTOS\'+'Or?amento '+Form7.ibDataSet97.FieldByname('Or?amento').AsString+'.htm') then
    begin
      ShellExecute( 0,'Open',pChar(Form1.sAtual+'\ORCAMENTOS\'+'Or?amento '+  Form7.ibDataSet97.FieldByname('Or?amento').AsString  +'.htm'),'','', SW_SHOW);
    end else
    begin
      if FileExists(Form1.sAtual+'\Or?amento '+Form7.ibDataSet97.FieldByname('Or?amento').AsString+'.htm') then
      begin
        ShellExecute( 0,'Open',pChar('Or?amento '+  Form7.ibDataSet97.FieldByname('Or?amento').AsString  +'.htm'),'','', SW_SHOW);
      end;
    end;
    }

    ImprimeOrcamento;
    {Dailon Parisotto 2023-10-13 Fim}
    Abort;
  end;
  
  Form38.DateTimePicker1.Date := StrToDate('31/12/1899');
  Form10.Image203Click(Sender);
end;

{Dailon Parisotto 2023-10-13 Inicio}
procedure TForm7.ImprimeOrcamento;
begin
  if IBDataSet97.IsEmpty then
    Exit;

  TImpressaoOrcamento.New
                     .SetTransaction(IBTransaction1)
                     .SetNumeroOrcamento(IBDataSet97.FieldByName('Oramento').AsString)
                     .Imprimir;
end;
{Dailon Parisotto 2023-10-13 Fim}

procedure TForm7.ibDataSet9NewRecord(DataSet: TDataSet);
begin
  ibDataSet9.Edit;
  ibDataSet9REGISTRO.AsString := sProximo;
  //
  if Form7.sWhere  = 'where CLIFOR='+QuotedStr('Vendedor') then
  begin
    ibDataSet9FUNCAO.AsString   := 'VENDEDOR';
  end else
  begin
    ibDataSet9FUNCAO.AsString   := 'TECNICO';
  end;
  //
end;

procedure TForm7.ibDataSet34AfterPost(DataSet: TDataSet);
begin
  if AllTrim(Form7.ibDataSet35DESCRICAO.AsString) = '' then
  begin
    Form7.ibDataSet35.Delete;
    Form7.ibDataSet35.Append;
    Form7.ibDataSet35.Last;

  end;
end;

procedure TForm7.ibDataSet3BeforeDelete(DataSet: TDataSet);
begin
  // Reaproveita o Nmero da OS
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_NUMEROOS,0) from rdb$database');
  IBDataSet99.Open;

  if Form7.ibDataSet3NUMERO.AsString = StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0) then
  begin
    IBDataSet99.Close;
    IBDataSet99.SelectSQL.Clear;
    IBDataSet99.SelectSQL.Add('select gen_id(G_NUMEROOS,-1) from rdb$database');
    IBDataSet99.Open;
  end;

  RegistraExclusaoRegistro(ibDataSet3);
end;

procedure TForm7.Agendada1Click(Sender: TObject);
begin
  //
  sWhere := 'where upper(SITUACAO)='+QuotedStr('AGENDADA');
  Form7.Close;
  Form7.Show;
  //
  MenuItem147.Checked       := False;
  Abertas1.Checked          := False;
  Fechadas1.Checked         := True;
  //
end;

procedure TForm7.Cadastrodetcnicos1Click(Sender: TObject);
begin
  Label1.Caption := 'CADASTRO DE TCNICOS';
  
  Form7.Close;
  Form7.sModulo := 'TECNICO';
  Form7.sTitulo := Label1.Caption;
  Form7.sRPS := 'N';
  Form7.Show;
end;

procedure TForm7.RelatriodepeasemOSabertas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible          := True;
  Form38.Label3.Visible          := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Peas em OS abertas';
  Form38.ShowModal; // Ok
  Form38.Label17.Visible := False;
  IbDataSet3.EnableControls;
  //
end;

procedure TForm7.ibDataSet3SITUACAOChange(Sender: TField);
begin
  //
  if Form7.ibDataSet3SITUACAO.AsString = 'Fechada' then
  begin
    if AllTrim(Form7.ibDataSet3DATA_ENT.AsString) = '' then
    begin
      Form7.ibDataSet3.Edit;
      Form7.ibDataSet3DATA_ENT.AsDateTime := Date;
      //Form7.ibDataSet3HORA_ENT.AsString   := TimeToStr(Time); Mauricio Parizotto 2024-01-03
      Form7.ibDataSet3HORA_ENT.AsString := Copy(TimeToStr(Time),1,5);
    end;
  end else
  begin
    Form7.ibDataSet3.Edit;
    Form7.ibDataSet3DATA_ENT.AsString := '';
    Form7.ibDataSet3HORA_ENT.AsString := '';
  end;
end;

procedure TForm7.Imprimirrecibo1Click(Sender: TObject);
var
  F: TextFile;
  ObservacaoRecibo : string;
  ConfSistema : TArquivosDAT;
begin
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet3CLIENTE.AsString));
  Form7.ibDataSet2.Open;

  {Mauricio Parizotto 2023-11-21 Inicio}
  try
    ConfSistema := TArquivosDAT.Create(Usuario,ibDataSet3.Transaction);
    ObservacaoRecibo := ConfSistema.BD.OS.ObservacaoReciboOS;
  finally
    FreeAndNil(ConfSistema);
  end;

  begin
    CriaJpg('logotip.jpg');
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);
    Writeln(F,'<html><head><title>'+AllTrim(Form7.ibDataSet13NOME.AsString) + ' - RECIBO DE ENTREGA</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<table  border=1  cellspacing=1 cellpadding=5 Width=600 style="border-collapse: collapse"  >');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td  >');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=600>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <P><font face="Microsoft Sans Serif" size=1> '+Form7.ibDataSet13NOME.AsString);
    WriteLn(F,'   <BR>CNPJ: '+Form7.ibDataSet13CGC.AsString+' IE: '+Form7.ibDataSet13IE.AsString);
    WriteLn(F,'   <BR>' + AllTrim(Form7.ibDataSet13ENDERECO.AsString) + ' - ' + AllTrim(Form7.ibDataSet13COMPLE.AsString));
    WriteLn(F,'   <BR>' + AllTrim(Form7.ibDataSet13CEP.AsString) + ' ' + AllTrim(Form7.ibDataSet13MUNICIPIO.AsString) + ' - ' + AllTrim(UpperCase(Form7.ibDataSet13ESTADO.AsString)) );
    WriteLn(F,'   <BR>Telefone: ' + AllTrim(Form7.ibDataSet13TELEFO.AsString));
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'<table>');
    WriteLn(F,'<table  border=0 cellspacing=0 cellpadding=0 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <center><font face="Microsoft Sans Serif" size=4><b>RECIBO DE ENTREGA - OS '+Form7.ibDataSet3NUMERO.AsString+'</b></center>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Cliente: <b>'+Form7.ibDataSet2NOME.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Contato: <b>'+AllTrim(Form7.ibDataSet2CONTATO.AsString)+'</b> Telefone: <b>'+AllTrim(Form7.ibDataSet2FONE.AsString)+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Endereo: <b>'+AllTrim(Form7.ibDataSet2ENDERE.AsString)+' - '+ AllTrim(Form7.ibDataSet2COMPLE.AsString)+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Cidade: <b>'+Form7.ibDataSet2CEP.AsString + ' ' + AllTrim(Form7.ibDataSet2CIDADE.AsString) + ' ' + AllTrim(Form7.ibDataSet2ESTADO.AsString)+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Atendente: <b>'+Form7.ibDataSet3TECNICO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Data da entrada: <b>'+Form7.ibDataSet3DATA.AsString+' '+Form7.ibDataSet3HORA.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Agendado para: <b>'+Form7.ibDataSet3DATA_PRO.AsString+' '+Form7.ibDataSet3HORA_PRO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>Tempo estimado: <b>'+Form7.ibDataSet3TEMPO.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');

    WriteLn(F,'       <font face="Microsoft Sans Serif" size=2>'+Form30.Label14.Caption+': <b>'+Form7.ibDataSet3DESCRICAO.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label15.Caption+': <b>'+Form7.ibDataSet3IDENTIFI1.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label16.Caption+': <b>'+Form7.ibDataSet3IDENTIFI2.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'       <font face="Microsoft Sans Serif" size=2>'+Form30.Label17.Caption+': <b>'+Form7.ibDataSet3IDENTIFI3.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label18.Caption+': <b>'+Form7.ibDataSet3IDENTIFI4.AsString+'</b>');
    WriteLn(F,'   <br><font face="Microsoft Sans Serif" size=2>'+Form30.Label30.Caption+': <b>'+Form7.ibDataSet3GARANTIA.AsString+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    //WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>'+Form30.Label19.Caption+': <b>'+Form7.ibDataSet3PROBLEMA.AsString+'</b>'); Mauricio Parizotto 2023-11-23
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>'+Form30.Label19.Caption+': <b>'+QuebraLinhaHtml(Form7.ibDataSet3PROBLEMA.AsString)+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');
    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    //WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>Observao: <b>'+Form7.ibDataSet3OBSERVACAO.AsString+'</b>');  Mauricio Parizotto 2023-11-23
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>Observao: <b>'+QuebraLinhaHtml(Form7.ibDataSet3OBSERVACAO.AsString)+'</b>');
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    {Mauricio Parizotto 2023-11-21 Inicio}
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF>');
    WriteLn(F,'    <font face="Microsoft Sans Serif" size=2>'+QuebraLinhaHtml(ObservacaoRecibo));
    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    {Mauricio Parizotto 2023-11-21 Inicio}
    WriteLn(F,'</table>');



    WriteLn(F,'<table  border=0 cellspacing=1 cellpadding=5 Width=100%>');
    WriteLn(F,' <tr>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF width=50%>');

    WriteLn(F,'  </td>');
    WriteLn(F,'  <td   bgcolor=#FFFFFF width=50%>');
    WriteLn(F,'   <br><br><br><center><font face="Microsoft Sans Serif" size=2>______________________________________</b>');
    WriteLn(F,'   <br><center><font face="Microsoft Sans Serif" size=2>Assinatura do atendente</b>');

    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    WriteLn(F,'  </td>');
    WriteLn(F,' </tr>');
    WriteLn(F,'</table>');

    WriteLn(F,'<center><font face="Microsoft Sans Serif" size=1></b>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
    + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
    + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br></center>');
    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center>pelo sistema Small Commerce, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a></font></center>');
    WriteLn(F,'</html>');
    CloseFile(F);
    
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  end;
end;

procedure TForm7.ImprimirOrdemdeServio1Click(Sender: TObject);
begin
  //Mauricio Parizotto 2023-11-21
  ImprimeOrdemServico;
end;

procedure TForm7.MenuItem12Click(Sender: TObject);
begin
  Imprimirrecibo1.Caption        := 'Imprimir recibo de entrega da Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  ImprimirOrdemdeServio1.Caption := 'Imprimir Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  Gerarnotafiscalsrie11.Caption  := 'Gerar Nota Fiscal srie 001 da Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;
  Gerarnotafiscalsrie21.Caption  := 'Gerar Nota Fiscal srie 002 da Ordem de Servio '+Form7.ibDataSet3NUMERO.AsString;

  {Mauricio Parizotto 2023-12-28 inicio}
  //if Form7.ibDataSet3SITUACAO.AsString = 'Fechada' then
  if Form7.ibDataSet3NF.AsString <> '' then
  begin
    Gerarnotafiscalsrie11.Enabled := False;
    Gerarnotafiscalsrie21.Enabled := False;
  end else
  begin
    Gerarnotafiscalsrie11.Enabled := True;
    Gerarnotafiscalsrie21.Enabled := True;
  end;

  if Form7.ibDataSet3NFSE.AsString <> '' then
  begin
    GerarNotaFiscaldeServio2.Enabled := False;
  end else
  begin
    GerarNotaFiscaldeServio2.Enabled := True;
  end;

  {Mauricio Parizotto 2023-12-28 fim}
end;

procedure TForm7.Agenda1Click(Sender: TObject);
begin
  // Form6.Show;
end;

procedure TForm7.ibDataSet19ELEMENTOSetText(Sender: TField;
  const Text: String);
var
  I : Integer;
begin
  I := Application.MessageBox('Este campo normalmente no deve ser alterado. Tem certeza que quer alterar este campo?', 'Ateno', mb_OKCancel + mb_DefButton1);
  if I = IDOK then
  begin
    ibDataSet19ELEMENTO.AsString := TExt;
  end else
  begin
    ibDataSet19ELEMENTO.AsString := ibDataSet19ELEMENTO.AsString;
  end;
end;

procedure TForm7.Grade1Click(Sender: TObject);
var
  F: TextFile;
  I, J: Integer;
  vGrade    : array [0..19,0..19] of String; // Cria uma matriz com 100 elementos
begin
  //
  // Processa o movimento antes de imprimir a ficha pois pode alterar a qtd inicial//
  //
  CriaJpg('logotip.jpg');
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
  Rewrite(F);
  Writeln(F,'<html><head><title>'+AllTrim(Form7.ibDataSet13NOME.AsString) + ' - '+Form7.sModulo+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
  WriteLn(F,'<br><font size=3 color=#c0c0c0><b>'+Form7.Caption+'</b></font>');
  //    WriteLn(F,'<table  border=0 cellpadding=10 cellspacing=0><tr><td  >');
  WriteLn(F,'<br><br><font size=4 color=#000000><b>GRADE</b></font>');

  WriteLn(F,'<table  border=0 bgcolor=#FFFFFFFF cellspacing=1 cellpadding=4>');
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  >');
//  WriteLn(F,'   <table  border=0 bgcolor=#000000 cellspacing=1 cellpadding=4>');
  //
  Form7.ibDataSet4.First;
  //
  while not Form7.ibDataSet4.Eof do
  begin
    //
    Form7.ibDataSet10.DisableControls;
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
    begin
      //
      for I := 0 to 19 do for J := 0 to 19 do vGrade[I,J] := '';
      //
      while (Form7.ibDataSet10CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString) and not (Form7.ibDataSet10.EOF) do
      begin
        if AllTrim(Form7.ibDataSet10QTD.AsString) <> '' then
        begin
          if StrToInt(Form7.ibDataSet10COR.AsString) + strtoInt(Form7.ibDataSet10TAMANHO.AsString) <> 0 then
          begin
            vGrade[StrToInt(Form7.ibDataSet10COR.AsString),strtoInt(Form7.ibDataSet10TAMANHO.AsString)] := Form7.ibDataSet10QTD.AsString;
          end;
        end;
        Form7.ibDataSet10.Next;
      end;
      //
      Writeln(F,'    <p align=center><font face="Microsoft Sans Serif" size=2><b>'+AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+'</b>');
      //
      WriteLn(F,'    <table  border=0 bgcolor=#000000 cellspacing=1 cellpadding=4>');
      for J := 0 to 19 do
      begin
        for I := 0 to 19 do
        begin
          if (I=0) and (J=0) then WriteLn(F,'     <tr><td   bgcolor=#'+Form1.sHtmlCor+' align=Right></td>');
          if vGrade[I,J] <> '' then
          begin
            if I = 0 then WriteLn(F,'     </tr><tr>');
            if (I = 0) then WriteLn(F,'      <td   bgcolor=#'+Form1.sHtmlCor+' align=Right><font face="Microsoft Sans Serif" size=1>'+vGrade[I,J]+'</td>') else
               if (J = 0) then WriteLn(F,'      <td   bgcolor=#'+Form1.sHtmlCor+' align=center width=70><font face="Microsoft Sans Serif" size=1>'+vGrade[I,J]+'</td>')
             else WriteLn(F,'      <td   bgcolor=#FFFFFFFF align=Right><font face="Microsoft Sans Serif" size=1>'+Format('%12.'+Form1.ConfCasas+'n',[Abs(StrToFloat(LimpaNumeroDeixandoAVirgula(vGrade[I,J])))])+'</td>');
          end;
        end;
      end;
      //
      WriteLn(F,'     </tr>');
      WriteLn(F,'    </table>');
      Writeln(F,'    <font face="Microsoft Sans Serif" size=2><b>'+ Format('%12.'+Form1.ConfCasas+'n',[Form7.ibDataSet4QTD_ATUAL.AsFloat]) +'</b><br>');

    end;
    //
    Form7.ibDataSet4.Next;
    //
  end;
  //
  WriteLn(F,'    </tr>');
  WriteLn(F,'   </table></td>');
  //
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
  + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><br>');
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
  //
end;

procedure TForm7.Cartadecobrana1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\cobrana.doc'),'','', SW_SHOWMAXIMIZED);
end;

procedure TForm7.Imprimiretiquetaparacobrana1Click(Sender: TObject);
begin
  Screen.Cursor  := crHourGlass;    // Cursor de Aguardo
  Form7.IBDataSet100.DisableControls;
  Form7.IBDataSet2.DisableControls;
  
  Form7.IBDataSet100.Close;
  Form7.IBDataSet100.SelectSQL.Clear;
  Form7.IBDataSet100.SelectSQL.Add('update CLIFOR set COMPRA=(select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)');
  Form7.IBDataSet100.Open;

  Form7.sModulo := 'CLIENTES';
  sWhere := ' where COMPRA<>0 ';
  Form7.IBDataSet2.EnableControls;
  Screen.Cursor  := crDefault;    // Cursor de Aguardo

  Form7.Close;
  Form7.Show;

  try
    Form15 := TForm15.Create(nil);
    Form15.CheckBox2.Checked := True;
    Form15.ShowModal;
  finally
    FreeAndNil(Form15);
  end;

  Form7.Close;

  Form7.sModulo := 'RECEBER';
  Form7.Show;
end;

procedure TForm7.Imprimircartadecobrana1Click(Sender: TObject);
begin
  try
    Form33 := TForm33.Create(nil);
    Form33.ShowModal;
  finally
    FreeAndNil(Form33);
  end;
end;

procedure TForm7.ibDataSet2CEPSetText(Sender: TField; const Text: String);
begin
  Valida_Campo('CLIFOR',Text,'CEP','Auxilio na digitao do CEP.');
  ibDataSet2CEP.AsString := Text;
end;

procedure TForm7.ibDataSet4QTD_ATUALSetText(Sender: TField;
  const Text: String);
var
  bBlocoX : Boolean;  
begin
  //
  try
    if NaoHouveMovimento(Form7.ibDataSet4CODIGO.AsString) then
    begin
      //
      Form7.ibDataSet4QTD_ATUAL.AsString := Text;
      //
    end else
    begin
      //
      try
        //
        Form7.IBQuery1.Close;
        Form7.IBQuery1.SQL.Text := 'select first 1 * from BLOCOX where TIPO = ''REDUCAO''';
        Form7.IBQuery1.Open;
        //
        if Form7.IBQuery1.FieldByName('REGISTRO').AsString = '' then
        begin
          bBlocox := False;
        end else
        begin
          bBlocox := True;
        end;
        //
      except
        bBlocoX := False;
      end;
      //
      if not bBlocoX then
      begin
        if Form1.Modoinventrio1.Checked then
        begin
          Form7.ibDataSet4QTD_ATUAL.AsString := Text;
        end else
        begin
          {
          ShowMessage('A quantidade do estoque no pode ser alterada manualmente.'
          +chr(10)+chr(10)+'Para alterar a quantidade entre em: Configuraes; Modo inventrio;');
          Mauricio Parizotto 2023-10-25}
          MensagemSistema('A quantidade do estoque no pode ser alterada manualmente.'
                          +chr(10)+chr(10)+'Para alterar a quantidade entre em: Configuraes; Modo inventrio;'
                          ,msgAtencao);
        end;
      end else
      begin
        {
        ShowMessage('A quantidade do estoque no pode ser alterada manualmente.'
        +chr(10)+chr(10)+'Para alterar a quantidade deste item somente emitindo um dos seguintes documentos fiscais:'
        +chr(10)+chr(10)+'NF-e de entrada (compra)'
        +chr(10)+'NF-e de sada (venda)'
        +chr(10)+'NFC-e de sada (venda)'
        +chr(10)+'Cupom Fiscal (venda)'+chr(10));
        Mauricio Parizotto 2023-10-25}
        MensagemSistema('A quantidade do estoque no pode ser alterada manualmente.'
                        +chr(10)+chr(10)+'Para alterar a quantidade deste item somente emitindo um dos seguintes documentos fiscais:'
                        +chr(10)+chr(10)+'NF-e de entrada (compra)'
                        +chr(10)+'NF-e de sada (venda)'
                        +chr(10)+'NFC-e de sada (venda)'
                        +chr(10)+'Cupom Fiscal (venda)'+chr(10));
      end;
    end;
  except
    Form7.ibDataSet4QTD_ATUAL.AsString := Text;
  end;
end;

procedure TForm7.AuditaAlteracaoEstoqueManual;
var
  QrySaldo: TIBQuery;
begin  
  QrySaldo := TIBQuery.Create(nil);
  try
    QrySaldo.Close;
    QrySaldo.Database := IBDatabase1;
    QrySaldo.SQL.Add('SELECT QTD_ATUAL');
    QrySaldo.SQL.Add('FROM ESTOQUE');
    QrySaldo.SQL.Add('WHERE');
    QrySaldo.SQL.Add('(CODIGO=:XCOD)');
    QrySaldo.ParamByName('XCOD').AsString := ibDataSet4CODIGO.AsString;
    QrySaldo.Open;

    if QrySaldo.IsEmpty then
      Exit;

    {Mauricio Parizotto 2023-08-11 Inicio}
    {gerando erro quando campo for nulo
    if QrySaldo.FieldByName('QTD_ATUAL').Value <> Form7.ibDataSet4QTD_ATUAL.Value then
      Audita('ALTEROU', 'ESTOQUE', Senhas.UsuarioPub, ibDataSet4CODIGO.AsString + ' - ' + ibDataSet4DESCRICAO.AsString + ' - QUANTIDADE', QrySaldo.FieldByName('QTD_ATUAL').Value, Form7.ibDataSet4QTD_ATUAL.Value);
    }
    if QrySaldo.FieldByName('QTD_ATUAL').AsFloat <> Form7.ibDataSet4QTD_ATUAL.AsFloat then
      Audita('ALTEROU', 'ESTOQUE', Senhas.UsuarioPub, ibDataSet4CODIGO.AsString + ' - ' + ibDataSet4DESCRICAO.AsString + ' - QUANTIDADE', QrySaldo.FieldByName('QTD_ATUAL').AsFloat, Form7.ibDataSet4QTD_ATUAL.AsFloat);
    {Mauricio Parizotto 2023-08-11 Fim}
  finally
    FreeAndNil(QrySaldo);
  end;
end;

procedure TForm7.Resumodevendas1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form38.Label21.Caption := Form7.ibDataSet2NOME.AsString;
  Form38.Label21.Visible := True;
  Form7.sModulo := 'Resumo das vendas';
  Form38.ShowModal; // Ok
  Form38.Label21.Visible := False;
  //
end;

procedure TForm7.DBGrid2DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  //Mauricio Parizotto 2023-01-03
  if Column.Field.DataType = ftMemo then
  begin
    DBGridExibeMemo(DBGrid2, Column, Rect, State, Column.FieldName);
  end;
end;

procedure TForm7.DBGrid2DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  OldBkMode : Integer;
  xRect : tREct;
begin
  //
  dbGrid2.Canvas.Pen.Color   := clBlack;
  dbGrid2.Canvas.Brush.Color := Form7.Panel7.Color;
  dbGrid2.Canvas.Font.Color  := clBlack;
  //
  xRect.Left   := Rect.Left;
  xRect.Top    := -2;
  xRect.Right  := Rect.Right;
  xRect.Bottom := Rect.Bottom-Rect.Top + 2;
  dbGrid2.Canvas.FillRect(XrEct);
  //
  with dbgrid2.Canvas do
  begin
    OldBkMode := SetBkMode(Handle, TRANSPARENT);
    TextOut(Rect.Left+3,3,AllTrim(Field.DisplayLabel));
    dbgrid2.Canvas.Font.Color := clblack;
    SetBkMode(Handle, OldBkMode);
  end;
  //
  if sModulo = 'OS' then
  begin
    Form7.Panel9.Caption  := Format('%14.2n',[Form7.ibDataSet3TOTAL_PECA.AsFloat]);
    Form7.Panel10.Caption := Format('%14.2n',[Form7.ibDataSet3TOTAL_SERV.AsFloat]);
    Form7.Panel10.Repaint;
    Form7.Panel9.Repaint;
  end;
  //
  if sModulo = 'VENDA' then
  begin
    Form7.Panel9.Caption  := Format('%14.2n',[Form7.ibDataSet15MERCADORIA.AsFloat]);
    Form7.Panel10.Caption := Format('%14.2n',[Form7.ibDataSet15SERVICOS.AsFloat]);
    Form7.Panel10.Repaint;
    Form7.Panel9.Repaint;
  end;
  //
  if sModulo = 'COMPRA' then
  begin
    Form7.Panel9.Caption  := Format('%14.2n',[Form7.ibDataSet24MERCADORIA.AsFloat]);
  end;
  //
end;

procedure TForm7.DBGrid3DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  //Mauricio Parizotto 2023-01-03
  if Column.Field.DataType = ftMemo then
  begin
    DBGridExibeMemo(DBGrid3, Column, Rect, State, Column.FieldName);
  end;
end;

procedure TForm7.DBGrid3DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  OldBkMode : Integer;
  xRect : tREct;
begin
  if Field <> nil then // Sandro Silva 2023-09-14
  begin
    //
    dbGrid3.Canvas.Pen.Color := clBlack;
    dbGrid3.Canvas.Brush.Color := Form7.Panel7.Color;
    //
    xRect.Left   := Rect.Left;
    xRect.Top    := -2;
    xRect.Right  := Rect.Right;
    xRect.Bottom := Rect.Bottom - Rect.Top + 2;
    dbGrid3.Canvas.FillRect(XrEct);
    //
    {Sandro Silva 2022-09-23 inicio
    with dbGrid3.Canvas do
    begin
      OldBkMode := SetBkMode(Handle, TRANSPARENT);
      TextOut(Rect.Left + 3, 3, AllTrim(Field.DisplayLabel));
      dbGrid3.Canvas.Font.Color := clblack;
      SetBkMode(Handle, OldBkMode);
    end;
    }
    OldBkMode := SetBkMode(Handle, TRANSPARENT);
    dbGrid3.Canvas.TextOut(Rect.Left + 3, 3, Trim(Field.DisplayLabel));
    dbGrid3.Canvas.Font.Color := clblack;
    SetBkMode(Handle, OldBkMode);
    {Sandro Silva 2022-09-23 fim}
    //
  end;
end;

procedure TForm7.Vendas_1Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);

  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie 001';
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo

  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE 1');
  Mais1Ini.Free;
end;

procedure TForm7.Compras_1Click(Sender: TObject);
begin
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);

  Form7.sModulo := 'COMPRA';
  Form7.sTitulo := 'Notas fiscais de entrada (compras)';
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
end;

procedure TForm7.ibDataSet16AfterPost(DataSet: TDataSet);
begin
  if Form7.sModulo <> 'NAO' then
  begin
    // Descrio em Branco no grava //
    if Form7.sModulo = 'VENDA' then
    begin
      Screen.Cursor := crHourGlass; // Cursor de Aguardo

      {Mauricio Parizotto 2023-06-05 Inicio}
      {
      try
        // Quando no tem produtos cadastrados e pq a NF e de complemento do ICMS
        if Form7.ibDataSet15FINNFE.AsString <> '2' then
        begin
          if (AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> '') or (Form7.ibDataSet15MERCADORIA.AsFloat <> 0) then
          begin
            //fTotalMercadoria := Form7.ibDataSet15MERCADORIA.AsFloat;
            // LogRetaguarda('TForm7.ibDataSet16AfterPost(  item ' + IntToStr(Form7.ibDataSet16.Recno)); // Sandro Silva 2023-05-08
            //Mauricio Parizotto 2023-04-17
            if Form12.vNotaFiscal <> nil then
              Form12.vNotaFiscal.CalculaValores(Form7.ibDataSet15,Form7.ibDataSet16);

          end;
        end else
        begin
          Form12.edtTotalNota.ReadOnly := False;
        end;
      except
      end;
      }

      try
        try
          if (AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> '') or (Form7.ibDataSet15MERCADORIA.AsFloat <> 0) then
          begin
            //Mauricio Parizotto 2023-04-17
            if Form12.vNotaFiscal <> nil then
              Form12.vNotaFiscal.CalculaValores(Form7.ibDataSet15,Form7.ibDataSet16);
          end;
        except
        end;
        if Form7.ibDataSet15FINNFE.AsString = '2' then
        begin
          Form12.edtTotalNota.ReadOnly := False;
        end;
        {Mauricio Parizotto 2023-06-05 Fim}

      finally
        // Tratamento para limpar o valor unitario e o total quando no tem ITEM (DESCRIO/CODIGO) - Stack overflow
        LimparLinhaItemSemItem;
      end;

      AtualizarListaItensAuxiliar;

      Form7.ibDataSet15.EnableControls;
      Screen.Cursor := crDefault;
    end;

    if Form7.sModulo = 'OS' then
      TotalizaOS(True,False);

    if Form7.sModulo = 'VENDA' then
      TotalizaServicos(True);
  end;

  Form7.ibDataSet4.EnableControls;
  Form7.IBQuery14.Close;
  AgendaCommit(True);

  //FreeAndNil(IBQESTOQUE);
end;

procedure TForm7.LimparLinhaItemSemItem;
var
  nRecNo: Integer;
begin
  if ibDataSet16.IsEmpty then
    Exit;
    
  nRecNo := Form7.ibDataSet16.RecNo;
  Form7.ibDataSet16.DisableControls;
  try
    Form7.ibDataSet16.First;
    while not Form7.ibDataSet16.Eof do
    begin
      if (Alltrim(Form7.ibDataSet16DESCRICAO.AsString) = EmptyStr)
          and (Form7.ibDataSet16QUANTIDADE.AsCurrency = 0)
          and (Form7.ibDataSet16UNITARIO.AsCurrency > 0) then
      begin
        if Form7.ibDataSet16.State <> dsEdit then
          Form7.ibDataSet16.Edit;

        LimpaCamposItensNota;

        if Form7.ibDataSet16.State = dsEdit then
          Form7.ibDataSet16.Post;
      end;
      Form7.ibDataSet16.Next;
    end;
  finally
    Form7.ibDataSet16.RecNo := nRecNo;
    Form7.ibDataSet16.EnableControls;
  end;
end;

procedure TForm7.LimpaCamposItensNota;
begin
  Form7.ibDataSet16CODIGO.AsString     := EmptyStr;
  Form7.ibDataSet16DESCRICAO.AsString  := EmptyStr;
  Form7.ibDataSet16TOTAL.AsString      := EmptyStr;
  Form7.ibDataSet16UNITARIO.AsString   := EmptyStr;
  Form7.ibDataSet16QUANTIDADE.AsString := EmptyStr;
  Form7.ibDataSet16CODIGO.AsString     := EmptyStr;
  Form7.ibDataSet16CFOP.AsString       := EmptyStr;
end;

procedure TForm7.AtualizarListaItensAuxiliar;
var
  nRecNo: Integer;
begin
  if (Form1.ConfNegat <> 'No') then
    Exit;

  if CDSItensNotaAux.Active then
    CDSItensNotaAux.Close;

  CDSItensNotaAux.CreateDataSet;

  if not Form12.Showing then
    Exit;
  if (ibDataSet16.IsEmpty) then
    Exit;
    
  nRecNo := Form7.ibDataSet16.RecNo;
  ibDataSet16.DisableControls;
  try
    ibDataSet16.First;
    while not ibDataSet16.Eof do
    begin
      if ibDataSet16DESCRICAO.AsString <> EmptyStr then
      begin
        CDSItensNotaAux.Append;
        CDSItensNotaAuxINDICE.AsInteger   := ibDataSet16.RecNo;
        CDSItensNotaAuxCODIGO.AsString    := ibDataSet16CODIGO.AsString;
        CDSItensNotaAuxDESCRICAO.AsString := ibDataSet16DESCRICAO.AsString;
        CDSItensNotaAuxQTDE.AsCurrency    := ibDataSet16QUANTIDADE.AsCurrency;
        CDSItensNotaAux.Post;
      end;

      ibDataSet16.Next;
    end;
  finally
    Form7.ibDataSet16.RecNo := nRecNo;
    ibDataSet16.EnableControls;
  end;
end;

procedure TForm7.ibDataSet16BeforeDelete(DataSet: TDataSet);
begin
  if Form7.sModulo = 'OS' then
  begin
    if AllTrim(Form7.ibDataSet16NUMERONF.AsString) <> '' then
    begin
      if Form30.Visible then
      begin
        //ShowMessage('No  possvel apagar este item porque foi importado para nota fiscal.'); Mauricio Parizotto 2023-10-25 
        MensagemSistema('No  possvel apagar este item porque foi importado para nota fiscal.',msgAtencao);
        Abort;
      end;
    end;
  end;

  Form1.rReserva := 0;
  //
  Form7.ibDataSet4.Close;
  Form7.ibDataSet4.Selectsql.Clear;
  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
  Form7.ibDataSet4.Open;
  //
  if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet16CODIGO.AsString) and (AllTrim(Form7.ibDataSet4CODIGO.AsString)<>'') then
  begin
    // Grade
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    
    if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString) then
    begin
      try
        // Grade // Quando deleta um item na venda
        Form13.Button2.Enabled := False;
        Form7.sModulo := 'GRADE';
        Form13.Label1.Caption := 'Deletando um item da venda';
        Form13.ShowModal; // Quando deleta um item na venda
        Form7.sModulo := 'VENDA';
        Form13.Button2.Enabled := True;
      except end;
    end;
    //////////////////////////
    // Controle de serie    //
    // Esta rotina cancela  //
    // um item na venda     //
    //////////////////////////
    if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
    begin
      Form7.ibDataSet30.Close;
      Form7.ibDataSet30.SelectSQL.Clear;
      Form7.ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
      Form7.ibDataSet30.Open;
      while not Form7.ibDataSet30.Eof do
      begin
        if Copy(Form7.ibDataSet30NFVENDA.AsString,1,6) = Copy(Form7.ibDataSet15NUMERONF.AsString,4,6) then
        begin
          Form7.ibDataSet30.Edit;
          Form7.ibDataSet30NFVENDA.AsString  := '';
          Form7.ibDataSet30VALVENDA.AsFloat  := 0;
          Form7.ibDataSet30DATVENDA.AsString := '';
        end;
        Form7.ibDataSet30.Next;
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet16NewRecord(DataSet: TDataSet);
begin
  Form7.ibDataSet16REGISTRO.AsString   := sProximo;
  Form7.ibDataSet16SINCRONIA.AsFloat   := 0;                                    // Resolvi este problema as 4 da madrugada no NoteBook em casa
  //
  if Form7.sModulo = 'OS' then
  begin
    Form7.ibDataSet16NUMEROOS.AsString := Form7.ibDataset3NUMERO.AsString;
  end else
  begin
    Form7.ibDataSet16NUMERONF.AsString := Form7.ibDataset15NUMERONF.AsString;
  end;
end;

procedure TForm7.ibDataSet16CFOPSetText(Sender: TField; const Text: String);
begin
  if LimpaNumero(Text) <> '' then
  begin
    if (Length(LimpaNumero(Text)) <> 4) or  ((Copy(LimpaNumero(Text),1,1) <> '5') and (Copy(LimpaNumero(Text),1,1) <> '6') and (Copy(LimpaNumero(Text),1,1) <> '7')) then
      //ShowMessage('CFOP Invlido') Mauricio Parizotto 2023-10-25
      MensagemSistema('CFOP Invlido',msgAtencao)
    else
      Form7.ibDataSet16CFOP.AsString := LimpaNumero(Text);
  end
  else
    Form7.ibDataSet16CFOP.AsString := '';
    
  if Form7.ibDataSet16TOTAL.AsFloat <=0 then
    Form7.ibDataSet16CFOP.AsString := '';
end;

procedure TForm7.ibDataSet16DESCRICAOChange(Sender: TField);
var
  Mais1Ini: TiniFile;
  fQuantidadeVendida: Real;
  sModuloRes, sEstado, sCodigo: String;
  sSerial_: String;
  sTipoEtiqueta, sMensagem: String;
  bButton: Integer;
  sRegistro1:  String;
  bFind: Boolean;
  I: Integer;
  ItemNFe: TItemNFe; 
begin
  try
    //Form7.ibDataSet4.DisableControls; // Sandro Silva 2023-05-08 Teste de otimizao
    try
      if (Form1.bFlag) and (Alltrim(ibDataSet16DESCRICAO.AsString) <> '') then
      begin
        Form1.bFlag        := False;
        bFind              := False;
        fQuantidadeVendida := 1;

        Form7.ibDataSet4.DisableControls;
        Form7.ibDataSet4.Close;
        Form7.ibDataSet4.SelectSQL.Clear;
        Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 order by upper(DESCRICAO)');
        Form7.ibDataSet4.Open;
        Form7.ibDataSet4.First;
        Form7.ibDataSet4.EnableControls;
        Form7.ibDataSet4.First;
        //
        // Procura por: cdigo
        //
        if (Length(Alltrim(Form7.ibDataSet16DESCRICAO.AsString)) <= 5) and (LimpaNumero(Alltrim(Form7.ibDataSet16DESCRICAO.AsString))<>'') then
        begin
          if Form7.ibDataSet16CODIGO.AsString <> Form7.ibDataSet4CODIGO.AsString then
          begin
            Form7.ibDataSet4.Close;
            Form7.ibDataSet4.Selectsql.Clear;
            Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString));
            Form7.ibDataSet4.Open;
          end;
        end;

        if Form7.ibDataSet16DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.AsString then
        begin
          Form7.ibDataSet4.DisableControls;
          Form7.ibDataSet4.Close;
          Form7.ibDataSet4.SelectSQL.Clear;
          Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 order by upper(DESCRICAO)');
          Form7.ibDataSet4.Open;
          //Form7.ibDataSet4.First;
          Form7.ibDataSet4.EnableControls;
          //Form7.ibDataSet4.First;

          // Procura por: cdigo
          if (length(Alltrim(Form7.ibDataSet16DESCRICAO.AsString)) <= 5) and (LimpaNumero(Alltrim(Form7.ibDataSet16DESCRICAO.AsString))<>'') then
          begin
            try
              if StrToInt(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)) <> 0 then
                bFind := Form7.ibDataSet4.Locate('CODIGO',StrZero(StrToInt(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)),5,0),[]);
            except
            end;
          end;
          //
          if Pos(Alltrim(Form7.ibDataSet16DESCRICAO.AsString), Form7.ibDataSet4CODIGO.AsString) = 0 then
          begin
            // Procura pela referencia
            bFind := Form7.ibDataSet4.Locate('REFERENCIA',AllTrim(Form7.ibDataSet16DESCRICAO.AsString),[]);
            if Alltrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4REFERENCIA.AsString) then
            begin
              bFind := Form7.ibDataSet4.Locate('REFERENCIA',AnsiUppercase(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)),[]);
              if Alltrim(AnsiUppercase(Form7.ibDataSet16DESCRICAO.AsString)) = AllTrim(Form7.ibDataSet4REFERENCIA.AsString) then
              begin
                Form7.ibDataSet16DESCRICAO.AsString := Alltrim(AnsiUppercase(Form7.ibDataSet16DESCRICAO.AsString));
              end;
            end;

            // Se o produto no foi encontrado //
            if (Alltrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4REFERENCIA.AsString)) and (UpperCase(Alltrim(Form7.ibDataSet16DESCRICAO.AsString)) <> AllTrim(Form7.ibDataSet4REFERENCIA.AsString)) then
            begin
              //  produto pesado //
              if (Length(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)) = 13) and
               (Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),1,1) = '2' ) then
              begin
                bFind := Form7.ibDataSet4.Locate('REFERENCIA',Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),1,7),[]);
                if Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),1,7) = AllTrim(Form7.ibDataSet4REFERENCIA.AsString) then
                begin
                  try
                    try
                      Mais1ini               := TIniFile.Create('FRENTE.INI');
                      sTipoEtiqueta          := Mais1Ini.ReadString('Frente de caixa' , 'Tipo etiqueta','KG');
                      Mais1Ini.Free;
                    except
                      sTipoEtiqueta := 'KG';
                    end;

                    if sTipoEtiqueta = 'KG' then
                    begin
                      if UpperCase(AllTrim(Form7.ibDataSet4MEDIDA.AsString)) = 'KU' then
                      begin
                        fQuantidadeVendida := StrToFloat(Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),8,5));
                      end else
                      begin
                        fQuantidadeVendida := StrToFloat(Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),8,5)) / 1000;
                      end;
                    end else
                    begin
                      fQuantidadeVendida := StrToFloat(Copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString),8,5)) / Form7.ibDataSet4.FieldByname('PRECO').AsFloat;
                    end;
                  except
                  end;
                end;
              end else
              begin
                // Procura pela descrico
                Form7.ibDataSet99.Close;
                Form7.ibDataSet99.SelectSQL.Clear;
                // Sandro Silva 2023-08-17 Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 and upper(DESCRICAO)='+QuotedStr(UpperCase(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)))+' order by upper(DESCRICAO)'); // Maa Verde
                // where no campo descricao tirando espaos do incio e final do texto gravado no campo porque no dataset16descricao so eliminados do texto os espaos do incio e final
                Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 and upper(trim(DESCRICAO))='+QuotedStr(UpperCase(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)))+' order by upper(DESCRICAO)'); // Maa Verde
  //              Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(AllTrim(ibDataSet16DESCRICAO.AsString))+'%')+' order by upper(DESCRICAO)');
                Form7.ibDataSet99.Open;
                Form7.ibDataSet99.First;
  //              if Pos(UpperCAse(AllTrim(ibDataSet16DESCRICAO.AsString)),UpperCase(ibDataset99.FieldByname('DESCRICAO').AsString))<>0 then bFind := Form7.ibDataSet4.Locate('DESCRICAO',ibDataset99.FieldByname('DESCRICAO').AsString,[]);
                if Pos(UpperCAse(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)),UpperCase(Form7.ibDataset99.FieldByname('DESCRICAO').AsString))<> 0 then
                  bFind := Form7.ibDataSet4.Locate('CODIGO',ibDataset99.FieldByname('CODIGO').AsString,[]); // ibDataSet16DESCRICAOChange
              end;
            end;
          end;
        end
        else
          bFind := True;
        Form7.ibDataSet4.EnableControls;

        //Mauricio Parizotto
        if ibDataSet4.FieldByname('TIPO_ITEM').AsString = '09' then
        begin
          //ShowMessage('O tipo do item NO deve ser "09 - Servio" na guia ICMS.'+chr(10)+'Os servios devem ser informados na tabela abaixo.' ); Mauricio Parizotto 2023-10-25
          MensagemSistema('O tipo do item NO deve ser "09 - Servio" na guia ICMS.'+chr(10)+
                          'Os servios devem ser informados na tabela abaixo.'
                          ,msgAtencao);
                          
          Form7.ibDataSet16.Delete;
        end;

        //  Preenche os dados do arquivo NOTA0001.DBF
        //  se o produto for encontrado
        if bFind then
        begin
          // Grava no arquivo NOTA0001.DBF:
          //
          // 1. Descrico do produto
          // 2. Valor unitrio
          // 3. Quantidade
          // 4. Total
          // 5. Situao tributria
          // 6. Percentual do IPI
          // 7. Peso
          // 7. Cdigo
          //
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16DESCRICAO.AsString := AllTrim(Form7.ibDataSet16DESCRICAO.AsString);
          {Sandro Silva 2022-12-20 inicio}
          Form7.ibDataSet16IDENTIFICADORPLANOCONTAS.Value := Form7.ibDataSet4IDENTIFICADORPLANOCONTAS.Value;
          if Form7.ibDataSet16IDENTIFICADORPLANOCONTAS.AsString = '' then
            Form7.ibDataSet16IDENTIFICADORPLANOCONTAS.Clear;
          {Sandro Silva 2022-12-20 fim}

          {Sandro Silva 2023-05-12 inicio}
          // Valida se PFCP e PFCPST esto vazios (no  nota feita via opo compras/devolver)
          if Form7.ibDataSet16PFCP.AsString = '' then
          begin
            if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCP', Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
              Form7.ibDataSet16PFCP.AsFloat := StrToFloatDef(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCP', Form7.ibDataSet4.FieldByname('TAGS_').AsString)), 0.00);
          end;
          if Form7.ibDataSet16PFCPST.AsString = '' then
          begin
            if LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCPST', Form7.ibDataSet4.FieldByname('TAGS_').AsString)) <> '' then
              Form7.ibDataSet16PFCPST.AsFloat := StrToFloatDef(LimpaNumeroDeixandoAvirgula(RetornaValorDaTagNoCampo('FCPST', Form7.ibDataSet4.FieldByname('TAGS_').AsString)), 0.00);
          end;
          {Sandro Silva 2023-05-12 fim}

          if Form7.ibDataSet16CODIGO.AsString <> Form7.ibDataSet4CODIGO.AsString then
          begin
            //if (ibDataSet4QTD_ATUAL.AsFloat <= 0) and (Form1.ConfNegat = 'No') and (TestarNatOperacaoMovEstoque) and (ProdutoComposto(Form7.ibDataSet4.Transaction, Form7.ibDataSet4CODIGO.AsString) = False) then // Sandro Silva 2023-11-28 if (ibDataSet4QTD_ATUAL.AsFloat <= 0) and (Form1.ConfNegat = 'No') and (TestarNatOperacaoMovEstoque) then Mauricio Parizotto 2024-0-05
            if ( (ibDataSet4QTD_ATUAL.AsFloat <= 0) and (Form1.ConfNegat = 'No') and (TestarNatOperacaoMovEstoque) and (ProdutoComposto(Form7.ibDataSet4.Transaction, Form7.ibDataSet4CODIGO.AsString) = False) ) //Produdo sem composio
              or ( (ibDataSet4QTD_ATUAL.AsFloat <= 0) and (not Form1.ConfPermitFabricarSemQtd) and (TestarNatOperacaoMovEstoque) and (ProdutoComposto(Form7.ibDataSet4.Transaction, Form7.ibDataSet4CODIGO.AsString) = True) ) //Produdo com composio
            then
              VerificaSaldoEstoqueDispItemNota(Form7.ibDataSet16QUANTIDADE.AsFloat)
            else
            begin
              if not Form41.Visible then
              begin
                ///////////////////////
                // Controle de serie //
                ///////////////////////
                if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
                begin
                  sCodigo := Form7.ibDataSet4.FieldByname('CODIGO').AsString;
                  Form7.ibDataSet16.Edit;
                  Form7.ibDataSet16DESCRICAO.AsString := Form7.ibDataSet4DESCRICAO.AsString;
                  Form7.ibDataSet16CODIGO.AsString    := Form7.ibDataSet4CODIGO.AsString;
                  //
                  Form7.ibDataSet16.Edit;
                  Form7.ibDataSet16QUANTIDADE.AsFloat := 0;
                  //
                  sSerial_ := '99';
                  sMensagem := '';
                  //
                  while AllTrim(sSerial_) <> '' do
                  begin
                    //
                    try
                      sRegistro1 := Form7.ibDataSet16REGISTRO.AsString;
                    except end;
                    //
                    sSerial_ := AllTrim(Form1.Small_InputForm('Venda de item','Nmero de srie:','')); // Nf de venda
                    //
                    if sSerial_ <> '' then
                    begin
                      Form7.ibDataSet30.Close;
                      Form7.ibDataSet30.SelectSQL.Clear;
                      Form7.ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString));
                      Form7.ibDataSet30.Open;
                      //
                      while not ibDataSet30.Eof do
                      begin
                        try
                          if ibDataSet30SERIAL.AsString = sSerial_ then
                          begin
                            if AllTrim(ibDataSet30NFVENDA.AsString) = '' then
                            begin
                              Form7.ibDataSet30.Edit;
                              Form7.ibDataSet30NFVENDA.AsString     := Copy(Form7.ibDataSet15NUMERONF.AsString,4,6);
                              Form7.ibDataSet30VALVENDA.AsFloat     := Form7.ibDataSet16UNITARIO.AsFloat;
                              Form7.ibDataSet30DATVENDA.AsDateTime  := Form7.ibDataSet15EMISSAO.AsDateTime;
                              Form7.ibDataSet16QUANTIDADE.AsFloat   := Form7.ibDataSet16QUANTIDADE.AsFloat + 1;
                              fQuantidadeVendida              := Form7.ibDataSet16QUANTIDADE.AsFloat;
                              Form7.ibDataSet16.Post;
                              //
                              Form1.bFlag := False;
                              //
                              Form7.ibDataSet16.Append;
                              Form7.ibDataSet16DESCRICAO.AsString := 'SERIAL ' +  ibDataSet30SERIAL.AsString;
                              Form7.ibDataSet16.Post;
                              Form7.ibDataSet16.Locate('REGISTRO',sRegistro1,[]);
                              Form7.ibDataSet16.Edit;
                              //
                              try
                                Form7.ibDataSet4.Close;
                                Form7.ibDataSet4.Selectsql.Clear;
                                Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(sCodigo)+' ');  //
                                Form7.ibDataSet4.Open;
                              except end;
                              //
                              Form1.bFlag := True;
                              //
                              sSerial_ := '0CONFIRMADO0';
                              sMensagem := '';
                            end else
                            begin
                              sMensagem := 'Nmero de srie j vendido.';
                            end;
                          end;
                          //
                        except end;
                        //
                        Form7.ibDataSet30.Next;
                      end;
                    end;

                    try
                      if (sMensagem = 'Nmero de srie j vendido.') then
                        //ShowMessage(sMensagem) Mauricio Parizotto 2023-10-25
                        MensagemSistema('Nmero de srie j vendido.',msgAtencao)
                      else if (sSerial_ <> '0CONFIRMADO0') and (sSerial_ <> '') then
                        //ShowMessage('Nmero de srie no encontrado no produto: '+Chr(10)+ibDataSet4DESCRICAO.AsString); Mauricio Parizotto 2023-10-25
                        MensagemSistema('Nmero de srie no encontrado no produto: '+Chr(10)+ibDataSet4DESCRICAO.AsString,msgAtencao);
                    except
                    end;
                  end;
                end;
              end;

              Form7.ibDataSet16.Edit;
              Form7.ibDataSet16DESCRICAO.AsString := Form7.ibDataSet4DESCRICAO.AsString;
              Form7.ibDataSet16CODIGO.AsString    := Form7.ibDataSet4CODIGO.AsString;
              if Form7.ibDataSet16QUANTIDADE.AsFloat = 0 then
                Form7.ibDataSet16QUANTIDADE.AsFloat := 0;

              // Sandro Silva 2023-05-18 if (Form7.ibDataSet15FINNFE.AsString = '4') and (Form7.Tag = 999) then // Devolucao Devoluo
              if (NFeFinalidadeDevolucao(Form7.ibDataSet15FINNFE.AsString)) and (Form7.Tag = 999) then // Devolucao Devoluo
              begin
                // No faz nada est importando a NF para Devoluo
              end else
              begin
                // Desconto pelo convnio
                if AllTrim(Form7.ibDataSet2CONVENIO.AsString) <> '' then
                begin
                  Form7.ibDataSet29.Locate('NOME', Form7.ibDataSet2CONVENIO.AsString,[]);
                  if Form7.ibDataSet29DESCONTO.AsFloat <> 0 then
                  begin
                    bButton := Application.MessageBox(Pchar('Confirma um desconto de: % ' + AllTrim(Format('%12.2n',[Form7.ibDataSet29DESCONTO.AsFloat])) +
                      Chr(10) + 'Conforme convnio: ' + Form7.ibDataSet29NOME.AsString+
                      Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
                      //
                    if bButton = IDYES then
                      Form7.ibDataSet16UNITARIO.AsFloat    := Int(Form7.ibDataSet4PRECO.AsFloat * ( 1 - (Form7.ibDataSet29DESCONTO.AsFloat/100)) * StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco))))/StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco)))
                    else
                      Form7.ibDataSet16UNITARIO.AsFloat := Int(ibDataSet4PRECO.AsFloat * StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco))))/StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco)));
                  end
                  else
                    Form7.ibDataSet16UNITARIO.AsFloat   := Int(ibDataSet4PRECO.AsFloat * StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco))))/StrToInt('1'+Replicate('0',StrToInt(Form1.ConfPreco)));
                end else
                begin
                  // Sandro Silva 2023-04-26 Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat, StrToInt(Form1.ConfPreco));
                  // Sandro Silva 2023-05-29 Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(CorrigeCustoCompraNaVenda(Form7.ibDataSet4CUSTOCOMPR.AsFloat), StrToInt(Form1.ConfPreco));
                  //
                  // Venda pelo custo
                  //
                  if Pos('0',Form7.ibDataSet14INTEGRACAO.AsString) = 0 then // Se no tiver configurao de integrao para usar o preo de compra na venda, usar o preo de venda cadastrado no estoque
                  begin
                    Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
                  end else
                  begin
                    Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(CorrigeCustoCompraNaVenda(Form7.ibDataSet4CUSTOCOMPR.AsFloat), StrToInt(Form1.ConfPreco));
                  end;
                  //
                end;
                //
              end;
              //
              Form7.ibDataSet16ST.AsString        := Form7.ibDataSet4ST.AsString;
              Form7.ibDataSet16MEDIDA.AsString    := Form7.ibDataSet4MEDIDA.AsString;
              Form7.ibDataSet16IPI.AsFloat        := Form7.ibDataSet4IPI.AsFloat;
              Form7.ibDataSet16PESO.AsFloat       := Form7.ibDataSet4PESO.AsFloat;
              Form7.ibDataSet16CUSTO.AsFloat      := CorrigeCustoCompraNaVenda(Form7.ibDataSet4CUSTOCOMPR.AsFloat); // Sandro Silva 2023-04-26 Form7.ibDataSet16CUSTO.AsFloat      := Form7.ibDataSet4CUSTOCOMPR.AsFloat;
              Form7.ibDataSet16LISTA.AsFloat      := Form7.ibDataSet4PRECO.AsFloat;
              //
              // Grade
              //
              if Form7.ibDataSet16DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString then
              begin
                //
                Form7.ibDataSet10.Close;
                Form7.ibDataSet10.SelectSQL.Clear;
                Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
                Form7.ibDataSet10.Open;
                Form7.ibDataSet10.First;
                //
                Form7.ibDataSet16.Edit;
                //
                if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
                begin
                  Form7.ibDataSet10.Close;
                  Form7.ibDataSet10.SelectSQL.Clear;
                  Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
                  Form7.ibDataSet10.Open;
                  Form7.ibDataSet10.First;
                  //
                  Form7.ibDataSet16.Edit;
                  //
                  if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
                  begin
                    // Cadastro do item na VENDA quantidade geralemtne = 1
                    if (Form7.ibDataSet16QUANTIDADE.AsFloat = 0) or (Form7.ibDataSet4.FieldByname('SERIE').Value = 1) then
                    begin
                      Form1.rReserva := 0;
                      Form13.Label1.Caption := 'Cadastro do item na venda';
                      Form13.ShowModal; //  Cadastro do item na VENDA quantidade geralemtne = 1
                      //
                      // Mostra como comentrio
                      //
                      Form7.ibDataSet16.Post;
                      //
                      sRegistro1 := Form7.ibDataSet16REGISTRO.AsString;
                      //
                      Form7.ibDataSet16.Append;
                      Form7.ibDataSet16DESCRICAO.AsString := Form1.sGrade;
                      Form7.ibDataSet16.Post;
                      //
                      Form7.ibDataSet16.Locate('REGISTRO',sRegistro1,[]);
                      //
                      Form7.ibDataSet16.Edit;
                    end;
                  end;
                end;

                if (Form7.ibDataSet16QUANTIDADE.AsFloat = 0) and (Form7.ibDataSet16DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString) then
                begin
                  Form7.ibDataSet16.Edit;
                  Form7.ibDataSet16QUANTIDADE.AsFloat := fQuantidadeVendida;
                end;
              end;
            end;

            // Comentrio do produto
            for I := 1 to 9 do
            begin
              if (Pos('<Obs'+IntToStr(I)+'>',Form7.ibDataSet4TAGS_.AsString) <> 0) and (Pos('</Obs'+IntToStr(I)+'>',Form7.ibDataSet4TAGS_.AsString) > Pos('<Obs'+IntToStr(I)+'>',ibDataSet4TAGS_.AsString)) then
              begin
                // Mostra como comentrio
                sModuloREs := Form7.sMoDulo;
                Form7.sMoDulo := 'No';

                Form7.ibDataSet16.Post;

                sRegistro1 := Form7.ibDataSet16REGISTRO.AsString;

                Form7.ibDataSet16.Append;
                Form1.bFlag := False;
                Form7.ibDataSet16DESCRICAO.AsString := Copy(Copy(Form7.ibDataSet4TAGS_.AsString,Pos('<Obs'+IntToStr(I)+'>',Form7.ibDataSet4TAGS_.AsString)+6,(Pos('</Obs'+IntToStr(I)+'>',ibDataSet4TAGS_.AsString)-Pos('<Obs'+IntToStr(I)+'>',ibDataSet4TAGS_.AsString))-6),1, ibDataSet4DESCRICAO.Size);
                Form7.ibDataSet16.Post;

                Form7.ibDataSet16.Locate('REGISTRO',sRegistro1,[]);

                Form7.ibDataSet16.Edit;
                Form7.sMoDulo := sModuloRes;
              end;
            end;
          end;

          if (Form7.sModulo = 'VENDA') or (Form7.sModulo = 'RETRIBUTA') then
          begin
            if Form7.ibDataSet15OPERACAO.AsString <> Form7.ibDataSet14NOME.AsString then
            begin
              Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);       //
            end;

            try
              // Verifica se pode usar tributao interestadual
              if UpperCase(Copy(Form7.ibDataSet2IE.AsString,1,2)) = 'PR' then // Quando  produtor rural no precisa ter CGC
              begin
                sEstado := UpperCAse(Form7.ibDataSet2ESTADO.AsString);
                if AllTrim(Form7.ibDataSet2CGC.AsString) = '' then
                  sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString); // Quando  produtor rural tem que ter CPF
              end else
              begin
                if AllTrim((Limpanumero(Form7.ibDataSet2IE.AsString))) <> '' then
                  sEstado := Form7.ibDataSet2ESTADO.AsString
                else
                  sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
                if not CpfCgc(LimpaNumero(Form7.ibDataSet2CGC.AsString)) then
                  sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
                if Length(AllTrim(Form7.ibDataSet2CGC.AsString)) <= 14 then
                  sEstado := UpperCase(Form7.ibDataSet13ESTADO.AsString);
              end;

              sEstado := Form7.ibDataSet2ESTADO.AsString;

              if Pos('1'+sEstado+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX2') = 0 then
                sEstado := 'MG';

              // CFOP Dinamico
              if (Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '107') and (Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '108') then // Esta faixa no muda dentro e fora do estado DOUGLAS - Electra - Sara Suporte
              begin
                if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '5') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '6') then
                begin
                  try
                    if AllTrim(Form7.ibDataSet2ESTADO.AsString) = 'EX' then
                    begin
                      Form7.ibDataSet14.Edit;
                      Form7.ibDataSet14CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5);
                      Form7.ibDataSet14.Post;
                    end else
                    begin
                      Form7.ibDataSet14.Edit;
                      if (sEstado = UpperCase(Form7.ibDataSet13ESTADO.AsString)) or (AllTrim(Form7.ibDataSet2ESTADO.AsString)='') then
                        Form7.ibDataSet14CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5)
                      else
                        Form7.ibDataSet14CFOP.AsString := '6'+copy(Form7.ibDataSet14CFOP.AsString,2,5); // Ok
                      Form7.ibDataSet14.Post;
                    end;

                    try
                      if (Form12.Edit3.Text = '1-Consumidor Final') and (Form7.ibDataSet13ESTADO.AsString <> Form7.ibDataSet2ESTADO.AsString) then
                      begin
                        Form7.ibDataSet16PFCPUFDEST.Visible := True;
                        Form7.ibDataSet16PICMSUFDEST.Visible := True;
                      end else
                      begin
                        Form7.ibDataSet16PFCPUFDEST.Visible := False;
                        Form7.ibDataSet16PICMSUFDEST.Visible := False;
                      end;
                      //
                      if AllTrim(Form7.ibDataSet2ESTADO.AsString)='EX' then
                      begin
                        Form7.ibDataSet16PFCPUFDEST.Visible := False;
                        Form7.ibDataSet16PICMSUFDEST.Visible := False;
                      end;
                    except end;
                    //
                  except end;
                end;
              end;

              if Form7.ibDataSet14.FieldByName(sEstado+'_').AsFloat <> 0 then
              begin
                // Se o ST do produto for <> de zero pode
                // ser que este produto tenha uma aliquota
                // reduzida, ou tributado de ISS
                if AllTrim(Form7.ibDataSet4ST.Value) <> '' then       // Quando alterar esta rotina alterar tambm retributa Ok 1/ Abril
                begin
                  // Nova rotina para posicionar na tabla de CFOP
                  Form7.IBQuery14.Close;
                  Form7.IBQuery14.SQL.Clear;
                  Form7.IBQuery14.SQL.Add('select * from ICM where ST='+QuotedStr(Form7.ibDataSet4ST.AsString)+''); // Nova rotina
                  Form7.IBQuery14.Open;

                  if AllTrim(Form7.IBQuery14.FieldByName('ST').AsString) <> AllTrim(Form7.ibDataSet4ST.AsString) then
                  begin
                    Form7.IBQuery14.Close;
                    Form7.IBQuery14.SQL.Clear;
                    Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                    Form7.IBQuery14.Open;
                  end else
                  begin
                    // Joga p/obs a obs na tabela de icm
                    ObservacaoProduto(False); // Obs do ibDAtaSet14 relacionado ao item
                  end;
                end else
                begin
                  Form7.IBQuery14.Close;
                  Form7.IBQuery14.SQL.Clear;
                  Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                  Form7.IBQuery14.Open;
                end;
              end else
              begin
                Form7.IBQuery14.Close;
                Form7.IBQuery14.SQL.Clear;
                Form7.IBQuery14.SQL.Add('select * from ICM where NOME='+QuotedStr(Form7.ibDataSet15OPERACAO.AsString)+' ');
                Form7.IBQuery14.Open;
              end;
            except
            end;

            // Se o UF do cliente for invlido ocorre um erro
            try
              Form7.ibDataSet16.Edit;

              // Sandro Silva 2023-05-18 if Form7.ibDataSet15FINNFE.AsString <> '4' then // Devolucao Devoluo
              if NFeFinalidadeDevolucao(Form7.ibDataSet15FINNFE.AsString) = False then // Devolucao Devoluo
              begin
                if AllTrim(Form7.ibDataSet14CFOP.AsString) <> '' then
                begin
                  if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '7') and (Copy(Form7.ibDataSet14CFOP.AsString,1,1) <> '3') then // Exportao
                  begin
                    try
                      if (Form12.Edit3.Text = '1-Consumidor Final') and (Form7.ibDataSet13ESTADO.AsString <> Form7.ibDataSet2ESTADO.AsString) then
                      begin
                        Form7.ibDataSet16PFCPUFDEST.Visible  := True;
                        Form7.ibDataSet16PICMSUFDEST.Visible := True;
                      end else
                      begin
                        Form7.ibDataSet16PFCPUFDEST.Visible  := False;
                        Form7.ibDataSet16PICMSUFDEST.Visible := False;
                      end;
                    except
                    end;

                    if AllTrim(Form7.ibDataSet2ESTADO.AsString) = 'EX' then
                    begin
                      Form7.ibDataSet16CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5);
                      Form7.ibDataSet16PFCPUFDEST.Visible  := False;
                      Form7.ibDataSet16PICMSUFDEST.Visible := False;
                    end else
                    begin
                      if (Form7.ibDataSet16DESCRICAO.AsString <> EmptyStr) then
                      begin
                        if (Form7.IBDataSet2ESTADO.AsString = UpperCase(Form7.ibDataSet13ESTADO.AsString)) or (AllTrim(Form7.ibDataSet2ESTADO.AsString)='') then
                          Form7.ibDataSet16CFOP.AsString := '5'+copy(Form7.ibDataSet14CFOP.AsString,2,5)
                        else
                          Form7.ibDataSet16CFOP.AsString := '6'+copy(Form7.ibDataSet14CFOP.AsString,2,5); // Ok
                      end;
                    end;
                  end;
                end;

                // certo
                Form7.ibDataSet16IPI.AsFloat     := Form7.ibDataSet4IPI.AsFloat;
                Form7.ibDataSet16ISS.AsFloat     := Form7.ibQuery14.FieldByName('ISS').AsFloat;
                Form7.ibDataSet16BASE.AsFloat    := Form7.ibQuery14.FieldByName('BASE').AsFloat;
                Form7.ibDataSet16BASEISS.AsFloat := Form7.ibQuery14.FieldByName('BASEISS').AsFloat;
                Form7.ibDataSet16ICM.AsFloat     := Form7.ibQuery14.FieldByName(sEstado+'_').AsFloat;

                Form7.ibDataSet16CST_IPI.AsString     := Form7.ibDataSet4CST_IPI.AsString;   // Cst do IPI no estoque
                Form7.ibDataSet16CST_ICMS.AsString    := Form7.ibDataSet4CST.AsString;       // CST do ICMS no estoque

                try
                  if Form7.ibDataSet13.FieldByName('CRT').AsString = '1' then
                  begin
                    ItemNFe := TItemNFe.Create;
                    CsosnComOrigemdoProdutoNaOperacao(Form7.ibDataSet16CODIGO.AsString, Form7.ibDataSet15OPERACAO.AsString, ItemNFe);
                    Form7.ibDataSet16CSOSN.AsString := ItemNFe.CSOSN;
                  end;
                except

                end;
                
                if ItemNFe <> nil then
                  FreeAndNil(ItemNFe);
              end;

              {Sandro Silva 2022-09-28 inicio}
              //Ficha 6273
              if (Form7.ibDataSet16DESCRICAO.AsString <> EmptyStr) then
              begin
                if (AllTrim(Form7.ibQuery14.FieldByName('CFOP').AsString) <> EmptyStr) then
                  Form7.ibDataSet16CFOP.AsString := Copy(Form7.ibDataSet14CFOP.AsString,1,1)+Copy(Form7.ibQuery14.FieldByName('CFOP').AsString,2,3)
                else
                  Form7.ibDataSet16CFOP.AsString := Form7.ibDataSet14CFOP.AsString;
              end;
              {Sandro Silva 2022-09-28 fim}


              {Mauricio Parizotto 2023-06-19 inicio}
              if NFeFinalidadeDevolucao(Form7.ibDataSet15FINNFE.AsString) then // Devolucao
              begin
                //S preenche se campos estiverem em branco
                try
                  if (Form7.ibDataSet13.FieldByName('CRT').AsString = '1') then
                  begin
                    if Form7.ibDataSet16CSOSN.AsString = '' then
                      Form7.ibDataSet16CSOSN.AsString := CampoICMporNatureza('CSOSN',Form7.ibDataSet15OPERACAO.AsString,Form7.ibDataSet15.Transaction);

                    if Form7.ibDataSet16CST_ICMS.AsString = '' then
                      Form7.ibDataSet16CST_ICMS.AsString := '0';
                  end;


                  if (Form7.ibDataSet13.FieldByName('CRT').AsString <> '1')
                    and (Form7.ibDataSet16CST_ICMS.AsString = '') then
                  begin
                    Form7.ibDataSet16CST_ICMS.AsString := CampoICMporNatureza('CST',Form7.ibDataSet15OPERACAO.AsString,Form7.ibDataSet15.Transaction);
                  end;
                except
                end;
              end;
              {Mauricio Parizotto 2023-06-19 fim}
            except
              Form7.ibDataSet16.Edit;
              Form7.ibDataSet16IPI.AsFloat      := 0;
              Form7.ibDataSet16BASE.AsFloat     := 100;
              Form7.ibDataSet16BASEISS.AsFloat  := 0;
              Form7.ibDataSet16ISS.AsFloat      := 0;
              Form7.ibDataSet16ICM.AsFloat      := 0;
            end;

            if not (Form7.ibDataSet4PIVA.AsFloat > 0) then
            begin
              if AllTrim(Form7.ibQuery14.FieldByName('CST').AsString) <> '' then // Tabela de ICM
              begin
                if (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '30') or
                   (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '40') or
                   (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '41') or
                   (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '50') or
                   (Copy(AllTrim(Form7.ibQuery14.FieldByname('CST').AsString),2,2) = '60') then
                begin
                  Form7.ibDataSet16BASE.AsFloat     := 0;
                end;
              end else  //
              begin     // Estoque
                if (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '30') or
                   (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '40') or
                   (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '41') or
                   (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '50') or
                   (Copy(AllTrim(Form7.ibDAtaSet4.FieldByName('CST').AsString),2,2) = '60') then
                begin
                  Form7.ibDataSet16BASE.AsFloat     := 0;
                end;
              end;
            end;
          end;
        end else
        begin
          // DESCRICAO NO CORPO DA NOTA
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16QUANTIDADE.AsString := '';
        end;

        Form1.bFlag := True;
      end;
    except
    end;
    // DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
    // Form12.Label65.Hint := 'Tempo: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0);
    //
    Form7.IBQuery14.Close;
  finally
    // Form7.ibDataSet4.EnableControls; // Sandro Silva 2023-05-08 Teste de otimizao
  end;
end;


procedure TForm7.ibDataSet16DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  // Localiza pela descricao
  if Limpanumero(Text) <> Text then
  begin
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.SelectSQL.Clear;
    Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where Coalesce(Ativo,0)=0 and  upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(Text)+'%')+' order by upper(DESCRICAO)');
    Form7.ibDataSet4.Open;
    Form7.ibDataSet4.First;
    Form7.ibDataSet4.EnableControls;
    //
    if AllTrim(ibDataSet16CODIGO.AsString) <> '' then
    begin
      //////////////////////////
      // Controle de serie    //
      // Esta rotina cancela  //
      // um item na venda     //
      //////////////////////////
      if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
      begin
        ibDataSet30.Close;
        ibDataSet30.SelectSQL.Clear;
        ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
        ibDataSet30.Open;
        while not ibDataSet30.Eof do
        begin
          if Copy(ibDataSet30NFVENDA.AsString,1,6) = Copy(Form7.ibDataSet15NUMERONF.AsString,4,6) then
          begin
            ibDataSet30.Edit;
            ibDataSet30NFVENDA.AsString := '';
          end;
          ibDataSet30.Next;
        end;
      end;
      /////////////////////////////////////////////
    end;
  end;
  //
  ibDataSet16DESCRICAO.AsString := Text;
end;

function TestarNatOperacaoMovEstoque: Boolean;
begin
  Result := (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) = 0);
end;

procedure TForm7.DefineQuantidadeSaldoDisponivelNota;
var
  AnQtdeDisponivel: Currency;
  ProdComposto : Boolean;
begin
  {Mauricio Parizotto 2024-02-05 Inicio}
  ProdComposto := ProdutoComposto(Form7.ibDataSet16.Transaction,
                                  Form7.ibDataSet16CODIGO.AsString);
  {
  if (Form1.ConfNegat <> 'No') then
    Exit;
  }

  if (Form1.ConfNegat <> 'No') and (not ProdComposto) then
    Exit;

  if (Form1.ConfPermitFabricarSemQtd) and (ProdComposto) then
    Exit;

  {Mauricio Parizotto 2024-02-05 Fim}

  if (ibDataSet16TOTAL.Value > 0) then
    Exit;

  if TestarNatOperacaoMovEstoque then
  begin
    AnQtdeDisponivel := RetornarSaldoDisponivelItemNota(Form7.ibDataSet16CODIGO.AsString);

    // Se ta inserindo um item novo e a quantidade 1 for maior q a disponivel seta a disponivel.
    if (AnQtdeDisponivel > 0) and (Form7.ibDataSet16QUANTIDADE.AsFloat = 1) and (AnQtdeDisponivel < Form7.ibDataSet16QUANTIDADE.AsCurrency) then
    begin
      //ShowMessage('O item atual possui ' + FormatFloat('0.' + Replicate('0', StrToInt(Form1.ConfCasas)), AnQtdeDisponivel) + ' em estoque.' + sLineBreak + 'A quantidade do item ser alterada para a quantidade disponvel.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('O item atual possui ' + FormatFloat('0.' + Replicate('0', StrToInt(Form1.ConfCasas)), AnQtdeDisponivel) + ' em estoque.' + sLineBreak + 'A quantidade do item ser alterada para a quantidade disponvel.'
                      ,msgAtencao);
      ibDataSet16QUANTIDADE.OnChange := nil;
      try
        ibDataSet16QUANTIDADE.AsCurrency := AnQtdeDisponivel;
      finally
        ibDataSet16QUANTIDADE.OnChange := ibDataSet16QUANTIDADEChange;
      end;
    end;
  end;
end;

function TForm7.RetornarSaldoDisponivelItemNota(AcItem: String): Currency;
begin
  Result := (ibDataSet4QTD_ATUAL.AsCurrency - RetornarTotalQuantidadeItem(AcItem));
end;

function TForm7.RetornarTotalQuantidadeItem(AcITem: String): Currency;
begin
  Result := 0;

  if CDSItensNotaAux.IsEmpty then
    Exit;

  try
    CDSItensNotaAux.Filtered := False;
    CDSItensNotaAux.Filter := '(CODIGO=' + QuotedStr(AcITem) + ')';
    CDSItensNotaAux.Filtered := True;

    if CDSItensNotaAux.IsEmpty then
      Exit;

    CDSItensNotaAux.First;
    while not CDSItensNotaAux.Eof do
    begin
      if (ibDataSet16.RecNo <> CDSItensNotaAuxINDICE.AsInteger) then
        Result := Result + CDSItensNotaAuxQTDE.AsCurrency;

      CDSItensNotaAux.Next;
    end;
  finally
    CDSItensNotaAux.Filtered := False;
    CDSItensNotaAux.Filter := EmptyStr;
  end;
end;

procedure TForm7.ibDataSet16QUANTIDADEChange(Sender: TField);
var
  fDesconto: Real;
begin
  // Quando altera a quantidade recalcula o valor  //
  // total, mas s quando o valor total  alterado //
  if AllTrim(Form7.ibDataSet16QUANTIDADE.AsString) <> '' then
  begin
    DefineQuantidadeSaldoDisponivelNota;

    if Form7.ibDataSet16QUANTIDADE.AsFloat <> 0 then
    begin
      fDesconto := 0;

      if Form7.ibDataSet16QUANTIDADE.Asfloat >= Form7.ibDataSet4QTD_PRO1.AsFloat then
        fDesconto := form7.ibDataSet4DESCONT1.AsFloat;
      if Form7.ibDataSet16QUANTIDADE.Asfloat >= Form7.ibDataSet4QTD_PRO2.AsFloat then
        fDesconto := form7.ibDataSet4DESCONT2.AsFloat;

      if fDesconto <> 0 then
      begin
        if Form7.sModulo <> 'ORCAMENTO' then
        begin
          if Application.MessageBox(Pchar('Confirma um desconto de: ' + AllTrim(Format('%12.2n',[fDesconto])) + ' % no produto: ' + Form7.ibDataSet4PRECO.AsString),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION) = IDYES then
          begin
            Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat - ( Form7.ibDataSet4PRECO.AsFloat * fDesconto / 100);
          end;
        end;
      end;

      if Arredonda(Form7.ibDataSet16TOTAL.AsFloat,4) <> Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat *  Form7.ibDataSet16UNITARIO.AsFloat,4) then
      begin
        Form7.ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,4);
      end;
      {Sandro Silva 2023-11-28 inicio
      VerificaSaldoEstoqueDispItemNota(Form7.ibDataSet16QUANTIDADE.AsFloat);
      }
      if (ProdutoComposto(Form7.ibDataSet4.Transaction, Form7.ibDataSet4CODIGO.AsString) = False) then
        VerificaSaldoEstoqueDispItemNota(Form7.ibDataSet16QUANTIDADE.AsFloat);
      {Sandro Silva 2023-11-28 fim}
    end else
    begin
      //if Form7.ibDataSet16TOTAL.AsFloat <> 0 then Mauricio Parizotto 2023-06-05
      if (Form7.ibDataSet16TOTAL.AsFloat <> 0) and
        not (NFeFinalidadeComplemento(Form7.ibDataSet15FINNFE.AsString)) then
      begin
        Form7.ibDataSet16TOTAL.AsFloat    := 0;
        Form7.ibDataSet16UNITARIO.AsFloat := 0;
      end;
    end;
  end;
end;

function TForm7.TestarSaldoEstoqueDisponivelNota(AnQtdeInformada: Double; CodProd : string): Boolean;
var
  nSaldoDisp: Currency;
  ProdComposto : Boolean;
begin
  Result := True;

  {Mauricio Parizotto 2024-02-05 Inicio}
  ProdComposto := ProdutoComposto(Form7.ibDataSet4.Transaction,
                                  CodProd);

  {
  if (Form1.ConfNegat <> 'No') then
    Exit;
  }

  if (Form1.ConfNegat <> 'No') and (not ProdComposto) then
    Exit;

  if (Form1.ConfPermitFabricarSemQtd) and (ProdComposto) then
    Exit;

  {Mauricio Parizotto 2024-02-05 Fim}

  if TestarNatOperacaoMovEstoque then
  begin
    nSaldoDisp := RetornarSaldoDisponivelItemNota(ibDataSet16CODIGO.AsString);


    if (nSaldoDisp < 0) or (ibDataSet4QTD_ATUAL.AsCurrency <= 0) or (nSaldoDisp < AnQtdeInformada) then
    begin
      if ibDataSet4QTD_ATUAL.AsCurrency < 0 then
        nSaldoDisp := ibDataSet4QTD_ATUAL.AsCurrency;
      // Necessario remover os eventos para no mostrar mensagem 2 vezes
      Form7.ibDataSet16QUANTIDADE.OnSetText := nil;
      Form7.ibDataSet16QUANTIDADE.OnChange  := nil;
      try
        Result := False;
        MensagemSistema('No  possvel efetuar a venda deste item, saldo insuficiente em estoque para a quantidade informada. Cod. 3.' + sLineBreak +
                        'Saldo atual: ' + FormatFloat('0.' + Replicate('0', StrToInt(Form1.ConfCasas)), nSaldoDisp) + '.'
                        ,msgAtencao);
      finally
        Form7.ibDataSet16QUANTIDADE.OnSetText := ibDataSet16QUANTIDADESetText;
        Form7.ibDataSet16QUANTIDADE.OnChange  := ibDataSet16QUANTIDADEChange;
      end;
    end;

  end;
end;

procedure TForm7.VerificaSaldoEstoqueDispItemNota(AnQtdeInformada: Double);
var
  cPesq: String;
begin
  if Form7.ibDataSet16DESCRICAO.AsString = EmptyStr then
    Exit;

  //Mauricio Parizotto 2023-08-16
  //Se for importao de cupom no valida Estoque - J foi baixado estoque (se mudar mudar deve mudar rotina de incremento estoque quando entra na nota)
  if Copy(ibDataSet14CFOP.AsString,2,3) = '929' then
    Exit;

  if ibDataSet16QUANTIDADE.AsFloat < 0 then
    ibDataSet16QUANTIDADE.AsFloat := 0
  else
  begin

    if (AnsiUpperCase(ibDataSet4DESCRICAO.AsString) <> AnsiUpperCase(ibDataSet16DESCRICAO.AsString)) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select *');
      Form7.ibDataSet4.Selectsql.Add('from ESTOQUE');
      Form7.ibDataSet4.Selectsql.Add('where');
      cPesq := ibDataSet16DESCRICAO.AsString;
      if (LimpaNumero(ibDataSet16DESCRICAO.AsString) = ibDataSet16DESCRICAO.AsString) and (Length(ibDataSet16DESCRICAO.AsString) <= 5) then
      begin
        if Length(cPesq) < 5 then
          cPesq := Replicate('0', 5 - Length(cPesq)) + cPesq;

        Form7.ibDataSet4.Selectsql.Add('(CODIGO='+QuotedStr(cPesq)+')');
      end else
        Form7.ibDataSet4.Selectsql.Add('(DESCRICAO='+QuotedStr(cPesq)+')');

      Form7.ibDataSet4.Open;
    end;

    if not TestarSaldoEstoqueDisponivelNota(AnQtdeInformada,Form7.ibDataSet4CODIGO.AsString) then
      LimpaCamposItensNota
    else
    begin
      if ibDataSet16QUANTIDADE.AsFloat <> AnQtdeInformada then
        ibDataSet16QUANTIDADE.AsFloat := AnQtdeInformada;
    end;
  end;
end;

procedure TForm7.ibDataSet16QUANTIDADESetText(Sender: TField;
  const Text: String);
begin
  // Quando o produto no ta cadastrado fica como comentrio em cinza
  if ibDataSet16QUANTIDADE.AsFloat <> StrToFloat(Text) then
  begin
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;

    //if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',44),1,44) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',44),1,44)) then Mauricio Parizotto 2023-12-20
    if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',120),1,120) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',120),1,120)) then
    begin
      Form7.ibDataSet16UNITARIO.AsString   := EmptyStr;
      Form7.ibDataSet16TOTAL.AsString      := EmptyStr;
      Form7.ibDataSet16QUANTIDADE.AsString := EmptyStr;
    end else
    begin
      /////////////////////////////////////////////////////////////////////////
      // Grade                                                               //
      /////////////////////////////////////////////////////////////////////////
      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;

      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
      begin
        Form7.ibDataSet16QUANTIDADE.AsString  := Form7.ibDataSet16QUANTIDADE.AsString; // Fica 1
      end else
      begin
        // Controle de nmero de Serie
        //if StrToFloat(LimpaNumero('0'+Text)) <> 0 then Mauricio Parizotto 2023-06-05
        if (StrToFloat(LimpaNumero('0'+Text)) <> 0)
          or (NFeFinalidadeComplemento(Form7.ibDataSet15FINNFE.AsString)) then
        begin
          if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then                                      //
          begin                                                                    //
            Form7.ibDataSet16QUANTIDADE.AsString  := Form7.ibDataSet16QUANTIDADE.AsString; // Fica 1
          end else
            Form7.ibDataSet16QUANTIDADE.AsString := Text;                                                                                                                                 
//            VerificaSaldoEstoqueDispItemNota(StrToFloat(Text));
        end else
        begin
          // No permite quantidade negativa
          Form7.ibDataSet16QUANTIDADE.AsString  := Form7.ibDataSet16QUANTIDADE.AsString; // Fica 1
        end;
      end;

    end;
  end;
end;

procedure TForm7.ibDataSet16UNITARIOChange(Sender: TField);
var
  cModuloAnt: String;
begin
  //
  // Verifica se ta cadastrado
  //
  if AllTrim(Form7.ibDataSet16UNITARIO.AsString) <> '' then
  begin
    //
    // Quando o produto no ta cadatrado  comntario fica em cinza
    //
    if Form7.ibDataSet16DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.AsString then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      // Sandro Silva 2023-08-17 Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      // IBDataSet16DESCRICAO elimina os espaos no incio e final, mas no banco est gravado com espao
      // Pesquisa eliminando espaos do incio e final do campo e do texto usado na condio
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where trim(DESCRICAO)='+QuotedStr(Trim(Form7.ibDataSet16DESCRICAO.AsString))+' ');
      Form7.ibDataSet4.Open;
    end;
    //
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) = AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      //
      // Se o produto ta com pro zerado tem que preencher com 0.001 lei de MG
      //
      cModuloAnt := Form7.sModulo;
      try
        if Form7.ibDataSet4PRECO.Value = 0 then
        begin
          Form7.ibDataSet4.Edit;
          Form7.ibDataSet4PRECO.Value := 0.01;
        end;
      finally
        // Estava trocando o modulo para ESTOQUE
        Form7.sModulo := cModuloAnt;
      end;
      //
      // No aceita zerado
      //
      if Form7.ibDataSet16UNITARIO.AsFloat = 0 then
      begin
        //
        Form7.ibDataSet16.Edit;
        //
        // Venda pelo custo
        //
        if Pos('0',Form7.ibDataSet14INTEGRACAO.asString) = 0 then
        begin
          Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
        end else
        begin
          // Sandro Silva 2023-04-26 Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(CorrigeCustoCompraNaVenda(Form7.ibDataSet4CUSTOCOMPR.AsFloat), StrToInt(Form1.ConfPreco));
        end;
        //
      end;
      //
      // Calcula o desconto quando  negativo
      //
      if Form7.ibDataSet16UNITARIO.AsFloat < 0 then
      begin
        Form7.ibDataSet16.Edit;
        Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat * (1- ((Form7.ibDataSet16UNITARIO.AsFloat *-1) /100));
      end;
      //
      // Quando altera a quantidade recalcula o valor
      // total, mas s quando o valor total  alterado
      //
      if Form7.ibDataSet16QUANTIDADE.AsFloat <> 0 then
      begin
        if Arredonda(Form7.ibDataSet16TOTAL.AsFloat,5) <> Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,9) then
        begin
           Form7.ibDataSet16.Edit;
           Form7.ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,9);
        end;
      end;
    end;
  end;
  //
  // the end
  //
end;

procedure TForm7.ibDataSet16UNITARIOSetText(Sender: TField;
  const Text: String);
begin
  try
    // No permite alterar a OS quando a NF ja foi emitida //
    if Form7.sModulo = 'OS' then
    begin
      if Form7.ibDataSet16NUMERONF.AsString <> '' then
      begin
        if Form30.Visible then
        begin
          //ShowMessage('No  possvel alterar o valor deste item porque foi importado para nota fiscal.'); Mauricio Parizotto 2023-10-25
          MensagemSistema('No  possvel alterar o valor deste item porque foi importado para nota fiscal.',msgAtencao);
          ibDataSet16UNITARIO.AsFloat := ibDataSet16UNITARIO.AsFloat;
          Abort;
        end;
      end;
    end;
                                                                               //
    // Se o produto no ta cadastrado  comentrio                               //
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;

    //if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',44),1,44) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',44),1,44)) then Mauricio Parizotto 2023-12-20
    if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',120),1,120) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',120),1,120)) then
    begin
      // Quando o produto no ta cadatrado  comntario fica em cinza
      Form7.ibDataSet16UNITARIO.AsString   := '';
      Form7.ibDataSet16TOTAL.AsString      := '';
      Form7.ibDataSet16QUANTIDADE.AsString := '';
    end else
    begin
      // No permite venda abaixo do custo //
      if StrToFloat(LimpaNumero('0'+Text)) <> 0 then
      begin
        if StrToFloat(Text) >= 0 then   // Se for -  desconto
        begin                           //
          if (Form1.ConfCusto = 'No') then
          begin
            if StrToFloat(Text) < ibDataSet4CUSTOCOMPR.AsFloat then
            begin
              //ShowMessage('No  possvel efetuar vendas com o preo abaixo do custo'); Mauricio Parizotto 2023-10-25
              MensagemSistema('No  possvel efetuar vendas com o preo abaixo do custo',msgAtencao);
            end else
              ibDataSet16UNITARIO.AsFloat := Arredonda(StrToFloat(Text),9);
          end else
            ibDataSet16UNITARIO.AsFloat   := Arredonda(StrToFloat(Text),9);
        end else
          ibDataSet16UNITARIO.AsFloat     := Arredonda(StrToFloat(Text),9);


      end else
      begin
        // Venda pelo custo
        if Pos('0',Form7.ibDataSet14INTEGRACAO.asString) = 0 then
        begin
          Form7.ibDataSet16UNITARIO.AsFloat := Form7.ibDataSet4PRECO.AsFloat;
        end else
        begin
          // Sandro Silva 2023-04-26 Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco)); aqui
          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(CorrigeCustoCompraNaVenda(Form7.ibDataSet4CUSTOCOMPR.AsFloat), StrToInt(Form1.ConfPreco));
        end;
        //
      end;
      //
    end;
    //
    // the end
    //
  except
  end;
end;

procedure TForm7.ibDataSet16TOTALChange(Sender: TField);
begin
  try
    if AllTrim(Form7.ibDataSet16TOTAL.AsString) <> '' then
    begin
      //
      // No permite valor negativo no total
      //
      if Form7.ibDataSet16TOTAL.AsFloat <= 0 then
      begin
        Form7.ibDataSet16.Edit;
        Form7.ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet16QUANTIDADE.Asfloat * Form7.ibDataSet16UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));
      end;
      //
      // S altera o valor unitrio quando for necessrio
      //
      if Form7.ibDataSet16QUANTIDADE.Asfloat <> 0 then
      begin
        //
        // + ou menos 0.001
        //
        if (Form7.ibDataSet16UNITARIO.AsFloat - (Form7.ibDataSet16TOTAL.AsFloat / Form7.ibDataSet16QUANTIDADE.Asfloat) > 0.001)
        or ((Form7.ibDataSet16TOTAL.AsFloat / Form7.ibDataSet16QUANTIDADE.Asfloat) - Form7.ibDataSet16UNITARIO.AsFloat > 0.001) then
        begin
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16UNITARIO.AsFloat := Arredonda(Form7.ibDataSet16TOTAL.AsFloat / Form7.ibDataSet16QUANTIDADE.Asfloat,StrToInt(Form1.ConfPreco));
        end;
      end;

      {Sandro Silva 2023-05-08 inicio}
      // Calcula o FCP ST para devoluo
      CalculaFCPSTAoIncluirProdutoDevolucao;
      {Sandro Silva 2023-05-08 fim}
    end;
  except
  end;
end;

procedure TForm7.ibDataSet16TOTALSetText(Sender: TField; const Text: String);
begin
  // Verifica se ta cadastrado
  try
    if AllTrim(Form7.ibDataSet16DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.Selectsql.Clear;
      Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
      Form7.ibDataSet4.Open;
    end;
    
    //if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',44),1,44) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',44),1,44)) then Mauricio Parizotto 2023-12-20
    if (copy(AllTrim(Form7.ibDataSet16DESCRICAO.AsString)+Replicate(' ',120),1,120) <> copy(AllTrim(Form7.ibDataSet4DESCRICAO.AsString)+Replicate(' ',120),1,120)) then
    begin
      // Quando o produto no ta cadatrado  comntario fica em cinza
      Form7.ibDataSet16UNITARIO.AsString   := '';
      Form7.ibDataSet16TOTAL.AsString      := '';
      Form7.ibDataSet16QUANTIDADE.AsString := '';
    end else
    begin
      // No permite alterar a OS quando a NF ja foi emitida
      if Form7.sModulo = 'OS' then
      begin
        if Form7.ibDataSet16NUMERONF.AsString <> '' then
        begin
          if Form30.Visible then
          begin
            //ShowMessage('No  possvel alterar o valor deste item porque foi importado para nota fiscal.'); Mauricio Parizotto 2023-10-25
            MensagemSistema('No  possvel alterar o valor deste item porque foi importado para nota fiscal.');
            ibDataSet16TOTAL.AsFloat := ibDataSet16TOTAL.AsFloat;
          end;
        end else
          ibDataSet16TOTAL.AsString := Text;
      end;

      // No permite venda abaixo do custo
      if StrToFloat(LimpaNumero('0'+Text)) > 0 then
      begin
        if Form1.ConfCusto = 'No' then
        begin
          if (StrToFloat(Text)/ibDataSet16QUANTIDADE.AsFloat) < ibDataSet4CUSTOCOMPR.AsFloat then
          begin
            //ShowMessage('No  possvel efetuar vendas com o preo abaixo do custo'); Mauricio Parizotto 2023-10-25
            MensagemSistema('No  possvel efetuar vendas com o preo abaixo do custo',msgAtencao);

            ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet4PRECO.AsFloat * ibDataSet16QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
          end else ibDataSet16TOTAL.AsFloat := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
        end else ibDataSet16TOTAL.AsFloat   := Arredonda(StrToFloat(Text),StrToInt(Form1.ConfPreco));
      end else
      begin
        ibDataSet16TOTAL.AsFloat := Arredonda(Form7.ibDataSet4PRECO.AsFloat * ibDataSet16QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
      end;
    end;
  except
  end;
end;

procedure TForm7.ibDataSet15NewRecord(DataSet: TDataSet);
var
  sN, sNovoNumero : String;
begin
  IBDataSet99.Close;
  IBDataSet99.SelectSQL.Clear;
  IBDataSet99.SelectSQL.Add('select gen_id(G_NSU,1) from rdb$database');
  IBDataSet99.Open;
  sNSU := StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0);
  IBDataSet99.Close;

  try
    Form7.IBDataSet99.Close;
    Form7.IBDataSet99.SelectSQL.Clear;

    // Notas fiscais de sada (vendas) srie 001
    // Notas fiscais de sada (vendas) srie 002
    // Notas fiscais de sada (vendas) srie XXX

    if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then
    begin
      Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE1,1) from rdb$database');
    end else
    begin
      if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then
      begin
        Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE2,1) from rdb$database');
      end else
      begin
        if Form7.sTitulo = 'Notas fiscais de sada (vendas) com CPF srie 920' then
        begin
          Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE920,1) from rdb$database');
        end else
        begin
          Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE'+Right(Form7.sTitulo,3)+',1) from rdb$database');
        end;
      end;
    end;

    Form7.IBDataSet99.Open;
  except
    on E: Exception do
    begin
      //ShowMessage(E.Message); Mauricio Parizotto 2023-10-25
      MensagemSistema(E.Message,msgErro);
    end
  end;

  // Notas fiscais de sada (vendas) srie 001
  // Notas fiscais de sada (vendas) srie 002
  // Notas fiscais de sada (vendas) srie XXX
  sNovoNumero := StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+Right(Form7.sTitulo,3);
  sN          := StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0);

  if sN = '000000001' then
  begin
    while Application.MessageBox(pChar(
    chr(10) +'Iniciar a numerao de '+ sN +' para a srie '+ Right(Form7.sTitulo,3) +'?'),
    'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION) <> idYes do
    begin
      try
        sN := StrZero(StrtoFloat(Form1.Small_InputForm('Sequncia da numerao','Informe a sequncia para iniciar a numerao da srie '+ Right(Form7.sTitulo,3) + ': ',sN)),9,0);
      except
        // ShowMessage('Numerao invalida.');Mauricio Parizotto 2023-10-25
        MensagemSistema('Numerao invalida.');
        sN := '000000001';
      end;
    end;

    if Application.MessageBox(pChar('Voc tem certeza que quer iniciar a numerao de '+ sN +' para a srie '+Right(Form7.sTitulo,3)+'? Considere pedir ajuda ao seu contador.'),'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION) = idYes then
    begin
      sNovoNumero := sN+Right(Form7.sTitulo,3);
    end else
    begin
      sN := '000000001';
    end;

    sNovoNumero := sN+Right(Form7.sTitulo,3);

    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;

    if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then
    begin
      Form1.ibQuery1.SQL.Add('set generator G_SERIE1 to '+SN+' ');
    end else
    begin
      if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then
      begin
        Form1.ibQuery1.SQL.Add('set generator G_SERIE2 to '+sN+' ');
      end else
      begin
        if Form7.sTitulo = 'Notas fiscais de sada (vendas) com CPF srie 920' then
        begin
          Form1.ibQuery1.SQL.Add('set generator G_SERIE920 to '+sN+' ');
        end else
        begin
          if Right(Form7.sTitulo,3) = 'RPS' then
          begin
            Form1.ibQuery1.SQL.Add('set generator G_SERIERPS to '+SN+' ');
          end else
          begin
            Form1.ibQuery1.SQL.Add('set generator G_SERIE'+Form1.sSerieEspecial+' to '+SN+' ');
          end;
        end;
      end;
    end;

    Form1.ibQuery1.ExecSQL;
  end;

  Form7.IBDataSet99.Close;
  
  Form7.ibDataSet15.Edit;
  Form7.ibDataSet15REGISTRO.AsString   := sProximo;
  Form7.ibDataSet15NSU.AsString        := sNSU;
  Form7.ibDataSet15NSUD.AsDatetime     := Date;
  Form7.ibDataSet15NSUH.AsString       := TimeToStr(Time);
  Form7.ibDataSet15NUMERONF.AsString   := sNovoNumero;
  Form7.ibDataSet15EMITIDA.AsString    := 'J';
  Form7.ibDataSet15FRETE12.AsString    := '0';
  Form7.ibDataSet15ESPECIE.AsString    := Form1.ConfEspecie;
  Form7.ibDataSet15MARCA.AsString      := Form1.ConfMarca;
  Form7.ibDataSet15VOLUMES.AsFloat     := 1;
  Form7.ibDataSet15MERCADORIA.Value    := 0;
  Form7.ibDataSet15SERVICOS.Value      := 0; // Nova nota
  Form7.ibDataSet15FRETE.Value         := 0;
  Form7.ibDataSet15DESCONTO.Value      := 0;
  Form7.ibDataSet15SEGURO.Value        := 0;
  Form7.ibDataSet15IPI.Value           := 0;
  Form7.ibDataSet15DESPESAS.Value      := 0;
  Form7.ibDataSet15BASEICM.Value       := 0;
  Form7.ibDataSet15ISS.Value           := 0;
  Form7.ibDataSet15ICMS.Value          := 0;
  Form7.ibDataSet15EMISSAO.Value       := Date;
  Form7.ibDataSet15SAIDAD.Value        := Date;
  Form7.ibDataSet15SAIDAH.Value        := TimeToStr(Time);

  if Right(Form7.sTitulo,3) = 'RPS' then
  begin
    Form7.ibDataSet15MODELO.Value        := 'SV';
  end;

  Form7.ibDataSet15.Post;
  
  if Form12.Visible then
    Form7.ibDataSet2.Append;
end;

procedure TForm7.ibDataSet2MAESetText(Sender: TField; const Text: String);
begin
  // Labels inteligentes
  if Pos('$',Sender.DisplayLabel) <> 0 then
  begin
    Sender.AsString  := AllTrim(Format('%22.2n',[StrToFloat(LimpaNumeroDeixandoAvirgula('0'+Text))]));
  end else
  begin
    if Pos('DATA',UpperCase(Sender.DisplayLabel)) <> 0 then
    begin
      Sender.AsString := Copy(LimpaNumero(Text),1,2)+'/'+Copy(LimpaNumero(Text),3,2)+'/'+Copy(LimpaNumero(Text),5,4);
    end else
    begin
      Sender.AsString := Text;
    end;
  end;

  if Form10.Visible then
  begin
    if (pos('<',Sender.AsString)<>0) and (pos('>',Sender.AsString)<>0) then
    begin
      //ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.',msgAtencao);
    end;

    {Sandro Silva 2023-11-20 inicio
    if Length(LimpaNumero(Sender.AsString))=9 then
    begin
      //ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.',msgAtencao);
    end;
    }
  end;
end;

procedure TForm7.Imprimirdocumento1Click(Sender: TObject);
begin
  Form1.imgVendasClick(Sender);
  Form7.ibDataSet3.First;

  while not Form7.ibDataSet3.Eof do
  begin
    if form7.ibDataSet3NF.AsString = '' then
    begin
      Form12.Close;
      Form7.ibDataSet3.Next;
    end;
  end;

  Form1.imgVendasClick(Sender);
  Form1.imgOrdemServicoClick(Sender);
end;

procedure TForm7.Enviartorpedo1Click(Sender: TObject);
var
  //
  sMsg : String;
  //
begin
  //
  Form40.CheckBox1.Visible := False;
  Form40.MaskEdit1.Visible := False;
  Form40.Edit1.Visible     := False;
  Form40.Label1.Visible    := False;
  Form40.Label3.Visible    := False;
  Form40.Label4.Visible    := False;
  Form40.Caption           := 'Enviar WhatsApp';
  //
  Form40.OpenDialog1.FileName := '';
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<HISTORICO>');
  Form40.Memo2.Lines.Add('<PORTADOR>');
  Form40.Memo2.Lines.Add('<DOCUMENTO>');
  Form40.Memo2.Lines.Add('<EMISSAO>');
  Form40.Memo2.Lines.Add('<VENCIMENTO>');
  Form40.Memo2.Lines.Add('<VALOR_DUPL>');
  Form40.Memo2.Lines.Add('<VALOR_JURO>');
  Form40.Memo2.Lines.Add('<CODEBAR>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>');
  //
  Form40.ShowModal;
  //
  Form40.MaskEdit1.Visible := True;
  Form40.Edit1.Visible     := True;
  Form40.Label1.Visible    := True;
  Form40.Label4.Visible    := True;
  Form40.Label3.Visible    := True;
  Form40.Caption           := 'Enviar e-mail texto';
  //
  if Form1.Tag = 1 then
  begin
    //
    if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
    begin
      //
      sMsg := Form40.Memo1.Lines.Text;
      //
      // CLIENTES
      //
      sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
      sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
      sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
      sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
      sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
      sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
      sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
      sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
      sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
      sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
      sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
      sMsg := StrTran(sMsg,'<WHATSAPP>'           ,Form7.ibDataSet2.FieldByName('WHATSAPP'      ).AsString);
      sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
      sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
      sMsg := StrTran(sMsg,'<CONTATOS>'      ,Form7.ibDataSet2.FieldByName('CONTATOS' ).AsString);
      sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
      sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
      //
      sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
      sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
      //
      sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
      sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
      sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
      sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
      //
      sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
      sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
      sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
      sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
      sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
      sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
      sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
      //
      sMsg := StrTran(sMsg,' ','%20');
      sMsg := StrTran(sMsg,chr(10),'%0A');
      sMsg := StrTran(sMsg,chr(13),'');
      //
      ShellExecute( 0, 'Open', pChar('https://api.whatsapp.com/send?phone=55'+LimpaNumero(StrTran(ibDataSet2WHATSAPP.AsString,'0xx',''))+'&text='+sMSG),'','', SW_SHOW);
      //
    end;
  end;
  //
end;

procedure TForm7.ibDataSet16AfterDelete(DataSet: TDataSet);
begin
  if Form7.sModulo = 'VENDA' then
    AtualizarListaItensAuxiliar;
    
  if Form7.sModulo = 'OS' then
    TotalizaOS(True,False);

  AgendaCommit(True);
end;

procedure TForm7.DBGrid4DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  //Mauricio Parizotto 2023-01-03
  if Column.Field.DataType = ftMemo then
  begin
    DBGridExibeMemo(DBGrid4, Column, Rect, State, Column.FieldName);
  end;
end;

procedure TForm7.DBGrid4DrawDataCell(Sender: TObject; const Rect: TRect;
  Field: TField; State: TGridDrawState);
var
  OldBkMode : Integer;
  xRect : tREct;
begin
  //
  if  Field.DataType <> ftFloat  then
  begin
    if Form7.sModulo = 'VENDA' then
    begin
      if ibDataSet7Vencimento.Value < date then
        DBGrid4.Canvas.Font.Color := clRed;
      if ibDataSet7Vencimento.Value = date then
        DBGrid4.Canvas.Font.Color := clBlue;
      if ibDataSet7Valor_Rece.Value <> 0 then
        DBGrid4.Canvas.Font.Color := clGreen;
      if ibDataSet7ATIVO.AsString='1' then
        DBGrid4.Canvas.Font.Color := clSilver;
    end;
    //
    dbGrid4.Canvas.FillRect(Rect);
    DbGrid4.Canvas.TextOut(Rect.Left+2,Rect.Top+2,Field.AsString);
    //
  end;
  //
  if Field.Name = 'ibDataSet7VENCIMENTO' then
  begin
    dbGrid4.Canvas.Brush.Color := clWhite;
    dbGrid4.Canvas.Font := dbGrid4.Font;
    if (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 1) or (DayOfWeek(Form7.ibDataSet7VENCIMENTO.AsDateTime) = 7) then
      dbGrid4.Canvas.Font.Color   := clRed
    else
      dbGrid4.Canvas.Font.Color   := clBlack;
    dbGrid4.Canvas.TextOut(Rect.Left+dbGrid4.Canvas.TextWidth('99/99/9999_'),Rect.Top+2,Copy(DiaDaSemana(Form7.ibDataSet7VENCIMENTO.AsDateTime),1,3) );
  end;
  //
  dbGrid4.Canvas.Pen.Color := clBlack;
  dbGrid4.Canvas.Brush.Color := Form7.Panel7.Color;
  //
  xRect.Left   := Rect.Left;
  xRect.Top    := -2;
  xRect.Right  := Rect.Right;
  xRect.Bottom := Rect.Bottom-Rect.Top + 2;
  dbGrid4.Canvas.FillRect(XrEct);
  //
  with dbGrid4.Canvas do
  begin
    OldBkMode := SetBkMode(Handle, TRANSPARENT);
    dbGrid4.Canvas.Font.Color := clblack;
    TextOut(Rect.Left+3,3,AllTrim(Field.DisplayLabel));
    dbGrid4.Canvas.Font.Color := clblack;
    SetBkMode(Handle, OldBkMode);
  end;
  //
end;

procedure TForm7.DBGrid4ColEnter(Sender: TObject);
begin
  dbGrid4.Repaint;
end;

procedure TForm7.ibDataSet35AfterPost(DataSet: TDataSet);
begin
  //
  if AllTrim(Form7.ibDataSet35DESCRICAO.AsString) = '' then
  begin
    if not Form7.ibDataSet35.Eof then Form7.ibDataSet35.Delete;
    Form7.ibDataSet35.Append;
    Form7.ibDataSet35.Last;
  end else
  begin
    //
    Form7.ibDataSet99.Close;
    Form7.ibDataSet99.SelectSQL.Clear;
    Form7.IBDataSet99.SelectSQL.Add('select CODIGO, DESCRICAO, PRECO, TIPO_ITEM from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet35DESCRICAO.AsString)+' '); // Ok
    Form7.ibDataSet99.Open;
    //
    Form7.ibDataSet35.Edit;
    if Form7.IBDataSet99.FieldByname('DESCRICAO').AsString = Form7.ibDataSet35DESCRICAO.AsString then
    begin
      if Form7.IBDataSet99.FieldByname('TIPO_ITEM').AsString = '09' then
      begin
        Form7.ibDataSet35CODIGO.AsString    := Form7.IBDataSet99.FieldByname('CODIGO').AsString;
        Form7.ibDataSet35DESCRICAO.AsString := Form7.IBDataSet99.FieldByname('DESCRICAO').AsString;
        // TESTE
        if Form7.ibDataSet35QUANTIDADE.AsFloat <= 0 then
          Form7.ibDataSet35QUANTIDADE.AsFloat := 1;
        if Form7.ibDataSet35UNITARIO.AsFloat   <= 0 then
          Form7.ibDataSet35UNITARIO.AsFloat   := Form7.IBDataSet99.FieldByname('PRECO').AsFloat;
      end else
      begin
        //ShowMEssage('O tipo do item deve ser "09 - Servio" na guia ICMS.');  Mauricio Parizotto 2023-10-25
        MensagemSistema('O tipo do item deve ser "09 - Servio" na guia ICMS.');

        Form7.ibDataSet35CODIGO.AsString    := '';
        Form7.ibDataSet35DESCRICAO.AsString := '';
      end;
    end else
    begin
      //ShowMEssage('Servio no cadastrado. (O tipo do item deve ser "09 - Servio" na guia ICMS)');Mauricio Parizotto 2023-10-25
      MensagemSistema('Servio no cadastrado. (O tipo do item deve ser "09 - Servio" na guia ICMS)',msgAtencao);
      Form7.ibDataSet35DESCRICAO.AsString := '';
    end;
  end;

  if Form7.sModulo = 'VENDA' then
    TotalizaServicos(True);
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet35AfterDelete(DataSet: TDataSet);
begin
  if Form7.sModulo = 'OS' then
    TotalizaOS(False,True);

  if Form7.sModulo = 'VENDA' then
    TotalizaServicos(True);
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet35TOTALChange(Sender: TField);
begin
  if Form7.ibDataSet35QUANTIDADE.AsFloat > 0 then
  begin
    // Sandro Silva 2023-11-20 if Format('%12.4n',[(Form7.ibDataSet35TOTAL.AsFloat)]) <> Format('%12.4n',[(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat)]) then
    if Format('%12.4n',[(Form7.ibDataSet35TOTAL.AsFloat)]) <> Format('%12.4n',[Arredonda(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco))]) then
    begin
      Form7.ibDataSet35.Edit;
      Form7.ibDataSet35TOTAL.AsFloat := Arredonda(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
    end;
    //
    if Form7.sModulo = 'OS' then
      TotalizaOS(False,True);

    if Form7.sModulo = 'VENDA' then
      TotalizaServicos(True);

  end;
end;

procedure TForm7.ibDataSet23AfterPost(DataSet: TDataSet);
begin
  if Form7.sModulo <> 'NAO' then
  begin
    //Mauricio Parizotto 2024-01-10
    TotalizaItensCompra;
  end;
end;

procedure TForm7.ibDataSet23BeforeDelete(DataSet: TDataSet);
begin
  Form1.rReserva := 0;
  //
  Form7.ibDataSet4.Close;                                                //
  Form7.ibDataSet4.Selectsql.Clear;                                      // receber Relacionado
  Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');  //
  Form7.ibDataSet4.Open;
  //
  if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet23CODIGO.AsString) and (AllTrim(Form7.ibDataSet4CODIGO.AsString)<>'') then
  begin
    // Grade
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString) then
    begin
      try
        // Grade // Quando deleta um item na compra
        Form13.Button2.Enabled := False;
        Form7.sModulo := 'GRADE';
        Form13.Label1.Caption := 'Deletando um item da compra';
        Form13.ShowModal; // Quando deleta um item na compra
        Form7.sModulo := 'COMPRA';
        Form13.Button2.Enabled := True;
      except end;
    end;
    //////////////////////////
    // Controle de serie    //
    // Esta rotina cancela  //
    // um item na venda     //
    //////////////////////////
    if ibDataSet4.FieldByname('SERIE').Value = 1 then
    begin
      ibDataSet30.Close;
      ibDataSet30.SelectSQL.Clear;
      ibDataSet30.Selectsql.Add('select * from SERIE where CODIGO='+QuotedStr(ibDataSet4CODIGO.AsString));
      ibDataSet30.Open;
      while not ibDataSet30.Eof do
      begin
        if Copy(ibDataSet30NFCOMPRA.AsString,1,6) = Copy(Form7.ibDataSet24NUMERONF.AsString,4,6) then
        begin
          ibDataSet30.Delete;
        end else ibDataSet30.Next;
      end;
    end;
  end;
  //
  if ibDataSet23QUANTIDADE.Asfloat > 0 then
  begin
    try
      ibDataSet23.Edit;
      ibDataSet23QUANTIDADE.Value := 0;
      ibDataSet23TOTAL.Value := 0;
      ibDataSet23.Post;
    except end;
  end;
  ibDataSet23AfterPost(DataSet);
end;

procedure TForm7.ibDataSet23BeforePost(DataSet: TDataSet);
var
  sRegistro14 : String;
begin
  try
    if Alltrim(Form7.ibDataSet23QUANTIDADE.AsString) <> '' then
    begin
      if Form7.ibDataSet23BASE.Value < 0.01 then
      begin
        if Form7.ibDataSet14.Active then
        begin
          if (Alltrim(Form7.ibDataSet23CFOP.AsString)<>Alltrim(Form7.ibDataSet14CFOP.AsString)) and (AllTrim(Form7.ibDataSet23CFOP.AsString) <> '') then
          begin
            sRegistro14 := Form7.ibDataSet14REGISTRO.AsString;
            Form7.ibDataSet14.DisableControls;
            Form7.ibDataSet14.Locate('CFOP',Alltrim(Form7.ibDataSet23CFOP.AsString),[]);

            if Alltrim(Form7.ibDataSet14CFOP.AsString) = Alltrim(Form7.ibDataSet23CFOP.AsString) then
            begin
              Form7.ibDataSet23.Edit;
              Form7.ibDataSet23BASE.Value := Form7.ibDataSet14BASE.AsFloat;       // 23 Before post 2
            end;

            Form7.ibDataSet14.Locate('REGISTRO',sRegistro14,[]);
            Form7.ibDataSet14.EnableControls;
          end;
        end;
      end;  
    end else
    begin
      Form7.ibDataSet23BASE.AsString := '';
    end;
  except
  end;
end;

procedure TForm7.ibDataSet23DESCRICAOChange(Sender: TField);
var
  I : Integer;
  sCodigoAnterior : String;
  sSerial : string;

  // Pis cofins da Operao
  sCST_PIS_COFINS : String;
  rpPIS, rpCOFINS : Real;
begin
  if (Form1.bFlag) and (Alltrim(ibDataSet23DESCRICAO.AsString) <> '') then
  begin
    Form7.ibDataSet23.DisableControls;
    //LogRetaguarda('unit7 ibDataSet23.DisableControls 21070'); // Sandro Silva 2023-12-04
    Form7.ibDataSet4.DisableControls;

    // S procura se estiver diferente
    if ibDataSet14.FieldByname('CSTPISCOFINS').AsString <> ibDataSet24OPERACAO.AsString then
      ibDataSet14.Locate('NOME',ibDataSet24OPERACAO.AsString,[]);

    sCST_PIS_COFINS := ibDataSet14.FieldByname('CSTPISCOFINS').AsString;
    rpPIS           := ibDataSet14.FieldByname('PPIS').AsFloat;
    rpCOFINS        := ibDataSet14.FieldByname('PCOFINS').AsFloat;

    if not (Form7.ibDataset23.State in ([dsEdit, dsInsert])) then
      Form7.ibDataset23.Edit;

    if ibDataSet23CFOP.AsString = '' then
      ibDataSet23CFOP.AsString := ibDataSet14CFOP.AsString;

    Form1.bFlag := False;

    if (Form7.ibDataSet23DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.Value) then
    begin
      Form7.ibDataSet4.Close;
      Form7.ibDataSet4.SelectSQL.Clear;
      Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE order by upper(DESCRICAO)');
      Form7.ibDataSet4.Open;
      Form7.ibDataSet4.First;
      Form7.ibDataSet4.EnableControls;
      Form7.ibDataSet4.First;

      //Procura por: cdigo
      if (length(Alltrim(ibDataSet23DESCRICAO.AsString)) <= 5) and (LimpaNumero(Alltrim(ibDataSet23DESCRICAO.AsString)) <> EmptyStr) then
      begin
        try
          if StrToInt(AllTrim(ibDataSet23DESCRICAO.AsString)) <> 0 then
            Form7.ibDataSet4.Locate('CODIGO',StrZero(StrToInt(AllTrim(ibDataSet23DESCRICAO.AsString)),5,0),[]);
        except
        end;
      end;

      if Pos(Alltrim(ibDataSet23DESCRICAO.AsString),ibDataSet4CODIGO.AsString) = 0 then
      begin
        // Procura pela referencia
        Form7.ibDataSet4.Locate('REFERENCIA',AllTrim(ibDataSet23DESCRICAO.AsString),[]);
        // Se o produto no foi encontrado //
        if Alltrim(ibDataSet23DESCRICAO.AsString) <> AllTrim(ibDataSet4REFERENCIA.AsString) then
        begin
          // Procura pela descrico
          Form7.ibDataSet99.Close;
          Form7.ibDataSet99.SelectSQL.Clear;
//          Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(AllTrim(ibDataSet23DESCRICAO.AsString))+'%')+' order by upper(DESCRICAO)');
          Form7.ibDataSet99.SelectSQL.Add('select *');
          Form7.ibDataSet99.SelectSQL.Add('from ESTOQUE');
          Form7.ibDataSet99.SelectSQL.Add('where (upper(DESCRICAO)='+QuotedStr(UpperCase(AllTrim(ibDataSet23DESCRICAO.AsString)))+')');
          Form7.ibDataSet99.SelectSQL.Add(RetornarWhereAtivoEstoqueCompra);
          Form7.ibDataSet99.SelectSQL.Add('order by upper(DESCRICAO)'); // Maa verde
          Form7.ibDataSet99.Open;
          Form7.ibDataSet99.First;

//        if not Form7.ibDataSet4.Locate('DESCRICAO',ibDataset99.FieldByname('DESCRICAO').AsString,[]) then
          if not Form7.ibDataSet4.Locate('CODIGO',ibDataset99.FieldByname('CODIGO').AsString,[]) then
          begin
            //Mauricio Parizotto 2023-04-04
            Form7.ibDataSet23.Edit;
            LimparColunasItemCompra;
            ibDataSet4.EnableControls;
            ibDataSet23.EnableControls;
            //LogRetaguarda('unit7 ibDataSet23.EnableControls 21136'); // Sandro Silva 2023-12-04
            Exit;
          end;
        end;
      end;
    end;

    {  Preenche os dados do arquivo ENTRADA.DBF }
    {  se o produto for encontrado              }
    //if not Form7.ibDataSet4.Eof then Mauricio Parizotto 2023-04-04
    { Grava no arquivo ENTRADA.DBF: }
    {                               }
    { 1. Descrico do produto       }
    { 2. Valor unitrio             }
    { 3. Quantidade                 }
    { 4. Total                      }
    { 5. Situao tributria        }
    { 6. Percentual do IPI          }
    { 7. Peso                       }
    { 7. Cdigo                     }
    {                               }
    Form7.ibDataSet23.Edit;

    if AllTrim(Form7.ibDataSet23DESCRICAO.AsString) <> AllTrim(Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      Form7.ibDataSet23CODIGO.AsString    := '';
    end;

    if (AllTrim(ibDataSet23CODIGO.AsString) <> '') and (ibDataSet23CODIGO.AsString <> ibDataSet4CODIGO.AsString) then
    begin
      sCodigoAnterior := ibDataSet4CODIGO.AsString;
      ibDataSet4.Locate('CODIGO',ibDataSet23CODIGO.AsString,[]);

      Form1.rReserva := 0;

      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;

      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
      begin
        try
          // Deleta na compra
          Form7.sModulo := 'ESTOQUE';
          Form13.Button2.Enabled := False;
          Form13.Label1.Caption := 'Deleta na compra';
          Form13.ShowModal;  // Deleta na compra
          Form13.Button2.Enabled := True;
          Form7.sModulo := 'COMPRA';
        except end;
      end;

//        ibDataSet4.IndexFieldNames := 'CODIGO';
      ibDataSet4.Locate('CODIGO',sCodigoAnterior,[]);
    end;

    if (FbImportandoXML) or ((ibDataSet4ATIVO.AsInteger = 0) or ((ibDataSet4ATIVO.AsInteger = 1) and (ibDataSet4TIPO_ITEM.AsString = '01'))) then
      Form7.ibDataSet23DESCRICAO.AsString := Form7.ibDataSet4DESCRICAO.AsString
    else
    begin
      Form7.ibDataSet23.Edit;
      LimparColunasItemCompra;
      ibDataSet4.EnableControls;
      ibDataSet23.EnableControls;
      //LogRetaguarda('unit7 ibDataSet23.EnableControls 21202'); // Sandro Silva 2023-12-04
      Exit;
    end;
    // So altera se for um produto novo
    if AllTrim(Form7.ibDataSet23CODIGO.AsString) = '' then
    begin
      // se tem grade quantidade = zero
      Form7.ibDataSet10.Close;
      Form7.ibDataSet10.SelectSQL.Clear;
      Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
      Form7.ibDataSet10.Open;
      Form7.ibDataSet10.First;

      Form7.ibDataSet23.Edit;

      if (Form7.ibDataSet4CODIGO.AsString <> Form7.ibDataSet10CODIGO.AsString) and (Form7.ibDataSet4.FieldByname('SERIE').Value <> 1) then
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat     := 1;
        Form7.ibDataSet23QTD_ORIGINAL.AsFloat   := 1;
      end;

      // Form7.ibDataSet23UNITARIO_O.Asfloat   := 0;
      // Form7.ibDataSet23UNITARIO.Asfloat     := 0;
      Form7.ibDataSet23UNITARIO.Asfloat       := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));
      Form7.ibDataSet23UNITARIO_O.Asfloat     := Arredonda(Form7.ibDataSet4CUSTOCOMPR.AsFloat,StrToInt(Form1.ConfPreco));

      Form7.ibDataSet23ST.AsString        := Form7.ibDataSet4ST.AsString;
      Form7.ibDataSet23ICM.AsFloat        := 0;
      Form7.ibDataSet23PESO.AsFloat       := Form7.ibDataSet4PESO.AsFloat;
      Form7.ibDataSet23MEDIDA.AsString    := Form7.ibDataSet4MEDIDA.AsString;
      Form7.ibDataSet23PESO.AsString      := Form7.ibDataSet4PESO.AsString;

      if (AllTrim(Form7.ibDataSet23CST_ICMS.AsString)='') then
      begin
        if (AllTrim(Form7.ibDataSet23CST_ICMS.AsString)='') then if (AllTrim(Form7.ibDataSet14CST.AsString)<>'') then Form7.ibDataSet23CST_ICMS.AsString := Form7.ibDataSet14CST.AsString;
      end;
      if (AllTrim(Form7.ibDataSet23CST_ICMS.AsString)='') then
      begin
        if (AllTrim(Form7.ibDataSet4CST.AsString)<>'') then Form7.ibDataSet23CST_ICMS.AsString  := Form7.ibDataSet4CST.AsString;
      end;
    end;

    if Alltrim(sCST_PIS_COFINS) <> '' then
    begin
      Form7.ibDataSet23CST_PIS_COFINS.AsString := sCST_PIS_COFINS;
      Form7.ibDataSet23ALIQ_PIS.AsFloat        := rpPIS;
      Form7.ibDataSet23ALIQ_COFINS.AsFloat     := rpCOFINS;
    end else
    begin
      Form7.ibDataSet23CST_PIS_COFINS.AsString   := Form7.ibDataSet4CST_PIS_COFINS_ENTRADA.AsString;     // CST do PIS no ICM
      Form7.ibDataSet23ALIQ_PIS.AsFloat          := Form7.ibDataSet4ALIQ_PIS_ENTRADA.AsFloat;
      Form7.ibDataSet23ALIQ_COFINS.AsFloat       := Form7.ibDataSet4ALIQ_COFINS_ENTRADA.AsFloat;
    end;

    Form7.ibDataSet23CODIGO.AsString           := Form7.ibDataSet4CODIGO.AsString;

    ///////////////////////
    // Controle de serie //
    ///////////////////////

    if (Form7.ibDataSet4.FieldByname('SERIE').Value = 1) and (Form7.ibDataSet23QUANTIDADE.AsFloat=0) then
    begin
      sSerial := '99';
      ibDataSet23QUANTIDADE.AsFloat := 0;
      while AllTrim(sSerial) <> '' do
      begin
        I := 0;

        while I <> 6 do
        begin
          sSerial := AllTrim(Form1.Small_InputForm('Compra de item','Nmero de srie:',''));

          if sSerial <> '' then
          begin
            ibDataSet100.Close;
            ibDataSet100.SelectSQL.Clear;
            ibDataSet100.SelectSQL.Add('select * from SERIE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' and SERIAL='+QuotedStr(sSerial)+' ');
            ibDataSet100.Open;

            if ibDAtaSet100.FieldByName('SERIAL').AsString = sSerial then
            begin
              I := Application.MessageBox(pChar(
                                        chr(10) +'O nmero de srie: '+sSerial+' j est cadastrado no produto: '+
                                        chr(10)+Alltrim(ibDataSet4DESCRICAO.AsString)+' '+
                                        chr(10)+
                                        chr(10) +'Incluir novamente este nmero de srie?'+Chr(10)+
                                        chr(10)),
                                        'Ateno',mb_YesNo + mb_DefButton2 +  MB_ICONWARNING);
              if I <> 6 then sSerial := '';
            end else I := 6;

          end else I := 6;
        end;

        ibDataSet100.Close;

        if sSerial <> '' then
        begin
          ibDataSet30.Append;
          ibDataSet30CODIGO.AsString      := Form7.ibDataSet23CODIGO.AsString;
          ibDataSet30SERIAL.AsString      := sSerial;
          ibDataSet30NFCOMPRA.AsString    := Copy(Form7.ibDataSet24NUMERONF.AsString,4,6);
          ibDataSet23QUANTIDADE.AsFloat   := ibDataSet23QUANTIDADE.AsFloat + 1;
          ibDataSet23QTD_ORIGINAL.AsFloat := ibDataSet23QUANTIDADE.AsFloat;
          ibDataSet30.Post;

          Form24.DbGrid1.Refresh;
        end;
      end;
    end;

    //  the end SERIE

    // Grade
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;

    try
//        if not Jatem(Form7.ibDataSet23,Form7.ibDataSet23DESCRICAO,False) then
      begin
        if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
        begin
          // Quantiade na compra sempre 1
          if (Form7.ibDataSet23QUANTIDADE.AsFloat = 0) then
          begin
            Form1.rReserva := 0;
            Form13.Label1.Caption := 'Quantidade na compra';
            Form13.ShowModal;  // Quantiade na compra sempre 1
          end;
        end;
      end;
    except
    end;

    if (Form7.ibDataSet23QUANTIDADE.AsFloat = 0) and (Form7.ibDataSet23DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString) then
    begin
      if Form7.ibDataSet4.FieldByname('SERIE').Value <> 1 then
      begin
        Form7.ibDataSet23.Edit;
        Form7.ibDataSet23QUANTIDADE.AsFloat := 1;
      end else
      begin
        Form7.ibDataSet23DESCRICAO.AsString := EmptyStr;
        Form7.ibDataSet23QUANTIDADE.AsString := EmptyStr;
        Form7.ibDataSet23UNITARIO.AsString := EmptyStr;
        Form7.ibDataSet23TOTAL.AsString := EmptyStr;
        Form7.ibDataSet23CFOP.AsString := EmptyStr;
        Form7.ibDataSet23ICM.AsString := EmptyStr;
        Form7.ibDataSet23CST_ICMS.AsString := EmptyStr;
        Form7.ibDataSet23CODIGO.AsString := EmptyStr;

        Form24.DbGrid1.SelectedIndex := 6;
      end;
    end;

    ibDataSet4.EnableControls;
    ibDataSet23.EnableControls;
    //LogRetaguarda('unit7 ibDataSet23.EnableControls 21362'); // Sandro Silva 2023-12-04

    Observacao2(False);
  end;
end;

procedure TForm7.LimparColunasItemCompra;
begin
  Form7.ibDataSet23QUANTIDADE.AsString := EmptyStr;
  Form7.ibDataSet23DESCRICAO.AsString := EmptyStr;
  Form7.ibDataSet23QTD_ORIGINAL.AsString := EmptyStr;
  Form7.ibDataSet23UNITARIO_O.AsString := EmptyStr;

  Form7.ibDataSet23UNITARIO.AsString := EmptyStr;
  Form7.ibDataSet23TOTAL.AsString := EmptyStr;
end;

procedure TForm7.ibDataSet23DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  if Limpanumero(Text) <> Text then
  begin
    Form7.ibDataSet4.DisableControls;
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.SelectSQL.Clear;
    Form7.ibDataSet4.SelectSQL.Add('select *');
    Form7.ibDataSet4.SelectSQL.Add('from ESTOQUE');
    Form7.ibDataSet4.SelectSQL.Add('where (upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(Text)+'%')+')');
    Form7.ibDataSet4.SelectSQL.Add(RetornarWhereAtivoEstoqueCompra);
    Form7.ibDataSet4.SelectSQL.Add('order by upper(DESCRICAO)');
    Form7.ibDataSet4.Open;
    Form7.ibDataSet4.First;
    Form7.ibDataSet4.EnableControls;
  end;
  ibDataSet23DESCRICAO.AsString := Text;
end;

function TForm7.RetornarWhereAtivoEstoqueCompra: String;
begin
  Result := EmptyStr;
  if not FbImportandoXML then
    Result := 'AND ((COALESCE(ATIVO,0)=0) OR ((ATIVO=1) AND (TIPO_ITEM=''01'')))';
end;

procedure TForm7.ibDataSet23QUANTIDADEChange(Sender: TField);
begin
  // Quando altera a quantidade recalcula o valor
  // total, mas s quando o valor total  alterado
  if (Form7.ibDataSet23QUANTIDADE.Value < 0) then
  begin
    //ShowMessage('Valor invlido na quantidade.');  Mauricio Parizotto 2023-10-25
    MensagemSistema('Valor invlido na quantidade.',msgAtencao);
    Form7.ibDataSet23.Edit;
    Form7.ibDataSet23QUANTIDADE.Value := 0;
  end;
  if (Form7.ibDataSet23UNITARIO.Value < 0 ) then
  begin
    //ShowMessage('Valor invlido na campo valor unitrio.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Valor invlido na campo valor unitrio.',msgAtencao);
    Form7.ibDataSet23.Edit;
    Form7.ibDataSet23UNITARIO.Value := 0;
  end;
  
  if Form7.ibDataSet23QUANTIDADE.Value <> 0 then
  begin
    if Arredonda(Form7.ibDataSet23TOTAL.Value,StrToInt(Form1.ConfPreco)) <> Arredonda(Form7.ibDataSet23QUANTIDADE.AsFloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco)) then
    begin
      Form7.ibDataSet23.Edit;
      Form7.ibDataSet23TOTAL.Value := Arredonda(Form7.ibDataSet23QUANTIDADE.AsFloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));
    end;
  end else
  begin
    if Form7.ibDataSet23TOTAL.Value <> 0 then
    begin
      Form7.ibDataSet23.Edit;
      Form7.ibDataSet23TOTAL.Value := 0;
      Form7.ibDataSet23UNITARIO.Value := 0;
    end;
  end;
end;

procedure TForm7.ibDataSet23QUANTIDADESetText(Sender: TField;
  const Text: String);
begin
  //
  // Serie
  //
  if Form7.ibDataSet4.FieldByname('SERIE').Value = 1 then
  begin
    Form7.ibDataSet23QUANTIDADE.AsString  := Form7.ibDataSet23QUANTIDADE.AsString;
    Form7.ibDataSet23QTD_ORIGINAL.AsString  := Form7.ibDataSet23QTD_ORIGINAL.AsString;
  end else
  begin
    //
    // Grade
    //
    Form7.ibDataSet10.Close;
    Form7.ibDataSet10.SelectSQL.Clear;
    Form7.ibDataSet10.Selectsql.Add('select * from GRADE where CODIGO='+QuotedStr(Form7.ibDataSet4CODIGO.AsString)+' order by CODIGO, COR, TAMANHO');
    Form7.ibDataSet10.Open;
    Form7.ibDataSet10.First;
    //
    if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet10CODIGO.AsString then
    begin
      Form1.rReserva := ibDataSet23QUANTIDADE.AsFloat;
    end else
    begin
      ibDataSet23QUANTIDADE.AsFloat   := StrToFloat(Text);
      ibDataSet23QTD_ORIGINAL.AsFloat := StrToFloat(Text);
    end;
  end;
  //
end;

procedure TForm7.ibDataSet23TOTALChange(Sender: TField);
begin
  {                                                   }
  { S altera o valor unitrio quando for necessrio  }
  {                                                   }
  if Form7.ibDataSet23QUANTIDADE.Value <> 0 then
  begin
    if (Form7.ibDataSet23UNITARIO.AsFloat - (Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat) > 0.001)
    or ((Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat) - Form7.ibDataSet23UNITARIO.AsFloat > 0.001) then
    begin
      Form7.ibDataSet23.Edit;
//      Form7.ibDataSet23UNITARIO.AsFloat    := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat,StrToInt(Form1.ConfPreco));
//      Form7.ibDataSet23UNITARIO_O.Asfloat  := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QTD_ORIGINAL.Asfloat,StrToInt(Form1.ConfPreco));
      Form7.ibDataSet23UNITARIO.AsFloat    := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QUANTIDADE.Asfloat,4);
      Form7.ibDataSet23UNITARIO_O.Asfloat  := Arredonda(Form7.ibDataSet23TOTAL.AsFloat / Form7.ibDataSet23QTD_ORIGINAL.Asfloat,4);
    end;
  end;
  //
end;

procedure TForm7.ibDataSet23IPIChange(Sender: TField);
begin
  if Sender.AsFloat >= 100 then Sender.AsFloat := 0;
end;

procedure TForm7.ibDataSet23CFOPSetText(Sender: TField; const Text: String);
begin
  if LimpaNumero(Text) <> '' then
  begin
    if ((Copy(LimpaNumero(Text),1,1) <> '1')
        and (Copy(LimpaNumero(Text),1,1) <> '2')
        and (Copy(LimpaNumero(Text),1,1) <> '3')) then
     //ShowMessage('CFOP Invlido') Mauricio Parizotto 2023-10-25
     MensagemSistema('CFOP Invlido',msgAtencao)
    else
      ibDataSet23CFOP.AsString := LimpaNumero(Text);
  end else
    ibDataSet23CFOP.AsString := '';
end;

procedure TForm7.ibDataSet23NewRecord(DataSet: TDataSet);
begin
  //
  if Alltrim(ibDataSet24FORNECEDOR.AsString) <> '' then
  begin
    ibDataSet23REGISTRO.AsString   := sProximo;
    ibDataSet23SINCRONIA.AsFloat   := 0;                                    // Resolvi este problema as 4 da madrugada no NoteBook em casa
    ibDataSet23NUMERONF.AsString   := Form7.ibDataset24NUMERONF.AsString;
    ibDataSet23FORNECEDOR.AsString := ibDataSet24FORNECEDOR.AsString;
  end else
  begin
    //ShowMessage('Selecione um fornecedor.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Selecione um fornecedor.');

    try
      if Form24.SMALL_DBEdit39.CanFocus then Form24.SMALL_DBEdit39.SetFocus;
    except
    end;

    Abort;
  end;
end;

procedure TForm7.ibDataSet24NewRecord(DataSet: TDataSet);
begin
  //
  sFornecedorAntigo := '';
  //
  {Sandro Silva 2023-11-28 inicio
  Form7.ibDataSet24.DisableControls;

  //LogRetaguarda('ibDataSet24.DisableControls; 21548'); // Sandro Silva 2023-11-27
  }
  {
  Form7.ibDataSet23.DisableControls;
  //LogRetaguarda('unit7 ibDataSet23.DisableControls 21551'); // Sandro Silva 2023-12-04
  }
  Form7.ibDataSet8.DisableControls;
  //
  Form7.ibDataSet24REGISTRO.AsString  := sProximo;
  Form7.ibDataSet24MERCADORIA.Value   := 0;
  Form7.ibDataSet24SERVICOS.Value     := 0;
  Form7.ibDataSet24FRETE.Value        := 0;
  Form7.ibDataSet24SEGURO.Value       := 0;
  Form7.ibDataSet24IPI.Value          := 0;
  Form7.ibDataSet24DESPESAS.Value     := 0;
  Form7.ibDataSet24BASEICM.Value      := 0;
  Form7.ibDataSet24ISS.Value          := 0;
  Form7.ibDataSet24ICMS.Value         := 0;
  Form7.ibDataSet24EMISSAO.Value  := Date;
  Form7.ibDataSet24SAIDAD.Value   := Date;
  Form7.ibDataSet24SAIDAH.Value   := TimeToStr(Time);
  Form7.ibDataSet24NFEID.Value    := '0000000000000000000000000000000000000000000';
  //
  Form7.ibDataSet24.Post;
  Form7.ibDataSet24.Edit;
end;

procedure TForm7.lblNovoMouseLeave(Sender: TObject);
begin
  if Form7.lblNovo.Font.Style <> [] then
  begin
    Form7.imgNovo.Picture    := Form7.Image201_R.Picture;
    Form7.lblNovo.Font.Style := [];
  end;
end;

procedure TForm7.lblNovoMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
  if Form7.lblNovo.Font.Style <> [fsBold] then
  begin
    Form7.imgNovo.Picture    := Form7.Image201_X.Picture;
    Form7.lblNovo.Font.Style := [fsBold];
  end;
end;

procedure TForm7.ibDataSet3AfterDelete(DataSet: TDataSet);
begin
  ibDataSet3.First;
  if ibDataSet3.Eof then ibDataSet3.Append;
  AgendaCommit(True);  
end;

procedure TForm7.ibDataSet35UNITARIOChange(Sender: TField);
begin
  if Form7.ibDataSet35QUANTIDADE.AsFloat > 0 then
  begin
//    if Format('%12.4n',[(Form7.ibDataSet35UNITARIO.AsFloat)]) <> Format('%12.4n',[(Form7.ibDataSet35TOTAL.AsFloat / Form7.ibDataSet35QUANTIDADE.AsFloat)]) then
    if StrZero(Form7.ibDataSet35TOTAL.AsFloat,12,4) <> StrZero(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,12,4) then
    begin
      Form7.ibDataSet35.Edit;
//      Form7.ibDataSet35TOTAL.AsFloat := Arredonda(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,StrToInt(Form1.ConfPreco));
      Form7.ibDataSet35TOTAL.AsString := StrZero(Form7.ibDataSet35UNITARIO.AsFloat * Form7.ibDataSet35QUANTIDADE.AsFloat,12,4);
    end;
    if Form7.sModulo = 'OS' then
      TotalizaOS(False,True);

    if Form7.sModulo = 'VENDA' then
      TotalizaServicos(True);
  end;
end;

procedure TForm7.ibDataSet15BeforeDelete(DataSet: TDataSet);
var
  bButton : Integer;
  ssModulo : String;
begin
  //
  // Antes de apagar
  //
  ssModulo := Form7.sModulo;
  //
  if (AllTrim(Form7.ibDataSet15STATUS.AsString) = '') or (Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada') or (Pos('denegado',LowerCase(Form7.ibDataSet15STATUS.AsString)) <> 0) or (AllTrim(Form7.ibDataSet15CLIENTE.AsString)='') then
  begin
    //
    if AllTrim(Form7.ibDataSet15STATUS.AsString) = '' then
    begin
      //
      if AllTrim(Form7.ibDataSet15CLIENTE.AsString) <> '' then
      begin
        bButton := Application.MessageBox(Pchar('Ateno:'+chr(10)
                                          + Chr(10)
                                          + 'Cancelar a NF ' + Copy(Form7.ibDataSet15NUMERONF.AsString,1,9) + '?'
                                          + Chr(10))
                                          ,'Ateno',
                                                mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);

        Screen.Cursor := crHourGlass; // Cursor de Aguardo
      end else bButton := IDYES;
      //
    end else
    begin
      if Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada' then
        bButton := IDYES else bButton := IDNO;
      
      if (Pos('denegado',LowerCase(Form7.ibDataSet15STATUS.AsString)) <> 0) then
      begin
        {
          ShowMessage(Pchar('Ateno:'+chr(10)
                                            + Chr(10)
                                            + 'Esta nota fiscal foi denegada (Por irregularidade fiscal). O nmero desta NF-e no podera ser reutilizado e o XML devera ser guardado pelo praso decadencial.'
                                            + Chr(10)));
         Mauricio Parizotto 2023-10-25}
        MensagemSistema('Ateno:'+chr(10)
                        + Chr(10)
                        + 'Esta nota fiscal foi denegada (Por irregularidade fiscal). O nmero desta NF-e no podera ser reutilizado e o XML devera ser guardado pelo praso decadencial.'
                        + Chr(10)
                        ,msgAtencao);

        bButton := IDYES;
      end;
    end;

    Screen.Cursor := crHourGlass; // Cursor de Aguardo

    if bButton = IDYES then
    begin
      try
        // Servicos
        Screen.Cursor := crHourGlass; // Cursor de Aguardo
        
        Form7.ibDataSet35.First;
        while not Form7.ibDataSet35.Eof do
        begin
          if AllTrim(Form7.ibDataSet35NUMEROOS.AsString) = '' then  Form7.ibDataSet35.Delete else
          begin
            Form7.ibDataSet35.Edit;
            Form7.ibDataSet35NUMERONF.AsString := '';
            Form7.ibDataSet35.Next;
          end;
        end;

        // Produtos
        if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet15OPERACAO.AsString then
          Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
          
        Screen.Cursor := crHourGlass; // Cursor de Aguardo
        //
        Form7.ibDataSet16.DisableControls;
        Form7.ibDataSet16.First;
        while not Form7.ibDataSet16.Eof do // Disable
        begin
          Screen.Cursor := crHourGlass; // Cursor de Aguardo
          //
          if AllTrim(Form7.ibDataSet16NUMEROOS.AsString) = '' then
          begin
            try
              Form7.ibDataSet4.Close;
              Form7.ibDataSet4.Selectsql.Clear;
              Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet16DESCRICAO.AsString)+' ');
              Form7.ibDataSet4.Open;
            except end;

            if (Form7.ibDataSet16DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString) and (AllTRim(Form7.ibDataSet4DESCRICAO.AsString)<>'') then
            begin
              try
                // Quando nao baixa estoque tambem nao pode devolver
                if (TestarNatOperacaoMovEstoque) and (Copy(Form7.ibDataSet14CFOP.AsString,2,3) <> '929') then
                begin
                  Form7.ibDataSet4.Edit;
                  Form7.ibDataSet4QTD_ATUAL.AsFloat := Form7.ibDataSet4QTD_ATUAL.AsFloat + Form7.ibDataSet16SINCRONIA.AsFloat; // S retorna o SINCRONIA que realmente saiu do estoque. No caso de nf qua ainda no foi autorizada SINCRONIA  igual a 0 (zero)
                  Form7.ibDataSet4.Post;
                end;
              except end;
            end;
            //
            Form7.ibDataSet16.Delete
          end else
          begin
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16NUMERONF.AsString := '';
            Form7.ibDataSet16.Next;
            //
            Form7.ibDataSet3.Close;
            Form7.ibDataSet3.SelectSQL.Clear;
            Form7.ibDataSet3.SelectSQL.Add('select * from OS where NUMERO='+QuotedStr(Form7.ibDataSet16NUMEROOS.AsString)+' ');
            Form7.ibDataSet3.Open;
            Form7.ibDataSet3.First;
            //
            while not Form7.ibDataSet3.Eof do
            begin
              Form7.ibDataSet3.Edit;
              Form7.ibDataSet3SITUACAO.AsString := 'Aberta';
              Form7.ibDataSet3.Post;
              Form7.ibDataSet3.Next;
            end;
          end;
        end;

        Form7.ibDataSet15.EnableControls;
        // Receber
        if sModulo = 'VENDA' then
        begin
          Screen.Cursor := crHourGlass; // Cursor de Aguardo
          Form7.ibDataSet7.First;
          //
          if Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada' then
          begin
            while not Form7.ibDataSet7.Eof do
            begin
              if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
              begin
                if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
                begin
                  Form7.ibDataSet7.Edit;
                  Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
                end else
                begin
                  Form7.ibDataSet7.Edit;
                  Form7.ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
                end;
                //
                Form7.ibDataSet7ATIVO.AsString := '1';
                Form7.ibDataSet7.Post;
                Form7.ibDataSet7.Next;
                //
              end else
              begin
                Form7.ibDataSet7.Next;
              end;
              //
            end;
            //
          end else
          begin
            //
            while not Form7.ibDataSet7.Eof do
            begin
              if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
              begin
                Form7.ibDataSet7.Delete;
              end else
              begin
                Form7.ibDataSet7.Next;
              end;
            end;
            //
          end;
        end;
        //
        // CAIXA
        //
        ApagaIntegracaoComOCaixa(True);
        //
        //
        Form7.ibDataSet15.EnableControls;
        Form7.ibDataSet35.EnableControls;
        //
        if form21.Visible then form21.Close;
        //
      except end;
      //
      // Reaproveita o Nmero do NSU
      //
      IBDataSet99.Close;
      IBDataSet99.SelectSQL.Clear;
      IBDataSet99.SelectSQL.Add('select gen_id(G_NSU,0) from rdb$database');
      IBDataSet99.Open;
      //
      if (Form7.ibDataSet15NSU.AsString = StrZero(StrtoFloat(AllTrim(ibDataSet99.FieldByname('GEN_ID').AsString)),10,0)) and (Form7.ibDataSet15STATUS.AsString = '') then
      begin
        //
        IBDataSet99.Close;
        IBDataSet99.SelectSQL.Clear;
        IBDataSet99.SelectSQL.Add('select gen_id(G_NSU,-1) from rdb$database');
        IBDataSet99.Open;
        //
        // Reaproveita o Nmero da NF
        //
        if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 001' then
        begin
          Form7.IBDataSet99.Close;
          Form7.IBDataSet99.SelectSQL.Clear;
          Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE1,0) from rdb$database');
          Form7.IBDataSet99.Open;
          if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+'001' then
          begin
            IBDataSet99.Close;
            IBDataSet99.SelectSQL.Clear;
            IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE1,-1) from rdb$database');
            IBDataSet99.Open;
          end;
        end else
        begin
          if Form7.sTitulo = 'Notas fiscais de sada (vendas) srie 002' then
          begin
            Form7.IBDataSet99.Close;
            Form7.IBDataSet99.SelectSQL.Clear;
            Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE2,0) from rdb$database');
            Form7.IBDataSet99.Open;
            if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+'002' then
            begin
              IBDataSet99.Close;
              IBDataSet99.SelectSQL.Clear;
              IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE2,-1) from rdb$database');
              IBDataSet99.Open;
            end;
          end else
          begin
            if Form7.sTitulo = 'Notas fiscais de sada (vendas) com CPF srie 920' then
            begin
              //
              // Notas fiscais de sada (vendas) srie 001
              // Notas fiscais de sada (vendas) srie 002
              // Notas fiscais de sada (vendas) srie XXX
              // Notas fiscais de sada (vendas) com CPF srie 920
              //
              Form7.IBDataSet99.Close;
              Form7.IBDataSet99.SelectSQL.Clear;
              Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE920,0) from rdb$database');
              Form7.IBDataSet99.Open;
              //
              if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+'920' then
              begin
                IBDataSet99.Close;
                IBDataSet99.SelectSQL.Clear;
                IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE920,-1) from rdb$database');
                IBDataSet99.Open;
              end;
              //
            end else
            begin
              //
              Form7.IBDataSet99.Close;
              Form7.IBDataSet99.SelectSQL.Clear;
              Form7.ibDataset99.SelectSql.Add('select gen_id(G_SERIE'+Right(Form7.sTitulo,3)+',0) from rdb$database');
              Form7.IBDataSet99.Open;
              //
              if Form7.ibDataSet15NUMERONF.AsString = StrZero(StrtoFloat(Form7.ibDataSet99.FieldByname('GEN_ID').AsString),9,0)+Right(Form7.sTitulo,3) then
              begin
                IBDataSet99.Close;
                IBDataSet99.SelectSQL.Clear;
                IBDataSet99.SelectSQL.Add('select gen_id(G_SERIE'+Right(Form7.sTitulo,3)+',-1) from rdb$database');
                IBDataSet99.Open;
              end;
              //
            end;
          end;
        end;
      end else
      begin
        //
        Form7.ibDataSet15.Edit; Form7.ibDataSet15MERCADORIA.AsFloat    := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15DESCONTO.AsFloat      := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15SERVICOS.AsFloat      := 0; // Reaproveita a nota
        Form7.ibDataSet15.Edit; Form7.ibDataSet15ICMSSUBSTI.AsFloat    := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15DESPESAS.AsFloat      := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15FRETE.AsFloat         := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15SEGURO.AsFloat        := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15IPI.AsFloat           := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15ICMS.AsFloat          := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15BASEICM.AsFloat       := 0;
        Form7.ibDataSet15.Edit; Form7.ibDataSet15EMITIDA.AsString      := 'X';
        //
        Screen.Cursor := crDefault; // Cursor de Aguardo
        Form7.sModulo := ssModulo;
        Abort;
        //
      end;
    end else
    begin
      Screen.Cursor := crDefault; // Cursor de Aguardo
      Form7.sModulo := ssModulo;
      Abort;
    end;
  end else
  begin
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.sModulo := ssModulo;
    Abort;
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.sModulo := ssModulo;

  RegistraExclusaoRegistro(ibDataSet15, 'VENDA');
  //
end;

procedure TForm7.ibDataSet24BeforeDelete(DataSet: TDataSet);
var
  bButton : Integer;
begin
  //
  if Form7.sModulo <> 'DUPLA' then
  begin
    //
    if AllTrim(Form7.ibDataSet24FORNECEDOR.AsString) <> '' then
    begin
      bButton := Application.MessageBox(Pchar('Ateno:'+chr(10)
                                        + Chr(10)
                                        + 'Apagar a NF de compra ' + Form7.ibDataSet24NUMERONF.AsString + '?'
                                        + Chr(10))
                                        ,'Ateno',
                                              mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    end else bButton := IDYES;
    //
    if bButton = IDYES then
    begin
      //
      Screen.Cursor := crHourGlass; // Cursor de Aguardo
      //
      if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet24OPERACAO.AsString then Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet24OPERACAO.AsString,[]);
      //
      Form7.ibDataSet23.DisableControls;
      //LogRetaguarda('unit7 ibDataSet23.DisableControls 21962'); // Sandro Silva 2023-12-04
      Form7.ibDataSet4.DisableControls;
      //
      Form7.ibDataSet23.First;
      //{Sandro Silva 2023-08-23 inicio
      while not Form7.ibDataSet23.Eof do
      begin
        //
        Form7.ibDataSet4.Close;
        Form7.ibDataSet4.Selectsql.Clear;
        Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet23DESCRICAO.AsString)+' ');
        Form7.ibDataSet4.Open;
        //
        if (Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet23CODIGO.AsString) and (Form7.ibDataSet4CODIGO.AsString <>'') then
        begin
          if TestarNatOperacaoMovEstoque then
          begin
            Form7.ibDataSet4.Edit;
            Form7.ibDataSet4QTD_ATUAL.AsFloat := Form7.ibDataSet4QTD_ATUAL.AsFloat - Form7.ibDataSet23QUANTIDADE.AsFloat;
            Form7.ibDataSet4.Post;
          end;
        end;
        //
        Form7.ibDataSet23.Delete;
        Form7.ibDataSet23.First;
        //
      end;
      //
      Form7.ibDataSet23.EnableControls;
      //LogRetaguarda('unit7 ibDataSet23.EnableControls 21991'); // Sandro Silva 2023-12-04
      Form7.ibDataSet4.EnableControls;
      //
      // Contas a PAGAR
      //
      if sModulo = 'COMPRA' then
      begin
        Form7.ibDataSet8.First;
        while not Form7.ibDataSet8.Eof do
        begin
          if Form7.ibDataSet8NUMERONF.AsString = Form7.ibDataSet24NUMERONF.AsString then
            Form7.ibDataSet8.Delete
          else
            Form7.ibDataSet8.Next;
        end;
      end;
      //
      Screen.Cursor := crDefault; // Cursor de Aguardo
      //
    end else Abort;
  end;
  RegistraExclusaoRegistro(ibDataSet24);
  //
end;

procedure TForm7.MenuItem183Click(Sender: TObject);
begin
  ImprimirNF3.Visible                     := (TestarNFeHomologacao);
  //
  //ImprimirNF3.Caption := 'Imprimir NF nmero '+ Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet24FORNECEDOR.AsString;
  DevolverNF1.Caption := 'Devolver NF nmero '+ Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) +' de '+Form7.ibDataSet24FORNECEDOR.AsString;
  //
  if FileExists(Form1.sAtual+'\CaulculoDoCustoDaUlimtaNota.txt') then ClculodoCustodaltimaNota1.Enabled := True else ClculodoCustodaltimaNota1.Enabled := False;
  //
end;

procedure TForm7.ImprimirNF3Click(Sender: TObject);
begin
  Unit24.ImprimeOuNaoANota2(True)
end;

procedure TForm7.Enviaremailparatodos1Click(Sender: TObject);
var
  //
  sRegistro, sX, sMsg, sEmail, sAssunto : String;
  bButton, I, II  : Integer;
  Mais1ini : tIniFile;
  //
  F : TExtfile;
  //
begin
  //
  Form40.OpenDialog1.FileName := '';
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<HISTORICO>');
  Form40.Memo2.Lines.Add('<PORTADOR>');
  Form40.Memo2.Lines.Add('<DOCUMENTO>');
  Form40.Memo2.Lines.Add('<EMISSAO>');
  Form40.Memo2.Lines.Add('<VENCIMENTO>');
  Form40.Memo2.Lines.Add('<VALOR_DUPL>');
  Form40.Memo2.Lines.Add('<CODEBAR>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>');
  //
  Form40.ShowModal;
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail para os clientes e' + chr(10) +
              Chr(10) + 'fornecedores filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    I := 0;
    //
    if bButton = IDYES then
    begin
      //
      sX := '';
      //
      Form7.ibDataSet2.First;
      //
      // Retorna onde parou
      //
      Mais1ini := TIniFile.Create('frente.ini');
      sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;
      //
      AssignFile(F,pchar(Form1.sAtual+'\E-MAIL.TXT'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      //
      if sRegistro <> 'FIM' then
      begin
        //
        bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        if bButton = IDYES then
        begin
          //
          while (not Form7.ibDataSet2.Eof) and (sRegistro <> Form7.ibDataSet2.FieldByName('REGISTRO').AsString) do
          begin
            //
            if VAlidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
          if sRegistro = Form7.ibDataSet2.FieldByName('REGISTRO').AsString then
          begin
            //
            if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
        end;
        //
      end;
      //
      Mais1ini.Free;
      //
      Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
      Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
      Form7.Panel1.Visible := True;
      //
      while not Form7.ibDataSet2.Eof do
      begin
        //
        if VAlidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
        begin
          //
          if I <> 0 then
          begin
            for II := 1 to 700 do
            begin
              //
              try
                Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
              except end;
              //
              Application.ProcessMessages;
              //
            end;
          end;
          //
          sASsunto := Form40.Edit1.Text;
          sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          //
          sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
          //
          sMsg := Form40.Memo1.Lines.Text;
          //
          // CLIENTES
          //
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
          sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
          sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
          sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
          sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
          sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
          sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
          sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
          sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
          sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
          sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
          sMsg := StrTran(sMsg,'<CONTATOS>'      ,Form7.ibDataSet2.FieldByName('CONTATOS' ).AsString);
          sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
          sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
          //
          sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
          //
          sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
          sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
          sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
          sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
          //
          sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
          sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
          sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
          sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
          sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
          sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
          sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
          //
          if (FileExists(pChar(Form40.OpenDialog1.FileName))) and (Alltrim(Form40.OpenDialog1.FileName)<>'') then
          begin
            EnviarEMail('', sEmail,'', PChar(sAssunto), PChar(sMSG), PChar(Form40.OpenDialog1.FileName), False); //2024-02-26 EnviarEMail('',sEmail,'',sAssunto,sMSG,pChar(Form40.OpenDialog1.FileName), False);
          end else
          begin
            EnviarEMail('', sEmail, '', PChar(sAssunto), PChar(sMSG), '', False);
          end;
          //
          I := I + 1;
          //
          Mais1ini := TIniFile.Create('frente.ini');
          Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet2.FieldByName('REGISTRO').AsString));
          Mais1Ini.Free;
          //
          Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
          Form7.Panel1.Repaint;
          //
        end;
        //
        Form7.ibDataSet2.Next;
        //
      end;
      //
      try
        CloseFile(F); // Fecha o arquivo
      except end;
      //
    end;
    //
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    //
    try
      Mais1ini := TIniFile.Create('frente.ini');
      Mais1Ini.WriteString('mail','Registro','FIM');
      Mais1Ini.Free;
    except end;
  end;  
  //
end;

procedure TForm7.Emaildecobrana1Click(Sender: TObject);
var
  sSecoes :  TStrings;
  sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, II, J : Integer;
//  PDF: TPrintPDF;
  PDF :TPdfDocumentGDI;
  PAGE : TPdfPage;
begin
  Form40.Tag := 0;
  Form40.CheckBox1.Visible := True;
  Form40.ShowModal;

  if Form1.Tag = 1 then
  begin
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail de cobrana para os clientes' + chr(10) +
              Chr(10) + 'filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);

    try
      if bButton = IDYES then
      begin
        I := 0;
        Form7.ibDataSet7.First;

        // Retorna onde parou
        Mais1ini := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;

        if sRegistro <> 'FIM' then
        begin
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          if bButton = IDYES then
          begin
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;

              if Form7.ibDataSet7ATIVO.AsFloat <> 1 then
              begin
                if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
                begin
                  I := I + 1;
                end;
              end;

              Form7.ibDataSet7.Next;
            end;

            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              if Form7.ibDataSet7ATIVO.AsFloat <> 1 then
              begin
                if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
                begin
                  I := I + 1;
                end;
              end;

              Form7.ibDataSet7.Next;
            end;
          end;
        end;

        Mais1ini.Free;
        
        while not Form7.ibDataSet7.Eof do
        begin
          try
            // No relacionar os inativos
            if Form7.ibDataSet7ATIVO.AsFloat <> 1 then
            begin
              // Relaciona os clientes com o arquivo de vendas
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;

              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                sArquivo := '';

                if Form7.sModulo = 'RECEBER' then
                begin
                  if Form40.CheckBox1.Checked then
                  begin
                    while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf') do
                    begin
                      DeleteFile(pchar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf'));
                      Sleep(1000);
                    end;

                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;
                    try
                      // Cria o PDF
                      { Mauricio Parizotto 2024-02-15 Inicio
                      PDF := TPrintPDF.Create(Self);

                      // Configuraes do documento
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;

                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf';// sFileCFeSAT;
                      //
                      // Inicia o documento pdf
                      //
                      PDF.BeginDoc;

                      }

                      try
                        PDF:=TPdfDocumentGDI.Create();
                        PDF.Info.Author       := 'Small';
                        PDF.Info.Creator      := 'Small';
                        PDF.Info.Title        := 'Boletos';
                        PDF.Info.Subject      := 'Boletos de cobrana';
                        PDF.Info.CreationDate := now;
                        PDF.DefaultPaperSize := psA4; //Tamanho A4
                        PDF.ForceJPEGCompression := 0;
                        PDF.AddTrueTypeFont('Interleaved 2of5 Text');
                        PDF.EmbeddedTTF := True;
                        PDF.EmbeddedWholeTTF := true;

                        PAGE := pdf.AddPage;
                        PAGE.PageLandscape := False;

                        Form1.sEscolhido := '';
                        Form1.sBancoBoleto := '';

                        try
                          sSecoes := TStringList.Create;
                          Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                          Mais1Ini.ReadSections(sSecoes);

                          for J := 0 to (sSecoes.Count - 1) do
                          begin
                            if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                             or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                            and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                            or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                            begin
                              Form1.sEscolhido := sSecoes[J];
                            end;
                          end;

                          Mais1Ini.Free;
                        except
                        end;

                        begin
                          Form1.sBancoBoleto     := Trim(StringReplace(Form1.sEscolhido, 'Boleto de cobrana do', '', [rfReplaceAll]));
                          Form25.EventoShow;
                          Form7.Repaint;
                          Form25.CarregaConfiguracao;
                          Form25.CarregaDadosParcela;

                          //Mauricio Parizotto 2024-02-19
                          DesenhaBoletoLayoutPadrao(PDF.VCLCanvas, grPDF, Copy(Form26.MaskEdit42.Text,1,3), Form26.MaskEdit44.Text, Form26.MaskEdit46.Text, Form26.MaskEdit50.Text, Form26.MaskEdit43.Text, Form26.MaskEdit47.Text, Form26.MaskEdit45.Text);

                          PDF.SaveToFile(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf');

                          // Fecha o pdf
                          if FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf') then
                            sArquivo := Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.pdf'
                          else
                            sArquivo := '';
                        end;
                      finally
                        FreeAndNil(PDF);
                      end;
                    except
                    end;

                    Form25.Close;
                    Form7.Repaint;

                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                  end;
                end;
                
                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                //
                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL
                //
                sMsg := Form40.Memo1.Lines.Text;

                // CLIENTES
                if I <> 0 then
                begin
                  for II := 1 to 700 do
                  begin
                    try
                      Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
                    except
                    end;

                    Application.ProcessMessages;
                  end;
                end;

                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                // CONTAS A RECEBER
                sMsg := StrTran(sMsg,'<HISTORICO>'     ,Form7.ibDataSet7.FieldByName('HISTORICO'     ).AsString);
                sMsg := StrTran(sMsg,'<PORTADOR>'      ,Form7.ibDataSet7.FieldByName('PORTADOR'      ).AsString);
                sMsg := StrTran(sMsg,'<DOCUMENTO>'     ,Form7.ibDataSet7.FieldByName('DOCUMENTO'     ).AsString);
                sMsg := StrTran(sMsg,'<EMISSAO>'       ,Form7.ibDataSet7.FieldByName('EMISSAO'       ).AsString);
                sMsg := StrTran(sMsg,'<VENCIMENTO>'    ,Form7.ibDataSet7.FieldByName('VENCIMENTO'    ).AsString);
                //
                sMsg := StrTran(sMsg,'<VALOR_DUPL>'    ,AllTrim(Format('%12.2n',[Form7.ibDataSet7.FieldByName('VALOR_DUPL').AsFloat])));
                sMsg := StrTran(sMsg,'<VALOR_JURO>'    ,AllTrim(Format('%12.2n',[Form7.ibDataSet7.FieldByName('VALOR_JURO').AsFloat])));
                sMsg := StrTran(sMsg,'<CODEBAR>'       ,AllTrim(Form7.ibDataSet7.FieldByName('CODEBAR').AsString));
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));

                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));

                EnviarEMail('', sEmail, '', PChar(sAssunto), PChar(sMSG), PChar(sArquivo), False);

                I := I + 1;
                //
                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;
                //
                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;
                //
                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
                Form7.Panel1.Repaint;
              end;
            end;
          except
          end;

          Form7.ibDataSet7.Next;
        end;
      end;
    except
    end;

    Form7.Panel1.Visible := False;
    Form7.Repaint;
  end;
end;

procedure TForm7.NotasfiscaisdesadavendasSrie11Click(Sender: TObject);
var
  Mais1ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie 002';
  Form7.sRPS := 'N';
  //
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE 2');
  Mais1Ini.Free;
  //
  //sSerieNFSelecionada := '002';
end;

procedure TForm7.Rankingdedevedores1Click(Sender: TObject);
begin
  //
  sModuloAnterior                 := sModulo;
  Form38.ComboBox1.Visible        := True;
  Form38.Panel6.Visible           := True;
  Form7.sModulo                   := 'Ranking de devedores';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet1BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataset99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CAIXA,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except abort end;
  //
  fValorAnterior := 0;
end;

procedure TForm7.IBDataSet2NewRecord(DataSet: TDataSet);
begin
  ibDataSet2REGISTRO.AsString   := sProximo;
  ibDataSet2CADASTRO.AsDateTime := Date;
end;

procedure TForm7.DBGrid1ColEnter(Sender: TObject);
begin
  {Mauriico Parizotto 2024-01-04
  ArquivoAberto.DisableControls;
  if ArquivoAberto.MoveBy(+1) = 1 then
    ArquivoAberto.MoveBy(-1)
  else
    if ArquivoAberto.MoveBy(-1) = -1 then
        ArquivoAberto.MoveBy(+1);


  ArquivoAberto.EnableControls;
  }
end;

procedure TForm7.ibDataSet15BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_VENDAS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet16BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENS001,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet19BeforeInsert(DataSet: TDataSet);
begin
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_NOTA,1) from rdb$database');
  ibDataset99.Open;
  sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
  ibDataset99.Close;
end;

procedure TForm7.ibDataSet24BeforeInsert(DataSet: TDataSet);
begin
  //
  if Form7.ibDataSet24.RecordCount > 0 then // tem registro selecionado
  begin
    try
      if Alltrim(Form7.ibDataSet24FORNECEDOR.AsString) = '' then
        Form7.ibDataSet24.Delete;
    except
    end;
  end;
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_COMPRAS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
  //
end;

procedure TForm7.ibDataSet3BeforeInsert(DataSet: TDataSet);
begin
  if (not Form7.ibDataSet3.Bof) then try if Alltrim(Form7.ibDataSet3CLIENTE.AsString) = '' then Form7.ibDataSet3.Delete; except end;
  
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_OS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);

    //Mauricio Parizotto 2023-12-08
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_OSIDOS,1) from rdb$database');
    ibDataset99.Open;
    sProximoID := ibDataSet99.FieldByname('GEN_ID').AsInteger;
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.IBDataSet2BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CLIFOR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet7BeforeInsert(DataSet: TDataSet);
begin
  {Sandro Silva 2023-07-20 inicio}
  if Form7.ibDataSet7.Tag = ID_BLOQUEAR_APPEND_NO_GRID_DESDOBRAMENTO_PARCELAS then
    Abort;
  {Sandro Silva 2023-07-20 fim}
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_RECEBER,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
  fValorAnterior := 0;
  //
end;

procedure TForm7.ibDataSet9BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_VENDEDOR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet12BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CONTAS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet14BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ICM,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet8BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_PAGAR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
  fValorAnterior := 0;
  //
end;

procedure TForm7.ibDataSet18BeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibDataSet18);
end;

procedure TForm7.ibDataSet18BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_TRANSPOR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet29BeforeInsert(DataSet: TDataSet);
begin
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_CONVENIO,1) from rdb$database');
  ibDataset99.Open;
  sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
  ibDataset99.Close;
end;

procedure TForm7.ibDataSet5BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_MOVIMENT,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
  fValorAnterior := 0;
end;

procedure TForm7.ibDataSet23BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENS002,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet35BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENS003,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet30BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_SERIE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet27BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ALTERACA,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_HASH_ALTERACA,1) from rdb$database');
    ibDataset99.Open;
    //
  except Abort end;
  //
  HasHs('ALTERACA',True);
  //
end;

procedure TForm7.ibDataSet25BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_FLUXO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet26BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_RESUMO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet13BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_EMITENTE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibDataSet21BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_GRUPO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet10BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_GRADE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet28BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_COMPOSTO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.ibDataSet26NewRecord(DataSet: TDataSet);
begin
  Form7.ibDataSet26.FieldByName('REGISTRO').AsString := sProximo;
end;

procedure TForm7.ibDataSet27NewRecord(DataSet: TDataSet);
begin
  ibDataSet27REGISTRO.AsString  := sProximo;
end;

procedure TForm7.ibDataSet14NewRecord(DataSet: TDataSet);
begin
  ibDataSet14REGISTRO.AsString  := sProximo;
end;

procedure TForm7.ibDataSet18NewRecord(DataSet: TDataSet);
begin
  ibDataSet18REGISTRO.AsString := sProximo;

end;

procedure TForm7.ibDataSet29NewRecord(DataSet: TDataSet);
begin
  ibDataSet29REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet35NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet35.Edit;
  ibDataSet35REGISTRO.AsString := sProximo;
  if form7.sModulo = 'OS' then
  begin
    ibDataSet35NUMEROOS.AsString := Form7.ibDataset3NUMERO.AsString;
  end else
  begin
    ibDataSet35NUMERONF.AsString := Form7.ibDataset15NUMERONF.AsString;
  end;
  //
end;

procedure TForm7.ibDataSet19NewRecord(DataSet: TDataSet);
begin
  ibDataSet19REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet25NewRecord(DataSet: TDataSet);
begin
  ibDataSet25REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet13NewRecord(DataSet: TDataSet);
begin
  ibDataSet13REGISTRO.AsString := sProximo;
end;

procedure TForm7.ibDataSet10NewRecord(DataSet: TDataSet);
begin
  ibDataSet10REGISTRO.AsString := sProximo;
end;

procedure TForm7.Panel7MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Hint := TabelaAberta.SelectSQL.Text;
end;

procedure TForm7.ibDataSet23UNITARIOChange(Sender: TField);
begin
  //                           //
  // Verifica se ta cadastrado //
  //                           //
  if Form7.ibDataSet23DESCRICAO.AsString <> Form7.ibDataSet4DESCRICAO.AsString then
  begin
    Form7.ibDataSet4.Close;
    Form7.ibDataSet4.Selectsql.Clear;
    Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where DESCRICAO='+QuotedStr(Form7.ibDataSet23DESCRICAO.AsString)+' ');
    Form7.ibDataSet4.Open;
  end;
  //
  if Form7.ibDataSet23DESCRICAO.AsString = Form7.ibDataSet4DESCRICAO.AsString then
  begin
    //
    // Quando altera a quantidade recalcula o valor
    // total, mas s quando o valor total  alterado
    //
    if Form7.ibDataSet23QUANTIDADE.AsFloat <> 0 then
    begin
      if Arredonda(Form7.ibDataSet23TOTAL.AsFloat,StrToInt(Form1.ConfPreco)) <> Arredonda(Form7.ibDataSet23QUANTIDADE.Asfloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco)) then
      begin
         Form7.ibDataSet23.Edit;
//       Form7.ibDataSet23TOTAL.AsFloat := Arredonda(Form7.ibDataSet23QUANTIDADE.Asfloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));
         Form7.ibDataSet23TOTAL.AsFloat := Arredonda(Form7.ibDataSet23QUANTIDADE.Asfloat * Form7.ibDataSet23UNITARIO.AsFloat,StrToInt(Form1.ConfPreco));

      end;
    end;
  end;
  //
  // the end
  //
end;

procedure TForm7.ibDataSet3DESCONTOChange(Sender: TField);
begin
  TotalizaOS(True,True);
end;

procedure TForm7.ibDataSet21NewRecord(DataSet: TDataSet);
begin
  ibDataSet21REGISTRO.AsString  := sProximo;
end;

procedure TForm7.ibDataSet5BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet5ENTRADA_.AsFloat + (ibDataSet5SAIDA_.AsFloat*-1);
end;

procedure TForm7.Etiquetaparamaladireta1Click(Sender: TObject);
begin
  try
    Form15 := TForm15.Create(nil);
    Form15.CheckBox2.Checked := True;
    Form15.ShowModal;
  finally
    FreeAndNil(Form15);
  end;
end;

procedure TForm7.ibDataset40AfterPost(DataSet: TDataSet);
begin
  if ibDataset40.FieldByName('DESCRICAO').AsString = '' then ibDataset40.Delete;
  AgendaCommit(True);
end;

procedure TForm7.MenuItem56Click(Sender: TObject);
var
  Mais1ini: tIniFile;
  I: Integer;
  NovItem1, NovItem2: TmenuItem;
  GeraEnvioItem1: TmenuItem;
  bI: Boolean;
begin
  Gerarboletoeenviodeemaildecobranatotalizadoporcliente1.Visible := Form1.DisponivelSomenteParaNos; // Sandro Silva 2022-12-26
  GerCNAB400.Visible := True;
  GerCNAB240.Visible := True;

  ibDataSet11.First;

  while not ibDataSet11.eof do
  begin
    // Boletos
    bI := True;
    for I := 0 to Bloquetos1.Count -1 do
    begin
      if Bloquetos1.Items[I].Caption = ibDataSet11NOME.Value then
        bI := False;
    end;

    if bI then
    begin
      NovItem1 := TMenuItem.Create(Bloquetos1);
      NovItem1.Caption := ibDataSet11NOME.Value;
      Bloquetos1.Add(NovItem1);
      NovItem1.OnClick := Form1.EscolheOBloqueto;

      {Sandro Silva 2022-12-26 inicio}
      GeraEnvioItem1 := TMenuItem.Create(Bloquetos1);
      GeraEnvioItem1.Caption := ibDataSet11NOME.Value;
      Gerarboletoeenviodeemaildecobranatotalizadoporcliente1.Add(GeraEnvioItem1);
      GeraEnvioItem1.OnClick := EscolheOBancoParaGerarBoletoEEnviarEmail;
      {Sandro Silva 2022-12-26 fim}
    end;

    // CNAB 400
    bI := True;
    for I := 0 to GerCNAB400.Count -1 do
    begin
      if GerCNAB400.Items[I].Caption = ibDataSet11NOME.Value then
        bI := False;
    end;

    if bI then
    begin
      NovItem2 := TMenuItem.Create(GerCNAB400);
      NovItem2.Caption := ibDataSet11NOME.Value;
      GerCNAB400.Add(NovItem2);
      NovItem2.OnClick := Form1.EscolheCNAB400;
    end;

    // CNAB 240
    bI := True;
    for I := 0 to GerCNAB240.Count -1 do
    begin
      if GerCNAB240.Items[I].Caption = ibDataSet11NOME.Value then
        bI := False;
    end;

    if bI then
    begin
      NovItem2 := TMenuItem.Create(GerCNAB240);
      NovItem2.Caption := ibDataSet11NOME.Value;
      GerCNAB240.Add(NovItem2);
      NovItem2.OnClick := Form1.EscolheCNAB240;
    end;
    ibDataSet11.Next;
  end;

  Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
  for I := 0 to GerCNAB240.Count -1 do
  begin
    if Mais1Ini.ReadString(pChar('Boleto de cobrana do '+GerCNAB240.Items[I].Caption),'CNAB240','') = 'Sim' then
      GerCNAB240.Items[I].Enabled := True
    else
      GerCNAB240.Items[I].Enabled := False;
  end;

  for I := 0 to GerCNAB400.Count -1 do
  begin
    if Mais1Ini.ReadString(pChar('Boleto de cobrana do '+GerCNAB400.Items[I].Caption),'CNAB400','') = 'Sim' then
      GerCNAB400.Items[I].Enabled := True
    else
      GerCNAB400.Items[I].Enabled := False;
  end;
  Mais1ini.Free;

  if Form7.ibDataSet7VALOR_RECE.AsFloat <> 0 then
    Imprimirrecibo2.Enabled := True
  else
    Imprimirrecibo2.Enabled := False;
end;

procedure TForm7.ibDataSet1CalcFields(DataSet: TDataSet);
begin
  try
    if AllTrim(ibDataSet1.FieldByName('REGISTRO').AsString) <> '' then
      Form7.ibDataSet1.FieldByName('SALDO').AsFloat := fSaldoVetorCaixa[ibDataSet1.FieldByName('REGISTRO').AsInteger];
  except end;
end;

procedure TForm7.ibDataSet5CalcFields(DataSet: TDataSet);
begin
  if AllTrim(ibDataSet5.FieldByName('REGISTRO').AsString) <> '' then
    Form7.ibDataSet5.FieldByName('SALDO_BANC').AsFloat := fSaldoVetorBanco[ibDataSet5.FieldByName('REGISTRO').AsInteger];
end;

procedure TForm7.Rankingdedevedores2Click(Sender: TObject);
begin
  Form38.ComboBox1.Visible  := True;
  sModuloAnterior := sModulo;
  Form7.sWhere := '';
  Form38.Panel6.Visible := True;
  Form7.sModulo                   := 'Ranking de devedores';
  Form38.ShowModal; // Ok
end;

procedure TForm7.ibDataSet11BeforeInsert(DataSet: TDataSet);
begin
  //
  try if AllTrim(Form7.ibDataSet11NOME.AsString)='' then Form7.ibDataSet11.Delete; except end;
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_BANCOS,1) from rdb$database');
  ibDataset99.Open;
  sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
  ibDataset99.Close;
  //
end;

procedure TForm7.ibDataSet11NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet11REGISTRO.AsString := sProximo;
  //
end;

procedure TForm7.ibDataSet1DATAChange(Sender: TField);
begin
  if sModulo = 'CAIXA' then CalculaSaldo(True);
end;

procedure TForm7.ibDataSet5COMPENSChange(Sender: TField);
begin
  if Form7.sModulo = 'BANCOS' then SaldoBanco(True);
end;

procedure TForm7.IBDataSet2EditError(DataSet: TDataSet; E: EDatabaseError;
  var Action: TDataAction);
begin
  Abort;
end;

procedure TForm7.IBDataSet2UpdateError(DataSet: TDataSet;
  E: EDatabaseError; UpdateKind: TUpdateKind;
  var UpdateAction: TIBUpdateAction);
begin
  try
    if (ibDataSet13CGC.AsString = CNPJ_SMALLSOFT) then
    begin
      // Comercial da Small est perdendo dados de contatos
      if AnsiContainsText(E.Message, 'deadlock') then
        Audita('CONTATOS','SMALL', Senhas.UsuarioPub, Form7.smodulo + ' Conflito L23774 ' + RightStr(E.Message, 50),0,0) // Ato, Modulo, Usurio, Histrico, Valor
      else
        Audita('CONTATOS','SMALL', Senhas.UsuarioPub, Form7.smodulo + ' ' + Copy('Salvar contatos L23776 ' + E.Message, 1, 80),0,0); // Ato, Modulo, Usurio, Histrico, Valor

    end;
  except
  end;

  Abort;
end;

procedure TForm7.IBDataSet2DeleteError(DataSet: TDataSet;
  E: EDatabaseError; var Action: TDataAction);
begin
  Abort;
end;

procedure TForm7.IBDataSet2PostError(DataSet: TDataSet; E: EDatabaseError;
  var Action: TDataAction);
begin
  DataSet.Cancel;
  Abort;
end;

procedure TForm7.MenuItem75Click(Sender: TObject);
begin
  Form20.ShowModal;
end;

procedure TForm7.este1Click(Sender: TObject);
var
  //
  sRegistro, sX, sMsg : String;
  bButton, I, J : Integer;
  Mais1ini : tIniFile;
  //
  F : TExtfile;
  //
begin
  //
  Form40.CheckBox1.Visible := False;
  Form40.MaskEdit1.Visible := False;
  Form40.Edit1.Visible     := False;
  Form40.Label1.Visible    := False;
  Form40.Label3.Visible    := False;
  Form40.Label4.Visible    := False;
  Form40.Caption           := 'Enviar WhatsApp';
  //
  Form40.OpenDialog1.FileName := '';
  //
  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<HISTORICO>');
  Form40.Memo2.Lines.Add('<PORTADOR>');
  Form40.Memo2.Lines.Add('<DOCUMENTO>');
  Form40.Memo2.Lines.Add('<EMISSAO>');
  Form40.Memo2.Lines.Add('<VENCIMENTO>');
  Form40.Memo2.Lines.Add('<VALOR_DUPL>');
  Form40.Memo2.Lines.Add('<VALOR_JURO>');
  Form40.Memo2.Lines.Add('<CODEBAR>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>');
  //
  Form40.ShowModal;
  //
  Form40.MaskEdit1.Visible := True;
  Form40.Edit1.Visible     := True;
  Form40.Label1.Visible    := True;
  Form40.Label4.Visible    := True;
  Form40.Label3.Visible    := True;
  Form40.Caption           := 'Enviar e-mail texto';
  //
  if Form1.Tag = 1 then
  begin
    //
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este WhatsApp para os clientes e' + chr(10) +
              Chr(10) + 'fornecedores filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    I := 0;
    J := 0;
    //
    if bButton = IDYES then
    begin
      //
      sX := '';
      //
      Form7.ibDataSet2.First;
      //
      // Retorna onde parou
      //
      Mais1ini := TIniFile.Create('frente.ini');
      sRegistro := Mais1Ini.ReadString('whatsapp','registro','FIM') ;
      //
      AssignFile(F,pchar(Form1.sAtual+'\WHATSAPP.TXT'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);                  // Abre para gravao
      //
      if sRegistro <> 'FIM' then
      begin
        //
        bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
        if bButton = IDYES then
        begin
          //
          while (not Form7.ibDataSet2.Eof) and (sRegistro <> Form7.ibDataSet2.FieldByName('REGISTRO').AsString) do
          begin
            //
            if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
          if sRegistro = Form7.ibDataSet2.FieldByName('REGISTRO').AsString then
          begin
            //
            if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
            begin
              I := I + 1;
            end;
            //
            Form7.ibDataSet2.Next;
            //
          end;
          //
        end;
        //
      end;
      //
      Mais1ini.Free;
      //
      Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
      Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
      Form7.Panel1.Visible := True;
      //
      //
      while (not Form7.ibDataSet2.Eof) and (J < 20) do
      begin
        //
        if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
        begin
          //
          Application.ProcessMessages;
          //
          sMsg := Form40.Memo1.Lines.Text;
          //
          // CLIENTES
          //
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
          sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
          sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
          sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
          sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
          sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
          sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
          sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
          sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
          sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
          sMsg := StrTran(sMsg,'<WHATSAPP>'           ,Form7.ibDataSet2.FieldByName('WHATSAPP'      ).AsString);
          sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
          sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
          sMsg := StrTran(sMsg,'<CONTATOS>'      ,Form7.ibDataSet2.FieldByName('CONTATOS' ).AsString);
          sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
          sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
          //
          sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
          sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
          //
          sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
          sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
          sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
          sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
          //
          sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
          sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
          sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
          sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
          sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
          sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
          sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
          //
          sMsg := StrTran(sMsg,' ','%20');
          sMsg := StrTran(sMsg,chr(10),'%0A');
          sMsg := StrTran(sMsg,chr(13),'');
          //
          ShellExecute( 0, 'Open', pChar('https://api.whatsapp.com/send?phone=55'+LimpaNumero(StrTran(ibDataSet2WHATSAPP.AsString,'0xx',''))+'&text='+sMSG),'','', SW_SHOW);
          //
          J := J + 1;
          I := I + 1;
          //
          Mais1ini := TIniFile.Create('frente.ini');
          Mais1Ini.WriteString('whatsapp','Registro',pchar(Form7.ibDataSet2.FieldByName('REGISTRO').AsString));
          Mais1Ini.Free;
          //
          Form7.Panel1.Caption := AllTrim(IntToStr(I))+' WhatsApps enviados.';
          Form7.Panel1.Repaint;
          //
        end;
        //
        Form7.ibDataSet2.Next;
        //
      end;
      //
      try
        CloseFile(F); // Fecha o arquivo
      except end;
      //
    end;
    //
    Form7.Panel1.Visible := False;
    Form7.Repaint;
    
    if J >= 20 then
    begin
      //ShowMessage('Mximo de 20 mensagens pelo WhatsApp. Se continuar do registro que parou poder mandar mais 20.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Mximo de 20 mensagens pelo WhatsApp. Se continuar do registro que parou poder mandar mais 20.',msgAtencao);
    end else
    begin
      try
        Mais1ini := TIniFile.Create('frente.ini');
        Mais1Ini.WriteString('whatsapp','Registro','FIM');
        Mais1Ini.Free;
      except end;
    end;
  end;
end;

procedure TForm7.ibDataSet11BeforePost(DataSet: TDataSet);
begin
  if (AllTrim(ibDataSet11NOME.AsString) <> '') and (AllTrim(ibDataSet11PLANO.AsString) = '') then
  begin
    ibDataSet12.Close;
    ibDataSet12.SelectSql.Clear;
    ibDataSet12.SelectSQL.Add('select * from CONTAS where SUBSTRING(CONTA FROM 1 FOR 1)='+QuotedStr('5')+'order by CONTA');
    ibDataSet12.Open;
    ibDataSet12.Last;

    if LimpaNumero(Right(ibDataSet12CONTA.AsString,2)) <> '' then
    begin
      ibDataSet11.Edit;
      ibDataSet11PLANO.AsString := '510'+StrZero(StrToInt(LimpaNumero(Right(ibDataSet12CONTA.AsString,2)))+1,2,0);
    end;
    
    ibDataSet12.Append;
    ibDataSet12CONTA.AsString := ibDataSet11PLANO.AsString;
    ibDataSet12NOME.AsString := ibDataSet11NOME.AsString;
    ibDataSet12.Post;
  end;
end;

procedure TForm7.Gerarnotafiscalsrie11Click(Sender: TObject);
var
  numOS : string;
begin
  numOS := ibDataSet3NUMERO.AsString;

  // Gera a nota fiscal
  if Form1.bNotaVendaLiberada then
  begin
    if Form7.ibDataSet3NF.AsString = '' then
    begin
      if Application.MessageBox(Pchar('Confirma a importao da OS '+numOS+' para a Nota Fiscal?'
                                                  + chr(10)
                                                  + Chr(10))
                                                  ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING) = IDYES then
      begin
        Form7.Close;
        Form7.Vendas_1Click(Sender);                        // Nota fiscal srie 1
        Form7.Image101Click(Sender);                        // Nova Nota
        Form7.sModulo := 'OS';
        ImportaOS(numOS);
        Form7.sModulo := 'VENDA';
      end;
    end else
    begin
      MensagemSistema('Esta OS j possui documento fiscal vinculado.',msgAtencao);
    end;
  end else
  begin
    //ShowMessage('Emisso de NF no liberada para este usurio.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Emisso de NF no liberada para este usurio.',msgAtencao);
  end;
end;

procedure TForm7.Gerarnotafiscalsrie21Click(Sender: TObject);
var
  numOS : string;
begin
  numOS := ibDataSet3NUMERO.AsString;

  // Gera a nota fiscal
  if Form1.bNotaVendaLiberada then
  begin
    if Form7.ibDataSet3NF.AsString = '' then
    begin
      if Application.MessageBox(Pchar('Confirma a importao da OS '+numOS+' para a Nota Fiscal?'
                                                  + chr(10)
                                                  + Chr(10))
                                                  ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING) = IDYES then
      begin
        Form7.Close;
        Form7.NotasfiscaisdesadavendasSrie11Click(Sender);  // Nota fiscal srie 002
        Form7.Image101Click(Sender);                        // Nova Nota
        Form7.sModulo := 'OS';
        ImportaOS(numOS);
        Form7.sModulo := 'VENDA';
      end;
    end else
    begin
      MensagemSistema('Esta OS j possui documento fiscal vinculado.',msgAtencao);
    end;
  end else
  begin
    //ShowMessage('Emisso de NF no liberada para este usurio.');  Mauricio Parizotto 2023-10-25
    MensagemSistema('Emisso de NF no liberada para este usurio.',msgAtencao);
  end;
end;

procedure TForm7.miRelCorrelacaoClick(Sender: TObject);
var
  F : TextFile;
begin
  DeleteFile(pChar(Form1.sAtual+'\CORRELACAO.TXT'));   // Apaga o arquivo anterior
  AssignFile(F,pchar(Form1.sAtual+'\CORRELACAO.TXT'));
  //
  Rewrite(F);           // Abre para gravao
  Writeln(F,'         RELATRIO DE CORRELAO         ');
  Writeln(F,'');
  Writeln(F,'NSU        NF/SERIE DATA       HORA     VALOR TOTAL ');
  Writeln(F,'---------- -------- ---------- -------- -------------');
  //
  ibDataSet15.DisableControls;
  ibDataSet15.Close;
  ibDataSet15.SelectSQL.Clear;
  ibDataSet15.SelectSQL.Add('select * from VENDAS where EMITIDA=''S'' order by NSU');
  ibDataSet15.Open;
  //
  ibDataSet15.First;
  while not ibDataSet15.Eof do
  begin
    try
      Writeln(F,ibDataSet15NSU.AsString+' '+copy(ibDataSet15NUMERONF.AsString,1,9)+'/'+copy(ibDataSet15NUMERONF.AsString,10,3)+' '+DateToStr(ibDataSet15NSUD.AsDateTime)+' '+TimeToStr(ibDataSet15NSUH.AsDateTime)+' '+' '+Format('%12.2n',[ibDataSet15TOTAL.AsFloat]));
    except end;
    ibDataSet15.Next;
  end;
  //
  Writeln(F,'');
  Writeln(F,'');
  Writeln(F,'                   PRODUTOS COM ESTOQUE NEGATIVO                    ');
  Writeln(F,'');
  Writeln(F,'CODIGO        DESCRICO                                QUANTIDADE');
  Writeln(F,'------------- ---------------------------------------- -------------');
  
  ibDataSet4.First;
  while not ibDataSet4.Eof do
  begin
    try
      if ibDataSet4QTD_ATUAL.AsFloat < 0 then
        Writeln(F,ibDataSet4CODIGO.AsString+'         '+Copy(ibDataSet4DESCRICAO.AsString+Replicate(' ',40),1,40)+' '+Format('%14.2n',[ibDataSet4QTD_ATUAL.AsFloat]));
    except
    end;
    ibDataSet4.Next;
  end;

  Writeln(F,'');
  Writeln(F,'');
  Writeln(F,'MOTIVO REINICIO: No houve reinicio de NSU.');

  CloseFile(F);  // Fecha o arquivo

  Form7.Close;
  Form7.Show;

  if FileExists(Form1.sAtual+'\CORRELACAO.TXT') then
    ShellExecute( 0, 'Open','notepad.exe',PChar('CORRELACAO.TXT'), '', SW_SHOW);
end;

procedure TForm7.Sosclientescomcontasatrasadas1Click(Sender: TObject);
begin
  //sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)<>0'; // se mudar aqui mudar o traduz sql (Inadimplante)
  //2022-07-19 Estava considerando as contas inativas como em atraso. Alfredo precisa enviar cobranas apenas para quem realmente tem conta em atraso
  sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE and COALESCE(RECEBER.ATIVO, 0) <> 1)<>0 '; // se mudar aqui mudar o traduz sql (Inadimplante)
  //
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Sosclientescomsuascontasemdia1Click(Sender: TObject);
begin
  sWhere := ' where (select Coalesce(sum(VALOR_DUPL),0) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and RECEBER.VENCIMENTO < CURRENT_DATE)=0'; // se mudar aqui mudar o traduz sql (Inadimplante)
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Sosclientescomcontasareceber1Click(Sender: TObject);
begin
  //sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0)<>0'; // se mudar aqui mudar o traduz sql (Contas a receber) Mauricio Parizotto 2023-02-28
  sWhere := ' where (select sum(VALOR_DUPL) from RECEBER where CLIFOR.NOME=RECEBER.NOME and Coalesce(RECEBER.VALOR_RECE,0)=0 and COALESCE(RECEBER.ATIVO, 0) <> 1 )<>0'; // se mudar aqui mudar o traduz sql (Contas a receber)
  Form7.Close;
  Form7.Show;
end;

procedure TForm7.ibDataSet4INDEXADORChange(Sender: TField);
begin
  if ibDataSet4INDEXADOR.Asfloat < 0 then ibDataSet4INDEXADOR.Asfloat := 0;
end;

procedure TForm7.ibDataSet4CUSTOMEDIOChange(Sender: TField);
begin
  if ibDataSet4CUSTOMEDIO.AsFloat < 0 then
    ibDataSet4CUSTOMEDIO.AsFloat := 0;

  try
    // Tratando situao que o custo mdio fica com valor "INF"
    if AnsiContainsText(ibDataSet4CUSTOMEDIO.AsString, 'INF') then
      ibDataSet4CUSTOMEDIO.AsFloat := 0;
  except

  end;
end;

procedure TForm7.ibDataSet24DESCONTOChange(Sender: TField);
begin
  Form7.ibDataSet24MERCADORIAChange(Sender);
end;

procedure TForm7.IBDataSet119BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CONFOS,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.IBDataSet119NewRecord(DataSet: TDataSet);
begin
  ibDataSet119REGISTRO.AsString := sProximo;
end;

procedure TForm7.FloatField3SetText(Sender: TField; const Text: String);
var
  I : Integer;
begin
  I := Application.MessageBox('Este campo normalmente no deve ser alterado. Tem certeza que quer alterar este campo?', 'Ateno', mb_OKCancel + mb_DefButton1);
  if I = IDOK then
  begin
    ibDataSet19ELEMENTO.AsString := TExt;
  end else
  begin
    ibDataSet19ELEMENTO.AsString := ibDataSet19ELEMENTO.AsString;
  end;
end;

procedure TForm7.ArquivotextoNotaFiscalPaulista1Click(Sender: TObject);
begin
  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'SP' then if FileExists(Form1.sAtual+'\sintegra.exe') then
    ShellExecute( 0, 'Open', 'sintegra.exe', 'PAULISTA', '', SW_SHOW)
  else
    //ShowMessage('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.',msgAtencao);

  if UpperCase(Form7.ibDataSet13ESTADO.AsString) = 'AL' then if FileExists(Form1.sAtual+'\sintegra.exe') then
    ShellExecute( 0, 'Open', 'sintegra.exe', 'ALAGOANA', '', SW_SHOW)
  else
    //ShowMessage('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('O executvel sintegra.exe no foi encontrado na pasta de instalao do programa.',msgAtencao);
end;

procedure TForm7.ibDataSet4BeforeInsert(DataSet: TDataSet);
begin
  try
//    if Alltrim(Form7.ibDataSet4DESCRICAO.AsString)='' then Form7.ibDataSet4.Delete;
  except end;

  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ESTOQUE,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;

    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_HASH_ESTOQUE,1) from rdb$database');
    ibDataset99.Open;
  except end;
end;

procedure TForm7.ImprimirtodasasOSfiltradas1Click(Sender: TObject);
var
  I : Integer;
begin
  I := Application.MessageBox(pChar(
                            chr(10) +'Quer realmente imprimir todas as OS filtradas?'
                            +chr(10)+
                            'Imprimir agora?'),
                            'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
  if I = 6 then
  begin
    Form7.ibDataSet3.First;
    while not Form7.ibDataSet3.Eof do
    begin
      Form7.ImprimirOrdemdeServio1Click(Sender);
      Form7.ibDataSet3.Next;
    end;
  end;
end;

procedure TForm7.ibDataSet3SITUACAOSetText(Sender: TField;
  const Text: String);
begin
//  if UpperCase(AllTrim(ibDataSet3SITUACAO.AsString)) = 'FECHADA' then ibDataSet3SITUACAO.AsString := 'Fechada' else ibDataSet3SITUACAO.AsString := Text;
  {Sandro Silva 2023-10-16 inicio}
  if UpperCase(AllTrim(ibDataSet3SITUACAO.AsString)) = 'FECHADA' then
    Sender.AsString := 'Fechada'
  else
    Sender.AsString := Text;
  {Sandro Silva 2023-10-16 fim}
end;

procedure TForm7.ibDataSet11AfterPost(DataSet: TDataSet);
var
  sNomeNovo, sNomevolta : String;
begin
  // NOME DO BANCO
  if (sNomeAnterior <> ibDataSet11NOME.AsString) and (sNomeAnterior <> '')  and (sNumeroAnterior = ibDataSet11REGISTRO.AsString) then
  begin
    sNomeNovo  := ibDataSet11NOME.AsString;
    sNomeVolta := sNomeAnterior;

    // MOVIMENTO
    Form7.ibDataSet5.Close;
    Form7.ibDataSet5.SelectSQL.Clear;
    Form7.ibDataSet5.SelectSQL.Add('update MOVIMENT set NOME='+QuotedStr(sNomeNovo)+' where upper(NOME)='+QuotedStr(UpperCase(sNomeVolta))+'');
    Form7.ibDataSet5.Open;
  end;

  AgendaCommit(True);
end;
  
procedure TForm7.ibDataSet11BeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibDataSet11);
end;

procedure TForm7.ibDataSet11BeforeEdit(DataSet: TDataSet);
begin
  {  necessrio saber o Nome anterior no caso de    }
  { alterar o nome. Se o nome for alterado deve ser  }
  { atualizado o arquivo VENDAS e o arquivo ALTERACA }
  sNumeroAnterior := ibDataSet11REGISTRO.AsString;
  sNomeAnterior   := ibDataSet11NOME.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.Notasfiscaiscanceladas1Click(Sender: TObject);
begin
  sWhere := sWhere + ' and EMITIDA='+QuotedStr('X');
  Form7.Close;
  Form7.Show;

  // Sandro Silva 2024-01-11 Notasfiscaiscanceladas1.Checked := True;
  // Sandro Silva 2024-01-11 Notasfiscaisabertas1.Checked    := False;
end;

procedure TForm7.Notasfiscaisabertas1Click(Sender: TObject);
begin
  sWhere := sWhere + ' and EMITIDA<>'+QuotedStr('S')+' and EMITIDA<>'+QuotedStr('X');
  Form7.Close;
  Form7.Show;

  // Sandro Silva 2024-01-11 Notasfiscaiscanceladas1.Checked := False;
  // Sandro Silva 2024-01-11 Notasfiscaisabertas1.Checked    := True;
end;

procedure TForm7.odas4Click(Sender: TObject);
begin
  sWhere := '';
  Form7.Close;
  Form7.Show;

  // Sandro Silva 2024-01-11 Notasfiscaiscanceladas1.Checked := True;
  // Sandro Silva 2024-01-11 Notasfiscaisabertas1.Checked    := False;
end;

procedure TForm7.Exportar1Click(Sender: TObject);
begin
  {Dailon Parisotto (f-204) 2024-03-06 Inicio

  ExportaNF(True);

  }

  ExportarXMLNF;

  {Dailon Parisotto (f-204) 2024-03-06 Fim}
end;

procedure TForm7.ImportarOS1Click(Sender: TObject);
begin
  AgendaCommit(True);
  Form7.Close;
  Form7.Show;

  Form7.Image101Click(Sender);
  Form12.ImportarOS2Click(Sender);
end;

procedure TForm7.ImportarCupomFiscal1Click(Sender: TObject);
begin
  AgendaCommit(True);
  Form7.Close;
  Form7.Show;

  Form7.Image101Click(Sender);
  Form12.Emitirnotafiscaldevendasnobalco1Click(Sender);
end;

procedure TForm7.ImportarOramento1Click(Sender: TObject);
begin
  AgendaCommit(True);

  Form7.Close;
  Form7.Show;

  Form7.ibDataSet97.Close;
  Form7.ibDataSet97.Selectsql.Clear;
  //Form7.ibDataSet97.Selectsql.Add('select PEDIDO as "Oramento", DATA as "Data", CLIFOR as "Cliente", VENDEDOR as "Vendedor", sum(TOTAL) as "Total", NUMERONF as "Doc. Fiscal", PEDIDO as "Registro" from ORCAMENT group by PEDIDO, DATA, CLIFOR, VENDEDOR, NUMERONF order by PEDIDO');  // Mauricio Parizotto 2023-10-16
  Form7.ibDataSet97.Selectsql.Add(SqlEstoqueOrcamentos);
  Form7.ibDataSet97.Open;
  Form7.ibDataSet97.EnableControls;

  Form7.Image101Click(Sender);
  Form12.Importaroramentos1Click(Sender);
end;

procedure TForm7.ImportarNotaFiscal1Click(Sender: TObject);
begin
  FbImportandoXML := True;
  try
    ImportaNF(True,'');
  finally
    FbImportandoXML := False;
  end;
end;

procedure TForm7.IBDataSet2CIDADESetText(Sender: TField; const Text: String);
var
  vEstado : string;
begin
  vEstado := Form7.IBDataSet2ESTADO.AsString;
  SelecionaMunicipio(vEstado,Text,(Sender as TIBStringField));
end;

procedure TForm7.Movimentaodositemskardex1Click(Sender: TObject);
begin
  Form7.sModulo := 'KARDEX';
  Form10.Image203Click(Sender);
  Form7.sModulo := 'ESTOQUE';
end;

procedure TForm7.ibDataSet30SERIALSetText(Sender: TField;
  const Text: String);
begin
  if Form10.Visible then
  begin
    if Valida_Campo('SERIE',Text,'SERIAL','Este nmero de srie j foi cadastrado.') then
    ibDataSet30SERIAL.AsString := Text;
  end;  
end;

procedure TForm7.miRelVendasVendedorClick(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de vendas por vendedor';
  //
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ibDataSet15AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
  //
  Form1.ibQuery2.Close;
  Form1.ibQuery2.SQL.Clear;
  Form1.ibQuery2.SQL.Add('set generator G_GRAFICO_VENDAS to 0');
  Form1.ibQuery2.ExecSQL;
  //
end;

procedure TForm7.ibDataSet24AfterPost(DataSet: TDataSet);
begin
  //
  if AllTrim(sFornecedorAntigo) <> '' then
  begin
    if sFornecedorAntigo <> Form7.IbDataSet24FORNECEDOR.AsString then
    begin
      //
      Screen.Cursor := crHourGlass; // Cursor de Aguardo
      //
      Form7.IBQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update ITENS002 set FORNECEDOR='+QuotedStr(Form7.IbDataSet24FORNECEDOR.AsString)+' where NUMERONF='+QuotedStr(Form7.IbDataSet24NUMERONF.AsString)+' and FORNECEDOR='+QuotedStr(sFornecedorAntigo)+'');
      Form7.IBQuery1.Open;
      //
      Form7.IBQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update PAGAR set NOME='+QuotedStr(Form7.IbDataSet24FORNECEDOR.AsString)+' where NUMERONF='+QuotedStr(Form7.IbDataSet24NUMERONF.AsString)+' and NOME='+QuotedStr(sFornecedorAntigo)+'');
      Form7.IBQuery1.Open;
      //
      Screen.Cursor := crDefault; // Cursor de Aguardo
      //
    end;
  end;
  //
  AgendaCommit(True);
  //
end;

procedure TForm7.ibDataSet3AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet1AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
  //
  Form1.ibQuery2.Close;
  Form1.ibQuery2.SQL.Clear;
  Form1.ibQuery2.SQL.Add('set generator G_GRAFICO_CAIXA to 0');
  Form1.ibQuery2.ExecSQL;
  //
end;

procedure TForm7.ibDataSet8AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet18AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet5AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet30AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet27AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet25AfterPost(DataSet: TDataSet);
begin
//  AgendaCommit(True);
end;

procedure TForm7.ibDataSet26AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet13AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet10AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet28AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet37AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet15AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet24AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet2AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet7AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet9AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet12AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet14AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet8AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet18AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet29AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet5AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
  if sModulo = 'BANCOS' then CalculaSAldo(True);
end;

procedure TForm7.IBDataSet99AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet23AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet19AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet30AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet27AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet25AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet26AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet13AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet21AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet10AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataset40AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet11AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibDataSet37AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet119AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.Relatriodetotaldeserviosporvendedor1Click(
  Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de servios por tcnico';
  Form38.ShowModal; // Ok
  //

end;

procedure TForm7.Resumodascompras1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Resumo das compras'; // 1
  Form38.ShowModal; // Ok
end;

procedure TForm7.Resumodascomrpas1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form38.Label21.Caption := Form7.ibDataSet2NOME.AsString;
  Form38.Label21.Visible := True;
  Form7.sModulo := 'Resumo das compras';
  Form38.ShowModal; // Ok
  Form38.Label21.Visible := False;
end;

procedure TForm7.miExibirAjudaICMClick(Sender: TObject);
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar(sAjuda)));
end;

procedure TForm7.ibDataSet1BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'CAIXA' then
  begin
    if (Date <> ibDataSet1DATA.AsDAteTime) and (ibDataSet1DATA.AsString<>'') then
    begin
      if (fValorAnterior <> ibDataSet1ENTRADA.AsFloat + (ibDataSet1SAIDA.AsFloat*-1)) and (fValorAnterior <> 0) then
      begin
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
        ibDataSet1DATA.AsString + ' - ' + Alltrim(ibDataSet1HISTORICO.AsString),
        (fValorAnterior)
        ,(ibDataSet1ENTRADA.AsFloat+(ibDataSet1SAIDA.AsFloat*-1)) );   // Ato, Modulo, Usurio, Histrico
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet5BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'BANCOS' then
  begin
    if (Date <> ibDataSet5EMISSAO.AsDAteTime) and (ibDataSet5EMISSAO.AsString<>'') then
    begin
      if (fValorAnterior <> ibDataSet5ENTRADA_.AsFloat + (ibDataSet5SAIDA_.AsFloat*-1)) and  (fValorAnterior <> 0) then
      begin
        Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
        ibDataSet5EMISSAO.AsString + ' - ' + Alltrim(ibDataSet5HISTORICO.AsString),
        (fValorAnterior)
        ,(ibDataSet5ENTRADA_.AsFloat+(ibDataSet5SAIDA_.AsFloat*-1)) );   // Ato, Modulo, Usurio, Histrico
      end;
    end;
  end;
  //
end;

procedure TForm7.ibDataSet7BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet7VALOR_DUPL.AsFloat;
end;

procedure TForm7.ibDataSet8BeforeEdit(DataSet: TDataSet);
begin
  fValorAnterior := ibDataSet8VALOR_DUPL.AsFloat;
end;

procedure TForm7.ibDataSet7BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'RECEBER' then
  begin
    if (fValorAnterior <> ibDataSet7VALOR_DUPL.AsFloat) and (fValorAnterior <> 0) then
    begin
      Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
      Alltrim(ibDataSet7VENCIMENTO.AsString + ' - ' + Alltrim(ibDataSet7DOCUMENTO.AsString + ' - ' + ibDataSet7HISTORICO.AsString)),
      fValorAnterior, (ibDataSet7VALOR_DUPL.AsFloat));   // Ato, Modulo, Usurio, Histrico
    end;
  end;
  //
end;

procedure TForm7.ibDataSet7BeforeDelete(DataSet: TDataSet);
var
  sS : String;
begin
  if sModulo = 'RECEBER' then
  begin
    sS := '';

    sS := Form1.Small_InputForm('Motivo', 'Informe o motivo de estar apagando esta conta:', '');

    if AllTrim(sS) = '' then
    begin
      //ShowMessage('A Conta no foi apagada. Informe um motivo.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('A Conta no foi apagada. Informe um motivo.',msgAtencao);
      Abort;
    end;

    RegistraExclusaoRegistro(ibDataSet7, EmptyStr, ' - ' + AllTrim(Copy(sS+replicate(' ',60),1,60)));
  end;
end;

procedure TForm7.ibDataSet8BeforeDelete(DataSet: TDataSet);
begin
  if sModulo = 'PAGAR' then
    RegistraExclusaoRegistro(ibDataSet8);
end;

procedure TForm7.ibDataSet8BeforePost(DataSet: TDataSet);
begin
  //
  if sModulo = 'PAGAR' then
  begin
    if (fValorAnterior <> ibDataSet8VALOR_DUPL.AsFloat) and (fValorAnterior <> 0) then
    begin
      Audita('ALTEROU', sModulo, Senhas.UsuarioPub,
      Alltrim(ibDataSet8VENCIMENTO.AsString +' - ' +Alltrim(ibDataSet8DOCUMENTO.AsString + ' - ' + ibDataSet8HISTORICO.AsString)),
      fValorAnterior, (ibDataSet8VALOR_DUPL.AsFloat));   // Ato, Modulo, Usurio, Histrico
    end;
  end;
  //
end;

function TForm7.TestaNFSaidaFaturada: Boolean;
begin
  Result := (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> EmptyStr) or (bContingencia);
end;

procedure TForm7.N4ImprimirDANFE1Click(Sender: TObject);
var
  Device : array[0..255] of char;
  Driver : array[0..255] of char;
  Port   : array[0..255] of char;
  hDMode : THandle;
  sFormato, sLote : String;
begin
  if TestaNFSaidaFaturada then
  begin
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption := 'Imprimindo o DANFE'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    spdNFe.ArquivoServidoresHom    := Form1.sAtual + '\nfe\nfeServidoresHom.ini';
    spdNFe.ArquivoServidoresProd   := Form1.sAtual + '\nfe\nfeServidoresProd.ini';
    //
    ConfiguraNFE;
    //
    // Recupera na tabela VENDAS o XML
    //
    fNFE :=  Form7.ibDataSet15NFEXML.AsString;
    //
    // Recupera na tabela VENDAS o XML
    //
    try
      //
      // if Form7.bProximas then spdNFe.ImprimirDanfe(sLote, fNFe,'',CorrentPrinter) else
      //
      if Form7.ibDataSet15EMITIDA.AsString = 'X' then
      begin
        sFormato := Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento;
      end else
      begin
        sFormato := Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm';
      end;
      //
      if bProximas then
      begin
        //
        Printer.GetPrinter(Device, Driver, Port, hDMode);
        //
        spdNFe.ImprimirDanfe(sLote, fNFe, sFormato,Device);
        //
      end else
      begin
        spdNFe.ImprimirDanfe(sLote, fNFe, sFormato);
      end;
      //
      if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
      begin
        Form7.ibDataSet15.Edit;
        Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
        Form7.ibDataSet15.Post;
      end;
      //
    except end;

    {$IFDEF VER150}
    DecimalSeparator := ',';
    DateSeparator    := '/';
    {$ELSE}
    FormatSettings.DecimalSeparator := ',';
    FormatSettings.DateSeparator    := '/';
    {$ENDIF}

    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    //
    Screen.Cursor            := crDefault;
    //
    if bContingencia then
    begin
      Form7.ibDataset15.Edit;
      Form7.ibDataSet15STATUS.AsString   := 'DANFE impresso em formulrio de segurana.';
      Form7.ibDataset15.Post;
    end;
    //
  end;
  //
end;


procedure TForm7.N1EnviarNFe1Click(Sender: TObject);
var
  sLote : String;
  sRetorno : String;
  sRecibo : String;
begin
  if ValidaLimiteDeEmissaoDeVenda(Form7.ibDataSet15EMISSAO.AsDateTime) = False then
  begin
    Exit;
  end;

  if AllTrim(Form7.ibDataSet15NFEID.AsString) <> '' then
  begin
    Form7.RRecuperaroXMLdestaNFe1Click(Sender);
  end;

  if FileExists(pChar(Form1.sAtual + '\XmlDestinatario\' + Form7.ibDataSet15NFEID.AsString + '-nfe.xml')) then
  begin
    if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then
      Form7.ibDataset15.Edit;
    Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
  end else
  begin
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      begin
        Form7.ibDataset15.Edit;
        Form7.ibDataSet15STATUS.AsString    := '';

        if alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '' then
        begin
          try
            begin
              sLote := Form7.ibDataSet15.FieldByName('NUMERONF').AsString;
              fNFe := GeraXmlNFe;

              // Incio gerao do xml
              try
                fNFe := spdNFe.AssinarNota(fNFe);
                Screen.Cursor            := crHourGlass;
              except
                Form7.ibDataset15.Edit;
                Form7.ibDataSet15STATUS.AsString    := 'Erro ao assinar NFE';
                Form7.ibDataset15.Post;
                Form7.ibDataset15.Edit;
              end;

              // Transmitindo
              Form7.ibDataset15.Edit;
              Form7.ibDataSet15NFEXML.AsString    := fNFe;
              Form7.ibDataset15.Post;

              if not bContingencia then
              begin
                try
                  Form7.Panel7.Caption          := 'Transmitindo arquivo XML...'+replicate(' ',100);
                  Form7.Panel7.Repaint;
                  sRetorno := spdNFe.EnviarNF(sLote, fNFe);
                  Screen.Cursor            := crHourGlass;
                  
                  if Pos('<nRec>',sRetorno) <> 0 then
                  begin
                    sRecibo := Copy(sRetorno+'   ',Pos('<nRec>',sRetorno)+6,Pos('</nRec>',sRetorno)-Pos('<nRec>',sRetorno)-6);
                  end else
                  begin
                    //ShowMessage(sRetorno); Mauricio Parizotto 2023-10-25
                    MensagemSistema(sRetorno);
                  end;
                except
                  on E: Exception do
                  begin
                    {
                    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+'ao enviar NFe'
                    ),'Ateno',mb_Ok + MB_ICONWARNING);
                    Mauricio Parizotto 2023-10-24}
                    MensagemSistema(E.Message+chr(10)+chr(10)+'ao enviar NFe',msgErro);
                  end;
                end;

                // Grava na tabela VENDAS os dados da NF-e
                Form7.Panel7.Caption          := 'Gravando nmero do recibo e arquivo XML...'+replicate(' ',100);
                Form7.Panel7.Repaint;

                Form7.ibDataset15.Edit;
                Form7.ibDataSet15NFEID.AsString     := Copy(spdNFeDataSets.Campo('Id_A03').AsString,4,44); // Copia o ID da NFe p/ o Edit
                Form7.ibDataSet15NFERECIBO.AsString := Copy(sRecibo+REplicate(' ',15),1,15);

                Form7.ibDataSet15NFEXML.AsString    := fNFe;
                Form7.ibDataSet15MODELO.AsString    := '55';

                if Alltrim(sRecibo) <> '' then
                begin
                  if Copy(Form7.ibDataSet15STATUS.AsString,1,4) <> 'Erro' then Form7.ibDataSet15STATUS.AsString := 'Consulte o recibo desta NF-e'
                end else
                begin
                  Form7.ibDataSet15STATUS.AsString := 'No foi possvel acessar o servidor da receita.';
                  Form7.N0TestarservidorNFe1Click(Sender);
                end;
              end else
              begin

              end;
              // End Transmitindo
            end;
          except end;

          {$IFDEF VER150}
          DecimalSeparator := ',';
          DateSeparator    := '/';
          {$ELSE}
          FormatSettings.DecimalSeparator := ',';
          FormatSettings.DateSeparator    := '/';
          {$ENDIF}

          Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
          Form7.Panel7.Repaint;
        end;

        Screen.Cursor            := crDefault;
      end;
    end;

    try
      Form7.ibDataSet14.DisableControls;
      Form7.ibDataSet14.Close;
      Form7.ibDataSet14.SelectSQL.Clear;
      Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or  SubString(CFOP from 1 for 1) = '''' or SubString(CFOP from 1 for 1) = ''7''  or Coalesce(CFOP,''XXX'') = ''XXX'' order by upper(NOME)');
      Form7.ibDataSet14.Open;
      Form7.ibDataSet14.EnableControls;
      Form7.ibDataSet15.EnableControls;
    except
    end;
  end;
end;


procedure TForm7.N2ConsultarrecibodaNFe1Click(Sender: TObject);
var
  sRetorno, sStatus : String;
  I : Integer;
begin
  if (Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0) and (Alltrim(Form7.ibDataSet15NFERECIBO.AsString)<>'') then
  begin
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption          := 'Consultando recibo da NF-e...'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    Form7.ibDataSet15.Edit;
    Form7.ibDataset15STATUS.AsString := 'Consultando recibo da NF-e';

    ConfiguraNFE;
    Form7.spdNFe.TimeOut                      := 60000*30;

    try
      for I := 1 to 10 do
      begin
        if Pos('<cStat>104</cStat>',sRetorno) = 0 then
        begin
          sRetorno := Form7.spdNFe.ConsultarRecibo(Form7.ibDataSet15NFERECIBO.AsString);
          if Pos('<cStat>104</cStat>',sRetorno) = 0 then sLeep(3000);
        end;
      end;
      //
      // Autorizao de uso
      //
      Form7.ibDataSet15.Edit;
      Form7.ibDAtaSet15RECIBOXML.AsString := sRetorno; // Retorno da NF-e
      //
      sStatus := '';
      while sRetorno <> '' do
      begin
        if copy(sRetorno,1,9)='<xMotivo>' then
        begin
          sStatus  := Copy(sRetorno,10,Pos('</xMotivo>',sRetorno)-10);
          sRetorno := Copy(sRetorno,9,Length(sRetorno)-10);
        end else
        begin
          sRetorno := Copy(sRetorno,2,Length(sRetorno)-1);
        end;
      end;

      Form7.ibDataSet15.Edit;
      Form7.ibDataSet15STATUS.AsString       := sStatus;
      Form7.ibDataSet15.Post;
      Form7.ibDataSet15.Edit;
      
      if (Pos('<cStat>100</cStat>',Form7.ibDataSet15RECIBOXML.AsString) = 0) and (Pos('<cStat>105</cStat>',Form7.ibDataSet15RECIBOXML.AsString) = 0) then
      begin
        ExibeOrientacaoParaCorrigirErroAPartirDaRejeicaodeMedicamentos(Form7.ibDataSet15NFEXML.AsString, Form7.ibDataSet15RECIBOXML.AsString);

        {
        Application.MessageBox(pChar(sStatus+chr(10)+
        ItemRejeicao(Form7.ibDataSet15RECIBOXML.AsString, Form7.ibDataSet15NFEXML.AsString)+chr(10)+
        chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
        ),'Ateno',mb_Ok + MB_ICONWARNING);
        Mauricio Parizotto 2023-10-24}

        MensagemSistema(sStatus+chr(10)+
                        ItemRejeicao(Form7.ibDataSet15RECIBOXML.AsString, Form7.ibDataSet15NFEXML.AsString)+chr(10)+
                        chr(10)+'Leia atentamente a mensagem acima e tente resolver o problema. Considere pedir ajuda ao seu contador para o preenchimento correto da NF-e.'
                        ,msgAtencao);

      end;
    except
    end;

    {$IFDEF VER150}
    DecimalSeparator := ',';
    DateSeparator    := '/';
    {$ELSE}
    FormatSettings.DecimalSeparator := ',';
    FormatSettings.DateSeparator    := '/';
    {$ENDIF}

    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    Screen.Cursor            := crDefault;
  end;
end;

procedure TForm7.N3ConsultarNFe1Click(Sender: TObject);
var
  sRetorno : String;
  sqlAntes : string;
begin
  try
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      begin
        if Alltrim(Form7.ibDataSet15NFERECIBO.AsString) <> '' then
        begin
          Screen.Cursor            := crHourGlass;

          Panel7.Caption     := 'Consultando NF-e...'+replicate(' ',100);
          Panel7.Repaint;

          ibDataSet15.Edit;
          ibDataset15STATUS.AsString := 'Consultando NF-e';

          ConfiguraNFE;
          Form7.spdNFe.TimeOut                      := 60000*30;
          
          try
            sRetorno := spdNFe.ConsultarNF(Alltrim(Form7.ibDataSet15NFEID.AsString));

            //Mauricio Parizotto 2023-11-28
            Panel7.Caption     := 'Verificando retorno...'+replicate(' ',100);
            Panel7.Repaint;
            
            Form7.ibDataSet15.Edit;
            Form7.ibDataset15STATUS.AsString       := Copy(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9), 1, Form7.ibDataset15STATUS.Size);
            Form7.ibDataSet15NFEPROTOCOLO.AsString := Copy(sRetorno+'   ',Pos('<nProt>',sRetorno)+7,Pos('</nProt>',sRetorno)-Pos('<nProt>',sRetorno)-7);
            Form7.ibDataSet15.Post;
            Form7.ibDataSet15.Edit;

            if Form7.ibDataSet15NFEPROTOCOLO.AsString <> '' then
            begin
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15NFEXML.AsString  := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);

              if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
              begin
                Form7.ibDataSet15EMITIDA.AsString := 'S'; // Emitida
              end;

              Form7.ibDataSet15.Post;

              //Mauricio Parizotto 2023-11-28
              Panel7.Caption     := 'Verificando Estoque...'+replicate(' ',100);
              Panel7.Repaint;

              BaixaEstoqueDaNFeAutorizada('');

              // Form7.ibDataSet128.active := True; Mauricio Parizotto 2023-11-28

              if AllTrim(Copy(UpperCase(ParamStr(1)),1,3)) <> 'URB' then
              begin
                PegaImpostosDoXML(Form7.ibDataSet15.FieldByName('NUMERONF').AsString);
              end;
              
              try
                // Relaciona a natureza da operao com o arquivo de vendas
                if AllTrim(Form7.ibDataSet15OPERACAO.AsString) = '' then
                  Form7.ibDataSet14.Append
                else
                  Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);
                
                if Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,5) = 'CAIXA' then
                begin
                  //Mauricio Parizotto 2023-11-28
                  ibDataSet128.Close;
                  sqlAntes := ibDataSet128.SelectSQL.Text;
                  ibDataSet128.SelectSQL.Text := ' Select * From PAGAMENT Where 1=2 '; // Para evitar lentido
                  ibDataSet128.active := True;

                  ibDataSet128.Append;

                  ibDataSet128.FieldByName('DATA').AsDateTime    := Form7.ibDataSet15EMISSAO.AsDateTIme;
                  ibDataSet128.FieldByName('PEDIDO').AsString    := Copy(Form7.ibDataSet15NUMERONF.AsString,4,6);
                  ibDataSet128.FieldByName('CLIFOR').AsString    := Form7.ibDataSet15CLIENTE.AsString;
                  ibDataSet128.FieldByName('VENDEDOR').AsString  := Form7.ibDataSet15VENDEDOR.AsString;

                  if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '1') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '2') then
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '02 Dinheiro NF-e entrada';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet24TOTAL.AsFloat;
                  end else
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '02 Dinheiro NF-e';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet15TOTAL.AsFloat;
                  end;

                  ibDataSet128.Post;

                  //Mauricio Parizotto 2023-11-28
                  ibDataSet128.Close;
                  ibDataSet128.SelectSQL.Text := sqlAntes;
                end;

                if ((Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,7) = 'RECEBER') and (Form7.ibDataSet15TOTAL.AsFloat > 0)) or
                   ((Copy(AnsiUpperCase(Form7.ibDataSet14INTEGRACAO.asString),1,5) = 'PAGAR') and (Form7.ibDataSet24TOTAL.AsFloat > 0)) then
                begin
                  //Mauricio Parizotto 2023-11-28
                  ibDataSet128.Close;
                  sqlAntes := ibDataSet128.SelectSQL.Text;
                  ibDataSet128.SelectSQL.Text := ' Select * From PAGAMENT Where 1=2 '; // Para evitar lentido
                  ibDataSet128.active := True;

                  ibDataSet128.Append;

                  ibDataSet128.FieldByName('DATA').AsDateTime    := Form7.ibDataSet15EMISSAO.AsDateTIme;
                  ibDataSet128.FieldByName('PEDIDO').AsString    := Copy(Form7.ibDataSet15NUMERONF.AsString,4,6);
                  ibDataSet128.FieldByName('CLIFOR').AsString    := Form7.ibDataSet15CLIENTE.AsString;
                  ibDataSet128.FieldByName('VENDEDOR').AsString  := Form7.ibDataSet15VENDEDOR.AsString;

                  if (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '1') or (Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '2') then
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '04 A prazo NF-e entrada';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet24TOTAL.AsFloat;
                  end else
                  begin
                    ibDataSet128.FieldByName('FORMA').AsString     := '04 A prazo NF-e';
                    ibDataSet128.FieldByName('VALOR').Asfloat      := Form7.ibDataSet15TOTAL.AsFloat;
                  end;

                  ibDataSet128.Post;

                  //Mauricio Parizotto 2023-11-28
                  ibDataSet128.Close;
                  ibDataSet128.SelectSQL.Text := sqlAntes;
                end;
              except
              end;

              Form7.ibDataSet128.active := False;
            end;
          except
          end;

          Screen.Cursor            := crDefault;
        end;
      end;
    end;

    //Mauricio Parizotto 2023-11-28
    Panel7.Caption     := 'Consultando status...'+replicate(' ',100);
    Panel7.Repaint;
    DenegadoOuCancelado(True);
  except
  end;

  //Mauricio Parizotto 2023-11-28
  Panel7.Caption     := 'Finalizando...'+replicate(' ',100);
  Panel7.Repaint;

  RecuperaXML(True);

  AgendaCommit(True);

  //Mauricio Parizotto 2023-11-28
  Panel7.Caption     := '';
  Panel7.Repaint;

  Form7.Close;
  Form7.Show;

  Screen.Cursor            := crDefault;
end;

procedure TForm7.CancelarNFe1Click(Sender: TObject);
var
  sJustificativa : string;
  sRetorno, sStatus : String;
  sEmail : String;
begin
  try
    if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
    begin
      Screen.Cursor            := crHourGlass;
      Form7.Panel7.Caption          := 'Cancelando NF-e...'+replicate(' ',100);
      Form7.Panel7.Repaint;

      ConfiguraNFE;

      try
        sJustificativa := ConverteAcentos2(Form1.Small_InputForm('Ateno',
                          chr(10)+
                          'Voc est prestes a cancelar uma NF-e. O DANFE'+chr(10)+
                          'referente a esta NF-e se tornar invlido e no'+chr(10)+
                          'poder ser utilizado para acompanhar a mercadoria.'+chr(10)+
                          chr(10)+
                          'Para cancelar a NF-e: '+Form7.ibDataSet15NUMERONF.AsString+' insira uma justificativa (min. 15 caracteres)'+chr(10)+
                          chr(10), ''));

        if Length(sJustificativa) >= 15 then
        begin
          // Cancelamento da NF-e por evento.
          try
            sRetorno := spdNFe.CancelarNFeEvento(Form7.ibDataSet15NFEID.AsString,Form7.ibDataSet15NFEPROTOCOLO.AsString,sJustificativa, FormatDateTime('yyyy-mm-dd"T"hh:nn:"00"',Now), 1, Form7.sFuso);
          except
          end;
          
          if (Pos('<cStat>135</cStat>',sRetorno) <> 0)
            or (Pos('<cStat>136</cStat>',sRetorno) <> 0)
            or FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) then
          begin
            if Form7.ibDataSet14NOME.AsString <> Form7.ibDataSet15OPERACAO.AsString then
              Form7.ibDataSet14.Locate('NOME',Form7.ibDataSet15OPERACAO.AsString,[]);

            {Mauricio Parizotto 2023-08-29 Inicio
            if Form7.ibDataSet14NOME.AsString = Form7.ibDataSet15OPERACAO.AsString then
            begin
              if (Copy(Form7.ibDataSet14CFOP.AsString,2,3) = '929') then
              begin
                try
                  // Recupera o cupom
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.SQL.Clear;
                  Form7.ibQuery1.SQL.Add('update ALTERACA set VALORICM=Null where VALORICM='+   IntToStr(StrToInt(Form7.ibDataSet15NUMERONF.AsString)) +' ');
                  Form7.ibQuery1.Open;
                except
                  on E: Exception do
                  begin
                    Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+Form7.ibQuery1.SQL.Text),'Ateno',mb_Ok + MB_ICONWARNING);
                  end;
                end;
              end;
            end;
            }

            // Recupera o cupom
            try
              Form7.ibQuery1.Close;
              Form7.ibQuery1.SQL.Text :=' Update ALTERACA set VALORICM=Null '+
                                        ' Where VALORICM='+IntToStr(StrToInt(Form7.ibDataSet15NUMERONF.AsString));
              Form7.ibQuery1.ExecSQL;
            except
              on E: Exception do
              begin
                //Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+Form7.ibQuery1.SQL.Text),'Ateno',mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
                MensagemSistema(E.Message+chr(10)+chr(10)+Form7.ibQuery1.SQL.Text
                                ,msgErro);
              end;
            end;

            // Recupera o Oramento
            try
              Form7.ibQuery1.Close;
              Form7.ibQuery1.SQL.Text :=' Update ORCAMENT set NUMERONF=Null '+
                                        ' Where NUMERONF='+QuotedStr(Form7.ibDataSet15NUMERONF.AsString);
              Form7.ibQuery1.ExecSQL;
            except
              on E: Exception do
              begin
                //Application.MessageBox(pChar(E.Message+chr(10)+chr(10)+Form7.ibQuery1.SQL.Text),'Ateno',mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
                MensagemSistema(E.Message+chr(10)+chr(10)+Form7.ibQuery1.SQL.Text
                                ,msgErro);
              end;
            end;

            {Mauricio Parizotto 2023-08-29 Fim}

            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15STATUS.AsString       := 'NF-e cancelada';

            // Exemplo da funo xmlnodevalue xml node value feita pelo Sandro
            //
            //            Form7.ibDataSet15NFEPROTOCOLO.AsString := xmlNodeValue(sRetorno, '//retEnvEvento/retEvento/infEvento/nProt');
            //
            // No estou gravando para manter o PROTOCOLO original da NFE

            Form7.ibDataSet15EMITIDA.AsString := 'X';
            Form7.ibDataSet15.Post;
            
            while not FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) do
            begin
              Sleep(100);
            end;

            if FileExists(pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml'))) then
            begin
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(pChar(Form7.ibDataSet15NFEID.AsString));
              Form7.ibDataSet15.Post;

              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  
              Form7.ibDataSet2.Open;

              sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL

              if sZiparXML = 'S' then
              begin
                ShellExecute( 0, 'Open','szip.exe', pChar('backup "'+Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml')+'" "'+ Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.zip')+'"'),'', SW_SHOWMAXIMIZED);

                while ConsultaProcesso('szip.exe') do
                begin
                  Application.ProcessMessages;
                  sleep(100);
                end;

                while not FileExists(pChar(Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.zip'))) do
                begin
                  sleep(100);
                end;

                // 2024-02-26 Unit7.EnviarEMail('',sEmail,'','Cancelamento de NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo o cancelamento sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                //chr(10)+
                //chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve'+'.zip') ,False);

                EnviarEMail('',sEmail,'','Cancelamento de NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo o cancelamento sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'), PChar(Alltrim(Form1.sAtual + '\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve'+'.zip')), False);


              end else
              begin
                //2024-02-26 Unit7.EnviarEMail('',sEmail,'','Cancelamento de NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo o cancelamento sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                //chr(10)),pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml')),False);
                EnviarEMail('', sEmail, '', PChar('Cancelamento de NF-e (Nota Fiscal Eletrnica)'), PChar('Segue em anexo o cancelamento sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)), pChar(Alltrim(Form1.sAtual + '\XmlDestinatario\'+Form7.ibDAtaSet15NFEID.AsString+'-caneve.xml')), False);
              end;
            end;

            // Este cdigo  so pra homologacao do paf
            try
              if (Pos('=',UpperCase(Form7.ibDataSet14INTEGRACAO.AsString)) <> 0) or (Copy(Form7.ibDataSet14CFOP.AsString,2,3) = '929') then
              begin
                // No caso de importao de cupom fiscal '929' ou = na integrao nao deve voltar a quantidade no estoque
                // Porque no baixou estoque quando fez a nota.
              end else
              begin
                // Volta a quantidade no estoque
                Form7.ibDataSet16.First;
                while not Form7.ibDataset16.Eof do
                begin
                  if Form7.ibDataSet16SINCRONIA.AsFloat <> 0 then
                  begin
                    if AllTrim(Form7.ibDataSet16CODIGO.AsString)<>'' then
                    begin
                      Form7.ibDataSet4.Close;
                      Form7.ibDataSet4.SelectSQL.Clear;
                      Form7.ibDataSet4.SelectSQL.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet16CODIGO.AsString)+' ');
                      Form7.ibDataSet4.Open;

                      if Form7.ibDataSet4CODIGO.AsString = Form7.ibDataSet16CODIGO.AsString then
                      begin
                        ibDataSet4.Edit;
                        ibDataSet4QTD_ATUAL.AsFloat    := ibDataSet4QTD_ATUAL.AsFloat + ibDataSet16SINCRONIA.AsFloat; // Mantem a sincronia
                        ibDataSet4.Post;
                        Form7.sModulo := 'CANCELA';
                        ibDataSet16.Edit;
                        ibDataSet16SINCRONIA.AsFloat   := 0; // Resolvi este problema as 4 da madrugada no NoteBook em casa
                        ibDataSet16.Post;
                        Form7.sModulo := 'VENDA';
                      end;
                    end;
                  end;

                  Form7.ibDataset16.Next;
                end;
              end;
            except
              on E: Exception do
              begin
                //Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
                MensagemSistema(E.Message,msgErro);
              end;
            end;

            // Este cdigo altera a quantidade no estoque
            // Este cdigo  so pra homologacao do paf
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'X';
            Form7.ibDataSet15.Post;
            
            // Receber
            if sModulo = 'VENDA' then
            begin
              Form7.ibDataSet7.First;

              if Copy(Form7.ibDataSet15STATUS.AsString,1,31) = 'NF-e cancelada' then
              begin
                while not Form7.ibDataSet7.Eof do
                begin
                  if Form7.ibDataSet7NUMERONF.AsString = Form7.ibDataSet15NUMERONF.AsString then
                  begin
                    if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
                    begin
                      Form7.ibDataSet7.Edit;
                      Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
                    end else
                    begin
                      Form7.ibDataSet7.Edit;
                      Form7.ibDataSet7PORTADOR.AsString     := 'EM CARTEIRA';
                    end;

                    Form7.ibDataSet7ATIVO.AsString := '1';
                    Form7.ibDataSet7.Post;
                    Form7.ibDataSet7.Next;
                  end else
                  begin
                    Form7.ibDataSet7.Next;
                  end;
                end;
              end;
            end;
            
            // CAIXA
            ApagaIntegracaoComOCaixa(True);
            
            // Relaciona os clientes com o arquivo de vendas
            Form7.ibDataSet2.Close;
            Form7.ibDataSet2.Selectsql.Clear;
            Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  
            Form7.ibDataSet2.Open;
            
            // Data da ltima venda para o cliente
            try
              Form7.ibDataSet2.Edit;
              Form7.ibDataSet2ULTIMACO.AsString := '';
              Form7.ibDataSet2.Post;
            except
            end;

            commitatudo(True);

            Form7.Close;
            Form7.Show;
          end else
          begin
            sStatus := '';
            while sRetorno <> '' do
            begin
              if copy(sRetorno,1,9)='<xMotivo>' then
              begin
                sStatus  := sStatus + chr(10) + Copy(sRetorno,10,Pos('</xMotivo>',sRetorno)-10);
                sRetorno := Copy(sRetorno,9,Length(sRetorno)-10);
              end else
              begin
                sRetorno := Copy(sRetorno,2,Length(sRetorno)-1);
              end;
            end;
            
            if Alltrim(sStatus) <> '' then
            begin
              //ShowMessage(sStatus);Mauricio Parizotto 2023-10-25
              MensagemSistema(sStatus);
            end;
          end;
        end else
        begin
          if AllTrim(sJustificativa) <> '' then
          begin
            //ShowMessage('A justificativa tem que ter no minimo 15 caracteres.'); Mauricio Parizotto 2023-10-25
            MensagemSistema('A justificativa tem que ter no minimo 15 caracteres.',msgAtencao);
          end;
        end;
      except
      end;

      {$IFDEF VER150}
      DecimalSeparator := ',';
      DateSeparator    := '/';
      {$ELSE}
      FormatSettings.DecimalSeparator := ',';
      FormatSettings.DateSeparator    := '/';
      {$ENDIF}

      Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
      Form7.Panel7.Repaint;
    end;
  except
  end;

  Form7.sModulo := 'VENDA';

  if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
  begin
    Form7.N3ConsultarNFe1Click(Sender);
  end;
  
  Form7.Close;
  Form7.Show;
  Form7.DBGrid1.SetFocus;
  Screen.Cursor            := crDefault;
end;

procedure TForm7.N6EnviarNFeConsultareImprimirDANFE1Click(Sender: TObject);
begin
  EnviarConsultaImprimirDANFE;
end;

procedure TForm7.EnviarConsultaImprimirDANFE;
var
  Hora, Min, Seg, cent : Word;
  tInicio : tTime;
begin
  if Form7.sRPS = 'S' then
  begin
    Screen.Cursor            := crHourGlass;
    TransmiteNFSE;
    Screen.Cursor            := crDefault
  end else
  begin
    tInicio := Time;

    if ValidaLimiteDeEmissaoDeVenda(Form7.ibDataSet15EMISSAO.AsDateTime) then
    begin
      Form7.ibDataSet15.DisableControls;

      try
        if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
        begin
          if (Length(LimpaNumero(Form7.ibDataSet15NFEID.AsString)) = 44) and (Pos('Duplicidade',Form7.ibDataSet15STATUS.AsString)<>0)then
          begin
            Form7.N3ConsultarNFe1Click(nil);
          end else
          begin
            Form7.N1EnviarNFe1Click(nil);
            Screen.Cursor            := crHourGlass;
            Form7.N2ConsultarrecibodaNFe1Click(nil); Screen.Cursor            := crHourGlass;

            if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') and
               (Copy(Form7.ibDataSet15STATUS.AsString,1,8) <> 'Rejeicao') and
               (Copy(Form7.ibDataSet15STATUS.AsString,1,4) <> 'Erro') then
            begin
              Form7.N3ConsultarNFe1Click(nil);
            end else
            begin
              Form7.N1EnviarNFe1Click(nil);
              Screen.Cursor            := crHourGlass;
              Form7.N2ConsultarrecibodaNFe1Click(nil); Screen.Cursor            := crHourGlass;

              if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') and
                 (Copy(Form7.ibDataSet15STATUS.AsString,1,8) <> 'Rejeicao') and
                 (Copy(Form7.ibDataSet15STATUS.AsString,1,4) <> 'Erro') then
              begin
                Form7.N3ConsultarNFe1Click(nil);
              end;
            end;
          end;

          DecodeTime((Time - tInicio), Hora, Min, Seg, cent);
          Form7.Panel7.Hint := 'Tempo para autorizar a NF-e: '+TimeToStr(Time - tInicio)+'  '+StrZero(cent,3,0);

          if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
          begin
            try
              Form7.N4ImprimirDANFE1Click(nil);
              Screen.Cursor  := crHourGlass;
              Form7.N5EnviarDANFEporemail1Click(nil);
              Screen.Cursor  := crHourGlass;
            except
            end;
          end;
        end;

        Form7.ibDataSet15.EnableControls;
      except
      end;

      {Sandro Silva 2022-09-29 inicio
      VVerificaresquemashema1Click(Sender);
      }
      if PermiteValidarSchema(Form7.ibDataSet15) then
        VerificarShemaXsd(Form7.ibDataSet15NFEXML.AsString, False);
      {Sandro Silva 2022-09-29 fim}
    end;
    Screen.Cursor            := crDefault;
  end;
end;

procedure TForm7.N0TestarservidorNFe1Click(Sender: TObject);
var
  sStatus, sRetorno : String;
begin
  Screen.Cursor            := crHourGlass;

  ConfiguraNFE;

  try
    sRetorno := spdNFe.StatusDoServico;

    if Pos('<cStat>',sRetorno) <> 0 then
    begin
      sStatus := Alltrim(Copy(sRetorno+'   ',Pos('<cStat>',sRetorno)+7,Pos('</cStat>',sRetorno)-Pos('<cStat>',sRetorno)-7));
    end else sStatus := '';

    if sStatus = '109' then
    begin
      {
      Application.MessageBox(pChar(chr(10) +'Aguarde, no  possvel enviar esta NF-e no momento.'+Chr(10)+
      'Servio Paralisado sem Previso.'+Chr(10)+
      chr(10)+
      'OBS: Tente ativar o modo SCAN (Configuraes; Configurao da NF-e; (SCAN) Sistema de Contingncia do Ambiente Nacional).'),
      'Ateno',mb_Ok + MB_ICONWARNING);
      Mauricio Parizotto 2023-10-24}
      
      MensagemSistema(chr(10) +'Aguarde, no  possvel enviar esta NF-e no momento.'+Chr(10)+
                      'Servio Paralisado sem Previso.'+Chr(10)+
                      chr(10)+
                      'OBS: Tente ativar o modo SCAN (Configuraes; Configurao da NF-e; (SCAN) Sistema de Contingncia do Ambiente Nacional).'
                      ,msgAtencao);
    end;

    if sStatus = '108' then
    begin
      {
      Application.MessageBox(pChar(chr(10) +'Aguarde, no  possvel enviar esta NF-e no momento.'+Chr(10)+
      'Servio Paralisado Momentaneamente (curto prazo).'),
      'Ateno',mb_Ok + MB_ICONWARNING);
      Mauricio Parizotto 2023-10-24}

      MensagemSistema(chr(10) +'Aguarde, no  possvel enviar esta NF-e no momento.'+Chr(10)+
                      'Servio Paralisado Momentaneamente (curto prazo).'
                      ,msgAtencao);
    end;
    
    if sStatus <> '107' then
    begin
      //ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9)); Mauricio Parizotto 2023-10-25
      MensagemSistema(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
    end else
    begin
      //ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));Mauricio Parizotto 2023-10-25
      MensagemSistema(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
    end;
  except
    on E: Exception do
    begin
      if Pos('CERTIFICADO',Uppercase(e.Message)) <> 0 then
      begin
        {
        Application.MessageBox(
        pChar(
        chr(10) +'Erro:'
        +Chr(10)
        +Chr(10)+E.Message
        +Chr(10)
        +chr(10)+'1 - Verifique se o seu certificado est instalado'
        +chr(10)+'2 - Verifique se o seu certificado est selecionado (Configuraes da NF-e; Selecionar Certificado Digital...)'
        +chr(10)+'3 - Seu certificado pode estar vencido'
        +chr(10)+'4 - Seu certificado pode ser invlido'
        + chr(10)
        +chr(10)+'Certificados recomendados pela Smallsoft'
        +chr(10)+''
        +chr(10)+'1. Certificados SERASA'
        +chr(10)+'    * A1'
        +chr(10)+'    * SmartCard'
        +chr(10)+'    * E-CNPJ'
        +chr(10)+'2. Certificados Certisign A1 e A3'
        +chr(10)+'3. Certificados dos Correios A1 e A3'
        +chr(10)+'4. Certificados A3 PRONOVA ACOS5.'),
        'Ateno',mb_Ok + MB_ICONWARNING);
        Mauricio Parizotto 2023-10-24}

        MensagemSistema(chr(10) +'Erro:'
                        +Chr(10)
                        +Chr(10)+E.Message
                        +Chr(10)
                        +chr(10)+'1 - Verifique se o seu certificado est instalado'
                        +chr(10)+'2 - Verifique se o seu certificado est selecionado (Configuraes da NF-e; Selecionar Certificado Digital...)'
                        +chr(10)+'3 - Seu certificado pode estar vencido'
                        +chr(10)+'4 - Seu certificado pode ser invlido'
                        + chr(10)
                        +chr(10)+'Certificados recomendados pela Smallsoft'
                        +chr(10)+''
                        +chr(10)+'1. Certificados SERASA'
                        +chr(10)+'    * A1'
                        +chr(10)+'    * SmartCard'
                        +chr(10)+'    * E-CNPJ'
                        +chr(10)+'2. Certificados Certisign A1 e A3'
                        +chr(10)+'3. Certificados dos Correios A1 e A3'
                        +chr(10)+'4. Certificados A3 PRONOVA ACOS5.'
                        ,msgAtencao);
      end else
      begin
        {
        Application.MessageBox(
        pChar(
        chr(10) +'Erro:'
        +Chr(10)
        +Chr(10)+E.Message
        +Chr(10)
        +chr(10) +'No foi possvel acessar o servidor da receita.'
        +Chr(10)
        +chr(10)+'1 - Verifique sua conexo de internet'
        +chr(10)+'2 - Verifique a disponibilidade dos servios (Configuraes da NF-e; Disponibilidade dos Servios).'),
        'Ateno',mb_Ok + MB_ICONWARNING);
        Mauricio Parizotto 2023-10-24}

        MensagemSistema(chr(10) +'Erro:'
                                  +Chr(10)
                                  +Chr(10)+E.Message
                                  +Chr(10)
                                  +chr(10) +'No foi possvel acessar o servidor da receita.'
                                  +Chr(10)
                                  +chr(10)+'1 - Verifique sua conexo de internet'
                                  +chr(10)+'2 - Verifique a disponibilidade dos servios (Configuraes da NF-e; Disponibilidade dos Servios).'
                                  ,msgAtencao);
      end;
    end;
  end;

  {$IFDEF VER150}
  DecimalSeparator := ',';
  DateSeparator    := '/';
  {$ELSE}
  FormatSettings.DecimalSeparator := ',';
  FormatSettings.DateSeparator    := '/';
  {$ENDIF}

  Screen.Cursor            := crDefault;
end;

procedure TForm7.ransmitirNFe1Click(Sender: TObject);
begin
  bProximas := True;
  while not Form7.ibDataSet15.Eof do
  begin
    EnviarConsultaImprimirDANFE;
    Form7.ibDataSet15.Next;
  end;
  bProximas := False;
end;

procedure TForm7.N5EnviarDANFEporemail1Click(Sender: TObject);
var
  sLote    : String;
  sEmail   : String;
  sEmail1  : String;
  sCaminhoXML: String;
  sCaminhoPDF: String;
  cAnexo: String;
  cMensagem: String;
  cMsgAnexo: string;
  cNomePDF: String;
begin
  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
  Form7.ibDataSet2.Open;
  //
  Form7.ibDataSet18.Locate('NOME',Form7.ibDataSet15TRANSPORTA.AsString,[]);
  //
  DistribuicaoNFe('XML');
  //
  if ibDataSet2NOME.AsString = ibDataSet15CLIENTE.AsString then
  begin
    if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') then
    begin
      Screen.Cursor            := crHourGlass;
      Form7.Panel7.Caption := 'Imprimindo o DANFE'+replicate(' ',100);
      Form7.Panel7.Repaint;

      ConfiguraNFE;

      // Recupera na tabela VENDAS o XML
      fNFE :=  Form7.ibDataSet15NFEXML.AsString;
      //
      // Recupera na tabela VENDAS o XML
      try
        sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL

        if Alltrim(Form7.ibDataSet15TRANSPORTA.AsString) = Alltrim(Form7.ibDataSet18NOME.AsString) then
        begin
          sEmail1 := Form7.ibDataSet18EMAIL.AsString; // XML POR EMAIL
        end else
        begin
          sEmail1  := '';
        end;

        if (validaEmail(sEmail)) or (validaEmail(sEmail1)) then
        begin
          cNomePDF := 'danfe_NF_' + Form7.ibDataSet15NUMERONF.AsString + '.pdf';
          try
            if sEnviarDAnfePorEmail = 'S' then
            begin
              while FileExists(pChar(cNomePDF)) do
              begin
                DeleteFile(pChar(cNomePDF));
                Sleep(100);
              end;

              spdNFe.ExportarDanfe(sLote, fNfe, Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm',1,Form1.sAtual+'\' + cNomePDF);
              sCaminhoPDF := Form1.sAtual+'\'+cNomePDF;

              if not FileExists(pChar(cNomePDF)) then
                sCaminhoPDF := EmptyStr;
            end;

            spdNFe.ExportarDanfe(sLote, fNfe, Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm',1,Form1.sAtual+'\' + cNomePDF);
            sCaminhoPDF := Form1.sAtual+'\'+cNomePDF;

            if not FileExists(pChar(cNomePDF)) then
              sCaminhoPDF := EmptyStr;

            if sZiparXML = 'S' then
            begin
              ShellExecute( 0, 'Open','szip.exe',pChar('backup "'+pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml')+'" "'+pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip')+'"'), '', SW_SHOWMAXIMIZED);
              while ConsultaProcesso('szip.exe') do
              begin
                Application.ProcessMessages;
                sleep(100);
              end;
              while not FileExists(pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip')) do
              begin
                sleep(100);
              end;
              sCaminhoXML := Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip';
            end else
              sCaminhoXML := Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml';

            if (sCaminhoPDF <> EmptyStr) or (sCaminhoXML <> EmptyStr) then
            begin
              cAnexo    := sCaminhoPDF;
              cMsgAnexo := 'PDF';
            end;
            if (sCaminhoXML <> EmptyStr) then
            begin
              if cAnexo <> EmptyStr then
              begin
                cAnexo := cAnexo + ';';
                cMsgAnexo := 'XML e o PDF';
              end else
                cMsgAnexo := 'XML';
              cAnexo := cAnexo + sCaminhoXML;
            end;

            cMensagem := TTextoEmailFactory.New
                                           .NFe
                                           .setDescrAnexo(cMsgAnexo)
                                           .setDataEmissao(Form7.ibDataSet15EMISSAO.AsDateTime)
                                           .setNumeroDocumento(Form7.ibDataSet15NUMERONF.AsString)
                                           .setChaveAcesso(Form7.ibDataSet15NFEID.AsString)
                                           .setPropaganda(Form1.sPropaganda)
                                           .RetornarTexto;

            if (validaEmail(sEmail)) then
            begin
              //2024-02-26 Unit7.EnviarEMail('',sEmail,'','Sua Nota Fiscal Eletrnica',PAnsichar(cMensagem),PAnsiChar(cAnexo),False);
              EnviarEMail('', sEmail, '', PChar('Sua Nota Fiscal Eletrnica'), PChar(cMensagem), PChar(cAnexo), False);
            end;
            if (validaEmail(sEmail1)) then
            begin
              //2024-02-26 Unit7.EnviarEMail('',sEmail1,'','Sua Nota Fiscal Eletrnica',PAnsichar(cMensagem),PAnsiChar(cAnexo),False);
              EnviarEMail('', sEmail1, '', PChar('Sua Nota Fiscal Eletrnica'), PChar(cMensagem), PChar(cAnexo), False);
            end;
          finally
            if (sCaminhoPDF <> EmptyStr) and (FileExists(pChar(sCaminhoPDF))) then
              DeleteFile(pChar(sCaminhoPDF));
          end;
          if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
          begin
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'S'; // Emitida
            Form7.ibDataSet15.Post;
          end;

{            while FileExists(pChar('danfe.pdf')) do
            begin
              DeleteFile(pChar('danfe.pdf'));
              Sleep(100);
            end;
            spdNFe.ExportarDanfe(sLote, fNfe, Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm',1,Form1.sAtual+'\danfe.pdf');
            if FileExists(pChar('danfe.pdf')) then
            begin
              sCaminhoPDF := Form1.sAtual+'\danfe.pdf';
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','DANFE (Documento Auxiliar da NF-e)',pchar('Segue em anexo seu DANFE em arquivo PDF.'+chr(10)+Form1.sPropaganda),pChar(Form1.sAtual+'\danfe.pdf'),False);
              end;
              if (validaEmail(sEmail1)) then
              begin
                Unit7.EnviarEMail('',sEmail1,'','DANFE (Documento Auxiliar da NF-e)',pchar('Segue em anexo DANFE em arquivo PDF para transportadora.'+chr(10)+Form1.sPropaganda),pChar(Form1.sAtual+'\danfe.pdf'),False);
              end;
            end;
          end;
          if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
          begin
            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15EMITIDA.AsString := 'S'; // Imitida
            Form7.ibDataSet15.Post;
          end;
          if FileExists(pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml')) then
          begin
            if sZiparXML = 'S' then
            begin
              ShellExecute( 0, 'Open','szip.exe',pChar('backup "'+pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml')+'" "'+pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip')+'"'), '', SW_SHOWMAXIMIZED);
              while ConsultaProcesso('szip.exe') do
              begin
                Application.ProcessMessages;
                sleep(100);
              end;
              while not FileExists(pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip')) do
              begin
                sleep(100);
              end;
              sCaminhoXML := Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip';
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip'),False);
              end;
              if (validaEmail(sEmail1)) then
              begin
                Unit7.EnviarEMail('',sEmail1,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo NF-e em arquivo XML para transportadora.'+chr(10)+Form1.sPropaganda+
                chr(10)+
                chr(10)+'OBS: Por segurana o arquivo XML foi zipado.'),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.zip'),False);
              end;
            end else
            begin
              if (validaEmail(sEmail)) then
              begin
                Unit7.EnviarEMail('',sEmail,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo sua NF-e em arquivo XML.'+chr(10)+Form1.sPropaganda+
                chr(10)),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'),False);
              end;
              if (validaEmail(sEmail1)) then
              begin
                Unit7.EnviarEMail('',sEmail1,'','NF-e (Nota Fiscal Eletrnica)',pchar('Segue em anexo NF-e em arquivo XML para transportadora.'+chr(10)+Form1.sPropaganda+
                chr(10)),pChar(Form1.sAtual+'\XML\'+Form7.ibDAtaSet15NFEID.AsString+'-nfe.xml'),False);
              end;
            end;   }
        end;
      except
        Screen.Cursor            := crDefault;
      end;

      {$IFDEF VER150}
      DecimalSeparator := ',';
      DateSeparator    := '/';
      {$ELSE}
      FormatSettings.DecimalSeparator := ',';
      FormatSettings.DateSeparator    := '/';
      {$ENDIF}

      Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
      Form7.Panel7.Repaint;
      Screen.Cursor            := crDefault;
    end;
  end;
end;

procedure TForm7.N6VisualizarDANFE1Click(Sender: TObject);
var
  sFormato, sLote : String;
  bTentarVisualizar: Boolean; // Sandro Silva 2023-02-14
begin
  bTentarVisualizar := False;
  if sModulo = 'VENDA' then
  begin
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '') then
      bTentarVisualizar := True;
  end;

  if sModulo = 'COMPRA' then
  begin
    if Form7.ibDataSet24NFEXML.AsString <> '' then
      bTentarVisualizar := True;
  end;

  if bTentarVisualizar then
  begin
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption := 'Visualizando o DANFE'+replicate(' ',100);
    Form7.Panel7.Repaint;

    ConfiguraNFE;

    // Recupera na tabela VENDAS o XML
    sFormato := Form1.sAtual + '\nfe\Templates\vm60\danfe\'+Form7.sFormatoDoDanfe+'.rtm';
    if sModulo = 'VENDA' then
    begin
      fNFE :=  Form7.ibDataSet15NFEXML.AsString;

      // Recupera na tabela VENDAS o XML
      if Form7.ibDataSet15EMITIDA.AsString = 'X' then
      begin
        sFormato := Form7.spdNFe.DanfeSettings.ModeloRetratoCancelamento;
      end;
    end;

    if sModulo = 'COMPRA' then
    begin
      fNFE :=  Form7.ibDataSet24NFEXML.AsString;
      Form7.spdNFe.DanfeSettings.LogotipoEmitente := '';
    end;

    try
      spdNFe.VisualizarDanfe(sLote, fNFe, sFormato);
    except
      Screen.Cursor            := crDefault;
    end;

    {$IFDEF VER150}
    DecimalSeparator := ',';
    DateSeparator    := '/';
    {$ELSE}
    FormatSettings.DecimalSeparator := ',';
    FormatSettings.DateSeparator    := '/';
    {$ENDIF}

    Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
    Form7.Panel7.Repaint;
    Screen.Cursor            := crDefault;
  end;
end;

procedure TForm7.ibDataset40NewRecord(DataSet: TDataSet);
begin
  //
  ibDataSet40.Edit;
  ibDataSet40REGISTRO.AsString  := sProximo;
  //
end;

procedure TForm7.ibDataset40BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_ITENSETI,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  //Troca Cor Celula Selecionada
  with (Sender as TDBGrid).Canvas do
  begin
    if (gdSelected in State) then
    begin
      Brush.Color := $00D77800;
      FillRect(Rect);
      Font.Color:= clWhite;
      TextOut(Rect.Left, Rect.Top,Column.Field.AsString);
    end;

    (Sender as TDBGrid).DefaultDrawColumnCell(Rect, DataCol, Column, State);
  end;

  //Mauricio Parizotto 2023-01-03
  if Column.Field.DataType = ftMemo then
  begin
    DBGridExibeMemo(DBGrid1, Column, Rect, State, Column.FieldName);
  end;

  DrawCell_Receber(Sender, Rect, DataCol, Column,State);

  DrawCell_Pagar(Sender, Rect, DataCol, Column,State);

  DrawCell_Estoque(Sender, Rect, DataCol, Column,State);

  DrawCell_Vendas(Sender, Rect, DataCol, Column,State);

  DrawCell_NaturezaOP(Sender, Rect, DataCol, Column,State);

  DrawCell_Clientes(Sender, Rect, DataCol, Column,State);

  DrawCell_Compras(Sender, Rect, DataCol, Column,State);

  DrawCell_Caixa(Sender, Rect, DataCol, Column,State);

  DrawCell_Bancos(Sender, Rect, DataCol, Column,State);

end;

procedure TForm7.GerarNFedeentrada1Click(Sender: TObject);
var
  sSerie : String;
begin
  try
    Screen.Cursor            := crHourGlass;
    sSerie := Copy(Form7.ibDAtaSet24NUMERONF.AsString,10,3);
    //
    Form7.ibDataSet15.Close;
    Form7.ibDataSet15.SelectSQL.Clear;
    Form7.ibDataSet15.SelectSQL.Add('select * from VENDAS where NUMERONF like '+QuotedStr('%'+sSerie)+ ' order by NUMERONF');
    Form7.ibDataSet15.Open;
    Form7.ibDataSet15.Last;
    //
    if Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) = Right(StrZero(StrToInt('0'+Copy(Form7.ibDataSet15NUMERONF.AsString,1,9))+1,9,0),9) then
    begin
      Form7.sTitulo := 'Notas fiscais de sada (vendas) srie '+sSerie;
      Form7.ibDataSet15.Append;
      Form7.ibDataSet15.Edit; Form7.ibDataSet15NUMERONF.AsString := Copy(Form7.ibDataSet24NUMERONF.AsString,1,9) + sSerie;
      Form7.ibDataSet15.Edit; Form7.ibDataSet15CLIENTE.AsString  := Form7.ibDataSet24FORNECEDOR.AsString;
      Form7.ibDataSet15.Edit; Form7.ibDataSet15OPERACAO.AsString := Form7.ibDataSet24OPERACAO.AsString;
      //
      if AllTrim(Form7.ibDataSet24FRETE12.AsString) <> '' then
      begin
        Form7.ibDataSet15.Edit;
        Form7.ibDataSet15FRETE12.AsString  := Form7.ibDataSet24FRETE12.AsString;
      end else
      begin
        Form7.ibDataSet15.Edit;
        Form7.ibDataSet15FRETE12.AsString  := '0';
      end;
      //
      Form7.ibDataSet15.Edit;
      Form7.ibDataSet15COMPLEMENTO.AsString := 'ENTRADA';
      Form7.ibDataSet15.Edit;
      Form7.ibDataSet15EMITIDA.AsString     := 'E';
      //
      Form7.ibDataSet15.Post;

      //ShowMessage('Nota fiscal de entrada gerada com sucesso.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Nota fiscal de entrada gerada com sucesso.');
    end else
    begin
      //ShowMessage('Nota Fiscal fora de sequncia.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Nota Fiscal fora de sequncia.',msgAtencao);
    end;
  except
  end;
  
  Form7.sModulo := 'COMPRA';
  Screen.Cursor            := crDefault;
end;

procedure TForm7.N9ImprimirDANFEemformulriodecontingncia1Click(
  Sender: TObject);
var
  bPode : Boolean;
begin
  ConfiguraNFE;

  bPode := True;

  if bPode then
  begin
    Form7.ibDataSet15.DisableControls;
    try
      if ValidaLimiteDeEmissaoDeVenda(Form7.ibDataSet15EMISSAO.AsDateTime) then
      begin
        if (Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) = '') then
        begin
          begin
            bContingencia := True;
            Form7.N1EnviarNFe1Click(Sender);
            Form7.N4ImprimirDANFE1Click(Sender); Screen.Cursor := crHourGlass;
            //
            if Form7.ibDataSet15EMITIDA.AsString <> 'X' then
            begin
              Form7.ibDataSet15.Edit;
              Form7.ibDataSet15EMITIDA.AsString := 'S';
              Form7.ibDataSet15.Post;
            end;
            //
            BaixaEstoqueDaNFeAutorizada('');
            //
            bContingencia := False;
          end;
        end else
        begin
          //ShowMessage('NF-e j foi enviada.'); Mauricio Parizotto 2023-10-25
          MensagemSistema('NF-e j foi enviada.');
        end;
      end;

    except
    end;

    Form7.ibDataSet15.EnableControls;

  end;

  {$IFDEF VER150}
  DecimalSeparator := ',';
  DateSeparator    := '/';
  {$ELSE}
  FormatSettings.DecimalSeparator := ',';
  FormatSettings.DateSeparator    := '/';
  {$ENDIF}

  Screen.Cursor            := crDefault;
end;

procedure TForm7.Agrupar1Click(Sender: TObject);
begin
  Form1.Panel4.Visible := False;
  //
  Form1.SQLMododecomando1Click(Sender);
  //
  if Pos('ORDER BY',UpperCase(Form7.TabelaAberta.SelectSQL.Text))<> 0 then
  begin
    Form1.Edit200.Text := Copy(Form7.TabelaAberta.SelectSQL.Text,1,Pos('ORDER BY',UpperCase(Form7.TabelaAberta.SelectSQL.Text))-1);
  end else
  begin
    Form1.Edit200.Text := Form7.TabelaAberta.SelectSQL.Text;
  end;
  //
  Form1.Edit200.Text := StrTran(Form1.Edit200.Text,'*',' '+Form7.DBGrid1.SelectedField.FieldName+' as "'+Form7.DBGrid1.SelectedField.DisplayName+'", count('+QuotedStr(Form7.DBGrid1.SelectedField.FieldName)+')as "Ocorrncias"')+' group by '+Form7.DBGrid1.SelectedField.FieldName+' order by "Ocorrncias"' ;
  FechaTudo(Form1.bFechaTudo);
end;

procedure TForm7.ExportarNFesemarquivoXML1Click(Sender: TObject);
begin
  ChamarTelaXMLContab;
end;

procedure TForm7.ibDataSet4ULT_VENDASetText(Sender: TField;
  const Text: String);
begin
  {
  Application.MessageBox(Pchar('Esta data no pode ser alterada manualmente. Por estar diretamente'+ Chr(10) +
                                        'relacionada a relatrios de venda.' + Chr(10))
                                         ,'Ateno',mb_Ok);
  Mauricio Parizotto 2023-10-24}

  MensagemSistema('Esta data no pode ser alterada manualmente. Por estar diretamente'+ Chr(10) +
                  'relacionada a relatrios de venda.' + Chr(10)
                  ,msgAtencao);
end;

procedure TForm7.XConsultarcadastro1Click(Sender: TObject);
var
  sRetorno : String;
begin
  Screen.Cursor            := crHourGlass;

  try
    sRetorno := Form7.spdNFe.ConsultarCadastro(LimpaNumero(Form7.ibDataSet13CGC.AsString),'CNPJ',Form7.ibDataSet13ESTADO.AsString);
    sRetorno := Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
  except
    if Form1.bHomologacao then
    begin
      //ShowMessage('O Servio no esta disponvel no web service, ou o endereo no est configurado no arquivo '+Pchar(Form1.sAtual+'\NFE\nfeServidoresHom.ini')); Mauricio Parizotto 2023-10-25
      MensagemSistema('O Servio no esta disponvel no web service, ou o endereo no est configurado no arquivo '+Pchar(Form1.sAtual+'\NFE\nfeServidoresHom.ini'));
    end else
    begin
      //ShowMessage('O Servio no esta disponvel no web service, ou o endereo no est configurado no arquivo '+Pchar(Form1.sAtual+'\NFE\nfeServidoresProd.ini')); Mauricio Parizotto 2023-10-25
      MensagemSistema('O Servio no esta disponvel no web service, ou o endereo no est configurado no arquivo '+Pchar(Form1.sAtual+'\NFE\nfeServidoresProd.ini'));
    end;
  end;

  //ShowMessage(sRetorno); Mauricio Parizotto 2023-10-25
  MensagemSistema(sRetorno);
  
  Screen.Cursor            := crDefault;
end;

procedure TForm7.vendasparaClick(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form38.Label21.Caption := Form7.ibDataSet2NOME.AsString;
  Form38.Label21.Visible := True;
  Form7.sModulo := 'Vendas para';
  Form38.ShowModal; // Ok
  Form38.Label21.Visible := False;
  //
end;

procedure TForm7.Ca1Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  if Form7.sModulo = 'ESTOQUE' then
  begin
    Form7.Caption := 'Catlogo de produtos';
    { L as configuraes no .INF }
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    { -- Mais1Ini.WriteString(Mais.sEscolhido,'L'+alltrim(IntToStr(I)), -- }
    Form39.CheckBox4.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo1','7'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00') +'%';
    Form39.CheckBox5.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo2','14'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00') +'%';
    Form39.CheckBox6.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo3','21'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00') +'%';
    //
    Form39.Label1.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00');
    Form39.Label2.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00');
    Form39.Label3.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00');
    //
    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    Form39.CheckBox7.Visible := False;
    Form39.CheckBox8.Visible := False;
    //
    Form39.Height := 80;
  end;
  Form9.Show;
  Form14.Caption := 'Assistente para catlogo de produtos';
  Form14.Show;
end;

procedure TForm7.lbumdefotografias1Click(Sender: TObject);
begin
  Form7.Caption := 'lbum de fotografias';
  Form14.Caption := 'Assistente para lbum de fotografias';
  Form9.Show;
  Form14.Show;
end;

procedure TForm7.SPEDFiscal1Click(Sender: TObject);
begin
  if not FileExists(Form1.sAtual+'\sped.exe') then
    ShellExecute( 0, 'Open', 'sped_setup.exe', '', '', SW_SHOW);

  if FileExists(Form1.sAtual+'\sped.exe') then
    ShellExecute( 0, 'Open', 'sped.exe', '', '', SW_SHOW)
  else
    //ShowMessage('O executvel sped.exe no foi encontrado na pasta de instalao do programa.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('O executvel sped.exe no foi encontrado na pasta de instalao do programa.');
end;

procedure TForm7.ibDataSet8DOCUMENTOSetText(Sender: TField;
  const Text: String);
begin
  Form7.ibDataSet8DOCUMENTO.AsString := AllTrim(Text);
end;

procedure TForm7.SMALL_DBEdit2Change(Sender: TObject);
begin
  if Form7.sModulo = 'RECEBER' then
  begin
    if Form7.ibDataSet7ATIVO.AsFloat >= 5 then
    begin
      Edit2.Text := SMALL_DBEdit2.Text;
      Form7.SMALL_DBEdit1.Visible := True;
    end else
    begin
      Edit2.Text := '';
      Form7.SMALL_DBEdit1.Visible := False;
    end;
  end else
  begin
    if Form7.ibDataSet8ATIVO.AsFloat >= 5 then
    begin
      Edit2.Text := SMALL_DBEdit2.Text;
      Form7.SMALL_DBEdit1.Visible := True;
    end else
    begin
      Edit2.Text := '';
      Form7.SMALL_DBEdit1.Visible := False;
    end;
  end;
end;

procedure TForm7.Edit2KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
  bAchou : Boolean;
begin
  //
  if (Key = Vk_Return) or (Key = Vk_Tab) then
  begin
    //
    if Alltrim(Edit2.Text) <> '' then
    begin
      //
      if Form7.sModulo = 'PAGAR' then
      begin
        //
        bAchou := Form7.ibDataSet8.Locate('DOCUMENTO',Edit2.Text,[]);
        //
        if not bAchou then
        begin
          //
          Form7.IBQuery99.Close;
          Form7.IBQuery99.SQL.Clear;
          Form7.IBQuery99.SQL.Add('select DOCUMENTO from PAGAR where DOCUMENTO like '+QuotedStr('%'+Edit2.Text+'%')+' and  coalesce(VALOR_PAGO,0)=0 ');
          Form7.IBQuery99.Open;
          //
          if AllTrim(Form7.IBQuery99.FieldByname('DOCUMENTO').AsString) <> '' then
          begin
            Edit2.Text := Form7.IBQuery99.FieldByname('DOCUMENTO').AsString;
            bAchou := Form7.ibDataSet8.Locate('DOCUMENTO',Edit2.Text,[]);
          end;
        end;
        //
        if bAchou then
        begin
          //
          if Form7.ibDataSet8ATIVO.AsFloat < 5 then
          begin
            //
            if Form7.ibDataSet8VALOR_PAGO.AsFloat = 0 then
            begin
              //
              Form7.SMALL_DBEdit1.Visible := True;
              Form7.Edit2.Text        := Form7.SMALL_DBEdit2.Text;
              //
              Form7.ibDataSet8.Edit;
              if Form7.ibDataSet8ATIVO.AsFloat < 5 then
              begin
                //
                Form7.ibDataSet8ATIVO.AsFloat := Form7.ibDataSet8ATIVO.AsFloat + 5;
                Form7.ibDataSet8VALOR_PAGO.AsFloat := Form7.ibDataSet8VALOR_DUPL.AsFloat;
                //
              end;
              //
              Form7.ibDataSet8.Post;
              //
              Form1.IBDataSet200.Close;
              Form1.IBDataSet200.Open;
              //
              Form7.ibQuery1.Close;
              Form7.IBQuery1.SQL.Clear;
              Form7.IBQuery1.SQL.Add('select sum(VALOR_PAGO) from PAGAR where ATIVO >= 5');
              Form7.IBQuery1.Open;
              //
              Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
              Form7.Panel10.Repaint;
              //
              SMALL_DBEdit1.SetFocus;
            end else
            begin
              Edit2.Text := '';
              Edit2.SetFocus;
              //ShowMessage('Documento j foi pago'); Mauricio Parizotto 2023-10-25
              MensagemSistema('Documento j foi pago');
            end;
          end else
          begin
            Edit2.SetFocus;
            //ShowMessage('Documento j foi selecionado'); Mauricio Parizotto 2023-10-25
            MensagemSistema('Documento j foi selecionado');
          end;
        end else
        begin
          Edit2.Text := '';
          Edit2.SetFocus;
          //ShowMessage('Documento j foi quitado'); Mauricio Parizotto 2023-10-25
          MensagemSistema('Documento j foi quitado');
        end;
      end else
      begin
        bAchou := Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Edit2.Text),[]);
        //
        if not bAchou then
        begin
          Form7.IBQuery99.Close;
          Form7.IBQuery99.SQL.Clear;
          Form7.IBQuery99.SQL.Add('select DOCUMENTO from RECEBER where DOCUMENTO like '+QuotedStr('%'+Edit2.Text+'%')+'  and coalesce(VALOR_RECE,0)=0 ');
          Form7.IBQuery99.Open;
          //
          if AllTrim(Form7.IBQuery99.FieldByname('DOCUMENTO').AsString) <> '' then
          begin
            Edit2.Text := Form7.IBQuery99.FieldByname('DOCUMENTO').AsString;
            bAchou := Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Edit2.Text),[]);
          end;
        end;

        if bAchou then
        begin
          if Form7.ibDataSet7ATIVO.AsFloat < 5 then
          begin
            //
            if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
            begin
              //
              Form7.SMALL_DBEdit1.Visible := True;
              Form7.Edit2.Text        := Form7.SMALL_DBEdit2.Text;
              //
              Form7.ibDataSet7.Edit;
              if Form7.ibDataSet7ATIVO.AsFloat < 5 then
              begin
                //
                Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
                Form7.ibDataSet7VALOR_RECE.AsFloat := Form7.ibDataSet7VALOR_DUPL.AsFloat;
                //
              end;
              //
              Form7.ibDataSet7.Post;
              //
              Form1.IBDataSet200.Close;
              Form1.IBDataSet200.Open;
              //
              Form7.ibQuery1.Close;
              Form7.IBQuery1.SQL.Clear;
              Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
              Form7.IBQuery1.Open;
              //
              Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
              Form7.Panel10.Repaint;
              //
              SMALL_DBEdit1.SetFocus;
            end else
            begin
              Edit2.Text := '';
              Edit2.SetFocus;
              //ShowMessage('Documento j foi pago'); Mauricio Parizotto 2023-10-25
              MensagemSistema('Documento j foi pago');
            end;
          end else
          begin
            Edit2.Text := '';
            Edit2.SetFocus;
            //ShowMessage('Documento j foi selecionado'); Mauricio Parizotto 2023-10-25
            MensagemSistema('Documento j foi selecionado');
          end;
        end else
        begin
          Edit2.SetFocus;
          //ShowMessage('Documento no encontrado......'); Mauricio Parizotto 2023-10-25
          MensagemSistema('Documento no encontrado......');
        end;
      end;
    end else
    begin
      SMALL_DBEdit6.SetFocus;
    end;
  end;
end;

procedure TForm7.SMALL_DBEdit1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = Vk_Return) or (Key = Vk_Tab) then
  begin
    //
    if (Form7.ibDataset7.State in ([dsEdit, dsInsert])) then Form7.ibDataset7.Post;
//    Form7.ibDataSet7.Post;
      Form7.ibDataSet7.Edit;
    {Dailon Parisotto (f-6594) 2023-02-01 Inicio}
    if sModulo = 'PAGAR' then
    begin
      if (Form7.ibDataset8.State in ([dsEdit, dsInsert])) then Form7.ibDataset8.Post;
        Form7.ibDataSet8.Edit;
    end;
    {Dailon Parisotto (f-6594) 2023-02-01 Fim}
    //
    Form1.IBDataSet200.Close;
    Form1.IBDataSet200.Open;
    //
    CalculaTotalRecebido(True);
    Form7.Edit2.SetFocus;
    // 
  end;
end;

procedure TForm7.DBGrid3KeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if Form7.sModulo = 'PAGAR' then
  begin
    Form7.ibDataSet8.Locate('REGISTRO',Form1.IBDataSet200.FieldByname('REGISTRO').AsString,[]);
  end;
  if Form7.sModulo = 'RECEBER' then
  begin
    Form7.ibDataSet7.Locate('REGISTRO',Form1.IBDataSet200.FieldByname('REGISTRO').AsString,[]);
  end;
end;

procedure TForm7.SMALL_DBEdit6Exit(Sender: TObject);
var
  ftotal : Real;
begin
  //LogRetaguarda('25841'); // Sandro Silva 2023-09-13
  //
  CalculaTotalRecebido(True);
  fTotal := StrToFloat(LimpaNumeroDeixandoAVirgula(Form7.Label49.CAption));
  //
  ComboBox2.Items.Clear;
  ComboBox2.Items.Add('<Plano de contas para a diferena>');
  ComboBox2.ItemIndex := 0;
  //
  Form7.ibDataSet12.Close;
  Form7.ibDataSet12.SelectSQL.Clear;
  Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
  Form7.ibDataSet12.Open;
  //
  Form7.ibDataSet12.First;
  while not Form7.ibDataSet12.Eof do
  begin
    if Form7.sModulo = 'RECEBER' then
    begin
      //
      if StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) > StrToFloat(FormatFloat('0.00', fTotal)) then // Sandro Silva 2023-10-30 if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal then
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '1' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end else
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '3' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end;
      //
      Edit1.Text := 'Recebimentos';
      //
    end;
    if Form7.sModulo = 'PAGAR' then
    begin
      if StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) > StrToFloat(FormatFloat('0.00', fTotal)) then // Sandro Silva 2023-10-30 if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal then
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '3' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end else
      begin
        if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '1' then
          ComboBox2.Items.Add(Form7.ibDataSet12NOME.AsString);
      end;
      //
      Edit1.Text := 'Pagamentos';
      //
    end;
    Form7.ibDataSet12.Next;
  end;
  //
  if FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat) <> FormatFloat('0.00', fTotal) then // Sandro Silva 2023-10-30 if Form7.ibDataSet25DIFERENCA_.AsFloat <> fTotal then
  begin
    ComboBox2.Enabled := True;
  end else
  begin
    ComboBox2.Enabled := False;
  end;
  //
  if Form7.ComboBox1.CanFocus then Form7.ComboBox1.SetFocus;
  //
  //LogRetaguarda('25902'); // Sandro Silva 2023-09-13
end;

procedure TForm7.SMALL_DBEdit1Exit(Sender: TObject);
begin
  Form7.SMALL_DBEdit1.Visible := False;
  Form7.Edit2.Text        := '';
end;

procedure TForm7.SMALL_DBEdit6KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  //
  if (Key = Vk_Return) or (Key = Vk_Tab) then
  begin
    Button7Click(Sender);
  end;
  //
end;

procedure TForm7.Romaneiodecarga1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  Form7.sModulo := 'Romaneio de carga';
  Form38.ShowModal; // Ok
end;

procedure TForm7.ConsultarvalidadedaNFe1Click(Sender: TObject);
var
  sUf, sRetorno, sNota : String;
begin
  (*sUF := UpperCase(AllTrim(Form1.Small_InputForm('Consultar validade da NF-e','UF do Emitente da NF-e:',''))); // Nf de venda

  if Pos('1'+UpperCase(sUF)+'2','1AC21AL21AM21AP21BA21CE21DF21ES21GO21MA21MG21MS21MT21PA21PB21PE21PI21PR21RJ21RN21RO21RR21RS21SC21SE21SP21TO21EX212') = 0 then
  begin
    //ShowMessage('Estado invlido'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Estado invlido',msgAtencao);
    Abort;
  end;

  sNota := AllTrim(Form1.Small_InputForm('Consultar validade da NF-e','Chave de acesso da NF-e:','')); // Nf de venda

  if Length(AllTrim(LimpaNumero(sNota))) = 44 then
  begin
    Screen.Cursor            := crHourGlass;
    Form7.Panel7.Caption          := 'Consultando NF-e...'+replicate(' ',100);
    Form7.Panel7.Repaint;
    //
    ConfiguraNFE;

    Form7.spdNFe.UF       := sUF;

    try
      sRetorno := spdNFe.ConsultarNF(Alltrim(sNota));

      //ShowMessage(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9)); Mauricio Parizotto 2023-10-25
      MensagemSistema(Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9));
    except
    end;
  end else
  begin
    //ShowMessage('Chave de acesso da NF-e invlido'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Chave de acesso da NF-e invlido');
  end;

  Screen.Cursor            := crDefault;

  {$IFDEF VER150}
  DecimalSeparator := ',';
  DateSeparator    := '/';
  {$ELSE}
  FormatSettings.DecimalSeparator := ',';
  FormatSettings.DateSeparator    := '/';
  {$ENDIF}

  Form7.Panel7.Caption  := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
  Form7.Panel7.Repaint;  *)
end;

procedure TForm7.ibDataSet16BeforePost(DataSet: TDataSet);
begin
  // Sandro Silva 2023-05-18 if Form7.ibDataSet15FINNFE.AsString <> '4' then // Devolucao Devoluco
  if NFeFinalidadeDevolucao(Form7.ibDataSet15FINNFE.AsString) = False then // Devolucao Devoluco
  begin
    try
      if (Copy(Form7.ibDataSet14CFOP.AsString,1,4) = '5101') or (Copy(Form7.ibDataSet14CFOP.AsString,1,4) = '6101') or (Pos('IPI',Form7.ibDataSet14OBS.AsString) <> 0) then
      begin
        //
        if Form7.ibDataSet16IPI.AsFloAt <> Form7.ibDataSet4IPI.AsFloat then
        begin
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16IPI.AsFloAt := Form7.ibDataSet4IPI.AsFloat;
        end;
        //
      end else
      begin
        if Form7.ibDataSet16IPI.AsFloAt <> 0 then
        begin
          Form7.ibDataSet16.Edit;
          Form7.ibDataSet16IPI.AsFloAt := 0;
        end;
      end;
    except end;
  end;

  //
  AssinaRegistro('ITENS001',DataSet, True);
  //
end;

procedure TForm7.GerarNotaFiscalSrie12Click(Sender: TObject);
begin
  // Gera a nota fiscal
  if Form1.bNotaVendaLiberada then
  begin
    if Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString = '' then
    begin
      {Mauricio Parizotto 2023-10-16 Inicio
      //Form41.MaskEdit1.Text := Form7.ibDataSet97.FieldByname('Oramento').AsString; Mauricio Parizotto 2023-08-23
      Form41.vOrcamentImportar := Form7.ibDataSet97.FieldByname('Oramento').AsString;
      Form7.Close;
      Form7.Vendas_1Click(Sender);                        // Nota fiscal srie 001
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.Importaroramentos1Click(Sender);             // Importa OS

    end;
    }
      if Application.MessageBox(Pchar('Confirma a importao do oramento '+ibDataSet97.FieldByname('Oramento').AsString+' para a Nota Fiscal?'
                                                  + chr(10)
                                                  + Chr(10))
                                                  ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING) = IDYES then
      begin
        Form7.Close;
        Form7.Vendas_1Click(Sender);                        // Nota fiscal srie 001
        Form7.Image101Click(Sender);                        // Nova Nota
        Form7.sModulo := 'ORCAMENTO';
        ImportaOrcamento(ibDataSet97.FieldByname('Oramento').AsString,sModulo);
        Form7.sModulo := 'VENDA';

        Form7.ibDataSet16.First;
        Retributa(True);
      end;
    end else
    begin
      MensagemSistema('Este oramento j possui documento fiscal vinculado.',msgAtencao);
    end;

    {Mauricio Parizotto 2023-10-16 Fim}
  end else
  begin
    MensagemSistema('Emisso de NF no liberada para este usurio.',msgAtencao);
  end;
end;

procedure TForm7.GerarNotaFiscalSrie22Click(Sender: TObject);
begin
  // Gera a nota fiscal
  if Form1.bNotaVendaLiberada then
  begin
    if Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString = '' then
    begin
       {Mauricio Parizotto 2023-10-16 Inicio
      //Form41.MaskEdit1.Text := Form7.ibDataSet97.FieldByname('Oramento').AsString; Mauricio Parizotto 2023-08-23
      Form41.vOrcamentImportar := Form7.ibDataSet97.FieldByname('Oramento').AsString;
      Form7.Close;
      Form7.NotasfiscaisdesadavendasSrie11Click(Sender);  // Nota fiscal srie 002
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.Importaroramentos1Click(Sender);             // Importa OS
    end;
    }

      if Application.MessageBox(Pchar('Confirma a importao do oramento '+ibDataSet97.FieldByname('Oramento').AsString+' para a Nota Fiscal?'
                                                  + chr(10)
                                                  + Chr(10))
                                                  ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING) = IDYES then
      begin
        Form7.Close;
        Form7.NotasfiscaisdesadavendasSrie11Click(Sender);  // Nota fiscal srie 002
        Form7.Image101Click(Sender);                        // Nova Nota
        Form7.sModulo := 'ORCAMENTO';
        ImportaOrcamento(ibDataSet97.FieldByname('Oramento').AsString,sModulo);
        Form7.sModulo := 'VENDA';

        Form7.ibDataSet16.First;
        Retributa(True);
      end;
    end else
    begin
      MensagemSistema('Este oramento j possui documento fiscal vinculado.',msgAtencao);
    end;

    {Mauricio Parizotto 2023-10-16 Fim}
  end else
  begin
    MensagemSistema('Emisso de NF no liberada para este usurio.',msgAtencao);
  end;
end;

procedure TForm7.Relatriodeoramentospendentes2Click(Sender: TObject);
begin
  Form7.Relatriodeoramentospendentes1Click(Sender);
end;

procedure TForm7.ibDataSet27BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('ALTERACA',DataSet, True);
end;

procedure TForm7.ibDataSet37BeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibDataSet37);
end;

procedure TForm7.ibDataSet37BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('ORCAMENT',DataSet, True);
end;

procedure TForm7.VVerificaresquemashema1Click(Sender: TObject);
{Sandro Silva 2022-09-29 inicio 
var
  DOMDocument : IXMLDOMDocument3;
  ParseError  : IXMLDOMParseError;
  Schema      : XMLSchemaCache;
  sErro, sMErro, sVersaoManual : String;
  rcpNFExml   : tStringList;
  DOMDocumentNFe: IXMLDOMDocument;
  xNodeNFe: IXMLDOMNodeList;
}
begin
  //
  Screen.Cursor := crHourGlass;
  //
  // Protocolo
  //
  (*{Sandro Silva 2022-09-29 inicio}
  if PermiteValidarSchema(Form7.ibDataSet15) then // Ficha 6275 Sandro Silva 2022-09-28 if Pos('Falha no Schema',Form7.ibDataSet15STATUS.AsString)<> 0 then
  begin
    //
    // Validar Shema
    //
    try
      //
      DOMDocument := CoDOMDocument50.Create;
      //
      DOMdocument.Async := False;
      DOMdocument.ResolveExternals := False;
      DOMdocument.ValidateOnParse  := True;
      //
      // Carrega s uma parte do XML
      //
      XMLDocument1.Active := false;
      XMLDocument1.XML.Text := Form7.IbDAtaSet15NFEXML.AsString;
      XMLDocument1.Active := True;
      rcpNFExml := TStringList.Create;
      // Sandro Silva 2022-09-28 rcpNFExml.Text := XMLDocument1.ChildNodes['NFe'].XML;
      DOMDocumentNFe := CoDOMDocument.Create; // Precisa ser criado com est herana para no ocorrer erro na linha DOMDocumentNFe.selectNodes('//NFe');
      DOMDocumentNFe.loadXML(Form7.IbDAtaSet15NFEXML.AsString);

      xNodeNFe := DOMDocumentNFe.selectNodes('//NFe');
      if xNodeNFe.length > 0 then
      begin
        rcpNFExml.Text := xNodeNFe.item[0].xml;

        DOMdocument.LoadXML(rcpNFExml.Text); //XML COM ERRO
        rcpNFExml.Free;
        //
        Schema := CoXMLSchemaCache50.Create;
        //
        // Verso 2.0 da NFE 4.0 do manual
        //
        {Sandro Silva 2022-09-28 inicio
        spdNFe.VersaoManual := vm50a;
        sVersaoManual := 'vm50a\nfe_v2.00.xsd';
        }
        spdNFe.VersaoManual := vm60;
        sVersaoManual := 'vm60\nfe_v4.00.xsd';
        {Sandro Silva 2022-09-28 fim}
        //
        Schema.add('http://www.portalfiscal.inf.br/nfe', Form1.sAtual+'\Nfe\Esquemas\'+sVersaoManual);
        //
        DOMdocument.Schemas := Schema;
        ParseError          := DOMdocument.validate;
        sErro := '';
        sMErro := '';
        sErro := ParseError.reason; /// retorno da validao
      end;
      DOMDocument         := Nil;
      ParseError          := Nil;
      Schema              := Nil;
      DOMDocumentNFe      := nil;
      xNodeNFe            := nil;
      //
      // Fim valida schema
      //
    except
    end;
  end;
  //
  Screen.Cursor := crDefault;
  try
    if sErro <> '' then
      ShowMessage('Mensagem de erro retornada: '+chr(10)+chr(10)+strTran(sErro,'{http://www.portalfiscal.inf.br/nfe}',''))
  except
  end;
  //
  *)
  if PermiteValidarSchema(Form7.ibDataSet15) then // Ficha 6275 Sandro Silva 2022-09-28 if Pos('Falha no Schema',Form7.ibDataSet15STATUS.AsString)<> 0 then
    VerificarShemaXsd(Form7.ibDataSet15NFEXML.AsString, True); 
  {Sandro Silva 2022-09-29 fim}
end;

procedure TForm7.Importarretornodevendaambulante1Click(Sender: TObject);
begin
  // ImportaNF(False,'');
end;

procedure TForm7.ibDataSet24BeforeEdit(DataSet: TDataSet);
begin
  sFornecedorAntigo := Form7.IbDataSet24FORNECEDOR.AsString;
end;

procedure TForm7.ibDataSet4MEDIDASetText(Sender: TField;
  const Text: String);
begin
  if ibDataSet4MEDIDA.AsString <> '' then
  begin
    Form7.IBDataSet49.Close;
    Form7.IBDataSet49.SelectSQL.Clear;
    Form7.IBDataSet49.SelectSQL.Add('select * from MEDIDA order by SIGLA'); // Medida
    Form7.IBDataSet49.Open;
    
    ibDataSet49.Locate('SIGLA',AllTrim(Text),[loCaseInsensitive, loPartialKey]);

    if AllTrim(Text) = '' then ibDataSet4MEDIDA.AsString := Text else
      if Pos(AnsiUpperCase(AllTrim(Text)),AnsiUpperCase(ibDataSet49.FieldByname('SIGLA').AsString)) <> 0 then ibDataSet4MEDIDA.AsString := ibDataSet49.FieldByname('SIGLA').AsString
    else
      //ShowMessage('Unidade de medida invlida.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Unidade de medida invlida.',msgAtencao);
  end else
    ibDataSet4MEDIDA.AsString := Text;
end;

procedure TForm7.RRecuperaroXMLdestaNFe1Click(Sender: TObject);
begin
  try
    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      Form7.ibDataSet15.Edit;
      Form7.ibDataSet15NFEXML.AsString := LoadXmlDestinatarioSaida(Form7.ibDataSet15NFEID.AsString);
      Form7.ibDataSet15.Post;
    end;

    if Pos('<nfeProc',Form7.ibDataSet15NFEXML.AsString) = 0 then
    begin
      RecuperaXML(True);
    end;
  except end;
end;

procedure TForm7.ExportarNFesfiltradasemarquivoXML1Click(Sender: TObject);
var
  sDirectory : string;
begin
  SelectDirectory('Select folder', '', sDirectory);
  if AllTrim(sDirectory) <> ''  then
  begin
    Form7.ibDataSet15.First;
    while not Form7.ibDataSet15.Eof do
    begin
      DistribuicaoNFe2(sDirectory);
      Form7.ibDataSet15.Next;
    end;
  end;
end;

procedure TForm7.ibDataSet23ICMChange(Sender: TField);
begin
  if Sender.AsFloat >= 100 then Sender.AsFloat := 0;
end;

procedure TForm7.Imprimirrecibo2Click(Sender: TObject);
begin
  Form7.Button6Click(Sender);
end;

procedure TForm7.Imprimirrecibo3Click(Sender: TObject);
begin
  Form7.Button6Click(Sender);
end;

procedure TForm7.ibDataSet4LIVRE4Validate(Sender: TField);
begin
  if Copy(Sender.Text,1,5)='<pIVA' then
  begin
    //ShowMessage('Use o campo especfico IVA'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Use o campo especfico IVA');
  end;
end;

procedure TForm7.imgImprimirClick(Sender: TObject);
var
  Mais1Ini: TIniFile;
begin
  Form39.Height := 80;
  Form9.Show;
  Form14.Caption := 'Assistente de relatrios';
  Form14.Show;

  {Mauricio Parizotto 2023-05-24 Inicio}
  Form39.CheckBox1.Visible := False;
  Form39.CheckBox2.Visible := False;
  Form39.CheckBox3.Visible := False;
  Form39.CheckBox4.Visible := False;
  Form39.CheckBox5.Visible := False;
  Form39.CheckBox6.Visible := False;
  Form39.CheckBox7.Visible := False;
  Form39.CheckBox8.Visible := False;
  {Mauricio Parizotto 2023-05-24 Fim}

  if Form7.sModulo = 'ESTOQUE' then
  begin
    { L as configuraes no .INF }
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    { -- Mais1Ini.WriteString(Mais.sEscolhido,'L'+alltrim(IntToStr(I)), -- }
    Form39.CheckBox4.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo1','7'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00') +'%';
    Form39.CheckBox5.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo2','14'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00') +'%';
    Form39.CheckBox6.Caption := 'Preo '+AllTrim(Mais1Ini.ReadString('Nota Fiscal','Intervalo3','21'))+' dias ' + Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00') +'%';

    Form39.Label1.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo1','0,00');
    Form39.Label2.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo2','0,00');
    Form39.Label3.Caption := Mais1Ini.ReadString('Lista de preos','Intervalo3','0,00');

    Form39.CheckBox1.Visible := True;
    Form39.CheckBox2.Visible := True;
    Form39.CheckBox3.Visible := True;
    //Form39.CheckBox4.Visible := False;
    //Form39.CheckBox5.Visible := False;
    //Form39.CheckBox6.Visible := False;
    Form39.Height := 80;

    Form39.Show;
  end;

  if Form7.sModulo = 'CLIENTES' then
  begin
    if not (Form1.iReduzida = 1) then
    begin
      Form39.CheckBox4.Caption := 'Recebido       ';
      Form39.CheckBox5.Caption := 'A receber      ';
      Form39.CheckBox6.Caption := 'Atrasado       ';

      Form39.Label1.Caption := '';
      Form39.Label2.Caption := '';
      Form39.Label3.Caption := '';

      //Form39.CheckBox1.Visible := False;
      //Form39.CheckBox2.Visible := False;
      //Form39.CheckBox3.Visible := False;
      Form39.CheckBox4.Visible := True;
      Form39.CheckBox5.Visible := True;
      Form39.CheckBox6.Visible := True;

      Form39.Show;
    end;
  end;

  if Form7.sModulo = 'FORNECED' then
  begin
    Form39.CheckBox4.Caption := 'Pago           ';
    Form39.CheckBox5.Caption := 'A pagar        ';
    Form39.CheckBox6.Caption := 'Atrasado       ';

    Form39.Label1.Caption := '';
    Form39.Label2.Caption := '';
    Form39.Label3.Caption := '';

    //Form39.CheckBox1.Visible := False;
    //Form39.CheckBox2.Visible := False;
    //Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;

    Form39.Show;
  end;

  if Form7.sModulo = 'RECEBER' then
  begin
    Form39.CheckBox4.Caption := 'Endereo       ';
    Form39.CheckBox5.Caption := 'Cidade         ';
    Form39.CheckBox6.Caption := 'Telefone       ';
    Form39.CheckBox7.Caption := 'Contato        ';
    Form39.CheckBox8.Caption := 'WhatsApp       ';

    Form39.Label1.Caption := '';
    Form39.Label2.Caption := '';
    Form39.Label3.Caption := '';

    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    Form39.CheckBox7.Visible := True;
    Form39.CheckBox8.Visible := True;
    Form39.Height := 115;
    Form39.Show;
  end;

  Form14.Button1.SetFocus;
end;

procedure TForm7.ibDataSet27BeforeDelete(DataSet: TDataSet);
begin
  ibDataSet99.Close;
  ibDataSet99.SelectSql.Clear;
  ibDataset99.SelectSql.Add('select gen_id(G_HASH_ALTERACA,-1) from rdb$database');
  ibDataset99.Open;
end;

procedure TForm7.Button6Click(Sender: TObject);
begin
  if Form7.ibDataSet7.FieldByName('VALOR_RECE').AsFloat <> 0 then
  begin
    Form7.fTotalDoRecibo := Form7.ibDataSet7.FieldByName('VALOR_RECE').AsFloat;
    Form7.sReciboProvenienteDe := 'Proveniente: dp. ' + Form7.ibDataSet7.FieldByName('DOCUMENTO').AsString + ', Referente ' + AllTrim(Form7.ibDataSet7.FieldByName('HISTORICO').AsString);
    Form7.sReciboRecebemosDe   := Form7.ibDataSet7.FieldByName('NOME').AsString;
  end else
  begin
    Form7.fTotalDoRecibo       := 0;
    Form7.sReciboProvenienteDe := '';
    Form7.sReciboRecebemosDe   := '';
  end;

  if Form7.fTotalDoRecibo<>0 then Form7.RECIBOClick(Sender) else
    //ShowMessage('No  possvel imprimir o recibo. Valor recebido igual a zero.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('No  possvel imprimir o recibo. Valor recebido igual a zero.',msgAtencao);
end;

procedure TForm7.Button7Click(Sender: TObject);
var
  ftotal : Real;
  iRecno: Integer; // Sandro Silva 2023-08-30
begin
  Form7.Edit2.SetFocus;
  //
  {Sandro Silva 2023-10-30 inicio
  CalculaTotalRecebido(True);
  fTotal := StrToFloat(LimpaNumeroDeixandoAVirgula(Form7.Label49.Caption));
  }

  fTotal := StrToFloat(FormatFloat('0.00', CalculaTotalRecebido(True)));
  {Sandro Silva 2023-10-30 fim}
  //
  if Form7.sModulo = 'PAGAR' then
  begin
    if FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat) = '0,00' then // Sandro Silva 2023-10-30 if Form7.ibDataSet25DIFERENCA_.AsFloat = 0 then
    begin
      Form7.SMALL_DBEdit6.Visible := True;
      //ShowMessage('Informe o total pago.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Informe o total pago.',msgAtencao);
      Form7.SMALL_DBEdit6.SetFocus;
      Abort;
    end else
    begin
      if AllTrim(ComboBox1.Text) = '' then
        ComboBox1.Text := _cRecebPagto;

      if (FormatFloat('0.00', fTotal) <> FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) and ( FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat) <> '0,00' ) then // Sandro Silva 2023-10-30 if (fTotal <> Form7.ibDataSet25DIFERENCA_.AsFloat) and ( Form7.ibDataSet25DIFERENCA_.AsFloat <> 0 ) then
      begin
        if ComboBox2.Text = '<Plano de contas para a diferena>' then
        begin
          //ShowMessage('Informe o <Plano de contas para a diferena>.'); Mauricio Parizotto 2023-10-25
          MensagemSistema('Informe o <Plano de contas para a diferena>.');
          Form7.ComboBox2.SetFocus;
          Abort;
        end;

        Form7.ibDataSet1.Append;

        Form7.ibDataSet1HISTORICO.AsString     := 'Diferena';
        Form7.ibDataSet1NOME.AsString          := ComboBox2.Text;

        Form7.ibDataSet1DATA.AsDateTime        := Date;
        {Sandro Silva 2023-10-30 inicio
        if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal
         then Form7.ibDataSet1SAIDA.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat - fTotal
           else Form7.ibDataSet1ENTRADA.AsFloat := fTotal - Form7.ibDataSet25DIFERENCA_.AsFloat;
        }
        if StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) > StrToFloat(FormatFloat('0.00', fTotal)) then // Sandro Silva 2023-10-30 if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal then
          Form7.ibDataSet1SAIDA.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) - StrToFloat(FormatFloat('0.00', fTotal))
        else
          Form7.ibDataSet1ENTRADA.AsFloat := StrToFloat(FormatFloat('0.00', fTotal)) - StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat));
        {Sandro Silva 2023-10-30 fim}

        Form7.ibDataSet1.Post;
      end;

      if (Copy(ComboBox1.Text,1,9) <> _cRecebPagto) and (FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat) <> '0,00') then // Sandro Silva 2023-10-30 if (Copy(ComboBox1.Text,1,9) <> _cRecebPagto) and (Form7.ibDataSet25DIFERENCA_.AsFloat <> 0) then
      begin
        Form7.ibDataSet1.Append;
        Form7.ibDataSet1HISTORICO.AsString     := Edit1.Text;
        Form7.ibDataSet1NOME.AsString          := ComboBox1.Text;
        Form7.ibDataSet1DATA.AsDateTime        := Date; // A pedido da center
        Form7.ibDataSet1ENTRADA.AsFloat        := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat));// Sandro Silva 2023-10-30 Form7.ibDataSet1ENTRADA.AsFloat        := Form7.ibDataSet25DIFERENCA_.AsFloat;
        //
        // Este procedimento  para mudar a ordem do registro
        // para o caixa no ficar negativo
        Form7.ibDataSet1.Post;
      end;

      // Cancela todas as contas marcadas para receber
      Form7.ibQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update PAGAR set ATIVO = ATIVO-5 where ATIVO >= 5');
      Form7.IBQuery1.Open;
      //
      Form7.ibDataSet25.Edit;
      Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
      Form7.ibDataSet25.Post;
      Form7.ibDataSet25.Edit;
      //
      Form7.Close;
      Form7.Show;
      Form7.DBGrid1.SetFocus;
    end;
  end else
  begin

    iRecno := Form7.DBGrid1.DataSource.DataSet.RecNo;// Sandro Silva 2023-08-30

    if Form7.ibDataSet25DIFERENCA_.AsFloat = 0 then
    begin
      Form7.SMALL_DBEdit6.Visible := True;
      //ShowMessage('Informe o total recebido.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Informe o total recebido.');
      Form7.SMALL_DBEdit6.SetFocus;
      Abort;
    end else
    begin
      if AllTrim(ComboBox1.Text) = '' then ComboBox1.Text := _cRecebPagto;

      if (StrToFloat(FormatFloat('0.00', fTotal)) <> StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat))) and ( StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) <> 0 ) then // Sandro Silva 2023-10-30 if (fTotal <> Form7.ibDataSet25DIFERENCA_.AsFloat) and ( Form7.ibDataSet25DIFERENCA_.AsFloat <> 0 ) then
      begin
        if ComboBox2.Text = '<Plano de contas para a diferena>' then
        begin
          //ShowMessage('Informe o <Plano de contas para a diferena>.'); Mauricio Parizotto 2023-10-25
          MensagemSistema('Informe o <Plano de contas para a diferena>.');
          Form7.ComboBox2.SetFocus;
          Abort;
        end;

        Form7.ibDataSet1.Append;

        Form7.ibDataSet1HISTORICO.AsString     := 'Diferena';
        Form7.ibDataSet1NOME.AsString          := ComboBox2.Text;

        Form7.ibDataSet1DATA.AsDateTime        := Date;
        {Sandro Silva 2023-10-30 inicio
        if Form7.ibDataSet25DIFERENCA_.AsFloat > fTotal
         then Form7.ibDataSet1ENTRADA.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat - fTotal
           else Form7.ibDataSet1SAIDA.AsFloat := fTotal - Form7.ibDataSet25DIFERENCA_.AsFloat;
        }
        if StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) > StrToFloat(FormatFloat('0.00', fTotal)) then
          Form7.ibDataSet1ENTRADA.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) - StrToFloat(FormatFloat('0.00', fTotal))
        else
          Form7.ibDataSet1SAIDA.AsFloat := StrToFloat(FormatFloat('0.00', fTotal)) - StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat));
        {Sandro Silva 2023-10-30 fim}
        //
        Form7.ibDataSet1.Post;
      end;

      if (Copy(ComboBox1.Text,1,9) <> _cRecebPagto) and (StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)) <> 0) then // Sandro Silva 2023-10-30 if (Copy(ComboBox1.Text,1,9) <> _cRecebPagto) and (Form7.ibDataSet25DIFERENCA_.AsFloat <> 0) then
      begin
        Form7.ibDataSet1.Append;
        Form7.ibDataSet1HISTORICO.AsString     := Edit1.Text;
        Form7.ibDataSet1NOME.AsString          := ComboBox1.Text;
        Form7.ibDataSet1DATA.AsDateTime      := Date; // A pedido da center
        Form7.ibDataSet1SAIDA.AsFloat        := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)); // Sandro Silva 2023-10-30 Form7.ibDataSet1SAIDA.AsFloat        := Form7.ibDataSet25DIFERENCA_.AsFloat;
        Form7.ibDataSet1.Post;
      end;
      // Cancela todas as contas marcadas para receber
      Form7.ibQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update RECEBER set ATIVO = ATIVO-5 where ATIVO >= 5');
      Form7.IBQuery1.Open;

      Form7.ibDataSet25.Edit;
      Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
      Form7.ibDataSet25.Post;
      Form7.ibDataSet25.Edit;
     
      Form7.Close;
      //LogRetaguarda('26640'); // Sandro Silva 2023-09-13
      Form7.Show;
      //LogRetaguarda('26642'); // Sandro Silva 2023-09-13

      {Sandro Silva 2023-08-30 inicio}
      // f-7283 Pode ser que isso deixe lento nos casos onde h muitas contas pendentes e o usurio quite uma das ltimas contas da lista
      // Form7.Show posiciona no primeiro registro. Vai percorrer todos at chegar na conta seguinta daquela quitada
      try
        Form7.DBGrid1.DataSource.DataSet.DisableControls;
        if Form7.DBGrid1.DataSource.DataSet.RecordCount >= iRecno then
        begin
          Form7.DBGrid1.DataSource.DataSet.RecNo := iRecno;
        end;

      except
      end;
      Form7.DBGrid1.DataSource.DataSet.EnableControls;
      {Sandro Silva 2023-08-30 fim}
      //LogRetaguarda('26658'); // Sandro Silva 2023-09-13

      Form7.DBGrid1.SetFocus;

      //LogRetaguarda('26662'); // Sandro Silva 2023-09-13      
    end;
  end;
end;

procedure TForm7.Button8Click(Sender: TObject);
begin
  //
  //
  //
  if Form7.sModulo = 'PAGAR' then
  begin
    //
    // Cancela todas as contas marcadas para pagar
    //
    Form7.ibDataSet8.DisableControls;
    //
    Form7.ibDataSet8.Close;
    Form7.ibDataSet8.SelectSQL.Clear;
    Form7.ibDataSet8.SelectSQL.Add('select * from PAGAR where ATIVO >=5');
    Form7.ibDataSet8.Open;
    //
    Form7.ibDataSet8.First;
    //
    while not Form7.ibDataSet8.Eof do
    begin
      //
      if Form7.ibDataSet8ATIVO.AsFloat >= 5 then
      begin
        Form7.ibDataSet8.Edit;
        Form7.ibDataSet8VALOR_PAGO.AsFloat := 0;
        Form7.ibDataSet8.Post;
      end;
      //
      Form7.ibDataSet8.Next;
      //
    end;
    //
    Label49.CAption := 'R$ 0,00';
    //
    Form7.ibQuery1.Close;
    Form7.IBQuery1.SQL.Clear;
    Form7.IBQuery1.SQL.Add('update PAGAR set ATIVO = ATIVO-5 where ATIVO >= 5');
    Form7.IBQuery1.Open;
    //
  end else
  begin
    //
    // Cancela todas as contas marcadas para receber
    //
    Form7.ibDataSet7.DisableControls;
    //
    Form7.ibDataSet7.Close;
    Form7.ibDataSet7.SelectSQL.Clear;
    Form7.ibDataSet7.SelectSQL.Add('select * from RECEBER where ATIVO >=5');
    Form7.ibDataSet7.Open;
    //
    Form7.ibDataSet7.First;
    //
    while not Form7.ibDataSet7.Eof do
    begin
      //
      if Form7.ibDataSet7ATIVO.AsFloat >= 5 then
      begin
        Form7.ibDataSet7.Edit;
        Form7.ibDataSet7VALOR_RECE.AsFloat := 0;
        Form7.ibDataSet7.Post;
      end;
      //
      Form7.ibDataSet7.Next;
      //
    end;
    //
    Label49.CAption := 'R$ 0,00';
    //
    Form7.ibQuery1.Close;
    Form7.IBQuery1.SQL.Clear;
    Form7.IBQuery1.SQL.Add('update RECEBER set ATIVO = ATIVO-5 where ATIVO >= 5');
    Form7.IBQuery1.Open;
    //
  end;
  //
  Form7.ibDataSet25.Edit;
  Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
  Form7.ibDataSet25.Post;
  Form7.ibDataSet25.Edit;
  //
  Form7.Close;
  Form7.Show;
  Form7.DBGrid1.SetFocus;
  //

end;

procedure TForm7.RelatriodeIPI1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de IPI';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.RelatriodePISCOFINS1Click(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  //
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de PIS/COFINS (NF-e)';
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.Cardpio1Click(Sender: TObject);
begin
  if Form7.sModulo = 'ESTOQUE' then
  begin
    Form7.Caption := 'Cardpio';

    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    Form39.CheckBox7.Visible := False;
    Form39.CheckBox8.Visible := False;

    Form39.Height := 80;
  end;

  Form9.Show;
  Form14.Caption := 'Assistente para cardpio';
  Form14.Show;
end;

procedure TForm7.Livrodereceitas1Click(Sender: TObject);
begin
  if Form7.sModulo = 'ESTOQUE' then
  begin
    Form7.Caption := 'Receitas';

    Form39.CheckBox1.Visible := False;
    Form39.CheckBox2.Visible := False;
    Form39.CheckBox3.Visible := False;
    Form39.CheckBox4.Visible := True;
    Form39.CheckBox5.Visible := True;
    Form39.CheckBox6.Visible := True;
    Form39.CheckBox7.Visible := False;
    Form39.CheckBox8.Visible := False;

    Form39.Height := 80;
  end;

  Form9.Show;

  if Form7.Livrodereceitas1.Caption = 'Relatrio de composio' then
  begin
    Form14.Caption := 'Relatrio de composio';
  end else
  begin
    Form14.Caption := 'Livro de receitas';
  end;
  
  Form14.Show;
end;

procedure TForm7.ibDataSet4ALIQ_PIS_ENTRADAChange(Sender: TField);
var
  I : Integer;
begin
  {Dailon Parisotto 2023-10-09 Inicio}
  if FbDuplicandoProd then
    Exit;
  {Dailon Parisotto 2023-10-09 fim}
  
  //Mauricio Parizotto 2023-09-18
  if Form7.StatusTrocaPerfil = 'PR' then
    Exit;

  I := Application.MessageBox(Pchar('Atribuir o novo valor para todas as compras deste produto?'+ Chr(10)
                    + Chr(10))
                    ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING);

  if I = IDYES then
  begin
    begin
      try
        Screen.Cursor            := crHourGlass;
        Form7.IBQuery99.Close;
        Form7.IBQuery99.SQL.Clear;
        Form7.IBQuery99.SQL.Add('update ITENS002 set ALIQ_PIS='+QuotedStr(StrTran(Form7.ibDataSet4ALIQ_PIS_ENTRADA.AsString,',','.'))+', ALIQ_COFINS='+QuotedStr(StrTran(Form7.ibDataSet4ALIQ_COFINS_ENTRADA.AsString,',','.'))+', CST_PIS_COFINS='+QuotedStr(Form7.ibDataSet4CST_PIS_COFINS_ENTRADA.AsString)+' where DESCRICAO='+QuotedStr(Form7.ibDataSet4DESCRICAO.AsString)+' ');
        Form7.IBQuery99.Open;
      except

      end;

      Screen.Cursor            := crDefault;
    end;
  end;

  VerificaAlteracaoPerfil;//Mauricio Parizotto 2023-09-18
end;

procedure TForm7.SPEDPISCOFINS1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\spedpiscofins.exe') then
    ShellExecute( 0, 'Open', 'spedpiscofins.exe', '', '', SW_SHOW)
  else
    //ShowMessage('O executvel spedpiscofins.exe no foi encontrado na pasta de instalao do programa.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('O executvel spedpiscofins.exe no foi encontrado na pasta de instalao do programa.',msgAtencao);
end;

procedure TForm7.WebBrowser1DocumentComplete(ASender: TObject;
  const pDisp: IDispatch; const URL: OleVariant);
begin
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
end;

procedure TForm7.WebBrowser1DownloadComplete(Sender: TObject);
begin
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
end;

procedure TForm7.WebBrowser1NavigateComplete2(ASender: TObject;
  const pDisp: IDispatch; const URL: OleVariant);
begin
  Screen.Cursor             := crDefault;              // Cursor de Aguardo
end;

procedure TForm7.CCartadeCorreoEletronicaCCe1Click(Sender: TObject);
var
  sCartaCorrecao, sRetorno, sMotivo, sIDLote : String;
  vXMLProt: TXMLDocument;
begin
  try
    if Alltrim(Form7.ibDataSet15NFEPROTOCOLO.AsString) <> '' then
    begin
      Screen.Cursor            := crHourGlass;
      Form7.Panel7.Caption          := 'Carta de correo de NF-e...'+replicate(' ',100);
      Form7.Panel7.Repaint;

      vXMLProt        := TXMLDocument.Create(Form7.XMLDocument1);

      ConfiguraNFE;

      try
        Form36.Top := Form7.Top;
        Form36.Left := Form7.Left;
        Form36.Width  := Form7.Width;
        Form36.Height  := Form7.Height;

        Form36.Label1.Caption := chr(10)+
        'Para enviar uma carta de correo para a NF-e: '+Form7.ibDataSet15NUMERONF.AsString+' insira um texto livre (min. 30 caracteres).'+chr(10)+
        chr(10)+
        'O Ajuste SINIEF 01/07 veda a correo das seguintes informaes relacionadas com o Fato Gerador do ICMS da NF-e:'+chr(10)+chr(10)+
        'I - as variveis que determinam o valor do imposto tais como: base de clculo, alquota, diferena de preo, quantidade, valor da operao ou da prestao;'+chr(10)+
        'II - a correo de dados cadastrais que implique mudana do remetente ou do destinatrio;'+chr(10)+
        'III - a data de emisso ou de sada.'+chr(10)+
        chr(10)+
        'Uma NF-e pode ter at 20 cartas de correo e a ltima carta substitui as anteriores, assim o emissor deve consolidar o texto na nova carta de correo.'+chr(10)+
        chr(10)+
        'O texto da correo  um texto livre com tamanho limitado a 1000 caracteres e inexiste modelo ou padro do texto, assim o emissor deve descrever de'+chr(10)+
        'forma clara e objetiva a correo que deve ser considerada.';

        Form36.ShowModal;
        sCartaCorrecao := ConverteCaracterEspecialXML(Form36.Memo1.Text);

        if Length(sCartaCorrecao) >= 30 then
        begin

          Screen.Cursor            := crHourGlass;

          Form7.ibDataset99.Close;
          Form7.ibDataset99.SelectSql.Clear;
          Form7.ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
          Form7.ibDataset99.Open;

          Form7.ibDataSet15.Edit;
          Form7.ibDataSet15ICCE.AsInteger := Form7.ibDataSet15ICCE.AsInteger + 1;
          Form7.ibDataSet15.Post;

          sIDLote := ibDataSet15.FieldByname('NUMERONF').AsString;

          sCartaCorrecao := StringReplace (sCartaCorrecao, #13#10, ' ', [rfReplaceAll]);
          sRetorno := spdNFe.EnviarCCe(Alltrim(Form7.ibDataSet15NFEID.AsString),AllTrim(sCartaCorrecao),FormatDateTime('yyyy-mm-dd"T"hh:nn:"00"',Now),Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,2),sIDLote,Form7.ibDataSet15ICCE.AsInteger,Form7.sFuso);
          sleep(3000);

          if FileExists( pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.xml')) then
          begin
            Form7.ibDataSet2.Close;
            Form7.ibDataSet2.Selectsql.Clear;
            Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
            Form7.ibDataSet2.Open;

            vXMLProt.LoadFromFile(pChar(Form1.sAtual + '\XmlDestinatario\'+Alltrim(Form7.ibDataSet15NFEID.AsString)+'-CCe.xml'));

            Form7.ibDataSet15.Edit;
            Form7.ibDataSet15CCEXML.AsString := vXMLProt.XML.Text;
            Form7.ibDataSet15.Post;

            EnviarEmailCCe(vXMLProt.XML.Text);

            sRetorno := 'Carta de correo Eletrnica (Cc-e) vinculada a NF-e.';

            //ShowMessage(sRetorno); Mauricio Parizotto 2023-10-25
            MensagemSistema(sRetorno);
          end else
          begin
            sMotivo :=  Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
            sRetorno := StrTran(sRetorno,'<xMotivo>'+sMotivo+'</xMotivo>','');

            if Pos('<xMotivo>',sRetorno) <> 0 then
            begin
              sMotivo := Copy(sRetorno+'   ',Pos('<xMotivo>',sRetorno)+9,Pos('</xMotivo>',sRetorno)-Pos('<xMotivo>',sRetorno)-9);
            end;

            //ShowMessage(sMotivo); Mauricio Parizotto 2023-10-25
            MensagemSistema(sMotivo);

            sRetorno := 'Erro ao gerar Cc-e para NF-e '+Form7.ibDataSet15NUMERONF.AsString;
          end;
        end else
        begin
          if AllTrim(sCartaCorrecao) <> '' then
          begin
            //ShowMessage('O texto livre da Carta de Correo Eletrnica (Cc-e) tem que ter no minimo 30 caracteres.'); Mauricio Parizotto 2023-10-25
            MensagemSistema('O texto livre da Carta de Correo Eletrnica (Cc-e) tem que ter no minimo 30 caracteres.',msgAtencao);
          end;
        end;
      except
      end;
    end;
  except
  end;

  {$IFDEF VER150}
  DecimalSeparator := ',';
  DateSeparator    := '/';
  {$ELSE}
  FormatSettings.DecimalSeparator := ',';
  FormatSettings.DateSeparator    := '/';
  {$ENDIF}

  Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
  Form7.Panel7.Repaint;
  Screen.Cursor            := crDefault;

  Form7.Close;
  Form7.Show;

end;

procedure TForm7.IBDataSet128BeforeInsert(DataSet: TDataSet);
begin
  //
  try
    //
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_PAGAMENT,1) from rdb$database');
    ibDataset99.Open;
    sProximo := StrZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
    //
    try
      ibDataSet99.Close;
      ibDataSet99.SelectSql.Clear;
      ibDataset99.SelectSql.Add('select gen_id(G_HASH_PAGAMENT,1) from rdb$database');
      ibDataset99.Open;
    except end;
    //
  except end;
  //
end;

procedure TForm7.IBDataSet128BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('PAGAMENT', DataSet, True);
end;

procedure TForm7.IBDataSet128NewRecord(DataSet: TDataSet);
begin
  ibDataSet128.FieldByName('REGISTRO').AsString := sProximo;
end;

procedure TForm7.Exibir1Click(Sender: TObject);
var
  I, J : Integer;
  bI : Boolean;
  NewItem: TMenuItem;
begin
  if ibDataSet2ATIVO.AsString='1' then
    Ativo2.Checked := False
  else
    Ativo2.Checked := True;

  Mostrartodososclientesefornecedores1.OnClick := EscolheOclifor;
  //
  for I := 0 to Form10.ComboBox8.Items.Count -1 do
  begin
    if Form10.ComboBox8.Items[I] = Form7.ArquivoAberto.FieldByName('CLIFOR').AsString then
    begin
      Form10.ComboBox8.ItemIndex := I;
    end;
  end;
  //
  for J := 0 to Form10.ComboBox8.Items.Count -1 do
  begin
    bI := True;
    //
    for I := 0 to Exibir1.Count -1 do
      if Exibir1.Items[I].Caption = 'S '+Form10.ComboBox8.Items[J] then
        bI := False;
    
    if bI then
    begin
      if AllTrim(Form10.ComboBox8.Items[J]) <> '' then
      begin
        NewItem         := TMenuItem.Create(Exibir1);
        NewItem.Caption := 'S '+Form10.ComboBox8.Items[J];
        Exibir1.Add(NewItem);
        NewItem.OnClick := Self.EscolheOclifor;
      end;
    end;
  end;
end;

procedure TForm7.EscolheOclifor(Sender:TObject);
var
  i: Integer;
  oMenuItem: TMenuItem;
  bNosDinamicos: Boolean;
begin
  bNosDinamicos := False;

  oMenuItem := (Sender as TMenuItem);

  sWhere := EmptyStr;

  if oMenuItem <> Mostrartodososclientesefornecedores1 then
    Form7.sWhere  := 'where CLIFOR='+QuotedStr( Copy(oMenuItem.Caption,4,Length(oMenuItem.Caption)-2))+ ' ';

//  oMenuItem.Checked := True;
  for I := 0 to Pred(Exibir1.Count) do
  begin
    if not bNosDinamicos then
    begin
      bNosDinamicos := (Exibir1.Items[I].Caption = '-');
      Continue;
    end;

//    if (bNosDinamicos) and (Exibir1.Items[I].Caption <> oMenuItem.Caption) then
//      Exibir1.Items[I].Checked := False;
  end;

  Form7.Close;
  Form7.Show;
end;

 procedure TForm7.ibDataSet4PROMOINISetText(Sender: TField;
  const Text: String);
begin
  { ------------------------------------------------------------------ }
  { Cuidado: Esta rotina est associada a todos os campos do tipo data }
  { ------------------------------------------------------------------ }
  if Text = '  /  /    ' then
  begin
    Sender.AsString := '';
  end else
  begin
    try
      if (StrToDate(Text) <= (Date-(360*90))) or (StrToDate(Text) >= (Date+(360*90))) then
      begin
        if Application.MessageBox(Pchar('Esta data no parece ser a correta. Voc confirma '+text+ Chr(10) +
                                        'como a data vlida?' + Chr(10))
                                         ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION) <> IDYES then
        begin
          Form7.bFlag := False;
        end else
        begin
          try
            Sender.AsString := Text;
          except
            begin
              Form7.bFlag := False;
              //ShowMessage('Esta data no  vlida, digite-a novamente.'); Mauricio Parizotto 2023-10-25
              MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
            end;
          end;
        end;
      end else
      begin
        try
          Sender.AsString := Text;
        except
          begin
            Form7.bFlag := False;
            //ShowMessage('Esta data no  vlida, digite-a novamente.'); Mauricio Parizotto 2023-10-25
            MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
          end;
        end;
      end;
    except
      Form7.bFlag := False;
      //ShowMessage('Esta data no  vlida, digite-a novamente.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Esta data no  vlida, digite-a novamente.',msgAtencao);
    end;
  end;
end;

procedure TForm7.Resumodainadimplncia1Click(Sender: TObject);
var
  I : Integer;
  F: TextFile;
  Mais1Ini : tInifile;
begin
  {$IFDEF VER150}
  ShortDateFormat := 'dd/mm/yyyy';
  {$ELSE}
  FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
  {$ENDIF}

  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
  Rewrite(F);                           // Abre para gravao
  Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - INADIMPLNCIA')+'</title></head>');
  WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
  WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');

  // Tabela de inadimplncia
  WriteLn(F,'<br><br>');              // Linha em branco
  WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>Resumo da inadimplncia</b></font>');
  WriteLn(F,'<center><br><br>');
  WriteLn(F,'<a href="inadimplencia_mes.png"><img src="inadimplencia_mes.png" border="0" width=200 height=200></a>');
  WriteLn(F,'<a href="inadimplencia_ano.png"><img src="inadimplencia_ano.png" border="0" width=200 height=200></a>');
  WriteLn(F,'<a href="inadimplencia_tot.png"><img src="inadimplencia_tot.png" border="0" width=200 height=200></a>');
  WriteLn(F,'</enter>');
  //
  WriteLn(F,' <table  border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=3 width=600>');
  WriteLn(F,'  <tr>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000"></th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">% de<br>inadimplncia</th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Valor em R$</th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Mdia de dias<br>em atraso</th>');
  WriteLn(F,'   <th   bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Clientes<br>em atraso</th>');
  WriteLn(F,'  </tr>');
  WriteLn(F,'  <tr>');
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">ltimos trs meses</td>');
  //
  // ltimos trs meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select cast(sum(VALOR_DUPL)as numeric(18,2))as VALOR, cast(sum(VALOR_RECE)as numeric(18,2))as RECE from RECEBER where (VENCIMENTO>=(CURRENT_DATE-90)) and VENCIMENTO<CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)])+'</td>'); // Percentual de inadimplncia
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[Form7.ibDataSet99.FieldByname('VALOR').AsFloat-Form7.ibDataSet99.FieldByname('RECE').AsFloat])+'</td>'); // Valor atrasado  //
  //                                          //
  // Grfico de fluxo de caixa inadimplencia //
  //                                        //
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_mes.gra'));
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_mes.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\inadimplencia_mes.gra');
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','0');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','AlturaBmp','200');
  Mais1Ini.WriteString('DADOS','LarguraBmp','200');
  Mais1Ini.WriteString('DADOS','Titulo','Inadimplncia');
  Mais1Ini.WriteString('DADOS','SubTitulo','Trs meses: '+AllTrim(Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]))+'%');
  Mais1Ini.WriteString('DADOS','NomeBmp','inadimplencia_mes.png');
  Mais1Ini.WriteString('DADOS','FontSize','8'); //'11577023' // '15381040'
  Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
  //
  // Acumula os valores
  //
  I := 1;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Inadimplncia>');

  I := 2;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[100-(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Adimplncia>');


  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'graficos.exe', 'inadimplencia_mes.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  while not FileExists(Form1.sAtual+'\inadimplencia_mes.png') do
    Sleep(100);
  //
  // Mdia de dias de atraso ltimos trs meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select avg(coalesce(RECEBIMENT,CURRENT_DATE)-coalesce(VENCIMENTO,CURRENT_DATE)) as DIAS from RECEBER where (VENCIMENTO>=(CURRENT_DATE-90)) and VENCIMENTO<CURRENT_DATE and coalesce(RECEBIMENT,CURRENT_DATE)<>CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('DIAS').AsFloat])+'</td>');
  //
  // Clientes em atraso  trs meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select count(distinct(NOME))as CLIENTES from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(VALOR_RECE,0)=0 and (VENCIMENTO>=(CURRENT_DATE-90)) and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'   <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('CLIENTES').AsFloat])+'</td>');
  WriteLn(F,' </tr>');
  //
  // ltimos doze meses
  //
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">ltimos doze meses</td>');
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select cast(sum(VALOR_DUPL)as numeric(18,2))as VALOR, cast(sum(VALOR_RECE)as numeric(18,2))as RECE from RECEBER where (VENCIMENTO>=(CURRENT_DATE-360)) and VENCIMENTO<CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  //                                          //
  // Grfico de fluxo de caixa inadimplencia //
  //                                        //
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_ano.gra'));
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_ano.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\inadimplencia_ano.gra');
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','0');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','AlturaBmp','200');
  Mais1Ini.WriteString('DADOS','LarguraBmp','200');
  Mais1Ini.WriteString('DADOS','Titulo','Inadimplncia');
  Mais1Ini.WriteString('DADOS','SubTitulo','Doze meses: '+AllTrim(Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]))+'%');
  Mais1Ini.WriteString('DADOS','NomeBmp','inadimplencia_ano.png');
  Mais1Ini.WriteString('DADOS','FontSize','8'); //'11577023' // '15381040'
  Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
  //
  // Acumula os valores
  //
  I := 1;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Inadimplncia>');

  I := 2;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[100-(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Adimplncia>');


  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'graficos.exe', 'inadimplencia_ano.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  while not FileExists(Form1.sAtual+'\inadimplencia_ano.png') do
    Sleep(100);
  //
  // Fim grafico
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)])+'</td>'); // Percentual de inadimplncia
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[Form7.ibDataSet99.FieldByname('VALOR').AsFloat-Form7.ibDataSet99.FieldByname('RECE').AsFloat])+'</td>'); // Valor atrasado
  //
  // Mdia de dias de atraso ltimos doze meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select avg(coalesce(RECEBIMENT,CURRENT_DATE)-coalesce(VENCIMENTO,CURRENT_DATE)) as DIAS from RECEBER where (VENCIMENTO>=(CURRENT_DATE-360)) and VENCIMENTO<CURRENT_DATE and coalesce(RECEBIMENT,CURRENT_DATE)<>CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('DIAS').AsFloat])+'</td>');
  //
  // Clientes em atraso doze meses
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select count(distinct(NOME))as CLIENTES from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(VALOR_RECE,0)=0 and (VENCIMENTO>=(CURRENT_DATE-360)) and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('CLIENTES').AsFloat])+'</td>');
  WriteLn(F,' </tr>');
  //
  // Total
  //
  WriteLn(F,' <tr>');
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Total registrado</td>');
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select  cast(sum(VALOR_DUPL)as numeric(18,2))as VALOR, cast(sum(VALOR_RECE)as numeric(18,2))as RECE  from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  //                                          //
  // Grfico de fluxo de caixa inadimplencia //
  //                                        //
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_tot.gra'));
  DeleteFile(pChar(Form1.sAtual+'\inadimplencia_tot.png'));
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\inadimplencia_tot.gra');
  Mais1Ini.WriteString('DADOS','3D','1');
  Mais1Ini.WriteString('DADOS','MarcasS1','0');
  Mais1Ini.WriteString('DADOS','Legenda','0');
  Mais1Ini.WriteString('DADOS','TipoS1','4');
  Mais1Ini.WriteString('DADOS','AlturaBmp','200');
  Mais1Ini.WriteString('DADOS','LarguraBmp','200');
  Mais1Ini.WriteString('DADOS','Titulo','Inadimplncia');
  Mais1Ini.WriteString('DADOS','SubTitulo','Total: '+AllTrim(Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]))+'%');
  Mais1Ini.WriteString('DADOS','NomeBmp','inadimplencia_tot.png');
  Mais1Ini.WriteString('DADOS','FontSize','8'); //'11577023' // '15381040'
  Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
  //
  // Acumula os valores
  //
  I := 1;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Inadimplncia>');

  I := 2;

      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),'S1<'+
      StrTran(Format('%15.2n',[100-(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)]),'.','')
        +'>S2<'+'0,00'
                        +'>VX<'+StrZero(I,2,0)+'>LX<Adimplncia>');


  Mais1Ini.Free;
  //
  ShellExecute( 0, 'Open', 'graficos.exe', 'inadimplencia_tot.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
  while not FileExists(Form1.sAtual+'\inadimplencia_tot.png') do
    Sleep(100);
  //
  // Fim grafico
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[(100-(Form7.ibDataSet99.FieldByname('RECE').AsFloat/Form7.ibDataSet99.FieldByname('VALOR').AsFloat)*100)])+'</td>'); // Percentual de inadimplncia
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%12.2n',[Form7.ibDataSet99.FieldByname('VALOR').AsFloat-Form7.ibDataSet99.FieldByname('RECE').AsFloat])+'</td>'); // Valor atrasado
  //
  // Mdia de dias de atraso TOTAL
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select avg(coalesce(RECEBIMENT,CURRENT_DATE)-coalesce(VENCIMENTO,CURRENT_DATE)) as DIAS from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(RECEBIMENT,CURRENT_DATE)<>CURRENT_DATE and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('DIAS').AsFloat])+'</td>');
  //
  // Clientes em atraso TOTAL
  //
  Form7.IBDataSet99.Close;
  Form7.IBDataSet99.SelectSQL.Clear;
  Form7.IBDataSet99.SelectSQL.Add('select count(distinct(NOME))as CLIENTES from RECEBER where VENCIMENTO<CURRENT_DATE and coalesce(VALOR_RECE,0)=0 and coalesce(ATIVO,9)<>1');
  Form7.IBDataSet99.Open;
  //
  WriteLn(F,'  <td  vAlign=Top align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+ Format('%5.0n',[Form7.ibDataSet99.FieldByname('CLIENTES').AsFloat])+'</td>');
  WriteLn(F,' </tr>');
  //
  WriteLn(F,'</table>');
  WriteLn(F,'</center>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  WriteLn(F,'<center><br><font face="verdana" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
  + Copy(DateTimeToStr(Date),7,4) +', '+ LowerCase(DiaDaSemana(Date)) + ' s ' + TimeToStr(Time)+'</font></center>');
  //
  WriteLn(F,'<br>');              // Linha em branco
  //
  // WWW
  //
  if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
  begin
    WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
  end else
  begin
    WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
  end;
  //
  if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
  WriteLn(F,'</html>');
  //
  CloseFile(F);                                    // Fecha o arquivo
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  //
end;

procedure TForm7.Manifestaododestinatrio1Click(Sender: TObject);
var
  sRetorno : String;
begin
  try
    ConfiguraNFE;

    // Cdigo do evento:
    // 210200  Confirmao da Operao
    // 210210  Cincia da Operao
    // 210220  Desconhecimento da Operao
    // 210240  Operao no Realizada
    if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)=0) then
    begin
      Manifesto(2); // 2: Cincia da operao
    end else
    begin
      if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString)=0) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)<>0) then
      begin
        if Form7.ibDataSet24MERCADORIA.Asfloat = 0 then
        begin
          sRetorno := spdNFe.ConsultarDistribuicaoDFeChave(pChar(Copy(Form7.ibDataSet24NFEID.AsString,1,2)), pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)),pChar(Form7.ibDataSet24NFEID.AsString));
          DownloadNFeEmitida(sRetorno); // Baixa o XML de uma NF-e especifica
        end;
      end;
    end;

    if Form7.ibDataSet24MERCADORIA.AsFloat = 0 then
    begin
      if Pos('<nfeProc',Form7.ibDataSet24NFEXML.AsString) <> 0 then
      begin
        if Application.MessageBox(PChar(_cDesejaDarEntradaNFManifesto), PChar(_cTituloMsg), MB_YESNO + MB_ICONQUESTION) = mrYes then
        begin
          ImportaNF(True, Form7.ibDataset24NFEXML.AsString); // Sandro Silva 2023-04-10 Form7.ImportaNF(True,Form7.ibDataset24NFEXML.AsString);
          Form7.ibDataSet23AfterPost(Form7.ibDataSet23);
        end;
      end;
    end;
    {Dailon Parisotto (f-7502) 2023-10-30 Inicio

    if Form7.ibDataSet24MERCADORIA.AsFloat <> 0 then
    begin
      Manifesto(1); // 1: Confirmao da operao.
    end;

    }
    // Se j foi confirmado antes no deve fazer novamente.
    if (Pos('<tpEvento>210200',Form7.ibDataSet24MDESTINXML.AsString) = 0) then
      Manifesto(1); // 1: Confirmao da operao.
    {Dailon Parisotto (f-7502) 2023-10-30 Fim}
  except
    on E: Exception do
    begin
      //Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
      MensagemSistema(E.Message,msgErro);
    end;
  end;

  Screen.Cursor := crDefault;
end;

procedure TForm7.ibDataSet4CFChange(Sender: TField);
begin
  //
  Form7.ibQuery3.Close;
  Form7.ibQuery3.SQL.Clear;
//  Form7.ibQuery3.SQL.Add('select * from IBPT_ where CODIGO like '+QuotedStr(Form7.ibDataSet4CF.AsString+'%'));
//
//  Form7.ibQuery3.SQL.Add('select * from IBPT_ where '+QuotedStr(Form7.ibDataSet4CF.AsString)+' like CODIGO||''%''');
//  Form7.ibQuery3.SQL.Add('select * from IBPT_ where char_length(CODIGO) >= 8 and '+QuotedStr(Form7.ibDataSet4CF.AsString)+' like CODIGO||''%''');
  Form7.ibQuery3.SQL.Add('select * from IBPT_ where char_length(CODIGO) >= 8 and CODIGO='+QuotedStr(Form7.ibDataSet4CF.AsString));
  Form7.ibQuery3.Open;
  //
  if Form7.ibDataSet4CF.AsString <> '' then
  begin
    Form7.ibDataSet4.Edit;
    //
    // INDICE DE IMPOSTO APROXIMADO - IIA - ESTADUAL
    //
    Form7.ibDataSet4IIA_UF.ReadOnly := False;
    Form7.ibDataSet4IIA_UF.AsFloat := Form7.ibQuery3.FieldByname('ESTADUAL').AsFloat;
    Form7.ibDataSet4IIA_UF.ReadOnly := True;
    //
    // INDICE DE IMPOSTO APROXIMADO - IIA - MUNICIPAL
    //
    //
    Form7.ibDataSet4IIA_MUNI.ReadOnly := False;
    Form7.ibDataSet4IIA_MUNI.AsFloat := Form7.ibQuery3.FieldByname('MUNICIPAL').AsFloat;
    Form7.ibDataSet4IIA_MUNI.ReadOnly := True;
    //
    if (Copy(Form7.ibDataSet4CST.AsString,1,1) = '1') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '2') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '6') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '7') or
       (Copy(Form7.ibDataSet4CST.AsString,1,1) = '8') then

    begin
      // 1 - Estrangeira - Importao direta, exceto a indicada no cdigo 6
      // 2 - Estrangeira - Adquirida no mercado interno, exceto a indicada no cdigo 7
      // 6 - Estrangeira - Importao direta, sem similar nacional, constante em lista de Resoluo CAMEX;
      // 7 - Estrangeira - Adquirida no mercado interno, sem similar nacional, constante em lista de Resoluo CAMEX.
      // 8 - Nacional, mercadoria ou bem com Contedo de Importao sup. a 70%
      //
      Form7.ibDataSet4IIA.ReadOnly := False;
      Form7.ibDataSet4IIA.AsFloat  := Form7.ibQuery3.FieldByname('IMPORTADOFEDERAL').AsFloat;
      Form7.ibDataSet4IIA.ReadOnly := True;
    end else
    begin
      // 0 - Nacional, exceto as indicadas nos cdigos 3 a 5
      // 3 - Nacional, mercadoria ou bem com Contedo de Importao superior a 40% (quarenta por cento)
      // 4 - Nacional, cuja produo tenha sido feita em conformidade com os processos produtivos bsicos de que tratam o Decreto-Lei n 288/1967, e as Leis ns 8.248/1991, 8.387/1991, 10.176/2001 e 11.484/2007;
      // 5 - Nacional, mercadoria ou bem com Contedo de Importao inferior ou igual a 40% (quarenta por cento)
      //
      Form7.ibDataSet4IIA.ReadOnly := False;
      Form7.ibDataSet4IIA.AsFloat  := Form7.ibQuery3.FieldByname('NACIONALFEDERAL').AsFloat;
      Form7.ibDataSet4IIA.ReadOnly := True;
    end;
    //
    Form7.ibDataSet4.Post;
    Form7.ibDataSet4.Edit;
    Form7.ibQuery3.Close;
    //
  end;

  //Mauricio Parizotto 2023-09-20
  if TField(Sender).FieldName = 'CST' then
    VerificaAlteracaoPerfil;

end;

procedure TForm7.IImprimirCartadeCorreoEletronicaCCe1Click(
  Sender: TObject);
begin
  ConfiguraNFE;

  // Recupera na tabela VENDAS o XML
  fNFE :=  Form7.ibDataSet15CCEXML.AsString;

  spdNFe.ImprimirCCe(fNFE);
end;

procedure TForm7.EtiquetasZebraArgoxElgin1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\etiquetas.exe') then
  ShellExecute( 0, 'Open', 'etiquetas.exe', '', '', SW_SHOW) else
  //ShowMessage('O executvel etiquetas.exe no foi encontrado na pasta de instalao do programa.'); Mauricio Parizotto 2023-10-25
  MensagemSistema('O executvel etiquetas.exe no foi encontrado na pasta de instalao do programa.',msgAtencao);
end;

procedure TForm7.Panel1Click(Sender: TObject);
begin
  Winexec('TASKKILL /F /IM "Small Commerce.exe"' , SW_HIDE ); Winexec('TASKKILL /F /IM small22.exe' , SW_HIDE );  Winexec('TASKKILL /F /IM nfe.exe' , SW_HIDE );
  FecharAplicacao(ExtractFileName(Application.ExeName)); // Sandro Silva 2024-01-04
end;

procedure TForm7.ImprimiraNFemformulrionumerado1Click(Sender: TObject);
begin
  try
    Unit7.ImprimeOuNaoANota(True);
  except end;
end;

procedure TForm7.ImprimirtodasasNFfiltradas1Click(Sender: TObject);
var
  I : Integer;
begin
  //
  I := Application.MessageBox(pChar(
                            chr(10) +'Quer realmente imprimir todas as Notas Fiscais filtradas?'
                            +chr(10)+
                            chr(10) +'Verifique se a impressora est ligada e com o formulrio'+Chr(10)+
                            'posicionado.'+Chr(10)+
                            chr(10)+
                            'Imprimir agora?'),
                            'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);



  if I = 6 then
  begin
    ibDataSet15.First;
    while (not ibDataSet15.Eof) do
    begin
      Application.ProcessMessages;
      Unit7.ImprimeOuNaoANota(True);
      ibDataSet15.Next;
    end;
  end;
  //
end;

procedure TForm7.Button3Click(Sender: TObject);
begin
  Form20.ShowModal;
  dbGrid1.SetFocus;
end;

procedure TForm7.Button4Click(Sender: TObject);
var
  F: TextFile;
  Mais2Ini: TIniFile;
  iPagina, I, JI : Integer;
  vLinha: array [0..200]  of String;  // Cria uma matriz com 100 elementos
begin
  //
  for I := 1 to 200  do vLinha[I] := '';
  //
  JI      := 136;
  iPagina := 66;
  //
  ibDataSet19.DisableControls;
  ibDataSet19.First;
  while not ibDataSet19.Eof do
  begin
    if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,17))) = 'CHR(27)+[C]+CHR(' then iPagina := StrToInt('0'+Limpanumero((Copy(Form7.ibDataSet19Tipo.AsString,Length(Form7.ibDataSet19TIPO.AsString)-3,3))));
    ibDataSet19.Next;
  end;
  //
  // Imprime todas as Linhas
  //
  for I := 0 to iPagina -1 do
  begin
    //
    if (I=0)
    or (I=10)
    or (I=20)
    or (I=30)
    or (I=40)
    or (I=50)
    or (I=60)
    or (I=70)
    or (I=80)
    or (I=90)
    or (I=100)
    or (I=120) then vLinha[I] := Copy('0........1.........2.........3.........4.........5.........6.........7.........8.........9.........0.........1.........2.........3.........4',1,JI) else
                      vLinha[I] := Copy(Copy(IntToStr(I)+'   ',1,3)+'      .         .         .         .         .         .         .         .         .         .         .         .         .         .',1,JI);
    ibDataSet19.First;
    //
    while not ibDataSet19.Eof do
    begin
      //
      try
        if (ibDataSet19LINHA.AsFloat = I) and ((ibDataSet19COLUNA.AsFloat <> 0)) then
        begin
          if Copy(ibDataSet19TIPO.AsString,1,2) = '@&' then
          begin
            //
            if UpperCase(AllTrim(Copy(ibDataSet19TIPO.AsString,3,Length(ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then JI := 136;
            if UpperCase(AllTrim(Copy(ibDataSet19TIPO.AsString,3,Length(ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then JI := 80;
            //
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(15)' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(15) + Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(18)' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(18) + Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[0]' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(27)+'0'+Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[1]' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(27)+'1'+Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
            if UpperCase(AllTrim(Copy(Form7.ibDataSet19TIPO.AsString,3,Length(Form7.ibDataSet19TIPO.AsString)-2))) = 'CHR(27)+[2]' then
            vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ] := chr(27)+'2'+Copy(vLinha[ Trunc(Form7.ibDataSet19LINHA.AsFloat) ],1,JI);
          end;
        end;
        //
      except end;
      //
      ibDataSet19.Next;
    end;
    // Arquivo de nota fiscal NOTA.DBF
  end;

  // Inco da impressao da regua
  if Form7.sModulo = 'NOTA' then
  begin
    if Button2.Caption = 'Srie 2' then
    begin
      Mais2ini := TIniFile.Create('retaguarda.ini');
      AssignFile(F,Mais2Ini.ReadString('Nota Fiscal','Porta','LPT1'));
      Mais2ini.Free;
    end else
    begin
      Mais2ini := TIniFile.Create('retaguarda.ini');
      AssignFile(F,Mais2Ini.ReadString('Nota Fiscal 2','Porta','LPT1'));
      Mais2ini.Free;
    end;
  end;

  if Form7.sModulo = 'CONFOS' then
  begin
    Mais2ini := TIniFile.Create('retaguarda.ini');
    AssignFile(F,Mais2Ini.ReadString('OS','Porta','LPT1'));
    Mais2ini.Free;
  end;
  
  if Form7.sModulo = 'CONFRECIBO' then
  begin
    Mais2ini := TIniFile.Create('retaguarda.ini');
    AssignFile(F,Mais2Ini.ReadString('RECIBOOS','Porta','LPT1'));
    Mais2ini.Free;
  end;
  
  // MOTOR DA NOTA FISCAL
  try
    Rewrite(F);
  except
    //ShowMessage('Verifique a impressora.') Mauricio Parizotto 2023-10-25
    MensagemSistema('Verifique a impressora.',msgAtencao);
  end;

  try
    Writeln(F,chr(27)+'@');
    for I := 0 to iPagina -1 do
    begin
      try
        Writeln(F,vLinha[I]);
      except
        //ShowMessage('Verifique a impressora.'); Mauricio Parizotto 2023-10-25
        MensagemSistema('Verifique a impressora.',msgAtencao);
        Abort;
      end;
    end;
    CloseFile(F);
  except
    //ShowMessage('Verifique a impressora.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Verifique a impressora.',msgAtencao);
    Abort;
  end;

  ibDataSet19.First;
  ibDataSet19.EnableControls;
end;

procedure TForm7.Button2Click(Sender: TObject);
begin
  if Button2.Caption = 'Srie 1' then
  begin
    sWhere := 'where SERIE=1';
  end else
  begin
    sWhere := 'where SERIE=2';
  end;

  Form7.Close;
  
  Form7.sModulo         := 'NOTA';
  Form7.Show;
end;

procedure TForm7.FCIFichadeContedodeImportao1Click(Sender: TObject);
begin
  ShellExecute( 0, 'Open', 'fci.exe', '', '', SW_SHOW);
end;

procedure TForm7.Produtividadedecontatos1Click(Sender: TObject);
var
  F: TextFile;
  MesInicial, I : Integer;
  fContatos, fTotal1, fTotal2 : Real;
  dContador, dInicio, dFinal : TdateTime;
begin
  Form7.sModulo := 'CONTATOS';
  Form38.Panel5.Visible := True;
  Form38.btnCancelar.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Panel5.Visible := False;
  Form38.btnCancelar.Visible := True;

  Form7.sModulo := 'CLIENTES';

  Screen.Cursor := crHourGlass; // Cursor de Aguardo

  if Form38.Caption <> 'Cancelar' then
  begin
    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
    {$ENDIF}

    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CONTATOS DE HORA EM HORA')+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CONTATOS DE HORA EM HORA</b></font>');
    WriteLn(F,'<br>');

  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
      //
      dInicio :=  StrToDate('01'+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      dFinal  :=  StrToDate(StrZero(DiasPorMes(Year(Form38.MonthCalendar1.Date),Month(Form38.MonthCalendar1.Date)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      //
      WriteLn(F,'<font face="verdana" size=2><b>'+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+'</b><br><br>');              // Ms e ano
      WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
      WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Dom</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Seg</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Ter</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qua</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qui</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Sex</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Sab</font></th>');
      WriteLn(F,' </tr>');
      //
      WriteLn(F,' <tr  bgcolor=#FFFFFF>');
      //
      dContador  := DInicio - Day(dInicio) +1;
      MesInicial := Month(dInicio);
      //
      fTotal2 := 0;
      //
      for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
      while dContador <= dFinal + DiasPorMes(Year(dFinal),Month(dFinal)) - Day(dFinal) do
      begin
        //
        if Month(dContador) = MesInicial then
        begin
          if DayOfWeek(dContador) = 1 then WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          if (dContador < dInicio) or (dContador > dFinal) then WriteLn(F,'   <td   '+{nowrap}'   align=left valign=top width=100><font face="verdana" size=1 color=c0c0c0>'+IntToStr(Day(dContador))+'</td>') else WriteLn(F,'   <td   '+{nowrap}'   align=left valign=top width=100><font face="verdana" size=1>'+IntToStr(Day(dContador)));
          //
          Form7.Panel7.Caption := 'Analizando dia '+DateToStr(dContador)+'...';
          Form7.Panel7.Repaint;
          //
          Form7.IBDataSet99.Close;
          Form7.IBDataSet99.SelectSQL.Clear;
          Form7.IBDataSet99.SelectSQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%'+StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0)+'%''');
          Form7.IBDataSet99.Open;
          //
          if Form7.IBDataSet99.FieldByname('COUNT').AsFloat <> 0 then
          begin
            //
            // Tabela do dia
            //
            WriteLn(F,' <table  border=1  style="border-collapse:Collapse"  cellspacing=0 cellpadding=3 width=100>');
    //        WriteLn(F,'  <tr>');
    //        WriteLn(F,'   <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Hora</th>');
    //        WriteLn(F,'   <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">Contatos</th>');
    //        WriteLn(F,'  </tr>');
            //
            fTotal1 := 0;
            //
            for I := 1 to 24 do
            begin
              //
              Form7.Panel7.Caption := 'Analizando dia '+DateToStr(dContador)+' '+StrZero(I,2,0)+':00:00 ...';
              Form7.Panel7.Repaint;
              //
              Form7.IBDataSet99.Close;
              Form7.IBDataSet99.SelectSQL.Clear;
              Form7.IBDataSet99.SelectSQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%'+ StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0) +' '+StrZero(I,2,0)+':%''');
              Form7.IBDataSet99.Open;
              //
              fContatos := Form7.IBDataSet99.FieldByname('COUNT').AsFloat;
              //
              if (fContatos <> 0) then
              begin
                //
                WriteLn(F,'  <tr>');
                WriteLn(F,'   <td   width=30 align=Left><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+StrZero(I,2,0)+'</td>');
                WriteLn(F,'   <td   width=70 align=Right><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+Format('%7.0n',[fContatos])+'</td>');
                WriteLn(F,'  </tr>');
                //
                fTotal1 := fTotal1 + fContatos;
                fTotal2 := fTotal2 + fContatos;
                //
              end;
              //
            end;
            //
            WriteLn(F,'  <tr>');
            WriteLn(F,'   <th  bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000"></th>');
            WriteLn(F,'   <th   align=Right bgcolor=#'+Form1.sHtmlCor+'><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#000000">'+FloatToStr(fTotal1)+'</th>');
            WriteLn(F,'  </tr>');
            //
            WriteLn(F,' </table>');
            //
            // Tabela do dia
            //
          end;
          //
          WriteLn(F,' </td>');
          if DayOfWeek(dContador) = 7 then WriteLn(F,' </tr>');
          dContador := SomaDias(dContador, 1);                // Incrementa o contador
          //
        end else
        begin
          MesInicial := Month(dContador);
          for I := DayOfWeek(dContador) to 7 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
          WriteLn(F,' </tr>');
          WriteLn(F,'</table>');
          WriteLn(F,'<br>');
          WriteLn(F,'<br><font face="verdana" size=1><b>'+MesExtenso(Month(dContador))+' de '+IntToStr(Year(dInicio))+'</b>');              // Ms e ano
          WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
          WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Dom</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Seg</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Ter</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qua</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qui</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Sex</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Sab</font></th>');
          WriteLn(F,' </tr>');
          //
          WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
        end;
      end;
      //
      WriteLn(F,' </tr>');
      WriteLn(F,'</table>');
      WriteLn(F,'<br>');
      //
      WriteLn(F,'<font face="verdana" size=2><b>Contatos no ms de '+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+': '+FloatToStr(fTotal2)+'</b><br><br>'); // Ms e ano
      //
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);                                    // Fecha o arquivo
    //
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.IBDataSet2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.Clientescontactadospordia1Click(Sender: TObject);
var
  F: TextFile;
  MesInicial, I : Integer;
  fTotal1, fTotal2 : Real;
  dContador, dInicio, dFinal : TdateTime;
begin
  Form7.sModulo := 'CONTATOS';
  Form38.Panel5.Visible := True;
  Form38.btnCancelar.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Panel5.Visible := False;
  Form38.btnCancelar.Visible := True;

  Form7.sModulo := 'CLIENTES';

  Screen.Cursor := crHourGlass; // Cursor de Aguardo

  if Form38.Caption <> 'Cancelar' then
  begin
    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
    {$ENDIF}

    Screen.Cursor := crHourGlass; // Cursor de Aguardo

    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CLIENTES CONTACTADOS POR DIA')+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CLIENTES CONTACTADOS POR DIA</b></font>');
    WriteLn(F,'<br>');
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
      //
      dInicio :=  StrToDate('01'+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      dFinal  :=  StrToDate(StrZero(DiasPorMes(Year(Form38.MonthCalendar1.Date),Month(Form38.MonthCalendar1.Date)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
      //
      WriteLn(F,'<font face="verdana" size=2><b>'+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+'</b><br><br>');              // Ms e ano
      WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
      WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Dom</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Seg</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Ter</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qua</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qui</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Sex</font></th>');
      WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Sab</font></th>');
      WriteLn(F,' </tr>');
      //
      WriteLn(F,' <tr  bgcolor=#FFFFFF>');
      //
      dContador  := DInicio - Day(dInicio) +1;
      MesInicial := Month(dInicio);
      //
      fTotal1 := 0;
      fTotal2 := 0;
      //
      for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
      while dContador <= dFinal + DiasPorMes(Year(dFinal),Month(dFinal)) - Day(dFinal) do
      begin
        //
        if Month(dContador) = MesInicial then
        begin
          if DayOfWeek(dContador) = 1 then WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          if (dContador < dInicio) or (dContador > dFinal) then WriteLn(F,'   <td   '+{nowrap}'   align=left valign=top width=100><font face="verdana" size=1 color=c0c0c0>'+IntToStr(Day(dContador))+'</td>') else WriteLn(F,'   <td   '+{nowrap}'   align=left valign=top width=100><font face="verdana" size=1>'+IntToStr(Day(dContador)));
          //
          Form7.Panel7.Caption := 'Analizando dia '+DateToStr(dContador)+'...';
          Form7.Panel7.Repaint;
          //
          Form7.IBDataSet99.Close;
          Form7.IBDataSet99.SelectSQL.Clear;
          Form7.IBDataSet99.SelectSQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%'+StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0)+'%''');
          Form7.IBDataSet99.Open;
          //
          Form7.IBDataSet100.Close;
          Form7.IBDataSet100.SelectSQL.Clear;
          Form7.IBDataSet100.SelectSQL.Add('select sum(TOTAL) from VENDAS, ICM where EMITIDA=''S'' and EMISSAO='+QuotedStr(DateToStrInvertida(dContador))+' and ICM.NOME=VENDAS.OPERACAO and ICM.INTEGRACAO<>''''');
          Form7.IBDataSet100.Open;
          //
          if (Form7.IBDataSet99.FieldByname('COUNT').AsFloat <> 0) or (Form7.IBDataSet100.FieldByname('SUM').AsFloat <> 0) then
          begin
            //
            WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#32CD32">'+FloatToStr(Form7.IBDataSet99.FieldByname('COUNT').AsFloat)+'</center>');
            WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#FF0000">R$ '+Format('%14.2n',[Form7.IBDataSet100.FieldByName('SUM').AsFloat])+'</center>');
            WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#1E90FF">&Sigma; '+Format('%14.2n',[Form7.IBDataSet100.FieldByname('SUM').AsFloat/Form7.IBDataSet99.FieldByname('COUNT').AsFloat])+'</center>');
            //
            fTotal2 := fTotal2 + Form7.IBDataSet99.FieldByname('COUNT').AsFloat;
            fTotal1 := fTotal1 + Form7.IBDataSet100.FieldByname('SUM').AsFloat;
            //
          end;
          //
          WriteLn(F,' </td>');
          if DayOfWeek(dContador) = 7 then WriteLn(F,' </tr>');
          dContador := SomaDias(dContador, 1);                // Incrementa o contador
          //
        end else
        begin
          MesInicial := Month(dContador);
          for I := DayOfWeek(dContador) to 7 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
          WriteLn(F,' </tr>');
          WriteLn(F,'</table>');
          WriteLn(F,'<br>');
          WriteLn(F,'<br><font face="verdana" size=1><b>'+MesExtenso(Month(dContador))+' de '+IntToStr(Year(dInicio))+'</b>');              // Ms e ano
          WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
          WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Dom</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Seg</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Ter</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qua</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qui</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Sex</font></th>');
          WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Sab</font></th>');
          WriteLn(F,' </tr>');
          //
          WriteLn(F,' <tr  bgcolor=#FFFFFF>');
          for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
        end;
      end;
      //
      WriteLn(F,' </tr>');
      WriteLn(F,'</table>');
      WriteLn(F,'<br>');
      //
      WriteLn(F,'<font face="verdana" size=1><b>Contatos no ms de '+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+': '+FloatToStr(fTotal2)+'</b><br><br>'); // Ms e ano
      WriteLn(F,'<font face="verdana" size=1><b>Vendas no ms de '+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+': '+FloatToStr(fTotal1)+'</b><br><br>'); // Ms e ano
      //
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);                                    // Fecha o arquivo
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.ibDataset2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.Clientescontactadospordiaeporvendedor1Click(
  Sender: TObject);
var
  F: TextFile;
  MesInicial, I : Integer;
  fTotal1, fTotal2 : Real;
  dContador, dInicio, dFinal : TdateTime;
  //
  BlobStream : TStream;
  JP2    : TJPEGImage;
  //
  tInicio : tTime;
begin
  Form7.sModulo := 'CONTATOS';
  Form38.Panel5.Visible := True;
  Form38.btnCancelar.Visible := True;
  Form38.ShowModal; // Ok
  Form38.Panel5.Visible := False;
  Form38.btnCancelar.Visible := True;

  Form7.sModulo := 'CLIENTES';

  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  tInicio := Time;

  if Form38.Caption <> 'Cancelar' then
  begin
    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
    {$ENDIF}

    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    
    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CLIENTES CONTACTADOS POR DIA')+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CLIENTES CONTACTADOS POR DIA</b></font>');
    WriteLn(F,'<br>');
    //
    Form7.IBDataSet2.DisableControls;
    Form7.ibDataSet3.DisableControls;
    //
    Form7.ibQuery3.Close;
    Form7.ibQuery3.SQL.Clear;
    Form7.ibQuery3.SQL.Add('select NOME from VENDEDOR order by NOME');
    Form7.ibQuery3.Open;
    //
    while not Form7.ibQuery3.Eof do
    begin
      //
      Form7.ibQuery2.Close;
      Form7.ibQuery2.SQL.Clear;
      Form7.ibQuery2.SQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%('+Form7.ibQuery3.FieldByname('NOME').AsString+')%''');
      Form7.ibQuery2.Open;
      //
      if Form7.ibQuery2.FieldByname('COUNT').AsFloat <> 0 then
      begin
        //
        Form7.Panel7.Caption := 'Analizando contatos do vendedor '+Form7.ibQuery3.FieldByname('NOME').AsString+'...';
        Form7.Panel7.Repaint;
        //
        WriteLn(F,'<table  border=0 style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        WriteLn(F,' <tr   align=left>');
        WriteLn(F,'  <td  >');
        /////////////////////////
        // C A L E N D A R I O //
        /////////////////////////
        dInicio :=  StrToDate('01'+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
        dFinal  :=  StrToDate(StrZero(DiasPorMes(Year(Form38.MonthCalendar1.Date),Month(Form38.MonthCalendar1.Date)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date),3,8));
        //
        WriteLn(F,'<font face="verdana" size=2><b>'+MesExtenso(Month(dInicio))+' de '+IntToStr(Year(dInicio))+'</b><br><br>');              // Ms e ano
        WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Dom</font></th>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Seg</font></th>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Ter</font></th>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qua</font></th>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qui</font></th>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Sex</font></th>');
        WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Sab</font></th>');
        WriteLn(F,' </tr>');
        //
        WriteLn(F,' <tr  bgcolor=#FFFFFF>');
        //
        dContador  := DInicio - Day(dInicio) +1;
        MesInicial := Month(dInicio);
        //
        fTotal1 := 0;
        fTotal2 := 0;
        //
        for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
        while dContador <= dFinal + DiasPorMes(Year(dFinal),Month(dFinal)) - Day(dFinal) do
        begin
          //
          if Month(dContador) = MesInicial then
          begin
            if DayOfWeek(dContador) = 1 then WriteLn(F,' <tr  bgcolor=#FFFFFF>');
            if (dContador < dInicio) or (dContador > dFinal) then WriteLn(F,'   <td   '+{nowrap}'   align=left valign=top width=70><font face="verdana" size=1 color=c0c0c0>'+IntToStr(Day(dContador))+'</td>') else WriteLn(F,'   <td   '+{nowrap}'   align=left valign=top width=70><font face="verdana" size=1>'+IntToStr(Day(dContador)));
            //
            Form7.Panel7.Caption := 'Analizando contatos do vendedor '+Form7.ibQuery3.FieldByname('NOME').AsString+' do dia '+DateToStr(dContador)+'...';
            Form7.Panel7.Repaint;
            //
            Form7.ibQuery2.Close;
            Form7.ibQuery2.SQL.Clear;
            Form7.ibQuery2.SQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%('+Form7.ibQuery3.FieldByname('NOME').AsString+') '+StrZero(Year(dContador),4,0)+'-'+StrZero(Month(dContador),2,0)+'-'+StrZero(Day(dContador),2,0)+'%''');
            Form7.ibQuery2.Open;
            //
            Form7.ibQuery1.Close;
            Form7.ibQuery1.SQL.Clear;
            Form7.ibQuery1.SQL.Add('select sum(TOTAL) from VENDAS, ICM where EMITIDA=''S'' and EMISSAO='+QuotedStr(DateToStrInvertida(dContador))+' and VENDEDOR='+QuotedStr(Form7.ibQuery3.FieldByname('NOME').AsString)+' and ICM.NOME=VENDAS.OPERACAO and ICM.INTEGRACAO<>''''');
            Form7.ibQuery1.Open;
            //
            if (Form7.ibQuery2.FieldByname('COUNT').AsFloat <> 0) or (Form7.ibQuery1.FieldByname('SUM').AsFloat <> 0) then
            begin
              //
              WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#32CD32">'+FloatToStr(Form7.ibQuery2.FieldByname('COUNT').AsFloat)+'</center>');
              WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#FF0000">R$ '+Format('%14.2n',[Form7.ibQuery1.FieldByName('SUM').AsFloat])+'</center>');
              WriteLn(F,'   <center><font face="Verdana, Microsoft Sans Serif, Helvetica" size="1" color="#1E90FF">&Sigma; '+Format('%14.2n',[Form7.ibQuery1.FieldByname('SUM').AsFloat/Form7.ibQuery2.FieldByname('COUNT').AsFloat])+'</center>');
              //
              fTotal2 := fTotal2 + Form7.ibQuery2.FieldByname('COUNT').AsFloat;
              fTotal1 := fTotal1 + Form7.ibQuery1.FieldByname('SUM').AsFloat;
              //
            end;
            //
            WriteLn(F,' </td>');
            if DayOfWeek(dContador) = 7 then WriteLn(F,' </tr>');
            dContador := SomaDias(dContador, 1);                // Incrementa o contador
            //
          end else
          begin
            MesInicial := Month(dContador);
            for I := DayOfWeek(dContador) to 7 do WriteLn(F,'   <td   '+{nowrap}'   align=left><font face="verdana" size=1> </td>');
            WriteLn(F,' </tr>');
            WriteLn(F,'</table>');
            WriteLn(F,'<br>');
            WriteLn(F,'<br><font face="verdana" size=1><b>'+MesExtenso(Month(dContador))+' de '+IntToStr(Year(dInicio))+'</b>');              // Ms e ano
            WriteLn(F,'<table  border=1  style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
            WriteLn(F,' <tr   bgcolor=#'+Form1.sHtmlCor+' align=left>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Dom</font></th>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Seg</font></th>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Ter</font></th>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qua</font></th>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Qui</font></th>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1>Sex</font></th>');
            WriteLn(F,'  <th  '+{nowrap}'><font face="verdana" size=1 color=FF0000>Sab</font></th>');
            WriteLn(F,' </tr>');
            //
            WriteLn(F,' <tr  bgcolor=#FFFFFF>');
            for I := 1 to DayOfWeek(dContador)-1 do WriteLn(F,'   <td   '+{nowrap}'  align=left><font face="verdana" size=1> </td>');
          end;
        end;
        //
        WriteLn(F,' </tr>');
        WriteLn(F,'</table>');
        WriteLn(F,' </td>');
        WriteLn(F,' <td  ><br><br>');
        //
        // Foto
        //
        Form7.ibDataSet2.Close;
        Form7.ibDataSet2.SelectSQL.Clear;
        Form7.ibDataSet2.SelectSQL.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibQuery3.FieldByname('NOME').AsString));
        Form7.ibDataSet2.Open;
        //
        if Form7.ibDataSet2FOTO.BlobSize <> 0 then
        begin
          BlobStream:= Form7.ibDataSet2.CreateBlobStream(Form7.ibDataSet2FOTO,bmRead);
          jp2 := TJPEGImage.Create;
          try
            jp2.LoadFromStream(BlobStream);
            Form10.Image5.Picture.Assign(jp2);
          finally
            BlobStream.Free;
            jp2.Free;
          end;
          //
        end
        else
          Form10.Image5.Picture := Form10.Image3.Picture;
        //
        Form10.Image5.Picture.SaveToFile('_t_'+Form7.ibDataSet2.FieldByName('REGISTRO').AsString+'.jpg');
        //
        if Form10.Image5.Picture.Width > Form10.Image5.Picture.Height then
        begin
          WriteLn(F,'<img src="'+'_t_'+Form7.ibDataSet2.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet2.FieldByName('NOME').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (200 / Form10.Image5.Picture.Width)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (200 / Form10.Image5.Picture.Width)),10,0)+'>');
        end else
        begin
          WriteLn(F,'<img src="'+'_t_'+Form7.ibDataSet2.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet2.FieldByName('REGISTRO').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (200 / Form10.Image5.Picture.Height)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (200 / Form10.Image5.Picture.Height)),10,0)+'>');
        end;
        //
        WriteLn(F,'   <br><font face="verdana" size=1>'+Form7.ibQuery3.FieldByname('NOME').AsString);              // Ms e ano
        WriteLn(F,'   <br><font face="verdana" size=1>Contatos: '+FloatToStr(fTotal2));
        WriteLn(F,'   <br><font face="verdana" size=1>Vendas: '+FloatToStr(fTotal1)); // Ms e ano
        WriteLn(F,'  </td>');
        WriteLn(F,' </tr>');
        WriteLn(F,'</table>');
        WriteLn(F,'<br>');
        //
      end;
      //
      Form7.ibQuery3.Next;
      //
    end;
  /////////////////////////
  // C A L E N D A R I O //
  /////////////////////////
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center>Tempo para gerar este relatrio: '+TimeToStr(Time - tInicio)+'</center>');
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</html>');
    //
    CloseFile(F);                                    // Fecha o arquivo
    //
    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.ibDataset2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
    //
  end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
end;

procedure TForm7.IBDataSet2BeforePost(DataSet: TDataSet);
begin
  //
  if Form7.sWhere  = 'where CLIFOR='+QuotedStr('Vendedor') then
  begin
    if AllTrim(Form7.IBDataSet2CLIFOR.AsString) = '' then Form7.IBDataSet2CLIFOR.AsString := 'Vendedor';
  end;
  //
  if Form7.IBDataSet2CLIFOR.AsString = 'Vendedor' then
  begin
    //
    Form7.ibDataSet9.Close;                                                    //
    Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
    Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME=:NOME'); //
    Form7.ibDataSet9.DataSource := DataSource2;
    Form7.ibDataSet9.Open;
    //
    if AllTrim(Form7.ibDataSet9NOME.AsString) <> AllTrim(Form7.IBDataSet2NOME.AsString) then
    begin
      try
        Form7.ibDataSet9.Append;
        Form7.IBDataSet9NOME.AsString   := Form7.IBDataSet2NOME.AsString;
        Form7.IBDataSet9FUNCAO.AsString := 'VENDEDOR';
        Form7.ibDataSet9.Post;
      except end;
    end else
    begin
      try
        Form7.ibDataSet9.Edit;
        Form7.IBDataSet9FUNCAO.AsString := 'VENDEDOR';
        Form7.ibDataSet9.Post;
      except end;
    end;
  end;
  //
end;

procedure TForm7.Button10Click(Sender: TObject);
var
  I : Integer;
  f: TextFile;
  sMensagem, sLinha : String;
begin
  //
  if not Form7.OpenDialog4.Execute then Exit;
  //
  if FileExists(Form7.OpenDialog4.FileName) then
  begin
    //
    AssignFile(f,Form7.OpenDialog4.FileName);
    Reset(f);
    //
    Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
    sMensagem := '';
    I := 0;
    //
    while not eof(f) Do
    begin
      //
      ReadLn(f,sLinha);
      //
      if (Copy(sLinha,001,001) = '0') and (Copy(sLinha,003,007) = 'RETORNO') then // 03 Identificao Tipo de Operao RETORNO
      begin
        //
        // HEADER
        //
        //   Copy(sLinha,001,001); // 01 Identificao do Registro Header: 0
        //   Copy(sLinha,002,001); // 02 Tipo de Operao: 2
        //   Copy(sLinha,003,007); // 03 Identificao Tipo de Operao RETORNO
        //   Copy(sLinha,010,002); // 04 Identificao do Tipo de Servio: 01
        //   Copy(sLinha,012,008); // 05 Identificao por Extenso do Tipo de Servio:COBRANA
        //   Copy(sLinha,020,007); // 06 Complemento do Registro: Brancos
        //   Copy(sLinha,027,004); // 07 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,031,001); // 08 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,032,008); // 09 Cdigo do Cliente/Beneficirio: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,040,001); // 10 Dgito Verificador do Cdigo: vide planilha "Capa" deste arquivo
        //   Copy(sLinha,041,006); // 11 Nmero do convnio lder: Brancos
        //   Copy(sLinha,047,030); // 12 Nome do Beneficirio
        //   Copy(sLinha,077,018); // 13 Identificao do Banco: "756BANCOOBCED"
        //   Copy(sLinha,095,006); // 14 Data da Gravao do Retorno: formato ddmmaa
        //   Copy(sLinha,101,007); // 15 Seqencial do Retorno: nmero seqencial atribudo pelo Sicoob, acrescido de 1 a cada retorno. Inicia com "0000001"
        //   Copy(sLinha,108,287); // 16 Complemento do Registro: Brancos
        //   Copy(sLinha,395,006); // 17 Seqencial do Registro:000001
        //
        sMensagem := sMensagem + 'Arquivo processado com sucesso.' + chr(10)+chr(10);
        //
      end;
      //
      if (Copy(sLinha,001,001) = '1') then // and (Copy(sLinha,004,014) = cnpj do emitente) then // 03 Nmero do CPF/CNPJ do Beneficirio
      begin
        //
        // Copy(sLinha,001,001); // 01 Identificao do Registro Detalhe: 1 (um)
        // Copy(sLinha,002,002); // 02 "Tipo de Inscrio do Beneficirio: ""01"" = CPF ""02"" = CNPJ  "
        // Copy(sLinha,004,014); // 03 Nmero do CPF/CNPJ do Beneficirio
        // Copy(sLinha,018,004); // 04 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
        // Copy(sLinha,022,001); // 05 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
        // Copy(sLinha,023,008); // 06 Conta Corrente: vide planilha "Capa" deste arquivo
        // Copy(sLinha,031,001); // 07 Dgito Verificador da Conta: vide planilha "Capa" deste arquivo
        // Copy(sLinha,032,006); // 08 Nmero do Convnio de Cobrana do Beneficirio: "000000"
        // Copy(sLinha,038,025); // 09 Nmero de Controle do Participante: Brancos
        // Copy(sLinha,063,011); // 10 Nosso Nmero
        // Copy(sLinha,074,001); // 11 DV Nosso Nmero
        // Copy(sLinha,075,002); // 12 Nmero da Parcela
        // Copy(sLinha,077,004); // 13 Grupo de Valor: "00"
        // Copy(sLinha,081,002); // 14 Cdigo de Baixa/Recusa
        // Copy(sLinha,083,003); // 15 "Prefixo do Ttulo: Informa Espcie do Ttulo DM = Duplicata Mercantil CH = Cheque DS = Duplicata de Servio PC  = Parcela de Consrcio OU = Outros"
        // Copy(sLinha,086,003); // 16 Variao da Carteira: "000"
        // Copy(sLinha,089,001); // 17 Conta Cauo: "0"
        // Copy(sLinha,090,005); // 18 Cdigo de responsabilidade: "00000"
        // Copy(sLinha,095,001); // 19 DV do cdigo de responsabilidade: "0"
        // Copy(sLinha,096,005); // 20 Taxa de desconto
        // Copy(sLinha,101,005); // 21 Taxa de IOF
        // Copy(sLinha,106,001); // 22 Complemento do Registro: Brancos
        // Copy(sLinha,107,002); // 23 "Carteira/Modalidade: 01 = Simples Com Registro 02 = Simples Sem Registro 03 = Garantida Caucionada
        // Copy(sLinha,109,002); // 24 Comando/Movimento: 02 = Confirmao Entrada Ttulo;
        // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
        // Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
        // Copy(sLinha,127,020); // 27 Complemento do Registro: Brancos
        // Copy(sLinha,147,006); // 28 Data Vencimento Ttulo: formato ddmmaa
        // Copy(sLinha,153,013); // 29 Valor Titulo
        // Copy(sLinha,166,003); // 30 Cdigo do banco recebedor: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
        // Copy(sLinha,169,004); // 31 Prefixo da agncia recebedora: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
        // Copy(sLinha,173,001); // 32 DV prefixo recebedora
        // Copy(sLinha,174,002); // 33 "Espcie do Ttulo : 01 = Duplicata Mercantil
        // Copy(sLinha,176,006); // 34 Data do crdito: formato ddmmaa
        // Copy(sLinha,182,007); // 35 Valor da Tarifa
        // Copy(sLinha,189,013); // 36 Outras despesas
        // Copy(sLinha,202,013); // 37 Juros do desconto
        // Copy(sLinha,215,013); // 38 IOF do desconto
        // Copy(sLinha,228,013); // 39 Valor do abatimento
        // Copy(sLinha,241,013); // 40 Desconto concedido (diferena entre valor do ttulo e valor recebido)
        // Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
        // Copy(sLinha,267,013); // 42 Juros de Mora
        // Copy(sLinha,280,013); // 43 Outros recebimentos
        // Copy(sLinha,293,013); // 44 Abatimento no aproveitado pelo Pagador
        // Copy(sLinha,306,013); // 45 Valor do Lanamento
        // Copy(sLinha,319,001); // 46 Indicativo dbito/crdito
        // Copy(sLinha,320,001); // 47 Indicativo valor
        // Copy(sLinha,321,012); // 48 Valor do Ajuste
        // Copy(sLinha,333,010); // 49 Complemento do Registro: Brancos
        // Copy(sLinha,343,014); // 50 CPF/CNPJ do Pagador
        // Copy(sLinha,358,038); // 51 Complemento do Registro: Brancos
        // Copy(sLinha,395,006); // 52 Seqencial do Registro: Incrementado em 1 a cada registro
        //
        // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
        //
        if Copy(sLinha,109,002) = '06' then // 24 Comando/Movimento: 06 = Liquidao Normal
        begin
          //
          if Copy(sLinha,254,013) <> '0000000000000' then // 41 Valor recebido (valor recebido parcial)
          begin
  //        Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
  //        Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
  //
  //Form7.ibDataset7NOSSONUM.AsString
  //           Copy(sLinha,117,009)+asdfasdf
            sMensagem := sMensagem + 'Nmero documento: ' + Copy(sLinha,117,010) + ' Valor: R$ '+  FloatToStr(StrToFloat(Copy(sLinha,254,013))/100);
            if Form7.ibDataSet7.Locate('DOCUMENTO',AllTrim(Copy(sLinha,117,010)),[]) then
            begin
              //
              if Form7.ibDataSet7ATIVO.AsFloat < 5 then
              begin
                //
                //
                if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                begin
                  //
                  Form7.SMALL_DBEdit1.Visible := True;
                  Form7.Edit2.Text            := Form7.SMALL_DBEdit2.Text;
                  //
                  Form7.ibDataSet7.Edit;
                  Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;
  //                Form7.ibDataSet7VALOR_RECE.AsFloat := Form7.ibDataSet7VALOR_DUPL.AsFloat;
                  Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,254,013))/100;
                  Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet7VALOR_RECE.AsFloat)); // Sandro Silva 2023-10-30
                  //
                  Form7.ibDataSet7.Post;
                  //
                  Form1.IBDataSet200.Close;
                  Form1.IBDataSet200.Open;
                  //
                  Form7.ibQuery1.Close;
                  Form7.IBQuery1.SQL.Clear;
                  Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
                  Form7.IBQuery1.Open;
                  //
                  Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
                  Form7.Panel10.Repaint;
                  //
                  Form7.ibDataSet25DIFERENCA_.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat +  StrToFloat(Copy(sLinha,254,013))/100;
                  Form7.ibDataSet25DIFERENCA_.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)); // Sandro Silva 2023-10-30
                  //
                  SMALL_DBEdit1.SetFocus;
                  I := I + 1;
                  //
                end else
                begin
                  sMensagem := sMensagem + ' documento j estava quitado. ';
                end;
              end else
              begin
                sMensagem := sMensagem + ' documento j estava marcado. ';
              end;
              sMensagem := sMensagem + chr(10);
            end else
            begin
              sMensagem := sMensagem + ' documento no encontrado '+chr(10);
            end;
          end;
        end;
      end;
    end;

    CloseFile(F);

    begin
      sMensagem := sMensagem + chr(10) + chr(10) +
      'Duplicatas recebidos: '+ IntToStr(I )+chr(10)+chr(10) +
      'Total recebido R$: '+Form7.ibDataSet25DIFERENCA_.AsString+chr(10)+chr(10);

      //ShowMessage(sMensagem); Mauricio Parizotto 2023-10-25
      MensagemSistema(sMensagem);
    end;
    Form7.SMALL_DBEdit6.SetFocus;
  end;
end;

procedure TForm7.lblExcluirMouseLeave(Sender: TObject);
begin
  if Form7.lblExcluir.Font.Style <> [] then
  begin
    Form7.imgExcluir.Picture    := Form7.Image202_R.Picture;
    Form7.lblExcluir.Font.Style := [];
  end;
end;

procedure TForm7.lblProcurarMouseLeave(Sender: TObject);
begin
  if Form7.lblProcurar.Font.Style <> [] then
  begin
    Form7.imgProcurar.Picture    := Form7.Image203_R.Picture;
    Form7.lblProcurar.Font.Style := [];
  end;
end;

procedure TForm7.lblImprimirMouseLeave(Sender: TObject);
begin
  if Form7.lblImprimir.Font.Style <> [] then
  begin
    Form7.imgImprimir.Picture    := Form7.Image205_R.Picture;
    Form7.lblImprimir.Font.Style := [];
  end;
end;

procedure TForm7.lblVisualizarMouseLeave(Sender: TObject);
begin
  if Form7.lblVisualizar.Font.Style <> [] then
  begin
    Form7.imgVisualizar.Picture    := Form7.Image204_R.Picture;
    Form7.lblVisualizar.Font.Style := [];
  end;
end;

procedure TForm7.lblEditarMouseLeave(Sender: TObject);
begin
  if Form7.lblEditar.Font.Style <> [] then
  begin
    Form7.imgEditar.Picture    := Form7.Image206_R.Picture;
    Form7.lblEditar.Font.Style := [];
  end;
end;

procedure TForm7.Label208MouseLeave(Sender: TObject);
begin
  if Form7.Label208.Font.Style <> [] then
  begin
    Form7.imgLibBloq.Picture    := Form7.Image208_R.Picture;
    Form7.Image308.Picture    := Form7.Image308_R.Picture;
    Form7.Label208.Font.Style := [];
  end;
end;

procedure TForm7.lblFiltrarMouseLeave(Sender: TObject);
begin
  if Form7.lblFiltrar.Font.Style <> [] then
  begin
    Form7.imgFiltrar.Picture    := Form7.Image209_R.Picture;
    Form7.lblFiltrar.Font.Style := [];
  end;
end;

procedure TForm7.lblExcluirMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.lblExcluir.Font.Style <> [fsBold] then
  begin
    Form7.imgExcluir.Picture    := Form7.Image202_X.Picture;
    Form7.lblExcluir.Font.Style := [fsBold];
  end;
end;

procedure TForm7.lblProcurarMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.lblProcurar.Font.Style <> [fsBold] then
  begin
    Form7.imgProcurar.Picture    := Form7.Image203_X.Picture;
    Form7.lblProcurar.Font.Style := [fsBold];
  end;
end;

procedure TForm7.lblImprimirMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.lblImprimir.Font.Style <> [fsBold] then
  begin
    Form7.imgImprimir.Picture    := Form7.Image205_X.Picture;
    Form7.lblImprimir.Font.Style := [fsBold];
  end;
end;

procedure TForm7.lblVisualizarMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.lblVisualizar.Font.Style <> [fsBold] then
  begin
    Form7.imgVisualizar.Picture    := Form7.Image204_X.Picture;
    Form7.lblVisualizar.Font.Style := [fsBold];
  end;
end;

procedure TForm7.lblEditarMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.lblEditar.Font.Style <> [fsBold] then
  begin
    Form7.imgEditar.Picture    := Form7.Image206_X.Picture;
    Form7.lblEditar.Font.Style := [fsBold];
  end;
end;

procedure TForm7.Label208MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.Label208.Font.Style <> [fsBold] then
  begin
    Form7.imgLibBloq.Picture    := Form7.Image208_X.Picture;
    Form7.Image308.Picture    := Form7.Image308_X.Picture;
    Form7.Label208.Font.Style := [fsBold];
  end;
end;

procedure TForm7.lblFiltrarMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if Form7.lblFiltrar.Font.Style <> [fsBold] then
  begin
    Form7.imgFiltrar.Picture    := Form7.Image209_X.Picture;
    Form7.lblFiltrar.Font.Style := [fsBold];
  end;
end;

procedure TForm7.ibDataSet23QTD_ORIGINALChange(Sender: TField);
begin
  // converter unidades de medida na nota de compra
  try
    if (Form7.ProdutoOld.sDescricao  <> Form7.ibDataSet23DESCRICAO.AsString) or
       (Form7.ProdutoOld.sQuantidade <> Form7.ibDataSet23QTD_ORIGINAL.AsString) or
       (Form7.ProdutoOld.sUnitario   <> Form7.ibDataSet23UNITARIO_O.AsString) or
       bMudei then
    begin
      bMudei := False;

      {Mauriico Parizotto 2024-02-21 Inicio}
      if not (Form7.ibDataset23.State in ([dsEdit, dsInsert])) then
        Form7.ibDataset23.Edit;

      //if (Form7.ibDataSet4FATORC.AsFloat = 0) or (Form7.ibDataSet4FATORC.AsFloat = 1) then
      if (StrToFloatDef(Form24.edtFatorC.Text,1) = 0) or (StrToFloatDef(Form24.edtFatorC.Text,1) = 1) then
      
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := Form7.ibDataSet23QTD_ORIGINAL.AsFloat;
        Form7.ibDataSet23UNITARIO.AsFloat   := Form7.ibDataSet23UNITARIO_O.AsFloat;
      end else
      begin
        //Form7.ibDataSet23QUANTIDADE.AsFloat := (Form7.ibDataSet23QTD_ORIGINAL.AsFloat * Form7.ibDataSet4FATORC.AsFloat);
        //Form7.ibDataSet23UNITARIO.AsFloat   := (Form7.ibDataSet23UNITARIO_O.AsFloat / Form7.ibDataSet4FATORC.AsFloat);
        Form7.ibDataSet23QUANTIDADE.AsFloat := (Form7.ibDataSet23QTD_ORIGINAL.AsFloat * StrToFloatDef(Form24.edtFatorC.Text,1));
        Form7.ibDataSet23UNITARIO.AsFloat   := (Form7.ibDataSet23UNITARIO_O.AsFloat / StrToFloatDef(Form24.edtFatorC.Text,1));
      end;
      {Mauriico Parizotto 2024-02-21 Fim}

      Form7.ProdutoOld.sDescricao  := Form7.ibDataSet23DESCRICAO.AsString;
      Form7.ProdutoOld.sQuantidade := Form7.ibDataSet23QTD_ORIGINAL.AsString;
      Form7.ProdutoOld.sUnitario   := Form7.ibDataSet23UNITARIO_O.AsString;
    end;
  except
  end;
end;

procedure TForm7.ibDataSet23UNITARIO_OChange(Sender: TField);
begin
  // converter unidades de medida na nota de compra
  try
    if (Form7.ProdutoOld.sDescricao  <> Form7.ibDataSet23DESCRICAO.AsString) or
       (Form7.ProdutoOld.sQuantidade <> Form7.ibDataSet23QTD_ORIGINAL.AsString) or
       (Form7.ProdutoOld.sUnitario   <> Form7.ibDataSet23UNITARIO_O.AsString) or
       bMudei then
    begin
      bMudei := False;
      if (Form7.ibDataSet4FATORC.AsFloat = 0) or (Form7.ibDataSet4FATORC.AsFloat = 1) then
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := Form7.ibDataSet23QTD_ORIGINAL.AsFloat;
        Form7.ibDataSet23UNITARIO.AsFloat   := Form7.ibDataSet23UNITARIO_O.AsFloat;
      end else
      begin
        Form7.ibDataSet23QUANTIDADE.AsFloat := (Form7.ibDataSet23QTD_ORIGINAL.AsFloat * Form7.ibDataSet4FATORC.AsFloat);
        Form7.ibDataSet23UNITARIO.AsFloat   := (Form7.ibDataSet23UNITARIO_O.AsFloat / Form7.ibDataSet4FATORC.AsFloat);
      end;
      Form7.ProdutoOld.sDescricao  := Form7.ibDataSet23DESCRICAO.AsString;
      Form7.ProdutoOld.sQuantidade := Form7.ibDataSet23QTD_ORIGINAL.AsString;
      Form7.ProdutoOld.sUnitario   := Form7.ibDataSet23UNITARIO_O.AsString;
    end;
  except
  end;
end;

procedure TForm7.ibDataSet23AfterScroll(DataSet: TDataSet);
begin
  Form7.ProdutoOld.sDescricao  := Form7.ibDataSet23DESCRICAO.AsString;
  Form7.ProdutoOld.sQuantidade := Form7.ibDataSet23QTD_ORIGINAL.AsString;
  Form7.ProdutoOld.sUnitario   := Form7.ibDataSet23UNITARIO_O.AsString;
end;

procedure TForm7.Emaildecobrana2Click(Sender: TObject);
var
  sSecoes :  TStrings;
  sParcelas, sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, II, YY, J : Integer;
  sMandados : String;
  MyBookMark1 : TBookMark;
//  PDF: TPrintPDF;
  sArquivoPDF: String; // Sandro Silva 2022-12-22
  PDF :TPdfDocumentGDI;
  PAGE : TPdfPage;
begin
  Form40.Tag := 9;
  Form40.CheckBox1.Visible := True;
  Form40.ShowModal;

  if Form1.Tag = 1 then
  begin
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail de cobrana para os clientes' + chr(10) +
              Chr(10) + 'filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);

    try
      if bButton = IDYES then
      begin
        I := 0;
        Form7.ibDataSet7.First;

        // Retorna onde parou
        Mais1ini := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;

        if sRegistro <> 'FIM' then
        begin
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);

          if bButton = IDYES then
          begin
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;

              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;

              Form7.ibDataSet7.Next;
            end;

            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;

              Form7.ibDataSet7.Next;
            end;
          end else
          begin
            sMandados := '';
          end;
        end;

        Mais1ini.Free;
        Screen.Cursor            := crHourGlass;

        YY := 0;

        while not Form7.ibDataSet7.Eof do
        begin
          if (Pos(Form7.ibDataSet7NOME.AsString,sMandados)=0) and (Form7.ibDataSet7ATIVO.AsFloat=0) then
          begin
            try
              // Relaciona os clientes com o arquivo de vendas
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString));
              Form7.ibDataSet2.Open;

              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                sArquivo := '';
                sArquivoPDF := Form1.sAtual+'\boletos_' + LimpaNumero(Form7.IBDataSet2CGC.AsString) + '.pdf'; // Sandro Silva 2022-12-22

                if Form7.sModulo = 'RECEBER' then
                begin
                  if Form40.CheckBox1.Checked then
                  begin
                    while FileExists(sArquivoPDF) do  // Sandro Silva 2022-12-22 while FileExists(Form1.sAtual+'\boletos.pdf') do
                    begin
                      DeleteFile(pChar(sArquivoPDF)); // Sandro Silva 2022-12-22 DeleteFile(pChar(Form1.sAtual+'\boletos.pdf'));
                      Sleep(1000);
                    end;

                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;

                    try
                      // Grava o local para voltar
                      MyBookMark1 := Form7.ibDataSet7.GetBookMark();

                      // Cria o PDF
                      (*
                      {Mauricio Parizotto 2024-02-15 Inicio
                      PDF := TPrintPDF.Create(Self);

                      // Configuraes do documento
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;

                      // Tamanho do A4 21,0 cm x 29,7 cm
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;

                      // Nome do arquivo para salvar
                      PDF.FileName    := sArquivoPDF;// sFileCFeSAT; // Sandro Silva 2022-12-22 PDF.FileName    := Form1.sAtual+'\boletos.pdf';// sFileCFeSAT;
                      PDF.BeginDoc;

                      Form7.ibDataSet7.First;
                      while not Form7.ibDataSet7.Eof do
                      begin
                        if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                        begin
                          if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                          begin
                            if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                            begin
                              if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                              begin
                                while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                begin
                                  DeleteFile(pChar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg'));
                                  Sleep(1000);
                                end;

                                Form1.sEscolhido := '';
                                Form1.sBancoBoleto := '';

                                try
                                  sSecoes := TStringList.Create;
                                  Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                  Mais1Ini.ReadSections(sSecoes);

                                  for J := 0 to (sSecoes.Count - 1) do
                                  begin
                                    if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                     or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                    and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                      or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                    begin
                                      Form1.sEscolhido := sSecoes[J];
                                    end;
                                  end;

                                  Mais1Ini.Free;
                                except
                                end;

                                if (AllTrim(Form1.sEscolhido) <> '') or (Form1.DisponivelSomenteParaNos) then // Sandro Silva 2022-12-22 if AllTrim(Form1.sEscolhido) <> '' then
                                begin
                                  Form25.Show; // Em Form7.Emaildecobrana2Click()

                                  {Sandro Silva 2022-12-23 inicio}
                                  if Form1.DisponivelSomenteParaNos then
                                  begin
                                    //GeraImagemDoBoletoComOCodigoDeBarras(False); // Para calcular cdigo de barras, nosso numero
                                    {Sandro Silva 2023-01-24 inicio
                                    Form25.GravaPortadorNossoNumCodeBar;
                                    }
                                    if UpperCase(Copy(AllTrim(Form7.ibDataSet7PORTADOR.AsString),1,7)) <> 'BANCO (' then
                                    begin
                                      Form25.GravaPortadorNossoNumCodeBar;
                                    end;
                                    {Sandro Silva 2023-01-24 fim}
                                  end;
                                  {Sandro Silva 2022-12-23 fim}

                                  Form7.Repaint;

                                  while not FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                  begin
                                    Sleep(1000);
                                  end;

                                  // Print Image
                                  YY := YY + 1;
//                                  if YY >= 2 then
  //                                  PDF.NewPage; // Add New Page

  //                                PDF.DrawJPEG(0, 0, Form25.Image2.Picture.Bitmap);

                                  PAGE := PDF.AddPage;
                                  PAGE.PageLandscape := False;

                                  PDF.VCLCanvas.Draw(0,0,Form25.imgBoletoEnvia.Picture.Graphic);

                                end;
                              end;
                            end;
                          end;

                          Screen.Cursor            := crHourGlass;
                          Form7.ibDataSet7.Next;
                          Form25.Close;
                          Form7.Repaint;
                        end;

                        Form7.ibDataSet7.GotoBookmark(MyBookMark1);

//                      PDF.EndDoc;
                        PDF.SaveToFile(sArquivoPDF);
                      finally
                        FreeAndNil(PDF);
                      end;
                      {Mauricio Parizotto 2024-02-15 Fim}

                      if FileExists(sArquivoPDF) then // Sandro Silva 2022-12-22 if FileExists(Form1.sAtual+'\boletos.pdf') then
                        sArquivo := sArquivoPDF // Sandro Silva 2022-12-22 sArquivo := Form1.sAtual + '\boletos.pdf'
                      else
                        sArquivo := '';
                      *)
                      try
                        PDF:=TPdfDocumentGDI.Create();
                        PDF.Info.Author       := 'Small';
                        PDF.Info.Creator      := 'Small';
                        PDF.Info.Title        := 'Boletos';
                        PDF.Info.Subject      := 'Boletos de cobrana';
                        PDF.Info.CreationDate := now;
                        PDF.DefaultPaperSize := psA4; //Tamanho A4
                        PDF.ForceJPEGCompression := 0;
                        PDF.AddTrueTypeFont('Interleaved 2of5 Text');
                        PDF.EmbeddedTTF := True;
                        PDF.EmbeddedWholeTTF := true;

                        Form7.ibDataSet7.First;
                        while not Form7.ibDataSet7.Eof do
                        begin
                          if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                          begin
                            if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                            begin
                              if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                              begin
                                if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                                begin
                                  Form1.sEscolhido := '';
                                  Form1.sBancoBoleto := '';

                                  try
                                    sSecoes := TStringList.Create;
                                    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                    Mais1Ini.ReadSections(sSecoes);

                                    for J := 0 to (sSecoes.Count - 1) do
                                    begin
                                      if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                       or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                      and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                        or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                      begin
                                        Form1.sEscolhido := sSecoes[J];
                                      end;
                                    end;

                                    Mais1Ini.Free;
                                  except
                                  end;

                                  if (AllTrim(Form1.sEscolhido) <> '') or (Form1.DisponivelSomenteParaNos) then // Sandro Silva 2022-12-22 if AllTrim(Form1.sEscolhido) <> '' then
                                  begin
                                    Form1.sBancoBoleto     := Trim(StringReplace(Form1.sEscolhido, 'Boleto de cobrana do', '', [rfReplaceAll]));
                                    Form25.EventoShow;
                                    Form25.CarregaConfiguracao;
                                    Form25.CarregaDadosParcela;
                                    Form7.Repaint;

                                    //Mauricio Parizotto 2024-02-19

                                    PAGE := pdf.AddPage;
                                    PAGE.PageLandscape := False;
                                    DesenhaBoletoLayoutPadrao(PDF.VCLCanvas, grPDF, Copy(Form26.MaskEdit42.Text,1,3), Form26.MaskEdit44.Text, Form26.MaskEdit46.Text, Form26.MaskEdit50.Text, Form26.MaskEdit43.Text, Form26.MaskEdit47.Text, Form26.MaskEdit45.Text);
                                  end;
                                end;
                              end;
                            end;
                          end;

                          Screen.Cursor            := crHourGlass;
                          Form7.ibDataSet7.Next;
                          Form25.Close;
                        end;

                        Form7.ibDataSet7.GotoBookmark(MyBookMark1);

                        PDF.SaveToFile(sArquivoPDF);

                        // Fecha o pdf
                        if FileExists(sArquivoPDF) then
                          sArquivo := sArquivoPDF
                        else
                          sArquivo := '';

                      finally
                        FreeAndNil(PDF);
                      end;
                    except
                    end;

                    Form25.Close;
                    Form7.Repaint;

                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                    // Fecha o pdf
                  end;
                end;

                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);

                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL

                sMsg := Form40.Memo1.Lines.Text;

                // CLIENTES
                if I <> 0 then
                begin
                  for II := 1 to 700 do
                  begin
                    try
                      Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
                    except
                    end;

                    Application.ProcessMessages;
                  end;
                end;

                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                //
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));

                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));

                // TOTAL ATRASADO - Total acumulado
                if Pos('<PARCELAS_VENCIDAS>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select * from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' order by VENCIMENTO');
                  Form7.ibQuery1.Open;
                  //
                  sParcelas := '';

                  while not Form7.ibQuery1.eof do
                  begin
                    sParcelas := sParcelas +
                                'Documento: '+Copy(Form7.ibQuery1.fieldByname('DOCUMENTO').AsString   +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Emisso: '+Copy(Form7.ibQuery1.fieldByname('EMISSAO').AsString     +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Vencimento: '+Copy(Form7.ibQuery1.fieldByname('VENCIMENTO').AsString  +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Valor: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_DUPL').AsFloat])+Replicate(' ',10),1,10)+' '+chr(10)+
                                'Atualizado: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_JURO').AsFloat])+Replicate(' ',10),1,10)+chr(10)+
                                IfThen(Trim(Form7.ibQuery1.fieldByname('CODEBAR').AsString) <> '', 'Cdigo de barras: '+Form7.ibQuery1.fieldByname('CODEBAR').AsString, '')+chr(10)+chr(10)// Sandro Silva 2023-02-10
                                ;
                    Form7.ibQuery1.Next;
                  end;

                  sMsg := StrTran(sMsg,'<PARCELAS_VENCIDAS>'    ,sParcelas);
                end;

                // TOTAL ATRASADO - Total acumulado
                if Pos('<TOTAL_ATRASADO>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_DUPL) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;

                  sMsg := StrTran(sMsg,'<TOTAL_ATRASADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                end;

                if Pos('<TOTAL_ATUALIZADO>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_JURO) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATUALIZADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                end;
                
                EnviarEMail('', sEmail, '', PChar(sAssunto), PChar(sMSG), PChar(sArquivo), False);
                
                I := I + 1;

                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;

                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;

                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
                Form7.Panel1.Repaint;
              end;
              
              sMandados := sMandados + Form7.ibDataSet7NOME.AsString;
            except end;
         end;

         Form7.ibDataSet7.Next;
        end;
      end;
    except end;

    Screen.Cursor            := crDefault;
    Form7.Panel1.Visible := False;
    Form7.Repaint;
  end;
end;

procedure TForm7.FormMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.Panel4MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.Panel_0MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.DBGrid1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  Form1.Panel4.Visible  := True;
end;

procedure TForm7.IBDataSet6AfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet6AfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IBDataSet6BeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CODEBAR,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except Abort end;
end;

procedure TForm7.IBDataSet6NewRecord(DataSet: TDataSet);
begin
  ibDataSet6REGISTRO.AsString := sProximo;
end;

procedure TForm7.AnliseAnualdascontas1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  I : Integer;
  F: TextFile;
begin
  Form7.ibDataSet1.DisableControls;

  try
    CriaJpg('logotip.jpg');

    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';   
    {$ENDIF}

    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE ANUAL</b></font>');
    WriteLn(F,'<br><center>');   // Linha em branco
    WriteLn(F,'<br>');           // Linha em branco

    Screen.Cursor := crHourGlass; // Cursor de Aguardo

    // Faturamento
    DeleteFile(pChar(Form1.sAtual+'\faturamento.gra'));
    DeleteFile(pChar(Form1.sAtual+'\faturamento.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //

    Mais1ini := TIniFile.Create(Form1.sAtual+'\faturamento.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','faturamento.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Receita');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    Form1.ibQuery1.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as FATURAMENTO, extract(year from CAIXA.DATA) as ANO from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=1 and CAIXA.NOME=CONTAS.NOME group by extract(year from CAIXA.DATA) order by extract(year from CAIXA.DATA)');
    Form1.ibQuery1.Open;
    //
    I := 0;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+Form1.ibQuery1.FieldByName('ANO').AsString+'>');
      Form1.ibQuery1.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','faturamento.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\faturamento.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\faturamento.png"><img src="faturamento.png" border="0" width=500 height=250></a>');
    //

    //
    // Despesas
    //
    DeleteFile(pChar(Form1.sAtual+'\despesas.gra'));
    DeleteFile(pChar(Form1.sAtual+'\despesas.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\despesas.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','despesas.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Despesa');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery2.Close;
    Form1.ibQuery2.SQL.Clear;
    Form1.ibQuery2.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as despesas, extract(year from CAIXA.DATA) as ANO from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=3 and CAIXA.NOME=CONTAS.NOME group by extract(year from CAIXA.DATA) order by extract(year from CAIXA.DATA)');
    Form1.ibQuery2.Open;
    //
    I := 0;
    //
    while not Form1.ibQuery2.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+Form1.ibQuery2.FieldByName('ANO').AsString+'>');
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','despesas.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\despesas.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\despesas.png"><img src="despesas.png" border="0" width=500 height=250></a>');
    //
    // Lucro
    //
    DeleteFile(pChar(Form1.sAtual+'\lucro.gra'));
    DeleteFile(pChar(Form1.sAtual+'\lucro.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\lucro.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','lucro.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Lucro');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','Anos');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    I := 0;
    //
    Form1.ibQuery1.First;
    Form1.ibQuery2.First;
    //
    while not Form1.ibQuery1.Eof do
    begin
      //
      I := I + 1;
      //
      if Form1.ibQuery2.FieldByName('ANO').AsString = Form1.ibQuery1.FieldByName('ANO').AsString then
      begin
        Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                     'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'VX<'+StrZero(I,2,0)+'>LX<'+Form1.ibQuery1.FieldByName('ANO').AsString+'>');
      end;
      //
      Form1.ibQuery1.Next;
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','lucro.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\lucro.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\lucro.png"><img src="lucro.png" border="0" width=500 height=250></a>');
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
    AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
    //
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  //
end;

procedure TForm7.Clientescontactadospormsporvendedor1Click(
  Sender: TObject);
var
  F: TextFile;
  III : Integer;
  ftotalContatos, fTotal, fTotal1, fTotal2, fTotal3 : Real;
  dInicio, dFinal : TdateTime;
  //
  BlobStream : TStream;
  JP2    : TJPEGImage;
  //
  tInicio : tTime;
  mais2ini, Mais1ini : tIniFile;
begin
  Form7.IBDataSet2.DisableControls;
  try
    Form7.sModulo := 'CONTATOS';
    Form38.Panel5.Visible := True;
    Form38.btnCancelar.Visible := True;
    Form38.ShowModal; // Ok
    Form38.Panel5.Visible := False;
    Form38.btnCancelar.Visible := True;

    Form7.sModulo := 'CLIENTES';

    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    tInicio := Time;

    if Form38.Caption <> 'Cancelar' then
    begin
      {$IFDEF VER150}
      ShortDateFormat := 'dd/mm/yyyy';
      {$ELSE}
      FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
      {$ENDIF}

      AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));         // Direciona o arquivo F para RELATO.TXT
      Rewrite(F);                           // Abre para gravao
      Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - CLIENTES CONTACTADOS POR MS')+'</title></head>');
      WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
      WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
      WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#c0c0c0><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
      //
      WriteLn(F,'<br>');              // Linha em branco
      WriteLn(F,'<br><font face="Microsoft Sans Serif" size=3 color=#000000><b>CLIENTES CONTACTADOS POR MS</b></font>');
      WriteLn(F,'<br>');
      //
      try
        //
//        dInicio := StrToDate('01/'+StrZero( Month( Form38.MonthCalendar1.Date - DiasDesteMes ),2,0)+'/'+StrZero(Year(Form38.MonthCalendar1.Date-DiasDesteMes),4,0));
//        dFinal  := StrToDate(StrZero(DiasPorMes(Year( Form38.MonthCalendar1.Date -DiasDesteMes),Month(Form38.MonthCalendar1.Date-DiasDesteMes)),2,0)+Copy(DateTimeToStr(Form38.MonthCalendar1.Date-DiasDesteMes),3,8));
        //
        dInicio := StrToDate('01/'+StrZero(Month(Form38.MonthCalendar1.Date),2,0)+'/'+StrZero(Year(Form38.MonthCalendar1.Date),4,0));
        dFinal  := StrToDate(StrZero(DiasDesteMes,2,0)+'/'+StrZero(Month(Form38.MonthCalendar1.Date),2,0)+'/'+StrZero(Year(Form38.MonthCalendar1.Date),4,0));
        //
        fTotal  := 0;
        ftotalContatos := 0;
        //
        // GRAFICO
        //
        DeleteFile(pChar(Form1.sAtual+'\vendedores.png'));
        DeleteFile(pChar(Form1.sAtual+'\vendedores.gra'));
        DeleteFile(pChar(Form1.sAtual+'\contatos.png'));
        DeleteFile(pChar(Form1.sAtual+'\contatos.gra'));
        //                            //
        // cria o grfico vendedores //
        //                          //
        Mais1ini := TIniFile.Create(Form1.sAtual+'\vendedores.gra');
        //
        // Titulo
        //
        Mais1Ini.WriteString('DADOS','3D','1');
        Mais1Ini.WriteString('DADOS','MarcasS1','1');
        Mais1Ini.WriteString('DADOS','Legenda','0');
        Mais1Ini.WriteString('DADOS','TipoS1','4');
        Mais1Ini.WriteString('DADOS','AlturaBmp','1000');
        Mais1Ini.WriteString('DADOS','LarguraBmp','2000');
        //
        Mais1Ini.WriteString('DADOS','Titulo','');
        Mais1Ini.WriteString('DADOS','NomeBmp','vendedores.png');
        //
        // GRAFICO
        //
        DeleteFile(pChar(Form1.sAtual+'\contatos.png'));
        DeleteFile(pChar(Form1.sAtual+'\contatos.gra'));
        //                                                //
        // cria o grfico de fluxo de caixa contatos.png //
        //                                              //
        mais2ini := TIniFile.Create(Form1.sAtual+'\contatos.gra');
        //
        // Titulo
        //
        mais2Ini.WriteString('DADOS','3D','1');
        mais2Ini.WriteString('DADOS','MarcasS1','1');
        mais2Ini.WriteString('DADOS','Legenda','0');
        mais2Ini.WriteString('DADOS','TipoS1','4');
        mais2Ini.WriteString('DADOS','AlturaBmp','1000');
        mais2Ini.WriteString('DADOS','LarguraBmp','2000');
        //
        mais2Ini.WriteString('DADOS','Titulo','');
        mais2Ini.WriteString('DADOS','NomeBmp','contatos.png');
        //
        WriteLn(F,'<center>');
        WriteLn(F,'<table border=1 style="border-collapse:Collapse" cellspacing=0 cellpadding=4>');
        WriteLn(F,' <tr  bgcolor=#'+Form1.sHtmlCor+'   align=left>');
        WriteLn(F,'  <th '+{nowrap}'><font face="Microsoft Sans Serif" size=1>Foto</font></th>');
        WriteLn(F,'  <th '+{nowrap}'><font face="Microsoft Sans Serif" size=1>Vendedor</font></th>');
        WriteLn(F,'  <th '+{nowrap}'><font face="Microsoft Sans Serif" size=1>Valor</font></th>');
        WriteLn(F,'  <th '+{nowrap}'><font face="Microsoft Sans Serif" size=1>Contatos</font></th>');
        WriteLn(F,' </tr>');
        //
        Form7.IBDataSet99.Close;
        Form7.IBDataSet99.SelectSQL.Clear;
        Form7.IBDataSet99.SelectSQL.Add('select VENDEDOR, sum(MERCADORIA+SERVICOS-DESCONTO) from VENDAS, ICM where EMITIDA=''S'' and EMISSAO<='+QuotedStr(DateToStrInvertida(dFinal))+' and EMISSAO>='+QuotedStr(DateToStrInvertida(dInicio))+' and ICM.NOME=VENDAS.OPERACAO and ICM.INTEGRACAO<>'''' group by VENDEDOR');
        Form7.IBDataSet99.Open;
        Form7.IBDataSet99.First;
        //
        Form7.ibDataSet99.First;
        //
        Form7.IBDataSet100.Close;
        Form7.IBDataSet100.SelectSQL.Clear;
        Form7.IBDataSet100.SelectSQL.Add('select VENDEDOR, sum(TOTAL) from ALTERACA where DATA<='+QuotedStr(DateToStrInvertida(dFinal))+' and DATA>='+QuotedStr(DateToStrInvertida(dInicio))+' and (TIPO='+QuotedStr('BALCAO')+' or TIPO='+QuotedStr('VENDA')+') group by VENDEDOR');
        Form7.IBDataSet100.Open;
        Form7.IBDataSet100.First;
        //
        III := 0;
        //
        Form7.ibDataSet99999.Close;
        Form7.ibDataSet99999.SelectSQL.Clear;
        Form7.ibDataSet99999.SelectSQL.Add('select NOME, FOTO, REGISTRO from CLIFOR where Upper(CLIFOR)='+QuotedStr('VENDEDOR')+' order by upper(NOME)');
        Form7.ibDataSet99999.Open;
        Form7.ibDataSet99999.First;
        //
        Form7.ibDataSet99999.First;
        //
        while not Form7.ibDataSet99999.EOF do
        begin
          //
          Application.ProcessMessages;
          //
          //
          Form7.IBDataSet99.Locate('VENDEDOR',Form7.ibDataSet99999.FieldByname('NOME').AsString,[]);
          Form7.IBDataSet100.Locate('VENDEDOR',Form7.ibDataSet99999.FieldByname('NOME').AsString,[]);
          //
          if AllTrim(Form7.ibDataSet99999.FieldByName('NOME').AsString) = AllTrim(Form7.ibDataSet99.FieldByName('VENDEDOR').AsString) then fTotal1 := Form7.ibDataSet99.FieldByname('SUM').AsFloat else  fTotal1 := 0;
          if AllTrim(Form7.ibDataSet99999.FieldByName('NOME').AsString) = AllTrim(Form7.ibDataSet100.FieldByName('VENDEDOR').AsString) then fTotal2 := Form7.ibDataSet100.FieldByname('SUM').AsFloat else fTotal2 := 0;
          //
          if fTotal1 + fTotal2 <> 0 then
          begin
            //
            Form7.ibQuery2.Close;
            Form7.ibQuery2.SQL.Clear;
            Form7.ibQuery2.SQL.Add('select count(REGISTRO) from CLIFOR where CONTATOS like ''%('+ Form7.ibDataSet99999.FieldByname('NOME').AsString + ') '+StrZero(Year(dInicio),4,0)+'-'+StrZero(Month(dInicio),2,0)+'%''');
            Form7.ibQuery2.Open;
            //
            fTotal3 := Form7.ibQuery2.FieldByname('COUNT').AsFloat;
            //
            // Foto
            //
            if Form7.ibDataSet99999FOTO.BlobSize <> 0 then
            begin
              //
              BlobStream:= Form7.ibDataSet99999.CreateBlobStream(Form7.ibDataSet99999FOTO,bmRead);
              jp2 := TJPEGImage.Create;
              jp2.LoadFromStream(BlobStream);
              Form10.Image5.Picture.Assign(jp2);
              Form10.Image5.Picture.SaveToFile('_t_'+Form7.ibDataSet99999REGISTRO.AsString+'.jpg');
              //
            end
            else
              Form10.Image5.Picture := Form10.Image3.Picture;
            //
            Form10.Image5.Picture.SaveToFile('_t_'+Form7.ibDataSet99999REGISTRO.AsString+'.jpg');
            //
            if Form10.Image5.Picture.Width > Form10.Image5.Picture.Height then
            begin
              WriteLn(F,'<td '+{nowrap}' valign=top bgcolor=#FFFFFF align=right><img src="'+'_t_'+Form7.ibDataSet99999.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet99999.FieldByName('NOME').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (100 / Form10.Image5.Picture.Width)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (100 / Form10.Image5.Picture.Width)),10,0)+'></td>');
            end
            else
            begin
              WriteLn(F,'<td '+{nowrap}' valign=top bgcolor=#FFFFFF align=right><img src="'+'_t_'+Form7.ibDataSet99999.FieldByName('REGISTRO').AsString+'.jpg'+'" alt="'+AllTrim(Form7.ibDataSet99999.FieldByName('REGISTRO').AsString)+'" width='+StrZero((Form10.Image5.Picture.Width * (100 / Form10.Image5.Picture.Height)),10,0)+' Height='+StrZero((Form10.Image5.Picture.Height* (100 / Form10.Image5.Picture.Height)),10,0)+'></td>');
            end;
            //
            WriteLn(F,'    <td '+{nowrap}' valign=top bgcolor=#FFFFFF align=right><font face="Microsoft Sans Serif" size=1>'+Form7.ibDataSet99999.FieldByname('NOME').AsString+'</font></td>');
            WriteLn(F,'    <td '+{nowrap}' valign=top bgcolor=#FFFFFF align=right><font face="Microsoft Sans Serif" size=1>'+Format('%7.'+Form1.ConfCasas+'n',[fTotal1+fTotal2])+'<br></font></td>');
            WriteLn(F,'    <td '+{nowrap}' valign=top bgcolor=#FFFFFF align=right><font face="Microsoft Sans Serif" size=1>'+FloatToStr(fTotal3)+'<br></font></td>');
            WriteLn(F,'   </tr>');
            //
            III := III + 1;
            Mais1Ini.WriteString('DADOS','XY'+StrZero(III,2,0),'S1<'+
            StrTran(Format('%15.2n',[fTotal1+fTotal2]),'.','')
              +'>S2<'+'0,00'
                              +'>VX<'+StrZero(III,2,0)+'>LX<'+AllTrim(Copy(Form7.ibDataSet99999.FieldByname('NOME').AsString+Replicate(' ',20),1,20))+'>');
            //
            mais2Ini.WriteString('DADOS','XY'+StrZero(III,2,0),'S1<'+
            StrTran(Format('%15.2n',[fTotal3]),'.','')
              +'>S2<'+'0,00'
                              +'>VX<'+StrZero(III,2,0)+'>LX<'+AllTrim(Copy(Form7.ibDataSet99999.FieldByname('NOME').AsString+Replicate(' ',20),1,20))+'>');
            //
            fTotal  := fTotal + fTotal1+fTotal2;
            fTotalContatos := ftotalContatos + fTotal3;
            //
          end;
          //
          Form7.ibDataSet99999.Next;
          //
        end;
        //
        WriteLn(F,'<br>');              // Linha em branco
        WriteLn(F,'<br><font face="Microsoft Sans Serif" size=2 color=#000000><b>VENDAS</b></font>');
        WriteLn(F,'<center><a href="'+Form1.sAtual+'\vendedores.png"><img src="vendedores.png" border="0" width=800 height=400></a>');
        WriteLn(F,'<br><font face="Microsoft Sans Serif" size=2 color=#000000><b>CONTATOS</b></font>');
        WriteLn(F,'<center><a href="'+Form1.sAtual+'\contatos.png"><img src="contatos.png" border="0" width=800 height=400></a>');
        WriteLn(F,'<br>');              // Linha em branco
        //
        Mais1Ini.Free;
        Mais2Ini.Free;
        //
        ShellExecute( 0, 'Open', 'graficos.exe', 'vendedores.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
        while not FileExists(Form1.sAtual+'\vendedores.png') do
          Sleep(100);
        ShellExecute( 0, 'Open', 'graficos.exe', 'contatos.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
        while not FileExists(Form1.sAtual+'\contatos.png') do
          Sleep(100);
        //
        WriteLn(F,'  <tr bgcolor=#'+Form1.sHtmlCor+'   FF7F00>');
        WriteLn(F,'   <td '+{nowrap}' valign=top align=left><font face="Microsoft Sans Serif" size=1><br></font></td>');
        WriteLn(F,'   <td '+{nowrap}' valign=top align=left><font face="Microsoft Sans Serif" size=1><br></font></td>');
        WriteLn(F,'   <td '+{nowrap}' valign=top align=right><font face="Microsoft Sans Serif" size=1><b>'+ Format('%11.'+Form1.ConfPreco+'n',[fTotal])+'<br></font></td>');
        WriteLn(F,'   <td '+{nowrap}' valign=top align=right><font face="Microsoft Sans Serif" size=1><b>'+ FloatToStr(fTotalContatos)+'<br></font></td>');
        WriteLn(F,'  </tr>');
        WriteLn(F,' </table>');
        //
        Writeln(F,'<font face="Microsoft Sans Serif" size=1><br>Perodo analisado, de ' + DateTimeToStr(dInicio) + ' at ' + DateTimeToStr(dFinal)+'<br>');
        WriteLn(F,'</center>');
      except
        on E: Exception do
        begin
          WriteLn(F,'  <br>Erro: '+E.Message);
        end;
      end;
      //
      Form7.IBDataSet2.DisableControls;
      Form7.ibDataSet3.DisableControls;

      if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
      begin
        WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
      end else
      begin
        WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
      end;
      //
      WriteLn(F,'<font face="Microsoft Sans Serif" size=1><center>Tempo para gerar este relatrio: '+TimeToStr(Time - tInicio)+'</center>');
      if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
      WriteLn(F,'</html>');
      
      CloseFile(F);                                    // Fecha o arquivo

      Screen.Cursor := crDefault; // Cursor de Aguardo
    end;

    Screen.Cursor := crDefault; // Cursor de Aguardo
    Form7.ibDataset2.EnableControls;
    Form7.sModulo := 'CLIENTES';
    Form7.Close;
    Form7.Show;

    AbreArquivoNoFormatoCerto(pChar(Senhas.UsuarioPub+'.HTM'));
  except
  end;

  Screen.Cursor := crDefault; // Cursor de Aguardo
end;

procedure TForm7.ibDataSet4CESTSetText(Sender: TField; const Text: String);
var
  bButton : Integer;
  bForm10 : Integer;
begin
  try
    bButton := Application.MessageBox(pChar('Preencher automaticamente o CEST:'+TExt+' com NCM: '+ibDataSet4CF.AsString+Chr(10)),'Ateno',mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    //
    if bButton = IDYES  then
    begin
      Form7.IBQuery1.Close;
      Form7.IBQuery1.SQL.Clear;
      Form7.IBQuery1.SQL.Add('update ESTOQUE set CEST='+QuotedStr(Text)+' where CF='+QuotedStr(ibDataSet4CF.AsString)+' ');
      Form7.IBQuery1.Open;
      //
      if Form10.Active then
        bForm10 := 1
      else
        bForm10 := 0;
      
      Screen.Cursor            := crHourGlass;
      AgendaCommit(True);
      if bForm10 = 1 then
        Form10.Close;
      Form7.Close;
      Form7.Show;
      Form7.ibDataSet13.Edit;
      Screen.Cursor            := crDefault;
      //
      if bForm10 = 1 then
      begin
        Form10.Show;
        Form10.Orelhas.ActivePage := Form10.orelha_ICMS;
        Form10.ComboBox5.SetFocus;
      end;
    end else
    begin
      ibDataSet4CEST.AsString := Text;
    end;
  except
  end;
end;

procedure TForm7.btnRetornoCNAB400Click(Sender: TObject);
var
  I: Integer;
  f: TextFile;
  sBanco, sMensagem, sLinha: String;
  sDocumento: String;
  sDataDoCredito: String;
begin
  //
  sBanco := '000';
  //
  if not Form7.OpenDialog4.Execute then
    Exit;

  CHDir(Form1.sAtual); // Apontar devolta para a pasta do sistema Sandro Silva 2023-10-30

  if FileExists(Form7.OpenDialog4.FileName) then
  begin
    //
    AssignFile(f,Form7.OpenDialog4.FileName);
    Reset(f);
    //
    Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
    sMensagem := '';
    I := 0;
    //
    while not eof(f) Do
    begin
      //
      ReadLn(f,sLinha);
      //
      if Length(sLinha) = 400 then
      begin
        //
        if (Copy(sLinha,001,001) = '0') and (Copy(sLinha,003,007) = 'RETORNO') then // 03 Identificao Tipo de Operao RETORNO
        begin
          //
          // HEADER
          //
          //   Copy(sLinha,001,001); // 01 Identificao do Registro Header: 0
          //   Copy(sLinha,002,001); // 02 Tipo de Operao: 2
          //   Copy(sLinha,003,007); // 03 Identificao Tipo de Operao RETORNO
          //   Copy(sLinha,010,002); // 04 Identificao do Tipo de Servio: 01
          //   Copy(sLinha,012,008); // 05 Identificao por Extenso do Tipo de Servio:COBRANA
          //   Copy(sLinha,020,007); // 06 Complemento do Registro: Brancos
          //   Copy(sLinha,027,004); // 07 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,031,001); // 08 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,032,008); // 09 Cdigo do Cliente/Beneficirio: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,040,001); // 10 Dgito Verificador do Cdigo: vide planilha "Capa" deste arquivo
          //   Copy(sLinha,041,006); // 11 Nmero do convnio lder: Brancos
          //   Copy(sLinha,047,030); // 12 Nome do Beneficirio
          //   Copy(sLinha,077,018); // 13 Identificao do Banco: "756BANCOOBCED"
          //   Copy(sLinha,095,006); // 14 Data da Gravao do Retorno: formato ddmmaa
          //   Copy(sLinha,101,007); // 15 Seqencial do Retorno: nmero seqencial atribudo pelo Sicoob, acrescido de 1 a cada retorno. Inicia com "0000001"
          //   Copy(sLinha,108,287); // 16 Complemento do Registro: Brancos
          //   Copy(sLinha,395,006); // 17 Seqencial do Registro:000001
          //
          sBanco := Copy(sLinha,77,3);
          //
          sMensagem := sMensagem + 'Arquivo processado com sucesso.' + chr(10)+chr(10);
          //
        end;
        //
        if (Copy(sLinha,001,001) = '1') or (Copy(sLinha,001,001) = '7') then // and (Copy(sLinha,004,014) = cnpj do emitente) then // 03 Nmero do CPF/CNPJ do Beneficirio
        begin
          //
          // Copy(sLinha,001,001); // 01 Identificao do Registro Detalhe: 1 (um)
          // Copy(sLinha,002,002); // 02 "Tipo de Inscrio do Beneficirio: ""01"" = CPF ""02"" = CNPJ  "
          // Copy(sLinha,004,014); // 03 Nmero do CPF/CNPJ do Beneficirio
          // Copy(sLinha,018,004); // 04 Prefixo da Cooperativa: vide planilha "Capa" deste arquivo
          // Copy(sLinha,022,001); // 05 Dgito Verificador do Prefixo: vide planilha "Capa" deste arquivo
          // Copy(sLinha,023,008); // 06 Conta Corrente: vide planilha "Capa" deste arquivo
          // Copy(sLinha,031,001); // 07 Dgito Verificador da Conta: vide planilha "Capa" deste arquivo
          // Copy(sLinha,032,006); // 08 Nmero do Convnio de Cobrana do Beneficirio: "000000"
          // Copy(sLinha,038,025); // 09 Nmero de Controle do Participante: Brancos
          // Copy(sLinha,063,011); // 10 Nosso Nmero
          // Copy(sLinha,074,001); // 11 DV Nosso Nmero
          // Copy(sLinha,075,002); // 12 Nmero da Parcela
          // Copy(sLinha,077,004); // 13 Grupo de Valor: "00"
          // Copy(sLinha,081,002); // 14 Cdigo de Baixa/Recusa
          // Copy(sLinha,083,003); // 15 "Prefixo do Ttulo: Informa Espcie do Ttulo DM = Duplicata Mercantil CH = Cheque DS = Duplicata de Servio PC  = Parcela de Consrcio OU = Outros"
          // Copy(sLinha,086,003); // 16 Variao da Carteira: "000"
          // Copy(sLinha,089,001); // 17 Conta Cauo: "0"
          // Copy(sLinha,090,005); // 18 Cdigo de responsabilidade: "00000"
          // Copy(sLinha,095,001); // 19 DV do cdigo de responsabilidade: "0"
          // Copy(sLinha,096,005); // 20 Taxa de desconto
          // Copy(sLinha,101,005); // 21 Taxa de IOF
          // Copy(sLinha,106,001); // 22 Complemento do Registro: Brancos
          // Copy(sLinha,107,002); // 23 "Carteira/Modalidade: 01 = Simples Com Registro 02 = Simples Sem Registro 03 = Garantida Caucionada
          // Copy(sLinha,109,002); // 24 Comando/Movimento: 02 = Confirmao Entrada Ttulo;
          // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
          // Copy(sLinha,117,010); // 26 Seu Nmero/Nmero atribudo pela Empresa
          // Copy(sLinha,127,020); // 27 Complemento do Registro: Brancos
          // Copy(sLinha,147,006); // 28 Data Vencimento Ttulo: formato ddmmaa
          // Copy(sLinha,153,013); // 29 Valor Titulo
          // Copy(sLinha,166,003); // 30 Cdigo do banco recebedor: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
          // Copy(sLinha,169,004); // 31 Prefixo da agncia recebedora: Informado o prefixo de agncia do banco recebedor. Quando este prefixo no for informado, o campo vem preenchido com zeros
          // Copy(sLinha,173,001); // 32 DV prefixo recebedora
          // Copy(sLinha,174,002); // 33 "Espcie do Ttulo : 01 = Duplicata Mercantil
          // Copy(sLinha,176,006); // 34 Data do crdito: formato ddmmaa
          // Copy(sLinha,182,007); // 35 Valor da Tarifa
          // Copy(sLinha,189,013); // 36 Outras despesas
          // Copy(sLinha,202,013); // 37 Juros do desconto
          // Copy(sLinha,215,013); // 38 IOF do desconto
          // Copy(sLinha,228,013); // 39 Valor do abatimento
          // Copy(sLinha,241,013); // 40 Desconto concedido (diferena entre valor do ttulo e valor recebido)
          // Copy(sLinha,254,013); // 41 Valor recebido (valor recebido parcial)
          // Copy(sLinha,267,013); // 42 Juros de Mora
          // Copy(sLinha,280,013); // 43 Outros recebimentos
          // Copy(sLinha,293,013); // 44 Abatimento no aproveitado pelo Pagador
          // Copy(sLinha,306,013); // 45 Valor do Lanamento
          // Copy(sLinha,319,001); // 46 Indicativo dbito/crdito
          // Copy(sLinha,320,001); // 47 Indicativo valor
          // Copy(sLinha,321,012); // 48 Valor do Ajuste
          // Copy(sLinha,333,010); // 49 Complemento do Registro: Brancos
          // Copy(sLinha,343,014); // 50 CPF/CNPJ do Pagador
          // Copy(sLinha,358,038); // 51 Complemento do Registro: Brancos
          // Copy(sLinha,395,006); // 52 Seqencial do Registro: Incrementado em 1 a cada registro
          //
          // Copy(sLinha,111,006); // 25 Data da Entrada/Liquidao: formato ddmmaa
          //
          if (Copy(sLinha,109,002) = '06') or (Copy(sLinha,109,002) = '21') then // 24 Comando/Movimento: 06 = Liquidao Normal
          begin
            //
            if Copy(sLinha,254,013) <> '0000000000000' then // 41 Valor recebido (valor recebido parcial)
            begin
              sMensagem := sMensagem + 'Nmero documento: ' + Copy(sLinha,117,010) + ' Valor: R$ '+  FloatToStr(StrToFloat(Copy(sLinha,254,013))/100);

              sDocumento := AllTrim(Copy(sLinha,117,010)); // Sandro Silva 2022-12-21 Nmero do documento
              //
              Form7.ibDataSet7.Close;
              Form7.ibDataSet7.Selectsql.Clear;
              Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where DOCUMENTO='+QuotedStr(sDocumento)+' '); // Sandro Silva 2022-12-21 Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where DOCUMENTO='+QuotedStr(AllTrim(Copy(sLinha,117,010)))+' ');
              Form7.ibDataSet7.Open;
              //
              if Form7.ibDataSet7DOCUMENTO.AsString = sDocumento then // Sandro Silva 2022-12-21if Form7.ibDataSet7DOCUMENTO.AsString = AllTrim(Copy(sLinha,117,010)) then
              begin
                if Form7.ibDataSet7ATIVO.AsFloat < 5 then
                begin
                  if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                  begin
                    Form7.SMALL_DBEdit1.Visible := True;
                    Form7.Edit2.Text            := Form7.SMALL_DBEdit2.Text;
                    //
                    Form7.ibDataSet7.Edit;
                    Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat + 5;
                    //
                    if (sBanco = '033') or (sBanco = '353') then // Santander so 11 posicoes
                    begin
                      Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,254,011))/100;
                    end else
                    begin
                      Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,254,013))/100;
                    end;
                    //
                    Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'RECEBIDO';
                    {Sandro Silva 2022-12-21 inicio}
                    sDataDoCredito := Copy(sLinha, 176, 6); // Data do crdito: formato ddmmaa
                    sDataDoCredito := Copy(sDataDoCredito, 1, 2) + '/' + Copy(sDataDoCredito, 3, 2) + '/' + Copy(sDataDoCredito, 5, 2);
                    if StrToDateDef(sDataDoCredito, StrToDate('30/12/1899')) <> StrToDate('30/12/1899') then
                    begin
                      Form7.ibDataSet7MOVIMENTO.AsDateTime := StrToDate(sDataDoCredito);
                    end;
                    {Sandro Silva 2022-12-21 fim}
                    //
                    Form7.ibDataSet7.Post;
                    //
                    Form1.IBDataSet200.Close;
                    Form1.IBDataSet200.Open;
                    //
                    Form7.ibQuery1.Close;
                    Form7.IBQuery1.SQL.Clear;
                    Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
                    Form7.IBQuery1.Open;
                    //
                    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
                    Form7.Panel10.Repaint;
                    //
                    Form7.ibDataSet25DIFERENCA_.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat +  StrToFloat(Copy(sLinha,254,013))/100;
                    Form7.ibDataSet25DIFERENCA_.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat)); // Sandro Silva 2023-10-30 
                    //
                    SMALL_DBEdit1.SetFocus;
                    I := I + 1;
                    //
                  end else
                  begin
                    sMensagem := sMensagem + ' documento j estava quitado. ';
                  end;
                end else
                begin
                  sMensagem := sMensagem + ' documento j estava marcado. ';
                end;
                //
                sMensagem := sMensagem + chr(10);
              end else
              begin
                sMensagem := sMensagem + ' documento no encontrado '+chr(10);
              end;
            end;
          end;
        end;
      end else
      begin
        //ShowMessage('Aquivo fora do padro CNAB 400'); Mauricio Parizotto 2023-10-25
        MensagemSistema('Aquivo fora do padro CNAB 400',msgAtencao);
        Exit;
      end;
    end;
    
    CloseFile(F);
    begin
      sMensagem := sMensagem + chr(10) + chr(10) +
      'Duplicatas recebidos: '+ IntToStr(I )+chr(10)+chr(10) +
      'Total recebido R$: '+Form7.ibDataSet25DIFERENCA_.AsString+chr(10)+chr(10);
      //ShowMessage(sMensagem); Mauricio Parizotto 2023-10-25
      MensagemSistema(sMensagem);
    end;

    Form7.SMALL_DBEdit6.SetFocus;
  end;
end;

procedure TForm7.Baixaestacontanobanco1Click(Sender: TObject);
begin
  if UpperCase(Copy(Form7.ibDataSet7PORTADOR.AsString,1,7)) = 'BANCO (' then
  begin
    if Pos(Form7.ibDataSet7PORTADOR.AsString,'RECEBIDO') = 0 then
    begin
      Form7.ibDataSet7.Edit;
      Form7.ibDataSet7PORTADOR.AsString := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'BAIXA';
      Form7.ibDataSet7.Post;
    end;
  end;
end;

procedure TForm7.IBDataSet2CREDITOSetText(Sender: TField;
  const Text: String);
begin
  if (Form1.iReduzida = 1) then
  begin
    IBDataSet2CREDITO.AsString := '';
    //Application.MessageBox('Este campo no pode ser alterado nesta verso do SMALL.' + Chr(13) + Chr(13) + 'Para controlar o limite de crdito  necessrio liberar a verso SMALL COMMERCE.', 'Ateno', MB_OK + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
    MensagemSistema('Este campo no pode ser alterado nesta verso do SMALL.' + Chr(13) + Chr(13) + 'Para controlar o limite de crdito  necessrio liberar a verso SMALL COMMERCE.'
                    ,msgAtencao);
  end else
  begin
    IBDataSet2CREDITO.AsString := Text;
  end;
end;

procedure TForm7.Vendas_XXXClick(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);

  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie '+Form1.sSerieEspecial;
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo

  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE XXX');
  Mais1Ini.Free;
  //sSerieNFSelecionada := Form1.sSerieEspecial;
end;

procedure TForm7.NotasfiscaisdesadavendassrieXXX1Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);

  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) srie '+Form1.sSerieEspecial;
  Form7.sRPS := 'N';
  Form7.Show;
  Screen.Cursor := crDefault; // Cursor de Aguardo
  
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE XXX');
  Mais1Ini.Free;
end;

procedure TForm7.miRelProdMonofasicosCupomClick(Sender: TObject);
begin
  frmRelProdMonofasicoCupom := TfrmRelProdMonofasicoCupom.Create(nil);
  try
    frmRelProdMonofasicoCupom.Transaction := IBTransaction1;
    frmRelProdMonofasicoCupom.Usuario     := UsuarioLogado;
    frmRelProdMonofasicoCupom.Imagem      := imgImprimir.Picture;
    frmRelProdMonofasicoCupom.ShowModal;
  finally
    FreeAndNil(frmRelProdMonofasicoCupom);
  end;
end;

procedure TForm7.ibDataSet4CFSetText(Sender: TField; const Text: String);
begin
  Form7.ibDataSet4CF.AsString := AllTrim(Copy(Text + '        ',1,8));
end;

procedure TForm7.AnliseMensal1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  I : Integer;
  F: TextFile;
begin
  Form7.ibDataSet1.DisableControls;

  try
    CriaJpg('logotip.jpg');

    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
    {$ENDIF}


    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE MENSAL DE '+IntToStr(Year(DATE))+'</b></font>');
    WriteLn(F,'<center>');   // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    // Faturamento
    //
    DeleteFile(pChar(Form1.sAtual+'\faturamento.gra'));
    DeleteFile(pChar(Form1.sAtual+'\faturamento.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\faturamento.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','faturamento.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Receita');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    Form1.ibQuery1.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as FATURAMENTO, extract(month from CAIXA.DATA) as MES from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=1 and CAIXA.NOME=CONTAS.NOME and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' group by extract(month from CAIXA.DATA) order by extract(month from CAIXA.DATA)');
    Form1.ibQuery1.Open;
    //
    for I := 1 to 12 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(I),1,3)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(StrToInt(Form1.ibQuery1.FieldByName('MES').AsString)),1,3) +'>');
      Form1.ibQuery1.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','faturamento.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\faturamento.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\faturamento.png"><img src="faturamento.png" border="0" width=500 height=250></a>');
    //
    // Despesas
    //
    DeleteFile(pChar(Form1.sAtual+'\despesas.gra'));
    DeleteFile(pChar(Form1.sAtual+'\despesas.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\despesas.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','despesas.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Despesa');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery2.Close;
    Form1.ibQuery2.SQL.Clear;
    Form1.ibQuery2.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as despesas, extract(month from CAIXA.DATA) as MES from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=3 and CAIXA.NOME=CONTAS.NOME and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' group by extract(month from CAIXA.DATA) order by extract(month from CAIXA.DATA)');
    Form1.ibQuery2.Open;
    //
    for I := 1 to 12 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(I),1,3)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery2.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(StrToInt(Form1.ibQuery2.FieldByName('MES').AsString)),1,3) +'>');
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','despesas.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\despesas.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\despesas.png"><img src="despesas.png" border="0" width=500 height=250></a>');
    //
    // Lucro
    //
    DeleteFile(pChar(Form1.sAtual+'\lucro.gra'));
    DeleteFile(pChar(Form1.sAtual+'\lucro.png'));
    //                               //
    // cria o grfico de receber.png //
    //                               //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\lucro.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','lucro.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Lucro');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','250');
    Mais1Ini.WriteString('DADOS','LarguraBmp','500');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); 
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    for I := 1 to 12 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(I),1,3)+'>');
    end;
    //
    I := 0;
    //
    Form1.ibQuery1.First;
    Form1.ibQuery2.First;
    //
    while not Form1.ibQuery1.Eof do
    begin
      //
      I := I + 1;
      //
      if Form1.ibQuery2.FieldByName('MES').AsString = Form1.ibQuery1.FieldByName('MES').AsString then
      begin
        Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                     'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(MesExtenso(StrToInt(Form1.ibQuery1.FieldByName('MES').AsString)),1,3) +'>');
      end;
      //
      Form1.ibQuery1.Next;
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','lucro.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\lucro.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\lucro.png"><img src="lucro.png" border="0" width=500 height=250></a>');
    //
    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');
    //
    WriteLn(F,'<br>');              // Linha em branco
    //
    // WWW
    //
    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
    //
  except end;
  //
  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
  //
end;

procedure TForm7.ibDataSet15BeforePost(DataSet: TDataSet);
begin
  //
  AssinaRegistro('VENDAS',DataSet, True);
  //
end;

procedure TForm7.ibDataSet13BeforePost(DataSet: TDataSet);
begin
  AssinaRegistro('EMITENTE',DataSet, True);
end;

procedure TForm7.ibDataSet7PORTADORSetText(Sender: TField;
  const Text: String);
var
  MyBookmark: TBookmark;
begin
  if Form7.sModulo = 'VENDA' then // Ok
  begin
    try
      begin
        if Pos('|' + Copy(Form7.ibDataSet7FORMADEPAGAMENTO.AsString, 1, 2) + '|', '||15|') > 0 then
        begin

          MyBookmark    := Form7.ibDataSet7.GetBookmark;

          Form7.ibDataSet7.DisableControls;
          Form7.ibDataSet7.First;
          //
          while not Form7.ibDataSet7.Eof do
          begin
            //{Sandro Silva 2023-07-05 inicio
            if Text <> Form7.ibDataSet7PORTADOR.AsString then
            begin
              Form7.ibDataSet7.Edit;
              Form7.ibDataSet7PORTADOR.AsString := Text;
            end;
            {
            if Pos('|' + Copy(Form7.ibDataSet7FORMADEPAGAMENTO.AsString, 1, 2) + '|', '||15|') > 0 then
            begin
              if Text <> Form7.ibDataSet7PORTADOR.AsString then
              begin
                Form7.ibDataSet7.Edit;
                Form7.ibDataSet7PORTADOR.AsString := Text;
              end;
            end;
            {Sandro Silva 2023-07-05 inicio}
            Form7.ibDataSet7.Next;
            //
          end;
          //
          Form7.ibDataSet7.Edit;
          //
          Form7.ibDataSet7.GotoBookmark(MyBookmark);
          Form7.ibDataSet7.FreeBookmark(MyBookmark);
          Form7.ibDataSet7.EnableControls;
        end
        else
          Form7.ibDataSet7PORTADOR.AsString := Text;

      end;
    except
    end;
  end else
  begin
    Form7.ibDataSet7PORTADOR.AsString := Text;
  end;
end;

procedure TForm7.Anlisediaria1Click(Sender: TObject);
var
  Mais1Ini: TIniFile;
  I : Integer;
  F: TextFile;
begin
  Form7.ibDataSet1.DisableControls;

  try
    CriaJpg('logotip.jpg');

    {$IFDEF VER150}
    ShortDateFormat := 'dd/mm/yyyy';
    {$ELSE}
    FormatSettings.ShortDateFormat := 'dd/mm/yyyy';
    {$ENDIF}

    AssignFile(F,pChar(Senhas.UsuarioPub+'.HTM'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                           // Abre para gravao
    Writeln(F,'<html><head><title>'+AnsiUpperCase(AllTrim(Form7.ibDataSet13NOME.AsString)+' - '+Form7.Caption)+'</title></head>');
    WriteLn(F,'<body bgcolor="#FFFFFF" vlink="#FF0000" leftmargin="0"><center>');
    WriteLn(F,'<img src="logotip.jpg" alt="'+AllTrim(Form7.ibDataSet13NOME.AsString)+'">');
    WriteLn(F,'<br><font face="verdana" size=2 color=#000000><b>'+AllTrim(Form7.ibDataSet13NOME.AsString)+'</b></font>');
    WriteLn(F,'<br><font face="verdana" size=3 color=#000000><b>ANLISE DIRIA DO MS DE ' + UpperCase(Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2))))) + ' DE ' + Copy(DateTimeToStr(Date),7,4) + '</b></font>');
    WriteLn(F,'<center>');   // Linha em branco
    //
    Screen.Cursor := crHourGlass; // Cursor de Aguardo
    //
    // Faturamento
    DeleteFile(pChar(Form1.sAtual+'\faturamento.gra'));
    DeleteFile(pChar(Form1.sAtual+'\faturamento.png'));
    //                               //
    // cria o grfico de receber.png //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\faturamento.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','faturamento.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Receita');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','300');
    Mais1Ini.WriteString('DADOS','LarguraBmp','600');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery1.Close;
    Form1.ibQuery1.SQL.Clear;
    Form1.ibQuery1.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as FATURAMENTO, CAIXA.DATA as DIA from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=1 and CAIXA.NOME=CONTAS.NOME and extract(month from CAIXA.DATA)='+QuotedStr(IntToStr(Month(DATE)))
    +' and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' '
    +' group by CAIXA.DATA order by CAIXA.DATA');
    Form1.ibQuery1.Open;
    //
    for I := 1 to 30 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ StrZero(I,2,0)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('FATURAMENTO').AsFloat ]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(Form1.ibQuery1.FieldByName('DIA').AsString,1,2) +'>');
      Form1.ibQuery1.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','faturamento.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\faturamento.png') do sleep(10);
    WriteLn(F,'     <br><a href="'+Form1.sAtual+'\faturamento.png"><img src="faturamento.png" border="0" width=500 height=250></a>');
    //
    // Despesas
    DeleteFile(pChar(Form1.sAtual+'\despesas.gra'));
    DeleteFile(pChar(Form1.sAtual+'\despesas.png'));
    //                               //
    // cria o grfico de receber.png //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\despesas.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','despesas.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Despesa');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','300');
    Mais1Ini.WriteString('DADOS','LarguraBmp','600');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20'); //'11577023' // '15381040'
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    Form1.ibQuery2.Close;
    Form1.ibQuery2.SQL.Clear;

    Form1.ibQuery2.SQL.Add('select sum(CAIXA.ENTRADA-CAIXA.SAIDA) as DESPESAS, CAIXA.DATA as DIA from CAIXA, CONTAS'
    +' where substring(CONTAS.CONTA from 1 for 1)=3 and CAIXA.NOME=CONTAS.NOME and extract(month from CAIXA.DATA)='+QuotedStr(IntToStr(Month(DATE)))
    +' and extract(year from CAIXA.DATA)='+QuotedStr(IntToStr(Year(DATE)))+' '
    +' group by CAIXA.DATA order by CAIXA.DATA');
    Form1.ibQuery2.Open;
    //
    for I := 1 to 30 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ StrZero(I,2,0)+'>');
    end;
    //
    I := 0;
    //
    while not Form1.ibQuery2.Eof do
    begin
      I := I + 1;
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery2.FieldByName('despesas').AsFloat * -1]),'.','')+'>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(Form1.ibQuery2.FieldByName('DIA').AsString,1,2) +'>');
      Form1.ibQuery2.Next;
    end;
    //
    ShellExecute( 0, 'Open', 'graficos.exe','despesas.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\despesas.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\despesas.png"><img src="despesas.png" border="0" width=500 height=250></a>');
    //
    // Lucro
    DeleteFile(pChar(Form1.sAtual+'\lucro.gra'));
    DeleteFile(pChar(Form1.sAtual+'\lucro.png'));
    //                               //
    // cria o grfico de receber.png //
    Mais1ini := TIniFile.Create(Form1.sAtual+'\lucro.gra');
    Mais1Ini.WriteString('DADOS','3D','1');
    Mais1Ini.WriteString('DADOS','NomeBmp','lucro.png');
    Mais1Ini.WriteString('DADOS','TituloY','');
    Mais1Ini.WriteString('DADOS','TipoS1','0');
    Mais1Ini.WriteString('DADOS','Titulo','Lucro');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','Legenda','0');
    Mais1Ini.WriteString('DADOS','MarcasS1','0');
    Mais1Ini.WriteString('DADOS','TituloX','');
    Mais1Ini.WriteString('DADOS','AlturaBmp','300');
    Mais1Ini.WriteString('DADOS','LarguraBmp','600');
    Mais1Ini.WriteString('DADOS','CorS1','$008FC26C'); // Verde
    Mais1Ini.WriteString('DADOS','TituloSerie1','');
    Mais1Ini.WriteString('DADOS','FontSize','20');
    Mais1Ini.WriteString('DADOS','FontSizeLabel','8');
    //
    for I := 1 to 30 do
    begin
      Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                   'S1<          0,00>'+
                                   'S2<          0,00>'+
                                   'VX<'+StrZero(I,2,0)+'>LX<'+ StrZero(I,2,0)+'>');
    end;
    //
    I := 0;
    //
    Form1.ibQuery1.First;
    Form1.ibQuery2.First;
    //
    while not Form1.ibQuery1.Eof do
    begin
      I := I + 1;
      //
      if Form1.ibQuery2.FieldByName('DIA').AsString = Form1.ibQuery1.FieldByName('DIA').AsString then
      begin
        Mais1Ini.WriteString('DADOS','XY'+StrZero(I,2,0),
                                     'S1<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'S2<'+StrTran(Format('%15.2n',[ Form1.ibQuery1.FieldByName('faturamento').AsFloat + Form1.ibQuery2.FieldByName('despesas').AsFloat]),'.','')+'>'+
                                     'VX<'+StrZero(I,2,0)+'>LX<'+ Copy(Form1.ibQuery1.FieldByName('DIA').AsString,1,2) +'>');
      end;
      //
      Form1.ibQuery1.Next;
      Form1.ibQuery2.Next;
    end;

    ShellExecute( 0, 'Open', 'graficos.exe','lucro.gra SMALLSOFT', '', SW_SHOWMINNOACTIVE);
    while not FileExists(Form1.sAtual+'\lucro.png') do sleep(10);
    WriteLn(F,'     <br><br><a href="'+Form1.sAtual+'\lucro.png"><img src="lucro.png" border="0" width=500 height=250></a>');

    WriteLn(F,'<br><font face="Microsoft Sans Serif" size=1>Gerado em '+Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
      + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
      + Copy(DateTimeToStr(Date),7,4) + ' s ' + TimeToStr(Time)+'</font><font face="Microsoft Sans Serif" size=1><br>');

    WriteLn(F,'<br>');              // Linha em branco

    if (Alltrim(Form7.ibDataSet13HP.AsString) = '') then
    begin
      WriteLn(F,'<font face="verdana" size=1><center>Relatrio gerado pelo sistema Smallsoft, <a href="http://www.smallsoft.com.br"> www.smallsoft.com.br</a><font>'); // Ok
    end else
    begin
      WriteLn(F,'<font face="verdana" size=1><center><a href="http://'+Form7.ibDataSet13HP.AsString+'">'+Form7.ibDataSet13HP.AsString+'</a><font>');
    end;
    //
    if not Form1.bPDF then WriteLn(F,'<a href="http://www.smallsoft.com.br/meio_ambiente.htm"><center><font face="Webdings" size=5 color=#215E21>P<font face="Microsoft Sans Serif" size=1 color=#215E21> Antes de imprimir, pense no meio ambiente.</center></a>');
    WriteLn(F,'</center>');
    WriteLn(F,'</html>');
    CloseFile(F);                                    // Fecha o arquivo
    //
    Form7.Close;
    Form7.Show;
  except
  end;

  Screen.Cursor := crDefault; // Cursor de Aguardo
  Form7.ibDataSet1.EnableControls;
  AbreArquivoNoFormatoCerto(Senhas.UsuarioPub);
end;

procedure TForm7.btnRetornoCNAB240Click(Sender: TObject);
var
  I: Integer;
  f: TextFile;
  sDocumento, sBanco, sMensagem, sLinha: String;
  sDataDoCredito: String; // Sandro Silva 2022-12-21
begin
  sBanco := '000';

  if not Form7.OpenDialog4.Execute then
    Exit;

  CHDir(Form1.sAtual); // Apontar devolta para a pasta do sistema Sandro Silva 2023-10-30

  if FileExists(Form7.OpenDialog4.FileName) then
  begin
    Form7.ibDataSet7.DisableControls;

    AssignFile(f, Form7.OpenDialog4.FileName);
    Reset(f);

    Form7.ibDataSet25DIFERENCA_.AsFloat := 0;
    sMensagem := '';
    I := 0;

    while not Eof(f) Do
    begin
      ReadLn(f,sLinha);  // Lendo a primeira linha do documento retornado. Obtem o cdigo do banco, nmero do documento e o cdigo de movimento de retorno

      if Length(sLinha) = 240 then //  CNAB 240
      begin
        sBanco := Copy(sLinha,1,3);

        if (Copy(sLinha,014,01) = 'T') then
        begin
          sDocumento := AllTrim(Copy(sLinha,59,15));

          if Copy(sLinha,016,02) = '06' then // Cdigo de movimento de retorno 06 - Liquidao
          begin
            Form7.ibDataSet7.Close;
            Form7.ibDataSet7.Selectsql.Clear;
            Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where DOCUMENTO='+QuotedStr(sDocumento)+' ');
            Form7.ibDataSet7.Open;

            if Form7.ibDataSet7DOCUMENTO.AsString = sDocumento then
            begin
              ReadLn(f,sLinha); // Avana alinha para ler os detalhes do documento

              if (Copy(sLinha,014,01) = 'U') then  // U Registro detalhe
              begin
                if Form7.ibDataSet7ATIVO.AsFloat < 5 then
                begin
                  sMensagem := sMensagem + 'Nmero documento: ' + sdocumento + ' Valor: R$ '+  FloatToStr(StrToFloat(Copy(sLinha,78,015))/100);

                  if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                  begin
                    Form7.SMALL_DBEdit1.Visible := True;
                    Form7.Edit2.Text            := Form7.SMALL_DBEdit2.Text;

                    Form7.ibDataSet7.Edit;
                    Form7.ibDataSet7ATIVO.AsFloat := Form7.ibDataSet7ATIVO.AsFloat +5;

                    Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(Copy(sLinha,78,015))/100;
                    //Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(FormatFloat('0.00', StrToFloat(Copy(sLinha,78,015)) / 100)); // Sandro Silva 2023-10-30 StrToFloat(Copy(sLinha,78,015))/100;
                    Form7.ibDataSet7VALOR_RECE.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet7VALOR_RECE.AsFloat)); // Sandro Silva 2023-10-31
                    Form7.ibDataSet7PORTADOR.AsString  := Copy(Form7.ibDataSet7PORTADOR.AsString+'(000)',1,11)+'RECEBIDO';
                    {Sandro Silva 2022-12-21 inicio}
                    sDataDoCredito := Copy(sLinha, 146, 8);
                    sDataDoCredito := Copy(sDataDoCredito, 1, 2) + '/' + Copy(sDataDoCredito, 3, 2) + '/' + Copy(sDataDoCredito, 5, 4);
                    if StrToDateDef(sDataDoCredito, StrToDate('30/12/1899')) <> StrToDate('30/12/1899') then
                    begin
                      Form7.ibDataSet7MOVIMENTO.AsDateTime := StrToDate(sDataDoCredito);
                    end;
                    {Sandro Silva 2022-12-21 fim}

                    Form7.ibDataSet7.Post;

                    Form1.IBDataSet200.Close;
                    Form1.IBDataSet200.Open;

                    Form7.ibQuery1.Close;
                    Form7.IBQuery1.SQL.Clear;
                    Form7.IBQuery1.SQL.Add('select sum(VALOR_RECE) from RECEBER where ATIVO >= 5');
                    Form7.IBQuery1.Open;

                    Form7.Panel10.Caption := 'R$'+Format('%14.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat]);
                    Form7.Panel10.Repaint;

                    Form7.ibDataSet25DIFERENCA_.AsFloat := Form7.ibDataSet25DIFERENCA_.AsFloat +  Form7.ibDataSet7VALOR_RECE.AsFloat;
                    Form7.ibDataSet25DIFERENCA_.AsFloat := StrToFloat(FormatFloat('0.00', Form7.ibDataSet25DIFERENCA_.AsFloat));// Sandro Silva 2023-10-30

                    SMALL_DBEdit1.SetFocus;
                    I := I + 1;
                  end else
                  begin
                    sMensagem := sMensagem + ' documento j estava quitado. ';
                  end;
                end else
                begin
                  sMensagem := sMensagem + ' documento j estava marcado. ';
                end;
              end;
              
              sMensagem := sMensagem + chr(10);
            end else
            begin
              sMensagem := sMensagem + ' documento no encontrado '+chr(10);
              ReadLn(f,sLinha);
            end;
          end else
          begin
            //  sMensagem := sMensagem +
          end;
        end;
      end else
      begin
        //ShowMessage('Aquivo fora do padro CNAB 240'); Mauricio Parizotto 2023-10-25
        MensagemSistema('Aquivo fora do padro CNAB 240');
        Exit;
      end;
    end;

    CloseFile(F);

    Form7.ibDataSet7.Close;
    Form7.ibDataSet7.Selectsql.Clear;
    Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where ATIVO>=5');
    Form7.ibDataSet7.Open;

    Form7.ibDataSet7.Enablecontrols;

    sMensagem := sMensagem + chr(10) + chr(10) +
      'Duplicatas recebidos: '+ IntToStr(I )+chr(10)+chr(10) +
      'Total recebido R$: '+Form7.ibDataSet25DIFERENCA_.AsString+chr(10)+chr(10);

    //ShowMessage(sMensagem); Mauricio Parizotto 2023-10-25
    MensagemSistema(sMensagem);

    Form7.SMALL_DBEdit6.SetFocus;
  end;
end;

procedure TForm7.ConsultarNFesemitidasparameuCNPJ1Click(Sender: TObject);
var
  sHora, sData, sRetorno : String;
  Mais1Ini : tIniFile;
begin
  if Form1.ValidaRecursos.PermiteRecursoParaProduto then // Sandro Silva 2023-05-31
  begin
    Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
    sHora    := Mais1Ini.ReadString('Outros','HoraConsultarDistribuicao','00:00:00');
    sData    := Mais1Ini.ReadString('Outros','DataConsultarDistribuicao','26/09/1967');
    Mais1Ini.Free;

    // Bloquear por uma hora
    if (( StrToTime(sHora) + StrToTime('01:00:00')  )  < Time) or (sData <> DateToStr(Date)) then
    begin
      // Bloquear por uma hora
      Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
      Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao',TimeToStr(Time));
      Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
      Mais1Ini.Free;
      
      // Alterado para permitir matriz e filial com o mesmo certificado
      // CNPJ raz do certificado  igual ao CNPJ raz do emitente
      if (Copy(FormataCpfCgc(Form1.GetCNPJCertificado(Form7.spdNFe.NomeCertificado.Text)),1,10)= Copy(Form7.ibDataset13CGC.AsString,1,10)) or (Form1.GetCNPJCertificado(Form7.spdNFe.NomeCertificado.Text)='')  then
      begin
        // Bloquear por uma hora
        Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
        Mais1Ini.WriteString('Outros','HoraConsultarDistribuicao',TimeToStr(Time));
        Mais1Ini.WriteString('Outros','DataConsultarDistribuicao',DateToStr(Date));
        Mais1Ini.Free;

        // Alterado para permitir matriz e filial com o mesmo certificado
        // CNPJ raz do certificado  igual ao CNPJ raz do emitente
        if (Copy(FormataCpfCgc(Form1.GetCNPJCertificado(Form7.spdNFe.NomeCertificado.Text)),1,10)= Copy(Form7.ibDataset13CGC.AsString,1,10)) or (Form1.GetCNPJCertificado(Form7.spdNFe.NomeCertificado.Text)='')  then
        begin
          Screen.Cursor            := crHourGlass;

          try
            // Cdigo da UF
            ibDataset99.Close;
            ibDataset99.SelectSql.Clear;
            ibDataset99.SelectSQL.Add('select * from MUNICIPIOS where NOME='+QuotedStr(ibDataSet13MUNICIPIO.AsString)+' '+' and UF='+QuotedStr(UpperCase(ibDataSet13ESTADO.AsString))+' ');
            ibDataset99.Open;

            Form1.ibQuery2.Close;
            Form1.ibQuery2.SQL.Clear;
            Form1.ibQuery2.SQL.Add('select gen_id(G_NSU_DOWNLOAD_XML,0) from rdb$database');
            Form1.ibQuery2.Open;

            sRetorno := spdNFe.ConsultarDistribuicaoDFe(
                               pChar(Copy(ibDAtaSet99.FieldByname('CODIGO').AsString,1,2)),
                               pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)),
                               StrTran(StrZero(StrToInt(Form1.ibQuery2.FieldByname('GEN_ID').AsString),15,0),'-','0'),
                               nkUltimo
                               );


            //LogRetaguarda('31154 retorno ConsultarDistribuicaoDFe() ' + sRetorno);

            // Erro do vdeo
            Form7.ibDataSet23.DisableControls;
            //LogRetaguarda('unit7 ibDataSet23.DisableControls 31199'); // Sandro Silva 2023-12-04
            Form7.ibDataSet4.DisableControls;

            // Erro do vdeo
            DownloadListaDeNFesEmitidas(sRetorno); // Baixa uma lista de nf-es que foram emitidas para o CNPJ

            Form7.ibDataSet23.EnableControls;
            //LogRetaguarda('unit7 ibDataSet23.EnableControls 31206'); // Sandro Silva 2023-12-04
            Form7.ibDataSet4.EnableControls;
          except
            on E: Exception do
            begin
              //ShowMessage('Erro 38778 ao baixar lista de NF-es emitidas: '+E.Message); Mauricio Parizotto 2023-10-25
              MensagemSistema('Erro 38778 ao baixar lista de NF-es emitidas: '+E.Message,msgErro);
            end
          end;

          Screen.Cursor            := crDefault;
        end;
      end;

      Form7.ibDataSet24.DisableControls;

      //LogRetaguarda('ibDataSet24.DisableControls; 31183'); // Sandro Silva 2023-11-27

      try
        Form7.ibDataSet24.Close;
        Form7.ibDataSet24.SelectSQL.Clear;
        Form7.ibDataSet24.SelectSQL.Add('select * from COMPRAS where coalesce(NFEID,''0000000000000000000000000000000000000000000'')<>''0000000000000000000000000000000000000000000'' and coalesce(NFEXML,''X.X'')=''X.X'' and MERCADORIA=0 and EMISSAO >= (current_date - 11) ');
        Form7.ibDataSet24.Open;
      except
      end;

      // Faz a cincia da operao automaticamente
      try
        Form7.ibDataSet24.First;

        while not Form7.ibDataSet24.Eof do
        begin
          Manifesto(2); // 2: Cincia da operao
          Form7.ibDataSet24.Next;
        end;
      except
      end;

      Form7.ibDataSet24.EnableControls;

      //LogRetaguarda('Form7.ibDataSet24.EnableControls; 31213'); // Sandro Silva 2023-11-27

    end else
    begin
      Form22.Label6.Caption := 'ltima consulta de NF-es emitidas para o CNPJ: '+Form7.ibDataSet13CGC.AsString+' foi as '+sHora+
                                Form7.GetMensagemCertificado('ABERTURA');
      Form22.Label6.Width   := Screen.Width;
      Form22.Label6.Repaint;
    end;
  end;
end;

procedure TForm7.VisualizarXMLdamanifestaododestinatrio1Click(
  Sender: TObject);
var
  F : TextFile;
begin
  if (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)<>0) and (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) then
  begin
    AssignFile(F,pchar(Form1.sAtual+'\tempo.xml'));  // Direciona o arquivo F para EXPORTA.TXT
    Rewrite(F);                  // Abre para gravao
    WriteLn(F,Form7.ibDataSet24MDESTINXML.AsString);
    CloseFile(F); // Fecha o arquivo
    ShellExecute( 0, 'Open','tempo.xml','','', SW_SHOWMAXIMIZED);
    Screen.Cursor            := crDefault;
  end;
end;

procedure TForm7.DBGrid1CellClick(Column: TColumn);
begin
  Screen.Cursor            := CrDefault;
end;

procedure TForm7.EnviarmensagemWhatsAppparatodos1Click(Sender: TObject);
var
  sSecoes :  TStrings;
  sParcelas, sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, YY, J : Integer;
  sMandados : String;
  MyBookMark1 : TBookMark;
begin
  Form40.MaskEdit1.Visible := False;
  Form40.Edit1.Visible     := False;
  Form40.Label1.Visible    := False;
  Form40.Label3.Visible    := False;
  Form40.Label4.Visible    := False;
  Form40.Caption           := 'Enviar WhatsApp';
  Form40.CheckBox1.Visible := False;
  Form40.OpenDialog1.FileName := '';
  Form40.Tag := 9;

  Form40.Memo2.Lines.Clear;
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<NOME>');
  Form40.Memo2.Lines.Add('<CONTATO>');
  Form40.Memo2.Lines.Add('<IE>');
  Form40.Memo2.Lines.Add('<CGC>');
  Form40.Memo2.Lines.Add('<ENDERECO>');
  Form40.Memo2.Lines.Add('<BAIRRO>');
  Form40.Memo2.Lines.Add('<CIDADE>');
  Form40.Memo2.Lines.Add('<UF>');
  Form40.Memo2.Lines.Add('<CEP>');
  Form40.Memo2.Lines.Add('<FONE>');
  Form40.Memo2.Lines.Add('<FAX>');
  Form40.Memo2.Lines.Add('<EMAIL>');
  Form40.Memo2.Lines.Add('<OBS>');
  Form40.Memo2.Lines.Add('<CELULAR>');
  Form40.Memo2.Lines.Add('<CREDITO>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR1>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR2>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR3>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR4>');
  Form40.Memo2.Lines.Add('<IDENTIFICADOR5>');
  Form40.Memo2.Lines.Add('<CONVENIO>');
  Form40.Memo2.Lines.Add('<DATANAS>');
  Form40.Memo2.Lines.Add('<CADASTRO>');
  Form40.Memo2.Lines.Add('<ULTIMA COMPRA>');
  Form40.Memo2.Lines.Add('<LOCAL_E_DATA>');
  Form40.Memo2.Lines.Add('<TELEFONE_DO_EMITENTE>');
  Form40.Memo2.Lines.Add('<NOME_EMITENTE>,');
  Form40.Memo2.Lines.Add('<ENDERECO_EMITENTE>,');
  Form40.Memo2.Lines.Add('<BAIRRO_EMITENTE>,');
  Form40.Memo2.Lines.Add('<CEP_EMITENTE>,');
  Form40.Memo2.Lines.Add('<CIDADE_EMITENTE>,');
  Form40.Memo2.Lines.Add('<UF_EMITENTE>,');
  Form40.Memo2.Lines.Add('<PARCELAS_VENCIDAS>');
  Form40.Memo2.Lines.Add('<TOTAL_ATRASADO>');
  Form40.Memo2.Lines.Add('<TOTAL_ATUALIZADO>');
  //
  Form40.ShowModal;
  //
  Form40.MaskEdit1.Visible := True;
  Form40.Edit1.Visible     := True;
  Form40.Label1.Visible    := True;
  Form40.Label4.Visible    := True;
  Form40.Label3.Visible    := True;
  Form40.Caption           := 'Enviar e-mail texto';
  //
  if Form1.Tag = 1 then
  begin
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este WhatsApp de cobrana para os clientes' + chr(10) +
              Chr(10) + 'filtrados?' +
              Chr(10) +
              Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);

    try
      if bButton = IDYES then
      begin
        I := 0;
        Form7.ibDataSet7.First;

        // Retorna onde parou
        Mais1ini := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('whats','registro','FIM') ;
        //
        if sRegistro <> 'FIM' then
        begin
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          //
          if bButton = IDYES then
          begin
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
            end;

            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
              begin
                I := I + 1;
              end;
              //
              Form7.ibDataSet7.Next;
            end;
          end else
          begin
            sMandados := '';
          end;
        end;

        Mais1ini.Free;
        Screen.Cursor            := crHourGlass;

        YY := 0;

        while not Form7.ibDataSet7.Eof do
        begin
          if (Pos(Form7.ibDataSet7NOME.AsString,sMandados)=0) and (Form7.ibDataSet7ATIVO.AsFloat=0) then
          begin
            try
              // Relaciona os clientes com o arquivo de vendas
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) <> '' then
              begin
                (*
                sArquivo := '';
                sArquivoPDF := Form1.sAtual+'\boletos_' + LimpaNumero(Form7.ibDataSet2WHATSAPP.AsString) + '.pdf'; // Sandro Silva 2022-12-22
                if Form7.sModulo = 'RECEBER' then
                begin
                  if Form40.CheckBox1.Checked then
                  begin
                    while FileExists(sArquivoPDF) do // Sandro Silva 2022-12-22 while FileExists(Form1.sAtual+'\boletos.pdf') do
                    begin
                      DeleteFile(pChar(sArquivoPDF)); // Sandro Silva 2022-12-22 DeleteFile(pChar(Form1.sAtual+'\boletos.pdf'));
                      sleep(1000);
                    end;
                    //
                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;

                    try
                      // Grava o local para voltar
                      MyBookMark1 := Form7.ibDataSet7.GetBookMark();
                      // Cria o PDF
                      {Mauricio Parizotto 2024-05-15 Inicio
                      PDF := TPrintPDF.Create(Self);
                      //
                      // Configuraes do documento
                      //
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;
                      //
                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := sArquivoPDF;// sFileCFeSAT; // Sandro Silva 2022-12-11 PDF.FileName    := Form1.sAtual+'\boletos.pdf';// sFileCFeSAT;
                      PDF.BeginDoc;
                      }

                      try
                        PDF:=TPdfDocumentGDI.Create();
                        PDF.Info.Author       := 'Small Commerce';
                        PDF.Info.Creator      := 'Small Commerce';
                        PDF.Info.Title        := 'Boletos';
                        PDF.Info.Subject      := 'Boletos de cobrana';
                        PDF.Info.CreationDate := now;
                        PDF.DefaultPaperSize := psA4; //Tamanho A4
                        PDF.ForceJPEGCompression := 0;
                        PDF.AddTrueTypeFont('Interleaved 2of5 Text');
                        PDF.EmbeddedTTF := True;
                        PDF.EmbeddedWholeTTF := true;

                        Form7.ibDataSet7.First;
                        while not Form7.ibDataSet7.Eof do
                        begin
                          if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                          begin
                            if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                            begin
                              if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                              begin
                                while FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                begin
                                  DeleteFile(pChar(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg'));
                                  sleep(1000);
                                end;

                                Form1.sEscolhido := '';
                                Form1.sBancoBoleto := '';

                                try
                                  sSecoes := TStringList.Create;
                                  Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                  Mais1Ini.ReadSections(sSecoes);

                                  for J := 0 to (sSecoes.Count - 1) do
                                  begin
                                    if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                     or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                    and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                    or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                    begin
                                      Form1.sEscolhido := sSecoes[J];
                                    end;
                                  end;

                                  Mais1Ini.Free;

                                except end;

                                if AllTrim(Form1.sEscolhido) <> '' then
                                begin
                                  Form25.Show;
                                  Form7.Repaint;

                                  while not FileExists(Form1.sAtual+'\boleto_'+AllTrim(Form7.ibDataSet7DOCUMENTO.AsString)+'.jpg') do
                                  begin
                                    Sleep(1000);
                                  end;

                                  // Print Image
                                  YY := YY + 1;
//                                  if YY >= 2 then
  //                                  PDF.NewPage; // Add New Page

  //                                PDF.DrawJPEG(0, 0, Form25.Image2.Picture.Bitmap);

                                  PAGE := pdf.AddPage;
                                  PAGE.PageLandscape := False;

                                  PDF.VCLCanvas.Draw(0,0,Form25.Image2.Picture.Graphic);
                                end;
                              end;
                            end;
                          end;

                          Screen.Cursor            := crHourGlass;
                          Form7.ibDataSet7.Next;
                          Form25.Close;
                          Form7.Repaint;
                        end;

                        Form7.ibDataSet7.GotoBookmark(MyBookMark1);

  //                      PDF.EndDoc;

                        PDF.SaveToFile(sArquivoPDF);
                      finally
                        FreeAndNil(PDF);
                      end;

                      {Mauricio Parizotto 2024-02-15 Fim}

                      if FileExists(sArquivoPDF) then // Sandro Silva 2022-12-22 if FileExists(Form1.sAtual+'\boletos.pdf') then
                        sArquivo := sArquivoPDF // Sandro Silva 2022-12-22 sArquivo := Form1.sAtual + '\boletos.pdf'
                      else
                        sArquivo := '';
                    except
                    end;

                    Form25.Close;
                    Form7.Repaint;

                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);

                    // Fecha o pdf
                  end;
                end;

                Mauricio Parizotto 2024-02-15 Opo de boleto no est visivel *)

                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);

                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL

                sMsg := Form40.Memo1.Lines.Text;

                // CLIENTES
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                //
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));
                //
                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
                //
                // TOTAL ATRASADO - Total acumulado
                if Pos('<PARCELAS_VENCIDAS>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select * from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' order by VENCIMENTO');
                  Form7.ibQuery1.Open;
                  //
                  sParcelas := '';
                  //
                  while not Form7.ibQuery1.eof do
                  begin
                    sParcelas := sParcelas +
                                'Documento: '+Copy(Form7.ibQuery1.fieldByname('DOCUMENTO').AsString   +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Emisso: '+Copy(Form7.ibQuery1.fieldByname('EMISSAO').AsString     +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Vencimento: '+Copy(Form7.ibQuery1.fieldByname('VENCIMENTO').AsString  +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Valor: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_DUPL').AsFloat])+Replicate(' ',10),1,10)+' '+chr(10)+
                                'Atualizado: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_JURO').AsFloat])+Replicate(' ',10),1,10)+chr(10)+
                                IfThen(Trim(Form7.ibQuery1.fieldByname('CODEBAR').AsString) <> '', 'Cdigo de barras: '+Form7.ibQuery1.fieldByname('CODEBAR').AsString, '')+chr(10)+chr(10)// Sandro Silva 2023-02-10ng, '')// Sandro Silva 2023-02-10
                                ;
                    //
                    Form7.ibQuery1.Next;
                  end;
                  //
                  sMsg := StrTran(sMsg,'<PARCELAS_VENCIDAS>'    ,sParcelas);
                end;
                // TOTAL ATRASADO - Total acumulado
                if Pos('<TOTAL_ATRASADO>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_DUPL) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATRASADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                  //
                end;
                //
                if Pos('<TOTAL_ATUALIZADO>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_JURO) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  //
                  sMsg := StrTran(sMsg,'<TOTAL_ATUALIZADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                end;
                //
                sMsg := StrTran(sMsg,' ','%20');
                sMsg := StrTran(sMsg,chr(10),'%0A');
                sMsg := StrTran(sMsg,chr(13),'');
                //
                ShellExecute( 0, 'Open', pChar('https://api.whatsapp.com/send?phone=55'+LimpaNumero(StrTran(ibDataSet2WHATSAPP.AsString,'0xx',''))+'&text='+sMSG),'','', SW_SHOW);
                //
                I := I + 1;
                //
                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('whats','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;
                //
                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;
                //
                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' WhatsApps enviados.';
                Form7.Panel1.Repaint;
              end;
              sMandados := sMandados + Form7.ibDataSet7NOME.AsString;
            except
            end;
          end;

          Form7.ibDataSet7.Next;
        end;
      end;
    except
    end;

    Screen.Cursor            := crDefault;
    Form7.Panel1.Visible := False;
    Form7.Repaint;
  end;
end;

procedure TForm7.ibDataSet4OBSValidate(Sender: TField);
begin
  if Form10.Visible then
  begin
    if (pos('<',Sender.Text)<>0) and (pos('>',Sender.Text)<>0) then
    begin
      //ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.');
    end;
    if (pos('VAL0',Sender.AsString)<>0) then
    begin
      //ShowMessage('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Parece que voc est tentando incluir uma TAG. Verifique se existe um campo especfico na aba Tags para incluir esta informao.');
    end;
  end;
end;

procedure TForm7.Notasfiscaisdesadavendassrie9201Click(Sender: TObject);
var
  Mais1Ini : tIniFile;
begin
  //
  Screen.Cursor := crHourGlass; // Cursor de Aguardo
  FechaTudo(Form1.bFechaTudo);
  //
  Form7.sModulo := 'VENDA';
  Form7.sTitulo := 'Notas fiscais de sada (vendas) com CPF srie 920';
  Form7.Show;
  Form7.sRPS := 'N';
  Screen.Cursor := crDefault; // Cursor de Aguardo
  //
  Mais1ini := TIniFile.Create(Form1.sAtual+'\'+Usuario+'.inf');
  Mais1Ini.WriteString('NOTAS','default','SERIE 920');
  Mais1Ini.Free;
  //
  //sSerieNFSelecionada := '920';
end;

procedure TForm7.miRelatoriosCaixaClick(Sender: TObject);
begin
  Caixa1.Caption := 'Caixa do dia '+DateTimeToStr(Form7.ibDataSet1DATA.AsDateTime);
end;

procedure TForm7.miRelatoriosCliforClick(Sender: TObject);
begin
  Histrico1.Caption         := 'Histrico de: '+Alltrim(ibDataSet2NOME.AsString);
  VendasPara.Caption        := 'Vendas para: '+Alltrim(ibDataSet2NOME.AsString);
  Resumodevendas1.Caption   := 'Resumo das vendas para: '+Alltrim(ibDataSet2NOME.AsString);
  Resumodascomrpas1.Caption := 'Resumo das compras de: '+Alltrim(ibDataSet2NOME.AsString);
end;

procedure TForm7.miRelCompRestICMSClick(Sender: TObject);
begin
  //
  sModuloAnterior := sModulo;
  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Complemento/Restituio por ICMS ST';
  //
  Form38.ShowModal; // Ok
  //
end;

procedure TForm7.ClculodoCustodaltimaNota1Click(Sender: TObject);
begin
  if FileExists(Form1.sAtual+'\Clculos de Custos da ltima Nota.txt') then ShellExecute( 0, 'Open','notepad.exe',PChar('Clculos de Custos da ltima Nota.txt'), '', SW_SHOW);
end;

procedure TForm7.Manifesto1Click(Sender: TObject);
begin
  Form7.Manifestaododestinatrio1Click(Sender);
end;

procedure TForm7.EnvioaoFISCOREDUOZ1Click(Sender: TObject);
var
  bBlocoX : Boolean;
begin
  //
  {Sandro Silva 2023-02-14 inicio
  if (Form7.ibDataSet13ESTADO.AsString = 'SC') or (Form7.ibDataSet13ESTADO.AsString = 'MS') or (Form7.ibDataSet13ESTADO.AsString = 'PI') or (Form7.ibDataSet13ESTADO.AsString = 'TO') then
  begin
    //
    if FileExists(Form1.sAtual+'\blocox.exe') then
    begin
      //
      // (chamar este executvel quando abre o small e tem o paf instalado, SC, MS, PI, TO )....... sandro vai passar os parametros.....
      // Tambem um item no menu estoque para chamar este executvel:
      //
      if ParamCount = 0 then
      begin
        //
        try
          //
          Form7.IBQuery1.Close;
          Form7.IBQuery1.SQL.Text := 'select first 1 * from BLOCOX where TIPO = ''REDUCAO'' and (coalesce(XMLRESPOSTA, '''') not containing ''<SituacaoProcessamentoCodigo>1'') ';
          Form7.IBQuery1.Open;
          //
          if Form7.IBQuery1.FieldByName('REGISTRO').AsString = '' then
          begin
            bBlocox := False;
          end else
          begin
            bBlocox := True;
          end;
          //
        except
          bBlocoX := False;
        end;
        //
        if bBlocoX then
        begin
          //
          ShellExecute( 0, 'Open', 'blocox.exe', pChar(LimpaNumero(Form7.ibDataSet13CGC.AsString)+' '+Form7.ibDataSet13ESTADO.AsString+' '+'REDUCAO') , '', SW_SHOW);
          //
          while ConsultaProcesso('blocox.exe') do
          begin
            sleep(1000);
          end;
          //
        end;
      end;
      //
    end;
    //
  end;
  }
  //
end;

procedure TForm7.miTermoUsoBancoClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoCaixaClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoCliforClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoComprasClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoConvCFOPClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoConvenioClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoEstoqueClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoGrupoClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoICMClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoOrcamentoClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoOSClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoPagarClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoParamTributaClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoPerfilTribClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoPlanoContasClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoReceberClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoSituacaoOSClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoTransportClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoVendasClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.miTermoUsoVendedorClick(Sender: TObject);
begin
  AbreHelpTermoUso;
end;

procedure TForm7.AbreHelpTermoUso;
begin
  HH(handle, PChar( extractFilePath(application.exeName) + 'Retaguarda.chm' + '>Ajuda Small'), HH_Display_Topic, Longint(PChar('CONTRATO.HTM')));
end;


procedure TForm7.ChamarTelaXMLContab;
begin
  frmExportaXML := TfrmExportaXML.Create(nil);
  try
    frmExportaXML.SetImagem(Form1.imgVendas.Picture);
    frmExportaXML.AbrirTelaTodosDocs;

    AgendaCommit(False);
  finally
    FreeAndNil(frmExportaXML);
    Form7.Close;
    Form7.Show;
  end;
end;

procedure TForm7.ExportarNfesdeentrdaparacontabilidade1Click(
  Sender: TObject);
begin
  ChamarTelaXMLContab;
end;

procedure TForm7.ManifestaododestinatrioDesc1Click(Sender: TObject);
begin
  try
    ConfiguraNFE;

    // Tipo do evento que deseja enviar:
    // 1: Confirmao da operao.
    // 2: Cincia da operao.
    // 3: Desconhecimento da operao.
    // 4: Operao no Realizada.
    //
//    if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)=0) then
    begin
      Manifesto(3); // 3: Desconhecimento da operao.
    end;
  except
    on E: Exception do
    begin
      //Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
      MensagemSistema(E.Message,msgErro);
    end;
  end;
  
  Screen.Cursor := crDefault;
end;

procedure TForm7.Manifestaaododestinatrio1Click(Sender: TObject);
begin
  try
    ConfiguraNFE;

    // Tipo do evento que deseja enviar:
    // 1: Confirmao da operao.
    // 2: Cincia da operao.
    // 3: Desconhecimento da operao.
    // 4: Operao no Realizada.
    //
//    if (Length(LimpaNumero(Form7.ibDataSet24NFEID.AsString)) = 44) and (Pos('<tpEvento>2102',Form7.ibDataSet24MDESTINXML.AsString)=0) then
    begin
      Manifesto(4); // 4: Operao no Realizada.
    end;
  except
    on E: Exception do
    begin
      //Application.MessageBox(pChar(E.Message),'Ateno',mb_Ok + MB_ICONWARNING); Mauricio Parizotto 2023-10-24
      MensagemSistema(E.Message,msgErro);
    end;
  end;

  Screen.Cursor := crDefault;
end;

procedure TForm7.ransmitirNotaFiscaldeServioNFSe1Click(Sender: TObject);
begin
  Screen.Cursor            := crHourGlass;
  TransmiteNFSE;
  Screen.Cursor            := crDefault;
end;

procedure TForm7.Visu1Click(Sender: TObject);
var
  F : TextFile;
  sPDF : String;
begin
  //
  BuscaNumeroNFSe(True);
  //
  fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
  //
  try
    sPDF := pChar(Form1.sAtual+'\NFSE\LOG\'+Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)+'.pdf');
  except
  end;
  //
  if not (FileExists(pChar(sPDF))) and (Form7.ibDataSet15EMITIDA.AsString = 'S') then
  begin
    try
      AssignFile(F,pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));  // Direciona o arquivo F para EXPORTA.TXT
      Rewrite(F);
      //
      Writeln(F,'<Small>GerarPDF=Sim</Small>');
      Writeln(F,'<sNumeroDaNFSE>'+Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)+'<sNumeroDaNFSE>');
      //
      {Sandro Silva 2023-01-26 inicio
      Writeln(F,'<XMLdeEvio>'+Form7.ibDAtaSet15NFEXML.AsString+'</XMLdeEvio>');
      }
      if (RetornaValorDaTagNoCampo('nfseCabecMsg', Form7.ibDAtaSet15NFEXML.AsString) <> '') and (RetornaValorDaTagNoCampo('nfseDadosMsg', Form7.ibDAtaSet15NFEXML.AsString) <> '') and (AnsiUpperCase(Form7.ibDataSet13MUNICIPIO.AsString) = 'BRASLIA') then
        Writeln(F,'<XMLdeEvio>' + '<Nfse><nfseCabecMsg>' + RetornaValorDaTagNoCampo('nfseCabecMsg', Form7.ibDAtaSet15NFEXML.AsString) + '</nfseCabecMsg><nfseDadosMsg>' + RetornaValorDaTagNoCampo('nfseDadosMsg', Form7.ibDAtaSet15NFEXML.AsString) + '</nfseDadosMsg></Nfse>' + '</XMLdeEvio>')
      else
        Writeln(F,'<XMLdeEvio>'+Form7.ibDAtaSet15NFEXML.AsString+'</XMLdeEvio>');
      {Sandro Silva 2023-01-26 fim}
      //
      if Pos('CompNfse',Form7.ibDAtaSet15RECIBOXML.AsString) <> 0 then
      begin
        Writeln(F,'<XMLImpressao>'+ExtraiNodeXml(Form7.ibDAtaSet15RECIBOXML.AsString,'CompNfse')+'</XMLImpressao>');
      end else
      begin
        {Sandro Silva 2023-01-26 inicio
        Writeln(F,'<XMLImpressao>'+Form7.ibDAtaSet15RECIBOXML.AsString+'</XMLImpressao>');
        }
        if (RetornaValorDaTagNoCampo('Nfse', Form7.ibDAtaSet15RECIBOXML.AsString) <> '') and (AnsiUpperCase(Form7.ibDataSet13MUNICIPIO.AsString) = 'BRASLIA') then
          Writeln(F,'<XMLImpressao>' + RetornaValorDaTagNoCampo('Nfse', Form7.ibDAtaSet15RECIBOXML.AsString) + '</XMLImpressao>')
        else
          Writeln(F,'<XMLImpressao>'+Form7.ibDAtaSet15RECIBOXML.AsString+'</XMLImpressao>');
        {Sandro Silva 2023-01-26 fim}
      end;
      //
      CloseFile(F);
      //
      // Aguarda at criar o arquivo
      //
      while not FileExists(pChar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
      begin
        Sleep(100);
      end;
      //
      ShellExecute( 0, 'Open',pChar('NFSE.EXE'),'', '', SW_SHOW);
      //
      while ConsultaProcesso('NFSE.EXE') or ConsultaProcesso('NFSE.exe') or ConsultaProcesso('nfe.exe') do
      begin
        Application.ProcessMessages;
        sleep(100);
      end;
      //
    except end;
  end;

  if (FileExists(pChar(sPDF))) and (Form7.ibDataSet15EMITIDA.AsString = 'S') then
  begin
    ShellExecute( 0, 'Open',pChar(sPDF),'', '', SW_SHOWMAXIMIZED);
  end else
  begin
    if RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe) <> '' then
    begin
      ShellExecute( 0, 'Open',pChar(RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe)),'', '', SW_SHOWMAXIMIZED);
    end else
    begin
      if RetornaValorDaTagNoCampo('link',fNFe) <> '' then
      begin
        ShellExecute( 0, 'Open',pChar(RetornaValorDaTagNoCampo('link',fNFe)),'', '', SW_SHOWMAXIMIZED);
      end else
      begin
        fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);
        
        if RetornaValorDaTagNoCampo('codigo_html',fNFe) <> '' then
        begin
          Screen.Cursor            := crHourGlass;

          fNFe := RetornaValorDaTagNoCampo('codigo_html',fNFe);
          fNFe := StrTran(StrTran(StrTran(StrTran( FNfe,'&lt;','<'),'&gt;','>'),'&amp;nbsp;',' '),'&quot;','"');
          fNFe := StrTran( FNfe,'Software FiscalWeb- IPM Sistemas - Protegido por Lei.','<a href="https://www.smallsoft.com.br">www.smallsoft.com.br</a>');

          fNFe := '<codigo_html>'+fNFe+'</codigo_html>';
          AssignFile(F,pchar(Form1.sAtual+'\tempo.html'));  // Direciona o arquivo F para EXPORTA.TXT
          Rewrite(F);                  // Abre para gravao
          Write(F,fNFe);
          CloseFile(F); // Fecha o arquivo

          ShellExecute( 0, 'Open',pChar(Form1.sAtual+'\tempo.html'),'', '', SW_SHOWMAXIMIZED);

          Screen.Cursor            := crDefault;
        end else
        begin
          //ShowMessage('No foi possvel visualizar o NFS-e.'); Mauricio Parizotto 2023-10-25
          MensagemSistema('No foi possvel visualizar o NFS-e.',msgAtencao);
        end;
      end;
    end;
  end;
end;

procedure TForm7.EnviarNFSeporemail1Click(Sender: TObject);
var
  F : TextFile;
  sPDF : String;
begin
  if (validaEmail(Form7.ibDAtaSet2eMail.Asstring)) then
  begin
    BuscaNumeroNFSe(True);
    
    fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);

    try
      sPDF := pChar(Form1.sAtual+'\NFSE\LOG\'+Right('000000000'+Copy(Form7.ibDAtaSet15NFEPROTOCOLO.AsString,1,pos('/',Form7.ibDAtaSet15NFEPROTOCOLO.AsString)-1),9)+'.pdf');
    except end;

    if (FileExists(pChar(sPDF))) and (Form7.ibDataSet15EMITIDA.AsString = 'S') then
    begin
      //2024-02-26 Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue em anexo sua NFS-e em arquivo PDF.'+chr(10)+Form1.sPropaganda),pChar(sPDF),False);
      EnviarEMail('', Form7.ibDAtaSet2eMail.Asstring, '', PChar('Sua NFS-e'), PChar('Segue em anexo sua NFS-e em arquivo PDF.'+chr(10)+Form1.sPropaganda), PChar(sPDF), False);
    end else
    begin
      if RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe) <> '' then
      begin
        //2024-02-26 Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue link da sua NFS-e:'+chr(10)+chr(10)+pChar(RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe))+chr(10)+Form1.sPropaganda),'',False);
        EnviarEMail('', Form7.ibDAtaSet2eMail.Asstring, '', PChar('Sua NFS-e'), PChar('Segue link da sua NFS-e:'+chr(10)+chr(10)+pChar(RetornaValorDaTagNoCampo('LinkVisualizacaoNfse',fNFe))+chr(10)+Form1.sPropaganda), PChar(''), False);
      end else
      begin
        if RetornaValorDaTagNoCampo('link',fNFe) <> '' then
        begin
          //2024-02-26 Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue link da sua NFS-e:'+chr(10)+chr(10)+pChar(RetornaValorDaTagNoCampo('link',fNFe))+chr(10)+Form1.sPropaganda),'',False);
          EnviarEMail('', Form7.ibDAtaSet2eMail.Asstring,'', PChar('Sua NFS-e'), PChar('Segue link da sua NFS-e:'+chr(10)+chr(10)+pChar(RetornaValorDaTagNoCampo('link',fNFe))+chr(10)+Form1.sPropaganda), PChar(''), False);
        end else
        begin
          fNFe := ConverteAcentos(Form7.ibDataSet15RECIBOXML.AsString);

          if RetornaValorDaTagNoCampo('codigo_html',fNFe) <> '' then
          begin
            Screen.Cursor            := crHourGlass;

            fNFe := RetornaValorDaTagNoCampo('codigo_html',fNFe);
            fNFe := StrTran(StrTran(StrTran(StrTran( FNfe,'&lt;','<'),'&gt;','>'),'&amp;nbsp;',' '),'&quot;','"');
            fNFe := StrTran( FNfe,'Software FiscalWeb- IPM Sistemas - Protegido por Lei.','<a href="https://www.smallsoft.com.br">www.smallsoft.com.br</a>');

            fNFe := '<codigo_html>'+fNFe+'</codigo_html>';
            AssignFile(F,pchar(Form1.sAtual+'\tempo.html'));  // Direciona o arquivo F para EXPORTA.TXT
            Rewrite(F);                  // Abre para gravao
            Write(F,fNFe);
            CloseFile(F); // Fecha o arquivo

            //2024-02-26 Unit7.EnviarEMail('',Form7.ibDAtaSet2eMail.Asstring,'','Sua NFS-e',pchar('Segue em anexo sua NFS-e em arquivo HTML.'+chr(10)+Form1.sPropaganda),pChar(Form1.sAtual+'\tempo.html'),False);
            EnviarEMail('', Form7.ibDAtaSet2eMail.Asstring,'', PChar('Sua NFS-e'), PChar('Segue em anexo sua NFS-e em arquivo HTML.'+chr(10)+Form1.sPropaganda), PChar(Form1.sAtual+'\tempo.html'), False);

            Screen.Cursor            := crDefault;
          end;
        end;
      end;
    end;
  end;
end;

procedure TForm7.CancelarNFSe1Click(Sender: TObject);
var
  bButton : Integer;
  sRetornoNFse : String;
  _file : TStringList;
  F: TextFile;
  Mais1Ini : tIniFile; // 2022-07-14
  sPadraoSistema: String; //2022-07-14
begin
  try
    //2022-07-14 Identificar o padro da prefeitura
    Mais1ini := TIniFile.Create(Form1.sAtual+'\nfseConfig.ini');
    sPadraoSistema := UpperCase(Mais1Ini.ReadString('Informacoes obtidas na prefeitura','Padrao','?'));
    Mais1Ini.Free;

    if RetornaValorDaTagNoCampo('ChaveDeCancelamento',Form7.ibDAtaSet15RECIBOXML.AsString) <> '' then
    begin
      Screen.Cursor            := crHourGlass;

      if Form1.ExisteNfseExe(Form1.sAtual) then
      begin
        while FileExists(Pchar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
        begin
          DeleteFile(Pchar(Form1.sAtual+'\NFSE\smallnfse.tx2'));
          Sleep(100);
        end;

        AssignFile(F,pChar(Form1.sAtual+'\NFSE\smallnfse.tx2'));  // Direciona o arquivo F para EXPORTA.TXT
        Rewrite(F);
        Writeln(F,'ChaveDeCancelamento='+RetornaValorDaTagNoCampo('ChaveDeCancelamento',Form7.ibDAtaSet15RECIBOXML.AsString));
        Writeln(F,'');

        CloseFile(F);

        // Aguarda at criar o arquivo
        while not FileExists(pChar(Form1.sAtual+'\NFSE\smallnfse.tx2')) do
        begin
          Sleep(100);
        end;

        ShellExecute( 0, 'Open',pChar('NFSE.EXE'),'', '', SW_SHOW);

        // Aguarda fechar o NFSE.EXE
        while ConsultaProcesso('NFSE.EXE') or ConsultaProcesso('NFSE.exe') or ConsultaProcesso('nfe.exe') do
        begin
          Application.ProcessMessages;
          sleep(100);
        end;

        // Verifica o retorno
        if FileExists(pChar(Form1.sAtual+'\NFSE\ret.txt')) then
        begin
          _file := TStringList.Create;
          _file.LoadFromFile(pChar(Form1.sAtual+'\NFSE\ret.txt'));

          sRetornoNFse := _File.Text;

          if Pos('CANCELADA',_File.Text)<>0 then
          begin
            CancelarNFSe(_File.Text);
          end else
          begin
            if RetornaValorDaTagNoCampo('Motivo',_File.Text) <> '' then
            begin
              sRetornoNFse := RetornaValorDaTagNoCampo('Motivo',_File.Text);
            end;

            if (sPadraoSistema = 'MEMORY') then //2022-07-14 eliminado sRetornoNFSe, deixa muito grande a mensagem e esconde os botes Sim e No
              bButton := Application.MessageBox(pChar(
                        chr(10) +'No foi possvel identificar se a NFS-e foi cancelada'+
                        chr(10) +'com base no retorno do sistema da prefeitura.'+Chr(10)+
                        chr(10) +'Verifique no sistema de prefeitura se a nota foi cancelada'+Chr(10)+
                        chr(10) +'e clique em Sim para cancelar no Small'+
                        chr(10)+
                        'Considerar esta NFS-e como cancelada?'),
                        'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION)
            else
              bButton := Application.MessageBox(pChar(
                        sRetornoNFse+
                        chr(10)+
                        chr(10) +'No foi possvel identificar se a NFS-e foi cancelada'+
                        chr(10) +'com base no retorno do sistema da prefeitura.'+Chr(10)+
                        chr(10)+
                        'Considerar esta NFS-e como cancelada?'),
                        'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION);

            if bButton = IDYES  then
            begin
              CancelarNFSe('<RETORNO>'+_File.Text+'<SITUACAO>CANCELADA</SITUACAO><STATUS>CANCELADA</STATUS>'+'</RETORNO>');
            end;
          end;
        end;

        while FileExists(Pchar(Form1.sAtual+'\NFSE\ret.txt')) do
        begin
          DeleteFile(Pchar(Form1.sAtual+'\NFSE\ret.txt'));
          Sleep(100);
        end;
      end;
    end else
    begin
      bButton := Application.MessageBox(pChar(
                chr(10) +'No foi possvel cancelar a NFS-e no temos a chave de cancelamento.'+Chr(10)+
                chr(10) +'Esta NFS-e poder ser cancelada manualmente no site da prefeitura.'+Chr(10)+
                chr(10)+
                'Considerar esta NFS-e como cancelada?'),
                'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONQUESTION);

      if bButton = IDYES  then
      begin
        CancelarNFSe('<RETORNO><SITUACAO>CANCELADA</SITUACAO><STATUS>CANCELADA</STATUS></RETORNO>');
      end;
    end;
  except
  end;
  
  Screen.Cursor            := crDefault;
end;

procedure TForm7.ibDataSet35DESCRICAOSetText(Sender: TField;
  const Text: String);
begin
  ibDataSet35DESCRICAO.AsString := Text;

  if Form48.Visible then
  begin
    // Procura por descrio
    Form7.ibDataSet99.DisableControls;
    Form7.ibDataSet99.Close;
    Form7.ibDataSet99.SelectSQL.Clear;
    Form7.ibDataSet99.SelectSQL.Add('select * from ESTOQUE where TIPO_ITEM='+QuotedStr('09')+' and Coalesce(Ativo,0)=0 and Upper(DESCRICAO) like '+QuotedStr('%'+UpperCase(Form7.ibDataSet35DESCRICAO.AsString)+'%')+' order by DESCRICAO');
    Form7.ibDataSet99.Open;
    Form7.ibDataSet99.First;
    Form7.IBDataSet99.EnableControls;

    Form7.ibDataSet4.Locate('DESCRICAO',AllTrim( Form7.ibDataSet99.FieldByname('DESCRICAO').AsString  ),[loCaseInsensitive, loPartialKey]);
    Form7.ibDataSet4.EnableControls;
  end;
end;

procedure TForm7.GerarNotaFiscaldeServio1Click(Sender: TObject);
begin
  // Gera a nota fiscal de Servico
  if Form1.bNotaVendaLiberada then
  begin
    if Form7.ibDataSet97.FieldByName('Doc. Fiscal').AsString = '' then
    begin
      {Mauricio Parizotto 2023-10-16 Inicio
      //Form41.MaskEdit1.Text := Form7.ibDataSet97.FieldByname('Oramento').AsString; Mauricio Parizotto 2023-08-23
      Form41.vOrcamentImportar := Form7.ibDataSet97.FieldByname('Oramento').AsString;
      Form7.Close;
      Form1.imgServicosClick(Sender);                       // Nota Fiscal de Servico
      Form7.Image101Click(Sender);                        // Nova Nota
      Form12.Importaroramentos1Click(Sender);             // Importa OS
    end;
    }

      if Application.MessageBox(Pchar('Confirma a importao do oramento '+ibDataSet97.FieldByname('Oramento').AsString+' para a Nota Fiscal?'
                                                  + chr(10)
                                                  + Chr(10))
                                                  ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING) = IDYES then
      begin
        Form7.Close;
        Form1.imgServicosClick(Sender);                     // Nota Fiscal de Servico
        Form7.Image101Click(Sender);                        // Nova Nota
        Form7.sModulo := 'ORCAMENTO';
        ImportaOrcamento(ibDataSet97.FieldByname('Oramento').AsString,sModulo);
        Form7.sModulo := 'VENDA';

        Form7.ibDataSet16.First;
        Retributa(True);
      end;
    end else
    begin
      MensagemSistema('Este oramento j possui documento fiscal vinculado.',msgAtencao);
    end;

    {Mauricio Parizotto 2023-10-16 Fim}

  end else
  begin
    //ShowMessage('Emisso de NFS-e no liberada para este usurio.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Emisso de NFS-e no liberada para este usurio.',msgAtencao);
  end;
end;

procedure TForm7.GerarNotaFiscaldeServio2Click(Sender: TObject);
var
  numOS : string;
begin
  numOS := ibDataSet3NUMERO.AsString;

  // Gera a nota fiscal
  if Form1.bNotaVendaLiberada then
  begin
    //if Form7.ibDataSet3NF.AsString = '' then Mauricio Parizotto 2023-12-28
    if Form7.ibDataSet3NFSE.AsString = '' then
    begin
      if Application.MessageBox(Pchar('Confirma a importao da OS '+ibDataSet3NUMERO.AsString+' para a Nota Fiscal?'
                                                  + chr(10)
                                                  + Chr(10))
                                                  ,'Ateno',mb_YesNo + mb_DefButton2 + MB_ICONWARNING) = IDYES then
      begin
        Form7.Close;
        Form1.imgServicosClick(Sender);                     // Nota fiscal Nota Fiscal de Servico
        Form7.Image101Click(Sender);                        // Nova Nota
        Form7.sModulo := 'OS';
        ImportaOS(numOS);
        Form7.sModulo := 'VENDA';
      end;
    end else
    begin
      MensagemSistema('Esta OS j possui documento fiscal vinculado.',msgAtencao);
    end;
  end else
  begin
    //ShowMessage('Emisso de NF no liberada para este usurio.'); Mauricio Parizotto 2023-10-25
    MensagemSistema('Emisso de NF no liberada para este usurio.',msgAtencao);
  end;
end;

procedure TForm7.ConsultarNFSe1Click(Sender: TObject);
begin
  Form1.sConsultaNfse := 'SIM';
  EnviarConsultaImprimirDANFE;
  Form1.sConsultaNfse := 'NAO';
end;

procedure TForm7.ConfiguraesdaNFSe1Click(Sender: TObject);
begin
  Form1.ConfiguraesdaNFSe2Click(Sender);
end;

procedure TForm7.NFeTransmitirasprximas1Click(Sender: TObject);
begin
  bProximas := True;
  while not Form7.ibDataSet15.Eof do
  begin
    ransmitirNotaFiscaldeServioNFSe1Click(Sender);
    EnviarNFSeporemail1Click(Sender);
    Form7.ibDataSet15.Next;
  end;

  bProximas := False;

  try
    try
      Form7.ibDAtaSet15.Post;
    except
    end;

    Screen.Cursor            := crHourGlass;
    AgendaCommit(True);

    Form7.Close;
    Form7.Show;

    Screen.Cursor            := crDefault;
    Form7.ibDAtaSet15.Edit;
  except
  end;

  Screen.Cursor            := crDefault;
end;

procedure TForm7.DevolverNF1Click(Sender: TObject);
begin
  (* Mauricio Parizotto 2023-10-19 Inicio
  try
    Form1.imgVendasClick(Form1.imgVendas);
    Form7.Image101Click(Form7.Image201);

    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet24FORNECEDOR.AsString)+' ');  //
    Form7.ibDataSet2.Open;

    Form7.ibDataSet15CLIENTE.AsString     := Form7.ibDataSet2NOME.AsString;
    Form7.ibDataSet15DESCONTO.AsFloat     := Form7.ibDataSet24DESCONTO.AsFloat;
    Form7.ibDataSet15COMPLEMENTO.AsString := 'ID da NF-e referenciada:' + Form7.ibDataSet24NFEID.AsString;

    Form7.ibDataSet14.Close;
    Form7.ibDataSet14.SelectSQL.Clear;
    Form7.ibDataSet14.SelectSQL.Add('select * from ICM where SubString(CFOP from 1 for 1) = ''5'' or  SubString(CFOP from 1 for 1) = ''6'' or SubString(CFOP from 1 for 1) = ''7'' order by upper(NOME)');
    Form7.ibDataSet14.Open;

    Form7.ibDataSet14.Locate('NOME','DEVOLU',[loCaseInsensitive, loPartialKey]);

    if pos('DEVOLU',UpperCase(Form7.ibDataSet14NOME.AsString)) = 0  then
    begin
      Form7.ibDataSet14.Append;
      Form7.ibDataSet14CFOP.AsString := '6202';
      Form7.ibDataSet14NOME.AsString := 'Devoluo';
      Form7.ibDataSet14.Post;
    end;

    Form12.Edit2.Text := '4-Devoluo de mercadoria';
    Form7.ibDataSet15OPERACAO.AsString := Form7.ibDataSet14NOME.AsString;
    Form7.ibDataSet15FINNFE.AsString   := '4';
    Form12.ExibeColunasFCPST(True); // Sandro Silva 2023-05-08
    Form12.ExibeColunaCSOSN(False); // Sandro Silva 2023-05-23
    if Form7.ibDataSet13CRT.AsString = '1' then // Sandro Silva 2023-05-23
    begin
      Form12.ExibeColunaCSOSN(True); // Sandro Silva 2023-05-23
      Form12.ExibeColunaCSTICMS('4', Form7.ibDataSet13CRT.AsString); //Form12.ExibeColunaCSTICMS(False); // Sandro Silva 2023-05-24
    end;

    Form7.Tag := 999;

    try
      Form7.ibDataSet15.Post;
      Form7.ibDataSet15.Edit;

      Application.ProcessMessages; // Sandro Silva 2023-05-09

      Form7.ibDataSet23.First;

      while not Form7.ibDataSet23.Eof do
      begin
        Form12.vNotaFiscal.Calculando := True; // Sandro Silva 2023-05-08

        if AllTrim(Form7.ibDataSet23CODIGO.AsString) <> '' then
        begin
          Form7.ibDataSet4.Close;
          Form7.ibDataSet4.Selectsql.Clear;
          Form7.ibDataSet4.Selectsql.Add('select * from ESTOQUE where CODIGO='+QuotedStr(Form7.ibDataSet23CODIGO.AsString)+' ');
          Form7.ibDataSet4.Open;

          if Form7.ibDataSet23CODIGO.AsString = Form7.ibDataSet4CODIGO.AsString then
          begin
            Form7.ibDataSet16.Append;
            Form7.ibDataSet16CODIGO.AsString    := Form7.ibDataSet4CODIGO.AsString;
            Form7.ibDataSet16ST.AsString        := Form7.ibDataSet4ST.AsString;
            Form7.ibDataSet16PESO.AsFloat       := Form7.ibDataSet4PESO.AsFloat;
            Form7.ibDataSet16CUSTO.AsFloat      := Form7.ibDataSet4CUSTOCOMPR.AsFloat;
            Form7.ibDataSet16LISTA.AsFloat      := Form7.ibDataSet4PRECO.AsFloat;
            Form7.ibDataSet16MEDIDA.AsString    := Form7.ibDataSet4MEDIDA.AsString;

            // Acerta os tributos e o CFOP
            Form1.bFlag := True;
            Form7.sModulo                       := 'VENDA';
            Form7.ibDataSet16DESCRICAO.AsString := Form7.IbDataSet23DESCRICAO.AsString;
            Form1.bFlag := False;

            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16QUANTIDADE.AsFloat := Form7.IbDataSet23QUANTIDADE.AsFloat;
            Form7.ibDataSet16.Edit;
            Form7.ibDataSet16UNITARIO.AsFloat   := Form7.IbDataSet23UNITARIO.AsFloat;
            Form7.ibDataSet16IPI.AsFloat        := Form7.ibDataSet23IPI.AsFloat;

            Form7.ibDataSet16VIPI.AsFloat       := Arredonda2(Form7.ibDataSet23VIPI.AsFloat,2);
            Form7.ibDataSet16ICM.Asfloat        := Form7.ibDataSet23ICM.Asfloat;
            Form7.ibDataSet16CST_ICMS.AsString  := Form7.ibDataSet23CST_ICMS.AsString;
            Form7.ibDataSet16CFOP.AsString      := Form7.ibDataSet14CFOP.AsString;
            Form7.ibDataSet16VICMS.AsFloat      := Form7.ibDataSet23VICMS.AsFloat;
            Form7.ibDataSet16VBC.AsFloat        := Form7.ibDataSet23VBC.AsFloat;
            Form7.ibDataSet16VBCST.AsFloat      := Form7.ibDataSet23VBCST.AsFloat;
            Form7.ibDataSet16VICMSST.AsFloat    := Form7.ibDataSet23VICMSST.AsFloat;

            // Campos FCP - Sandro Silva 2023-05-05
            //Form7.ibDataSet16VBCFCP.AsFloat     := Form7.ibDataSet23VBCFCP.AsFloat;
            //Form7.ibDataSet16PFCP.AsFloat       := Form7.ibDataSet23PFCP.AsFloat;
            //Form7.ibDataSet16VFCP.AsFloat       := Form7.ibDataSet23VFCP.AsFloat;
            Form7.ibDataSet16VBCFCPST.AsFloat   := Form7.ibDataSet23VBCFCPST.AsFloat;
            Form7.ibDataSet16PFCPST.AsFloat     := Form7.ibDataSet23PFCPST.AsFloat;
            Form7.ibDataSet16VFCPST.AsFloat     := Form7.ibDataSet23VFCPST.AsFloat;
          end;
        end;

        Form7.ibDataSet23.Next;
      end;
    except
    end;
    //Form12.DBGrid1.SelectedIndex := 1; // Sandro Silva 2023-05-09
    //Form7.ibDataSet16.EnableControls; // Sandro Silva 2023-05-09
    //Form7.ibDataSet23.EnableControls; // Sandro Silva 2023-05-09

    Form7.Tag := 0;

    Form7.sModulo := 'VENDA';
    Form7.ibDataSet16.Edit;
    Form7.ibDataSet16.Post;
    Form7.sModulo := 'OS';
    Form7.ibDataSet16.Edit;

    Form7.ibDataSet16.EnableControls;
    Form7.ibDataSet16.MoveBy(-1);
    Form7.ibDataSet16.MoveBy(1);
    Form12.DBGrid1.Update;
    if Form12.vNotaFiscal <> nil then
    begin
      Form12.vNotaFiscal.Calculando := False; // Sandro Silva 2023-05-08
      Form12.vNotaFiscal.CalculaValores(Form7.ibDataSet15, Form7.ibDataSet16);
    end;
    Form7.ibDataSet15MERCADORIAChange(Form7.ibDataSet15MERCADORIA); // Fora o clculo de totais e de impostos

    {Sandro Silva 2023-05-15 inicio}
    // Para exibir os dados do destinatrio na tela de lanamento da nota
    Form7.ibDataSet2.Close;
    Form7.ibDataSet2.Selectsql.Clear;
    Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');  //
    Form7.ibDataSet2.Open;
    {Sandro Silva 2023-05-15 fim}
  finally

  end;

  Form12.dbGrid1.SetFocus;
  *)

  FrmProdutosDevolucao := TFrmProdutosDevolucao.Create(self);
  try
    FrmProdutosDevolucao.ibdProdutosNota.ParamByName('NUMERONF').AsString := ibDataSet24NUMERONF.AsString;
    FrmProdutosDevolucao.ibdProdutosNota.ParamByName('FORNECEDOR').AsString := ibDataSet24FORNECEDOR.AsString;
    FrmProdutosDevolucao.ShowModal;
  finally
    FreeAndNil(FrmProdutosDevolucao);
  end;

  {Mauricio Parizotto 2023-10-19 Fim} 
end;

procedure TForm7.RelatriodeprodutosmonofsicosNFe1Click(Sender: TObject);
begin
  frmRelProdMonofasicoNota := TfrmRelProdMonofasicoNota.Create(nil);
  try
    frmRelProdMonofasicoNota.Transaction := IBTransaction1;
    frmRelProdMonofasicoNota.Usuario     := UsuarioLogado;
    frmRelProdMonofasicoNota.Imagem      := imgImprimir.Picture;
    frmRelProdMonofasicoNota.ShowModal;
  finally
    FreeAndNil(frmRelProdMonofasicoNota);
  end;
end;

procedure TForm7.DuplicatestaNFe1Click(Sender: TObject);
var
  sDesVetor : array[0..999] of String;
  fValVetor : array[0..999] of real;
  fQtdVetor : array[0..999] of real;

  vCli, vOpe : String;
  I, J : Integer;
begin
  vCli := Form7.ibDataSet15CLIENTE.AsString;
  vOpe := Form7.ibDataSet15OPERACAO.AsString;

  I := 0;

  Form7.ibDataSet16.First;
  while not Form7.ibDataSet16.Eof do // disable
  begin
    sDesVetor[I] := Form7.ibDataSet16DESCRICAO.AsString;
    fValVetor[I] := Form7.ibDataSet16UNITARIO.Asfloat;
    fQtdVetor[I] := Form7.ibDataSet16QUANTIDADE.AsFloat;
    I := I + 1;
    Form7.ibDataSet16.Next;
  end;

  Form7.ibDataSet15.Append;
  if not (Form7.ibDataset15.State in ([dsEdit, dsInsert])) then Form7.ibDataset15.Edit;
  Form7.ibDataSet15CLIENTE.AsString  :=  vCli;
  Form7.ibDataSet15OPERACAO.AsString :=  vOpe;
  Form7.ibDataSet15.Post;

  J := I-1;
  for I := 0 to J do
  begin
    Form7.ibDataSet16.Append;
    Form7.ibDataSet16DESCRICAO.AsString := sDesVetor[I];
    Form7.ibDataSet16UNITARIO.AsFloat   := fValVetor[I];
    Form7.ibDataSet16QUANTIDADE.AsFloat := fQtdVetor[I];
    Form7.ibDataSet16.Post;
    Form7.sModulo := 'VENDA';
  end;
  
  Form7.sModulo := 'VENDA';
  Image106Click(Sender);
end;

function TForm7._ecf65_ValidaGtinNFCe(sEan: String): Boolean;
// Sandro Silva 2019-06-11
// Prefixo 781 e 792 indicam EAN de uso interno no registrado no GS1
begin
  //Result := ValidaEAN13(LimpaNumero(sEan)); Mauricio Parizotto 2023-07-05
  Result := ValidaEAN(LimpaNumero(sEan));
  if Result then
  begin
    if (Copy(LimpaNumero(sEan), 1, 3) = '781') or (Copy(LimpaNumero(sEan), 1, 3) = '792') then
      Result := False;
  end;
end;

// A PEDIDO DO
// VANDERLEI PERETI
// FONES: 49 35664136 / 91427178
// EMAIL: comercial@vpinformatica.com.br
function TForm7.AliqICMdoCliente16: double;
begin
  if Form1.fAliqICMdoCliente <> 0 then
  begin
    if Form7.ibDataSet13ESTADO.AsString =  Form7.ibDataSet2ESTADO.AsString then
    begin
      Result :=  Form1.fAliqICMdoCliente;
    end else
    begin
      Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
    end;
  end else
  begin
    Result := Form7.IbDataSet16.FieldByName('ICM').AsFloat;
  end;
end;

procedure TForm7.PrvisualizarDANFE1Click(Sender: TObject);
var
  sFormato, sLote: String;
begin
  {Sandro Silva 2022-09-12 inicio}
  //Ficha 4128

  Form7.ibDataSet2.Close;
  Form7.ibDataSet2.Selectsql.Clear;
  Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet15CLIENTE.AsString)+' ');
  Form7.ibDataSet2.Open;

  ConfiguraNFE;

  sLote := Form7.ibDataSet15.FieldByName('NUMERONF').AsString;

  fNFE := GeraXmlNFe;//(True);
  if Trim(fNFE) <> '' then
  begin

    if Form1.DisponivelSomenteParaNos then
      Clipboard.AsText := fNFe; // salva na rea de tranferncia

    try
      spdNFe.PreverDanfe(fNFE, '');
    except
      //Screen.Cursor            := crDefault;
    end;
  end;

  {$IFDEF VER150}
  DecimalSeparator := ',';
  DateSeparator    := '/';
  {$ELSE}
  FormatSettings.DecimalSeparator := ',';
  FormatSettings.DateSeparator    := '/';
  {$ENDIF}

  Form7.Panel7.Caption := TraduzSql('Listando '+swhere+' '+sOrderBy,True);
  Form7.Panel7.Repaint;
  Screen.Cursor            := crDefault;

  {Sandro Silva 2022-09-12 fim}
end;

function TForm7.Formata2CasasDecimais(Valor: Double): Currency;
begin
  Result := StrToFloat(FormatFloat('0.00', Valor));
end;

procedure TForm7.SelecionaAliquotaIss(var IBQuery: TIBQuery; Operacao: String = '');
begin
  // Seleciona a alquota de ISS configurada para o Emitente
  IBQuery.Close;
  IBQuery.SQL.Text :=
    'select first 1 ISS, BASEISS ' +
    'from ICM ';
  if Trim(Operacao) = '' then
    IBQuery.SQL.Add('where coalesce(ISS, 0) <> 0 and coalesce(BASEISS, 0) <> 0')
  else
    IBQuery.SQL.Add('where NOME = ' + QuotedStr(Operacao));

  IBQuery.Open;
end;

function TForm7.PermiteValidarSchema(DataSet: TDataSet): Boolean;
begin
  Result := (DataSet.FieldByName('NFEXML').AsString <> '') and (DataSet.FieldByName('MODELO').AsString = '55');
end;

procedure TForm7.ValidarSchemaSefaz(NFeXml: String);
begin
  Clipboard.SetTextBuf(pchar(NFEXml));
  ShellExecute( 0, 'Open',pChar('http://www.sefaz.rs.gov.br/NFE/NFE-VAL.aspx'),'','', SW_SHOWMAXIMIZED);
end;

procedure TForm7.VerificarShemaXsd(NFeXml: String;
  bValidarNaSefaz: Boolean);
var
  DOMDocument : IXMLDOMDocument3;
  ParseError  : IXMLDOMParseError;
  Schema      : XMLSchemaCache;
  sErro, sMErro, sVersaoManual : String;
  rcpNFExml   : tStringList;
  DOMDocumentNFe: IXMLDOMDocument;
  xNodeNFe: IXMLDOMNodeList;
begin
  Screen.Cursor := crHourGlass;
  // Validar Shema
  try
    DOMDocument := CoDOMDocument50.Create;

    DOMdocument.Async := False;
    DOMdocument.ResolveExternals := False;
    DOMdocument.ValidateOnParse  := True;

    // Carrega s uma parte do XML
    XMLDocument1.Active := false;
    XMLDocument1.XML.Text := Form7.IbDAtaSet15NFEXML.AsString;
    XMLDocument1.Active := True;
    rcpNFExml := TStringList.Create;
    DOMDocumentNFe := CoDOMDocument.Create; // Precisa ser criado com est herana para no ocorrer erro na linha DOMDocumentNFe.selectNodes('//NFe');
    DOMDocumentNFe.loadXML(Form7.IbDAtaSet15NFEXML.AsString);

    xNodeNFe := DOMDocumentNFe.selectNodes('//NFe');
    if xNodeNFe.length > 0 then
    begin
      rcpNFExml.Text := xNodeNFe.item[0].xml;

      DOMdocument.LoadXML(rcpNFExml.Text); //XML COM ERRO
      rcpNFExml.Free;

      Schema := CoXMLSchemaCache50.Create;

      // Verso 2.0 da NFE 4.0 do manual
      spdNFe.VersaoManual := vm60;
      sVersaoManual := 'vm60\nfe_v4.00.xsd';

      Schema.add('http://www.portalfiscal.inf.br/nfe', Form1.sAtual+'\Nfe\Esquemas\'+sVersaoManual);

      DOMdocument.Schemas := Schema;
      ParseError          := DOMdocument.validate;
      sErro := '';
      sMErro := '';
      sErro := ParseError.reason; /// retorno da validao
    end;
    DOMDocument         := Nil;
    ParseError          := Nil;
    Schema              := Nil;
    DOMDocumentNFe      := nil;
    xNodeNFe            := nil;
  except
  end;

  Screen.Cursor := crDefault;
  try
    if sErro <> '' then
      //ShowMessage('Mensagem de erro retornada: '+chr(10)+chr(10)+strTran(sErro, '{http://www.portalfiscal.inf.br/nfe}','')) Mauricio Parizotto 2023-10-25
      MensagemSistema('Mensagem de erro retornada: '+chr(10)+chr(10)+strTran(sErro, '{http://www.portalfiscal.inf.br/nfe}',''),msgAtencao)
    else
      if bValidarNaSefaz then
        ValidarSchemaSefaz(Form7.ibDataSet15NFEXML.AsString);
  except
  end;
end;

procedure TForm7.RelatriodePISCOFINSCupomFiscal1Click(Sender: TObject);
begin
  sModuloAnterior := sModulo;

  Form38.Label2.Visible := True;
  Form38.Label3.Visible := True;
  Form38.DateTimePicker1.Visible := True;
  Form38.DateTimePicker2.Visible := True;
  sModulo := 'Relatrio de PIS/COFINS (Cupom Fiscal)';
  Form38.ShowModal;
end;

procedure TForm7.EscolheOBancoParaGerarBoletoEEnviarEmail(Sender: TObject);
begin
  // Para envio de boletos referente a incorporao da Zucchetti
  Form1.sEscolhido := 'Boleto de cobrana do ' + TMenuItem(Sender).Caption;
  Form1.sBancoBoleto := TMenuItem(Sender).Caption;
  Form25.Show; // Para carregar parmetros e gerar corretamente o cdigo de barras/nosso nmero
  Form25.Close;
  // Sandro Silva 2022-12-28 Emaildecobrana2Click(Sender); // Executando o click de modo provisrio devido a pouco tempo para atender a incorporao da Zucchetti, analisar para evitar uso de eventos em cascata.
  Form7.EmailAtualizaBoletoscobranaClick(Sender);// Executando o click de modo provisrio devido a pouco tempo para atender a incorporao da Zucchetti, analisar para evitar uso de eventos em cascata.
end;

procedure TForm7.EmailAtualizaBoletoscobranaClick(Sender: TObject);
var
  sSecoes :  TStrings;
  sParcelas, sArquivo, sEmail, sAssunto, sMSG     : String;
  bButton    : Integer;
  MyBookMark : tBookMark;
  Mais1Ini : tIniFile;
  I, II,  J : Integer;
  sMandados : String;
  MyBookMark1 : TBookMark;
  sArquivoPDF: String; // Sandro Silva 2022-12-22
  PDF :TPdfDocumentGDI;
  PAGE : TPdfPage;
begin
  Form40.Tag := ID_TIPO_COBRANCA_ATUALIZA_BOLETOS;
  Form40.CheckBox1.Visible := True;
  Form40.ShowModal;

  if Form1.Tag = 1 then
  begin
    bButton := Application.MessageBox(Pchar('Quer realmente mandar este e-mail de cobrana para os clientes' + chr(10) +
                 Chr(10) + 'filtrados?' +
                 Chr(10) +
                 Chr(10) ),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
    try
      if bButton = IDYES then
      begin
        I := 0;
        Form7.ibDataSet7.First;
        // Retorna onde parou
        Mais1ini  := TIniFile.Create('frente.ini');
        sRegistro := Mais1Ini.ReadString('mail','registro','FIM') ;
        //
        if sRegistro <> 'FIM' then
        begin
          bButton := Application.MessageBox(Pchar('Quer recomear de onde parou?'),'Ateno', mb_YesNo + mb_DefButton1 + MB_ICONQUESTION);
          //
          if bButton = IDYES then
          begin
            while (not Form7.ibDataSet7.Eof) and (sRegistro <> Form7.ibDataSet7.FieldByName('REGISTRO').AsString) do
            begin
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');  //
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;

              Form7.ibDataSet7.Next;
            end;

            if sRegistro = Form7.ibDataSet7.FieldByName('REGISTRO').AsString then
            begin
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                I := I + 1;
              end;

              Form7.ibDataSet7.Next;
            end;
          end else
          begin
            sMandados := '';
          end;
        end;

        Mais1ini.Free;
        Screen.Cursor            := crHourGlass;
        
        while not Form7.ibDataSet7.Eof do
        begin
          if (Pos(Form7.ibDataSet7NOME.AsString,sMandados)=0) and (Form7.ibDataSet7ATIVO.AsFloat=0) then
          begin
            try
              // Relaciona os clientes com o arquivo de vendas
              Form7.ibDataSet2.Close;
              Form7.ibDataSet2.Selectsql.Clear;
              Form7.ibDataSet2.Selectsql.Add('select * from CLIFOR where NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' ');
              Form7.ibDataSet2.Open;
              //
              if ValidaEmail(AllTrim(Form7.ibDataSet2EMAIL.AsString)) then
              begin
                sArquivo := '';
                sArquivoPDF := Form1.sAtual+'\boletos_' + LimpaNumero(Form7.IBDataSet2CGC.AsString) + '.pdf'; // Sandro Silva 2022-12-22
                //
                if Form7.sModulo = 'RECEBER' then
                begin
                  if Form40.CheckBox1.Checked then
                  begin
                    while FileExists(sArquivoPDF) do  // Sandro Silva 2022-12-22 while FileExists(Form1.sAtual+'\boletos.pdf') do
                    begin
                      DeleteFile(pChar(sArquivoPDF)); // Sandro Silva 2022-12-22 DeleteFile(pChar(Form1.sAtual+'\boletos.pdf'));
                      Sleep(1000);
                    end;

                    MyBookMark := Form7.ibDataSet7.GetBookmark();
                    Form7.ibDataSet7.DisableControls;

                    try
                      // Grava o local para voltar
                      MyBookMark1 := Form7.ibDataSet7.GetBookMark();

                      // Cria o PDF
                      {Mauricio Parizotto 2024-15-02
                      PDF := TPrintPDF.Create(Self);

                      // Configuraes do documento
                      PDF.TITLE       := 'Boletos';
                      PDF.Creator     := 'Small Commerce';
                      PDF.Author      := 'Small Commerce';
                      PDF.Keywords    := 'Small Commerce';
                      PDF.Producer    := 'Small Commerce';
                      PDF.Subject     := 'Boletos de cobrana';
                      PDF.JPEGQuality := 100;
                      PDF.Compress    := False;
                      //
                      // Tamanho do A4 21,0 cm x 29,7 cm
                      //
                      PDF.PageWidth   :=  735;
                      PDF.PageHeight  :=  1039;
                      //
                      // Nome do arquivo para salvar
                      //
                      PDF.FileName    := sArquivoPDF;// sFileCFeSAT; // Sandro Silva 2022-12-22 PDF.FileName    := Form1.sAtual+'\boletos.pdf';// sFileCFeSAT;
                      PDF.BeginDoc;
                      }

                      try
                        PDF:=TPdfDocumentGDI.Create();
                        PDF.Info.Author       := 'Small';
                        PDF.Info.Creator      := 'Small';
                        PDF.Info.Title        := 'Boletos';
                        PDF.Info.Subject      := 'Boletos de cobrana';
                        PDF.Info.CreationDate := now;
                        PDF.DefaultPaperSize := psA4; //Tamanho A4
                        PDF.ForceJPEGCompression := 0;
                        PDF.AddTrueTypeFont('Interleaved 2of5 Text');
                        PDF.EmbeddedTTF := True;
                        PDF.EmbeddedWholeTTF := true;

                        Form7.ibDataSet7.First;
                        while not Form7.ibDataSet7.Eof do
                        begin
                          if Form7.ibDataSet7NOME.AsString = Form7.ibDataSet2NOME.AsString then
                          begin
                            if ibDataSet7ATIVO.AsString <> '1' then // No imprime boleto inativo
                            begin
                              if Form7.ibDataSet7VALOR_RECE.AsFloat = 0 then
                              begin
                                Form1.sEscolhido := '';
                                Form1.sBancoBoleto := '';

                                try
                                  sSecoes := TStringList.Create;
                                  Mais1ini := TIniFile.Create(Form1.sAtual+'\smallcom.inf');
                                  Mais1Ini.ReadSections(sSecoes);

                                  for J := 0 to (sSecoes.Count - 1) do
                                  begin
                                    if ((Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',8,3))
                                     or (Copy(Mais1Ini.ReadString(sSecoes[J],'Cdigo do banco',''),1,3) = Copy(Form7.ibDataset7PORTADOR.AsString+'XXXXXXXXXXXXX',10,3)))
                                    and ((Mais1Ini.ReadString(sSecoes[J],'CNAB400','') = 'Sim')
                                      or (Mais1Ini.ReadString(sSecoes[J],'CNAB240','') = 'Sim')) then
                                    begin
                                      Form1.sEscolhido := sSecoes[J];
                                    end;
                                  end;

                                  Mais1Ini.Free;
                                except
                                end;

                                if (AllTrim(Form1.sEscolhido) <> '') or (Form1.DisponivelSomenteParaNos) then // Sandro Silva 2022-12-22 if AllTrim(Form1.sEscolhido) <> '' then
                                begin
                                  Form1.sBancoBoleto     := Trim(StringReplace(Form1.sEscolhido, 'Boleto de cobrana do', '', [rfReplaceAll]));
                                  Form25.EventoShow;
                                  Form25.CarregaConfiguracao;
                                  Form25.CarregaDadosParcela;

                                  {Sandro Silva 2022-12-23 inicio}
                                  if Form1.DisponivelSomenteParaNos then
                                  begin
                                    if UpperCase(Copy(AllTrim(Form7.ibDataSet7PORTADOR.AsString),1,7)) <> 'BANCO (' then
                                    begin
                                      Form25.GravaPortadorNossoNumCodeBar;
                                    end;
                                  end;
                                  {Sandro Silva 2022-12-23 fim}

                                  Form7.Repaint;

                                  PAGE := pdf.AddPage;
                                  PAGE.PageLandscape := False;

                                  DesenhaBoletoLayoutPadrao(PDF.VCLCanvas, grPDF, Copy(Form26.MaskEdit42.Text,1,3), Form26.MaskEdit44.Text, Form26.MaskEdit46.Text, Form26.MaskEdit50.Text, Form26.MaskEdit43.Text, Form26.MaskEdit47.Text, Form26.MaskEdit45.Text);
                                end;
                              end;
                            end;
                          end;

                          Screen.Cursor            := crHourGlass;
                          Form7.ibDataSet7.Next;
                          Form25.Close;
                          Form7.Repaint;
                        end;

                        Form7.ibDataSet7.GotoBookmark(MyBookMark1);

                        PDF.SaveToFile(sArquivoPDF);
                      finally
                        FreeAndNil(PDF);
                      end;

                      if FileExists(sArquivoPDF) then // Sandro Silva 2022-12-22 if FileExists(Form1.sAtual+'\boletos.pdf') then
                        sArquivo := sArquivoPDF // Sandro Silva 2022-12-22 sArquivo := Form1.sAtual + '\boletos.pdf'
                      else
                        sArquivo := '';
                    except
                    end;

                    Form25.Close;
                    Form7.Repaint;

                    Form7.ibDataSet7.EnableControls;
                    Form7.ibDataSet7.GotoBookmark(MyBookMark);
                  end;
                end;

                sASsunto := Form40.Edit1.Text;
                sAssunto := StrTran(sASsunto,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);

                sEmail := Form7.ibDataSet2EMAIL.AsString; // XML POR EMAIL

                sMsg := Form40.Memo1.Lines.Text;

                // CLIENTES
                if I <> 0 then
                begin
                  for II := 1 to 700 do
                  begin
                    try
                      Sleep((60*60) div StrToInt(LimpaNumero(Form40.MaskEdit1.Text)));
                    except
                    end;

                    Application.ProcessMessages;
                  end;
                end;
                
                sMsg := StrTran(sMsg,'<NOME>'          ,Form7.ibDataSet2.FieldByName('NOME'     ).AsString);
                sMsg := StrTran(sMsg,'<CONTATO>'       ,Form7.ibDataSet2.FieldByName('CONTATO'  ).AsString);
                sMsg := StrTran(sMsg,'<IE>'            ,Form7.ibDataSet2.FieldByName('IE'       ).AsString);
                sMsg := StrTran(sMsg,'<CGC>'           ,Form7.ibDataSet2.FieldByName('CGC'      ).AsString);
                sMsg := StrTran(sMsg,'<ENDERECO>'      ,Form7.ibDataSet2.FieldByName('ENDERE'   ).AsString);
                sMsg := StrTran(sMsg,'<BAIRRO>'        ,Form7.ibDataSet2.FieldByName('COMPLE'   ).AsString);
                sMsg := StrTran(sMsg,'<CIDADE>'        ,Form7.ibDataSet2.FieldByName('CIDADE'   ).AsString);
                sMsg := StrTran(sMsg,'<UF>'            ,Form7.ibDataSet2.FieldByName('ESTADO'   ).AsString);
                sMsg := StrTran(sMsg,'<CEP>'           ,Form7.ibDataSet2.FieldByName('CEP'      ).AsString);
                sMsg := StrTran(sMsg,'<FONE>'          ,Form7.ibDataSet2.FieldByName('FONE'     ).AsString);
                sMsg := StrTran(sMsg,'<FAX>'           ,Form7.ibDataSet2.FieldByName('FAX'      ).AsString);
                sMsg := StrTran(sMsg,'<EMAIL>'         ,Form7.ibDataSet2.FieldByName('EMAIL'    ).AsString);
                sMsg := StrTran(sMsg,'<OBS>'           ,Form7.ibDataSet2.FieldByName('OBS'      ).AsString);
                sMsg := StrTran(sMsg,'<CELULAR>'       ,Form7.ibDataSet2.FieldByName('CELULAR'  ).AsString);
                sMsg := StrTran(sMsg,'<CREDITO>'       ,Form7.ibDataSet2.FieldByName('CREDITO'  ).AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR1>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR1').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR2>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR2').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR3>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR3').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR4>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR4').AsString);
                sMsg := StrTran(sMsg,'<IDENTIFICADOR5>',Form7.ibDataSet2.FieldByName('IDENTIFICADOR5').AsString);
                sMsg := StrTran(sMsg,'<CONVENIO>'      ,Form7.ibDataSet2.FieldByName('CONVENIO' ).AsString);
                sMsg := StrTran(sMsg,'<DATANAS>'       ,Form7.ibDataSet2.FieldByName('DATANAS'  ).AsString);
                sMsg := StrTran(sMsg,'<CADASTRO>'      ,Form7.ibDataSet2.FieldByName('CADASTRO' ).AsString);
                sMsg := StrTran(sMsg,'<ULTIMA COMPRA>' ,Form7.ibDataSet2.FieldByName('ULTIMACO' ).AsString);
                //
                sMsg := StrTran(sMsg,'<LOCAL_E_DATA>'  ,Trim(Form7.ibDataSet13MUNICIPIO.AsString)+', '+Copy(DateTimeToStr(Date),1,2)+' de '
                                                                                  + Trim(MesExtenso( StrToInt(Copy(DateTimeToStr(Date),4,2)))) + ' de '
                                                                                     + Copy(DateTimeToStr(Date),7,4));
                //
                sMsg := StrTran(sMsg,'<TELEFONE_DO_EMITENTE>',Form7.ibDataSet13TELEFO.AsString);
                sMsg := StrTran(sMsg,'<NOME_EMITENTE>',       Form7.ibDataSet13NOME.AsString);
                sMsg := StrTran(sMsg,'<ENDERECO_EMITENTE>',   Form7.ibDataSet13ENDERECO.AsString);
                sMsg := StrTran(sMsg,'<BAIRRO_EMITENTE>',     Form7.ibDataSet13COMPLE.AsString);
                sMsg := StrTran(sMsg,'<CEP_EMITENTE>',        Form7.ibDataSet13CEP.AsString);
                sMsg := StrTran(sMsg,'<CIDADE_EMITENTE>',     Form7.ibDataSet13MUNICIPIO.AsString);
                sMsg := StrTran(sMsg,'<UF_EMITENTE>',         UpperCase(Form7.ibDataSet13ESTADO.AsString));
                //
                // TOTAL ATRASADO - Total acumulado
                //
                if Pos('<PARCELAS_VENCIDAS>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select * from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet2NOME.AsString)+' order by VENCIMENTO');
                  Form7.ibQuery1.Open;

                  sParcelas := '';

                  while not Form7.ibQuery1.eof do
                  begin
                    sParcelas := sParcelas +
                                'Documento: '+Copy(Form7.ibQuery1.fieldByname('DOCUMENTO').AsString   +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Emisso: '+Copy(Form7.ibQuery1.fieldByname('EMISSAO').AsString     +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Vencimento: '+Copy(Form7.ibQuery1.fieldByname('VENCIMENTO').AsString  +Replicate(' ',10),1,10)+' '+chr(10)+
                                'Valor: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_DUPL').AsFloat])+Replicate(' ',10),1,10)+' '+chr(10)+
                                'Atualizado: '+Copy(Format('%10.2n',[Form7.ibQuery1.fieldByname('VALOR_JURO').AsFloat])+Replicate(' ',10),1,10)+chr(10)+
                                IfThen(Trim(Form7.ibQuery1.fieldByname('CODEBAR').AsString) <> '', 'Cdigo de barras: '+Form7.ibQuery1.fieldByname('CODEBAR').AsString, '')+chr(10)+chr(10)// Sandro Silva 2023-02-10
                                ;

                    Form7.ibQuery1.Next;
                  end;

                  sMsg := StrTran(sMsg,'<PARCELAS_VENCIDAS>'    ,sParcelas);
                end;

                // TOTAL ATRASADO - Total acumulado
                if Pos('<TOTAL_ATRASADO>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_DUPL) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;
                  
                  sMsg := StrTran(sMsg,'<TOTAL_ATRASADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                end;

                if Pos('<TOTAL_ATUALIZADO>',sMsg) <> 0 then
                begin
                  // sql para somar o total atrasado deste cliente
                  Form7.ibQuery1.Close;
                  Form7.ibQuery1.Sql.Clear;
                  Form7.ibQuery1.Sql.Add('select sum(VALOR_JURO) from RECEBER where coalesce(VALOR_RECE,0)=0 and VENCIMENTO < CURRENT_DATE and coalesce(ATIVO,9)<>1 and NOME='+QuotedStr(Form7.ibDataSet7NOME.AsString)+' group by NOME');
                  Form7.ibQuery1.Open;

                  sMsg := StrTran(sMsg,'<TOTAL_ATUALIZADO>'    ,AllTrim(Format('%12.2n',[Form7.IBQuery1.FieldByName('SUM').AsFloat])));
                end;

                EnviarEMail('',sEmail,'',PChar(sAssunto),PChar(sMSG),PChar(sArquivo), False);

                I := I + 1;

                Mais1ini := TIniFile.Create('frente.ini');
                Mais1Ini.WriteString('mail','Registro',pchar(Form7.ibDataSet7.FieldByName('REGISTRO').AsString));
                Mais1Ini.Free;

                Form7.Panel1.Top  := (Form7.Height - Panel1.Height) div 2;
                Form7.Panel1.Left := (Form7.Width - Panel1.Width) div 2;
                Form7.Panel1.Visible := True;

                Form7.Panel1.Caption := AllTrim(IntToStr(I))+' e-mails enviados.';
                Form7.Panel1.Repaint;
              end;

              sMandados := sMandados + Form7.ibDataSet7NOME.AsString;
            except
            end;
         end;

         Form7.ibDataSet7.Next;
        end;
      end;
    except
    end;

    Screen.Cursor        := crDefault;
    Form7.Panel1.Visible := False;
    Form7.Repaint;
  end;
end;

function TForm7.CaracteresParaSequencialDocumentos: String;
begin
  // Gera lista com os caracteres que podem ser usados para identificar parcelas de contas a receber ou pagar
  Result := 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890' + DupeString('_',1000);
end;

function TForm7.ObtemNumeroDocumentoReceber(sNumeroNF: String; TipoRPS: String;
  iSequencialParcela: Integer): String;
// Gera o nmero do documento para o contas a receber
begin
  if TipoRPS <> 'S' then
  begin
    if Copy(sNumeroNF,10,3) = '002' then
    begin
      Result := 'S'+Copy(sNumeroNF,2,8) + Copy(CaracteresParaSequencialDocumentos,iSequencialParcela,1);
    end else
    begin
      Result := Copy(sNumeroNF,1,9) + Copy(CaracteresParaSequencialDocumentos,iSequencialParcela,1);
    end;
  end else
  begin
    Result := Copy(sNumeroNF,1,1)+'S'+Copy(sNumeroNF,3,7) + Copy(CaracteresParaSequencialDocumentos,iSequencialParcela,1);
  end;
end;

function TForm7.UltimaParcelaReceberDaNF(sNumeroNF: String): String;
var
  IBQPARCELA: TIBQuery;
begin
  // Retorna a ltima parcela da nota fiscal
  IBQPARCELA := CriaIBQuery(Form7.ibDataSet7.Transaction);
  try
    IBQPARCELA.Close;
    IBQPARCELA.SQL.Text :=
      'select first 1 ' +
      'DOCUMENTO as ULTIMAPARCELA ' +
      'from RECEBER ' +
      'where NUMERONF = :NUMERONF ' +
      'order by REGISTRO desc';
    IBQPARCELA.ParamByName('NUMERONF').AsString := sNumeroNF;
    IBQPARCELA.Open;
    Result := IBQPARCELA.FieldByName('ULTIMAPARCELA').AsString;
  except
  end;
  FreeAndNil(IBQPARCELA);

end;

procedure TForm7.LimparRetornosda1Click(Sender: TObject);
begin
  LimpaNFSE;
end;

procedure TForm7.odos1Click(Sender: TObject);
begin
  sWhere := '';

  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Sativos1Click(Sender: TObject);
begin
  sWhere := ' where COALESCE(ATIVO,0)=0 ';

  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Sinativos1Click(Sender: TObject);
begin
  sWhere := ' where COALESCE(ATIVO,0)=1 ';
  
  Form7.Close;
  Form7.Show;
end;

function TForm7.CorrigeCustoCompraNaVenda(dCustoCompra: Double): Double;
begin
  // Venda no  possvel com valor zerado
  // Valida se valor  zero definindo 0,01, igual como  feito para venda com o valor unitrio sendo o preo de venda
  if dCustoCompra = 0 then
    Result := 0.01
  else
    Result := dCustoCompra;
end;

//Mauricio Parizotto 2023-05-03
procedure TForm7.SelecionaMunicipio(vEstado, vText : string; vCampoCidade : TIBStringField; Valida : Boolean = True);
var
  FiltroUF : string;
begin
  vCampoCidade.AsString := vText;

  if ibDataSet39NOME.AsString <> '' then
  begin
    if Length(AllTrim(vEstado)) = 2 then
    begin
      // Procura dentro do estado
      FiltroUF := ' Where UF='+QuotedStr(vEstado);
    end;

    Form7.IBDataSet39.Close;
    Form7.IBDataSet39.SelectSQL.Text := ' Select * '+
                                        ' From MUNICIPIOS '+
                                        FiltroUF+
                                        ' Order by NOME';
    Form7.IBDataSet39.Open;

    ibDataSet39.Locate('NOME',AllTrim(vText),[loCaseInsensitive, loPartialKey]);

    if AllTrim(vText) <> '' then
    begin
      if Pos(AnsiUpperCase(AllTrim(vText)),AnsiUpperCase(ibDataSet39NOME.AsString)) <> 0 then
      begin
        vCampoCidade.AsString := ibDataSet39NOME.AsString
      end else
      begin
        if Valida then
        begin
          //ShowMessage('Municpio invlido.'); Mauricio Parizotto 2023-10-25
          MensagemSistema('Municpio invlido.',msgAtencao);
          vCampoCidade.AsString := '';
        end;
      end;
    end;
  end;
end;


procedure TForm7.SetDataSetCadastros(CaminhoIni: String);
var
  Ini: TIniFile;
begin
  Ini := TIniFile.Create(CaminhoIni);

  if sModulo = 'VENDEDOR' then
  begin
    Form7.sAjuda := 'config_vendedores.htm'; // Falta vendedores

    // Menu
    Form7.Menu              := Form7.mmVendedor;
    Form7.Relatriodecomisses1.Visible := True;

    // Sql
    Form7.sSelect   := 'select * from CLIFOR';
    Form7.sWhere    := 'where CLIFOR=''Vendedor''';

    Form7.sModulo := 'CLIENTES';
  end else
  begin
    Form7.sAjuda := 'clifor.htm';

    // Menu
    Form7.Menu            := Form7.mmCLifor;
    //2024-01-10 Mostrartodososclientesefornecedores1.Checked := True;

    // Sql
    Form7.sSelect   := 'select * from CLIFOR';
    Form7.sWhere    := Ini.ReadString(sModulo,'FILTRO','');
  end;

  // Arquivo

  Form7.ArquivoAberto          := DataSource2.Dataset;
  Form7.TabelaAberta           := ibDataSet2;
  Form7.DataSourceAtual        := DataSource2;
  Form7.sMostra   := Ini.ReadString(sModulo,'Mostrar','TTTFTTTT' + Replicate('F', 19));
  sOrderBy  := 'order by '+ Ini.ReadString(sModulo,'ORDEM','NOME');
  Form7.iCampos   := 27;
  Ini.Free;
end;

procedure TForm7.ibDataSet18MUNICIPIOSetText(Sender: TField; const Text: String);
var
  vEstado : string;
begin
  vEstado := Form7.ibDataSet18UF.AsString;
  SelecionaMunicipio(vEstado,Text,(Sender as TIBStringField),False);
end;

procedure TForm7.EEnviarcartadecorreoporemail1Click(Sender: TObject);
begin
  EnviarEmailCCe(Form7.ibDataSet15CCEXML.AsString);
end;

procedure TForm7.EnviarEmailCCe(AcXML: String);
var
  cCaminhoXML: String;
  cNomeArqXML: String;
  cArqXML: String;
  cCaminhoPDF: string;
  cNomeArqPDF: string;
  cMensagem: String;
  cAnexo: string;
  cMsgAnexo: String;
  cEmail: String;
  slXML: TStringList;
begin
  if AcXML = EmptyStr then
    Exit;

  cEmail := Form7.ibDataSet2EMAIL.AsString;

  if (cEmail = EmptyStr) or (not validaEmail(cEmail)) then
    Exit;

  cCaminhoXML := Form1.sAtual + '\XmlDestinatario\';
  cCaminhoPDF := Form1.sAtual + '\';
  cNomeArqXML := Form7.ibDAtaSet15NFEID.AsString+'-CCe.';
  cNomeArqPDF := 'CCe_NF_' + Form7.ibDataSet15NUMERONF.AsString + '.pdf';

  try
    if sEnviarDAnfePorEmail = 'S' then
    begin
      if not FileExists(cCaminhoXML + cNomeArqXML + 'xml') then
      begin
        slXML := TStringList.Create;
        try
          slXML.Text := AcXML;
          slXML.SaveToFile(cCaminhoXML + cNomeArqXML + 'xml');
        finally
          FreeAndNil(slXML);
        end;
      end;

      if FileExists(cCaminhoPDF + cNomeArqPDF) then
        DeleteFile(PChar(cCaminhoPDF + cNomeArqPDF));

      spdNFe.ExportarCCe(AcXML, cCaminhoPDF + cNomeArqPDF);
      Sleep(100);
    end;
    if sZiparXML = 'S' then
    begin
      //
      ShellExecute( 0, 'Open','szip.exe', pChar('backup "'+Alltrim(pChar(cCaminhoXML + cNomeArqXML + 'xml'))+'" "'+
      Alltrim(pChar(cCaminhoXML + cNomeArqXML +'zip'))+'"'),'', SW_SHOWMAXIMIZED);
      //
      while ConsultaProcesso('szip.exe') do
      begin
        Application.ProcessMessages;
        sleep(100);
      end;
      //
      while not FileExists( pChar(cCaminhoXML + cNomeArqXML + 'zip')) do
      begin
        sleep(100);
      end;
      cArqXML := cCaminhoXML + cNomeArqXML + 'zip';
    end else
      cArqXML := cCaminhoXML + cNomeArqXML + 'xml';
    if FileExists(cCaminhoPDF + cNomeArqPDF) then
    begin
      cAnexo    := cCaminhoPDF + cNomeArqPDF;
      cMsgAnexo := 'PDF';
    end;
    if (FileExists(cArqXML)) then
    begin
      if cAnexo <> EmptyStr then
      begin
        cAnexo := cAnexo + ';';
        cMsgAnexo := 'XML e o PDF';
      end else
        cMsgAnexo := 'XML';
      cAnexo := cAnexo + cArqXML;
    end;

    if cAnexo = EmptyStr then
      Exit;

    cMensagem := TTextoEmailFactory.New
                                   .CCe
                                   .setDescrAnexo(cMsgAnexo)
                                   .setDataEmissao(Form7.ibDataSet15EMISSAO.AsDateTime)
                                   .setNumeroDocumento(Form7.ibDataSet15NUMERONF.AsString)
                                   .setChaveAcesso(Form7.ibDataSet15NFEID.AsString)
                                   .setPropaganda(Form1.sPropaganda)
                                   .RetornarTexto;

    //2024-02-26 EnviarEMail('',cEmail,'','Carta de correo Eletrnica emitida', pchar(cMensagem), cAnexo, False);
    EnviarEMail('', cEmail,'', PChar('Carta de correo Eletrnica emitida'), PChar(cMensagem), PChar(cAnexo), False);
  finally
    if FileExists(cCaminhoPDF + cNomeArqPDF) then
      DeleteFile(PChar(cCaminhoPDF + cNomeArqPDF));
  end;
end;


procedure TForm7.CalculaFCPSTAoIncluirProdutoDevolucao;// Sandro Silva 2023-05-08
begin
  // Calcula o FCP ST para devoluo
  // Sandro Silva 2023-05-18 if Form7.ibDataSet15FINNFE.AsString = '4' then
  if NFeFinalidadeDevolucao(Form7.ibDataSet15FINNFE.AsString) then
  begin
    if (Form7.ibDataSet16TOTAL.Value > 0) and (Form7.ibDataSet16VBCFCPST.Value > 0) then
    begin
      if Arredonda(Form7.ibDataSet16VBCFCPST.AsFloat * Form7.ibDataSet16PFCPST.AsFloat / 100, 2) <> Form7.ibDataSet16VFCPST.AsFloat then
      begin
        //if Form7.ibDataSet16VBCFCPST.AsString = '' then
        //  Form7.ibDataSet16VBCFCPST.AsFloat := Form7.ibDataSet16BASE.AsFloat;
        //F-7824 Sandro Silva 2024-01-17 Form7.ibDataSet16VFCPST.AsFloat   := Arredonda(Form7.ibDataSet16VBCFCPST.AsFloat * Form7.ibDataSet16PFCPST.AsFloat / 100, 2);
      end;
    end;
  end;
end;

procedure TForm7.ibDataSet16PFCPSTChange(Sender: TField);
//var
//  dPFCPSTOld: Double;
begin
//  dPFCPSTOld := StrtoFloat(FormatFloat(Form7.ibDataSet16PFCPST.DisplayFormat, StrtoFloatDef(VarToStrDef(Form7.ibDataSet16PFCPST.OldValue, '0,00'), 0.00)));
//  if (dPFCPSTOld <> Form7.ibDataSet16PFCPST.AsFloat) then
  CalculaFCPSTAoIncluirProdutoDevolucao; // Sandro Silva 2023-05-08
end;

procedure TForm7.ibDataSet16VBCFCPSTChange(Sender: TField);
begin
//  if (StrtoFloatDef(VarToStrDef(Form7.ibDataSet16VBCFCPST.OldValue, '0,00'), 0.00) <> Form7.ibDataSet16VBCFCPST.Value) then
    CalculaFCPSTAoIncluirProdutoDevolucao; // Sandro Silva 2023-05-08
end;

function TForm7.ValidaLimiteDeEmissaoDeVenda(dtBaseVerificar: TDate): Boolean;
begin
  Result := False;
  if Form1.ValidaRecursos.ValidaQtdDocumentoRetaguarda(dtBaseVerificar) = False then
  begin
    Form1.MensagemRecursoIndisponivel(
      'Voc j emitiu o nmero limite de documentos fiscais'+chr(10)+
      'permitidos para esta verso do sistema');
  end
  else
    Result := True;
end;

procedure TForm7.FormActivate(Sender: TObject);
begin
  Oramento1.Enabled                 := True;
  Inventrio1.Enabled                := True;
  SPEDFiscal1.Enabled               := True;
  SPEDPISCOFINS1.Enabled            := True;
  RegistroFiscal1.Enabled           := True;
  Etiquetas1.Enabled                := True;
  EtiquetasZebraArgoxElgin1.Enabled := True;
  ImportarOS1.Enabled               := True;

  Relatriodeservios1.Enabled               := True;
  Relatriodeprodutosmonofsicos1.Enabled    := True;
  RelatriodeprodutosmonofsicosNFe1.Enabled := True;
  RelatriodeIPI1.Enabled                   := True;
  RelatriodePISCOFINSCupomFiscal1.Enabled  := True;
  RelatriodePISCOFINS1.Enabled             := True;
  Relatriodeoramentospendentes1.Enabled    := True;
  Resumodasvendas1.Enabled                 := True;
  Resumodascompras1.Enabled                := True;
  Previsodecompra1.Enabled                 := True;
  ImportarOramento1.Enabled                := True;
  
  DuplicatestaNFe1.Enabled                 := True;

  miRelVendasServico.Enabled               := Form1.ValidaRecursos.PermiteRecursoParaProduto;
  miRelProdMonofasicosCupom.Enabled        := Form1.ValidaRecursos.PermiteRecursoParaProduto;
  miRelCompRestICMS.Enabled                := Form1.ValidaRecursos.PermiteRecursoParaProduto;
  miRelResumoVendasVendas.Enabled          := Form1.ValidaRecursos.PermiteRecursoParaProduto;
  miRelCorrelacao.Enabled                  := Form1.ValidaRecursos.PermiteRecursoParaProduto;

  PrevCompra.Enabled                       := True;

  if Form1.ValidaRecursos.PermiteRecursoParaProduto = False then
  begin
    Oramento1.Enabled                 := False;
    Inventrio1.Enabled                := False;
    SPEDFiscal1.Enabled               := False;
    SPEDPISCOFINS1.Enabled            := False;
    RegistroFiscal1.Enabled           := False;
    Etiquetas1.Enabled                := False;
    EtiquetasZebraArgoxElgin1.Enabled := False;
    ImportarOS1.Enabled               := False;

    Relatriodeservios1.Enabled               := False;
    Relatriodeprodutosmonofsicos1.Enabled    := False;
    RelatriodeprodutosmonofsicosNFe1.Enabled := False;
    RelatriodeIPI1.Enabled                   := False;
    RelatriodePISCOFINSCupomFiscal1.Enabled  := False;
    RelatriodePISCOFINS1.Enabled             := False;
    Relatriodeoramentospendentes1.Enabled    := False;
    Resumodasvendas1.Enabled                 := False;
    Resumodascompras1.Enabled                := False;
    Previsodecompra1.Enabled                 := False;
    ImportarOramento1.Enabled                := False;

    DuplicatestaNFe1.Enabled                 := False;

    PrevCompra.Enabled                       := False;
  end;
end;

procedure TForm7.RefreshDados;
begin
  Screen.Cursor            := crHourGlass;
  AgendaCommit(True);

  Form7.Close;
  Form7.Show;
  
  Screen.Cursor            := crDefault;
end;

procedure TForm7.HintTotalNotaCompra;
begin
  Form24.edtTotalNota.ShowHint := True;
  Form24.edtTotalNota.Hint     := '+ Mercadoria: '+FloatToStr(Form7.ibDataSet24MERCADORIA.Value)+CHR(10)+
                                  '+ Servios: '+FloatToStr(Form7.ibDataSet24SERVICOS.Value)+CHR(10)+
                                  '+ Frete: '+FloatToStr(Form7.ibDataSet24FRETE.Value)+CHR(10)+
                                  '+ Seguro: '+FloatToStr(Form7.ibDataSet24SEGURO.Value)+CHR(10)+
                                  '+ IPI: '+FloatToStr(Form7.ibDataSet24IPI.Value)+CHR(10)+
                                  '+ ICMS Substituio: '+FloatToStr(Form7.ibDataSet24ICMSSUBSTI.Value)+CHR(10)+
                                  '+ FCP ST: '+FloatToStr(Form7.ibDataSet24VFCPST.Value)+CHR(10)+
                                  '+ Despesas: '+FloatToStr(Form7.ibDataSet24DESPESAS.Value)+CHR(10)+
                                  '- Desconto: '+FloatToStr(Form7.ibDataSet24DESCONTO.Value)+CHR(10)+
                                  '- ICMS Desonerado: '+FloatToStr(Form7.ibDataSet24ICMS_DESONERADO.Value)+CHR(10);
end;

procedure TForm7.HintTotalNotaVenda(fRetencao : Real);
begin
  Form12.edtTotalNota.ShowHint := True;
  Form12.edtTotalNota.Hint     := '+ Mercadoria: '+FloatToStr(Form7.ibDataSet15MERCADORIA.Value)+CHR(10)+
                                  '+ Servios: '+FloatToStr(Form7.ibDataSet15SERVICOS.Value)+CHR(10)+
                                  '+ Frete: '+FloatToStr(Form7.ibDataSet15FRETE.Value)+CHR(10)+
                                  '+ Seguro: '+FloatToStr(Form7.ibDataSet15SEGURO.Value)+CHR(10)+
                                  '+ IPI: '+FloatToStr(Form7.ibDataSet15IPI.Value)+CHR(10)+
                                  '+ ICMS Substituio: '+FloatToStr(Form7.ibDataSet15ICMSSUBSTI.Value)+CHR(10)+
                                  '+ FCP ST: '+FloatToStr(Form7.ibDataSet15VFCPST.Value)+CHR(10)+
                                  '+ Despesas: '+FloatToStr(Form7.ibDataSet15DESPESAS.Value)+CHR(10)+
                                  '- Desconto: '+FloatToStr(Form7.ibDataSet15DESCONTO.Value)+CHR(10)+
                                  '- Retenes: '+FloatToStr(Form1.fRetencoes)+CHR(10)+
                                  '- Reteno de IR: '+FloatToStr(fRetencao)+CHR(10);
end;

procedure TForm7.ibDataSet7FilterRecord(DataSet: TDataSet;
  var Accept: Boolean);
begin
  {Sandro Silva 2023-10-02 inicio
  //Aplica filtro na contas a receber para listar apenas aquelas que podem gerar boleto quando estiver gerando a partir da tela de desdobramento de parcelas da nota
  if Form7.ibDataSet7.Tag = ID_FILTRAR_FORMAS_GERAM_BOLETO then
  begin
    Accept := FormaDePagamentoGeraBoleto(Form7.ibDataSet7FORMADEPAGAMENTO.AsString);
  end;
  }
  case Form7.ibDataSet7.Tag of
    ID_FILTRAR_FORMAS_GERAM_BOLETO:
    begin
      Accept := FormaDePagamentoGeraBoleto(Form7.ibDataSet7FORMADEPAGAMENTO.AsString);
    end;
    ID_FILTRAR_FORMAS_GERAM_CARNE_DUPLICATA:
    begin
      Accept := FormaDePagamentoGeraCarneDuplicata(Form7.ibDataSet7FORMADEPAGAMENTO.AsString);
    end;
  end;
  {Sandro Silva 2023-10-02 fim}
end;

procedure TForm7.ibDataSet7AfterScroll(DataSet: TDataSet);
begin
  if FrmParcelas <> nil then
  begin
    FrmParcelas.SetPickListParaColuna;
  end;
end;

procedure TForm7.FormDestroy(Sender: TObject);
begin
  {Sandro Silva 2023-07-05 inicio}
  slPickListBandeira.Free;
  slPickListFormaDePagamento.Free;
  slPickListBanco.Free;
  slPickListInstituicao.Free;
  {Sandro Silva 2023-07-05 fim}
  {Sandro Silva 2023-10-02 inicio}
  FreeAndNil(oArqConfiguracao);
  {Sandro Silva 2023-10-02 fim}
end;

procedure TForm7.ibDataSet15SAIDADChange(Sender: TField);
begin
  ibDataSet15SAIDAD.OnChange := nil;
  try
  if ibDataSet15SAIDAD.Value = 0 then
    ibDataSet15SAIDAD.Clear;
  finally
    ibDataSet15SAIDAD.OnChange := ibDataSet15SAIDADChange;
  end;
end;

procedure TForm7.RelatriodevendasporclienteNFeCupom1Click(Sender: TObject);
begin
  CriaJpg('logotip.jpg');
  TChamaRelatorioFactory.New
                        .VendasPorCliente
                        .setDataBase(IBDatabase1)
                        .setImagem(imgImprimir.Picture)
                        .setUsuario(Usuario)
                        .ChamarTela;
end;

procedure TForm7.Relatrios5Click(Sender: TObject);
begin
  MenuItem119.Caption    := 'Convnio '+AllTrim(ibDataSet29NOME.AsString);
end;

function TForm7.GetMensagemCertificado(vLocal:string='') : string;
var
  DtVencimento : TDateTime;
begin
  Result := '';

  if vLocal = 'ABERTURA' then
  begin
    Result := #13#10;
  end;

  //Nenhum certificado
  if TSistema.GetInstance.CertificadoTipo = '' then
  begin
    Exit;
  end;

  try
    {Mauricio Parizotto 2024-02-22 Inicio}
    //ConfiguraNFE; // Sandro Silva 2023-07-21 Precisa carregar a configurao para usar o componente spdNFe
    //DtVencimento := spdNFe.GetVencimentoCertificado;
    DtVencimento := TSistema.GetInstance.CertificadoDtVal;
    {Mauricio Parizotto 2024-02-22 Fim}

    if DtVencimento >= Date then
      Result := Result+'Seu certificado digital ir vencer em '+FormatFloat('0', DtVencimento - Date) + ' dia(s) '+'('+DateToStr(DtVencimento)+').'
    else
      Result := Result+'Seu certificado digital venceu no dia '+DateToStr(DtVencimento);

    //S exibe se vencimento for menor que 30 dias
    if ((DtVencimento - Date) > 30) and (vLocal <> 'ABERTURA' ) then
      Result := '';
  except
  end;
end;

procedure TForm7.CalculaTotalNota;
begin
  if Alltrim(Form7.ibDataSet24FRETE12.AsString) <> '1' then
  begin
     Form7.ibDataSet24TOTAL.AsFloat := Form7.ibDataSet24MERCADORIA.AsFloat
                                       - Form7.ibDataSet24DESCONTO.AsFloat
                                       + Form7.ibDataSet24SERVICOS.AsFloat
                                       + Form7.ibDataSet24ICMSSUBSTI.AsFloat
                                       + Form7.ibDataSet24DESPESAS.AsFloat
                                       + Form7.ibDataSet24SEGURO.AsFloat       
                                       + Form7.ibDataSet24IPI.AsFloat
                                       + Form7.ibDataSet24VFCPST.AsFloat
                                       - Form7.ibDataSet24ICMS_DESONERADO.AsFloat
                                       ;
  end else
  begin
     Form7.ibDataSet24TOTAL.AsFloat := Form7.ibDataSet24MERCADORIA.AsFloat
                                       - Form7.ibDataSet24DESCONTO.AsFloat
                                       + Form7.ibDataSet24SERVICOS.AsFloat
                                       + Form7.ibDataSet24ICMSSUBSTI.AsFloat
                                       + Form7.ibDataSet24DESPESAS.AsFloat
                                       + Form7.ibDataSet24FRETE.AsFloat
                                       + Form7.ibDataSet24SEGURO.AsFloat
                                       + Form7.ibDataSet24IPI.AsFloat
                                       + Form7.ibDataSet24VFCPST.AsFloat
                                       - Form7.ibDataSet24ICMS_DESONERADO.AsFloat
                                       ;
  end;

  if Copy(Form7.ibDataSet14CFOP.AsString,1,1) = '3' then
    Form7.ibDataSet24TOTAL.AsFloat := Form7.ibDataSet24TOTAL.AsFloat + Form7.ibDataSet24ICMS.AsFloat;

  //Mauricio Parizotto 2023-06-06
  HintTotalNotaCompra;
end;

function TForm7.RetornarAliquotaICM(AcUF: String): Currency;
begin
  Result := ibDataSet14.fieldbyname(AcUF+'_').AsCurrency;
end;

procedure TForm7.ibDataSet16AfterOpen(DataSet: TDataSet);
begin
  AtualizarListaItensAuxiliar;
end;

procedure TForm7.Oramentospendentes1Click(Sender: TObject);
begin
  sWhere := ' where COALESCE(ORCAMENTS.NUMERONF,'''') = '''' ';

  Form7.Close;
  Form7.Show;
end;

procedure TForm7.Oramentosfinalizados1Click(Sender: TObject);
begin
  sWhere := ' where COALESCE(ORCAMENTS.NUMERONF,'''') <> '''' ';

  Form7.Close;
  Form7.Show;
end;

procedure TForm7.odos2Click(Sender: TObject);
begin
  sWhere := '';

  Form7.Close;
  Form7.Show;
end;

procedure TForm7.IBDataSet2ENDERESetText(Sender: TField;
  const Text: String);
begin
  IBDataSet2ENDERE.AsString := AllTrim(Text);
end;

procedure TForm7.IBDataSet2COMPLESetText(Sender: TField;
  const Text: String);
begin
  IBDataSet2COMPLE.AsString := AllTrim(Text);
end;

function TForm7.TestarClienteExiste(AcTexto: String): Boolean;
begin
  Result := Valida_Campo('CLIFOR',AllTrim(AcTexto),'NOME', EmptyStr);
end;

procedure TForm7.IBDataSet2EMAILSetText(Sender: TField; const Text: String);
begin
  IBDataSet2EMAIL.OnSetText := nil;
  try
    IBDataSet2EMAIL.Text := AllTrim(Text);
  finally
    IBDataSet2EMAIL.OnSetText := IBDataSet2EMAILSetText;
  end;
end;

function TForm7.TestarProdutoExiste(AcTexto: String): Boolean;
begin
  Result := Valida_Campo('ESTOQUE', AllTrim(AcTexto), 'DESCRICAO', EmptyStr);
end;

procedure TForm7.ConversodeCFOP1Click(Sender: TObject);
begin
  Form7.Close;
  Form7.sModulo := 'CONVERSAOCFOP';
  Form7.sTitulo := 'Converso de CFOP';
  Form7.sRPS := 'N';
  Form7.Show;
end;

procedure TForm7.ibdConversaoCFOPAfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibdConversaoCFOPBeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibdConversaoCFOP);
end;

procedure TForm7.ibdConversaoCFOPBeforeEdit(DataSet: TDataSet);
begin
  sNumeroAnterior := ibdConversaoCFOPREGISTRO.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibdConversaoCFOPBeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_CFOPCONVERSAO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibdConversaoCFOPNewRecord(DataSet: TDataSet);
begin
  ibdConversaoCFOP.Edit;
  ibdConversaoCFOPREGISTRO.AsString := sProximo;
end;

procedure TForm7.ibdConversaoCFOPCFOP_ORIGEMSetText(Sender: TField;
  const Text: String);
var
  cTexto: String;
begin
  cTexto := Text;

  if (AllTrim(ibdConversaoCFOPCFOP_ORIGEM.AsString) <> '') and (AllTrim(cTexto) = '') then
  begin
    {
    Application.MessageBox(Pchar('CFOP Origem invlido (no pode ficar em branco).')
                                 ,'Ateno',mb_Ok + MB_ICONWARNING);
    Mauricio Parizotto 2023-10-24}

    MensagemSistema('CFOP Origem invlido (no pode ficar em branco).'
                    ,msgAtencao);
  end else
  begin
    if Valida_Campo('CFOPCONVERSAO',AllTrim(cTexto),'CFOP_ORIGEM','O CFOP de origem ('+cTexto+') j foi vinculado.') then
      ibdConversaoCFOPCFOP_ORIGEM.AsString := AllTrim(cTexto);
  end;
end;

procedure TForm7.ConfiguraodeICMSeISS1Click(Sender: TObject);
begin
  Form7.Close;
  Form7.sModulo := 'ICM';
  Form7.sTitulo := 'Operaes de venda e tabela de ICMS dos estados';

  {$IFDEF VER150}
  Form7.DBGrid1.Options := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs];
  {$ELSE}
  Form7.DBGrid1.Options := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgTitleClick];
  {$ENDIF}

  Form7.Show;
end;

procedure TForm7.ibdPerfilTributaAfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibdPerfilTributaBeforeEdit(DataSet: TDataSet);
begin
  sNumeroAnterior := ibdPerfilTributaREGISTRO.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibdPerfilTributaBeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_PERFILTRIBUTACAO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    sProximoID := StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibdPerfilTributaNewRecord(DataSet: TDataSet);
begin
  ibdPerfilTributa.Edit;
  ibdPerfilTributaREGISTRO.AsString := sProximo;
  ibdPerfilTributaIDPERFILTRIBUTACAO.AsInteger := sProximoID;

  ibdPerfilTributaIPPT.AsString         := 'T';
  ibdPerfilTributaIAT.AsString          := 'T';
end;

procedure TForm7.ibdPerfilTributaAfterPost(DataSet: TDataSet);
begin
  if AllTrim(ibdPerfilTributaDESCRICAO.AsString) = '' then
    ibdPerfilTributa.Delete;
end;

procedure TForm7.ibdPerfilTributaDESCRICAOSetText(Sender: TField;
  const Text: String);
var
  cTexto: String;
begin
  cTexto := Text;

  if (AllTrim(ibdPerfilTributaDESCRICAO.AsString) <> '') and (AllTrim(cTexto) = '') then
  begin
    {
    Application.MessageBox(Pchar('Descrio invlida (no pode ficar em branco).')
                                 ,'Ateno',mb_Ok + MB_ICONWARNING);
    Mauricio Parizotto 2023-10-24}

    MensagemSistema('Descrio invlida (no pode ficar em branco).'
                    ,msgAtencao);
  end else
  begin
    if Valida_Campo('PERFILTRIBUTACAO',AllTrim(cTexto),'DESCRICAO','Este perfil j foi cadastrado.') then
      ibdPerfilTributaDESCRICAO.AsString := AllTrim(cTexto);
  end;

  Form10.Caption := ibdPerfilTributaDESCRICAO.AsString;
end;

procedure TForm7.ibdPerfilTributaBeforePost(DataSet: TDataSet);
var
  QtdProdPerfil : integer;
  ProdutosErro : string;
begin
  //Verifica se precisa alterar dados dos produtos com o perfil selecionado
  QtdProdPerfil := 0;

  if (CampoAlterado(ibdPerfilTributaTIPO_ITEM))
    or (CampoAlterado(ibdPerfilTributaIPPT))
    or (CampoAlterado(ibdPerfilTributaIAT))
    or (CampoAlterado(ibdPerfilTributaPIVA))
    or (CampoAlterado(ibdPerfilTributaCST))
    or (CampoAlterado(ibdPerfilTributaCSOSN))
    or (CampoAlterado(ibdPerfilTributaST))
    or (CampoAlterado(ibdPerfilTributaCFOP))
    or (CampoAlterado(ibdPerfilTributaCST_NFCE))
    or (CampoAlterado(ibdPerfilTributaCSOSN_NFCE))
    or (CampoAlterado(ibdPerfilTributaALIQUOTA_NFCE))
    or (CampoAlterado(ibdPerfilTributaCST_IPI))
    or (CampoAlterado(ibdPerfilTributaIPI))
    or (CampoAlterado(ibdPerfilTributaENQ_IPI))
    or (CampoAlterado(ibdPerfilTributaCST_PIS_COFINS_SAIDA))
    or (CampoAlterado(ibdPerfilTributaALIQ_PIS_SAIDA))
    or (CampoAlterado(ibdPerfilTributaALIQ_COFINS_SAIDA))
    or (CampoAlterado(ibdPerfilTributaCST_PIS_COFINS_ENTRADA))
    or (CampoAlterado(ibdPerfilTributaALIQ_COFINS_ENTRADA))
    or (CampoAlterado(ibdPerfilTributaALIQ_PIS_ENTRADA)) then
  begin
    QtdProdPerfil := ExecutaComandoEscalar(IBDatabase1,
                                           ' Select Count(*) QTD'+
                                           ' From ESTOQUE '+
                                           ' Where IDPERFILTRIBUTACAO = '+ibdPerfilTributaIDPERFILTRIBUTACAO.AsString);
  end;


  if (QtdProdPerfil > 0) then
  begin
    MensagemSistema('Houve alterao do perfil. Sero alterados '+IntToStr(QtdProdPerfil)+' produtos.');

    if AtualizaTibutacaoProduto(ibdPerfilTributaIDPERFILTRIBUTACAO.AsInteger,ProdutosErro) then
    begin
      MensagemSistema('Produtos atualizados com sucesso!');
    end else
    begin
      MensagemSistema('As informaes do perfil e dos produtos no puderam ser alteradas.'+#13#10+
                      'Verifique se o produto abaixo est em uso e tente novamente.'+#13#10+#13#10+
                      ProdutosErro,msgAtencao);

      DataSet.Cancel;
      Abort;
    end;
  end;
end;

procedure TForm7.ibdPerfilTributaBeforeDelete(DataSet: TDataSet);
var
  sApagar : string;
  sModulos : string;
begin
  if AllTrim(ibdPerfilTributaDESCRICAO.AsString) <> '' then
  begin
    if ExecutaComandoEscalar(IBDatabase1,
                             ' Select count(*) '+
                             ' From ESTOQUE '+
                             ' Where IDPERFILTRIBUTACAO = '+ibdPerfilTributaIDPERFILTRIBUTACAO.Asstring) > 0 then
    begin
      sModulos := sModulos + 'Mdulo de Estoque.'+chr(10);
    end;

    if ExecutaComandoEscalar(IBDatabase1,
                             ' Select count(*) '+
                             ' From PARAMETROTRIBUTACAO '+
                             ' Where IDPERFILTRIBUTACAO = '+ibdPerfilTributaIDPERFILTRIBUTACAO.Asstring) > 0 then
    begin
      sModulos := sModulos + 'Mdulo de Parmetros de Tributao.'+chr(10);
    end;

    if sModulos <> '' then
    begin
      sApagar := 'O sistema encontrou lanamentos referentes ao perfil: '+Chr(10)+ibdPerfilTributaDESCRICAO.AsString+Chr(10)+
                 Chr(10)+
                 sModulos+Chr(10)+
                 'Portanto no pode ser apagado.';

      MensagemSistema(sApagar,msgAtencao);
      Abort;
    end;
  end;
  RegistraExclusaoRegistro(ibdPerfilTributa);
end;

procedure TForm7.ibDataSet37AfterOpen(DataSet: TDataSet);
begin
  IbdOrcamentObs.Close;
  IbdOrcamentObs.Open;
end;

procedure TForm7.IbdOrcamentObsAfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.IbdOrcamentObsAfterPost(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;
   
procedure TForm7.EnviarOrcamentoPorEmail1Click(Sender: TObject);
var
  cMensagem: String;
  cEmail: String;
  cCaminhoArq: String;
  cPortaAnt: tTipoImpressaoOrcamento;
  oArqDAT: TArquivosDAT;
begin
  // Pega e-mail
  cEmail := Trim(EnviarOrcamentoPorEmail1.Caption);
  cEmail := Trim(Copy(cEmail, Pos('<', cEmail) + 1,  length(cEmail)));
  cEmail := Copy(cEmail,1, length(cEmail)-1);

  if not ValidaEmail(cEmail) then
    Exit;

  oArqDAT := TArquivosDAT.Create(Usuario);
  try
    // Define sempre como PDF para envio por e-mail
    cPortaAnt := oArqDAT.Frente.Orcamento.Porta;
    try
      oArqDAT.Frente.Orcamento.Porta := ttioPDF;
      // Gera o arquivo PDF
      TImpressaoOrcamento.New
                         .SetTransaction(IBDataSet97.Transaction)
                         .SetNumeroOrcamento(IBDataSet97.FieldByName('Oramento').AsString)
                         .GetCaminhoImpressao(cCaminhoArq)
                         .Salvar;

    finally
      oArqDAT.Frente.Orcamento.Porta := cPortaAnt;
    end;

    Sleep(500);

    if not FileExists(cCaminhoArq) then
    begin
      //ShowMessage('No foi possvel enviar o oramento.'); Mauricio Parizotto 2023-10-25
      MensagemSistema('No foi possvel enviar o oramento.',msgAtencao);
      Exit;
    end;
    
    // Monta mensagem para enviar
    cMensagem := TTextoEmailFactory.New
                                   .Orcamento
                                   .setDataEmissao(IBDataSet97.FieldByName('Data').AsDateTime)
                                   .setNumeroDocumento(IBDataSet97.FieldByName('Oramento').AsString)
                                   .RetornarTexto;
    // Envia o e-mail
    EnviarEMail('', cEmail, '', PChar('Seu Oramento'), PChar(cMensagem), PChar(cCaminhoArq), False);
  finally
    FreeAndNil(oArqDAT);
  end;
end;

procedure TForm7.ibDataSet4IDPERFILTRIBUTACAOChange(Sender: TField);
begin
  {Dailon Parisotto 2023-10-09 Inicio}
  if FbDuplicandoProd then
    Exit;
  {Dailon Parisotto 2023-10-09 fim}

  //Mauricio Parizotto 2023-09-26
  if Form7.StatusTrocaPerfil = 'PR' then
    Exit;

  if ibDataSet4IDPERFILTRIBUTACAO.AsInteger > 0 then
  begin
    Form7.StatusTrocaPerfil := 'PR';
    SetTibutacaoProduto(ibDataSet4IDPERFILTRIBUTACAO.AsInteger);
    Form10.orelha_ICMSShow(sender);
    Form7.StatusTrocaPerfil := 'OK';
  end;

  Form10.fraPerfilTrib.CarregaDescricao;
end;

procedure TForm7.VerificaAlteracaoPerfil;
begin
  {Dailon Parisotto 2023-10-09 Inicio}
  if FbDuplicandoProd then
    Exit;
  {Dailon Parisotto 2023-10-09 fim}

  if ibDataSet4IDPERFILTRIBUTACAO.AsInteger = 0 then
    Exit;

  if Form7.StatusTrocaPerfil = 'PR' then
    Exit;

  ibDataSet4IDPERFILTRIBUTACAO.AsString := '';
end;

procedure TForm7.ibDataSet4TIPO_ITEMChange(Sender: TField);
begin
  VerificaAlteracaoPerfil;
end;

procedure TForm7.ibdParametroTributaAfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibdParametroTributaBeforeDelete(DataSet: TDataSet);
begin
  RegistraExclusaoRegistro(ibdParametroTributa);
end;

procedure TForm7.ibdParametroTributaBeforeEdit(DataSet: TDataSet);
begin
  sNumeroAnterior := ibdParametroTributaREGISTRO.AsString;
  { Est varivel tambm ser usada no evento AfterPost }
end;

procedure TForm7.ibdParametroTributaBeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_PARAMETROTRIBUTACAO,1) from rdb$database');
    ibDataset99.Open;
    sProximo := strZero(StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString),10,0);
    sProximoID := StrToInt(ibDataSet99.FieldByname('GEN_ID').AsString);
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibdParametroTributaNewRecord(DataSet: TDataSet);
begin
  ibdParametroTributa.Edit;
  ibdParametroTributaREGISTRO.AsString := sProximo;
  ibdParametroTributaIDPARAMETROTRIBUTACAO.AsInteger := sProximoID;
end;

procedure TForm7.Perfildetributao1Click(Sender: TObject);
begin
  Form7.Close;
  Form7.sModulo := 'PERFILTRIBUTACAO';
  Form7.sTitulo := 'Perfil de tributao';

  {$IFDEF VER150}
  Form7.DBGrid1.Options := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs];
  {$ELSE}
  Form7.DBGrid1.Options := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgTitleClick];
  {$ENDIF}

  Form7.Show;
end;

procedure TForm7.Parmetrosdetributao1Click(Sender: TObject);
begin
  Form7.Close;
  Form7.sModulo := 'PARAMETROTRIBUTACAO';
  Form7.sTitulo := 'Parmetros de tributao';

  {$IFDEF VER150}
  Form7.DBGrid1.Options := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs];
  {$ELSE}
  Form7.DBGrid1.Options := [dgEditing,dgTitles,dgColLines,dgRowLines,dgTabs,dgTitleClick];
  {$ENDIF}

  Form7.Show;
end;

procedure TForm7.Configurarobservaofixa1Click(Sender: TObject);
var
  oArqIni: TArquivosDAT;
  cMsg: String;
begin
  // ORCAMENTO
  if sModulo <> 'ORCAMENTO' then
    Exit;

  oArqIni := TArquivosDAT.Create(EmptyStr);
  try
    cMsg := Form1.Small_InputForm('Observao fixa do oramento',
                                  EmptyStr,
                                  oArqIni.SmallCom.Orcamento.Observacao
                                 );

    oArqIni.SmallCom.Orcamento.Observacao := cMsg;
  finally
    FreeAndNil(oArqIni);
  end;
end;

procedure TForm7.DuplicarProdutoClick(Sender: TObject);
begin
  try
    FbDuplicandoProd := True;

    if TDuplicaProduto.New
                   .SetTransaction(IBTransaction1)
                   .SetDataSetEstoque(ibDataSet4)
                   .SetDataSetComposicao(ibDataSet28)
                   .SetCodigoProduto(ibDataSet4CODIGO.AsString)
                   .Duplicar then
    begin
      Sleep(200);

      AgendaCommit(False);
    end;
  finally
    FbDuplicandoProd := False;

    Self.Close;
    Self.Show;
  end;
end;

procedure TForm7.DuplicaOrcamentoClick(Sender: TObject);
var
  cNroPedido: string;
begin
  try
    if TDuplicaOrcamento.New
                        .SetTransaction(IBTransaction1)
                        .SetNroOrcamento(IBDataSet97.FieldByName('Oramento').AsString)
                        .SetDataSetOrcamento(ibDataSet37)
                        .SetDataSetOrcamentoOBS(IbdOrcamentObs)
                        .Duplicar then
    begin
      Sleep(200);
      ibDataSet37.DisableControls;
      try
        ibDataSet37.Last;

        cNroPedido := ibDataSet37PEDIDO.AsString;

        ibDataSet37.First;
        while not ibDataSet37.Eof do
        begin
          if ibDataSet37PEDIDO.AsString = cNroPedido then
          begin
            ibDataSet37.Edit;
            AssinaRegistro('ORCAMENT', ibDataSet37, True);
            HasHs('ORCAMENT',True);
            ibDataSet37.Post;
          end;

          ibDataSet37.Next;
        end;
      finally
        ibDataSet97.Last;
        ibDataSet37.EnableControls;
      end;

      AgendaCommit(True);
    end;
  finally
    Self.Close;
    Self.Show;
  end;
end;

{Dailon Parisotto 2023-10-13 Inicio}
procedure TForm7.ImprimirOrcamentoClick(Sender: TObject);
begin
  ImprimeOrcamento;
end;
{Dailon Parisotto 2023-10-13 Fim}

function TForm7.getUsuarioLogado: String;
begin
  Result := Senhas.UsuarioPub;
end;

procedure TForm7.ExportarXMLNF;
var
  oDialog: TSaveDialog;
  cCaminho: String;
begin
  if not TestaNFSaidaFaturada then
    Exit;

  if Trim(Form7.ibDataSet15NFEXML.AsString) = EmptyStr then
  begin
    MensagemSistema(_cNaoTemXMLNFSaidaExportar, msgInformacao);
    Exit;
  end;

  oDialog := TSaveDialog.Create(nil);
  try
    oDialog.Title    := 'Exportar XML';
    oDialog.FileName := Form7.ibDataSet15NFEID.AsString;
    oDialog.Filter := 'Arquivo XML (.xml)|*.xml';

    if not oDialog.Execute then
      Exit;

    cCaminho := oDialog.FileName;
    if Copy(cCaminho, Length(cCaminho)-3, 4) <> '.xml' then
      cCaminho := cCaminho + '.xml';

    SalvaXMLNFSaida(cCaminho);
  finally
    FreeAndNil(oDialog);
  end;
end;

procedure TForm7.ExportarXML1Click(Sender: TObject);
begin
  ExportarXMLNF;
end;

procedure TForm7.SalvaXMLNFSaida(AcCaminho: String = '');
var
  lsXML: TStringList;
  cCaminho: String;
begin
  cCaminho := AcCaminho;

  if cCaminho = EmptyStr then
    cCaminho := ExtractFilePath(ExtractFilePath(Application.ExeName));
    
  lsXML := TStringList.Create;
  try
    lsXML.Clear;
    lsXML.Text := Form7.ibDataSet15NFEXML.AsString;

    lsXML.SaveToFile(cCaminho);
  finally
    FreeAndNil(lsXML);
  end;
end;

procedure TForm7.InutilizaodeNFes1Click(Sender: TObject);
begin
  Form1.InutilizarNFe1Click(Self);
end;

procedure TForm7.ImprimirOrdemdeServio2Click(Sender: TObject);
begin
  ImprimeOrdemServico;
end;

procedure TForm7.ConfigurarobservaoparaOS1Click(Sender: TObject);
var
  ConfSistema : TArquivosDAT;
  Observacao : string;
begin
  try
    ConfSistema := TArquivosDAT.Create(Usuario,ibDataSet3.Transaction);
    Observacao := Form1.Small_InputFormMemo('Configurao de observao para OS',ConfSistema.BD.OS.ObservacaoOS,1000);
    ConfSistema.BD.OS.ObservacaoOS := Observacao;
  finally
    FreeAndNil(ConfSistema);
  end;
end;

procedure TForm7.ConfigurarobservaoparaRecibo1Click(Sender: TObject);
var
  ConfSistema : TArquivosDAT;
  ObservacaoRec : string;
begin
  try
    ConfSistema := TArquivosDAT.Create(Usuario,ibDataSet3.Transaction);
    ObservacaoRec := Form1.Small_InputFormMemo('Configurao de observao para Recibo',ConfSistema.BD.OS.ObservacaoReciboOS,1000);
    ConfSistema.BD.OS.ObservacaoReciboOS := ObservacaoRec;
  finally
    FreeAndNil(ConfSistema);
  end;
end;

procedure TForm7.FechaModulos;
begin
  try
    if FrmParametroTributacao <> nil then
      FreeAndNil(FrmParametroTributacao);

    if FrmPerfilTributacao <> nil then
      FreeAndNil(FrmPerfilTributacao);

    if FrmNaturezaOperacao <> nil then
      FreeAndNil(FrmNaturezaOperacao);

    if FrmSituacaoOS <> nil then
      FreeAndNil(FrmSituacaoOS);

    if FrmFichaCadastros <> nil then
      FreeAndNil(FrmFichaCadastros);
  except
  end;
end;  

procedure TForm7.otalizadorgeraldevenda1Click(Sender: TObject);
begin
  TChamaRelatorioFactory.New
                        .TotalizadorGeralVenda
                        .setTransaction(IBTransaction1)
                        .setImagem(imgImprimir.Picture)
                        .setUsuario(Usuario)
                        .ChamarTela;
end;

procedure TForm7.ibdSituacaoOSAfterDelete(DataSet: TDataSet);
begin
  AgendaCommit(True);
end;

procedure TForm7.ibdSituacaoOSAfterPost(DataSet: TDataSet);
begin
  if AllTrim(ibdSituacaoOSSITUACAO.AsString) = '' then
    ibdSituacaoOS.Delete;
end;

procedure TForm7.ibdSituacaoOSBeforeInsert(DataSet: TDataSet);
begin
  try
    ibDataSet99.Close;
    ibDataSet99.SelectSql.Clear;
    ibDataset99.SelectSql.Add('select gen_id(G_OSSITUACAO,1) from rdb$database');
    ibDataset99.Open;
    sProximoID := ibDataSet99.FieldByname('GEN_ID').AsInteger;
    ibDataset99.Close;
  except
    Abort
  end;
end;

procedure TForm7.ibdSituacaoOSNewRecord(DataSet: TDataSet);
begin
  ibdSituacaoOS.Edit;
  ibdSituacaoOSIDSITUACAO.AsInteger := sProximoID;
end;

procedure TForm7.ibdSituacaoOSBeforeEdit(DataSet: TDataSet);
begin
  sNumeroAnterior := ibdSituacaoOSIDSITUACAO.AsString;
end;

procedure TForm7.Cadastrodesituaes1Click(Sender: TObject);
begin
  Label1.Caption := 'Cadastro de situaes';
  
  Form7.Close;
  Form7.sModulo := 'OSSITUACAO';
  Form7.sTitulo := Label1.Caption;
  Form7.sRPS := 'N';
  Form7.Show;
end;

procedure TForm7.ibdSituacaoOSSITUACAOSetText(Sender: TField;
  const Text: String);
var
  cTexto: String;
begin
  cTexto := Text;

  if (AllTrim(ibdSituacaoOSSITUACAO.AsString) <> '') and (AllTrim(cTexto) = '') then
  begin
    MensagemSistema('Situao invlida (no pode ficar em branco).'
                    ,msgAtencao);
  end else
  begin
    if (UpperCase(AllTrim(cTexto)) = 'AGENDADA' )
      or (UpperCase(AllTrim(cTexto)) = 'ABERTA' )
      or (UpperCase(AllTrim(cTexto)) = 'FECHADA' ) then
    begin
      MensagemSistema('Est situao j foi cadastrada!',msgAtencao);
      Exit;
    end;

    if Valida_Campo('OSSITUACAO',AllTrim(cTexto),'SITUACAO','Est situao j foi cadastrada!') then
      ibdSituacaoOSSITUACAO.AsString := AllTrim(cTexto);
  end;

end;

procedure TForm7.DBGrid2KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  DBGridCopiarCampo((Sender as TDBGrid), Key, Shift); // Mauricio Parizotto 2023-12-26
end;

procedure TForm7.DBGrid3KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  DBGridCopiarCampo((Sender as TDBGrid), Key, Shift); // Mauricio Parizotto 2023-12-26
end;

procedure TForm7.DBGrid4KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  DBGridCopiarCampo((Sender as TDBGrid), Key, Shift); // Mauricio Parizotto 2023-12-26
end;

procedure TForm7.FormShowModulos(Mais1Ini : tIniFile; var sSerieNFSelecionada : string);
var
  IBQCONTAS: TIBQuery;
  I : integer;
begin

  {$Region'//// Mdulo Receber ////'}
  if (sModulo = 'RECEBER') then
  begin
    Form7.ibDataSet7FORMADEPAGAMENTO.Index  := 17; // Sandro Silva 2023-06-22

    ComboBox1.Items.Clear;
    ComboBox1.Items.Add(_cRecebPagto);
    ComboBox1.ItemIndex := 0;
    //
    {Sandro Silva 2023-09-13 inicio
    Form7.ibDataSet12.Close;
    Form7.ibDataSet12.SelectSQL.Clear;
    Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
    Form7.ibDataSet12.Open;
    //
    Form7.ibDataSet12.First;
    //
    while not Form7.ibDataSet12.Eof do
    begin
      if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '5' then
      begin
        ComboBox1.Items.Add(Form7.ibDataSet12NOME.AsString);
      end;
      //
      Form7.ibDataSet12.Next;
      //
    end;
    }
    IBQCONTAS := CriaIBQuery(Form7.ibDataSet12.Transaction);
    try
      IBQCONTAS.Close;
      IBQCONTAS.UniDirectional := True;
      IBQCONTAS.SQL.Text :=
        'select * ' +
        'from CONTAS ' +
        'where CONTA like ''5%'' ' +
        'order by upper(NOME)';
      IBQCONTAS.Open;
      //
      IBQCONTAS.First;
      //
      while not IBQCONTAS.Eof do
      begin
        if Copy(IBQCONTAS.FieldByName('CONTA').AsString,1,1) = '5' then
        begin
          ComboBox1.Items.Add(IBQCONTAS.FieldByName('NOME').AsString);
        end;
        //
        IBQCONTAS.Next;
        //
      end;
    except
    end;
    FreeAndNil(IBQCONTAS);
    {Sandro Silva 2023-09-13 fim}

    Panel9.Top      := 86;
    Panel9.Width    := Panel2.Width;
    //
    //
    Panel2.Left     := Form7.Width - 395 -15 -5;
    Panel2.Top      := Form7.DBGrid1.Top;
    Panel2.Visible  := True;
    Button6.Visible := True;
    //
    dbGrid3.Top     := Form7.DBGrid1.Top + Panel2.Height + 10;
    //
    dbGrid3.Height  := dbGrid1.Height - 10 - Panel2.Height + 17;
    dbGrid3.Width   := 395;
    dbGrid3.Left    := Form7.Width - 395 -15 -5;
    dbGrid3.Visible := True;

    Panel10.Top     := dbGrid3.Top + dbGrid3.Height- 18;
    Panel10.Left    := dbGrid3.Left;
    Panel10.Width   := dbGrid3.Width;

    Panel10.Visible := True;
    dbGrid1.Width   := dbGrid1.Width - dbGrid3.Width - 15;

    {$IFDEF VER150}
    Form7.DBGrid1.Options  := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];
    {$ELSE}
    Form7.DBGrid1.Options  := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize,dgTitleClick];
    {$ENDIF}

    Form7.dbGrid1.ReadOnly := True;
    Form7.Image308.Visible := False;
    Form7.imgLibBloq.Visible := True; Form7.Label208.Caption  := 'Liberar';

    CalculaTotalRecebido(True);

    CarregarContasReceberMarcadas;
    //
    dbGrid3.Datasource         := Form1.DataSource200;
    dbGrid3.Columns[5].Visible := False;
    dbGrid3.Columns[4].Visible := False;
    //
    Edit1.Text := 'Recebimentos';
    //
    Label47.Caption := 'Valor recebido';
    Label23.Caption := 'Total recebido';
    //
    Form7.SMALL_DBEdit1.DataField  := '';
    Form7.SMALL_DBEdit1.DataSource := Form7.DataSource7;
    Form7.SMALL_DBEdit2.DataSource := Form7.DataSource7;
    Form7.SMALL_DBEdit1.DataField  := 'VALOR_RECE';
    //
    Form7.ibDataSet25.Active := True;
    Form7.ibDataSet25.Append;
  end;
  {$Endregion}

  {$Region'//// Mdulo Pagar'}
  if (sModulo = 'PAGAR') then
  begin
    ComboBox1.Items.Clear;
    ComboBox1.Items.Add(_cRecebPagto);
    ComboBox1.ItemIndex := 0;
    //
    Form7.ibDataSet12.Close;
    Form7.ibDataSet12.SelectSQL.Clear;
    Form7.ibDataSet12.SelectSQL.Add('select * from CONTAS order by upper(NOME)');
    Form7.ibDataSet12.Open;
    //
    Form7.ibDataSet12.First;
    //
    while not Form7.ibDataSet12.Eof do
    begin
      if Copy(Form7.ibDataSet12CONTA.AsString,1,1) = '5' then
      begin
        ComboBox1.Items.Add(Form7.ibDataSet12NOME.AsString);
      end;
      //
      Form7.ibDataSet12.Next;
      //
    end;
    //
    Panel9.Top      := 86;
    Panel9.Width    := Panel2.Width;
    //
    Panel2.Left     := Form7.Width - 395 -15 -5;
    Panel2.Top      := Form7.DBGrid1.Top;
    Panel2.Visible  := True;
    Button6.Visible := False;
    //
    dbGrid3.Top     := Form7.DBGrid1.Top + Panel2.Height + 10;
    //
    dbGrid3.Height  := dbGrid1.Height - 10 - Panel2.Height + 17;
    dbGrid3.Width   := 395;
    dbGrid3.Left    := Form7.Width - 395 -15 -5;
    dbGrid3.Visible := True;
    //
    Panel10.Top     := dbGrid3.Top + dbGrid3.Height- 18;
    Panel10.Left    := dbGrid3.Left;
    Panel10.Width   := dbGrid3.Width;
    //
    Panel10.Visible := True;
    dbGrid1.Width   := dbGrid1.Width - dbGrid3.Width - 15;

    {$IFDEF VER150}
    Form7.DBGrid1.Options  := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize];
    {$ELSE}
    Form7.DBGrid1.Options  := [dgTitles,dgColLines,dgRowLines,dgTabs,dgColumnResize,dgTitleClick];
    {$ENDIF}

    Form7.dbGrid1.ReadOnly := True;
    Form7.Image308.Visible := False;
    Form7.imgLibBloq.Visible := True; Form7.Label208.Caption  := 'Liberar';

    CalculaTotalRecebido(True);
    //
    CarregarContasPagarMarcadas;
    //
    dbGrid3.Datasource     := Form1.DataSource200;
    //
    dbGrid3.Columns[5].Visible := False;
    dbGrid3.Columns[4].Visible := False;
    //
    Edit1.Text := 'Pagamentos';
    //
    Label47.Caption := 'Valor pago';
    Label23.Caption := 'Total pago';
    //
    Form7.SMALL_DBEdit1.DataField  := '';
    Form7.SMALL_DBEdit1.DataSource := Form7.DataSource8;
    Form7.SMALL_DBEdit2.DataSource := Form7.DataSource8;
    Form7.SMALL_DBEdit1.DataField  := 'VALOR_PAGO';
    //
    Form7.ibDataSet25.Active := True;
    Form7.ibDataSet25.Append;
  end;
  {$Endregion}

  {$Region'//// Mdulo Compra ////'}
  if sModulo = 'COMPRA' then
  begin
    sAjuda := 'nf_compra.htm';

    ibDataSet8.Close;
    ibDataSet8.DataSource := DataSource24;
    ibDataSet8.Selectsql.Clear;
    ibDataSet8.Selectsql.Add('select * from PAGAR where NUMERONF=:NUMERONF and NOME=:FORNECEDOR order by REGISTRO');
    ibDataSet8.Open;
    //
    ibDataSet23.Close;
    ibDataSet23.DataSource  := DataSource24;
    ibDataSet23.Selectsql.Clear;
    ibDataSet23.Selectsql.Add('select * from ITENS002 where NUMERONF=:NUMERONF and FORNECEDOR=:FORNECEDOR');
    ibDataSet23.Open;
    //
    Form7.ibDataSet35.Close;                                                            //
    Form7.ibDataSet35.Selectsql.Clear;                                                  // Itens de servio relacionado
    Form7.ibDataSet35.Selectsql.Add('select * from ITENS003 where NUMERONF='+QuotedStr('9999999')+' '); //
    Form7.ibDataSet35.Open;
    //
    Form7.ibDataSet14.Close;
    Form7.ibDataSet14.SelectSQL.Clear;
    Form7.ibDataSet14.SelectSQL.Add('select * FROM ICM where (CFOP like '+QuotedStr('1%')+') or (CFOP like '+QuotedStr('3%')+') or (CFOP like '+QuotedStr('2%')+') order by upper(NOME)');
    Form7.ibDataSet14.Open;
    //
    if not Form7.ibDataSet4.active  then
      Form7.ibDataSet4.Open;
    if not Form7.ibDataSet1.active  then
      Form7.ibDataSet1.Open;
    //
    DbGrid1.Height         := Form7.Height - Form7.DbGrid1.Top - 60 -26 - 105 -10;
    dbGrid4.Left           := dbGrid1.Left;
    dbGrid4.Top            := dbGrid1.Top + dbGrid1.Height + 30 + 5 -2;
    dbGrid4.Height         := 105;
    dbGrid4.Width          := dbGrid1.Width;
    dbGrid4.Visible        := True;
    //
    // Mostra s o que interassa no contas a receber
    //
    for I := 1 to Form7.ibDataSet8.FieldCount do
    begin
      Form7.ibDataSet8.Fields[I-1].Visible := False;
    end;

    Form7.ibDataSet8DOCUMENTO.Visible  := True;
    Form7.ibDataSet8VENCIMENTO.Visible := True;
    Form7.ibDataSet8VALOR_DUPL.Visible := True;
    Form7.ibDataSet8NOME.Visible       := True;
    //
    // Liga os dbGrids aos dataSurces
    //
    dbGrid2.Datasource     := DataSource23;
    dbGrid3.Datasource     := DataSource35;
    dbGrid4.Datasource     := DataSource8;
    //
    // Campos
    //
    {Sandro Silva 2023-03-27 inicio
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
    iCampos                := 25;
    }
    sMostra := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
    // Para quem atualizar da verso anterior da 2023.0.0.24 para esta ir
    // exibir os novos campos adicionados ao grid
    if Length(sMostra) = 25 then // habilita a coluna DATA_SAI
    begin
      // Se ainda  a primeira vez que entra no mdulo depois que foi adicionado a coluna DATA_SAI
      // adiciona o valor T, na ltima posio de sMostra
      //sMostra := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
      sMostra := sMostra + 'T'; // habilita a coluna Data_SAI
      //Mais1Ini.WriteString(sModulo,'Mostrar', sMostra); // Sandro Silva 2023-04-17
    //end
    //else
    //begin
    //  sMostra := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTFFT');
    end;

    if Length(sMostra) = 26 then // habilita a coluna MODELO
    begin
      // Se ainda  a primeira vez que entra no mdulo depois que foi adicionado a coluna MODELO
      // adiciona o valor T, na string, na posio que representa a coluna MODELO (Segunda posio)
      //sMostra := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
      sMostra := Copy(sMostra, 1, 1) + 'T' + Copy(sMostra, 2, Length(sMostra)); // habilita a coluna MODELO
    end;

    {Sandro Silva 2023-03-27 fim}
    if Length(sMostra) = 27 then // habilita a coluna VFCPST
    begin
      // Se ainda  a primeira vez que entra no mdulo depois que foi adicionado a coluna VFCPST
      // adiciona o valor T, na string, na posio que representa a coluna VFCPST (dcima oitava posio)
      //sMostra := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT');
      sMostra := Copy(sMostra, 1, 18) + 'T' + Copy(sMostra, 19, Length(sMostra)); // habilita a coluna VFCPST
    end;
    if sMostra <> Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTFFT') then
      Mais1Ini.WriteString(sModulo,'Mostrar', sMostra); // Sandro Silva 2023-04-17
    iCampos                := 28;
    {Sandro Silva 2023-04-12 fim}

    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    //
    // Menu
    //
    Form7.Menu             := mmCompras;
    //
    // Arquivo
    //
    ArquivoAberto          := DataSource24.Dataset;
    TabelaAberta           := ibDataSet24;
    DataSourceAtual        := DataSource24;
    //
    // Sql
    //
    sSelect   := 'select * FROM COMPRAS';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by EMISSAO';
  end
  else
    Form7.ibDataSet8.DataSource := Nil;
  {$Endregion}

  {$Region'//// Mdulo Venda'}
  if sModulo = 'VENDA' then
  begin
    sAjuda := 'nf_venda.htm';

    Form7.ibDataSet9.Close;
    Form7.ibDataSet9.SelectSQL.Clear;
    Form7.ibDataSet9.SelectSQL.Add('select * FROM VENDEDOR where FUNCAO like '+QuotedStr('%VENDEDOR%')+' order by upper(NOME)');
    Form7.ibDataSet9.Open;
    Form7.ibDataSet9.First;
    Form7.ibDataSet9.DataSource := Nil;
    //
    Form7.ibDataSet7.Close;                                                            //
    Form7.ibDataSet7.Selectsql.Clear;                                                  // receber Relacionado
    Form7.ibDataSet7.Selectsql.Add('select * from RECEBER where (NUMERONF=:NUMERONF) AND (COALESCE(ATIVO,-10) <> 1) order by REGISTRO');  //
    Form7.ibDataSet7.DataSource := DataSource15;
    Form7.ibDataSet7.Open;
    //
    Form7.ibDataSet16.Close;                                                            //
    Form7.ibDataSet16.Selectsql.Clear;                                                  // Itens de venda relacionado
    Form7.ibDataSet16.Selectsql.Add('select * from ITENS001 where NUMERONF=:NUMERONF order by NUMERONF, REGISTRO'); //
    Form7.ibDataSet16.DataSource := DataSource15;
    Form7.ibDataSet16.Open;
    //
    Form7.ibDataSet35.Close;                                                            //
    Form7.ibDataSet35.Selectsql.Clear;                                                  // Itens de servio relacionado
    Form7.ibDataSet35.Selectsql.Add('select * from ITENS003 where NUMERONF=:NUMERONF order by REGISTRO'); //
    Form7.ibDataSet35.DataSource := DataSource15;
    Form7.ibDataSet35.Open;
    //
    Form7.ibDataSet14.Close;
    Form7.ibDataSet14.SelectSQL.Clear;
    Form7.ibDataSet14.SelectSQL.Add('select * FROM ICM where (CFOP like '+QuotedStr('5%')+') or (CFOP like '+QuotedStr('6%')+') or (CFOP like '+QuotedStr('7%')+') order by upper(NOME)');
    Form7.ibDataSet14.Open;
    //
    if not Form7.ibDataSet4.active  then
      Form7.ibDataSet4.Open;
    if not Form7.ibDataSet1.active  then
      Form7.ibDataSet1.Open;
    //
    DbGrid1.Height         := Form7.Height - Form7.DbGrid1.Top - 60 -26 - 105 -10;
    dbGrid4.Left           := dbGrid1.Left;
    dbGrid4.Top            := dbGrid1.Top + dbGrid1.Height + 30 + 5 -2;
    dbGrid4.Height         := 105;
    dbGrid4.Width          := dbGrid1.Width;
    dbGrid4.Visible        := True;
    //
    // Mostra s o que interassa no contas a receber
    //
    try
      for I := 1 to Form7.ibDataSet7.FieldCount do
      begin
        Form7.ibDataSet7.Fields[I-1].Visible := False;
      end;
    except

    end;
    //
    Form7.ibDataSet7DOCUMENTO.Visible  := True;
    Form7.ibDataSet7VENCIMENTO.Visible := True;
    Form7.ibDataSet7VALOR_DUPL.Visible := True;
    Form7.ibDataSet7NOME.Visible       := True;
    {Sandro Silva 2023-06-19 inicio}
    Form7.ibDataSet7FORMADEPAGAMENTO.Visible     := True; // Sandro Silva 2023-06-16
    Form7.ibDataSet7AUTORIZACAOTRANSACAO.Visible := True; // Sandro Silva 2023-06-22
    Form7.ibDataSet7BANDEIRA.Visible             := True; // Sandro Silva 2023-06-22
    Form7.ibDataSet7VALOR_DUPL.DisplayWidth := 10;
    Form7.ibDataSet7FORMADEPAGAMENTO.Index  := 12;
    {Sandro Silva 2023-06-16 fim}

    // Liga os dbGrids aos dataSurces
    dbGrid2.Datasource     := DataSource16;
    dbGrid3.Datasource     := DataSource35;
    dbGrid4.Datasource     := DataSource7;

    // Arquivo
    ArquivoAberto          := DataSource15.Dataset;
    TabelaAberta           := ibDataSet15;
    DataSourceAtual        := DataSource15;
    //
    // Sql
    //
    sSelect   := 'select * FROM VENDAS ';
    //
    if Form7.sRPS = 'S' then
    begin
      // Menu
      Form7.Menu             := mmServicos;
      //
      sWhere    := Mais1Ini.ReadString('RPS','FILTRO','');
    end else
    begin
      // Menu
      Form7.Menu             := mmVendas;

      sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    end;

    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%1'),'');
    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%2'),'');

    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%001'),'');
    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%002'),'');
    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%920'),'');
    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%'+Form1.sSerieEspecial+''),'');
    sWhere    := StrTran(sWhere,'where NUMERONF like '+QuotedStr('%RPS'),'');

    if Pos('where NUMERONF like ',sWhere) <> 0 then  sWhere := '';
    //
    if Alltrim(sWhere) = 'where' then sWhere := '';
    //
    // Notas fiscais de sada (vendas) srie 001
    // Notas fiscais de sada (vendas) srie 002
    //
    sWhere := 'where NUMERONF like '+QuotedStr('%'+Right(Form7.sTitulo,3))+ '  '+AllTrim(sWhere)+' ';
    sSerieNFSelecionada := Right(Form7.sTitulo,3); // Srie na nota foi selecionada para exibir
    //
    sOrderBy  := 'order by NUMERONF';
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');

    if Form7.sRPS = 'S' then
    begin
      Form7.ibDataSet15NUMERONF.DisplayLabel     := 'RPS';
      Form7.ibDataSet15NFEPROTOCOLO.DisplayLabel := 'NFS-e/Srie';
      //
      Form7.ibDataSet15NUMERONF.Visible := False;
      Form7.ibDataSet15STATUS.Visible := False;
      Form7.ibDataSet15EMISSAO.Visible := False;
      Form7.ibDataSet15CLIENTE.Visible := False;
      Form7.ibDataSet15MERCADORIA.Visible := False;
      Form7.ibDataSet15SERVICOS.Visible := False;
      Form7.ibDataSet15DESCONTO.Visible := False;
      Form7.ibDataSet15TOTAL.Visible := False;
      Form7.ibDataSet15OPERACAO.Visible := False;
      Form7.ibDataSet15VENDEDOR.Visible := False;
      Form7.ibDataSet15ICMS.Visible := False;
      Form7.ibDataSet15ISS.Visible := False;
      Form7.ibDataSet15IPI.Visible := False;
      Form7.ibDataSet15FRETE.Visible := False;
      Form7.ibDataSet15SEGURO.Visible := False;
      Form7.ibDataSet15DESPESAS.Visible := False;
      Form7.ibDataSet15VFCPST.Visible := False;
      Form7.ibDataSet15TRANSPORTA.Visible := False;
      Form7.ibDataSet15PLACA.Visible := False;
      Form7.ibDataSet15IDENTIFICADOR1.Visible := False;
      Form7.ibDataSet15BASEICM.Visible := False;
      Form7.ibDataSet15BASEISS.Visible := False;
      Form7.ibDataSet15ICMSSUBSTI.Visible := False;
      Form7.ibDataSet15BASESUBSTI.Visible := False;
      Form7.ibDataSet15NFEPROTOCOLO.Visible := False;
      Form7.ibDataSet15NFERECIBO.Visible := False;
      Form7.ibDataSet15NFEID.Visible := False;
      Form7.ibDataSet15NFEXML.Visible := False;
      Form7.ibDataSet15CCEXML.Visible := False;
      Form7.ibDataSet15RECIBOXML.Visible := False;
      Form7.ibDataSet15MODELO.Visible := False;
      //
      Form7.ibDataSet15NUMERONF.Index         := 0;
      Form7.ibDataSet15NFEPROTOCOLO.Index     := 1;
      Form7.ibDataSet15STATUS.Index           := 2;
      Form7.ibDataSet15EMISSAO.Index          := 3;
      Form7.ibDataSet15CLIENTE.Index          := 4;
      Form7.ibDataSet15SERVICOS.Index         := 5;
      Form7.ibDataSet15DESCONTO.Index         := 6;
      Form7.ibDataSet15TOTAL.Index            := 7;
      Form7.ibDataSet15OPERACAO.Index         := 8;
      Form7.ibDataSet15VENDEDOR.Index         := 9;
      Form7.ibDataSet15ISS.Index              := 10;
      Form7.ibDataSet15NFEXML.Index           := 11;
      Form7.ibDataSet15RECIBOXML.Index        := 12;
      //
      sMostra                := Mais1Ini.ReadString('RPS','Mostrar','TTTTTTTTTTTTT');
      iCampos                := 13;
    end else
    begin
      // Campos
      {Sandro Silva 2023-05-04 inicio
      sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTTTTTTTTTTTTT');
      iCampos                := 29;
      }
      sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTTTTTTTTTTTTTT');
      iCampos                := 30;
      {Sandro Silva 2023-05-04 fim}
      //
      Form7.ibDataSet15NUMERONF.DisplayLabel     := 'NF/Srie';
      Form7.ibDataSet15NFEPROTOCOLO.DisplayLabel := 'Protocolo';
      //
      Form7.ibDataSet15NUMERONF.Index         := 0;
      Form7.ibDataSet15STATUS.Index           := 1;
      Form7.ibDataSet15EMISSAO.Index          := 2;
      Form7.ibDataSet15CLIENTE.Index          := 3;
      Form7.ibDataSet15MERCADORIA.Index       := 4;
      Form7.ibDataSet15SERVICOS.Index         := 5;
      Form7.ibDataSet15DESCONTO.Index         := 6;
      Form7.ibDataSet15TOTAL.Index            := 7;
      Form7.ibDataSet15OPERACAO.Index         := 8;
      Form7.ibDataSet15VENDEDOR.Index         := 9;
      Form7.ibDataSet15ICMS.Index             := 10;
      Form7.ibDataSet15ISS.Index              := 11;
      Form7.ibDataSet15IPI.Index              := 12;
      Form7.ibDataSet15FRETE.Index            := 13;
      Form7.ibDataSet15SEGURO.Index           := 14;
      Form7.ibDataSet15DESPESAS.Index         := 15;
      Form7.ibDataSet15VFCPST.Index           := 16;
      Form7.ibDataSet15TRANSPORTA.Index       := 17;
      Form7.ibDataSet15PLACA.Index            := 18;
      Form7.ibDataSet15IDENTIFICADOR1.Index   := 19;
      Form7.ibDataSet15BASEICM.Index          := 20;
      Form7.ibDataSet15BASEISS.Index          := 21;
      Form7.ibDataSet15ICMSSUBSTI.Index       := 22;
      Form7.ibDataSet15BASESUBSTI.Index       := 23;
      Form7.ibDataSet15NFEPROTOCOLO.Index     := 24;
      Form7.ibDataSet15NFERECIBO.Index        := 25;
      Form7.ibDataSet15NFEID.Index            := 26;
      Form7.ibDataSet15NFEXML.Index           := 27;
      Form7.ibDataSet15CCEXML.Index           := 28;
      Form7.ibDataSet15RECIBOXML.Index        := 29;
      Form7.ibDataSet15MODELO.Index           := 30;
    end;
  end
  else
    Form7.ibDataSet7.DataSource := Nil;

  {$Endregion}

  {$Region'//// Mdulo OS ////'}
  if sModulo = 'OS' then
  begin
    sAjuda := 'os.htm';

    Form7.ibDataSet9.Close;
    Form7.ibDataSet9.SelectSQL.Clear;
    Form7.ibDataSet9.SelectSQL.Add('select * FROM VENDEDOR where FUNCAO like '+QuotedStr('%TECNICO%')+' order by upper(NOME)');
    Form7.ibDataSet9.Open;
    Form7.ibDataSet9.DataSource := Nil;
    Form7.ibDataSet9.First;

    ibDataSet16.Close;
    ibDataSet16.DataSource := DataSource3;
    ibDataSet16.Selectsql.Clear;
    ibDataSet16.Selectsql.Add('select * from ITENS001 where NUMEROOS=:NUMERO');
    ibDataSet16.Open;

    ibDataSet35.Close;
    ibDataSet35.DataSource := DataSource3;
    ibDataSet35.Selectsql.Clear;
    ibDataSet35.Selectsql.Add('select * from ITENS003 where NUMEROOS=:NUMERO');
    ibDataSet35.Open;

    if not Form7.ibDataSet4.active  then
      Form7.ibDataSet4.Open;

    dBgrid3.Visible        := True;

    // Liga os dbGrids aos dataSurces
    dbGrid2.Datasource     := DataSource16;
    dbGrid3.Datasource     := DataSource35;

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TFFTTTTTTFFFFFFFFFFFFFFFF');
    //iCampos                := 25; Mauricio Parizotto 2023-12-26
    iCampos                := 26;

    // Menu
    Form7.Menu             := mmOS;

    // Arquivo
    ArquivoAberto          := DataSource3.Dataset;
    TabelaAberta           := ibDataSet3;
    DataSourceAtual        := DataSource3;

    // Sql
    sSelect   := 'select * FROM OS';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NUMERO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
  end;
  {$Endregion}

  {$Region'//// Mdulo Nota ////'}
  if sModulo = 'NOTA' then
  begin
    sAjuda := 'nf_config.htm';
    //
    ArquivoAberto          := DataSource19.Dataset;
    TabelaAberta           := ibDataSet19;
    DataSourceAtual        := DataSource19;
    //
    iCampos              := 6;
    Form7.Menu       := MainMenu99;
    Panel3.Visible       := True;
    //
    DBgrid1.TitleFont.Name     := 'Microsoft Sans Serif';
    DBGrid1.TitleFont.Size     := 8;
    DBGrid1.TitleFont.Color    := clBlack;
    //
    DBGrid1.Font.Name          := 'Microsoft Sans Serif';
    DBGrid1.Font.Size          := 8;
    DBGrid1.Font.Color         := clBlack;
    //
    sSelect   := 'select * from NOTA';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','where SERIE=1');
    sOrderBy  := 'order by ((LINHA * 1000) + COLUNA)';
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := 'TTTTTT';
    //
    Form4.Top            := Form7.Top;
    Form4.Left           := Form7.Left + Form7.Width + 10;
    Form4.Width          := Screen.Width - Form4.Left -10;
    Form4.Height         := Form7.Height -10;
    //
    if sWhere = 'where SERIE=1' then
    begin
      Button2.Caption       := 'Srie 2';
      Button2.Repaint;
      Form7.sTitulo         := 'Configurao da nota fiscal srie 1';
      Form7.sRPS := 'N';
    end else
    begin
      Button2.Caption       := 'Srie 1';
      Button2.Repaint;
      Form7.sTitulo         := 'Configurao da nota fiscal srie 2';
      Form7.sRPS := 'N';
    end;

    Form7.Button2.Visible := True;
  end;
  {$Endregion}

  {$Region'//// Mdulo Oramento ////'}
  if Form7.sModulo = 'ORCAMENTO' then
  begin
    try
      CriaJpg('logotip.jpg');
    except
    end;

    if FileExists(Form1.sAtual+'\logotip.jpg') then
    begin
      if not FileExists(Form1.sAtual+'\ORCAMENTOS\logotip.jpg') then
      begin
        try
          ForceDirectories(Form1.sAtual+'\ORCAMENTOS');
        except
        end;
      end;

      DeleteFile(pChar(Form1.sAtual+'\ORCAMENTOS\logotip.jpg'));
      CopyFile(pChar(Form1.sAtual+'\logotip.jpg'),pChar(Form1.sAtual+'\ORCAMENTOS\logotip.jpg'),false);
    end;

    Form7.ibDataSet97.Close;
    Form7.ibDataSet97.Selectsql.Clear;
    //Form7.ibDataSet97.Selectsql.Add(RetornarSQLEstoqueOrcamentos); Mauricio Parizotto 2023-10-16
    Form7.ibDataSet97.Selectsql.Add(SqlEstoqueOrcamentos);
    Form7.ibDataSet97.Selectsql.Add('order by ORCAMENTS.PEDIDO');
    Form7.ibDataSet97.Open;
    Form7.ibDataSet97.EnableControls;

    Form7.ibDataSet37.Filtered := False;
    Form7.ibDataSet37.Filter := EmptyStr;
    Form7.ibDataSet37.Close;
    Form7.ibDataSet37.Selectsql.Clear;
    Form7.ibDataSet37.Selectsql.Add('SELECT * FROM ORCAMENT');
    Form7.ibDataset37.Open;

    Form7.IBDataSet97.FieldByName('Registro').Visible := False;

    sAjuda := 'orcamento.htm';

    // Campos
    //sMostra                := 'TTTTTTTF'; //Mauricio Parizotto 2023-08-14
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTF');
    iCampos                := 8;

    // Menu
    Form7.Menu         := mmOrcamento;

    // Arquivo
    ArquivoAberto          := DataSource97.Dataset;
    TabelaAberta           := ibDataSet97;
    DataSourceAtual        := DataSource97;

    // Sql
    //sSelect   := RetornarSQLEstoqueOrcamentos; Mauricio Parizotto 2023-10-16
    sSelect   := SqlEstoqueOrcamentos;
    // Devido a mudana na forma de montar os filtros do oramento  necessario limpar caso esteja no padro antigo
    if (Mais1Ini.ReadString(sModulo,'FILTRO','') <> EmptyStr) and (Pos('ORCAMENTS', Mais1Ini.ReadString(sModulo,'FILTRO','')) <= 0) then
      Mais1Ini.WriteString(sModulo, 'FILTRO', EmptyStr);

    sWhere    := StrTran(StrTran(StrTran(Mais1Ini.ReadString(sModulo,'FILTRO',''),'Cliente','CLIFOR'),'Doc. Fiscal','NUMERONF'),'Oramento','PEDIDO');
    sOrderBy  := 'order by ORCAMENTS.PEDIDO';
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
  end;
  {$Endregion}

  {$Region'//// Mdulo Caixa'}
  if sModulo = 'CAIXA' then
  begin
    sAjuda := 'livro.htm';

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TFTTTTF');
    iCampos                := 6;

    // Menu
    Form7.Menu             := mmCaixa;

    // Arquivo
    ArquivoAberto          := DataSource1.Dataset;
    TabelaAberta           := ibDataSet1;
    DataSourceAtual        := DataSource1;

    // Sql
    sSelect  := 'select * from CAIXA';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy := 'order by DATA, REGISTRO';
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
  end;
  {$Endregion}

  {$Region'//// Mdlo Converso CFOP ////' }
  {Mauricio Parizotto 2023-08-25 Inicio}
  if sModulo = 'CONVERSAOCFOP' then
  begin
    sAjuda := 'config_icms_iss.htm';

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TT');
    iCampos                := 2;

    // Menu
    Form7.Menu             := mmConvercaoCFOP;

    // Arquivo
    ArquivoAberto          := DSConversaoCFOP.Dataset;
    TabelaAberta           := ibdConversaoCFOP;
    DataSourceAtual        := DSConversaoCFOP;

    // Sql
    sSelect := ' Select'+
               '   *'+
               ' From CFOPCONVERSAO ';

    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy := 'order by REGISTRO';
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
  end;
  {Mauricio Parizotto 2023-08-25 Fim}
  {$Endregion}

  {$Region '//// Mdulo Perfil Tributo ////'}
  {Mauricio Parizotto 2023-08-30 Inicio}
  if sModulo = 'PERFILTRIBUTACAO' then
  begin
    sAjuda := 'perfil_tributacao.htm';


    if EstadoEmitente(IBDatabase1) = 'SP' then
    begin
      ibdPerfilTributaCFOP.DisplayLabel          := StrTran(ibdPerfilTributaCFOP.DisplayLabel,'NFC-e','SAT');
      ibdPerfilTributaCSOSN_NFCE.DisplayLabel    := StrTran(ibdPerfilTributaCSOSN_NFCE.DisplayLabel,'NFC-e','SAT');
      ibdPerfilTributaCST_NFCE.DisplayLabel      := StrTran(ibdPerfilTributaCST_NFCE.DisplayLabel,'NFC-e','SAT');
      ibdPerfilTributaALIQUOTA_NFCE.DisplayLabel := StrTran(ibdPerfilTributaALIQUOTA_NFCE.DisplayLabel,'NFC-e','SAT');
    end else
    begin
      ibdPerfilTributaCFOP.DisplayLabel          := StrTran(ibdPerfilTributaCFOP.DisplayLabel,'SAT','NFC-e');
      ibdPerfilTributaCSOSN_NFCE.DisplayLabel    := StrTran(ibdPerfilTributaCSOSN_NFCE.DisplayLabel,'SAT','NFC-e');
      ibdPerfilTributaCST_NFCE.DisplayLabel      := StrTran(ibdPerfilTributaCST_NFCE.DisplayLabel,'SAT','NFC-e');
      ibdPerfilTributaALIQUOTA_NFCE.DisplayLabel := StrTran(ibdPerfilTributaALIQUOTA_NFCE.DisplayLabel,'SAT','NFC-e');
    end;


    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTTTTTTTTTTT');
    iCampos                := 21;

    // Menu
    Form7.Menu             := mmPerfilTributa;

    // Arquivo
    ArquivoAberto          := DSPerfilTributa.Dataset;
    TabelaAberta           := ibdPerfilTributa;
    DataSourceAtual        := DSPerfilTributa;

    // Sql
    sSelect := ' Select'+
               '   *'+
               ' From PERFILTRIBUTACAO ';

    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','REGISTRO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
  end;
  {Mauricio Parizotto 2023-08-30 Fim}
  {$Endregion}

  {$Region'//// Mdulo Parametro Tributao ////'}
  {Mauricio Parizotto 2023-09-21 Inicio}
  if sModulo = 'PARAMETROTRIBUTACAO' then
  begin
    sAjuda := 'parametros_tributacao.htm';

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTT');
    iCampos                := 7;

    // Menu
    Form7.Menu             := mmParametroTributa;

    // Arquivo
    ArquivoAberto          := DSParametroTributa.Dataset;
    TabelaAberta           := ibdParametroTributa;
    DataSourceAtual        := DSParametroTributa;

    // Sql
    sSelect := ' Select'+
               '   PR.*,'+
               '   PF.DESCRICAO'+
               ' From PARAMETROTRIBUTACAO PR'+
               '   Left Join PERFILTRIBUTACAO PF on PF.IDPERFILTRIBUTACAO = PR.IDPERFILTRIBUTACAO';

    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','REGISTRO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
  end;
  {Mauricio Parizotto 2023-09-21 Fim}
  {$Endregion}

  {$Region'//// Mdulo OS Situao ////'}
  {Mauricio Parizotto 2023-12-04 Inicio}
  if sModulo = 'OSSITUACAO' then
  begin
    sAjuda := 'INDEX.HTM';

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','T');
    iCampos                := 1;

    // Menu
    Form7.Menu             := mmSituacaoOS;

    // Arquivo
    ArquivoAberto          := DSSitucaoOS.Dataset;
    TabelaAberta           := ibdSituacaoOS;
    DataSourceAtual        := DSSitucaoOS;

    // Sql
    sSelect := ' Select'+
               '   *'+
               ' From OSSITUACAO ';

    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','IDSITUACAO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','1');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMaxReg   := Mais1Ini.ReadString(sModulo,'MAX','5000');
  end;
  {Mauricio Parizotto 2023-12-04 Fim}
  {$Endregion}

  {$Region'//// Mdulo Bancos ////'}
  if sModulo = 'BANCOS' then
  begin
    sAjuda := 'bancos.htm';

    // Campos
    Form1.sEscolhido       := Mais1Ini.ReadString(sModulo,'BANCO','Banco do Brasil');
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTT');
    iCampos                := 9;

    // Menu
    Form7.Menu                       := mmMovBancos;

    Odas3.Checked                    := True;
    Lanamentoscompensados1.Checked   := False;
    Lanamentosnocompensados1.Checked := False;

    // Arquivo
    ArquivoAberto          := DataSource5.Dataset;
    TabelaAberta           := ibDataSet5;
    DataSourceAtual        := DataSource5;

    if not Form7.ibDataSet1.active  then
      Form7.ibDataSet1.Open;
    if not Form7.ibDataSet11.active  then
      Form7.ibDataSet11.Open;

    // Sql
    sSelect  := 'select * FROM MOVIMENT';
    sOrderBy := 'order by COMPENS, PREDATA, REGISTRO';
    sWhere   := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');

    if Pos(AllTrim(Form1.sEscolhido),Mais1Ini.ReadString(sModulo,'FILTRO','')) = 0 then
      sWhere := 'where NOME=' + QuotedStr(Form1.sEscolhido);

    if (Pos(' CONTA=',sWhere) <> 0) then
    begin
      sTitulo  := 'Conciliao Bancria - '+Form1.sEscolhido;
      sRPS := 'N';
    end else
    begin
      sTitulo  := 'Controle bancrio - '+Form1.sEscolhido;
      sRPS := 'N';
    end;

    Form7.Caption := StrTran(sTitulo,'(RPS) RPS','(RPS)');
  end;
  {$Endregion}

  {$Region'//// Mdulo Clientes/Vendedor ////'}
  if (sModulo = 'CLIENTES') or (sModulo = 'VENDEDOR') then
  begin

    {
    if sModulo = 'VENDEDOR' then
    begin
      sAjuda := 'config_vendedores.htm'; // Falta vendedores

      // Menu
      Form7.Menu              := mmVendedor;
      Relatriodecomisses1.Visible := True;

      // Sql
      sSelect   := 'select * from CLIFOR';
      sWhere    := 'where CLIFOR=''Vendedor''';

      sModulo := 'CLIENTES';
    end else
    begin
      sAjuda := 'clifor.htm';

      // Menu
      Form7.Menu            := mmCLifor;
      //2024-01-10 Mostrartodososclientesefornecedores1.Checked := True;

      // Sql
      sSelect   := 'select * from CLIFOR';
      sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    end;

    // Arquivo
    ArquivoAberto          := DataSource2.Dataset;
    TabelaAberta           := ibDataSet2;
    DataSourceAtual        := DataSource2;
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTFTTTT' + Replicate('F', 19));
    iCampos   := 27;
    }

    SetDataSetCadastros(IniFileUsuarioLogado);
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');

    // S FORNECEDORES
    if not Form1.bClientesLiberados then
    begin
      if Pos('where coalesce(CLIFOR,'+QuotedStr('F')+')=',sWhere)=0 then
      begin
        if (alltrim(sWhere)='where') or (alltrim(sWhere)='') then
        begin
          sWhere := 'where coalesce(CLIFOR,'+QuotedStr('F')+')='+QuotedStr('F')+ '';
        end else
        begin
          sWhere := 'where coalesce(CLIFOR,'+QuotedStr('F')+')='+QuotedStr('F')+' and '+ StrTran(sWhere,'where','');
        end;
      end;

      sWhere := StrTran(sWhere,'and and','and'); // corrige um bug
    end;

    // S CLIENTES
    if not Form1.bFornecedoresLiberados then
    begin
      if Pos('where coalesce(CLIFOR,'+QuotedStr('C')+')=',sWhere)=0 then
      begin
        if (alltrim(sWhere)='where') or (alltrim(sWhere)='') then
        begin
          sWhere := 'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+ '';
        end else
        begin
          if Pos('(select',sWhere)=0 then
          begin
            sWhere := 'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+ ' and '+ StrTran(sWhere,'where','');
          end else
          begin
            sWhere := 'where coalesce(CLIFOR,'+QuotedStr('C')+')='+QuotedStr('C')+ ' and '+ StrTran(sWhere,'where (','and (');
          end;
        end;
      end;

      sWhere := StrTran(sWhere,'and and','and'); // corrige um bug
    end;

    if Form7.sWhere  = 'where CLIFOR='+QuotedStr('Vendedor') then
    begin
      Form7.ibDataSet9.Close;                                                    //
      Form7.ibDataSet9.Selectsql.Clear;                                          // Vendedores e CLIENTES relacionados
      Form7.ibDataSet9.Selectsql.Add('select * from VENDEDOR where NOME=:NOME'); //
      Form7.ibDataSet9.DataSource := DataSource2;
      Form7.ibDataSet9.Open;
    end;
  end;
  {$Endregion}

  {$Region'//// Mdulo Estoque'}
  if sModulo = 'ESTOQUE' then
  begin
    sAjuda := 'estoque.htm';

    //if AllTrim(Form7.ibDataSet13ESTADO.AsString) = 'SP' then  Mauricio Parizotto 2023-09-06
    if EstadoEmitente(IBDatabase1) = 'SP' then
    begin
      ibDataSet4CFOP.DisplayLabel          := StrTran(ibDataSet4CFOP.DisplayLabel,'NFC-e','SAT');
      ibDataSet4CSOSN_NFCE.DisplayLabel    := StrTran(ibDataSet4CSOSN_NFCE.DisplayLabel,'NFC-e','SAT');
      ibDataSet4CST_NFCE.DisplayLabel      := StrTran(ibDataSet4CST_NFCE.DisplayLabel,'NFC-e','SAT');
      ibDataSet4ALIQUOTA_NFCE.DisplayLabel := StrTran(ibDataSet4ALIQUOTA_NFCE.DisplayLabel,'NFC-e','SAT');
    end else
    begin
      ibDataSet4CFOP.DisplayLabel          := StrTran(ibDataSet4CFOP.DisplayLabel,'SAT','NFC-e');
      ibDataSet4CSOSN_NFCE.DisplayLabel    := StrTran(ibDataSet4CSOSN_NFCE.DisplayLabel,'SAT','NFC-e');
      ibDataSet4CST_NFCE.DisplayLabel      := StrTran(ibDataSet4CST_NFCE.DisplayLabel,'SAT','NFC-e');
      ibDataSet4ALIQUOTA_NFCE.DisplayLabel := StrTran(ibDataSet4ALIQUOTA_NFCE.DisplayLabel,'SAT','NFC-e');
    end;

    // Menu
    Form7.Menu             := mmEstoque;

    // Arquivo
    Form7.ibDataSet4.EnableControls;

    ArquivoAberto          := DataSource4.Dataset;
    TabelaAberta           := ibDataSet4;
    DataSourceAtual        := DataSource4;

    // Sql
    sSelect   := 'select * FROM ESTOQUE';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','DESCRICAO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');

    {if Form1.bMKP then
    begin
      sMostra   := 'TFTFTFFFFF'+Replicate('F',40)+'T';
    end else
    begin
      // Sandro Silva 2022-12-20 sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TFTFFFTFFT'+Replicate('F',40));
      sMostra   := Mais1Ini.ReadString(sModulo, 'Mostrar', 'TFTFFFTFFT'+Replicate('F', 42));
    end;}
    //Mauricio Parizotto 2023-12-04
    sMostra   := Mais1Ini.ReadString(sModulo, 'Mostrar', 'TTTFTTFTFFT'+Replicate('F', 41));

    iCampos   := 50; // Sandro Silva 2023-01-18 iCampos   := 51; // Sandro Silva 2023-01-04 iCampos   := 50;
    {Sandro Silva 2022-12-20 inicio
    if Form1.CampoDisponivelParaUsuario(sModulo, 'IDENTIFICADORPLANOCONTAS') then
      iCampos   := 51;
    {Sandro Silva 2022-12-20 fim}
  end;
  {$Endregion}

  {$Region'//// Mdulo Receber'}
  // Receber
  if sModulo = 'RECEBER' then
  begin
    sAjuda := 'cr.htm';

    Odas1.Checked          := True;
    Receber2.Checked       := False;
    Jrecebidas2.Checked    := False;
    Atrasadas3.Checked     := False;
    Avencer3.Checked       := False;
    Vencendohoje2.Checked  := False;

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTFFFFTTTT'); // Sandro Silva 2023-06-22 sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTTTTFFFFT');
    //iCampos                := 16; // Sandro Silva 2022-12-29 iCampos                := 15;
    iCampos                := 20;// Sandro Silva 2023-06-22 iCampos                := 17; // Mauricio Parizotto 2023-05-29

    // Menu
    Form7.Menu             := mmReceber;

    // Arquivo
    ArquivoAberto          := DataSource7.Dataset;
    TabelaAberta           := ibDataSet7;
    DataSourceAtual        := DataSource7;

    try
      if not Form7.ibDataSet1.active  then
        Form7.ibDataSet1.Open;
    except
      //ShowMessage('Erro 11189'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro 11189',msgErro);
    end;

    // Sql
    sSelect   := 'select * FROM RECEBER';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','VENCIMENTO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
  end;
  {$Endregion}

  {$Region'//// Mdulo Pagar ////'}
  // Pagar
  if sModulo = 'PAGAR' then
  begin
    sAjuda := 'cp.htm';

    Form7.odas2.Checked    := True;
    Form7.Pagar2.Checked    := False;
    Form7.Jpagas2.Checked    := False;
    Form7.Atrasadas1.Checked  := False;
    Form7.Avencer1.Checked     := False;
    Form7.Vencendohoje3.Checked := False;

    // Campos
    sMostra                := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTT');
    iCampos                := 12; // 2022-07-18 iCampos                := 11;

    // Menu
    Form7.Menu             := mmPagar;

    // Arquivo
    ArquivoAberto          := DataSource8.Dataset;
    TabelaAberta           := ibDataSet8;
    DataSourceAtual        := DataSource8;

    try
      if not Form7.ibDataSet1.active then
        Form7.ibDataSet1.Open;
    except
      //ShowMessage('Erro 11189'); Mauricio Parizotto 2023-10-25
      MensagemSistema('Erro 11189',msgErro);
    end;

    // Sql
    sSelect   := 'select * FROM PAGAR';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','VENCIMENTO');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
  end;
  {$Endregion}

  {$Region'//// Mdulo Tcnico ////'}
  // Tcnicos
  if sModulo = 'TECNICO' then
  begin
    sAjuda := 'config_tecnicos.htm'; // Falta tecnicos

    // Menu
    Form7.Menu         := mmVendedor;

    // Arquivo
    ArquivoAberto          := DataSource9.Dataset;
    TabelaAberta           := ibDataSet9;
    DataSourceAtual        := DataSource9;

    // Sql
    Form7.ibDataSet9.Open;
    Form7.ibDataSet9.First;
    sSelect   := 'select * FROM VENDEDOR';
    sWhere    := 'where FUNCAO like '+QuotedStr('%TECNICO%')+' ';
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TFF');
    iCampos   := 1;

    Form7.ibDataSet9COMISSA1.Visible := False;
    Form7.ibDataSet9COMISSA2.Visible := False;
  end;
  {$Endregion}

  {$Region'//// Mdulo Convenio ////'}
  // Convenio
  if sModulo = 'CONVENIO' then
  begin
    sAjuda := 'config_convenio.htm'; // Falta convnio

    // Menu
    Form7.Menu             := mmConvenio;

    // Arquivo
    ArquivoAberto          := DataSource29.Dataset;
    TabelaAberta           := ibDataSet29;
    DataSourceAtual        := DataSource29;

    // Sql
    sSelect   := 'select * FROM CONVENIO';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTT');
    iCampos   := 5;
  end;
  {$Endregion}

  {$Region'//// Mdulo Contas ////'}
  // CONTAS
  if sModulo = 'CONTAS' then
  begin
    sAjuda := 'config_plano_contas.htm'; // Falta contas
    // Menu

    Form7.Menu             := mmPlanoContas;

    // Arquivo
    ArquivoAberto          := DataSource12.Dataset;
    TabelaAberta           := ibDataSet12;
    DataSourceAtual        := DataSource12;

    // Sql
    sSelect   := 'select * FROM CONTAS';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','CONTA');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTTTTT'); // Sandro Silva 2022-12-19 sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTTT');
    iCampos   := 9; // Sandro Silva 2022-12-19 iCampos   := 6;
  end;
  {$Endregion}

  {$Region'//// Mdulo Natureza OP ////'}
  // Tabela de ICM
  if sModulo = 'ICM' then
  begin
    sAjuda := 'config_icms_iss.htm'; // Falta icm

    // Menu
    Form7.Menu             := mmICM;

    // Arquivo
    ArquivoAberto          := DataSource14.Dataset;
    TabelaAberta           := ibDataSet14;
    DataSourceAtual        := DataSource14;

    // Sql
    sSelect   := 'select * FROM ICM';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by CFOP';
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar', DupeString('T', 47)); // Mauricio Parizotto 2023-12-11 sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar', DupeString('T', 46)); // Sandro Silva 2023-07-03 sMostra   := Replicate('T',47);
    // Sandro Silva 2023-07-03 iCampos   := 44;
    //iCampos   := 46; // Sandro Silva 2023-07-03 iCampos   := 5; Mauricio Parizotto 2023-12-11
    iCampos   := 47;
  end;
  {$Endregion}

  {$Region'//// Mdulo Transportadora ////'}
  if sModulo = 'TRANSPORT' then
  begin
    sAjuda := 'config_transportadoras.htm'; // Falta tranport

    // Menu
    Form7.Menu      := mmTransport;

    // Arquivo
    ArquivoAberto   := DataSource18.Dataset;
    TabelaAberta    := ibDataSet18;
    DataSourceAtual := DataSource18;

    // Sql
    sSelect   := 'select * FROM TRANSPOR';
    sWhere    := Mais1Ini.ReadString(sModulo,'FILTRO','');
    sOrderBy  := 'order by '+Mais1Ini.ReadString(sModulo,'ORDEM','NOME');
    sREgistro := Mais1Ini.ReadString(sModulo,'REGISTRO','0000000001');
    sColuna   := Mais1Ini.ReadString(sModulo,'COLUNA','01');
    sLinha    := Mais1Ini.ReadString(sModulo,'LINHA','001');
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTFTTTFTFTT');
    iCampos   := 11;
  end;
  {$Endregion}

  {$Region'//// Mdulo Grupos ////'}
  if sModulo = 'GRUPOS' then
  begin
    sAjuda := 'est_grupos.htm'; // Falta grupo

    Form7.Menu         := mmGrupos;

    ArquivoAberto   := DataSource21.Dataset;
    TabelaAberta    := ibDataSet21;
    DataSourceAtual := DataSource21;

    sSelect   := 'select * FROM GRUPO';
    sWhere    := '';
    sOrderBy  := 'order by upper(NOME)';
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','T');
    iCampos   := 1;
  end;
  {$Endregion}

  {$Region'//// Mdulo Contas ////'}
  if sModulo = '2CONTAS' then
  begin
    imgFiltrar.Visible := False; // Filtros
    lblFiltrar.Visible := False;

    sAjuda := 'bancos.htm'; // Falta contas bancrias

    Form7.Menu := mmContasBancarias;

    ArquivoAberto   := DataSource11.Dataset;
    TabelaAberta    := ibDataSet11;
    DataSourceAtual := DataSource11;

    sSelect   := 'select * FROM BANCOS';
    sWhere    := '';
    sOrderBy  := 'order by upper(NOME)';
    sREgistro := '0000000001';
    //sMostra   := 'TTTTT'; Mauricio Parizotto 2023-06-16
    sMostra   := Mais1Ini.ReadString(sModulo,'Mostrar','TTTTT');
    iCampos   := 6;
  end else
  begin
    imgFiltrar.Visible := True; // Filtros
    lblFiltrar.Visible := True;
  end;
  {$Endregion}

end;

procedure TForm7.CarregarContasReceberMarcadas;
begin
  Form1.IBDataSet200.Close;
  Form1.IBDataSet200.SelectSQL.Clear;
  Form1.IBDataSet200.SelectSQL.Add('select DOCUMENTO as "Documento", VALOR_DUPL as "Valor original   ", VALOR_RECE as "Valor recebido   ", VENCIMENTO as "Vencimento", RECEBIMENT as "Data recebimento   ", REGISTRO from RECEBER where ATIVO>=5');
  Form1.IBDataSet200.Open;
end;

procedure TForm7.CarregarContasPagarMarcadas;
begin
  Form1.IBDataSet200.Close;
  Form1.IBDataSet200.SelectSQL.Clear;
  Form1.IBDataSet200.SelectSQL.Add('select DOCUMENTO as "Documento", VALOR_DUPL as "Valor original   ", VALOR_PAGO as "Valor pago   ", VENCIMENTO as "Vencimento", PAGAMENTO as "Data de pagamento     ", REGISTRO from PAGAR where ATIVO>=5');
  Form1.IBDataSet200.Open;
end;


function TForm7.SomenteLeitura : Boolean;
var
  Mais1Ini : TiniFile;
begin
  try
    Result := False;
    Mais1Ini   := TIniFile.Create(Form1.sAtual+'\EST0QUE.DAT');

    if Form7.sModulo = 'NOTA'     then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B1','0'))  <> '1' then
        Result := True;
    end;
    if Form7.sModulo = 'ESTOQUE'  then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B2','0'))  <> '1' then
        Result := True;
    end;

    if Form7.sModulo = 'CLIENTES' then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B3','0'))  <> '1' then
        Result := True;
    end;

    if Form7.sModulo = 'RECEBER'  then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B4','0'))  <> '1' then
        Result := True;
    end;

    if Form7.sModulo = 'PAGAR'    then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B10','0')) <> '1' then
        Result := True;
    end;

    if Form7.sModulo = 'CAIXA'    then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B5','0'))  <> '1' then
        Result := True;
    end;

    if Form7.sModulo = 'BANCOS'   then
    begin
      if AllTrim(Mais1Ini.ReadString(Usuario,'B6','0'))  <> '1' then
        Result := True;
    end;

    Mais1Ini.Free;
  except
  end;
end;


procedure TForm7.MarcaColunaOrderBy;
var
  i : integer;
begin
  try
    if DBGrid1.Columns.Count = 1 then
      Exit;

    for I := 0 to DBGrid1.Columns.Count -1 do
    begin
      if Pos(DBGrid1.Columns[i].Field.FieldName,sOrderBy) <> 0 then
        DBGrid1.Columns[i].Title.Font.Style := [fsBold]
      else
        DBGrid1.Columns[i].Title.Font.Style := [];
    end;
  except
  end;
end;


procedure TForm7.TotalizaItensCompra;
begin
  try
    Form7.ibDataSet24.Edit;
    Form7.ibDataSet24MERCADORIA.AsFloat      := 0;
    Form7.ibDataSet24ISS.AsFloat             := 0;
    Form7.ibDataSet24SERVICOS.AsFloat        := 0;

    Form7.ibDataSet24ICMS.AsFloat            := 0;
    Form7.ibDataSet24BASEICM.AsFloat         := 0;
    Form7.ibDataSet24ICMSSUBSTI.AsFloat      := 0;
    Form7.ibDataSet24BASESUBSTI.AsFloat      := 0;
    Form7.ibDataSet24IPI.AsFloat             := 0;
    Form7.ibDataSet24VFCPST.AsFloat          := 0.00;// Sandro Silva 2023-04-11
    Form7.ibDataSet24ICMS_DESONERADO.AsFloat := 0; //Mauricio Parizotto 2023-07-18

    Form7.ibDataSet101.DisableControls;
    Form7.ibDataSet101.Close;
    Form7.ibDataSet101.SelectSQL.Clear;

    // Acumula os totais para evitar passar item por item da nota, nota com muitos itens fica lento
    Form7.ibDataSet101.SelectSQL.Add(
      'select ' +
      'sum(cast(coalesce(TOTAL, 0) as numeric(18, 2))) as TOTAL, ' +
      'sum(cast(coalesce(VIPI, 0) as numeric(18, 2))) as VIPI, ' +
      'sum(cast(coalesce(VBC, 0) as numeric(18, 2))) as VBC, ' +
      'sum(cast(coalesce(VICMS, 0) as numeric(18, 2))) as VICMS, ' +
      'sum(cast(coalesce(VBCST, 0) as numeric(18, 2))) as VBCST, ' +
      'sum(cast(coalesce(VICMSST, 0) as numeric(18, 2))) as VICMSST, ' +
      'sum(cast(coalesce(VFCPST, 0) as numeric(18, 2))) as VFCPST, ' +
      'sum(cast(coalesce(ICMS_DESONERADO, 0) as numeric(18, 2))) as ICMS_DESONERADO ' +
      'from ITENS002 '+
      ' Where NUMERONF='+QuotedStr(Form7.ibDAtaSet24NUMERONF.AsString)+
      '   and FORNECEDOR='+QuotedStr(Form7.ibDataSet24FORNECEDOR.AsString)+' ');

    Form7.ibDataSet101.Open;

    Form7.ibDataSet101.First;

    while not Form7.ibDataSet101.Eof do
    begin
      try
        Form7.ibDataSet24MERCADORIA.AsFloat      := Form7.ibDataSet24MERCADORIA.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('TOTAL').AsFloat,2);
        Form7.ibDataSet24IPI.Value               := Form7.ibDataSet24IPI.AsFloat        +  Arredonda(Form7.ibDataSet101.FieldByname('VIPI').AsFloat,2);
        Form7.ibDataSet24BASEICM.AsFloat         := Form7.ibDataSet24BASEICM.AsFloat    +  Arredonda(Form7.ibDataSet101.FieldByname('VBC').AsFloat,2);
        Form7.ibDataSet24ICMS.AsFloat            := Form7.ibDataSet24ICMS.AsFloat       +  Arredonda(Form7.ibDataSet101.FieldByname('VICMS').AsFloat,2);
        Form7.ibDataSet24BASESUBSTI.AsFloat      := Form7.ibDataSet24BASESUBSTI.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('VBCST').AsFloat,2);
        Form7.ibDataSet24ICMSSUBSTI.AsFloat      := Form7.ibDataSet24ICMSSUBSTI.AsFloat +  Arredonda(Form7.ibDataSet101.FieldByname('VICMSST').AsFloat,2);
        Form7.ibDataSet24VFCPST.AsFloat          := Form7.ibDataSet24VFCPST.AsFloat + Arredonda(Form7.ibDataSet101.FieldByname('VFCPST').AsFloat,2); // Sandro Silva 2023-04-11
        if bDescontaICMSDeso then
          Form7.ibDataSet24ICMS_DESONERADO.AsFloat := Form7.ibDataSet24ICMS_DESONERADO.AsFloat + Arredonda(Form7.ibDataSet101.FieldByname('ICMS_DESONERADO').AsFloat,2); // Mauricio Parizotto 2023-07-18
      except
      end;

      ibDataSet101.Next;
    end;

    //Mauricio Parizotto 2023-07-19
    CalculaTotalNota;
  except
  end;

  AgendaCommit(True);
end;

procedure TForm7.RegistraExclusaoRegistro(AoDataSet: TDataSet; AcModulo: String = ''; AcHistoricoExtra: String = '');
var
  cHistorico: String;
  cModuloAnt: String;
begin
  cModuloAnt := sModulo;
  try
    if AcModulo <> EmptyStr then
      sModulo := AcModulo;

    cHistorico := Copy('REG.: ' + AoDataSet.FieldByName('REGISTRO').AsString + ' - ' + RetornarHistoricoPorModulo + AcHistoricoExtra, 1, 1000);

    // Ato, Modulo, Usurio, Histrico
    case RetornaTipoModulo of
      tmcPagar  : Audita('APAGOU', sModulo, Senhas.UsuarioPub, cHistorico, (ibDataSet8VALOR_DUPL.AsFloat), 0);
      tmcReceber: Audita('APAGOU', sModulo, Senhas.UsuarioPub, cHistorico, (ibDataSet7VALOR_DUPL.AsFloat), 0);
      tmcBancos : Audita('APAGOU', sModulo, Senhas.UsuarioPub, cHistorico, ((ibDataSet5SAIDA_.AsFloat*-1)+ibDataSet5ENTRADA_.AsFloat), 0);
      tmcCaixa  : Audita('APAGOU', sModulo, Senhas.UsuarioPub, cHistorico, ((ibDataSet1SAIDA.AsFloat*-1)+ibDataSet1ENTRADA.AsFloat), 0);
      tmcParametroTributacao : Audita('APAGOU', 'PARAMTRIBU', Senhas.UsuarioPub, cHistorico, 0, 0);
      tmcPerfilTributacao    : Audita('APAGOU', 'PERFILTRIB', Senhas.UsuarioPub, cHistorico, 0, 0);
      tmcConversaoCFOP       : Audita('APAGOU', 'CONVERCFOP', Senhas.UsuarioPub, cHistorico, 0, 0);
      else Audita('APAGOU', Copy(sModulo,1,10), Senhas.UsuarioPub, cHistorico, 0, 0);
    end;
  finally
    sModulo := cModuloAnt;
  end;
end;

function TForm7.RetornaTipoModulo: tModulosCommerce;
var
  i: Integer;
  cNomeEnum: String;
begin
  Result := tmcNaoMapeado;

  for i := Ord(Low(tModulosCommerce)) to Ord(High(tModulosCommerce)) do
  begin
    cNomeEnum := AnsiUpperCase(Copy(GetEnumName(TypeInfo(tModulosCommerce), i), 4, Length(GetEnumName(TypeInfo(tModulosCommerce), i))));
    cNomeEnum := StringReplace(cNomeEnum, ' ', EmptyStr, [rfReplaceAll]);
    if cNomeEnum = StringReplace(AnsiUpperCase(sModulo), ' ', EmptyStr, [rfReplaceAll]) then
    begin
      Result := tModulosCommerce(i);
      Break;
    end;
  end;
end;

function TForm7.RetornarHistoricoPorModulo: String;
var
  i: Integer;
begin
  case RetornaTipoModulo of
    tmcVenda    : Result := 'NMERO NF: ' + ibDataSet15NUMERONF.AsString + ', CLIENTE: ' + ibDataSet15CLIENTE.AsString;
    tmcCompra   : Result := 'NMERO NF: ' + ibDataSet24NUMERONF.AsString + ', FORNECEDOR: ' + ibDataSet24FORNECEDOR.AsString;
    tmcEstoque  : Result := 'CDIGO: ' + ibDataSet4CODIGO.AsString + ', DESCRIO: ' + ibDataSet4DESCRICAO.AsString;
    tmcOS       : Result := 'NMERO: ' + ibDataSet3NUMERO.AsString + ', CLIENTE: ' + ibDataSet3CLIENTE.AsString;
    tmcClientes : Result := 'NOME: ' + IBDataSet2NOME.AsString;
    tmcBancos   : Result := Alltrim(ibDataSet5EMISSAO.AsString +' - ' +Alltrim(ibDataSet5DOCUMENTO.AsString + ' - ' + ibDataSet5HISTORICO.AsString));
    tmcPagar    : Result := Alltrim(ibDataSet8VENCIMENTO.AsString + ' - ' +Alltrim(ibDataSet8DOCUMENTO.AsString + ' - ' + ibDataSet8HISTORICO.AsString));
    tmcReceber  : Result := Alltrim(ibDataSet7DOCUMENTO.AsString);
    tmcCaixa    : Result := ibDataSet1DATA.AsString + ' - ' + Alltrim(ibDataSet1HISTORICO.AsString);
    tmcOrcamento: Result := 'PEDIDO: ' + ibDataSet37PEDIDO.AsString + ', ITEM: ' + ibDataSet37DESCRICAO.AsString;
    tmcConvenio : Result := 'NOME: ' + ibDataSet29NOME.AsString;
    tmcContas   : Result := 'CONTA: ' + ibDataSet12CONTA.AsString + ', NOME: ' + ibDataSet12NOME.AsString;
    tmcTransport: Result := 'NOME: ' + ibDataSet18NOME.AsString + ', PLACA: ' + ibDataSet18PLACA.AsString;
    tmcGrupos   : Result := 'NOME: ' + ibDataSet21NOME.AsString;
    tmcParametroTributacao: Result := 'CFOP ENTRADA: ' + ibdParametroTributaCFOP_ENTRADA.AsString + ', ID PERFIL TRIBUTAO: ' + ibdParametroTributaIDPERFILTRIBUTACAO.AsString;
    tmcPerfilTributacao   : Result := 'NOME: ' + ibdPerfilTributaDESCRICAO.AsString;
    tmcConversaoCFOP      : Result := 'CFOP ORIGEM: ' + ibdConversaoCFOPCFOP_ORIGEM.AsString + ', CFOP CONVERSO: ' + ibdConversaoCFOPCFOP_CONVERSAO.AsString;
    tmcICM                : Result := 'NOME: ' + ibDataSet14NOME.AsString + ', CFOP: ' + ibDataSet14CFOP.AsString;
    tmc2Contas            : Result := 'NOME: ' + ibDataSet11NOME.AsString + ', AGNCIA: ' + ibDataSet11AGENCIA.AsString + ', CONTA: ' + ibDataSet11CONTA.AsString;
    else Result := 'MDULO ' + AnsiUpperCase(sModulo) + ' NO MAPEADO.';
  end;
end;

end.
